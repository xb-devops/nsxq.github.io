<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"islocal.cc",root:"/",scheme:"Muse",version:"7.8.0",exturl:!1,sidebar:{position:"right",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:"default"},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="基础环境配置iptables: disabledselinux:  disabled|系统		|主机名		|IP地址	        |角色          ||CentOS 7.2 x64	|mysql_a	|192.168.6.126	|Atlas代理服务 ||CentOS 7.2 x64	|mysql_b	|192.168.6.127	|Mysql主服务器 ||CentOS 7.2 x64"><meta property="og:type" content="article"><meta property="og:title" content="Mariadb 读写分离集群搭建"><meta property="og:url" content="http://islocal.cc/arlo/b48c6366/index.html"><meta property="og:site_name" content="南山草舍"><meta property="og:description" content="基础环境配置iptables: disabledselinux:  disabled|系统		|主机名		|IP地址	        |角色          ||CentOS 7.2 x64	|mysql_a	|192.168.6.126	|Atlas代理服务 ||CentOS 7.2 x64	|mysql_b	|192.168.6.127	|Mysql主服务器 ||CentOS 7.2 x64"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://islocal.cc/images/2017/0801/01.png"><meta property="article:published_time" content="2017-08-01T09:24:42.000Z"><meta property="article:modified_time" content="2018-03-15T07:17:46.000Z"><meta property="article:author" content="南山小樵"><meta property="article:tag" content="数据库"><meta property="article:tag" content="Mysql"><meta property="article:tag" content="Mariadb"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://islocal.cc/images/2017/0801/01.png"><link rel="canonical" href="http://islocal.cc/arlo/b48c6366/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>Mariadb 读写分离集群搭建 | 南山草舍</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="stylesheet" href="/css/prism.css" type="text/css"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">南山草舍</h1><span class="logo-line-after"><i></i></span></a></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">17</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">175</span></a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">101</span></a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://islocal.cc/arlo/b48c6366/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="南山小樵"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="南山草舍"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Mariadb 读写分离集群搭建</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2017-08-01 17:24:42" itemprop="dateCreated datePublished" datetime="2017-08-01T17:24:42+08:00">2017-08-01</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2018-03-15 15:17:46" itemprop="dateModified" datetime="2018-03-15T15:17:46+08:00">2018-03-15</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="基础环境配置"><a href="#基础环境配置" class="headerlink" title="基础环境配置"></a>基础环境配置</h1><p>iptables: disabled<br>selinux: disabled<br>|系统 |主机名 |IP地址 |角色 |<br>|CentOS 7.2 x64	|mysql_a	|192.168.6.126	|Atlas代理服务 |<br>|CentOS 7.2 x64	|mysql_b	|192.168.6.127	|Mysql主服务器 |<br>|CentOS 7.2 x64	|mysql_c	|192.168.6.128	|Mysql 从服务器|</p><span id="more"></span><h2 id="在mysql-a上安装ansible"><a href="#在mysql-a上安装ansible" class="headerlink" title="在mysql_a上安装ansible"></a>在mysql_a上安装ansible</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@mysql_a ~]# yum -y install epel-release</span><br><span class="line">[root@mysql_a ~]# yum -y install ansible</span><br><span class="line">[root@mysql_a ~]# vim /etc/ansible/hosts</span><br><span class="line">[mysql]</span><br><span class="line">mysql_b</span><br><span class="line">mysql_c</span><br></pre></td></tr></table></figure><h2 id="建立无密码通信"><a href="#建立无密码通信" class="headerlink" title="建立无密码通信"></a>建立无密码通信</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@mysql_a ~]# ssh-keygen -t rsa</span><br><span class="line">[root@mysql_a ~]# ssh-copy-id -i ~/.ssh/id_rsa.pub mysql_b</span><br><span class="line">[root@mysql_a ~]# ssh-copy-id -i ~/.ssh/id_rsa.pub mysql_c</span><br></pre></td></tr></table></figure><h2 id="保持服务器时间同步"><a href="#保持服务器时间同步" class="headerlink" title="保持服务器时间同步"></a>保持服务器时间同步</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@mysql_a ~]# ansible mysql -a &#x27;timedatectl set-timezone Asia/Shanghai&#x27;</span><br><span class="line">[root@mysql_a ~]# ansible mysql -a &#x27;timedatectl set-ntp true&#x27;</span><br><span class="line">[root@mysql_a ~]# ansible mysql -a &#x27;ntpdate cn.ntp.org.cn&#x27;</span><br></pre></td></tr></table></figure><h2 id="配置三台服务器的hosts"><a href="#配置三台服务器的hosts" class="headerlink" title="配置三台服务器的hosts"></a>配置三台服务器的hosts</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/hosts</span><br><span class="line">192.168.6.126   mysql_a</span><br><span class="line">192.168.6.127   mysql_b</span><br><span class="line">192.168.6.128   mysql_c</span><br><span class="line">[root@mysql_a ~]# ansible mysql -m copy -a &#x27;src=/etc/hosts dest=/etc/hosts&#x27;</span><br></pre></td></tr></table></figure><h1 id="搭建Mariadb-mysql-主从复制"><a href="#搭建Mariadb-mysql-主从复制" class="headerlink" title="搭建Mariadb(mysql)主从复制"></a>搭建Mariadb(mysql)主从复制</h1><h2 id="配置Mariadb-yum源"><a href="#配置Mariadb-yum源" class="headerlink" title="配置Mariadb yum源"></a>配置Mariadb yum源</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@mysql_a ~]# vim /etc/yum.repos.d/MariaDB.repo</span><br><span class="line"># MariaDB 10.2 CentOS repository list - created 2017-07-27 03:36 UTC</span><br><span class="line"># http://downloads.mariadb.org/mariadb/repositories/</span><br><span class="line">[mariadb]</span><br><span class="line">name = MariaDB</span><br><span class="line">baseurl = http://yum.mariadb.org/10.2/centos7-amd64</span><br><span class="line">gpgkey=https://yum.mariadb.org/RPM-GPG-KEY-MariaDB</span><br><span class="line">gpgcheck=1</span><br></pre></td></tr></table></figure><h2 id="安装Mariadb-mysql"><a href="#安装Mariadb-mysql" class="headerlink" title="安装Mariadb(mysql)"></a>安装Mariadb(mysql)</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@mysql_a ~]# ansible mysql -m copy -a &#x27;src=/etc/yum.repos.d/MariaDB.repo dest=/etc/yum.repos.d/MariaDB.repo&#x27;</span><br><span class="line">[root@mysql_a ~]# ansible mysql -m yum -a &#x27;name=MariaDB-server state=installed&#x27;</span><br><span class="line">[root@mysql_a ~]# ansible mysql -m yum -a &#x27;name=MariaDB-client state=installed&#x27;</span><br></pre></td></tr></table></figure><p>*<em>Ps：也可以下载以下几个rpm包，使用yum localinstall <em>.rpm 进行安装（速度会快一些）</em></em></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@mysql_b mariadb]# ll</span><br><span class="line">total 171204</span><br><span class="line">-rw-r--r-- 1 root root   8353220 Aug  1 13:56 galera-25.3.20-1.rhel7.el7.centos.x86_64.rpm</span><br><span class="line">-rw-r--r-- 1 root root  50251656 Aug  1 09:46 MariaDB-10.2.7-centos7-x86_64-client.rpm</span><br><span class="line">-rw-r--r-- 1 root root    158012 Aug  1 09:46 MariaDB-10.2.7-centos7-x86_64-common.rpm</span><br><span class="line">-rw-r--r-- 1 root root   2975776 Aug  1 09:46 MariaDB-10.2.7-centos7-x86_64-compat.rpm</span><br><span class="line">-rw-r--r-- 1 root root 113565340 Aug  1 09:46 MariaDB-10.2.7-centos7-x86_64-server.rpm</span><br></pre></td></tr></table></figure><h2 id="拷贝模板配置文件"><a href="#拷贝模板配置文件" class="headerlink" title="拷贝模板配置文件"></a>拷贝模板配置文件</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@mysql_a ~]# ansible mysql -a &#x27;cp /usr/share/mysql/my-medium.cnf /etc/my.cnf&#x27;</span><br></pre></td></tr></table></figure><h2 id="各服务器上执行初始化操作"><a href="#各服务器上执行初始化操作" class="headerlink" title="各服务器上执行初始化操作"></a>各服务器上执行初始化操作</h2><p>mysql_secure_installation</p><h2 id="修改mysql-b配置文件"><a href="#修改mysql-b配置文件" class="headerlink" title="修改mysql_b配置文件"></a>修改mysql_b配置文件</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/my.cnf</span><br><span class="line">log-bin=/var/lib/mysql/mysql-bin</span><br><span class="line">binlog_format=row</span><br><span class="line">server-id = 127</span><br><span class="line">sync_binlog = 1</span><br><span class="line">innodb_support_xa = 1</span><br><span class="line">innodb-flush-log-at-trx-commit=1</span><br></pre></td></tr></table></figure><h2 id="建立授权账号"><a href="#建立授权账号" class="headerlink" title="建立授权账号"></a>建立授权账号</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@mysql_b mariadb]# mysql -uroot -pffffff</span><br><span class="line">MariaDB [mysql]&gt; grant replication slave on *.* to &#x27;repl&#x27;@&#x27;192.168.6.%&#x27; identified by &#x27;111111&#x27;;</span><br><span class="line">MariaDB [(none)]&gt; show master status;</span><br><span class="line">+------------------+----------+--------------+------------------+</span><br><span class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |</span><br><span class="line">+------------------+----------+--------------+------------------+</span><br><span class="line">| mysql-bin.000002 |      342 |              |                  |</span><br><span class="line">+------------------+----------+--------------+------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><h2 id="修改mysql-c配置文件"><a href="#修改mysql-c配置文件" class="headerlink" title="修改mysql_c配置文件"></a>修改mysql_c配置文件</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/my.cnf</span><br><span class="line">binlog_format=row</span><br><span class="line">server-id  = 128</span><br><span class="line">replicate-ignore-db=mysql</span><br><span class="line">relay_log=relay-bin</span><br></pre></td></tr></table></figure><h2 id="重启两台Mariadb-mysql-服务"><a href="#重启两台Mariadb-mysql-服务" class="headerlink" title="重启两台Mariadb(mysql)服务"></a>重启两台Mariadb(mysql)服务</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@mysql_a ~]# ansible mysql -a &#x27;systemctl restart mariadb.service&#x27;</span><br></pre></td></tr></table></figure><h2 id="开启主从同步"><a href="#开启主从同步" class="headerlink" title="开启主从同步"></a>开启主从同步</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@mysql_c mysql]# mysql -uroot –pffffff</span><br><span class="line">MariaDB [(none)]&gt; stop slave;</span><br><span class="line">MariaDB [(none)]&gt; change master to master_host=&#x27;mysql_b&#x27;, master_user=&#x27;repl&#x27;, master_password=&#x27;111111&#x27;,master_log_file=&#x27;mysql-bin.000002&#x27;,master_log_pos=342;</span><br><span class="line">MariaDB [(none)]&gt; start slave;</span><br><span class="line">MariaDB [(none)]&gt; show slave status\G</span><br></pre></td></tr></table></figure><p><img src="/images/2017/0801/01.png" alt="mariadb"></p><h1 id="Atlas安装配置"><a href="#Atlas安装配置" class="headerlink" title="Atlas安装配置"></a>Atlas安装配置</h1><h2 id="安装Mariadb-Mysql-客户端"><a href="#安装Mariadb-Mysql-客户端" class="headerlink" title="安装Mariadb(Mysql)客户端"></a>安装Mariadb(Mysql)客户端</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@mysql_a mariadb]# yum install MariaDB-client</span><br><span class="line">[root@mysql_a mariadb]# systemctl status mariadb.service //确保Atlas本机没有mysql服务被启动</span><br><span class="line">Unit mariadb.service could not be found.</span><br></pre></td></tr></table></figure><h2 id="安装atlas"><a href="#安装atlas" class="headerlink" title="安装atlas"></a>安装atlas</h2><p>下载的时候有两个软件包带分片功能的Atlas-sharding 和Atlas，我们下后边这个（el6的包centos7可以安装）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@mysql_a src]# axel https://github.com/Qihoo360/Atlas/releases/download/2.2.1/Atlas-2.2.1.el6.x86_64.rpm</span><br><span class="line">[root@mysql_a src]# rpm -ivh Atlas-2.2.1.el6.x86_64.rpm</span><br></pre></td></tr></table></figure><p>安装目录为&#x2F;usr&#x2F;local&#x2F;mysql-proxy&#x2F;，会在此目录下生成bin,conf,lib,log四个目录</p><h2 id="生成一个加密字符串，配置文件中会用到"><a href="#生成一个加密字符串，配置文件中会用到" class="headerlink" title="生成一个加密字符串，配置文件中会用到"></a>生成一个加密字符串，配置文件中会用到</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@mysql_a bin]# ./encrypt 111111</span><br><span class="line">kOVJsquUepY=</span><br></pre></td></tr></table></figure><h2 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h2><p><em>360团队很良心，中文注释很详细</em></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">[root@mysql_a bin]# vim /usr/local/mysql-proxy/conf/test.cnf</span><br><span class="line">[mysql-proxy]</span><br><span class="line"></span><br><span class="line">#带#号的为非必需的配置项目</span><br><span class="line"></span><br><span class="line">#管理接口的用户名</span><br><span class="line">admin-username = nsxq</span><br><span class="line"></span><br><span class="line">#管理接口的密码</span><br><span class="line">admin-password = ffffff</span><br><span class="line"></span><br><span class="line">#Atlas后端连接的MySQL主库的IP和端口，可设置多项，用逗号分隔</span><br><span class="line">proxy-backend-addresses = 192.168.6.127:3306</span><br><span class="line"></span><br><span class="line">#Atlas后端连接的MySQL从库的IP和端口，@后面的数字代表权重，用来作负载均衡，若省略则默认为1，可设置多项，用逗号分隔</span><br><span class="line">proxy-read-only-backend-addresses = 192.168.6.128:3306@1</span><br><span class="line"></span><br><span class="line">#用户名与其对应的加密过的MySQL密码，密码使用PREFIX/bin目录下的加密程序encrypt加密，下行的user1和user2为示例，将其替换为你的MySQL的用户名和加密密码！</span><br><span class="line">pwds = atlas:kOVJsquUepY=</span><br><span class="line"></span><br><span class="line">#设置Atlas的运行方式，设为true时为守护进程方式，设为false时为前台方式，一般开发调试时设为false，线上运行时设为true,true后面不能有空格。</span><br><span class="line">daemon = true</span><br><span class="line"></span><br><span class="line">#设置Atlas的运行方式，设为true时Atlas会启动两个进程，一个为monitor，一个为worker，monitor在worker意外退出后会自动将其重启，设为false时只有worker，没有monitor，一般开发调试时设为false，线上&gt;</span><br><span class="line">运行时设为true,true后面不能有空格。</span><br><span class="line">keepalive = true</span><br><span class="line"></span><br><span class="line">#工作线程数，对Atlas的性能有很大影响，可根据情况适当设置</span><br><span class="line">event-threads = 8</span><br><span class="line"></span><br><span class="line">#日志级别，分为message、warning、critical、error、debug五个级别</span><br><span class="line">log-level = message</span><br><span class="line"></span><br><span class="line">#日志存放的路径</span><br><span class="line">log-path = /usr/local/mysql-proxy/log</span><br><span class="line"></span><br><span class="line">#SQL日志的开关，可设置为OFF、ON、REALTIME，OFF代表不记录SQL日志，ON代表记录SQL日志，REALTIME代表记录SQL日志且实时写入磁盘，默认为OFF</span><br><span class="line">#sql-log = OFF</span><br><span class="line"></span><br><span class="line">#慢日志输出设置。当设置了该参数时，则日志只输出执行时间超过sql-log-slow（单位：ms)的日志记录。不设置该参数则输出全部日志。</span><br><span class="line">#sql-log-slow = 10</span><br><span class="line"></span><br><span class="line">#实例名称，用于同一台机器上多个Atlas实例间的区分</span><br><span class="line">#instance = test</span><br><span class="line"></span><br><span class="line">#Atlas监听的工作接口IP和端口</span><br><span class="line">proxy-address = 0.0.0.0:1234 </span><br><span class="line">#分表设置，此例中person为库名，mt为表名，id为分表字段，3为子表数量，可设置多项，以逗号分隔，若不分表则不需要设置该项</span><br><span class="line">#tables = person.mt.id.3</span><br><span class="line"></span><br><span class="line">#默认字符集，设置该项后客户端不再需要执行SET NAMES语句</span><br><span class="line">#charset = utf8</span><br><span class="line"></span><br><span class="line">#允许连接Atlas的客户端的IP，可以是精确IP，也可以是IP段，以逗号分隔，若不设置该项则允许所有IP连接，否则只允许列表中的IP连接</span><br><span class="line">#client-ips = 127.0.0.1, 192.168.1</span><br><span class="line"></span><br><span class="line">#Atlas前面挂接的LVS的物理网卡的IP(注意不是虚IP)，若有LVS且设置了client-ips则此项必须设置，否则可以不设置</span><br><span class="line">#lvs-ips = 192.168.1.1</span><br></pre></td></tr></table></figure><h2 id="启动Atlas服务"><a href="#启动Atlas服务" class="headerlink" title="启动Atlas服务"></a>启动Atlas服务</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@mysql_a bin]# ./mysql-proxyd test start</span><br><span class="line">[root@mysql_a mariadb]# ps -ef |grep mysql</span><br><span class="line">root     21456     1  0 15:24 ?        00:00:00 /usr/local/mysql-proxy/bin/mysql-proxy --defaults-file=/usr/local/mysql-proxy/conf/test.cnf</span><br><span class="line">root     21457 21456  0 15:24 ?        00:00:00 /usr/local/mysql-proxy/bin/mysql-proxy --defaults-file=/usr/local/mysql-proxy/conf/test.cnf</span><br><span class="line">root     21607 20025  0 15:35 pts/0    00:00:00 grep --color=auto mysql</span><br></pre></td></tr></table></figure><h2 id="通过Atlas访问"><a href="#通过Atlas访问" class="headerlink" title="通过Atlas访问"></a>通过Atlas访问</h2><h3 id="通过管理接口访问"><a href="#通过管理接口访问" class="headerlink" title="通过管理接口访问"></a>通过管理接口访问</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@mysql_a mariadb]# mysql -h127.0.0.1 -P2345 -unsxq –pffffff</span><br></pre></td></tr></table></figure><h3 id="通过工作接口访问"><a href="#通过工作接口访问" class="headerlink" title="通过工作接口访问"></a>通过工作接口访问</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">要保证这个用户在主从节点上都有权限，在主从节点上都添加一个用户</span><br><span class="line">MariaDB [mysql]&gt; grant all on *.* to atlas@&#x27;192.168.6.%&#x27; identified by &#x27;111111&#x27;;</span><br><span class="line">[root@mysql_a mariadb]# mysql -h127.0.0.1 -P1234 -uatlas -p111111  </span><br></pre></td></tr></table></figure><p>参考连接：<br><a target="_blank" rel="noopener" href="https://github.com/Qihoo360/Atlas/wiki">https://github.com/Qihoo360/Atlas/wiki</a><br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/yyhh/p/5084844.html">http://www.cnblogs.com/yyhh/p/5084844.html</a></p></div><footer class="post-footer"><div class="post-tags"><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag"># 数据库</a> <a href="/tags/Mysql/" rel="tag"># Mysql</a> <a href="/tags/Mariadb/" rel="tag"># Mariadb</a></div><div class="post-nav"><div class="post-nav-item"><a href="/arlo/fe63d61c/" rel="prev" title="Mariadb主从复制集群"><i class="fa fa-chevron-left"></i> Mariadb主从复制集群</a></div><div class="post-nav-item"><a href="/arlo/49c257f9/" rel="next" title="Mariadb(MHA)高可用集群搭建">Mariadb(MHA)高可用集群搭建 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><script>window.addEventListener("tabs:register",()=>{let{activeClass:t}=CONFIG.comments;if(CONFIG.comments.storage&&(t=localStorage.getItem("comments_active")||t),t){let e=document.querySelector(`a[href="#comment-${t}"]`);e&&e.click()}}),CONFIG.comments.storage&&window.addEventListener("tabs:click",t=>{if(!t.target.matches(".tabs-comment .tab-content .tab-pane"))return;let e=t.target.classList[1];localStorage.setItem("comments_active",e)})</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="nav-number">1.</span> <span class="nav-text">基础环境配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%A8mysql-a%E4%B8%8A%E5%AE%89%E8%A3%85ansible"><span class="nav-number">1.1.</span> <span class="nav-text">在mysql_a上安装ansible</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B%E6%97%A0%E5%AF%86%E7%A0%81%E9%80%9A%E4%BF%A1"><span class="nav-number">1.2.</span> <span class="nav-text">建立无密码通信</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%9D%E6%8C%81%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%97%B6%E9%97%B4%E5%90%8C%E6%AD%A5"><span class="nav-number">1.3.</span> <span class="nav-text">保持服务器时间同步</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E4%B8%89%E5%8F%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84hosts"><span class="nav-number">1.4.</span> <span class="nav-text">配置三台服务器的hosts</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%90%AD%E5%BB%BAMariadb-mysql-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="nav-number">2.</span> <span class="nav-text">搭建Mariadb(mysql)主从复制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEMariadb-yum%E6%BA%90"><span class="nav-number">2.1.</span> <span class="nav-text">配置Mariadb yum源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85Mariadb-mysql"><span class="nav-number">2.2.</span> <span class="nav-text">安装Mariadb(mysql)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8B%B7%E8%B4%9D%E6%A8%A1%E6%9D%BF%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">2.3.</span> <span class="nav-text">拷贝模板配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%84%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E6%89%A7%E8%A1%8C%E5%88%9D%E5%A7%8B%E5%8C%96%E6%93%8D%E4%BD%9C"><span class="nav-number">2.4.</span> <span class="nav-text">各服务器上执行初始化操作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9mysql-b%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">2.5.</span> <span class="nav-text">修改mysql_b配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B%E6%8E%88%E6%9D%83%E8%B4%A6%E5%8F%B7"><span class="nav-number">2.6.</span> <span class="nav-text">建立授权账号</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9mysql-c%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">2.7.</span> <span class="nav-text">修改mysql_c配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%87%8D%E5%90%AF%E4%B8%A4%E5%8F%B0Mariadb-mysql-%E6%9C%8D%E5%8A%A1"><span class="nav-number">2.8.</span> <span class="nav-text">重启两台Mariadb(mysql)服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%80%E5%90%AF%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5"><span class="nav-number">2.9.</span> <span class="nav-text">开启主从同步</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Atlas%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE"><span class="nav-number">3.</span> <span class="nav-text">Atlas安装配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85Mariadb-Mysql-%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">3.1.</span> <span class="nav-text">安装Mariadb(Mysql)客户端</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85atlas"><span class="nav-number">3.2.</span> <span class="nav-text">安装atlas</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%9F%E6%88%90%E4%B8%80%E4%B8%AA%E5%8A%A0%E5%AF%86%E5%AD%97%E7%AC%A6%E4%B8%B2%EF%BC%8C%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%B8%AD%E4%BC%9A%E7%94%A8%E5%88%B0"><span class="nav-number">3.3.</span> <span class="nav-text">生成一个加密字符串，配置文件中会用到</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">3.4.</span> <span class="nav-text">修改配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8Atlas%E6%9C%8D%E5%8A%A1"><span class="nav-number">3.5.</span> <span class="nav-text">启动Atlas服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%9A%E8%BF%87Atlas%E8%AE%BF%E9%97%AE"><span class="nav-number">3.6.</span> <span class="nav-text">通过Atlas访问</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E8%BF%87%E7%AE%A1%E7%90%86%E6%8E%A5%E5%8F%A3%E8%AE%BF%E9%97%AE"><span class="nav-number">3.6.1.</span> <span class="nav-text">通过管理接口访问</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E8%BF%87%E5%B7%A5%E4%BD%9C%E6%8E%A5%E5%8F%A3%E8%AE%BF%E9%97%AE"><span class="nav-number">3.6.2.</span> <span class="nav-text">通过工作接口访问</span></a></li></ol></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="南山小樵" src="/images/avatar.jpg"><p class="site-author-name" itemprop="name">南山小樵</p><div class="site-description" itemprop="description"></div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">175</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">17</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">101</span> <span class="site-state-item-name">标签</span></a></div></nav></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">南山小樵</span></div><div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动</div></div></footer></div><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script></body></html>