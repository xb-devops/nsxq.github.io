<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Hexo博客搭建简记</title>
    <url>/arlo/e5e5519a/</url>
    <content><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>博客是我记录学习过程最好的方式；我的第一个博客是百度空间，后来百度关闭了；第二个博客是ChinaUnix，最近ChinaUnix升级了安全，牛盾老是阻止我访问，再者ChinaUnix风格太老了，写出来的东西也不漂亮，于是就想自己搭建一个博客，现在的blog有很多，比如wordpress，ghost，等等，[比较之下][0]觉得hexo有逼格，高大上，就你了！  </p>
<span id="more"></span>
<h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><h2 id="基础环境"><a href="#基础环境" class="headerlink" title="基础环境"></a>基础环境</h2><ul>
<li>Node.js</li>
<li>Git</li>
<li>Github</li>
<li>MarkDown 编辑器</li>
</ul>
<h2 id="软件获取"><a href="#软件获取" class="headerlink" title="软件获取"></a>软件获取</h2><p>[下载nodejs][1]<br>[下载git][2]  </p>
<h2 id="安装过程"><a href="#安装过程" class="headerlink" title="安装过程"></a>安装过程</h2><h3 id="安装git"><a href="#安装git" class="headerlink" title="安装git"></a>安装git</h3><p>start–&gt;next–&gt;end(详细过程略)</p>
<h3 id="安装nodejs"><a href="#安装nodejs" class="headerlink" title="安装nodejs"></a>安装nodejs</h3><p>start–&gt;next–&gt;end(详细过程略)</p>
<h3 id="安装hexo"><a href="#安装hexo" class="headerlink" title="安装hexo"></a>安装hexo</h3><ul>
<li><strong>开始安装Hexo</strong><br><code>npm install -g hexo</code>  </li>
<li><strong>初始化博客</strong><br><code>hexo init</code>  #默认路径为当前目录，可以在init后手动指定一个目录为博客根目录</li>
<li><strong>生成静态页面</strong><br><code>hexo g</code>  #完整命令<code>hexo generate</code></li>
<li><strong>启动本地服务</strong><br><code>hexo s</code>  #完整命令<code>hexo server</code>，默认启动范围地址 <a href="http://localhost:4000/">http://localhost:4000</a> 可以使用-p指定端口<br>至此hexo 博客安装完毕</li>
</ul>
<h2 id="github"><a href="#github" class="headerlink" title="github"></a>github</h2><p>注册并登陆github<br>创建一个与自己用户名对应的项目(如：nsxq.github.io)</p>
<h2 id="配置hexo"><a href="#配置hexo" class="headerlink" title="配置hexo"></a>配置hexo</h2><p>hexo的主配置文件就是blog主目录下的_config.yml文件<br>打开文件，在配置文件最末尾，修改配置为：</p>
<pre class=" language-deploy:"><code class="language-deploy:">  type: git
  repo: git@github.com:nsxq/nsxq.github.io.git
  branch: master```

- 安装插件，支持hexo提交到github  
`npm install hexo-deployer-git --save`  

- 提交blog数据到github  
`hexo d**  #完整命令 hexo deploy`

## 更换皮肤next  
目前我看到的最漂亮的皮肤就是next  
`git clone https://github.com/iissnan/hexo-theme-next`  
复制hexo-theme-next目录到hexo\themes\为next
修改_config.yml中配置项theme: next  
next主题默认的Next.Muse,可以在主题配置文件hexo\themes\next\_config.yml中修改Schemes
[更换字体][8]
## 图片居左
修改E:\Hexo\themes\next\source\css\_custom\custom.styl
.post-body .fancybox img &#123;
    margin-left: 0 !important;
&#125;
## 博客更新后，打开一片空白
解决方法：替换掉 next 主题中提供的默认 DNS 加速服务。
步骤如下：
打开 /…/themes/next/_config.yml 主题配置文件，搜索jquery.min.js，将整段替换为
# FancyBox
# jquery: //cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js
# fancybox: //cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js
# fancybox_css: //cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css
jquery: https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js
fancybox: https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.1/jquery.fancybox.min.js
fancybox_css: https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.1/jquery.fancybox.min.css
hexo clean
hexo g
hexo d

# 将blog发布到公网  
- 我的在阿里云（原万网）上买的域名，设置一条CNAME即可  
CNAME    @    默认	nsxq.github.io	
- 在hexo\source 目录下新建一个文件CNAME，内容为  
islocal.cc
- 修改_config.yml中url为  
url: http://islocal.cc  
- hexo g
- hexo d
浏览器就可以使用http://islocal.cc 访问blog了

# 文章链接唯一化
修改站点配置文件E:\Hexo\_config.yml
permalink: arlo/:abbrlink/
abbrlink:
  alg: crc32  # 算法：crc16(default) and crc32
  rep: hex    # 进制：dec(default) and hex

# 编写第一篇博文
- 是不是终于搭建完成了，懵逼了，完全不知道干吗了？
- 是不是搭建完发现blog上不能直接编写很惊讶？
- 是不是终于google到可以使用markdown语法编写，从来没用过？
- 这都不是事儿！
**教程奉上**
[markdown快速入门][4]
[Hexo博客的写作][3]
**工具奉上**
[马克飞象][5]
[在线markdown编辑器][6]
[让Baidu和Google收录Hexo博客][9]

# 参考文档
[Hexo官方中文文档][7]

[0]:http://kaimingwan.com/post/gong-ju/farbox-jekyll-octopress-ghost-hexodeng-zhu-liu-bo-ke-sheng-cheng-qi-te-dian-gai-xuan-ze-na-ge
[1]:https://nodejs.org/en/download/  
[2]:https://git-scm.com/download/
[3]:http://wowubuntu.com/markdown/basic.html
[4]:http://www.hais2.com/2016/03/07/Hexo%20Getting%20Started%206/
[5]:https://maxiang.io/
[6]:http://mahua.jser.me/
[7]:https://hexo.io/zh-cn/docs/
[8]:http://prozhuchen.com/2015/10/05/Hexo%E5%8D%9A%E5%AE%A2%E4%B9%8B%E6%94%B9%E5%AD%97%E4%BD%93/
[9]:http://www.franktly.com/2016/07/06/%E8%AE%A9Baidu%E5%92%8CGoogle%E6%94%B6%E5%BD%95Hexo%E5%8D%9A%E5%AE%A2/
</code></pre>
]]></content>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Lustre文件系统部署</title>
    <url>/arlo/c6d9ba0c/</url>
    <content><![CDATA[<p>软件下载<br><a href="https://downloads.hpdd.intel.com/public/lustre/">https://downloads.hpdd.intel.com/public/lustre/</a><br><a href="https://downloads.hpdd.intel.com/public/e2fsprogs/1.42.7.wc1/">https://downloads.hpdd.intel.com/public/e2fsprogs/1.42.7.wc1/</a><br><a href="http://mirror.symnds.com/software/zfsonlinux/repo/epel-testing/6/x86_64/ldiskfsprogs-1.42.7.wc1.3chaos-7.ch5.1.1.x86_64.rpm">http://mirror.symnds.com/software/zfsonlinux/repo/epel-testing/6/x86_64/ldiskfsprogs-1.42.7.wc1.3chaos-7.ch5.1.1.x86_64.rpm</a></p>
<p>查看lustre版本和操作系统对应关系参考：<a href="https://wiki.hpdd.intel.com/display/PUB/Lustre+Support+Matrix">https://wiki.hpdd.intel.com/display/PUB/Lustre+Support+Matrix</a></p>
<p>2.4以后的版本支持多个mds<br>查看lustre版本<br>lctl get_param version</p>
<p>&lt;未完待续&gt;</p>
<p>参考文档：<br><a href="http://www.google.com.pg/patents/CN102169448A?cl=zh">http://www.google.com.pg/patents/CN102169448A?cl=zh</a><br><a href="http://cdn.opensfs.org/wp-content/uploads/2014/10/6-LUG-Inspur-WWWrevised.pdf">http://cdn.opensfs.org/wp-content/uploads/2014/10/6-LUG-Inspur-WWWrevised.pdf</a></p>
<p><a href="https://www.huaweicloud.com/articles/b168f462b54fefd10af1c04ff194b2b2.html">https://www.huaweicloud.com/articles/b168f462b54fefd10af1c04ff194b2b2.html</a><br><a href="https://blog.didiyun.com/index.php/2019/01/25/lustre/">https://blog.didiyun.com/index.php/2019/01/25/lustre/</a><br><a href="https://chowdera.com/2021/04/20210417222148281c.html">https://chowdera.com/2021/04/20210417222148281c.html</a><br><a href="https://wangmingjun.com/2018/06/13/%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%90%AD%E5%BB%BAlustre%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/">https://wangmingjun.com/2018/06/13/%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%90%AD%E5%BB%BAlustre%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/</a><br><a href="http://hmli.ustc.edu.cn/doc/linux/lustre/">http://hmli.ustc.edu.cn/doc/linux/lustre/</a><br><a href="https://www.cnblogs.com/wasaier/p/14672229.html">https://www.cnblogs.com/wasaier/p/14672229.html</a></p>
]]></content>
      <categories>
        <category>HPC</category>
      </categories>
      <tags>
        <tag>Lustre</tag>
        <tag>文件系统</tag>
        <tag>分布式</tag>
        <tag>集群</tag>
      </tags>
  </entry>
  <entry>
    <title>CentOs 7 firewalld 防火墙无法启动</title>
    <url>/arlo/5a65cdf4/</url>
    <content><![CDATA[<p>CentOs 7 无法启动，提示“Job for firewalld.service failed because a timeout was exceeded. See “systemctl status firewalld.service” and “journalctl -xe” for details.”</p>
<span id="more"></span>
<h1 id="排错"><a href="#排错" class="headerlink" title="排错"></a>排错</h1><p>启动报错提示如下图<br><img src="/images/2016/0922/1.jpg" alt="firewalld"><br>排错很久，发现服务没有启动，但是有一个firewall的进程<br><img src="/images/2016/0922/2.jpg" alt="firewalld"><br>kill掉这个进程，顺利启动<br><img src="/images/2016/0922/3.jpg" alt="firewalld"></p>
<h1 id="常用firewall命令"><a href="#常用firewall命令" class="headerlink" title="常用firewall命令"></a>常用firewall命令</h1><p>firewall-cmd –list-services<br>firewall-cmd –list-ports<br>firewall-cmd –add-port 80&#x2F;tcp	添加端口<br>firewall-cmd –add-service http	添加服务<br>firewall-cmd –zone&#x3D;external –add-masquerade	开启端口转发<br>firewall-cmd –zone&#x3D;external –add-forward-port&#x3D;port&#x3D;80:proto&#x3D;tcp:toport&#x3D;8080	本机80转发到本机8080<br>firewall-cmd –zone&#x3D;external –add-forward&#x3D;port&#x3D;9090:proto&#x3D;tcp:toaddr&#x3D;192.168.234.130	9090转发到另外一台机器的9090<br>firewall-cmd –zone&#x3D;external –add-forward&#x3D;port&#x3D;23:proto&#x3D;tcp:toport&#x3D;2003:toaddr&#x3D;192.168.234.130	23转发到另外一台机器的2003<br>firewall-cmd –zone&#x3D;public –add-port&#x3D;5060-5059&#x2F;udp –permanent	范围端口，永久生效<br>firewall-cmd –permanent –add-icmp-block&#x3D;echo-reply	允许ICMP响应应答报文</p>
<h1 id="顺便推荐一篇firewalld写的很好，很全的文章"><a href="#顺便推荐一篇firewalld写的很好，很全的文章" class="headerlink" title="顺便推荐一篇firewalld写的很好，很全的文章"></a>顺便推荐一篇firewalld写的很好，很全的文章</h1><p><a href="http://www.hi-linux.com/2016/05/26/CentOS%207%E4%B8%8B%E4%BD%BF%E7%94%A8FirewallD%E6%9E%84%E5%BB%BA%E5%8A%A8%E6%80%81%E9%98%B2%E7%81%AB%E5%A2%99/"><strong>CentOS 7下使用FirewallD构建动态防火墙</strong></a></p>
<p><a href="https://lists.centos.org/pipermail/centos/2014-September/145809.html">参考链接</a></p>
<hr>
]]></content>
      <categories>
        <category>Troubleshooting</category>
      </categories>
      <tags>
        <tag>firewalld</tag>
      </tags>
  </entry>
  <entry>
    <title>Xshell 使用技巧</title>
    <url>/arlo/d1d8517a/</url>
    <content><![CDATA[<p>Xshell 是一个强大的安全终端模拟软件，它支持SSH1, SSH2, 以及Microsoft Windows 平台的TELNET 协议。Xshell 通过互联网到远程主机的安全连接以及它创新性的设计和特色帮助用户在复杂的网络环境中享受他们的工作。Xshell可以在Windows界面下用来访问远端不同系统下的服务器，从而比较好的达到远程控制终端的目的。</p>
<span id="more"></span>
<ol>
<li>主界面<br><img src="/images/2016/0819/1.png" alt="xshell配图"> </li>
<li>添加链接。<br><img src="/images/2016/0819/2.png" alt="xshell配图"> </li>
<li>可以保存的，以后不用输入用户名，密码，这个是putty没有的（有利有弊，从安全方面说，有风险哇。。。）<br><img src="/images/2016/0819/3.png" alt="xshell配图"> </li>
<li>中文乱码，修改编码为 UTF-8<br><img src="/images/2016/0819/4.png" alt="xshell配图"> </li>
<li>小键盘不能输入数字。<br><img src="/images/2016/0819/5.png" alt="xshell配图"> </li>
<li>界面及字体颜色<br><img src="/images/2016/0819/6.png" alt="xshell配图"> </li>
<li>看到这个真有点相见恨晚的感觉，右键粘贴功能，这个是用putty养成的习惯（虽然之前看到网上有说,选中后，使用ctrl+insert 复制，鼠标中键粘贴），在此感谢@ 吴天！<br><img src="/images/2016/0819/7.png" alt="xshell配图"><br>最大的好处就是，你设置的这些，只需要设置一次就可以了，不用像putty里那种针对每个连接都设置一遍。<br>xftp在这里就不说了，此处省去几十字。。。。。。。</li>
<li>xshell 5 每次exit退出时候，停留在本地shell界面，需要再次关闭，取消以下选项即可(ps：有强迫症的人可以顺手打上最后那个选项勾)<br><img src="/images/2016/0819/8.jpg" alt="xshell配图"> </li>
<li>Xshell选中文字复制时中断<strong>【<a href="http://nkcoder.github.io/2014/05/05/xshell-select-interrupt-dict/">转</a>】</strong><br>在Xshell中设置了“自动将选中的文字复制到粘贴板”，之前一直没有问题，最近发现，只要选中屏幕上的文字，复制上了，但shell终端立即被中断了，即向终端发送了CTRL-C；</li>
</ol>
<p><em>很可能是“选中文字复制”与词典软件的“划词翻译”相冲突。我的原因是，最近安装了必应词典，且开启了“划词翻译”功能。<br>我在网上求助时，发现也有一些朋友遇到和我一样的问题，都是由于与词典的冲突导致的，如有道词典，关掉划译功能即可。</em><br>10. 顺手分享一个xshell的配色方案<br>将一些配置文件保存为x_shell.xcs格式</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[x_shell]</span><br><span class="line">text(bold)=ffffff</span><br><span class="line">magenta(bold)=ff00ff</span><br><span class="line">text=839496</span><br><span class="line">white(bold)=ffffff</span><br><span class="line">green=00c000</span><br><span class="line">red(bold)=ff0000</span><br><span class="line">green(bold)=00ff00</span><br><span class="line">black(bold)=808080</span><br><span class="line">red=808000</span><br><span class="line">blue=ff8040</span><br><span class="line">black=000000</span><br><span class="line">blue(bold)=8080ff</span><br><span class="line">yellow(bold)=ffff00</span><br><span class="line">cyan(bold)=00ffff</span><br><span class="line">yellow=c0c000</span><br><span class="line">magenta=c000c0</span><br><span class="line">background=002b35</span><br><span class="line">white=c0c0c0</span><br><span class="line">cyan=00c0c0</span><br><span class="line">[Names]</span><br><span class="line">count=1</span><br><span class="line">name0=x_shell</span><br></pre></td></tr></table></figure>
<p>点击工具-配色方案-导入<br><img src="/images/2016/0819/9.jpg" alt="xshell配图"><br><img src="/images/2016/0819/10.jpg" alt="xshell配图"><br>点击文件-属性-外观<br><img src="/images/2016/0819/11.jpg" alt="xshell配图"><br><img src="/images/2016/0819/12.jpg" alt="xshell配图"> </p>
<hr>
]]></content>
      <categories>
        <category>常识</category>
      </categories>
      <tags>
        <tag>xshell</tag>
        <tag>Linux</tag>
        <tag>常识</tag>
      </tags>
  </entry>
  <entry>
    <title>使用kubernetes 1.4 新特性kubeadm创建集群</title>
    <url>/arlo/f9f5730/</url>
    <content><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>kubernetes 发布的最新版本1.4，增加了很多新特性，据说只用两条命令就可以创建一个k8s集群，比起之前的搭建起来简单很多。<br>[官方文档][** <a href="http://kubernetes.io/docs/getting-started-guides/kubeadm/">http://kubernetes.io/docs/getting-started-guides/kubeadm/</a> **]</p>
<span id="more"></span>
<h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><h2 id="主机资源"><a href="#主机资源" class="headerlink" title="主机资源"></a>主机资源</h2><p>192.168.234.139	dc01<br>192.168.234.140	dc02<br>192.168.234.141	dc03</p>
<h2 id="操作系统"><a href="#操作系统" class="headerlink" title="操作系统"></a>操作系统</h2><p>推荐使用ubuntu 16 和centos 7 以上版本（我个人使用的是centos 7.2 x64）</p>
<h2 id="软件安装"><a href="#软件安装" class="headerlink" title="软件安装"></a>软件安装</h2><p>在三台机器上上分别安装docker 和 kubelet、kubectl和kubeadm </p>
<h3 id="安装docker"><a href="#安装docker" class="headerlink" title="安装docker"></a>安装docker</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">curl -sS https://get.docker.io/ |sh</span><br></pre></td></tr></table></figure>
<h3 id="安装kubelet、kubectl和kubeadm"><a href="#安装kubelet、kubectl和kubeadm" class="headerlink" title="安装kubelet、kubectl和kubeadm"></a>安装kubelet、kubectl和kubeadm</h3><p>需要安装的kubelet、kubeadm、kubectl、 kubernetes-cni这四个rpm包是google的源，正常情况下国内是连接不上的，qq群(319807078)里已经有热心网友下载下来了，安装的时候会依赖一个socat的软件包,使用</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum localinstall *.rpm </span><br></pre></td></tr></table></figure>
<h2 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h2><p>三台机器都需要启动docker和kubelet</p>
<h3 id="启动docker"><a href="#启动docker" class="headerlink" title="启动docker"></a>启动docker</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl enable docker &amp;&amp; systemctl start docker </span><br></pre></td></tr></table></figure>
<h3 id="启动kubelet"><a href="#启动kubelet" class="headerlink" title="启动kubelet"></a>启动kubelet</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl enable kubelet &amp;&amp; systemctl start kubelet  # **此时启动kubelet是失败的，因为在/etc/kubernetes下还没有生成配置文件**</span><br></pre></td></tr></table></figure>
<h3 id="下载images"><a href="#下载images" class="headerlink" title="下载images"></a>下载images</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">images=(kube-proxy-amd64:v1.4.0 kube-discovery-amd64:1.0 kubedns-amd64:1.7 kube-scheduler-amd64:v1.4.0 kube-controller-manager-amd64:v1.4.0 kube-apiserver-amd64:v1.4.0 etcd-amd64:2.2.5 kube-dnsmasq-amd64:1.3 exechealthz-amd64:1.1 pause-amd64:3.0 kubernetes-dashboard-amd64:v1.4.0)</span><br><span class="line">for imageName in $&#123;images[@]&#125; ; do</span><br><span class="line">  docker pull mritd/$imageName</span><br><span class="line">  docker tag mritd/$imageName gcr.io/google_containers/$imageName</span><br><span class="line">  docker rmi mritd/$imageName</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h1 id="搭建集群"><a href="#搭建集群" class="headerlink" title="搭建集群"></a>搭建集群</h1><h2 id="初始化集群"><a href="#初始化集群" class="headerlink" title="初始化集群"></a>初始化集群</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubeadm init --api-advertise-addresses=192.168.234.139</span><br></pre></td></tr></table></figure>
<p><img src="/images/2016/1021/01.png" alt="k8s"><br>查看日志</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">journalctl -fu kubelet</span><br></pre></td></tr></table></figure>
<p>漠然大神给出的此错误排错步骤<br>NO.1、保证 hostname 中主机名为 xxxx.com 等这种域名格式<br>NO.2、保证 hosts 文件中 有 127.0.0.1 与之对应<br>NO.3、保证 gcr 相关镜像 已经 load 到本地<br>NO.4、保证 iptables规则没问题，必要时候 -F<br>NO.5、保证 selinux 已经关闭<br>NO.6、init 之前保证 启动 kubelet，虽然启动后显示启动失败<br>NO.7、重新 init 保证用 官方 clean 步骤做下清理<br>官方清理脚本</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl stop kubelet;</span><br><span class="line">docker rm -f -v $(docker ps -q);</span><br><span class="line">find /var/lib/kubelet | xargs -n 1 findmnt -n -t tmpfs -o TARGET -T | uniq | xargs -r umount -v;</span><br><span class="line">rm -r -f /etc/kubernetes /var/lib/kubelet /var/lib/etcd;</span><br></pre></td></tr></table></figure>
<h2 id="加入集群节点"><a href="#加入集群节点" class="headerlink" title="加入集群节点"></a>加入集群节点</h2><p>保证节点上启动了docker 和kubectl</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubeadm join --token 0ab76c.b59aaa1d1ab3cf93 192.168.234.139</span><br></pre></td></tr></table></figure>
<h2 id="查看加入的节点"><a href="#查看加入的节点" class="headerlink" title="查看加入的节点"></a>查看加入的节点</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubectl get nodes</span><br></pre></td></tr></table></figure>

<p><a href="https://mritd.me/2016/10/09/kubernetes-1.4-create-cluster/">本文参考漠然大神链接</a><br><a href="https://mritd.me/">漠然大神博客地址</a><br><a href="https://github.com/kubernetes/release/tree/master/rpm">github build k8s rpm</a></p>
<hr>
]]></content>
      <categories>
        <category>DevOps</category>
      </categories>
      <tags>
        <tag>Kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title>使用阿里云Docker镜像库加速</title>
    <url>/arlo/42c94ca5/</url>
    <content><![CDATA[<h1 id="开发者账号"><a href="#开发者账号" class="headerlink" title="开发者账号"></a>开发者账号</h1><p>由于docker官方的镜像下载太慢了，于是开通了阿里云的开发者账号；<br><strong>申请开发者账号</strong><br><a href="http://console.d.aliyun.com/join.htm?spm=0.0.0.0.Xx1dX0#/docker/booster">http://console.d.aliyun.com/join.htm?spm=0.0.0.0.Xx1dX0#/docker/booster</a><br><strong>本人的专属加速器地址</strong><br><a href="https://4c2kkvb9.mirror.aliyuncs.com/">https://4c2kkvb9.mirror.aliyuncs.com</a><br><strong>阿里云docker镜像搜索地址：</strong><br><a href="https://cr.console.aliyun.com/#/imageSearch">https://cr.console.aliyun.com/#/imageSearch</a><br><strong>阿里云docker加速器</strong><br>使用加速器将会提升您在国内获取Docker官方镜像的速度！<br><a href="https://cr.console.aliyun.com/#/accelerator">https://cr.console.aliyun.com/#/accelerator</a></p>
<h1 id="加速器操作文档"><a href="#加速器操作文档" class="headerlink" title="加速器操作文档"></a>加速器操作文档</h1><p>安装或升级Docker<br>您可以通过阿里云的镜像仓库下载：**<a href="http://mirrors.aliyun.com/help/docker-engine">mirrors.aliyun.com&#x2F;help&#x2F;docker-engine</a>**</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">curl -sSL http://acs-public-mirror.oss-cn-hangzhou.aliyuncs.com/docker-engine/internet | sh -</span><br></pre></td></tr></table></figure>
<p>配置Docker加速器</p>
<p>您可以使用如下的脚本将mirror的配置添加到docker daemon的启动参数中。<br>系统要求 CentOS 7 以上，Docker 1.9 以上。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cp -n /lib/systemd/system/docker.service /etc/systemd/system/docker.service   </span><br><span class="line">sed -i &quot;s|ExecStart=/usr/bin/dockerd|ExecStart=/usr/bin/docker daemon --registry-mirror=https://4c2kkvb9.mirror.aliyuncs.com|g&quot; /etc/systemd/system/docker.service    </span><br><span class="line">systemctl daemon-reload </span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>
<h1 id="QA"><a href="#QA" class="headerlink" title="QA"></a>QA</h1><p>Q: docker pull 时候报错“ x509: certificate has expired or is not yet valid”<br>A: 此问题是由于主机的时间不同步造成的，使用ntpdate cn.ntp.org.cn 同步网络时间即可。</p>
<hr>
]]></content>
      <categories>
        <category>DevOps</category>
      </categories>
      <tags>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>升级mysql数据库字符集为utf8mb4</title>
    <url>/arlo/3b439eff/</url>
    <content><![CDATA[<p>之前公司的项目中一直使用的mysql版本(5.1.73)，使用utf8字符集，基本上没有什么问题的;<br><img src="/images/2016/0812/1.jpg" alt="之前的mysql版本"><br>现在开始做一些手机客户端之类的项目，发送表情(emoji)的时候会报错“ ‘\xF0\x9F\x98\xB1’ for column ‘body’ at row 1”；<br><img src="/images/2016/0812/2.jpg" alt="发送表情报错"></p>
<span id="more"></span>
<p>Google了一把，原因是因为表情存储需要4个字节，但是mysql的utf8字符集编码只支持1-3个字节，存储空间不够就报错了，因此需要升级一下字符集。<br>MYSQL 5.5.3之后的版本支持UTF8MB4字符集，一个字符最多能有4字节，此字符集也是完全兼容utf8的，不存在兼容性问题。<br>升级完mysql-server之后<br><img src="/images/2016/0812/3.jpg" alt="升级后的mysql版本"></p>
<p>修改配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[client]</span><br><span class="line">default-character-set = utf8mb4</span><br><span class="line">[mysql]</span><br><span class="line">default-character-set = utf8mb4</span><br><span class="line">[mysqld]</span><br><span class="line">character-set-client-handshake = FALSE</span><br><span class="line">character-set-server = utf8mb4</span><br><span class="line">collation-server = utf8mb4_unicode_ci</span><br><span class="line">init_connect=&#x27;SET NAMES utf8mb4&#x27;</span><br></pre></td></tr></table></figure>
<p>修改完这些配置文件后，之后创建的库、表就是utf8mb4格式了，但是之前的收据就需要手动修改一下了</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ALTER DATABASE database_name CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci;</span><br><span class="line">ALTER TABLE table_name CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;</span><br><span class="line">ALTER TABLE table_name CHANGE column_name VARCHAR(191) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;</span><br></pre></td></tr></table></figure>
<p>重启mysql，查看字符集<br><code>/etc/init.d/mysqld restart</code></p>
<p><strong>使用utf8mb4，需注意</strong>：<br>1.mysql-server 版本需要高于5.5.3<br>2.mysql-connector 版本需要高于5.1.3版本(建议升级到最新版，目前是5.1.39)</p>
<p><img src="/images/2016/0812/4.jpg" alt="查看字符集"><br>参考：<br><a href="http://www.wangyuxiong.com/blog/mysql-dbzi-fu-ji-sheng-ji-zhi-utf8mb4,24/">http://www.wangyuxiong.com/blog/mysql-dbzi-fu-ji-sheng-ji-zhi-utf8mb4,24/</a><br><a href="https://segmentfault.com/a/1190000000616820">https://segmentfault.com/a/1190000000616820</a></p>
]]></content>
      <categories>
        <category>Troubleshooting</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>正在启动windows卡住故障的填坑之路</title>
    <url>/arlo/4c7121ca/</url>
    <content><![CDATA[<h1 id="事件起因"><a href="#事件起因" class="headerlink" title="事件起因"></a>事件起因</h1><p>同事新买了一个ThinkPad E460，出厂系统为Windows8.1，希望修改为win7，于是开始了我的填坑之路，此故障之前在联想的S405上也遇到了一次。</p>
<h1 id="故障现象"><a href="#故障现象" class="headerlink" title="故障现象"></a>故障现象</h1><p>安装完操作系统后，出现“正在启动windows卡住”，如图:</p>
<p><img src="/images/2016/0809/1.jpg" alt="Alttext"></p>
<span id="more"></span>
<ul>
<li>更换安装版镜像</li>
<li>BIOS中硬盘模式调整</li>
<li>PE中重新分区</li>
<li>使用mhdd工具扫描硬盘</li>
</ul>
<p>做了以上步骤，实在是黔驴技穷啊，于是联系了ThinkPad的客服人员！</p>
<h2 id="使用安装版镜像，不能发现硬盘问题"><a href="#使用安装版镜像，不能发现硬盘问题" class="headerlink" title="使用安装版镜像，不能发现硬盘问题"></a>使用安装版镜像，不能发现硬盘问题</h2><p>官方客服给出的故障原因是，“原生Win7系统不包含USB3.0的驱动，所以无法使用USB3.0的U盘在USB3.0的设备上引导，且安装完系统后还需要重新安装USB3.0驱动”</p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案:"></a>解决方案:</h2><blockquote>
<p><em><strong>注：此方案仅适用于Intel芯片组的机型，AMD芯片组的机型将无法使用,文档中写明支持win7 32位系统，但是实测部分32位系统会存在问题，建议使用win7 64位系统安装</strong></em></p>
</blockquote>
<ul>
<li>从Intel官网下载<a href="https://downloadcenter.intel.com/zh-cn/download/25476/Windows7-USB3-0Creator">Windows7 USB3.0 Creator 实用程序</a></li>
<li>解压缩之前下载的软件，在解压缩路径下右键以管理员方式运行Installer_Creator.exe<br><img src="/images/2016/0809/2.png" alt="Alt text"></li>
<li>在弹出界面中点击右侧的选择按钮，选中U盘所在分区<br><img src="/images/2016/0809/3.png" alt="Alt text"></li>
<li>点击Create Image开始往U盘中添加程序，过程会比较长，Intel官方数据是15分钟，实测超过20分钟<br><img src="/images/2016/0809/4.png" alt="Alt text"></li>
<li>在出现Upadte finished！后创建结束，现在就可以使用这个U盘在USB 3.0接口上安装系统了<br><img src="/images/2016/0809/8.jpg" alt="Alt text"><br>使用安装完补丁的U盘安装完系统USB3.0驱动会自动安装上。</li>
</ul>
<h1 id="坑"><a href="#坑" class="headerlink" title="坑"></a>坑</h1><h2 id="坑一："><a href="#坑一：" class="headerlink" title="坑一："></a>坑一：</h2><p>win7，win8.1，win10 均不能讲此驱动安装到U盘上，报错如下图<br><img src="/images/2016/0809/15.png" alt="Alt text"></p>
<h2 id="坑二"><a href="#坑二" class="headerlink" title="坑二"></a>坑二</h2><p>更换Ghost版本的镜像，安装完操作系统后依然是启动到“正在启动windows”卡主，进入安全模式卡在“\Windows\System32\drivers\ahcix64s.sys 界面”</p>
<h2 id="坑三"><a href="#坑三" class="headerlink" title="坑三"></a>坑三</h2><ul>
<li>使用DG格式化整个硬盘</li>
<li>重建分区表</li>
<li>更换分区类型（MBR&#x2F;GPT）</li>
<li>激活主分区</li>
</ul>
<h2 id="其他坑"><a href="#其他坑" class="headerlink" title="其他坑"></a>其他坑</h2><p><a href="http://iknow.lenovo.com/detail/dc_093720.html">预装Win8&#x2F;8.1系统的电脑改装为Win7系统的操作步骤及常见问题</a></p>
<h1 id="填坑"><a href="#填坑" class="headerlink" title="填坑"></a>填坑</h1><p>使用<a href="https://www.microsoft.com/en-us/download/windows-usb-dvd-download-tool">Windows 7 USB DVD Download Tool</a>或者软碟通（UltraISO）制作Win7原版安装盘（不要使用Ghost镜像制作，否则后续会有报错）</p>
<ul>
<li>使用Win7光盘或者U盘（建议usb2.0的U盘）引导，进入系统安装界面<br><img src="/images/2016/0809/21.jpg" alt="Alt text"></li>
<li>按Shift + F10打开命令提示符。(Edge系列机器需要按Fn+Shift+F10)<br><img src="/images/2016/0809/22.jpg" alt="Alt text"></li>
<li>输入”Diskpart”(不用输入引号，下同)，并按回车，进入操作界面<br><img src="/images/2016/0809/23.jpg" alt="Alt text"></li>
<li>输入：”list空格disk”，查看磁盘信息。注意看磁盘容量来选择。图中465G的Disk 0是硬盘，3852M的Disk 1是用于Win7安装的U盘<br><img src="/images/2016/0809/24.jpg" alt="Alt text"></li>
<li>输入：”select 空格disk空格 0”，选择disk 0为当前操作的磁盘<br><img src="/images/2016/0809/25.jpg" alt="Alt text"></li>
<li>输入：”Clean”，清空当前磁盘分区。<br><img src="/images/2016/0809/26.jpg" alt="Alt text"></li>
<li>输入：”convert 空格 mbr”，转换为MBR分区。<br><img src="/images/2016/0809/27.jpg" alt="Alt text"></li>
<li>操作完成，关闭此命令提示符窗口，继续按照正常的方法安装Win7系统即可（由于我坑一中的usb3.0 的驱动没有填好，就使用PE安装ghost版本的镜像安装了）。</li>
</ul>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>这个故障是我在安装操作系统的时候遇到的最棘手的问题，最主要的步骤就是在dos模式下清空一下磁盘分区；这里只是记录了其中最主要的几个坑，希望给遇到的朋友一些参考。</p>
<hr>
]]></content>
      <categories>
        <category>Troubleshooting</category>
      </categories>
      <tags>
        <tag>Windows</tag>
      </tags>
  </entry>
  <entry>
    <title>Centos7下OpenVpn服务器搭建</title>
    <url>/arlo/fd972502/</url>
    <content><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>项目实施过程中，远程访问服务器方式有windows远程桌面、VNC、盗版teamviewer，向日葵、anydesk，甚至还有qq远程桌面的，错综复杂，杂乱无章，项目上没有购置硬件vpn的预算，为了结束这一尴尬的局面，决定使用开源软件openvpn自建vpn环境。</p>
<span id="more"></span>
<h1 id="系统环境"><a href="#系统环境" class="headerlink" title="系统环境"></a>系统环境</h1><p><strong>OS</strong>：CentOS Linux release 7.4.1708 (Core)<br><strong>SELinux</strong>：disabled<br><strong>firewalld</strong>：active<br><strong>openvpn</strong>：2.4.7<br><strong>easy-rsa</strong>：3.0.3</p>
<h1 id="部署openvpn软件"><a href="#部署openvpn软件" class="headerlink" title="部署openvpn软件"></a>部署openvpn软件</h1><h2 id="安装openvpn-amp-easy-rsa-软件"><a href="#安装openvpn-amp-easy-rsa-软件" class="headerlink" title="安装openvpn &amp; easy-rsa 软件"></a>安装openvpn &amp; easy-rsa 软件</h2><p><code>yum install epel-release</code><br><code>yum install openvpn easy-rsa</code><br><code>cp -r /usr/share/easy-rsa/ /etc/openvpn/easy-rsa</code><br><code>cd /etc/openvpn/easy-rsa/3.0.3</code><br><code>cp /usr/share/doc/easy-rsa-3.0.3/vars.example vars</code></p>
<h1 id="创建证书"><a href="#创建证书" class="headerlink" title="创建证书"></a>创建证书</h1><h2 id="创建ca证书"><a href="#创建ca证书" class="headerlink" title="创建ca证书"></a>创建ca证书</h2><h3 id="编辑vars文件，根据自己的环境配置"><a href="#编辑vars文件，根据自己的环境配置" class="headerlink" title="编辑vars文件，根据自己的环境配置"></a>编辑vars文件，根据自己的环境配置</h3><p><em>ps:这一步不是必须滴，不填写也可以</em></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">set_var EASYRSA_REQ_COUNTRY    &quot;CN&quot;</span><br><span class="line">set_var EASYRSA_REQ_PROVINCE   &quot;ShaanXi&quot;</span><br><span class="line">set_var EASYRSA_REQ_CITY       &quot;Xi&#x27;an&quot;</span><br><span class="line">set_var EASYRSA_REQ_ORG        &quot;islocal.cc&quot;</span><br><span class="line">set_var EASYRSA_REQ_EMAIL      &quot;xx@islocal.cc&quot;</span><br><span class="line">set_var EASYRSA_REQ_OU         &quot;My OpenVPN&quot;</span><br></pre></td></tr></table></figure>
<p><code>source /vars</code><br>进入*&#x2F;etc&#x2F;openvpn&#x2F;easy-rsa&#x2F;3.0.3*目录<br><img src="/images/2019/0428/01.png" alt="01"><br>目录初始化<br><code>./easyrsa init-pki</code>	<br>创建ca证书<br><code>./easyrsa build-ca nopass</code>	<br><img src="/images/2019/0428/02.png" alt="02"></p>
<h2 id="创建服务器证书和key"><a href="#创建服务器证书和key" class="headerlink" title="创建服务器证书和key"></a>创建服务器证书和key</h2><p><code>./easyrsa gen-req server nopass</code> #生成下列两个文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">req: /etc/openvpn/easy-rsa/3.0.3/pki/reqs/server.req</span><br><span class="line">key: /etc/openvpn/easy-rsa/3.0.3/pki/private/server.key</span><br></pre></td></tr></table></figure>
<p><img src="/images/2019/0428/03.png" alt="03"></p>
<h2 id="签约服务端证书"><a href="#签约服务端证书" class="headerlink" title="签约服务端证书"></a>签约服务端证书</h2><p>生成服务器证书文件<br><code>./easyrsa sign server server</code>  </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/etc/openvpn/easy-rsa/3.0.3/pki/issued/server.crt</span><br></pre></td></tr></table></figure>
<p><img src="/images/2019/0428/04.png" alt="04"></p>
<h2 id="生成vpn密钥协议交换文件"><a href="#生成vpn密钥协议交换文件" class="headerlink" title="生成vpn密钥协议交换文件"></a>生成vpn密钥协议交换文件</h2><p><code>./easyrsa gen-dh</code> #可以看到我们生成的是2048位的加密文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/etc/openvpn/easy-rsa/3.0.3/pki/dh.pem</span><br></pre></td></tr></table></figure>
<p><img src="/images/2019/0428/05.png" alt="05"></p>
<h2 id="创建客户端证书"><a href="#创建客户端证书" class="headerlink" title="创建客户端证书"></a>创建客户端证书</h2><p>拷贝easy-rsa到client目录下<br><code>cp -r /usr/share/easy-rsa/ /etc/openvpn/client/</code>	<br>初始化目录<br><code>./easyrsa init-pki</code>	</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/etc/openvpn/client/easy-rsa/3.0.3/pki</span><br></pre></td></tr></table></figure>
<p>新建用户，创建客户端证书<br><code>./easyrsa gen-req ths nopass</code>	</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">req: /etc/openvpn/client/easy-rsa/3.0.3/pki/reqs/ths.req</span><br><span class="line">key: /etc/openvpn/client/easy-rsa/3.0.3/pki/private/ths.key</span><br></pre></td></tr></table></figure>
<p><img src="/images/2019/0428/06.png" alt="06"></p>
<h2 id="签约客户端证书"><a href="#签约客户端证书" class="headerlink" title="签约客户端证书"></a>签约客户端证书</h2><p><font color="#FF0000"><strong>注意：返回到服务器目录下操作！！！</strong></font><br><code>cd /etc/openvpn/easy-rsa/3.0.3</code><br><code>./easyrsa import-req /etc/openvpn/client/easy-rsa/3.0.3/pki/reqs/ths.req ths</code><br><code>./easyrsa sign client ths</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/etc/openvpn/easy-rsa/3.0.3/pki/issued/ths.crt</span><br></pre></td></tr></table></figure>
<p><img src="/images/2019/0428/07.png" alt="07"></p>
<h2 id="整理一下所有证书"><a href="#整理一下所有证书" class="headerlink" title="整理一下所有证书"></a>整理一下所有证书</h2><h3 id="服务器端证书"><a href="#服务器端证书" class="headerlink" title="服务器端证书"></a>服务器端证书</h3><p><code>mkdir /etc/openvpn/certs</code><br><code>cd /etc/openvpn/certs</code><br><code>cp /etc/openvpn/easy-rsa/3.0.3/pki/ca.crt .</code><br><code>cp /etc/openvpn/easy-rsa/3.0.3/pki/dh.pem .</code><br><code>cp /etc/openvpn/easy-rsa/3.0.3/pki/issued/server.crt .</code><br><code>cp /etc/openvpn/easy-rsa/3.0.3/pki/private/server.key .</code></p>
<h3 id="客户端证书"><a href="#客户端证书" class="headerlink" title="客户端证书"></a>客户端证书</h3><p><code>mkdir /etc/openvpn/client/ths</code><br><code>cd /etc/openvpn/client/ths</code><br><code>cp /etc/openvpn/easy-rsa/3.0.3/pki/ca.crt .</code><br><code>cp /etc/openvpn/easy-rsa/3.0.3/pki/issued/ths.crt .</code><br><code>cp /etc/openvpn/client/easy-rsa/3.0.3/pki/private/ths.key .</code></p>
<h1 id="服务器端配置文件"><a href="#服务器端配置文件" class="headerlink" title="服务器端配置文件"></a>服务器端配置文件</h1><p><code>cat /etc/openvpn/server.conf</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">local 192.168.6.23		#填写自己的openvpn服务器ip地址，默认侦听服务器上所有的ip</span><br><span class="line">port 11094				#侦听端口，默认为1194，据说网上会过滤1194端口流量，我这里修改为11094</span><br><span class="line">proto tcp				#端口协议，默认udp，开启tcp方便映射转发</span><br><span class="line">dev tun					#创建一个路由ip隧道,路由模式有tun/tap</span><br><span class="line"></span><br><span class="line">ca /etc/openvpn/certs/ca.crt	#根证书路径</span><br><span class="line">cert /etc/openvpn/certs/server.crt	#证书</span><br><span class="line">key /etc/openvpn/certs/server.key	#私钥文件（保密）</span><br><span class="line">dh /etc/openvpn/certs/dh.pem		#协议交换文件</span><br><span class="line"></span><br><span class="line">ifconfig-pool-persist /etc/openvpn/ipp.txt #记录客户端和虚拟ip的对应关系。当重启OpenVPN时，再次连接的客户端将分配到与上一次分配相同的虚拟IP地址</span><br><span class="line">server 10.66.66.0 255.255.255.0		#设置服务器端模式，并提供一个VPN子网，以便于从中为客户端分配IP地址。服务器会获取10.66.66.1 </span><br><span class="line">push &quot;route 192.168.6.0 255.255.255.0&quot;	#推送路由信息到客户端，以允许客户端能够连接到服务器背后的其他私有子网。</span><br><span class="line">#push &quot;redirect-gateway def1 bypass-dhcp&quot; </span><br><span class="line"># 启用该指令，所有客户端的默认网关都将重定向到VPN，这将导致诸如web浏览器、DNS查询等所有客户端流量都经过VPN。</span><br><span class="line">push &quot;dhcp-option DNS 223.5.5.5&quot;	</span><br><span class="line">push &quot;dhcp-option DNS 223.6.6.6&quot;</span><br><span class="line">client-to-client		#允许拨号连接vpn的客户端之间相互通信</span><br><span class="line">keepalive 10 120	# 默认每10秒钟ping一次，如果120秒内都没有收到对方的回复，则表示远程连接已经关闭</span><br><span class="line">comp-lzo		# 在VPN连接上启用压缩。如果你在此处启用了该指令，那么也应该在每个客户端配置文件中启用它。</span><br><span class="line">#duplicate-cn	#打开后允许多个客户端使用同一个帐号连接</span><br><span class="line">user openvpn</span><br><span class="line">group openvpn</span><br><span class="line">max-clients 100</span><br><span class="line">persist-key		</span><br><span class="line">persist-tun		#通过keepalive检测vpn超时后，当重新启动vpn后，保持tun或者tap设备自动连接状态</span><br><span class="line">status openvpn-status.log	# 状态日志</span><br><span class="line">log-append  openvpn.log</span><br><span class="line">verb 1	#指定日志文件冗余</span><br><span class="line"># 为日志文件设置适当的冗余级别(0~9)。冗余级别越高，输出的信息越详细。</span><br><span class="line"># 0 表示静默运行，只记录致命错误。</span><br><span class="line"># 4 表示合理的常规用法。</span><br><span class="line"># 5 和 6 可以帮助调试连接错误。</span><br><span class="line"># 9 表示极度冗余，输出非常详细的日志信息。</span><br><span class="line">mute 20	#相同类别的信息只有前20条会输出到日志文件中。</span><br></pre></td></tr></table></figure>
<h2 id="启动openvpn服务"><a href="#启动openvpn服务" class="headerlink" title="启动openvpn服务"></a>启动openvpn服务</h2><p><code>systemctl start openvpn@server</code><br>启动服务器后，我们可以监控&#x2F;etc&#x2F;openvpn&#x2F;openvpn.log日志，如果有异常，可根据日志排查。<br>我们查看一下ip地址，可以看到tun0获取到的是10.66.66.1<br><img src="/images/2019/0428/08.png" alt="08"></p>
<h2 id="设置开机自启动服务"><a href="#设置开机自启动服务" class="headerlink" title="设置开机自启动服务"></a>设置开机自启动服务</h2><p><code>systemctl enable openvpn@server</code></p>
<h1 id="防火墙策略"><a href="#防火墙策略" class="headerlink" title="防火墙策略"></a>防火墙策略</h1><h2 id="开启内核路由转发"><a href="#开启内核路由转发" class="headerlink" title="开启内核路由转发"></a>开启内核路由转发</h2><p><code>echo &quot;net.ipv4.ip_forward = 1&quot; &gt;&gt; /etc/sysctl.conf</code><br><code>sysctl -p</code></p>
<h2 id="开放vpn监听端口"><a href="#开放vpn监听端口" class="headerlink" title="开放vpn监听端口"></a>开放vpn监听端口</h2><p><code>firewall-cmd --zone=public --add-port=11094/tcp --permanent</code><br><code>firewall-cmd --permanent --zone=public --add-masquerade</code><br><code>firewall-cmd --permanent --zone=public --add-rich-rule=&#39;rule family=ipv4 source address=10.66.66.0/24 masquerade&#39;</code><br><code>firewall-cmd --reload</code></p>
<h1 id="客户端测试"><a href="#客户端测试" class="headerlink" title="客户端测试"></a>客户端测试</h1><h2 id="安装Windows客户端"><a href="#安装Windows客户端" class="headerlink" title="安装Windows客户端"></a>安装Windows客户端</h2><p><code>https://build.openvpn.net/downloads/releases/openvpn-install-2.4.7-I607-Win7.exe</code><br><code>https://build.openvpn.net/downloads/releases/openvpn-install-2.4.7-I607-Win10.exe</code><br>将&#x2F;etc&#x2F;openvpn&#x2F;client&#x2F;ths目录下的ca.crt、ths.crt、ths.key复制到“C:\Program Files\OpenVPN\config”目录下<br>在此目录下新建一个client.ovpn文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">client   </span><br><span class="line">proto tcp  </span><br><span class="line">dev tun    </span><br><span class="line">remote 192.168.6.23 11094</span><br><span class="line">ca ca.crt   </span><br><span class="line">cert ths.crt</span><br><span class="line">key ths.key      </span><br><span class="line">resolv-retry infinite</span><br><span class="line">nobind</span><br><span class="line">mute-replay-warnings</span><br><span class="line">keepalive 20 120</span><br><span class="line">comp-lzo</span><br><span class="line">#user openvpn</span><br><span class="line">#group openvpn</span><br><span class="line">persist-key</span><br><span class="line">persist-tun</span><br><span class="line">status openvpn-status.log</span><br><span class="line">log-append openvpn.log</span><br><span class="line">verb 3</span><br><span class="line">mute 20</span><br></pre></td></tr></table></figure>
<p>使用管理员权限启动“OpenVPN GUI”<br><img src="/images/2019/0428/09.png" alt="09"><br><img src="/images/2019/0428/10.png" alt="10"></p>
<p>参考链接:<br><a href="https://build.openvpn.net/downloads/releases/">https://build.openvpn.net/downloads/releases/</a><br><a href="https://www.cnblogs.com/irockcode/p/7587421.html">https://www.cnblogs.com/irockcode/p/7587421.html</a><br><a href="https://www.cnblogs.com/tielemao/p/9603696.html">https://www.cnblogs.com/tielemao/p/9603696.html</a></p>
]]></content>
  </entry>
  <entry>
    <title>OpenVPN使用用户名密码验证登录</title>
    <url>/arlo/b525080b/</url>
    <content><![CDATA[<p>书接上文，咱们说到<a href="http://islocal.cc/arlo/fd972502/">Centos7下OpenVpn服务器搭建</a> ，使用证书验证，如果偷懒多人使用同一个证书，感觉不是很安全，如果新建多个账号，也不是很方便，所以想着使用用户名密码去验证。使用用户名密码验证的常见做法有两种，一种是借助<code>pam_mysql.so</code>,另一种是使用<code>checkpsw</code>方式，本文使用第二种方式，比较简单。搭建过程和上文基本一样，只需要创建服务器端证书，不需要客户端证书。</p>
<span id="more"></span>
<h1 id="修改服务端配置文件"><a href="#修改服务端配置文件" class="headerlink" title="修改服务端配置文件"></a>修改服务端配置文件</h1><p>修改服务器端配置文件<code>vim /etc/openvpn/server.conf</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">local 192.168.6.23</span><br><span class="line">port 11094</span><br><span class="line">proto tcp</span><br><span class="line">dev tun</span><br><span class="line"></span><br><span class="line">ca /etc/openvpn/certs/ca.crt</span><br><span class="line">cert /etc/openvpn/certs/server.crt</span><br><span class="line">key /etc/openvpn/certs/server.key</span><br><span class="line">dh /etc/openvpn/certs/dh.pem</span><br><span class="line">tls-auth ta.key 0</span><br><span class="line">cipher AES-256-GCM</span><br><span class="line"></span><br><span class="line">ifconfig-pool-persist /etc/openvpn/ipp.txt</span><br><span class="line">#以下四行配置文件未新添加的的</span><br><span class="line">auth-user-pass-verify /etc/openvpn/checkpsw.sh via-env</span><br><span class="line">verify-client-cert none</span><br><span class="line">username-as-common-name</span><br><span class="line">script-security 3</span><br><span class="line"></span><br><span class="line">server 10.66.66.0 255.255.255.0</span><br><span class="line">push &quot;route 192.168.6.0 255.255.255.0&quot;</span><br><span class="line">push &quot;route 192.168.10.0 255.255.255.0&quot;</span><br><span class="line">#push &quot;redirect-gateway def1 bypass-dhcp&quot;</span><br><span class="line"></span><br><span class="line">push &quot;dhcp-option DNS 223.5.5.5&quot;</span><br><span class="line">push &quot;dhcp-option DNS 223.6.6.6&quot;</span><br><span class="line">topology subnet</span><br><span class="line">client-to-client</span><br><span class="line"></span><br><span class="line">keepalive 20 120</span><br><span class="line">comp-lzo</span><br><span class="line">duplicate-cn</span><br><span class="line">user openvpn</span><br><span class="line">group openvpn</span><br><span class="line">persist-key</span><br><span class="line">persist-tun</span><br><span class="line">status openvpn-status.log</span><br><span class="line">log-append  openvpn.log</span><br><span class="line">verb 3</span><br><span class="line">mute 20</span><br></pre></td></tr></table></figure>
<h1 id="新建一个key"><a href="#新建一个key" class="headerlink" title="新建一个key"></a>新建一个key</h1><p>tls-auth 在 SSL&#x2F;TLS 握手包的基础上增加了额外的签名，以提供更高的安全性</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">openvpn --genkey --secret /etc/openvpn/ta.key</span><br></pre></td></tr></table></figure>
<h1 id="新建shell脚本"><a href="#新建shell脚本" class="headerlink" title="新建shell脚本"></a>新建shell脚本</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">###########################################################</span><br><span class="line"># checkpsw.sh (C) 2004 Mathias Sundman &lt;mathias@openvpn.se&gt;</span><br><span class="line">#</span><br><span class="line"># This script will authenticate OpenVPN users against</span><br><span class="line"># a plain text file. The passfile should simply contain</span><br><span class="line"># one row per user with the username first followed by</span><br><span class="line"># one or more space(s) or tab(s) and then the password.</span><br><span class="line">PASSFILE=&quot;/etc/openvpn/psw-file&quot;</span><br><span class="line">LOG_FILE=&quot;/etc/openvpn/openvpn-password.log&quot;</span><br><span class="line">TIME_STAMP=`date &quot;+%Y-%m-%d %T&quot;`</span><br><span class="line">###########################################################</span><br><span class="line">if [ ! -r &quot;$&#123;PASSFILE&#125;&quot; ]; then</span><br><span class="line">  echo &quot;$&#123;TIME_STAMP&#125;: Could not open password file \&quot;$&#123;PASSFILE&#125;\&quot; for reading.&quot; &gt;&gt; $&#123;LOG_FILE&#125;</span><br><span class="line">  exit 1</span><br><span class="line">fi</span><br><span class="line">CORRECT_PASSWORD=`awk &#x27;!/^;/&amp;&amp;!/^#/&amp;&amp;$1==&quot;&#x27;$&#123;username&#125;&#x27;&quot;&#123;print $2;exit&#125;&#x27; $&#123;PASSFILE&#125;`</span><br><span class="line">if [ &quot;$&#123;CORRECT_PASSWORD&#125;&quot; = &quot;&quot; ]; then</span><br><span class="line">  echo &quot;$&#123;TIME_STAMP&#125;: User does not exist: username=\&quot;$&#123;username&#125;\&quot;, password=\&quot;$&#123;password&#125;\&quot;.&quot; &gt;&gt; $&#123;LOG_FILE&#125;</span><br><span class="line">  exit 1</span><br><span class="line">fi</span><br><span class="line">if [ &quot;$&#123;password&#125;&quot; = &quot;$&#123;CORRECT_PASSWORD&#125;&quot; ]; then</span><br><span class="line">  echo &quot;$&#123;TIME_STAMP&#125;: Successful authentication: username=\&quot;$&#123;username&#125;\&quot;.&quot; &gt;&gt; $&#123;LOG_FILE&#125;</span><br><span class="line">  exit 0</span><br><span class="line">fi</span><br><span class="line">echo &quot;$&#123;TIME_STAMP&#125;: Incorrect password: username=\&quot;$&#123;username&#125;\&quot;, password=\&quot;$&#123;password&#125;\&quot;.&quot; &gt;&gt; $&#123;LOG_FILE&#125;</span><br><span class="line">exit 1</span><br></pre></td></tr></table></figure>
<p>赋予脚本权限<br><code>chmod 755 checkpsw.sh</code></p>
<h1 id="新建用户密码配置文件psw-file"><a href="#新建用户密码配置文件psw-file" class="headerlink" title="新建用户密码配置文件psw-file"></a>新建用户密码配置文件psw-file</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#用户名  密码</span><br><span class="line">ths1    123456</span><br><span class="line">ths2	123456</span><br><span class="line">ths3	123456</span><br></pre></td></tr></table></figure>
<p><code>chmod 600 /etc/openvpn/psw-file</code><br><code>chown openvpn.openvpn /etc/openvpn/psw-file</code><br><code>touch /etc/openvpn/openvpn-password.log</code><br><code>chown openvpn.openvpn /etc/openvpn/openvpn-password.log</code><br><code>chmod 644 /etc/openvpn/openvpn-password.log</code></p>
<h1 id="重启服务"><a href="#重启服务" class="headerlink" title="重启服务"></a>重启服务</h1><p><code>systemctl restart openvpn@server</code><br><code>systemctl enable openvpn@server</code></p>
<h1 id="客户端测试"><a href="#客户端测试" class="headerlink" title="客户端测试"></a>客户端测试</h1><p>编辑<code>C:\Program Files\OpenVPN\config\sx3.ovpn</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">client   </span><br><span class="line">proto tcp  </span><br><span class="line">dev tun    </span><br><span class="line">remote 192.168.6.23 11094</span><br><span class="line">ca ca.crt     </span><br><span class="line">auth-user-pass	#使用密码验证，主要是这行</span><br><span class="line">tls-auth ta.key 1</span><br><span class="line">cipher AES-256-GCM</span><br><span class="line">resolv-retry infinite</span><br><span class="line">nobind</span><br><span class="line">mute-replay-warnings</span><br><span class="line">keepalive 20 120</span><br><span class="line">comp-lzo</span><br><span class="line">#user openvpn</span><br><span class="line">#group openvpn</span><br><span class="line">persist-key</span><br><span class="line">persist-tun</span><br><span class="line">status openvpn-status.log</span><br><span class="line">log-append openvpn.log</span><br><span class="line">verb 3</span><br><span class="line">mute 20</span><br><span class="line">route-method exe</span><br><span class="line">route-delay 2</span><br><span class="line">#忽略192.168的路由</span><br><span class="line">#pull-filter ignore &quot;route 192.168.&quot;</span><br><span class="line">#允许学习172的路由</span><br><span class="line">#pull-filter accept  &quot;route 172.&quot;</span><br><span class="line">&lt;ca&gt;</span><br><span class="line">-----BEGIN CERTIFICATE-----</span><br><span class="line">……ABCDEFG……</span><br><span class="line">-----END CERTIFICATE-----</span><br><span class="line">&lt;/ca&gt;</span><br><span class="line">&lt;tls-auth&gt;</span><br><span class="line">#</span><br><span class="line"># 2048 bit OpenVPN static key</span><br><span class="line">#</span><br><span class="line">-----BEGIN OpenVPN Static key V1-----</span><br><span class="line">……ABCDEFG……</span><br><span class="line">-----END OpenVPN Static key V1-----</span><br><span class="line">&lt;/tls-auth&gt;</span><br></pre></td></tr></table></figure>
<h1 id="客户端测试-1"><a href="#客户端测试-1" class="headerlink" title="客户端测试"></a>客户端测试</h1><p><img src="/images/2019/0514/01.png" alt="01"><br><img src="/images/2019/0514/02.png" alt="02"></p>
]]></content>
  </entry>
  <entry>
    <title>常用命令集合</title>
    <url>/arlo/ddba52eb/</url>
    <content><![CDATA[<h1 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h1><h2 id="进程查看"><a href="#进程查看" class="headerlink" title="进程查看"></a>进程查看</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">netstat -ano |findstr “8080”	#查看端口及PID</span><br><span class="line">netstat -ano |findstr “127.0.0.1”</span><br><span class="line">#tasklist 查看进程</span><br><span class="line">tasklist |findstr “nginx”</span><br><span class="line">tasklist /fi &quot;imagename eq nginx.exe&quot;</span><br><span class="line">#tskill 结束进程</span><br><span class="line">tskill nginx</span><br><span class="line">tskill 1130</span><br><span class="line">taskkill /im nginx.exe /f</span><br></pre></td></tr></table></figure>
<h2 id="查看文件被哪个进程占用"><a href="#查看文件被哪个进程占用" class="headerlink" title="查看文件被哪个进程占用"></a>查看文件被哪个进程占用</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">打开资源管理器-CPU-关联的句柄-输入文件名称</span><br></pre></td></tr></table></figure>
<h2 id="映射网络驱动器"><a href="#映射网络驱动器" class="headerlink" title="映射网络驱动器"></a>映射网络驱动器</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">net use Z: \\192.168.0.x\share /user:username password</span><br><span class="line">#断开网络驱动器</span><br><span class="line">net use Z: /del /y</span><br><span class="line">net use * /del /y</span><br></pre></td></tr></table></figure>
<h2 id="桌面图标设置"><a href="#桌面图标设置" class="headerlink" title="桌面图标设置"></a>桌面图标设置</h2><p>添加计算机图标到桌面</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rundll32.exe shell32.dll,Control_RunDLL desk.cpl,,0</span><br></pre></td></tr></table></figure>
<h2 id="查看系统启动时间"><a href="#查看系统启动时间" class="headerlink" title="查看系统启动时间"></a>查看系统启动时间</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systeminfo|find &quot;系统启动时间&quot;</span><br></pre></td></tr></table></figure>
<h1 id="查看硬盘序列号"><a href="#查看硬盘序列号" class="headerlink" title="查看硬盘序列号"></a>查看硬盘序列号</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wmic diskdrive get model,serialnumber</span><br></pre></td></tr></table></figure>

<h2 id="常用快捷命令"><a href="#常用快捷命令" class="headerlink" title="常用快捷命令"></a>常用快捷命令</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">winver		# 查看操作版本信息</span><br><span class="line">msinfo32	# 查看系统信息</span><br><span class="line">control.exe	# 控制面板</span><br><span class="line">sysdm.cpl	# 系统属性</span><br><span class="line">devmgmt.msc	# 设备管理器</span><br><span class="line">compmgmt.msc	# 计算机管理</span><br><span class="line">wf.msc		# 防火墙管理</span><br></pre></td></tr></table></figure>
<h2 id="网络与共享中心"><a href="#网络与共享中心" class="headerlink" title="网络与共享中心"></a>网络与共享中心</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">control.exe /name Microsoft.NetworkAndSharingCenter</span><br></pre></td></tr></table></figure>
<h2 id="修复网络连接错误"><a href="#修复网络连接错误" class="headerlink" title="修复网络连接错误"></a>修复网络连接错误</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cmd</span><br><span class="line">netsh winsock reset</span><br></pre></td></tr></table></figure>
<h2 id="查看wifi密码"><a href="#查看wifi密码" class="headerlink" title="查看wifi密码"></a>查看wifi密码</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#显示您之前连接的所有 Wi-Fi 网络接口</span><br><span class="line">netsh wlan show profiles</span><br><span class="line">#显示接口详细信息 </span><br><span class="line">netsh wlan show profiles &lt;interface name&gt; key=clear</span><br></pre></td></tr></table></figure>
<h2 id="Windows下查看文件MD5值"><a href="#Windows下查看文件MD5值" class="headerlink" title="Windows下查看文件MD5值"></a>Windows下查看文件MD5值</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">certutil -hashfile filename MD5</span><br><span class="line">certutil -hashfile filename SHA1</span><br><span class="line">certutil -hashfile filename SHA256</span><br></pre></td></tr></table></figure>
<h2 id="同时ping-telnet"><a href="#同时ping-telnet" class="headerlink" title="同时ping+telnet"></a>同时ping+telnet</h2><p>从网上（ <em><a href="https://www.elifulkerson.com/projects/tcping.php">https://www.elifulkerson.com/projects/tcping.php</a></em> ）下载一个tcping.exe放置”C:\Windows\System32”目录中</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">持续测试一个端口的连通性</span><br><span class="line">tcping -t -d 192.168.6.131 22</span><br><span class="line">将结果输出到指定文件</span><br><span class="line">tcping -t -d --tee d:\pinglog.txt 192.168.6.131 22</span><br></pre></td></tr></table></figure>
<h2 id="curl-下载文件"><a href="#curl-下载文件" class="headerlink" title="curl 下载文件"></a>curl 下载文件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">--continue-at(-C)断点续传下载 </span><br><span class="line">--remote-name(-O) URL 制定远端地址</span><br><span class="line">--retry &lt;num&gt;选项在下载失败后自动重试</span><br><span class="line">--output（ -o）保存文件名</span><br><span class="line"></span><br><span class="line">D:\01-Tools\curl-8.2.0_1-win64-mingw\bin\curl.exe --retry 10 -C - -O  -o &quot;curl-8.2.0_1-win64-mingw.zip&quot; &quot;https://curl.se/windows/dl-8.2.0_1/curl-8.2.0_1-win64-mingw.zip&quot;</span><br></pre></td></tr></table></figure>

<h1 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h1><h2 id="free"><a href="#free" class="headerlink" title="free"></a>free</h2><p>查看内存使用情况</p>
<p>可用内存&#x3D;free+buffers+cached<br>以用内存&#x3D;used-buffers-cached<br>所以看内存的使用不要看used 和free ，看 -&#x2F;+ buffers&#x2F;cache 就可以了<br>查看内存插槽数</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dmidecode|grep -P -A5 &quot;Memory\s+Device&quot;|grep Size|grep -v Range</span><br></pre></td></tr></table></figure>
<p>查看内存最大容量</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dmidecode | grep -P &#x27;Maximum\s+Capacity&#x27;</span><br></pre></td></tr></table></figure>
<p>查看内存频率</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dmidecode|grep -A16 &quot;Memory Device&quot;|grep &#x27;Speed&#x27;</span><br></pre></td></tr></table></figure>
<h2 id="iostat"><a href="#iostat" class="headerlink" title="iostat"></a>iostat</h2><p>查看磁盘性能</p>
<p>iostat -x 1 5<br>%util 接近100%的时候，产生 的I&#x2F;O 请求太多，I&#x2F;O 系统已经满负荷，该磁盘可能存在瓶颈<br>%idle 小于70%的时候，I&#x2F;O 的 压力比较大，说明读取中有很多的wait</p>
<h2 id="du"><a href="#du" class="headerlink" title="du"></a>du</h2><p>查看系统目录占用空间大小</p>
<p>在根目录下执行</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">du -hsx * |sort -rh |head -10</span><br><span class="line">du -ah --max-depth=1</span><br></pre></td></tr></table></figure>
<p>推荐一款速度更快的工具ncdu</p>
<h2 id="uptime"><a href="#uptime" class="headerlink" title="uptime"></a>uptime</h2><h3 id="查看cpu的负载"><a href="#查看cpu的负载" class="headerlink" title="查看cpu的负载"></a>查看cpu的负载</h3><p>每cpu的核心当前活动进程数不大于3，表示性能良好，大于五表示严重。</p>
<h3 id="物理CPU数"><a href="#物理CPU数" class="headerlink" title="物理CPU数"></a>物理CPU数</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cat /proc/cpuinfo | grep &quot;physical id&quot; | sort | uniq</span><br></pre></td></tr></table></figure>
<h3 id="单个CPU的逻辑核心数量"><a href="#单个CPU的逻辑核心数量" class="headerlink" title="单个CPU的逻辑核心数量"></a>单个CPU的逻辑核心数量</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cat /proc/cpuinfo | fgrep &quot;cores&quot; | uniq</span><br></pre></td></tr></table></figure>
<h3 id="系统CPU线程数"><a href="#系统CPU线程数" class="headerlink" title="系统CPU线程数"></a>系统CPU线程数</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cat /proc/cpuinfo | grep &quot;processor&quot; | wc -l</span><br></pre></td></tr></table></figure>
<p>线程数&#x3D;物理cpu数x单个逻辑cpu核心数，表示没有开启多线程</p>
<h2 id="dd"><a href="#dd" class="headerlink" title="dd"></a>dd</h2><p>瞬间创建（1T）大文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dd if=/dev/zero of=file bs=1G seek=1024 count=0</span><br></pre></td></tr></table></figure>
<p>这个文件用ll -h 看着是1TB的，用du -sh 看着是空文件，随着写入的数据而增长</p>
<p>dd制作ISO镜像</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dd if=/dev/cdrom of=/mnt/cd1.iso</span><br></pre></td></tr></table></figure>
<h2 id="shopt"><a href="#shopt" class="headerlink" title="shopt"></a>shopt</h2><p>选择性删除文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">shopt -s extglob 打开</span><br><span class="line">rm -fr !(file1|file2)</span><br><span class="line">shopt -u extglob #关闭</span><br></pre></td></tr></table></figure>
<h2 id="dstat"><a href="#dstat" class="headerlink" title="dstat"></a>dstat</h2><p>监控系统状态</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">alias dstat=&#x27;dstat -cdlmnpsy&#x27;</span><br></pre></td></tr></table></figure>
<h2 id="iftop"><a href="#iftop" class="headerlink" title="iftop"></a>iftop</h2><p>n 显示ip&#x2F;主机名<br>p 显示端口<br>l 输入过滤内容<br><a href="http://www.vpser.net/manage/iftop.html">http://www.vpser.net/manage/iftop.html</a></p>
<h2 id="网卡灯闪烁"><a href="#网卡灯闪烁" class="headerlink" title="网卡灯闪烁"></a>网卡灯闪烁</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ethtool -p eth0</span><br></pre></td></tr></table></figure>
<h2 id="查找局域网ip地址冲突"><a href="#查找局域网ip地址冲突" class="headerlink" title="查找局域网ip地址冲突"></a>查找局域网ip地址冲突</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#在局域网其他机器检测目标主机，不能在本机arping检验自己的ip</span><br><span class="line">arping 192.168.1.120 </span><br><span class="line">#命令表示查看与本机在同一局域网内的所有机器的ip使用情况</span><br><span class="line">arp-scan -l</span><br><span class="line">#命令表示查看与本机在同一局域网内的所有主机的eth0网卡的ip使用情况</span><br><span class="line">arp-scan –I eth0 -l</span><br><span class="line"># windows下可以使用</span><br><span class="line">arp -a	# 打印arp表</span><br><span class="line">arp -d	# 清除arp对应关系</span><br><span class="line">arp -s 192.168.0.1  80-8f-1d-9f-5e-b7	#绑定arp</span><br></pre></td></tr></table></figure>

<h2 id="查看wifi密码-1"><a href="#查看wifi密码-1" class="headerlink" title="查看wifi密码"></a>查看wifi密码</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">netsh wlan show profile</span><br><span class="line">netsh wlan show profiles &quot;WiFi 名称&quot; key=clear</span><br><span class="line">--示例</span><br><span class="line">netsh wlan show profiles &quot;aigo_xb&quot; key=clear</span><br></pre></td></tr></table></figure>
<h2 id="查询当前网络公网ip"><a href="#查询当前网络公网ip" class="headerlink" title="查询当前网络公网ip"></a>查询当前网络公网ip</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">curl ipinfo.io</span><br><span class="line">curl cip.cc</span><br><span class="line">curl -L ipconfig.me</span><br><span class="line">curl -L ip.tool.lu</span><br></pre></td></tr></table></figure>
<h1 id="给ping加上时间信息"><a href="#给ping加上时间信息" class="headerlink" title="给ping加上时间信息"></a>给ping加上时间信息</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ping &lt;ip_address&gt; | awk &#x27;&#123; print $0&quot;\t&quot; strftime(&quot;%Y-%m-%d %H:%M:%S&quot;,systime())&#125;&#x27;  </span><br><span class="line">ping &lt;ip_address&gt; | while read pong; do echo &quot;$(date +%F_%T): $pong&quot;; done</span><br></pre></td></tr></table></figure>

<h1 id="vim对比编辑工具"><a href="#vim对比编辑工具" class="headerlink" title="vim对比编辑工具"></a>vim对比编辑工具</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 光标移动</span><br><span class="line">## 可以使用下列两种快捷键，在文件的各个差异点之间前后移动：</span><br><span class="line"></span><br><span class="line">], c：跳转到下个差异点</span><br><span class="line">[, c：跳转到上个差异点</span><br><span class="line"></span><br><span class="line">## 光标在两个窗口之前的切换，可以使用如下按键：</span><br><span class="line"></span><br><span class="line">Ctrl-w, l：光标切换到右侧的窗口</span><br><span class="line">Ctrl-w, h：光标切换到左侧的窗口</span><br><span class="line">Ctrl-w, w：光标在两个窗口间彼此切换</span><br><span class="line"></span><br><span class="line">## 内容合并</span><br><span class="line">d,o 左边覆盖右边（当前光标在左侧）</span><br><span class="line">d,p 右边覆盖左边（当前光标在左侧）</span><br></pre></td></tr></table></figure>

<h1 id="top监控进程"><a href="#top监控进程" class="headerlink" title="top监控进程"></a>top监控进程</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">top -bc |grep [进程名]</span><br></pre></td></tr></table></figure>

<h1 id="终端快捷键"><a href="#终端快捷键" class="headerlink" title="终端快捷键"></a>终端快捷键</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ctrl + a	移动光标到行首</span><br><span class="line">ctrl + e	移动光标到行尾（好像不生效）</span><br><span class="line">ctrl + r	查找历史命令</span><br><span class="line">ctrl + u	删除从光标到行首</span><br><span class="line">ctrl + k	删除从光标到行尾</span><br><span class="line">ctrl + w	删除从光标到前一个空格</span><br><span class="line">ctrl + l	清屏</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>常识</category>
      </categories>
      <tags>
        <tag>常识</tag>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>给下拉菜单和鼠标右键截图</title>
    <url>/arlo/8fb14fc6/</url>
    <content><![CDATA[<h1 id="调用常用的QQ软件截图"><a href="#调用常用的QQ软件截图" class="headerlink" title="调用常用的QQ软件截图"></a>调用常用的QQ软件截图</h1><p><strong>1. 登陆qq</strong><br><strong>2. 同时按住Crtl+Alt+Shift</strong><br><strong>3. 松开Shift，其他两个手指不用松开</strong><br><strong>4. 按住A</strong><br><strong>5. 截图</strong></p>
]]></content>
      <tags>
        <tag>windows</tag>
      </tags>
  </entry>
  <entry>
    <title>Oracle 11.2.0.4.0打PSU24006111(11.2.0.4.161018)</title>
    <url>/arlo/582decea/</url>
    <content><![CDATA[<p>系统环境：CentOS 6.9 &#x2F; Oracle 11.2.0.4 x64<br>** 软件链接: <a href="https://pan.baidu.com/s/16dlRzILi7p3LTd6lXVQy_g">https://pan.baidu.com/s/16dlRzILi7p3LTd6lXVQy_g</a> 提取码: fkrj **</p>
<h1 id="Oracle补丁术语介绍"><a href="#Oracle补丁术语介绍" class="headerlink" title="Oracle补丁术语介绍"></a>Oracle补丁术语介绍</h1><p>补丁概念请参考：<a href="https://blog.csdn.net/DBDeep/article/details/72904608">https://blog.csdn.net/DBDeep/article/details/72904608</a><br>我们今天安装的是打PSU补丁，就是DBA&amp;DMA们常论道的PSU。Oracle 选取在每个季度用户下载数量最多，并且得到验证具有较低风险的补丁放入到每个季度的PSU中，修复比较严重的一些问题，包含每个季度的CPU，是累积型的。虽然在描述PSU的时候会用到数据库版本第5位，比如Database PSU 11.2.0.3.5，但实际上打完PSU后并不会真正改变数据库的版本，从v$version中看到的版本还是4位的(11.2.0.3.0)，第5位仍然是0。<br>(1)Windows上没有CPU和PSU，对于Windows和Exadata，Oracle使用Bundle Patch代替PSU，Bundle Patch会包含PSU的内容<br>(2)从11.2.0.2版本开始，一个新的补丁策略被引入，11.2.0.1之后发布的Patch Set本身就是一个完整的安装包，不再需要基础的Release 版本安装。</p>
<p><em>Note 2118136.2 psu补丁号快速查询Quick Reference to Patch Numbers for Database PSU, SPU(CPU), Bundle Patches and Patchsets (文档 ID 1454618.1)</em></p>
<span id="more"></span>
<h1 id="查看当前补丁状态"><a href="#查看当前补丁状态" class="headerlink" title="查看当前补丁状态"></a>查看当前补丁状态</h1><h2 id="检查环境变量"><a href="#检查环境变量" class="headerlink" title="检查环境变量"></a>检查环境变量</h2><p>确保$PATH中包含以下可执行文件:make,ar,ld和nm</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[oracle@ora1 ~]$ which make</span><br><span class="line">/usr/bin/make</span><br><span class="line">[oracle@ora1 ~]$ which ar</span><br><span class="line">/usr/bin/ar</span><br><span class="line">[oracle@ora1 ~]$ which ld</span><br><span class="line">/usr/bin/ld</span><br><span class="line">[oracle@ora1 ~]$ which nm</span><br><span class="line">/usr/bin/nm</span><br></pre></td></tr></table></figure>

<h2 id="检查-amp-升级OPatch版本"><a href="#检查-amp-升级OPatch版本" class="headerlink" title="检查&amp;升级OPatch版本"></a>检查&amp;升级OPatch版本</h2><p>必须使用OPatch实用程序版本11.2.0.3.6或更高版本<br><code>$ORACLE_HOME/OPatch/opatch version</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">OPatch Version: 11.2.0.3.4</span><br></pre></td></tr></table></figure>
<p>这个版本不满足我们的要求，我们需要下载p6880880_112000_Linux-x86-64.zip，替换当前的OPatch<br><code>cd $ORACLE_HOME</code><br><code>mv OPatch OPatch_bak</code><br><code>unzip p6880880_112000_Linux-x86-64.zip -d $ORACLE_HOME</code><br><code>$ORACLE_HOME/OPatch/opatch version</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">OPatch Version: 11.2.0.3.19</span><br></pre></td></tr></table></figure>
<h2 id="查看当前补丁状态-1"><a href="#查看当前补丁状态-1" class="headerlink" title="查看当前补丁状态"></a>查看当前补丁状态</h2><p><code>opatch lsinventory</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[oracle@ora1 sf]$ opatch lsinventory</span><br><span class="line">Oracle Interim Patch Installer version 11.2.0.3.19</span><br><span class="line">Copyright (c) 2019, Oracle Corporation.  All rights reserved.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Oracle Home       : /u01/app/oracle/product/11.2.0.4/db_1</span><br><span class="line">Central Inventory : /u01/app/oraInventory</span><br><span class="line">   from           : /u01/app/oracle/product/11.2.0.4/db_1/oraInst.loc</span><br><span class="line">OPatch version    : 11.2.0.3.19</span><br><span class="line">OUI version       : 11.2.0.4.0</span><br><span class="line">Log file location : /u01/app/oracle/product/11.2.0.4/db_1/cfgtoollogs/opatch/opatch2019-01-24_22-21-59PM_1.log</span><br><span class="line"></span><br><span class="line">Lsinventory Output file location : /u01/app/oracle/product/11.2.0.4/db_1/cfgtoollogs/opatch/lsinv/lsinventory2019-01-24_22-21-59PM.txt</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">Local Machine Information::</span><br><span class="line">Hostname: localhost</span><br><span class="line">ARU platform id: 226</span><br><span class="line">ARU platform description:: Linux x86-64</span><br><span class="line"></span><br><span class="line">Installed Top-level Products (1): </span><br><span class="line"></span><br><span class="line">Oracle Database 11g                                                  11.2.0.4.0</span><br><span class="line">There are 1 products installed in this Oracle Home.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">There are no Interim patches installed in this Oracle Home.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">OPatch succeeded.</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="检测补丁兼容性"><a href="#检测补丁兼容性" class="headerlink" title="检测补丁兼容性"></a>检测补丁兼容性</h1><h2 id="检查补丁是否冲突"><a href="#检查补丁是否冲突" class="headerlink" title="检查补丁是否冲突"></a>检查补丁是否冲突</h2><p>首先我们上传补丁文件p24006111_112040_Linux-x86-64.zip到数据库服务器上<br><code>unzip p24006111_112040_Linux-x86-64.zip</code><br><code>cd 24006111</code><br><code>opatch prereq CheckConflictAgainstOHWithDetail -ph ./</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[oracle@ora1 24006111]$ opatch prereq CheckConflictAgainstOHWithDetail -ph ./</span><br><span class="line">Oracle Interim Patch Installer version 11.2.0.3.19</span><br><span class="line">Copyright (c) 2019, Oracle Corporation.  All rights reserved.</span><br><span class="line"></span><br><span class="line">PREREQ session</span><br><span class="line"></span><br><span class="line">Oracle Home       : /u01/app/oracle/product/11.2.0.4/db_1</span><br><span class="line">Central Inventory : /u01/app/oraInventory</span><br><span class="line">   from           : /u01/app/oracle/product/11.2.0.4/db_1/oraInst.loc</span><br><span class="line">OPatch version    : 11.2.0.3.19</span><br><span class="line">OUI version       : 11.2.0.4.0</span><br><span class="line">Log file location : /u01/app/oracle/product/11.2.0.4/db_1/cfgtoollogs/opatch/opatch2019-01-24_22-22-48PM_1.log</span><br><span class="line"></span><br><span class="line">Invoking prereq &quot;checkconflictagainstohwithdetail&quot;</span><br><span class="line"></span><br><span class="line">Prereq &quot;checkConflictAgainstOHWithDetail&quot; passed.</span><br><span class="line"></span><br><span class="line">OPatch succeeded.</span><br></pre></td></tr></table></figure>
<h2 id="查看组件信息"><a href="#查看组件信息" class="headerlink" title="查看组件信息"></a>查看组件信息</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">set linesize 150;</span><br><span class="line">set pagesize 9999;</span><br><span class="line">col comp_name format a40;</span><br><span class="line">SELECT COMP_NAME, VERSION, STATUS FROM SYS.DBA_REGISTRY;</span><br></pre></td></tr></table></figure>
<h2 id="查看补丁状态"><a href="#查看补丁状态" class="headerlink" title="查看补丁状态"></a>查看补丁状态</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">set linesize 500 pagesize 600</span><br><span class="line">col ACTION_TIME for a30</span><br><span class="line">col COMMENTS for a30</span><br><span class="line">select ACTION_TIME, ACTION,version, COMMENTS from sys.DBA_REGISTRY_HISTORY;</span><br></pre></td></tr></table></figure>
<p><img src="/images/2019/0124/01.png" alt="psu"></p>
<h1 id="打补丁"><a href="#打补丁" class="headerlink" title="打补丁"></a>打补丁</h1><h2 id="关闭数据库和监听"><a href="#关闭数据库和监听" class="headerlink" title="关闭数据库和监听"></a>关闭数据库和监听</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[oracle@ora1 24006111]$ sqlplus / as sysdba</span><br><span class="line"></span><br><span class="line">SQL*Plus: Release 11.2.0.4.0 Production on Thu Jan 24 23:03:01 2019</span><br><span class="line"></span><br><span class="line">Copyright (c) 1982, 2013, Oracle.  All rights reserved.</span><br><span class="line">SYS@@orcl&gt; shutdown immediate</span><br><span class="line">Database closed.</span><br><span class="line">Database dismounted.</span><br><span class="line">ORACLE instance shut down.</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[oracle@ora1 24006111]$ lsnrctl stop</span><br><span class="line"></span><br><span class="line">LSNRCTL for Linux: Version 11.2.0.4.0 - Production on 24-JAN-2019 23:03:45</span><br><span class="line"></span><br><span class="line">Copyright (c) 1991, 2013, Oracle.  All rights reserved.</span><br><span class="line"></span><br><span class="line">Connecting to (DESCRIPTION=(ADDRESS=(PROTOCOL=IPC)(KEY=EXTPROC1521)))</span><br><span class="line">The command completed successfully</span><br></pre></td></tr></table></figure>
<p>查看数据库和监听是否彻底关闭，如果未关闭，打补丁过程中会报错。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[oracle@ora1 24006111]$ ps -ef |grep ora_</span><br><span class="line">oracle    45322  42120  2 23:04 pts/0    00:00:00 grep ora_</span><br><span class="line">[oracle@ora1 24006111]$ ps -ef |grep tns</span><br><span class="line">root         21      2  0 16:29 ?        00:00:00 [netns]</span><br><span class="line">oracle    45324  42120  0 23:04 pts/0    00:00:00 grep tns</span><br></pre></td></tr></table></figure>
<h2 id="开始打补丁"><a href="#开始打补丁" class="headerlink" title="开始打补丁"></a>开始打补丁</h2><p>每个补丁包里都有Readme.html文件，文件中有很详细的说明和操作流程</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[oracle@ora1 24006111]$ opatch apply</span><br><span class="line">Oracle Interim Patch Installer version 11.2.0.3.19</span><br><span class="line">Copyright (c) 2019, Oracle Corporation.  All rights reserved.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Oracle Home       : /u01/app/oracle/product/11.2.0.4/db_1</span><br><span class="line">Central Inventory : /u01/app/oraInventory</span><br><span class="line">   from           : /u01/app/oracle/product/11.2.0.4/db_1/oraInst.loc</span><br><span class="line">OPatch version    : 11.2.0.3.19</span><br><span class="line">OUI version       : 11.2.0.4.0</span><br><span class="line">Log file location : /u01/app/oracle/product/11.2.0.4/db_1/cfgtoollogs/opatch/opatch2019-01-24_23-15-07PM_1.log</span><br><span class="line"></span><br><span class="line">Verifying environment and performing prerequisite checks...</span><br><span class="line">OPatch continues with these patches:   17478514  18031668  18522509  19121551  19769489  20299013  20760982  21352635  21948347  22502456  23054359  24006111  </span><br><span class="line"></span><br><span class="line">Do you want to proceed? [y|n]</span><br><span class="line">y</span><br><span class="line">User Responded with: Y</span><br><span class="line">All checks passed.</span><br><span class="line">Provide your email address to be informed of security issues, install and</span><br><span class="line">initiate Oracle Configuration Manager. Easier for you if you use your My</span><br><span class="line">Oracle Support Email address/User Name.</span><br><span class="line">Visit http://www.oracle.com/support/policies.html for details.</span><br><span class="line">Email address/User Name: </span><br><span class="line"></span><br><span class="line">You have not provided an email address for notification of security issues.</span><br><span class="line">Do you wish to remain uninformed of security issues ([Y]es, [N]o) [N]:  y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Please shutdown Oracle instances running out of this ORACLE_HOME on the local system.</span><br><span class="line">(Oracle Home = &#x27;/u01/app/oracle/product/11.2.0.4/db_1&#x27;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Is the local system ready for patching? [y|n]</span><br><span class="line">y</span><br><span class="line">User Responded with: Y</span><br><span class="line">Backing up files...</span><br><span class="line">Applying sub-patch &#x27;17478514&#x27; to OH &#x27;/u01/app/oracle/product/11.2.0.4/db_1&#x27;</span><br><span class="line"></span><br><span class="line">Patching component oracle.rdbms, 11.2.0.4.0...</span><br><span class="line"></span><br><span class="line">……</span><br><span class="line">Patching component oracle.rdbms.dbscripts, 11.2.0.4.0...</span><br><span class="line">Composite patch 24006111 successfully applied.</span><br><span class="line">Log file location: /u01/app/oracle/product/11.2.0.4/db_1/cfgtoollogs/opatch/opatch2019-01-24_23-15-07PM_1.log</span><br><span class="line"></span><br><span class="line">OPatch succeeded.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="升级数据字典"><a href="#升级数据字典" class="headerlink" title="升级数据字典"></a>升级数据字典</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cd $ORACLE_HOME/rdbms/admin</span><br><span class="line">sqlplus /nolog</span><br><span class="line">SQL&gt; CONNECT / AS SYSDBA</span><br><span class="line">SQL&gt; STARTUP</span><br><span class="line">SQL&gt; @catbundle.sql psu apply </span><br><span class="line">SQL&gt; QUIT</span><br></pre></td></tr></table></figure>
<h2 id="重新编译无效对象"><a href="#重新编译无效对象" class="headerlink" title="重新编译无效对象"></a>重新编译无效对象</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cd $ORACLE_HOME/rdbms/admin</span><br><span class="line">sqlplus /nolog</span><br><span class="line">SQL&gt; CONNECT / AS SYSDBA</span><br><span class="line">SQL&gt; @utlrp.sql</span><br></pre></td></tr></table></figure>

<h1 id="验证升级结果"><a href="#验证升级结果" class="headerlink" title="验证升级结果"></a>验证升级结果</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[oracle@ora1 24006111]$ opatch lsinventory</span><br><span class="line">Oracle Interim Patch Installer version 11.2.0.3.19</span><br><span class="line">Copyright (c) 2019, Oracle Corporation.  All rights reserved.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Oracle Home       : /u01/app/oracle/product/11.2.0.4/db_1</span><br><span class="line">Central Inventory : /u01/app/oraInventory</span><br><span class="line">   from           : /u01/app/oracle/product/11.2.0.4/db_1/oraInst.loc</span><br><span class="line">OPatch version    : 11.2.0.3.19</span><br><span class="line">OUI version       : 11.2.0.4.0</span><br><span class="line">Log file location : /u01/app/oracle/product/11.2.0.4/db_1/cfgtoollogs/opatch/opatch2019-01-24_23-36-05PM_1.log</span><br><span class="line"></span><br><span class="line">Lsinventory Output file location : /u01/app/oracle/product/11.2.0.4/db_1/cfgtoollogs/opatch/lsinv/lsinventory2019-01-24_23-36-05PM.txt</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">Local Machine Information::</span><br><span class="line">Hostname: localhost</span><br><span class="line">ARU platform id: 226</span><br><span class="line">ARU platform description:: Linux x86-64</span><br><span class="line"></span><br><span class="line">Installed Top-level Products (1): </span><br><span class="line"></span><br><span class="line">Oracle Database 11g                                                  11.2.0.4.0</span><br><span class="line">There are 1 products installed in this Oracle Home.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Interim patches (1) :</span><br><span class="line"></span><br><span class="line">Patch  24006111     : applied on Thu Jan 24 23:29:17 CST 2019</span><br><span class="line">Unique Patch ID:  20508568</span><br><span class="line">Patch description:  &quot;Database Patch Set Update : 11.2.0.4.161018 (24006111)&quot;</span><br><span class="line">   Created on 26 Aug 2016, 05:54:48 hrs PST8PDT</span><br><span class="line">Sub-patch  23054359; &quot;Database Patch Set Update : 11.2.0.4.160719 (23054359)&quot;</span><br><span class="line">Sub-patch  22502456; &quot;Database Patch Set Update : 11.2.0.4.160419 (22502456)&quot;</span><br><span class="line">Sub-patch  21948347; &quot;Database Patch Set Update : 11.2.0.4.160119 (21948347)&quot;</span><br><span class="line">Sub-patch  21352635; &quot;Database Patch Set Update : 11.2.0.4.8 (21352635)&quot;</span><br><span class="line">Sub-patch  20760982; &quot;Database Patch Set Update : 11.2.0.4.7 (20760982)&quot;</span><br><span class="line">Sub-patch  20299013; &quot;Database Patch Set Update : 11.2.0.4.6 (20299013)&quot;</span><br><span class="line">Sub-patch  19769489; &quot;Database Patch Set Update : 11.2.0.4.5 (19769489)&quot;</span><br><span class="line">Sub-patch  19121551; &quot;Database Patch Set Update : 11.2.0.4.4 (19121551)&quot;</span><br><span class="line">Sub-patch  18522509; &quot;Database Patch Set Update : 11.2.0.4.3 (18522509)&quot;</span><br><span class="line">Sub-patch  18031668; &quot;Database Patch Set Update : 11.2.0.4.2 (18031668)&quot;</span><br><span class="line">Sub-patch  17478514; &quot;Database Patch Set Update : 11.2.0.4.1 (17478514)&quot;</span><br><span class="line">   Bugs fixed:</span><br><span class="line">     17184721, 21538558, 16091637, 18092127, 17381384, 15979965, 18441944</span><br><span class="line">     13837378, 16314254, 16731148, 17835048, 13558557, 17201159, 17853498</span><br><span class="line">     17246576, 18356166, 18440047, 18681862, 16875449, 19788842, 17296856</span><br><span class="line">     21330264, 14010183, 17648596, 17551063, 17025461, 17267114, 22507210</span><br><span class="line">     17912217, 17889583, 18202441, 17040764, 16524926, 17478145, 19358317</span><br><span class="line">     22148226, 18747196, 18641419, 17036973, 17811789, 14285317, 16542886</span><br><span class="line">     18009564, 16618694, 8322815, 16692232, 18247991, 22507234, 17570240</span><br><span class="line">     17848897, 17441661, 14034426, 17465741, 16596890, 17437634, 20506706</span><br><span class="line">     21343897, 21453153, 18339044, 22321741, 17951233, 18430495, 21787056</span><br><span class="line">     22380919, 20506715, 17811429, 19721304, 18230522, 19554106, 19458377</span><br><span class="line">     6599380, 17612828, 22092979, 22321756, 17040527, 17811438, 18641461</span><br><span class="line">     14657740, 13364795, 21387964, 17346671, 17588480, 18235390, 17889549</span><br><span class="line">     19309466, 16472716, 20596234, 18331850, 18641451, 17344412, 21179898</span><br><span class="line">     17546761, 18203835, 18964939, 18203838, 18203837, 17313525, 22195457</span><br><span class="line">     18139690, 22296366, 14106803, 16837842, 17842825, 22657942, 21352646</span><br><span class="line">     20657441, 16360112, 22195441, 17389192, 14565184, 17205719, 14354737</span><br><span class="line">     22195448, 14764829, 13944971, 16571443, 21868720, 17186905, 17080436</span><br><span class="line">     18673342, 17027426, 19972569, 19972568, 19972566, 17282229, 19972564</span><br><span class="line">     16870214, 19615136, 17390431, 18762750, 16613964, 18098207, 17957017</span><br><span class="line">     18471685, 19730508, 21538485, 18264060, 17323222, 17754782, 17600719</span><br><span class="line">     18317531, 17852463, 17596908, 17655634, 20074391, 16228604, 19972570</span><br><span class="line">     18996843, 19854503, 16042673, 17835627, 20334344, 18000422, 20861693</span><br><span class="line">     17393683, 17551709, 20506699, 19006849, 18456514, 18277454, 17258090</span><br><span class="line">     17174582, 17242746, 16399083, 17824637, 17762296, 17397545, 16450169</span><br><span class="line">     12364061, 20067212, 18856999, 19211724, 19463893, 21343775, 19463897</span><br><span class="line">     17853456, 18673304, 20004021, 21668627, 16194160, 17477958, 16538760</span><br><span class="line">     12982566, 20296213, 18293054, 17610798, 19699191, 18135678, 17311728</span><br><span class="line">     16785708, 10136473, 17786518, 18315328, 18334586, 12747740, 19032867</span><br><span class="line">     18096714, 17390160, 17232014, 16422541, 18673325, 18155762, 14015842</span><br><span class="line">     19827973, 22683225, 17726838, 18554871, 23177648, 18051556, 20803583</span><br><span class="line">     18282562, 17922254, 15990359, 21972320, 16855292, 16668584, 21343838</span><br><span class="line">     20299015, 17446237, 18093615, 17694209, 17288409, 17274537, 13955826</span><br><span class="line">     16934803, 17634921, 17501491, 16315398, 22683212, 17006183, 13829543</span><br><span class="line">     18191164, 17655240, 19393542, 18384391, 21538567, 16198143, 21847223</span><br><span class="line">     17892268, 20142975, 19584068, 17165204, 18508861, 21756699, 16901385</span><br><span class="line">     18554763, 18189036, 17443671, 17385178, 17936109, 14829250, 20925795</span><br><span class="line">     17478514, 16850630, 13951456, 16595641, 15861775, 14054676, 16912439</span><br><span class="line">     17299889, 17297939, 18619917, 16833527, 17798953, 17816865, 18607546</span><br><span class="line">     17571306, 21286665, 17341326, 17851160, 20558005, 17586955, 19049453</span><br><span class="line">     21051840, 17587063, 16956380, 18328509, 14133975, 18061914, 21051833</span><br><span class="line">     18522509, 18765602, 18199537, 17332800, 13609098, 18384537, 22502493</span><br><span class="line">     14338435, 17945983, 21067387, 16392068, 17752995, 21051862, 17237521</span><br><span class="line">     16863422, 18244962, 19544839, 24433711, 17156148, 18973907, 17877323</span><br><span class="line">     17449815, 18180390, 17088068, 17037130, 20004087, 19466309, 11733603</span><br><span class="line">     18084625, 21051858, 18674024, 21051852, 18091059, 16306373, 18306996</span><br><span class="line">     19915271, 18193833, 17787259, 20631274, 16344544, 14692762, 18614015</span><br><span class="line">     17346091, 18228645, 17721717, 18436307, 11883252, 21756677, 17891943</span><br><span class="line">     22353199, 16384983, 19121551, 12816846, 17982555, 17761775, 22243719</span><br><span class="line">     17265217, 17071721, 16721594, 21756661, 18262334, 15913355, 17891946</span><br><span class="line">     17672719, 17602269, 17239687, 17042658, 17238511, 17811456, 17284817</span><br><span class="line">     17752121, 17394950, 16579084, 17011832, 22195465, 14602788, 18325460</span><br><span class="line">     24476265, 24476274, 12611721, 16903536, 17006570, 16043574, 18783224</span><br><span class="line">     16494615, 21526048, 19197175, 16069901, 17811447, 17308789, 22195477</span><br><span class="line">     17865671, 19013183, 17343514, 18316692, 17325413, 16180763, 17348614</span><br><span class="line">     14368995, 21983325, 17393915, 16285691, 20331945, 17883081, 24316947</span><br><span class="line">     17705023, 17614227, 22195485, 14084247, 13645875, 16777840, 19727057</span><br><span class="line">     14852021, 18744139, 18674047, 17716305, 18482502, 19289642, 17622427</span><br><span class="line">     22195492, 14458214, 18723434, 17767676, 19258504, 17786278, 17082983</span><br><span class="line">     21351877, 13498382, 18331812, 16065166, 18031668, 22893153, 16943711</span><br><span class="line">     21517440, 17649265, 13866822, 18094246, 24528741, 14245531, 17783588</span><br><span class="line">     17082359, 20448824, 18280813, 23330119, 16268425, 17302277, 18018515</span><br><span class="line">     17215560, 19271443, 17016369, 20777150, 23330124, 20441797, 19769489</span><br><span class="line">     17545847, 18260550, 13853126, 23536835, 17227277, 9756271, 18868646</span><br><span class="line">     17614134, 17546973, 19680952, 18704244, 18828868, 18273830, 17050888</span><br><span class="line">     17360606, 16992075, 17375354, 12905058, 18362222, 17571039, 17468141</span><br><span class="line">     18436647, 17235750, 21168487, 16220077, 16929165</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">OPatch succeeded.</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">set linesize 150;</span><br><span class="line">set pagesize 9999;</span><br><span class="line">col comp_name format a40;</span><br><span class="line">SELECT COMP_NAME, VERSION, STATUS FROM SYS.DBA_REGISTRY;</span><br><span class="line">--</span><br><span class="line">set linesize 500 pagesize 600</span><br><span class="line">col ACTION_TIME for a30</span><br><span class="line">col COMMENTS for a30</span><br><span class="line">select ACTION_TIME, ACTION,version, COMMENTS from sys.DBA_REGISTRY_HISTORY;</span><br></pre></td></tr></table></figure>
<p><img src="/images/2019/0124/01.png" alt="psu"></p>
<h1 id="启动监听"><a href="#启动监听" class="headerlink" title="启动监听"></a>启动监听</h1><p><code>lsnrctl start</code></p>
<h1 id="补丁回退"><a href="#补丁回退" class="headerlink" title="补丁回退"></a>补丁回退</h1><p><code>opatch rollback -id 24006111</code></p>
<p>参考文档：<br><a href="http://blog.itpub.net/26736162/viewspace-2096650/">http://blog.itpub.net/26736162/viewspace-2096650/</a><br><a href="https://blogs.oracle.com/database4cn/oracle-v4">https://blogs.oracle.com/database4cn/oracle-v4</a><br><a href="http://blog.51cto.com/hbxztc/1884214">http://blog.51cto.com/hbxztc/1884214</a><br><a href="http://www.snapdba.com/2014/01/oracle-database-11gr2-11-2-0-4-installation-on-oracle-linux-6-4/#.XUJlIegzaUk">http://www.snapdba.com/2014/01/oracle-database-11gr2-11-2-0-4-installation-on-oracle-linux-6-4/#.XUJlIegzaUk</a></p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>PSU</tag>
        <tag>Oracle</tag>
        <tag>数据库</tag>
      </tags>
  </entry>
  <entry>
    <title>Oracle单实例配置多个监听</title>
    <url>/arlo/1651f01e/</url>
    <content><![CDATA[<h1 id="监听注册"><a href="#监听注册" class="headerlink" title="监听注册"></a>监听注册</h1><p>Oracle的注册就是将数据库作为一个服务注册到监听程序，而客户端不需要知道数据库名和实例名，只需要知道改数据库对外提供的服务名就可以申请连接到数据库。</p>
<p>动态注册：由PMON进程动态注册至监听中<br>静态注册：通过解析listene.ora文件</p>
<p>在没有listener.ora配置文件的情况下，如果启动监听，则监听为动态注册。用图形化netca创建的监听，默认也为动态注册；监听的配置文件都在<code>$ORACLE_HOME/network/admin</code>目录下，默认监听名为LISTENER，端口为1521<br><img src="/images/2019/0905/01.png" alt="05"></p>
<span id="more"></span>
<h1 id="动态监听"><a href="#动态监听" class="headerlink" title="动态监听"></a>动态监听</h1><p>在动态注册监听的环境中，listener.ora文件可以不包括当前数据库的实例信息，所以这个文件不必要。<br>实例启动时，会由Oracle PMON进程将数据库实例信息动态注册至监听上。当Oracle实例关闭时，会再次由PMON进程自动从监听里面撤销当前实例信息。<br>动态注册成功大概需要一分钟时间，注册成功状态为READY；</p>
<p>一般有3种状态：READY、BLOCKED和RESTRICED<br><strong>READY</strong>：表示数据库实例已经处于mount或者open状态，可以接受客户端连接<br><strong>BLOCKED</strong>：表示数据库实例还处于nomount状态或者该实例类型为ASM实例，不接受客户端连接，如果这时候客户端去连接数据库会报ora-12528错误<br><strong>RESTRICED</strong>：表示数据库处于RESTRICED模式，不接受普通权限的远程客户端连接，如果这时候客户端去连接数据库会报ora-12526错误</p>
<h2 id="编辑监听文件listener-ora"><a href="#编辑监听文件listener-ora" class="headerlink" title="编辑监听文件listener.ora"></a>编辑监听文件listener.ora</h2><p><code>[oracle@dbserver admin]$ cat listener.ora</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># listener.ora Network Configuration File: /u01/app/oracle/product/11.2.0/db_1/network/admin/listener.ora</span><br><span class="line"># Generated by Oracle configuration tools.</span><br><span class="line"></span><br><span class="line">LISTENER =</span><br><span class="line">  (DESCRIPTION_LIST =</span><br><span class="line">    (DESCRIPTION =</span><br><span class="line">      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))</span><br><span class="line">      (ADDRESS = (PROTOCOL = TCP)(HOST = dbserver)(PORT = 1521))</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">LISTENER2 =</span><br><span class="line">  (DESCRIPTION_LIST =</span><br><span class="line">    (DESCRIPTION =</span><br><span class="line">      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1522))</span><br><span class="line">      (ADDRESS = (PROTOCOL = TCP)(HOST = dbserver)(PORT = 1522))</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line">ADR_BASE_LISTENER = /u01/app/oracle</span><br></pre></td></tr></table></figure>
<h2 id="编辑tnsnames-ora"><a href="#编辑tnsnames-ora" class="headerlink" title="编辑tnsnames.ora"></a>编辑tnsnames.ora</h2><p><code>[oracle@dbserver admin]$ cat tnsnames.ora </code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># tnsnames.ora Network Configuration File: /u01/app/oracle/product/11.2.0/db_1/network/admin/tnsnames.ora</span><br><span class="line"># Generated by Oracle configuration tools.</span><br><span class="line"></span><br><span class="line">ORCL =</span><br><span class="line">  (DESCRIPTION =</span><br><span class="line">    (ADDRESS = (PROTOCOL = TCP)(HOST = dbserver)(PORT = 1521))</span><br><span class="line">    (CONNECT_DATA =</span><br><span class="line">      (SERVER = DEDICATED)</span><br><span class="line">      (SERVICE_NAME = orcl)</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">TEST =</span><br><span class="line">  (DESCRIPTION =</span><br><span class="line">    (ADDRESS = (PROTOCOL = TCP)(HOST = dbserver)(PORT = 1522))</span><br><span class="line">    (CONNECT_DATA =</span><br><span class="line">      (SERVER = DEDICATED)</span><br><span class="line">      (SERVICE_NAME = orcl)</span><br><span class="line">    )</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
<h2 id="启动新创建的监听LISTENER2"><a href="#启动新创建的监听LISTENER2" class="headerlink" title="启动新创建的监听LISTENER2"></a>启动新创建的监听LISTENER2</h2><p><code>[oracle@dbserver admin]$ lsnrctl start LISTENER2</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">LSNRCTL for Linux: Version 11.2.0.4.0 - Production on 05-SEP-2019 21:01:25</span><br><span class="line"></span><br><span class="line">Copyright (c) 1991, 2013, Oracle.  All rights reserved.</span><br><span class="line"></span><br><span class="line">Starting /u01/app/oracle/product/11.2.0/db_1/bin/tnslsnr: please wait...</span><br><span class="line"></span><br><span class="line">TNSLSNR for Linux: Version 11.2.0.4.0 - Production</span><br><span class="line">System parameter file is /u01/app/oracle/product/11.2.0/db_1/network/admin/listener.ora</span><br><span class="line">Log messages written to /u01/app/oracle/diag/tnslsnr/dbserver/listener2/alert/log.xml</span><br><span class="line">Listening on: (DESCRIPTION=(ADDRESS=(PROTOCOL=ipc)(KEY=EXTPROC1522)))</span><br><span class="line">Listening on: (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=dbserver)(PORT=1522)))</span><br><span class="line"></span><br><span class="line">Connecting to (DESCRIPTION=(ADDRESS=(PROTOCOL=IPC)(KEY=EXTPROC1522)))</span><br><span class="line">STATUS of the LISTENER</span><br><span class="line">------------------------</span><br><span class="line">Alias                     LISTENER2</span><br><span class="line">Version                   TNSLSNR for Linux: Version 11.2.0.4.0 - Production</span><br><span class="line">Start Date                05-SEP-2019 21:01:25</span><br><span class="line">Uptime                    0 days 0 hr. 0 min. 0 sec</span><br><span class="line">Trace Level               off</span><br><span class="line">Security                  ON: Local OS Authentication</span><br><span class="line">SNMP                      OFF</span><br><span class="line">Listener Parameter File   /u01/app/oracle/product/11.2.0/db_1/network/admin/listener.ora</span><br><span class="line">Listener Log File         /u01/app/oracle/diag/tnslsnr/dbserver/listener2/alert/log.xml</span><br><span class="line">Listening Endpoints Summary...</span><br><span class="line">  (DESCRIPTION=(ADDRESS=(PROTOCOL=ipc)(KEY=EXTPROC1522)))</span><br><span class="line">  (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=dbserver)(PORT=1522)))</span><br><span class="line">The listener supports no services</span><br><span class="line">The command completed successfully</span><br></pre></td></tr></table></figure>
<h2 id="修改实例注册到新创建的监听LISTENER2"><a href="#修改实例注册到新创建的监听LISTENER2" class="headerlink" title="修改实例注册到新创建的监听LISTENER2"></a>修改实例注册到新创建的监听LISTENER2</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[oracle@dbserver admin]$ sqlplus / as sysdba</span><br><span class="line"></span><br><span class="line">SQL*Plus: Release 11.2.0.4.0 Production on Thu Sep 5 21:05:56 2019</span><br><span class="line"></span><br><span class="line">Copyright (c) 1982, 2013, Oracle.  All rights reserved.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Connected to:</span><br><span class="line">Oracle Database 11g Enterprise Edition Release 11.2.0.4.0 - 64bit Production</span><br><span class="line">With the Partitioning, OLAP, Data Mining and Real Application Testing options</span><br><span class="line"></span><br><span class="line">SQL&gt; show parameter local_listener;</span><br><span class="line"></span><br><span class="line">NAME				     TYPE	 VALUE</span><br><span class="line">------------------------------------ ----------- ------------------------------</span><br><span class="line">local_listener			     string</span><br><span class="line">SQL&gt; alter system set local_listener=&#x27;TEST&#x27;;</span><br><span class="line"></span><br><span class="line">System altered.</span><br><span class="line"></span><br><span class="line">SQL&gt; show parameter local_listener;</span><br><span class="line"></span><br><span class="line">NAME				     TYPE	 VALUE</span><br><span class="line">------------------------------------ ----------- ------------------------------</span><br><span class="line">local_listener			     string	 TEST</span><br><span class="line">SQL&gt; </span><br></pre></td></tr></table></figure>
<p><img src="/images/2019/0905/02.png" alt="05"><br><img src="/images/2019/0905/03.png" alt="05"></p>
<p>修改之后，我们查看监听状态，可以发现orcl实例已经从默认的监听LISTENER修改为LISTENER2了。</p>
<h2 id="注册多个端口"><a href="#注册多个端口" class="headerlink" title="注册多个端口"></a>注册多个端口</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SQL&gt;  ALTER SYSTEM SET LOCAL_LISTENER=&#x27;(ADDRESS=(PROTOCOL=TCP)(HOST=192.168.100.132)(PORT=1521))&#x27;,&#x27;(ADDRESS=(PROTOCOL=TCP)(HOST=192.168.100.132)(PORT=1522))&#x27;;</span><br><span class="line"></span><br><span class="line">System altered.</span><br><span class="line"></span><br><span class="line">SQL&gt; show parameter local_listener;</span><br><span class="line"></span><br><span class="line">NAME				     TYPE	 VALUE</span><br><span class="line">------------------------------------ ----------- ------------------------------</span><br><span class="line">local_listener			     string	 (ADDRESS=(PROTOCOL=TCP)(HOST=1</span><br><span class="line">						 92.168.100.132)(PORT=1521)), (</span><br><span class="line">						 ADDRESS=(PROTOCOL=TCP)(HOST=19</span><br><span class="line">						 2.168.100.132)(PORT=1522))</span><br><span class="line">SQL&gt; alter system register;</span><br><span class="line"></span><br><span class="line">System altered.</span><br><span class="line"></span><br><span class="line">SQL&gt; </span><br></pre></td></tr></table></figure>
<p><img src="/images/2019/0905/04.png" alt="05"><br><img src="/images/2019/0905/05.png" alt="05"></p>
<h1 id="静态监听"><a href="#静态监听" class="headerlink" title="静态监听"></a>静态监听</h1><p>静态注册不管实例是否启动，在启动监听的时候都会将实例名称注册到监听中，主要用于DBA远程启动数据库实例。</p>
<h2 id="编辑监听配置文件listener-ora"><a href="#编辑监听配置文件listener-ora" class="headerlink" title="编辑监听配置文件listener.ora"></a>编辑监听配置文件listener.ora</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[oracle@dbserver admin]$ cat listener.ora </span><br><span class="line"># listener.ora Network Configuration File: /u01/app/oracle/product/11.2.0/db_1/network/admin/listener.ora</span><br><span class="line"># Generated by Oracle configuration tools.</span><br><span class="line"></span><br><span class="line">LISTENER =</span><br><span class="line">  (DESCRIPTION_LIST =</span><br><span class="line">    (DESCRIPTION =</span><br><span class="line">      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))</span><br><span class="line">      (ADDRESS = (PROTOCOL = TCP)(HOST = dbserver)(PORT = 1521))</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">SID_LIST_LISTENER = </span><br><span class="line">  (SID_LIST = </span><br><span class="line">    (SID_DESC = </span><br><span class="line">      (GLOBAL_DBNAME = orcl) </span><br><span class="line">      (SID_NAME = orcl) </span><br><span class="line">      (ORACLE_HOME = /u01/app/oracle/product/11.2.0/db_1 ) </span><br><span class="line">    ) </span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">LISTENER2 =</span><br><span class="line">  (DESCRIPTION_LIST =</span><br><span class="line">    (DESCRIPTION =</span><br><span class="line">      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1522))</span><br><span class="line">      (ADDRESS = (PROTOCOL = TCP)(HOST = dbserver)(PORT = 1522))</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line">SID_LIST_LISTENER2 =</span><br><span class="line">  (SID_LIST =</span><br><span class="line">    (SID_DESC =</span><br><span class="line">      (GLOBAL_DBNAME = orcl)</span><br><span class="line">      (SID_NAME = orcl)</span><br><span class="line">      (ORACLE_HOME = /u01/app/oracle/product/11.2.0/db_1 )</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line">ADR_BASE_LISTENER = /u01/app/oracle</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h2><p><img src="/images/2019/0905/06.png" alt="05"><br><img src="/images/2019/0905/07.png" alt="05"></p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>Oracle</tag>
      </tags>
  </entry>
  <entry>
    <title>Oracle自动删除归档日志</title>
    <url>/arlo/272be08f/</url>
    <content><![CDATA[<h1 id="Oracle日志的分类"><a href="#Oracle日志的分类" class="headerlink" title="Oracle日志的分类"></a>Oracle日志的分类</h1><p>Alter log  files：警报日志<br>Trace files：跟踪日志（用户和进程）<br>redo log ：重做日志（记录数据库的更改）</p>
<span id="more"></span>
<h2 id="重做日志"><a href="#重做日志" class="headerlink" title="重做日志"></a>重做日志</h2><p>分为在线重做日志和归档重做日志<br><strong>在线重做日志</strong>：又称联机重做日志，指Oracle以SQL脚本的形式记录数据库的数据更新，换句话说，实时保存已执行的SQL脚本到在线日志文件中<br><strong>归档重做日志</strong>：简称归档日志，是指当条件满足时，Oracle将在线重做日志以文件形式保存到硬盘（持久化）<br>重做日志的简单原理：在数据更新操作commit前，将更改的SQL脚本写入重做日志。主要用于数据库的增量备份和增量恢复。<br>重做日志直接对应于硬盘的重做日志文件（有在线和归档俩种），重做日志文件以组的形式组织，一个重做日志组包括一个或多个日志文件。</p>
<h2 id="归档重做日志"><a href="#归档重做日志" class="headerlink" title="归档重做日志"></a>归档重做日志</h2><p>其实，所谓的归档，就是指，将在线日志进行归档，持久化成固定的文件到硬盘，便于以后的恢复和查询。当然，前提条件是数据库要处于归档模式。<br>在线重做日志大小毕竟是有限的，当都写满了的时候，就面临着俩个选择，第一个就是把以前在线重做日志从头擦除开始继续写，第二种就是把以前的在线重做日志先进行备份，然后对被备份的日志擦除开始写新的在线Redo  File。这种备份的在线重做日志就是归档日志。而数据库如果采用这种生成归档日志的模式的话，就是归档日志模式（ARCHIVELOG模式），反之如果不生成归档日志，就是非归档日志模式（NOARCHIVELOG模式）。<br><strong>有了归档日志有什么好处？</strong><br>比如在这个月1号的时候备份了一次数据，然后过了10天，这个10天生成了很多在线重做日志，突然发现其中有一个数据磁盘出问题了，不能用了，那我该如何是好呢？<br>如果没有采用归档日志，那么实际上磁盘中只会有几个最新的在线重做日志。那么我只能把出问题的数据磁盘上所占据的表空间都删除掉。但是如果是SYSTEM表空间所设计的磁盘出错了，就没办法这么做了，只能用第二种方法。第二种方法就是把1号备份的数据拿出来恢复。那么1号到10号之间的10天的数据都丢了，如果是关键系统，比如证券金融什么的系统，就要让你赔钱赔死掉。<br>但是如果有了归档日志，那么你这10天的重做日志都会存放起来，那么DBA首先会把1号的备份数据恢复，然后再拿这10天的Redo日志来进行一次数据操作重放，那么就可以完全恢复最新的数据库，不会有什么后果了。<br>在软件开发的时候，由于测试服务器的配置有限，特别是磁盘空间有限，所以可能要限制Redo文件的大小，有可能把系统设置为NOARCHIVELOG模式了。但是在实际的生产环境下，基本上一定要使用ARCHIVELOG模式，否则万一出了问题，真是苦都来不及。<br>有人可能会怕归档日志造成性能损失。其实这个完全是杞人忧天的，归档日志只是做一个备份，其实也就是多耗一些磁盘空间而已。在当前的软件系统中，硬盘的存储容量成本已经属于低到可以忽略的地步，而最重要的是数据库的安全。DBA的任务本来就是确保数据的安全，如果连安全都保证不了，那点微乎其微的性能提高又有什么用呢。<br>归档日志（Archive Log）是非活动的重做日志备份。通过使用归档日志，可以保留所有重做历史记录，当数据库处于Archive Log模式并进行日志切换时，后台进程ARCH会将重做日志的内容保存到归档日志中，当数据库出现介质失败时，使用数据文件备份，归档日志和重做日志可以完全恢复数据库。</p>
<h4 id="查看数据库当前是否为归档模式"><a href="#查看数据库当前是否为归档模式" class="headerlink" title="查看数据库当前是否为归档模式"></a>查看数据库当前是否为归档模式</h4><p><code>SELECT  LOG_MODE FROM  V$DATABASE;</code><br>ARCHIVELOG（归档模式）、NOARCHIVELOG（非归档模式）</p>
<h4 id="切换数据库为归档模式"><a href="#切换数据库为归档模式" class="headerlink" title="切换数据库为归档模式"></a><a href="http://islocal.cc/arlo/60a79bb7/">切换数据库为归档模式</a></h4><p><code>shutdown   immediate             #关闭数据库</code><br><code>startup   mount                        #开启数据库到挂载状态</code><br><code>alter database archivelog;     #改变模式为ARCHIVELOG</code><br><code>archive log  start;                   #开启归档日志</code><br><code>alter datebase open;               #打开数据库</code></p>
<h4 id="查找归档日志目录"><a href="#查找归档日志目录" class="headerlink" title="查找归档日志目录"></a>查找归档日志目录</h4><p><code>SELECT  destination  FROM  V$archive_dest;</code></p>
<h3 id="在线重做日志的原理"><a href="#在线重做日志的原理" class="headerlink" title="在线重做日志的原理"></a>在线重做日志的原理</h3><p>对于在线重做日志，Oracle 11g默认对于每个数据库实例，建立3个在线日志组，每组一个日志文件，文件名称为REDO01.LOG,REDO02.LOG,REDO03.LOG。（用户可以通过视图操作添加&#x2F;修改&#x2F;删除日志组合日志文件来自定义在线重做日志）每组内的日志文件的内容完全相同，且保存在不同的位置，用于磁盘日志镜像，以做多次备份提高安全性。默认情况这3组通常只有一组处于活动状态，不断地同步写入已操作的脚本，当日志文件写满时（达到指定的空间配额），如果当前数据库处于归档模式，则将在线日志归档到硬盘，成为归档日志；若当前数据库处于非归档模式，则不进行归档操作，而当前在线日志的内容会被下一次重新写入覆盖而无法保存。因此，通常数据库在运行时，是处于归档模式下的，以保存数据更新的日志。当前归档日志组写满够，Oracle会切换到下一日志组，继续写入，这样循环切换；处于归档模式下，切换至原已写满的日志组，若该日志组归档完毕则则覆盖写入，若没有则只能使用日志缓冲区，等待归档完毕之后才能覆盖写入。当然，处于非归档模式下是直接覆盖写入的。</p>
<h1 id="删除归档日志"><a href="#删除归档日志" class="headerlink" title="删除归档日志"></a>删除归档日志</h1><p>由于归档日志日积月累，占用空间很大，我们只需要保留最近一段时间的日志即可，所以我们要对之前的内容做删除处理。</p>
<h2 id="用oracle用户登陆rman并连接数据库"><a href="#用oracle用户登陆rman并连接数据库" class="headerlink" title="用oracle用户登陆rman并连接数据库"></a>用oracle用户登陆rman并连接数据库</h2><p><code>hostname@oracle$ rman target /</code></p>
<h2 id="列出并确认归档日志路径"><a href="#列出并确认归档日志路径" class="headerlink" title="列出并确认归档日志路径"></a>列出并确认归档日志路径</h2><p><code>RMAN&gt;list archivelog all;</code></p>
<h2 id="删除7天以前的归档日志"><a href="#删除7天以前的归档日志" class="headerlink" title="删除7天以前的归档日志"></a>删除7天以前的归档日志</h2><p><code>RMAN&gt;DELETE ARCHIVELOG ALL COMPLETED BEFORE &#39;SYSDATE-7&#39;;</code>  表明删除当前的系统时间7天前的日志</p>
<h1 id="Windows下自动删除归档日志"><a href="#Windows下自动删除归档日志" class="headerlink" title="Windows下自动删除归档日志"></a>Windows下自动删除归档日志</h1><h2 id="新建E-database-backup-rm-archivelog-txt文件"><a href="#新建E-database-backup-rm-archivelog-txt文件" class="headerlink" title="新建E:\database_backup\rm_archivelog.txt文件"></a>新建E:\database_backup\rm_archivelog.txt文件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">connect target  /</span><br><span class="line">run&#123;</span><br><span class="line">    crosscheck archivelog all;</span><br><span class="line">    DELETE ARCHIVELOG ALL COMPLETED BEFORE &#x27;SYSDATE-7&#x27;;</span><br><span class="line">    delete expired archivelog all;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="新建E-database-backup-rm-archivelog-bat文件"><a href="#新建E-database-backup-rm-archivelog-bat文件" class="headerlink" title="新建E:\database_backup\rm_archivelog.bat文件"></a>新建E:\database_backup\rm_archivelog.bat文件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@echo off</span><br><span class="line">set &quot;filename=rm_archivelog_task_log_%date:~0,4%%date:~5,2%%date:~8,2%.txt&quot;</span><br><span class="line">(</span><br><span class="line">echo.</span><br><span class="line">echo =========================  正在清除过期归档文件，请稍等...... %date% %time%  =========================</span><br><span class="line">echo.</span><br><span class="line">rman cmdfile=E:\database_backup\rm_archivelog.txt</span><br><span class="line">echo.</span><br><span class="line">echo =========================              【结束清理 %date% %time%】                  =========================</span><br><span class="line">echo.</span><br><span class="line">)&gt;&gt;E:\database_backup\%filename% 2&gt;&amp;1&lt;nul</span><br><span class="line">pause</span><br></pre></td></tr></table></figure>
<h2 id="设置计划任务"><a href="#设置计划任务" class="headerlink" title="设置计划任务"></a>设置计划任务</h2><p>每日凌晨执行E:\database_backup\rm_archivelog.bat脚本</p>
<h1 id="Linux下自动删除归档日志"><a href="#Linux下自动删除归档日志" class="headerlink" title="Linux下自动删除归档日志"></a>Linux下自动删除归档日志</h1><h2 id="编写脚本"><a href="#编写脚本" class="headerlink" title="编写脚本"></a>编写脚本</h2><p><code>vim /home/oracle/.rm_archivelog.sh</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">#Author 南山小樵</span><br><span class="line">#Date 2019/12/16</span><br><span class="line"></span><br><span class="line">if [ -f ~/.bash_profile ]; then</span><br><span class="line">    . ~/.bash_profile</span><br><span class="line">fi</span><br><span class="line">#set env</span><br><span class="line"></span><br><span class="line">ORACLE_SID=orcl</span><br><span class="line">ORACLE_HOME=/u01/app/oracle/product/11.2.0/db_1/</span><br><span class="line"></span><br><span class="line">$ORACLE_HOME/bin/rman target sys/passwd@orcl  log=/tmp/rman.log &lt;&lt;EOF       </span><br><span class="line">run&#123;</span><br><span class="line">crosscheck archivelog all;    </span><br><span class="line">delete noprompt expired archivelog all;    </span><br><span class="line">delete noprompt archivelog all completed before &#x27;sysdate - 7&#x27;;    </span><br><span class="line">&#125;  </span><br><span class="line">exit;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h2 id="给脚本赋予可执行权限"><a href="#给脚本赋予可执行权限" class="headerlink" title="给脚本赋予可执行权限"></a>给脚本赋予可执行权限</h2><p><code>chmod +x /home/oracle/.rm_archivelog.sh</code></p>
<h2 id="设置计划任务-1"><a href="#设置计划任务-1" class="headerlink" title="设置计划任务"></a>设置计划任务</h2><p><code>crontab -l</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">00 3 * * * /home/oracle/.rm_archivelog.sh</span><br></pre></td></tr></table></figure>

<p>参考链接：<br><a href="https://www.jianshu.com/p/3bc8f372fe16">https://www.jianshu.com/p/3bc8f372fe16</a><br><a href="https://www.cnblogs.com/kerrycode/p/9046372.html">https://www.cnblogs.com/kerrycode/p/9046372.html</a></p>
<hr>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>Oracle</tag>
      </tags>
  </entry>
  <entry>
    <title>Oracle解锁用户和表</title>
    <url>/arlo/5b695efc/</url>
    <content><![CDATA[<h1 id="查看用户是否被锁"><a href="#查看用户是否被锁" class="headerlink" title="查看用户是否被锁"></a>查看用户是否被锁</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select username,account_status,lock_date from dba_users;</span><br><span class="line">select username,account_status,lock_date from dba_users where username=&#x27;SCOTT&#x27;;</span><br></pre></td></tr></table></figure>
<h1 id="解锁用户"><a href="#解锁用户" class="headerlink" title="解锁用户"></a>解锁用户</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">alter user arlo account unlock;</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h1 id="数据级别解锁表"><a href="#数据级别解锁表" class="headerlink" title="数据级别解锁表"></a>数据级别解锁表</h1><h2 id="锁表查询的代码有以下的形式"><a href="#锁表查询的代码有以下的形式" class="headerlink" title="锁表查询的代码有以下的形式"></a>锁表查询的代码有以下的形式</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select count(*) from v$locked_object;</span><br><span class="line">select * from v$locked_object;</span><br></pre></td></tr></table></figure>
<h2 id="查看哪个表被锁"><a href="#查看哪个表被锁" class="headerlink" title="查看哪个表被锁"></a>查看哪个表被锁</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select b.owner,b.object_name,a.session_id,a.locked_mode from v$locked_object a,dba_objects b where b.object_id = a.object_id;</span><br><span class="line">--</span><br><span class="line">select b.owner TABLEOWNER, b.object_name TABLENAME, c.OSUSER LOCKBY,c.USERNAME LOGINID, c.sid SID, c.SERIAL# SERIAL from v$locked_object a,dba_objects b, v$session c where b.object_id = a.object_id AND a.SESSION_ID =c.sid;</span><br></pre></td></tr></table></figure>

<h2 id="查看是哪个session引起的"><a href="#查看是哪个session引起的" class="headerlink" title="查看是哪个session引起的"></a>查看是哪个session引起的</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select b.username,b.sid,b.serial#,logon_time from v$locked_object a,v$session b where a.session_id = b.sid order by b.logon_time;</span><br></pre></td></tr></table></figure>

<h2 id="查看是哪个sql引起的"><a href="#查看是哪个sql引起的" class="headerlink" title="查看是哪个sql引起的"></a>查看是哪个sql引起的</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select b.username,b.sid,b.serial#,c.* from v$locked_object a,v$session b,v$sql c where a.session_id = b.sid and b.SQL_ID = c.sql_id and c.sql_id = &#x27;&#x27; order by b.logon_time;</span><br></pre></td></tr></table></figure>
<h2 id="查看审计信息（包含登录用户，客户端等）"><a href="#查看审计信息（包含登录用户，客户端等）" class="headerlink" title="查看审计信息（包含登录用户，客户端等）"></a>查看审计信息（包含登录用户，客户端等）</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select sessionid,userid,userhost,comment$text,spare1,to_char(ntimestamp#+1/3,&#x27;yyyy-mm-dd hh24:mi:ss&#x27;) from aud$ where returncode=1017 and userid=&#x27;USERNAME&#x27; order by ntimestamp#;</span><br></pre></td></tr></table></figure>
<h2 id="杀掉对应进程"><a href="#杀掉对应进程" class="headerlink" title="杀掉对应进程"></a>杀掉对应进程</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">alter system kill session&#x27;1025,41&#x27;;		 --其中1025为sid,41为serial#</span><br></pre></td></tr></table></figure>

<h1 id="系统界别解锁表"><a href="#系统界别解锁表" class="headerlink" title="系统界别解锁表"></a>系统界别解锁表</h1><p>今天在使用上述方法解锁用户的时候报错</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">alter system kill session &#x27;2293,85&#x27;</span><br><span class="line">*</span><br><span class="line">ERROR at line 1:</span><br><span class="line">ORA-00031: session marked for kill</span><br></pre></td></tr></table></figure>

<h2 id="查找进程id"><a href="#查找进程id" class="headerlink" title="查找进程id"></a>查找进程id</h2><p>如果利用上面的命令杀死一个进程后，进程状态被置为”killed”，但是锁定的资源很长时间没有被释放，那么可以在os一级再杀死相应的进程（线程），首先执行下面的语句获得进程（线程）号：2293</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SYS@orcl&gt; select spid, osuser, s.program from v$session s,v$process p where s.paddr=p.addr and s.sid=2293;</span><br><span class="line">SPID			 OSUSER 			PROGRAM</span><br><span class="line">-------- ----------------------- ---------------------------------------------</span><br><span class="line">384159			 Administrator			SQL Developer</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="在Linux中结束进程"><a href="#在Linux中结束进程" class="headerlink" title="在Linux中结束进程"></a>在Linux中结束进程</h2><p>在Linux操作系统中执行命令杀掉进程</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kill -9 384159</span><br></pre></td></tr></table></figure>

<h2 id="在Windows中结束进程"><a href="#在Windows中结束进程" class="headerlink" title="在Windows中结束进程"></a>在Windows中结束进程</h2><p>在windows（unix也适用）用orakill杀死线程，orakill是oracle提供的一个可执行命令，语法为：<br><code>orakill sid thread</code>  – sid：表示要杀死的进程属于的实例名 thread：是要杀掉的线程号</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">C:&gt; orakill orcl 384159  </span><br></pre></td></tr></table></figure>

<h2 id="查看Oracle链接客户端的IP等信息"><a href="#查看Oracle链接客户端的IP等信息" class="headerlink" title="查看Oracle链接客户端的IP等信息"></a>查看Oracle链接客户端的IP等信息</h2><h3 id="查看每个oracle帐户的连接总数"><a href="#查看每个oracle帐户的连接总数" class="headerlink" title="查看每个oracle帐户的连接总数"></a>查看每个oracle帐户的连接总数</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">--查看当前连接数</span><br><span class="line">select count(*) from v$process;</span><br><span class="line"></span><br><span class="line">--查看会话session：</span><br><span class="line">select * from v$session where username is not null;</span><br><span class="line">select username,count(username) from v$session where username is not null group by username;</span><br><span class="line"></span><br><span class="line">--查看最大连接数</span><br><span class="line">select value from v$parameter where name =&#x27;processes&#x27;;</span><br><span class="line"></span><br><span class="line">--查看并发连接数</span><br><span class="line">Select count(*) from v$session where status=&#x27;ACTIVE&#x27;;</span><br><span class="line"></span><br><span class="line">--查询：客户端设备标识、客户端程序、oracle用户名、消耗的连接数量</span><br><span class="line">SELECT B.MACHINE 机器名,</span><br><span class="line">       B.PROGRAM 程序名,</span><br><span class="line">       B.USERNAME 用户名,</span><br><span class="line">       COUNT(*) 连接数</span><br><span class="line">  FROM V$PROCESS A, V$SESSION B</span><br><span class="line"> WHERE A.ADDR = B.PADDR</span><br><span class="line">   AND B.USERNAME IS NOT NULL</span><br><span class="line"> GROUP BY B.MACHINE, B.PROGRAM, B.USERNAME</span><br><span class="line"> ORDER BY COUNT(*) DESC;</span><br><span class="line"></span><br><span class="line">--杀死指定的进程</span><br><span class="line">alter system kill session &#x27;sid,serial#&#x27; immediate;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="缺省从-v-session-中不能直接获得客户端-IP，可以在数据库中创建一个追踪客户端IP地址的触发器"><a href="#缺省从-v-session-中不能直接获得客户端-IP，可以在数据库中创建一个追踪客户端IP地址的触发器" class="headerlink" title="缺省从 v$session 中不能直接获得客户端 IP，可以在数据库中创建一个追踪客户端IP地址的触发器"></a>缺省从 v$session 中不能直接获得客户端 IP，可以在数据库中创建一个追踪客户端IP地址的触发器</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">create or replace trigger on_logon_trigger after logon on database  </span><br><span class="line">begin  </span><br><span class="line">    dbms_application_info.set_client_info(sys_context(&#x27;userenv&#x27;, &#x27;ip_address&#x27;));  </span><br><span class="line">end; </span><br></pre></td></tr></table></figure>
<h3 id="比较常用的显示客户端信息的sql"><a href="#比较常用的显示客户端信息的sql" class="headerlink" title="比较常用的显示客户端信息的sql"></a>比较常用的显示客户端信息的sql</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select sid,serial#,username,program,machine,client_info  </span><br><span class="line">from v$session  </span><br><span class="line">where username is not null  </span><br><span class="line">order by username,program,machine;   </span><br></pre></td></tr></table></figure>
<h1 id="connection、process和session的基本知识"><a href="#connection、process和session的基本知识" class="headerlink" title="connection、process和session的基本知识"></a>connection、process和session的基本知识</h1><p>每个sql login称为一个连接（connection)，而每个连接，可以产生一个或多个会话，如果数据库运行在专用服务器方式，一个会话对应一个服务器进程（process)，如果数据库运行在共享服务器方式，一个服务器进程可以为多个会话服务。</p>
<p>Connection并不是直接建立在用户进程和数据库实例之间的。而是在用户进程和Server Process（服务器进程）之间的，因此有一个Connection就一定会有一个用户进程和一个服务器进程，但不一定会存在Session。比如，如果需要将东西从A运到B，Connection可以看成是一座“桥”，而卡车把东西从A运到B后并返回A，这就是Session。所以，只要不断开连接，随时都可以在这个连接上创建出会话。</p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>Oracle</tag>
      </tags>
  </entry>
  <entry>
    <title>Typora 快捷键</title>
    <url>/arlo/e402bc62/</url>
    <content><![CDATA[<ul>
<li>生成目录: <code>[TOC]</code></li>
<li>无序列表：<code>输入-之后输入空格</code></li>
<li>有序列表：<code>输入数字+“.”之后输入空格</code></li>
<li>任务列表：<code>-[空格]空格 文字</code></li>
<li>标题：<code>Ctrl+数字[1-6]</code></li>
<li>字体加粗：<code>Ctrl+B</code></li>
<li>字体倾斜：<code>Ctrl+I</code></li>
<li>字体下划线：<code>Ctrl+U</code></li>
<li>字体删除线：<code>Alt+Shift+5</code></li>
<li>表格：<code>Ctrl+T</code></li>
<li>代码：<code>Ctrl+Shift+</code>`</li>
<li>代码块：<code>Ctrl+Shift+K</code></li>
<li>公式块：<code>Ctrl+Shift+M</code></li>
<li>插入图片：<code>直接拖动到指定位置即可或者Ctrl+Shift+I</code></li>
<li>插入超级链接: <code>Ctrl+K</code></li>
</ul>
]]></content>
      <tags>
        <tag>Hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>fio 存储性能测试</title>
    <url>/arlo/687d8f2c/</url>
    <content><![CDATA[<h1 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h1><table>
<thead>
<tr>
<th align="left"></th>
<th>硬件环境</th>
</tr>
</thead>
<tbody><tr>
<td align="left">CPU</td>
<td>Intel(R) Xeon(R) Gold 5120 CPU @ 2.20GHz * 4  (逻辑cpu112核)</td>
</tr>
<tr>
<td align="left">内存</td>
<td>256GB</td>
</tr>
<tr>
<td align="left">磁盘</td>
<td>数普DS5760，单块10TB 7200RPM NL-SAS磁盘，划分3个RAID6 lun ，通过56GB InfiniBand网络挂载到操作系统</td>
</tr>
<tr>
<td align="left"></td>
<td><strong>软件环境</strong></td>
</tr>
<tr>
<td align="left">操作系统</td>
<td>CentOS Linux release 7.5.1804</td>
</tr>
<tr>
<td align="left">测试软件</td>
<td>fio-3.1</td>
</tr>
</tbody></table>
<blockquote>
<p><font color="#FF0000"><strong>友情提示：性能测试建议直接通过写裸盘的方式进行测试（systemrescuecd+fio），会得到较为真实的数据。但直接测试裸盘会破坏文件系统结构，导致数据丢失，请在测试前确认磁盘中数据已备份；</strong></font> </p>
</blockquote>
<span id="more"></span>

<h1 id="dd-测试"><a href="#dd-测试" class="headerlink" title="dd 测试"></a>dd 测试</h1><p>首先使用dd简单的测试一下写入速度<br><code>dd if=/dev/zero of=/opt/file1 bs=1M count=102400</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># dd if=/dev/zero of=/opt/file1 bs=1M count=102400 </span><br><span class="line">102400+0 records in</span><br><span class="line">102400+0 records out</span><br><span class="line">107374182400 bytes (107 GB) copied, 70.5689 s, 1.5 GB/s</span><br></pre></td></tr></table></figure>
<h1 id="fio安装"><a href="#fio安装" class="headerlink" title="fio安装"></a>fio安装</h1><p>为了看到更详细，更精准的存储性能，我们选用fio作为测试工具；<br>fio 是测试 IOPS 的非常好的工具，用来对硬件进行压力测试和验证，支持 19种不同的 I&#x2F;O 引擎，包括: sync,mmap, libaio, posixaio, SG v3, splice, null, network, syslet, guasi, solarisaio 等等。<br>它支持 Linux 、FreeBSD 、NetBSD、 OpenBSD、 OS X、 OpenSolaris、 AIX、 HP-UX、 Android 以及 Windows操作系统。</p>
<h2 id="硬盘性能指标"><a href="#硬盘性能指标" class="headerlink" title="硬盘性能指标"></a>硬盘性能指标</h2><p>顺序读写（bw吞吐量，常用单位为 MB&#x2F;s）：文件在硬盘上存储位置是连续的。<br>随机读写（iops磁盘的每秒读写次数，常用单位为次）：在硬盘上随机位置读写数据，默认4KB</p>
<h2 id="fio安装-1"><a href="#fio安装-1" class="headerlink" title="fio安装"></a>fio安装</h2><p><code>yum -y install epel-release</code><br><code>yum -y install fio</code></p>
<h2 id="fio命令格式"><a href="#fio命令格式" class="headerlink" title="fio命令格式"></a>fio命令格式</h2><p><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 32 -thread -rw=randrw -ioengine=psync -bs=16k -size=200G -numjobs=112 -runtime=300 -group_reporting -name=test </code></p>
<h2 id="fio参数详解"><a href="#fio参数详解" class="headerlink" title="fio参数详解"></a>fio参数详解</h2><p><strong>filename</strong>: 指定文件 (设备) 的名称。可以通过冒号分割同时指定多个文件，如 filename&#x3D;&#x2F;dev&#x2F;sda:&#x2F;dev&#x2F;sdb。<br><strong>name</strong>: 指定 job 的名字，在命令行中表示新启动一个 job。<br><strong>direct</strong>: bool 类型，如果设置成 true (1)，表示不使用 io buffer。<br><strong>iodepth</strong>: 如果 ioengine 采用异步方式，该参数表示一批提交保持的 io 单元数。该参数可参考文章“Fio 压测工具和 io 队列深度理解和误区”。<br><a href="http://blog.yufeng.info/archives/2104">http://blog.yufeng.info/archives/2104</a><br><strong>ioengine</strong>: I&#x2F;O 引擎，现在 fio 支持 19 种 ioengine。默认值是 sync 同步阻塞 I&#x2F;O，libaio 是 Linux 的 native 异步 I&#x2F;O。关于同步异步，阻塞和非阻塞模型可以参考文章“使用异步 I&#x2F;O 大大提高应用程序的性能”。<br><a href="http://www.ibm.com/developerworks/cn/linux/l-async/">http://www.ibm.com/developerworks/cn/linux/l-async/</a><br><strong>rw</strong>: I&#x2F;O 模式，顺序读(read)、顺序写(write)、随机读(randread)、随机写(randwrite)、随机读写(randrw)。<br><strong>rwmixread</strong>: 随机读写模式中读占比，默认为50%<br><strong>bs</strong>: I&#x2F;O block 大小，默认是 4k。<br><strong>bsrange</strong>：指定数据块的大小范围<br><strong>size</strong>: 指定 job 处理的文件的大小。<br><strong>numjobs</strong>: 指定 job 的线程数。<br><strong>runtime</strong>: 指定在多少秒后停止进程。如果未指定该参数，fio 将执行至指定的文件读写完全完成。<br><strong>time_based</strong>: 如果在 runtime 指定的时间还没到时文件就被读写完成，将继续重复知道 runtime 时间结束。<br><strong>group_reporting</strong>: 当同时指定了 numjobs 了时，输出结果按组显示。</p>
<h1 id="fio测试结果"><a href="#fio测试结果" class="headerlink" title="fio测试结果"></a>fio测试结果</h1><p>我们需要根据自己业务场景来看待测试结果，如果是数据库业务的话，对随机读写要求比较高。如果是视频业务的话，对顺序读要求比较高。<br>为了确认不同参数对测试结果的影响有多大，我这里针对ioengine、iodepth、numjobs和bs参数进行了单独测试，测试结果如下:<br><img src="/images/2019/0427/0.png" alt="0"><br>从测试结果来看，我们可以得出以下结论：</p>
<ul>
<li>在同步模式（psync）和异步模式（libaio）下测试，在顺序写的时候同步模式iops会低于异步模式，其他基本无差异</li>
<li>队列深度（iodepth）对测试影响不大，网上说法是一般设置32个</li>
<li>线程数（numjobs）对测试效果影响较大，建议设置为逻辑cpu核数</li>
<li>文件块大小（bs）可以看到块越小，iops越高</li>
</ul>
<h1 id="fio详细测试过程"><a href="#fio详细测试过程" class="headerlink" title="fio详细测试过程"></a>fio详细测试过程</h1><h2 id="测试iodepth"><a href="#测试iodepth" class="headerlink" title="测试iodepth"></a>测试iodepth</h2><p><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 1 -thread -rw=read -ioengine=psync -bs=16k -size=200G -numjobs=112 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/iodepth-read-1.png" alt="iodepth-read-1"><br><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 16 -thread -rw=read -ioengine=psync -bs=16k -size=200G -numjobs=112 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/iodepth-read-16.png" alt="iodepth-read-16"><br><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 32 -thread -rw=read -ioengine=psync -bs=16k -size=200G -numjobs=112 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/iodepth-read-32.png" alt="iodepth-read-32"><br><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 1 -thread -rw=write -ioengine=psync -bs=16k -size=200G -numjobs=112 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/iodepth-write-1.png" alt="iodepth-write-1"><br><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 16 -thread -rw=write -ioengine=psync -bs=16k -size=200G -numjobs=112 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/iodepth-write-16.png" alt="iodepth-write-16"><br><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 32 -thread -rw=write -ioengine=psync -bs=16k -size=200G -numjobs=112 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/iodepth-write-32.png" alt="iodepth-write-32"><br><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 1 -thread -rw=randread -ioengine=psync -bs=16k -size=200G -numjobs=112 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/iodepth-randread-1.png" alt="iodepth-randread-1"><br><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 16 -thread -rw=randread -ioengine=psync -bs=16k -size=200G -numjobs=112 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/iodepth-randread-16.png" alt="iodepth-randread-16"><br><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 32 -thread -rw=randread -ioengine=psync -bs=16k -size=200G -numjobs=112 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/iodepth-randread-32.png" alt="iodepth-randread-32"><br><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 1 -thread -rw=randwrite -ioengine=psync -bs=16k -size=200G -numjobs=112 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/iodepth-randwrite-1.png" alt="iodepth-randwrite-1"><br><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 16 -thread -rw=randwrite -ioengine=psync -bs=16k -size=200G -numjobs=112 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/iodepth-randwrite-16.png" alt="iodepth-randwrite-16"><br><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 32 -thread -rw=randwrite -ioengine=psync -bs=16k -size=200G -numjobs=112 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/iodepth-randwrite-32.png" alt="iodepth-randwrite-32"><br><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 1 -thread -rw=randrw -ioengine=psync -bs=16k -size=200G -numjobs=112 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/iodepth-randrw-1.png" alt="iodepth-randrw-1"><br><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 16 -thread -rw=randrw -ioengine=psync -bs=16k -size=200G -numjobs=112 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/iodepth-randrw-16.png" alt="iodepth-randrw-16"><br><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 32 -thread -rw=randrw -ioengine=psync -bs=16k -size=200G -numjobs=112 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/iodepth-randrw-32.png" alt="iodepth-randrw-32"></p>
<h2 id="测试ioengine-psync-x2F-libaio"><a href="#测试ioengine-psync-x2F-libaio" class="headerlink" title="测试ioengine(psync&#x2F;libaio)"></a>测试ioengine(psync&#x2F;libaio)</h2><p><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 32 -thread -rw=read -ioengine=libaio -bs=16k -size=200G -numjobs=112 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/libaio-read.png" alt="libaio-randread"><br><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 32 -thread -rw=write -ioengine=libaio -bs=16k -size=200G -numjobs=112 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/libaio-write.png" alt="libaio-write"><br><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 32 -thread -rw=randread -ioengine=libaio -bs=16k -size=200G -numjobs=112 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/libaio-randread.png" alt="libaio-randread"><br><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 32 -thread -rw=randwrite -ioengine=libaio -bs=16k -size=200G -numjobs=112 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/libaio-randwrite.png" alt="libaio-randwrite"><br><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 32 -thread -rw=randrw -ioengine=libaio -bs=16k -size=200G -numjobs=112 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/libaio-randrw.png" alt="libaio-randrw"></p>
<h2 id="测试numjobs-1-x2F-30-x2F-112"><a href="#测试numjobs-1-x2F-30-x2F-112" class="headerlink" title="测试numjobs  1&#x2F;30&#x2F;112"></a>测试numjobs  1&#x2F;30&#x2F;112</h2><p><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 32 -thread -rw=read -ioengine=psync -bs=16k -size=200G -numjobs=1 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/numjobs-read-1.png" alt="numjobs-read-1"><br><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 32 -thread -rw=read -ioengine=psync -bs=16k -size=200G -numjobs=30 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/numjobs-read-30.png" alt="numjobs-read-30"><br><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 32 -thread -rw=write -ioengine=psync -bs=16k -size=200G -numjobs=1 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/numjobs-write-1.png" alt="numjobs-write-1"><br><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 32 -thread -rw=write -ioengine=psync -bs=16k -size=200G -numjobs=30 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/numjobs-write-30.png" alt="numjobs-write-30"><br><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 32 -thread -rw=randread -ioengine=psync -bs=16k -size=200G -numjobs=1 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/numjobs-randread-1.png" alt="numjobs-randread-1"><br><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 32 -thread -rw=randread -ioengine=psync -bs=16k -size=200G -numjobs=30 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/numjobs-randread-30.png" alt="numjobs-randread-30"><br><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 32 -thread -rw=randwrite -ioengine=psync -bs=16k -size=200G -numjobs=1 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/numjobs-randwrite-1.png" alt="numjobs-randwrite-1"><br><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 32 -thread -rw=randwrite -ioengine=psync -bs=16k -size=200G -numjobs=30 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/numjobs-randwrite-30.png" alt="numjobs-randwrite-30"><br><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 32 -thread -rw=randrw -ioengine=psync -bs=16k -size=200G -numjobs=1 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/numjobs-randrw-1.png" alt="numjobs-randrw-1"><br><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 32 -thread -rw=randrw -ioengine=psync -bs=16k -size=200G -numjobs=30 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/numjobs-randrw-30.png" alt="numjobs-randrw-30"></p>
<h2 id="测试bs"><a href="#测试bs" class="headerlink" title="测试bs"></a>测试bs</h2><p><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 32 -thread -rw=read -ioengine=psync -bs=64k -size=200G -numjobs=112 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/bs-read-64.png" alt="bs-read-64"><br><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 32 -thread -rw=read -ioengine=psync -bs=1024k -size=200G -numjobs=112 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/bs-read-1024.png" alt="bs-read-1024"><br><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 32 -thread -rw=write -ioengine=psync -bs=64k -size=200G -numjobs=112 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/bs-write-64.png" alt="bs-write-64"><br><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 32 -thread -rw=write -ioengine=psync -bs=1024k -size=200G -numjobs=112 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/bs-write-1024.png" alt="bs-write-1024"><br><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 32 -thread -rw=randread -ioengine=psync -bs=64k -size=200G -numjobs=112 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/bs-randread-64.png" alt="bs-randread-64"><br><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 32 -thread -rw=randread -ioengine=psync -bs=1024k -size=200G -numjobs=112 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/bs-randread-1024.png" alt="bs-randread-1024"><br><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 32 -thread -rw=randwrite -ioengine=psync -bs=64k -size=200G -numjobs=112 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/bs-randwrite-64.png" alt="bs-randwrite-64"><br><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 32 -thread -rw=randwrite -ioengine=psync -bs=1024k -size=200G -numjobs=112 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/bs-randwrite-1024.png" alt="bs-randwrite-1024"><br><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 32 -thread -rw=randrw -ioengine=psync -bs=64k -size=200G -numjobs=112 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/bs-randrw-64.png" alt="bs-randrw-64"><br><code>fio -filename=/dev/mapper/mpatha -direct=1 -iodepth 32 -thread -rw=randrw -ioengine=psync -bs=1024k -size=200G -numjobs=112 -runtime=300 -group_reporting -name=test</code></p>
<p><img src="/images/2019/0427/bs-randrw-1024.png" alt="bs-randrw-1024"><br>参考链接：</p>
<p><a href="https://wsgzao.github.io/post/fio/">https://wsgzao.github.io/post/fio/</a><br><a href="https://linux.cn/article-9912-1.html">https://linux.cn/article-9912-1.html</a><br>​<a href="http://www.178pt.com/204.html">http://www.178pt.com/204.html</a><br><a href="http://blog.yufeng.info/archives/741">http://blog.yufeng.info/archives/741</a></p>
]]></content>
      <categories>
        <category>测试</category>
      </categories>
      <tags>
        <tag>硬件</tag>
        <tag>性能</tag>
        <tag>fio</tag>
      </tags>
  </entry>
  <entry>
    <title>Zabbix(10)使用zabbix监控IPMI</title>
    <url>/arlo/6abfbe9a/</url>
    <content><![CDATA[<h1 id="IPMI介绍"><a href="#IPMI介绍" class="headerlink" title="IPMI介绍"></a>IPMI介绍</h1><p> IPMI（Intelligent Platform Management Interface）即智能平台管理接口是使硬件管理具备“智能化”的新一代通用接口标准。用户可以利用 IPMI 监视服务器的物理特征，如温度、电压、电扇工作状态、电源供应以及机箱入侵等。Ipmi 最大的优势在于它是独立于 CPU BIOS 和 OS 的，所以用户无论在开机还是关机的状态下，只要接通电源就可以实现对服务器的监控。Ipmi 是一种规范的标准，其中最重要的物理部件就是BMC(Baseboard Management Controller 如图1)，一种嵌入式管理微控制器，它相当于整个平台管理的“大脑”，通过它 ipmi 可以监控各个传感器的数据并记录各种事件的日志。 </p>
<span id="more"></span>

<h1 id="配置服务器IPMI"><a href="#配置服务器IPMI" class="headerlink" title="配置服务器IPMI"></a>配置服务器IPMI</h1><p>使用服务器默认的ipmi地址登录，然后进入到ipmi登录界面，修改规划的ip地址，我这里以浪潮服务器为例</p>
<p><img src="/images/2019/0729/01.png" alt="01"></p>
<h1 id="修改zabbix-server配置文件"><a href="#修改zabbix-server配置文件" class="headerlink" title="修改zabbix server配置文件"></a>修改zabbix server配置文件</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sed -i &#x27;/# StartIPMIPollers=0/aStartIPMIPollers=3&#x27; /etc/zabbix/zabbix_server.conf</span><br></pre></td></tr></table></figure>

<p><code>/etc/init.d/zabbix-server restart</code></p>
<h1 id="安装IPMI相关软件"><a href="#安装IPMI相关软件" class="headerlink" title="安装IPMI相关软件"></a>安装IPMI相关软件</h1><p><code>yum -y install OpenIPMI OpenIPMI-devel ipmitool freeipmi</code></p>
<h1 id="获取IPMI传感器参数"><a href="#获取IPMI传感器参数" class="headerlink" title="获取IPMI传感器参数"></a>获取IPMI传感器参数</h1><p><code>ipmitool -I lanplus -H 10.206.2.52 -U admin -P passwd sensor</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CPU0_Temp        | 55.000     | degrees C  | ok    | na        | na        | na        | 101.000   | 103.000   | na        </span><br><span class="line">CPU1_Temp        | 52.000     | degrees C  | ok    | na        | na        | na        | 101.000   | 103.000   | na        </span><br><span class="line">PCH_Temp         | 50.000     | degrees C  | ok    | na        | na        | na        | 95.000    | 100.000   | na        </span><br><span class="line">DIMMG0_Temp      | 45.000     | degrees C  | ok    | na        | na        | na        | 83.000    | 93.000    | na        </span><br><span class="line">DIMMG1_Temp      | 43.000     | degrees C  | ok    | na        | na        | na        | 83.000    | 93.000    | na        </span><br><span class="line">Inlet_Temp       | 25.000     | degrees C  | ok    | na        | na        | na        | 40.000    | 42.000    | na        </span><br><span class="line">Outlet_Temp      | 48.000     | degrees C  | ok    | na        | na        | na        | na        | na        | na        </span><br><span class="line">SYS0_Temp        | 42.000     | degrees C  | ok    | na        | na        | na        | na        | na        | na        </span><br><span class="line">SYS1_Temp        | 35.000     | degrees C  | ok    | na        | na        | na        | na        | na        | na        </span><br><span class="line">RAID_Temp        | na         | degrees C  | na    | na        | na        | na        | 105.000   | 115.000   | na        </span><br><span class="line">GPU0_Temp        | na         | degrees C  | na    | na        | na        | na        | 82.000    | 92.000    | na        </span><br><span class="line">GPU1_Temp        | na         | degrees C  | na    | na        | na        | na        | 82.000    | 92.000    | na        </span><br><span class="line">MIC0_Temp        | na         | degrees C  | na    | na        | na        | na        | 104.000   | 114.000   | na        </span><br><span class="line">MIC1_Temp        | na         | degrees C  | na    | na        | na        | na        | 104.000   | 114.000   | na        </span><br><span class="line">SYS_VCCIO        | 0.950      | Volts      | ok    | 0.690     | 0.770     | 0.850     | 1.170     | 1.250     | 1.330     </span><br><span class="line">SYS_12V          | 12.126     | Volts      | ok    | 9.024     | 9.776     | 10.528    | 13.536    | 14.288    | 15.040    </span><br><span class="line">SYS_3.3V         | 3.360      | Volts      | ok    | 2.660     | 2.800     | 2.940     | 3.658     | 3.798     | 3.938     </span><br><span class="line">SYS_5V           | 5.220      | Volts      | ok    | 3.888     | 4.176     | 4.464     | 5.544     | 5.832     | 6.120     </span><br><span class="line">PCH_P1V05        | 1.050      | Volts      | ok    | 0.770     | 0.850     | 0.930     | 1.170     | 1.250     | 1.330     </span><br><span class="line">PCH_P1V5         | 1.540      | Volts      | ok    | 1.180     | 1.260     | 1.340     | 1.670     | 1.750     | 1.830     </span><br><span class="line">CPU0_VCORE       | 1.770      | Volts      | ok    | 1.040     | 1.120     | 1.200     | 2.300     | 2.380     | 2.460     </span><br><span class="line">CPU1_VCORE       | 1.780      | Volts      | ok    | 1.040     | 1.120     | 1.200     | 2.300     | 2.380     | 2.460     </span><br><span class="line">CPU0_DDR_VDDQAB  | 1.210      | Volts      | ok    | 0.910     | 0.990     | 1.070     | 1.330     | 1.410     | 1.490     </span><br><span class="line">CPU0_DDR_VDDQCD  | 1.230      | Volts      | ok    | 0.910     | 0.990     | 1.070     | 1.330     | 1.410     | 1.490     </span><br><span class="line">CPU1_DDR_VDDQEF  | 1.230      | Volts      | ok    | 0.910     | 0.990     | 1.070     | 1.330     | 1.410     | 1.490     </span><br><span class="line">CPU1_DDR_VDDQGH  | 1.220      | Volts      | ok    | 0.910     | 0.990     | 1.070     | 1.330     | 1.410     | 1.490     </span><br><span class="line">FAN_0            | 5760.000   | RPM        | ok    | na        | 0.000     | na        | na        | na        | na        </span><br><span class="line">FAN_1            | na         | RPM        | na    | na        | 0.000     | na        | na        | na        | na        </span><br><span class="line">FAN_2            | 5760.000   | RPM        | ok    | na        | 0.000     | na        | na        | na        | na        </span><br><span class="line">FAN_3            | na         | RPM        | na    | na        | 0.000     | na        | na        | na        | na        </span><br><span class="line">FAN_4            | 5952.000   | RPM        | ok    | na        | 0.000     | na        | na        | na        | na        </span><br><span class="line">FAN_5            | na         | RPM        | na    | na        | 0.000     | na        | na        | na        | na        </span><br><span class="line">FAN_6            | 5952.000   | RPM        | ok    | na        | 0.000     | na        | na        | na        | na        </span><br><span class="line">FAN_7            | na         | RPM        | na    | na        | 0.000     | na        | na        | na        | na        </span><br><span class="line">CPU0_Status      | 0x0        | discrete   | 0x8080| na        | na        | na        | na        | na        | na        </span><br><span class="line">CPU1_Status      | 0x0        | discrete   | 0x8080| na        | na        | na        | na        | na        | na        </span><br><span class="line">MEM_CHA0_Status  | 0x0        | discrete   | 0x4080| na        | na        | na        | na        | na        | na        </span><br><span class="line">MEM_CHA1_Status  | 0x0        | discrete   | 0x4080| na        | na        | na        | na        | na        | na        </span><br><span class="line">MEM_CHA2_Status  | 0x0        | discrete   | 0x0080| na        | na        | na        | na        | na        | na        </span><br><span class="line">MEM_CHB0_Status  | 0x0        | discrete   | 0x4080| na        | na        | na        | na        | na        | na        </span><br><span class="line">MEM_CHB1_Status  | 0x0        | discrete   | 0x4080| na        | na        | na        | na        | na        | na        </span><br><span class="line">MEM_CHB2_Status  | 0x0        | discrete   | 0x0080| na        | na        | na        | na        | na        | na        </span><br><span class="line">MEM_CHC0_Status  | 0x0        | discrete   | 0x4080| na        | na        | na        | na        | na        | na        </span><br><span class="line">MEM_CHC1_Status  | 0x0        | discrete   | 0x4080| na        | na        | na        | na        | na        | na        </span><br><span class="line">MEM_CHC2_Status  | 0x0        | discrete   | 0x0080| na        | na        | na        | na        | na        | na        </span><br><span class="line">MEM_CHD0_Status  | 0x0        | discrete   | 0x4080| na        | na        | na        | na        | na        | na        </span><br><span class="line">MEM_CHD1_Status  | 0x0        | discrete   | 0x4080| na        | na        | na        | na        | na        | na        </span><br><span class="line">MEM_CHD2_Status  | 0x0        | discrete   | 0x0080| na        | na        | na        | na        | na        | na        </span><br><span class="line">MEM_CHE0_Status  | 0x0        | discrete   | 0x4080| na        | na        | na        | na        | na        | na        </span><br><span class="line">MEM_CHE1_Status  | 0x0        | discrete   | 0x4080| na        | na        | na        | na        | na        | na        </span><br><span class="line">MEM_CHE2_Status  | 0x0        | discrete   | 0x0080| na        | na        | na        | na        | na        | na        </span><br><span class="line">MEM_CHF0_Status  | 0x0        | discrete   | 0x4080| na        | na        | na        | na        | na        | na        </span><br><span class="line">MEM_CHF1_Status  | 0x0        | discrete   | 0x4080| na        | na        | na        | na        | na        | na        </span><br><span class="line">MEM_CHF2_Status  | 0x0        | discrete   | 0x0080| na        | na        | na        | na        | na        | na        </span><br><span class="line">MEM_CHG0_Status  | 0x0        | discrete   | 0x4080| na        | na        | na        | na        | na        | na        </span><br><span class="line">MEM_CHG1_Status  | 0x0        | discrete   | 0x0080| na        | na        | na        | na        | na        | na        </span><br><span class="line">MEM_CHG2_Status  | 0x0        | discrete   | 0x0080| na        | na        | na        | na        | na        | na        </span><br><span class="line">MEM_CHH0_Status  | 0x0        | discrete   | 0x4080| na        | na        | na        | na        | na        | na        </span><br><span class="line">MEM_CHH1_Status  | 0x0        | discrete   | 0x0080| na        | na        | na        | na        | na        | na        </span><br><span class="line">MEM_CHH2_Status  | 0x0        | discrete   | 0x0080| na        | na        | na        | na        | na        | na        </span><br><span class="line">HDD0_Status      | 0x0        | discrete   | 0x0180| na        | na        | na        | na        | na        | na        </span><br><span class="line">HDD1_Status      | 0x0        | discrete   | 0x0180| na        | na        | na        | na        | na        | na        </span><br><span class="line">HDD2_Status      | 0x0        | discrete   | 0x0180| na        | na        | na        | na        | na        | na        </span><br><span class="line">HDD3_Status      | 0x0        | discrete   | 0x0180| na        | na        | na        | na        | na        | na        </span><br><span class="line">HDD4_Status      | 0x0        | discrete   | 0x0180| na        | na        | na        | na        | na        | na        </span><br><span class="line">HDD5_Status      | 0x0        | discrete   | 0x0180| na        | na        | na        | na        | na        | na        </span><br><span class="line">HDD6_Status      | 0x0        | discrete   | 0x0180| na        | na        | na        | na        | na        | na        </span><br><span class="line">HDD7_Status      | 0x0        | discrete   | 0x0180| na        | na        | na        | na        | na        | na        </span><br><span class="line">HDD8_Status      | 0x0        | discrete   | 0x0180| na        | na        | na        | na        | na        | na        </span><br><span class="line">HDD9_Status      | 0x0        | discrete   | 0x0180| na        | na        | na        | na        | na        | na        </span><br><span class="line">HDD10_Status     | 0x0        | discrete   | 0x0180| na        | na        | na        | na        | na        | na        </span><br><span class="line">HDD11_Status     | 0x0        | discrete   | 0x0180| na        | na        | na        | na        | na        | na        </span><br><span class="line">HDD12_Status     | 0x0        | discrete   | 0x0080| na        | na        | na        | na        | na        | na        </span><br><span class="line">HDD13_Status     | 0x0        | discrete   | 0x0080| na        | na        | na        | na        | na        | na        </span><br><span class="line">HDD14_Status     | 0x0        | discrete   | 0x0080| na        | na        | na        | na        | na        | na        </span><br><span class="line">HDD15_Status     | 0x0        | discrete   | 0x0080| na        | na        | na        | na        | na        | na        </span><br><span class="line">HDD16_Status     | 0x0        | discrete   | 0x0080| na        | na        | na        | na        | na        | na        </span><br><span class="line">HDD17_Status     | 0x0        | discrete   | 0x0080| na        | na        | na        | na        | na        | na        </span><br><span class="line">HDD18_Status     | 0x0        | discrete   | 0x0080| na        | na        | na        | na        | na        | na        </span><br><span class="line">HDD19_Status     | 0x0        | discrete   | 0x0080| na        | na        | na        | na        | na        | na        </span><br><span class="line">HDD20_Status     | 0x0        | discrete   | 0x0080| na        | na        | na        | na        | na        | na        </span><br><span class="line">HDD21_Status     | 0x0        | discrete   | 0x0080| na        | na        | na        | na        | na        | na        </span><br><span class="line">HDD22_Status     | 0x0        | discrete   | 0x0080| na        | na        | na        | na        | na        | na        </span><br><span class="line">HDD23_Status     | 0x0        | discrete   | 0x0080| na        | na        | na        | na        | na        | na        </span><br><span class="line">HDD24_Status     | 0x0        | discrete   | 0x0080| na        | na        | na        | na        | na        | na        </span><br><span class="line">HDD0_Rear_Status | 0x0        | discrete   | 0x0180| na        | na        | na        | na        | na        | na        </span><br><span class="line">HDD1_Rear_Status | 0x0        | discrete   | 0x0180| na        | na        | na        | na        | na        | na        </span><br><span class="line">HDD2_Rear_Status | 0x0        | discrete   | 0x0080| na        | na        | na        | na        | na        | na        </span><br><span class="line">HDD3_Rear_Status | 0x0        | discrete   | 0x0080| na        | na        | na        | na        | na        | na        </span><br><span class="line">Total_Power      | 335.000    | Watts      | ok    | na        | na        | na        | na        | na        | na        </span><br><span class="line">PSU0_Supply      | 0x0        | discrete   | 0x0180| na        | na        | na        | na        | na        | na        </span><br><span class="line">PSU1_Supply      | 0x0        | discrete   | 0x0180| na        | na        | na        | na        | na        | na        </span><br><span class="line">PSU0_Unit        | 0x0        | discrete   | 0x0080| na        | na        | na        | na        | na        | na        </span><br><span class="line">PSU1_Unit        | 0x0        | discrete   | 0x0080| na        | na        | na        | na        | na        | na        </span><br><span class="line">EventLog         | 0x0        | discrete   | 0x0080| na        | na        | na        | na        | na        | na        </span><br><span class="line">ME_FW_Status     | 0x0        | discrete   | 0x0080| na        | na        | na        | na        | na        | na        </span><br><span class="line">BMC_Boot_Up      | 0x0        | discrete   | 0x0280| na        | na        | na        | na        | na        | na        </span><br><span class="line">IPMI_Watchdog    | 0x0        | discrete   | 0x0080| na        | na        | na        | na        | na        | na        </span><br><span class="line">RISER0_Temp      | 48.000     | degrees C  | ok    | na        | na        | na        | na        | na        | na        </span><br><span class="line">RISER1_Temp      | na         | degrees C  | na    | na        | na        | na        | na        | na        | na        </span><br><span class="line">HDD_REAR0_Temp   | 36.000     | degrees C  | ok    | na        | na        | na        | 60.000    | 70.000    | na        </span><br><span class="line">HDD_REAR1_Temp   | na         | degrees C  | na    | na        | na        | na        | 60.000    | 70.000    | na        </span><br><span class="line">NVME_0_Status    | 0x0        | discrete   | 0x0080| na        | na        | na        | na        | na        | na        </span><br><span class="line">NVME_1_Status    | 0x0        | discrete   | 0x0080| na        | na        | na        | na        | na        | na        </span><br><span class="line">NVME_2_Status    | 0x0        | discrete   | 0x0080| na        | na        | na        | na        | na        | na        </span><br><span class="line">NVME_3_Status    | 0x0        | discrete   | 0x0080| na        | na        | na        | na        | na        | na        </span><br><span class="line">NVME_4_Status    | 0x0        | discrete   | 0x0080| na        | na        | na        | na        | na        | na        </span><br><span class="line">NVME_5_Status    | 0x0        | discrete   | 0x0080| na        | na        | na        | na        | na        | na        </span><br><span class="line">NVME_6_Status    | 0x0        | discrete   | 0x0080| na        | na        | na        | na        | na        | na        </span><br><span class="line">NVME_7_Status    | 0x0        | discrete   | 0x0080| na        | na        | na        | na        | na        | na        </span><br><span class="line">All_Unit_Status  | 0x0        | discrete   | 0x0080| na        | na        | na        | na        | na        | na  </span><br></pre></td></tr></table></figure>

<h1 id="Zabbix-web界面添加主机"><a href="#Zabbix-web界面添加主机" class="headerlink" title="Zabbix web界面添加主机"></a>Zabbix web界面添加主机</h1><p><img src="/images/2019/0729/02.png" alt="01"></p>
<p><img src="/images/2019/0729/03.png" alt="01"></p>
<p><img src="/images/2019/0729/04.png" alt="01"></p>
<h1 id="修改模板，添加监控项"><a href="#修改模板，添加监控项" class="headerlink" title="修改模板，添加监控项"></a>修改模板，添加监控项</h1><p>由于默认自带的模板很多监控项获取不到数据，这里我手动监测一下传感器，自己把传感器能获取的数据添加到模板里去</p>
<p><code>ipmitool -I lanplus -H 10.206.2.52 -U admin -P admin sensor list</code><br><img src="/images/2019/0729/05.png" alt="01"></p>
<p><code>ipmitool -I lanplus -H 10.206.2.52 -U admin -P admin sensor get &quot;CPU0_Temp&quot;</code></p>
<p><img src="/images/2019/0729/06.png" alt="01"></p>
<p><img src="/images/2019/0729/07.png" alt="01"></p>
<p><img src="/images/2019/0729/08.png" alt="01"></p>
<h1 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h1><h2 id="网络接口相关命令"><a href="#网络接口相关命令" class="headerlink" title="网络接口相关命令"></a>网络接口相关命令</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ipmitool lan print 1 #显示channel1的网络配置信息</span><br><span class="line">ipmitool lan set 1 ipsrc static	#使用静态IP地址</span><br><span class="line">ipmitool lan set 1 ipaddr 172.16.10.205   #设置IP地址   </span><br><span class="line">ipmitool lan set 1 netmask 255.255.0.0  #设置子网掩码</span><br><span class="line">ipmitool lan set 1 access on </span><br><span class="line">ipmitool lan set 1 defgw ipaddr 172.16.10.1   #配置网关</span><br><span class="line"></span><br><span class="line">ipmitool lan set 2 defgw macaddr 　#设置channel2的网关mac address</span><br><span class="line">ipmitool lan set 2 ipsrc dhcp 	   #设置channel2的ip 源在DHCP</span><br></pre></td></tr></table></figure>

<h2 id="用户管理相关命令"><a href="#用户管理相关命令" class="headerlink" title="用户管理相关命令"></a>用户管理相关命令</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ipmitool user list chan-id  #显示某通道上的所有用户</span><br><span class="line">ipmitool user list 1  #列出当前用户列表</span><br><span class="line"></span><br><span class="line">ipmitool set password [] #修改某用户的密码</span><br><span class="line">ipmitool user set password 2 “111.com”  #其中 2 为要设置密原的用户 ID 号，设置密码为 111.com</span><br><span class="line"></span><br><span class="line">ipmitool disable 　　#禁止掉某用户</span><br><span class="line">ipmitool enable 　　#启用某用户</span><br><span class="line">ipmitool priv []　 #修改某用户在某通道上的权限</span><br><span class="line">ipmitool test &lt;16|20&gt;[&lt;password]&gt;　#测试用户</span><br></pre></td></tr></table></figure>

<h2 id="远程电源控制类"><a href="#远程电源控制类" class="headerlink" title="远程电源控制类"></a>远程电源控制类</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ipmitool -I lanplus –H 10.206.2.52 –U username –P Passwordchassis power off</span><br><span class="line">ipmitool -I lanplus –H 10.206.2.52 –U username –P Passwordchassis power on</span><br><span class="line">ipmitool -I lanplus –H 10.206.2.52 –U username –P Passwordchassis power reset</span><br><span class="line">ipmitool -I lanplus –H 10.206.2.52 –U username –P Passwordchassis power cycle</span><br><span class="line"></span><br><span class="line">注：power cycle 和power reset的区别在于前者从掉电到上电有１秒钟的间隔，而后者是很快上电</span><br><span class="line"></span><br><span class="line">ipmitool  -I lanplus -H 10.206.2.52 -U  admin -P admin mc reset warm  #重启BMC</span><br></pre></td></tr></table></figure>

<h2 id="启动设置类"><a href="#启动设置类" class="headerlink" title="启动设置类"></a>启动设置类</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ipmitool chassis bootdev bios 重启后停在BIOS 菜单</span><br><span class="line">ipmitool chassis bootdev pxe　重启后从PXE启动</span><br></pre></td></tr></table></figure>

<h2 id="系统相关的命令"><a href="#系统相关的命令" class="headerlink" title="系统相关的命令"></a>系统相关的命令</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ipmitool mc info 显示BMC版本信息</span><br><span class="line">ipmitool bmc reset cold BMC 热启动</span><br><span class="line">ipmitool bmc reset warmBMC冷启动</span><br></pre></td></tr></table></figure>

<h2 id="读取系统状态类"><a href="#读取系统状态类" class="headerlink" title="读取系统状态类"></a>读取系统状态类</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ipmitool sensor list 　显示系统所有传感器列表</span><br><span class="line">ipmitool fru list　　　显示系统所有现场可替代器件的列表</span><br><span class="line">ipmitool sdr list　　　显示系统所有SDRRepository设备列表　</span><br><span class="line">ipmitool pef list 　　显示系统平台时间过滤的列表</span><br></pre></td></tr></table></figure>

<h2 id="系统日志类"><a href="#系统日志类" class="headerlink" title="系统日志类"></a>系统日志类</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ipmitool sel elist　　　显示所有系统事件日志</span><br><span class="line">ipmitool sel clear　　　删除所有系统时间日志</span><br><span class="line">ipmitool sel delete ID 删除第ID条SEL</span><br><span class="line">ipmitool sel time get 　显示当前BMC的时间</span><br><span class="line">ipmitool sel time set XXX 设置当前BMC的时间</span><br></pre></td></tr></table></figure>

<h2 id="通道相关命令"><a href="#通道相关命令" class="headerlink" title="通道相关命令"></a>通道相关命令</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ipmitool channel info　显示系统默认channel</span><br><span class="line">ipmitool channel authcap channel-number privilege 　修改通道的优先级别</span><br><span class="line">ipmitool channel getaccess channel-number user-id　读取用户在通道上的权限</span><br><span class="line">ipmitool channel setacccess channel-number user-id callin=on ipmi=on link=onprivilege=5 // 设置用户在通道上的权限</span><br></pre></td></tr></table></figure>

<h2 id="看门狗相关命令"><a href="#看门狗相关命令" class="headerlink" title="看门狗相关命令"></a>看门狗相关命令</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ipmitool mc watchdog get　读取当前看门狗的设置</span><br><span class="line">ipmitool watchdog off 　　关掉看门狗</span><br><span class="line">ipmitool watchdog reset 　　在最近设置的计数器的基础上重启看门狗</span><br></pre></td></tr></table></figure>

<p>参考资料: </p>
<p><a href="https://www.cnblogs.com/kaishirenshi/p/9703127.html">https://www.cnblogs.com/kaishirenshi/p/9703127.html</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/477139556">https://zhuanlan.zhihu.com/p/477139556</a></p>
]]></content>
      <categories>
        <category>监控</category>
      </categories>
      <tags>
        <tag>zabbix</tag>
        <tag>监控</tag>
      </tags>
  </entry>
  <entry>
    <title>oracle开启归档日志模式</title>
    <url>/arlo/60a79bb7/</url>
    <content><![CDATA[<p>在默认情况下，oracle数据库是在非归日志档模式中创建的，在非归档日志模式中，进行日志切换时会直接重写redo log，如果此时数据文件因为介质失败被损坏，则数据库恢复时会丢失掉被重写的数据；在归档日志模式下，数据库可以应用最近一次数据库备份开始生成的所有归档日志文件，保证数据无丢失；大部分的生产数据库以archivelog模式运行。<br>oracle数据库在开启归档日志模式后，会自动启动新的进程：归档器ARCn。默认情况下是开启4个进程，在实际应用中最多可以启动30个归档器进程。</p>
<span id="more"></span>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ ps -ef |grep arc</span><br><span class="line">oracle   22248     1  0 11:35 ?        00:00:00 ora_arc0_airforecast</span><br><span class="line">oracle   22250     1  0 11:35 ?        00:00:00 ora_arc1_airforecast</span><br><span class="line">oracle   22252     1  0 11:35 ?        00:00:00 ora_arc2_airforecast</span><br><span class="line">oracle   22254     1  0 11:35 ?        00:00:00 ora_arc3_airforecast</span><br></pre></td></tr></table></figure>
<h1 id="新建归档模式目录"><a href="#新建归档模式目录" class="headerlink" title="新建归档模式目录"></a>新建归档模式目录</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir /u01/app/oracle/oradata/airforecast/archivelog</span><br></pre></td></tr></table></figure>
<h1 id="设置实例参数"><a href="#设置实例参数" class="headerlink" title="设置实例参数"></a>设置实例参数</h1><p>从9i开始后，oracle数据库可以指定10个归档目的地，但实例log_archive_dest_n中的n最大为30，通常情况下需要指定2个或者多个归档目的地来多路复用归档日志文件；在理想情况下，这些归档日志文件应当位于不同的磁盘存储上；实际应用中，一般还是指定一个，非常重要的数据库一般有data guard来保证高可用性。</p>
<table>
<thead>
<tr>
<th>变量</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>%d</td>
<td>唯一的数据看标志符，如果多个数据库归档到同一目录，这是必须要的</td>
</tr>
<tr>
<td>%t</td>
<td>线程号，适用于RAC数据看，无实际意义</td>
</tr>
<tr>
<td>%r</td>
<td>场景（incarnation）号，在不完全恢复时需要用到</td>
</tr>
<tr>
<td>%s</td>
<td>日志切换序列号，保证同一个库中的归档日志不会彼此重写</td>
</tr>
</tbody></table>
<p>修改操作步骤如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SYS@airforecast&gt; conn / as sysdba</span><br><span class="line">SYS@airforecast&gt; alter system set log_archive_dest_1=&#x27;location=/u01/app/oracle/oradata/airforecast/archivelog&#x27; scope = spfile;</span><br><span class="line">SYS@airforecast&gt; alter system set log_archive_format=&#x27;arch_%d_%t_%r_%s.log&#x27; scope = spfile;</span><br></pre></td></tr></table></figure>
<h1 id="重启数据库并开启归档日志模式"><a href="#重启数据库并开启归档日志模式" class="headerlink" title="重启数据库并开启归档日志模式"></a>重启数据库并开启归档日志模式</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SYS@airforecast&gt; shutdown immediate</span><br><span class="line">Database closed.</span><br><span class="line">Database dismounted.</span><br><span class="line">ORACLE instance shut down.</span><br><span class="line">SYS@airforecast&gt; startup mount;</span><br><span class="line">ORACLE instance started.</span><br><span class="line"></span><br><span class="line">Total System Global Area 4977278976 bytes</span><br><span class="line">Fixed Size		    2261768 bytes</span><br><span class="line">Variable Size		 1006636280 bytes</span><br><span class="line">Database Buffers	 3959422976 bytes</span><br><span class="line">Redo Buffers		    8957952 bytes</span><br><span class="line">Database mounted.</span><br><span class="line">SYS@airforecast&gt; alter database archivelog;</span><br><span class="line"></span><br><span class="line">Database altered.</span><br><span class="line"></span><br><span class="line">SYS@airforecast&gt; alter database open;</span><br><span class="line"></span><br><span class="line">Database altered.</span><br></pre></td></tr></table></figure>
<h1 id="确认数据库是否为归档模式"><a href="#确认数据库是否为归档模式" class="headerlink" title="确认数据库是否为归档模式"></a>确认数据库是否为归档模式</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SYS@airforecast&gt; select log_mode from v$database;</span><br><span class="line"></span><br><span class="line">LOG_MODE</span><br><span class="line">------------</span><br><span class="line">ARCHIVELOG</span><br><span class="line"></span><br><span class="line">SYS@airforecast&gt; select archiver from v$instance;</span><br><span class="line"></span><br><span class="line">ARCHIVE</span><br><span class="line">-------</span><br><span class="line">STARTED</span><br></pre></td></tr></table></figure>
<h1 id="切换日志检查归档日志是否正常"><a href="#切换日志检查归档日志是否正常" class="headerlink" title="切换日志检查归档日志是否正常"></a>切换日志检查归档日志是否正常</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SYS@airforecast&gt; alter system switch logfile;</span><br><span class="line"></span><br><span class="line">System altered.</span><br><span class="line"></span><br><span class="line">SYS@airforecast&gt; select name from v$archived_log;</span><br><span class="line"></span><br><span class="line">NAME</span><br><span class="line">------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">/u01/app/oracle/oradata/airforecast/archivelog/arch_a9652e7f_1_1000805313_5.log</span><br><span class="line">/u01/app/oracle/oradata/airforecast/archivelog/arch_a9652e7f_1_1000805313_6.log</span><br></pre></td></tr></table></figure>

<p>参考链接：<a href="https://www.jianshu.com/p/f8c0e9309ce2">https://www.jianshu.com/p/f8c0e9309ce2</a></p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>Oracle</tag>
        <tag>数据库</tag>
      </tags>
  </entry>
  <entry>
    <title>fping批量检测主机存活</title>
    <url>/arlo/52a5c096/</url>
    <content><![CDATA[<p><strong>fping</strong>是一个小型命令行工具，用于向网络主机发送<strong>ICMP</strong> （ <strong>Internet控制消息协议</strong> ）回应请求，类似于ping，但在ping多个主机时性能要高得多。 fping完全不同于ping，因为您可以在命令行上定义任意数量的主机，或者指定包含要ping的IP地址或主机列表的文件。</p>
<span id="more"></span>
<h1 id="windows环境"><a href="#windows环境" class="headerlink" title="windows环境"></a>windows环境</h1><p>我在<a href="https://fping.org/">fping官网</a>没找到下载地址，可以从这里下载：<a href="http://blog.perceptus.ca/wp-content/uploads/2017/11/fping300.zip">http://blog.perceptus.ca/wp-content/uploads/2017/11/fping300.zip</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-g  ping一个区间范围</span><br><span class="line">-H  ping文本里的ip地址</span><br><span class="line">-L  将结果输出到文本中</span><br><span class="line">-D  打印日期（年月日）</span><br><span class="line">-T  打印时间戳（时分秒）</span><br></pre></td></tr></table></figure>



<h2 id="ping一个区间范围"><a href="#ping一个区间范围" class="headerlink" title="ping一个区间范围"></a>ping一个区间范围</h2><p><code>ping -g 172.16.10.1/172.16.10.254</code></p>
<h2 id="ping-文件"><a href="#ping-文件" class="headerlink" title="ping 文件"></a>ping 文件</h2><p><code>fping -D -T -H d:\172.txt -L d:\1.txt </code></p>
<h1 id="Linux（centos）环境"><a href="#Linux（centos）环境" class="headerlink" title="Linux（centos）环境"></a>Linux（centos）环境</h1><p><code>yum -y install epel-release</code><br><code>yum -y install fping</code></p>
<h2 id="fping用法"><a href="#fping用法" class="headerlink" title="fping用法"></a>fping用法</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-a 仅显示存活主机</span><br><span class="line">-u 仅显示不存活主机</span><br><span class="line">-g 指定网段</span><br><span class="line">-f 指定文件</span><br><span class="line">-r 重复检测网段次数（一般和-g结合使用，-g -r 1）</span><br><span class="line">-C 检测主机次数</span><br><span class="line">-s 显示统计信息</span><br></pre></td></tr></table></figure>
<h2 id="ping多主机"><a href="#ping多主机" class="headerlink" title="ping多主机"></a>ping多主机</h2><p><code> fping www.baidu.com 163.com qq.com t.cn google.com facebook.com</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">www.baidu.com is alive</span><br><span class="line">163.com is alive</span><br><span class="line">qq.com is alive</span><br><span class="line">t.cn is alive</span><br><span class="line">google.com is unreachable</span><br><span class="line">facebook.com is unreachable</span><br></pre></td></tr></table></figure>
<h2 id="ping区间"><a href="#ping区间" class="headerlink" title="ping区间"></a>ping区间</h2><p><code>fping -C 1 -g 192.168.6.1 192.168.6.5</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">192.168.6.1 : [0], 84 bytes, 0.58 ms (0.58 avg, 0% loss)</span><br><span class="line">192.168.6.1 : 0.58</span><br><span class="line">192.168.6.2 : -</span><br><span class="line">192.168.6.3 : -</span><br><span class="line">192.168.6.4 : -</span><br><span class="line">192.168.6.5 : -</span><br></pre></td></tr></table></figure>

<h2 id="ping网段"><a href="#ping网段" class="headerlink" title="ping网段"></a>ping网段</h2><p><code>fping -g -r 1 192.168.6.0/24</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">192.168.6.1 is alive</span><br><span class="line">……</span><br><span class="line">192.168.6.121 is alive</span><br><span class="line">ICMP Host Unreachable from 192.168.6.23 for ICMP Echo sent to 192.168.6.2</span><br><span class="line">……</span><br><span class="line">ICMP Host Unreachable from 192.168.6.23 for ICMP Echo sent to 192.168.6.148</span><br><span class="line">192.168.6.2 is unreachable</span><br><span class="line">……</span><br><span class="line">192.168.6.252 is unreachable</span><br></pre></td></tr></table></figure>
<h2 id="ping文件"><a href="#ping文件" class="headerlink" title="ping文件"></a>ping文件</h2><p><code>cat 1.txt</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">192.168.1.1</span><br><span class="line">192.168.10.33</span><br><span class="line">223.5.5.5</span><br><span class="line">114.114.114.114</span><br><span class="line">221.11.1.67</span><br></pre></td></tr></table></figure>
<p><code>fping &lt; 1.txt</code><br><code>fping -f 1.txt</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ICMP Time Exceeded from 192.168.0.253 for ICMP Echo sent to 192.168.1.1</span><br><span class="line">192.168.10.33 is alive</span><br><span class="line">114.114.114.114 is alive</span><br><span class="line">223.5.5.5 is alive</span><br><span class="line">221.11.1.67 is alive</span><br><span class="line">ICMP Time Exceeded from 192.168.0.253 for ICMP Echo sent to 192.168.1.1</span><br><span class="line">ICMP Time Exceeded from 192.168.0.253 for ICMP Echo sent to 192.168.1.1</span><br><span class="line">ICMP Time Exceeded from 192.168.0.253 for ICMP Echo sent to 192.168.1.1</span><br><span class="line">192.168.1.1 is unreachable</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Troubleshooting</category>
      </categories>
      <tags>
        <tag>监控</tag>
      </tags>
  </entry>
  <entry>
    <title>jenkins插件“Publish Over SSH”拷贝文件到远程服务器并执行脚本</title>
    <url>/arlo/e68b6718/</url>
    <content><![CDATA[<p>之前的java项目打出来的是war包，通过插件”Deploy to container”部署到tomcat下，近期项目组使用到spring boot项目，打出来的是jar包，需要远程发布，网上找了下，基本上都是通过”Publish Over SSH”插件，将jar包拷贝到远程服务器上，然后通过执行shell脚本启动jar项目，这里记录一下过程。</p>
<span id="more"></span>
<h1 id="安装-Publish-Over-SSH-插件"><a href="#安装-Publish-Over-SSH-插件" class="headerlink" title="安装 Publish Over SSH 插件"></a>安装 Publish Over SSH 插件</h1><p>Manage Jenkins –&gt;Manage Plugins–&gt;可选插件–&gt;Publish Over SSH–&gt;直接安装</p>
<h1 id="添加Linux主机"><a href="#添加Linux主机" class="headerlink" title="添加Linux主机"></a>添加Linux主机</h1><p>Manage Jenkins –&gt;Configure System –&gt;Publish Over SSH<br>这这里我们需要设置远程主机相关信息，如主机名，用户，密码，远程主机目录；高级选项选项中，我们可以选择key和密码两种方式访问远程linux主机，还可以设置跳转机<br><img src="/images/2019/0714/01.png" alt="02"></p>
<h1 id="构建项目"><a href="#构建项目" class="headerlink" title="构建项目"></a>构建项目</h1><p>构建一个maven项目，其他信息和之前的一样，配置好svn地址，相关用户获取代码。<br>Build阶段参数设置为：<code>-e clean package -Dmaven.test.skip=true</code><br><img src="/images/2019/0714/02.png" alt="02"><br><img src="/images/2019/0714/03.png" alt="02"><br><strong>Source Files</strong>：需要发布的jar包位置，需要写相对（当前项目目录）路径；如：当前项目名称是monitor-cloud，jar包的位置是&#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;monitor-cloud&#x2F;monitor-gateway&#x2F;target&#x2F;monitor-gateway.jar，在Source Files填写 monitor-gateway&#x2F;target&#x2F;monitor-gateway.jar即可<br><strong>Remove prefix</strong>：表示需要移除的目录，比如这里填写monitor-gateway&#x2F;target，则表示发布时，只把monitor-gateway.jar.jar发布到远程linux，而不包含monitor-gateway&#x2F;target目录结构<br><strong>Remote directory</strong>：表示需要把编译好的war包发布到远程linux的哪个目录下 (我刚才在全局属性里设置了，这里就留空了)<br><strong>Exec command</strong>：需要执行的shell命令，shell命令在远程linux服务器上.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">echo &quot;deploy monitor-gateway.jar&quot;</span><br><span class="line"> </span><br><span class="line">pid=`ps -ef|grep monitor-gateway|grep -v grep|awk &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line"> </span><br><span class="line">if [ -n &quot;$pid&quot; ]</span><br><span class="line">    then</span><br><span class="line">    echo &#x27;The pid: server&#x27; $pid &#x27; will be killed....&#x27;</span><br><span class="line">    kill -9 $pid</span><br><span class="line">    echo &#x27;The pid: server&#x27; $pid &#x27; will be start&#x27;</span><br><span class="line">    nohup /usr/local/jdk1.8.0_202/bin/java -jar /usr/local/ths/monitor-gateway.jar &gt;  /dev/null &amp; </span><br><span class="line">else</span><br><span class="line">    echo &#x27;The pid: server&#x27; $pid &#x27; not exist , will be start&#x27;</span><br><span class="line">    nohup /usr/local/jdk1.8.0_202/bin/java -jar /usr/local/ths/monitor-gateway.jar &gt;  /dev/null &amp;</span><br><span class="line">fi</span><br><span class="line">    echo &#x27;The pid: server&#x27; $pid &#x27; started&#x27;</span><br></pre></td></tr></table></figure>


<p>参考：<a href="https://blog.csdn.net/l848168/article/details/85261514">https://blog.csdn.net/l848168/article/details/85261514</a></p>
]]></content>
      <categories>
        <category>自动化运维</category>
      </categories>
      <tags>
        <tag>Jenkins</tag>
      </tags>
  </entry>
  <entry>
    <title>工具|利用GoAccess分析Nginx访问日志</title>
    <url>/arlo/85bf3410/</url>
    <content><![CDATA[<p>项目上线之后，访问量逐渐增多，最近发现一些异常，从服务器监控zabbix没有发现比较有用的信息，链路监控pinpoint上发现访问量比之前增加了很多，所以想从入口方面分析一下来源，看看是不是被人抓取数据了。</p>
<span id="more"></span>
<h1 id="Nginx日志格式"><a href="#Nginx日志格式" class="headerlink" title="Nginx日志格式"></a>Nginx日志格式</h1><p>我这里使用的是阿里开源的tengine，和nginx是一样的，默认的日志格式</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">                      &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">                      &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line"></span><br><span class="line">    access_log  logs/access.log  main;</span><br><span class="line">    error_log   logs/error.log warn;</span><br><span class="line">    access_log  &quot;pipe:rollback logs/access_log interval=1d baknum=7 maxsize=2G&quot;  main;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">113.200.77.134 - - [19/Dec/2019:10:45:39 +0800] &quot;GET /air/home/code/regions HTTP/1.1&quot; 200 1391 &quot;http://localhost:8080/app/tabs/home&quot; &quot;Mozilla/5.0 (Linux; Android 9; COL-AL10 Build/HUAWEICOL-AL10; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/72.0.3626.121 Mobile Safari/537.36&quot; &quot;-&quot;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
<th>实例</th>
</tr>
</thead>
<tbody><tr>
<td>$remote_addr</td>
<td>客户端地址</td>
<td>113.200.77.134</td>
</tr>
<tr>
<td>$remote_user</td>
<td>客户端用户名称</td>
<td>- -</td>
</tr>
<tr>
<td>$time_local</td>
<td>访问时间和时区</td>
<td>19&#x2F;Dec&#x2F;2019:10:45:39 +0800]</td>
</tr>
<tr>
<td>$request</td>
<td>请求的URI和HTTP协议</td>
<td>GET &#x2F;air&#x2F;home&#x2F;code&#x2F;regions HTTP&#x2F;1.1</td>
</tr>
<tr>
<td>$http_host</td>
<td>请求地址，即浏览器中你输入的地址（IP或域名）</td>
<td></td>
</tr>
<tr>
<td>$status</td>
<td>HTTP请求状态</td>
<td>200</td>
</tr>
<tr>
<td>$upstream_status</td>
<td>upstream状态</td>
<td></td>
</tr>
<tr>
<td>$body_bytes_sent</td>
<td>发送给客户端文件内容大小</td>
<td>1391</td>
</tr>
<tr>
<td>$http_referer</td>
<td>url跳转来源</td>
<td><a href="http://localhost:8080/app/tabs/home">http://localhost:8080/app/tabs/home</a></td>
</tr>
<tr>
<td>$http_user_agent</td>
<td>用户终端浏览器等信息</td>
<td>Mozilla&#x2F;5.0 (Linux; Android 9; COL-AL10 Build&#x2F;HUAWEICOL-AL10; wv) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Version&#x2F;4.0 Chrome&#x2F;72.0.3626.121 Mobile Safari&#x2F;537.36</td>
</tr>
<tr>
<td>$ssl_protocol</td>
<td>SSL协议版本</td>
<td></td>
</tr>
<tr>
<td>$ssl_cipher</td>
<td>交换数据中的算法</td>
<td></td>
</tr>
<tr>
<td>$http_x_forwarded_for</td>
<td>HTTP 扩展头部</td>
<td></td>
</tr>
<tr>
<td>$upstream_addr</td>
<td>后台upstream的地址，即真正提供服务的主机地址</td>
<td></td>
</tr>
<tr>
<td>$request_time</td>
<td>Nginx处理整个请求所用总时间</td>
<td></td>
</tr>
<tr>
<td>$upstream_connect_time</td>
<td>Nginx与upstream server建立连接所用时间</td>
<td></td>
</tr>
<tr>
<td>$upstream_header_time</td>
<td>从建立连接成功到接收第一个字节之间的时间</td>
<td></td>
</tr>
<tr>
<td>$upstream_response_time</td>
<td>从建立连接成功到接收第一个字节之间的时间</td>
<td></td>
</tr>
</tbody></table>
<h1 id="GoAccess"><a href="#GoAccess" class="headerlink" title="GoAccess"></a>GoAccess</h1><p><strong>GoAccess</strong>是一个开源的<strong>实时</strong> <strong>Web日志分析器</strong>和交互式查看器，可在* nix系统的<strong>终端</strong>中或通过<strong>浏览器运行</strong>。</p>
<p>它为需要实时可视服务器报告的系统管理员提供了<strong>快速</strong>而有价值的HTTP统计信息。</p>
<p>官网地址：<a href="https://goaccess.io/">https://goaccess.io/</a></p>
<p>github地址：<a href="https://github.com/allinurl/goaccess">https://github.com/allinurl/goaccess</a></p>
<p>GoAccess日志规范：<a href="https://goaccess.io/man#custom-log">https://goaccess.io/man#custom-log</a></p>
<h2 id="安装GoAccess"><a href="#安装GoAccess" class="headerlink" title="安装GoAccess"></a>安装GoAccess</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum install geoip-devel  ncurses-devel glib2 glib2-devel  ncurses-devel zlib zlib-devel </span><br><span class="line">wget https://tar.goaccess.io/goaccess-1.3.tar.gz</span><br><span class="line">tar -xzvf goaccess-1.3.tar.gz</span><br><span class="line">cd goaccess-1.3/</span><br><span class="line">./configure --prefix=/usr/local/goaccess --enable-utf8 --enable-geoip=legacy</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /usr/local/goaccess/etc/goaccess/goaccess.conf</span><br></pre></td></tr></table></figure>

<p>配置日志格式，和nginx里的日志格式匹配起来，日志规范参考上述链接</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">time-format %H:%M:%S</span><br><span class="line">date-format %d/%b/%Y</span><br><span class="line">log-format %h %^[%d:%t %^] &quot;%r&quot; %s %b &quot;%R&quot; &quot;%u&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">%t  匹配time-format格式的时间字段</span><br><span class="line">%d  匹配date-format格式的日期字段</span><br><span class="line">%h  host(客户端ip地址，包括ipv4和ipv6)</span><br><span class="line">%r  来自客户端的请求行</span><br><span class="line">%m  请求的方法</span><br><span class="line">%U  URL路径</span><br><span class="line">%H  请求协议</span><br><span class="line">%s  服务器响应的状态码</span><br><span class="line">%b  服务器返回的内容大小</span><br><span class="line">%R  HTTP请求头的referer字段</span><br><span class="line">%u  用户代理的HTTP请求报头</span><br><span class="line">%D  请求所花费的时间，单位微秒</span><br><span class="line">%T  请求所花费的时间，单位秒</span><br><span class="line">%^  忽略这一字段</span><br></pre></td></tr></table></figure>



<h2 id="终端查看日志"><a href="#终端查看日志" class="headerlink" title="终端查看日志"></a>终端查看日志</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/usr/local/goaccess/bin/goaccess -a -d -f /usr/local/tengine/logs/access.log -p /usr/local/goaccess/etc/goaccess/goaccess.conf</span><br></pre></td></tr></table></figure>

<p><img src="/images/2019/1219/01.png" alt="goaccess"></p>
<ul>
<li>F1或h：帮助</li>
<li>F5 ：刷新主界面</li>
<li>q：退出程序&#x2F;当前窗口&#x2F;折叠当前模块</li>
<li>o或Enter：展开选中的模块或窗口</li>
<li>0-9以及Shift + 0：将选中的模块或窗口激活</li>
<li>k和j：模块内部移动</li>
<li>c：修改配色</li>
<li>^f和^b：模块中上下滚屏</li>
<li>tab shift+tab：前后切换模块</li>
<li>s：模块内部排序选择</li>
<li>&#x2F;：在所有模块中搜索(支持正则)</li>
<li>n：找到下个匹配</li>
<li>g和G：跳到第一项&#x2F;最后一项</li>
</ul>
<h2 id="生成html格式"><a href="#生成html格式" class="headerlink" title="生成html格式"></a>生成html格式</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">usr/local/goaccess/bin/goaccess -a -d -f /usr/local/tengine/logs/access_log.1 -p /usr/local/goaccess/etc/goaccess/goaccess.conf  -o ~/sx.html</span><br></pre></td></tr></table></figure>

<p><img src="/images/2019/1219/02.png" alt="goaccess"></p>
]]></content>
  </entry>
  <entry>
    <title>开源APM工具pinpoint搭建使用</title>
    <url>/arlo/c47141fa/</url>
    <content><![CDATA[<p>APM，全称：Application Performance Management （应用程序性能管理）。 在应用服务各节点相互调用的时候，从中记录并传递一个应用级别的标记，这个标记可以用来关联各个服务节点之间的关系。比如两个应用服务节点之间使用 HTTP 作为传输协议的话，那么这些标记就会被加入到 HTTP 头中。这样就可以更加精细化的分析应用性能，也就是计量应用程序在执行不同区域的代码已经完成事务过程找那个所消耗的具体时长，耗费资源情况。<br><strong>商用软件：OneAPM，听云，透视宝，Oracle的EMCC等</strong><br><strong>开源软件：<a href="https://www.infoq.cn/article/apm-Pinpoint-practice">Pinpoint，SkyWalking，Zipkin，CAT</a>等</strong></p>
<p>Pinpoint是开源在github（项目地址：<a href="https://github.com/naver/pinpoint">https://github.com/naver/pinpoint</a> ）上的一款APM监控工具，它是用Java编写的，用于大规模分布式系统监控。它对性能的影响最小（只增加约3％资源利用率），安装agent是无侵入式的，只需要在被测试的Tomcat中加上3行内容，添加探针，就可以监控整套程序了。</p>
<span id="more"></span>
<h1 id="软件环境"><a href="#软件环境" class="headerlink" title="软件环境"></a>软件环境</h1><p>官方给的<a href="http://naver.github.io/pinpoint/quickstart.html">快速安装教程</a>，是使用git clone代码，然后build编译安装，这样时间比较慢，而且容易出错，不方便排查，所以我们这里直接从<a href="https://github.com/naver/pinpoint/releases/">https://github.com/naver/pinpoint/releases/</a> 下载war包，进行部署！</p>
<p><em>ps：如果hbase和pinpoint-collector、pinpoint-web部署在同一台机器，不用单独部署zookeeper；如果是下载war包部署，也不用安装maven</em><br><em>ps：不要使用hbase2.0，否则首页server map不显示</em></p>
<table>
<thead>
<tr>
<th>组件</th>
<th>版本</th>
<th>功能</th>
<th>下载路径</th>
</tr>
</thead>
<tbody><tr>
<td>zookeeper</td>
<td>3.4.12</td>
<td>应用程序协调</td>
<td><a href="http://mirror.bit.edu.cn/apache/zookeeper/stable/zookeeper-3.4.12.tar.gz">http://mirror.bit.edu.cn/apache/zookeeper/stable/zookeeper-3.4.12.tar.gz</a></td>
</tr>
<tr>
<td>hbase</td>
<td>1.2.9</td>
<td>存储收集的数据</td>
<td><a href="http://mirror.bit.edu.cn/apache/hbase/hbase-1.2.9/hbase-1.2.9-bin.tar.gz">http://mirror.bit.edu.cn/apache/hbase/hbase-1.2.9/hbase-1.2.9-bin.tar.gz</a></td>
</tr>
<tr>
<td>pinpoint-collector</td>
<td>1.8.1</td>
<td>收集各种性能数据</td>
<td><a href="https://github.com/naver/pinpoint/releases/download/1.8.1/pinpoint-collector-1.8.1.war">https://github.com/naver/pinpoint/releases/download/1.8.1/pinpoint-collector-1.8.1.war</a></td>
</tr>
<tr>
<td>pinpoint-web</td>
<td>1.8.1</td>
<td>数据WEB网页展示</td>
<td><a href="https://github.com/naver/pinpoint/releases/download/1.8.1/pinpoint-web-1.8.1.war">https://github.com/naver/pinpoint/releases/download/1.8.1/pinpoint-web-1.8.1.war</a></td>
</tr>
<tr>
<td>pinpoint-agent</td>
<td>1.8.1</td>
<td>应用关联探针</td>
<td><a href="https://github.com/naver/pinpoint/releases/download/1.8.1/pinpoint-agent-1.8.1.tar.gz">https://github.com/naver/pinpoint/releases/download/1.8.1/pinpoint-agent-1.8.1.tar.gz</a></td>
</tr>
<tr>
<td>Oracle JDK</td>
<td>1.8</td>
<td>JAVA运行环境</td>
<td><a href="https://www.oracle.com/technetwork/java/archive-139210.html">https://www.oracle.com/technetwork/java/archive-139210.html</a></td>
</tr>
<tr>
<td>apache-tomcat</td>
<td>8.5.37</td>
<td>web容器</td>
<td><a href="http://mirror.bit.edu.cn/apache/tomcat/tomcat-8/v8.5.37/bin/apache-tomcat-8.5.37.tar.gz">http://mirror.bit.edu.cn/apache/tomcat/tomcat-8/v8.5.37/bin/apache-tomcat-8.5.37.tar.gz</a></td>
</tr>
<tr>
<td>apache-maven</td>
<td>3.3.9</td>
<td>编译环境</td>
<td><a href="http://apache.mirrors.lucidnetworks.net/maven/maven-3/">http://apache.mirrors.lucidnetworks.net/maven/maven-3/</a></td>
</tr>
</tbody></table>
<h1 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h1><p><img src="/images/2019/0108/01.png" alt="pinpoint"></p>
<h1 id="支持的模块"><a href="#支持的模块" class="headerlink" title="支持的模块"></a>支持的模块</h1><ul>
<li>JDK 6+</li>
<li>Tomcat 6&#x2F;7&#x2F;8&#x2F;9, Jetty 8&#x2F;9, JBoss EAP 6&#x2F;7, Resin 4, Websphere 6&#x2F;7&#x2F;8, Vertx 3.3&#x2F;3.4&#x2F;3.5, Weblogic 10&#x2F;11g&#x2F;12c, Undertow</li>
<li>Spring, Spring Boot (Embedded Tomcat, Jetty), Spring asynchronous communication</li>
<li>Apache HTTP Client 3.x&#x2F;4.x, JDK HttpConnector, GoogleHttpClient, OkHttpClient, NingAsyncHttpClient, Akka-http, Apache CXF</li>
<li>Thrift Client, Thrift Service, DUBBO PROVIDER, DUBBO CONSUMER, GRPC</li>
<li>ActiveMQ, RabbitMQ, Kafka</li>
<li>MySQL, Oracle, MSSQL(jtds), CUBRID, POSTGRESQL, MARIA</li>
<li>Arcus, Memcached, Redis(Jedis, Lettuce), CASSANDRA, MongoDB, Hbase</li>
<li>iBATIS, MyBatis</li>
<li>DBCP, DBCP2, HIKARICP, DRUID</li>
<li>gson, Jackson, Json Lib, Fastjson</li>
<li>log4j, Logback</li>
</ul>
<h1 id="组件兼容性"><a href="#组件兼容性" class="headerlink" title="组件兼容性"></a>组件兼容性</h1><p><img src="/images/2019/0108/02.png" alt="pinpoint"></p>
<h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><h2 id="查看主机名"><a href="#查看主机名" class="headerlink" title="查看主机名"></a>查看主机名</h2><p><code>cat /etc/hostname </code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pinpoint_server</span><br></pre></td></tr></table></figure>
<h2 id="添加主机名解析"><a href="#添加主机名解析" class="headerlink" title="添加主机名解析"></a>添加主机名解析</h2><p><code>cat /etc/hosts</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">127.0.0.1 pinpoint_server</span><br></pre></td></tr></table></figure>
<h2 id="准备所需的软件包"><a href="#准备所需的软件包" class="headerlink" title="准备所需的软件包"></a>准备所需的软件包</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@pinpoint_server ~]# cd /usr/local/src/pinpoint</span><br><span class="line">[root@pinpoint_server pinpoint]# ll</span><br><span class="line">total 499488</span><br><span class="line">-rw-r--r-- 1 root root   9584807 Jan  9 08:52 apache-tomcat-8.5.32.tar.gz</span><br><span class="line">-rw-r--r-- 1 root root 105514702 Jan  9 08:52 hbase-1.2.9-bin.tar.gz</span><br><span class="line">-rw-r--r-- 1 root root     16984 Jan  9 08:52 hbase-create.hbase</span><br><span class="line">-rw-r--r-- 1 root root 183212596 Jan  9 09:03 jdk-8u112-linux-x64.tar.gz</span><br><span class="line">-rw-r--r-- 1 root root  16507792 Jan  9 08:52 pinpoint-agent-1.8.1.tar.gz</span><br><span class="line">-rw-r--r-- 1 root root  62644974 Jan  9 08:52 pinpoint-collector-1.8.1.war</span><br><span class="line">-rw-r--r-- 1 root root  97301169 Jan  9 08:52 pinpoint-web-1.8.1.war</span><br><span class="line">-rw-r--r-- 1 root root  36667596 Jan  9 08:52 zookeeper-3.4.12.tar.gz</span><br></pre></td></tr></table></figure>
<h1 id="安装JDK"><a href="#安装JDK" class="headerlink" title="安装JDK"></a>安装JDK</h1><p><code>tar xf jdk-8u112-linux-x64.tar.gz -C /usr/local/</code><br><code>vim /etc/profile</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">export HISTSIZE=10000</span><br><span class="line">export HISTTIMEFORMAT=&quot;%F %T &quot;</span><br><span class="line">export JAVA_HOME=/usr/local/jdk1.8.0_112/</span><br><span class="line">export JAVA_8_HOME=/usr/local/jdk1.8.0_112/</span><br><span class="line">export CLASSPATH=.:$JAVA_HOME/lib/:$JAVA_HOME/jre/lib/</span><br><span class="line">export PATH=$JAVA_HOME/bin:$PATH</span><br></pre></td></tr></table></figure>
<p><code>source /etc/profile</code></p>
<h1 id="安装hbase"><a href="#安装hbase" class="headerlink" title="安装hbase"></a>安装hbase</h1><h2 id="解压软件包"><a href="#解压软件包" class="headerlink" title="解压软件包"></a>解压软件包</h2><p><code>tar xf hbase-1.2.9-bin.tar.gz -C /usr/local/</code><br><code>cd /usr/local/hbase-1.2.9/conf/</code></p>
<h2 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h2><p><code>vim hbase-env.sh</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#在27行左右配置JAVA_HOME</span><br><span class="line">export JAVA_HOME=/usr/local/jdk1.8.0_112/</span><br></pre></td></tr></table></figure>
<p><code>vim hbase-site.xml</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;configuration&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;hbase.rootdir&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;file:///data/pinpoint/hbase&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;hbase.zookeeper.property.dataDir&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;/data/pinpoint/zookeeper&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;hbase.master.port&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;60000&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;hbase.regionserver.port&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;60020&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>
<h2 id="新建数据目录"><a href="#新建数据目录" class="headerlink" title="新建数据目录"></a>新建数据目录</h2><p><code>mkdir -p /data/pinpoint/hbase</code><br><code>mkdir -p /data/pinpoint/zookeeper</code></p>
<h2 id="启动hbase服务"><a href="#启动hbase服务" class="headerlink" title="启动hbase服务"></a>启动hbase服务</h2><p><code>cd /usr/local/hbase-1.2.9/bin</code><br> <code>./start-hbase.sh</code><br>查看启动日志<br><code>tailf /usr/local/hbase-1.2.9/bin/../logs/hbase-root-master-pinpoint_server.log</code><br>也可以通过web控制台 <a href="http://192.168.6.140:16010/">http://192.168.6.140:16010/</a> 来访问hbase<br><img src="/images/2019/0108/03.png" alt="pinpoint"></p>
<h2 id="导入hbase数据"><a href="#导入hbase数据" class="headerlink" title="导入hbase数据"></a>导入hbase数据</h2><p>下载这个hbase数据 <a href="https://github.com/naver/pinpoint/tree/master/hbase/scripts/hbase-create.hbase">https://github.com/naver/pinpoint/tree/master/hbase/scripts/hbase-create.hbase</a><br><em>$HBASE_HOME&#x2F;bin&#x2F;hbase shell $PATH_TO_SCRIPTS&#x2F;hbase-create.hbase</em><br><code>/usr/local/hbase-1.2.9/bin/hbase shell /usr/local/src/pinpoint/hbase-create.hbase</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">2019-01-09 09:20:19,016 WARN  [main] util.NativeCodeLoader: Unable to load native-hadoop library for your platform... using builtin-java classes where applicable</span><br><span class="line">0 row(s) in 1.5720 seconds</span><br><span class="line"></span><br><span class="line">0 row(s) in 2.2760 seconds</span><br><span class="line"></span><br><span class="line">0 row(s) in 4.3110 seconds</span><br><span class="line"></span><br><span class="line">0 row(s) in 1.2430 seconds</span><br><span class="line"></span><br><span class="line">0 row(s) in 1.2840 seconds</span><br><span class="line"></span><br><span class="line">0 row(s) in 1.2550 seconds</span><br><span class="line"></span><br><span class="line">0 row(s) in 1.2400 seconds</span><br><span class="line"></span><br><span class="line">0 row(s) in 1.2540 seconds</span><br><span class="line"></span><br><span class="line">0 row(s) in 2.2630 seconds</span><br><span class="line"></span><br><span class="line">0 row(s) in 4.2830 seconds</span><br><span class="line"></span><br><span class="line">0 row(s) in 18.4010 seconds</span><br><span class="line"></span><br><span class="line">0 row(s) in 2.2570 seconds</span><br><span class="line"></span><br><span class="line">0 row(s) in 2.2760 seconds</span><br><span class="line"></span><br><span class="line">0 row(s) in 2.2510 seconds</span><br><span class="line"></span><br><span class="line">0 row(s) in 2.2520 seconds</span><br><span class="line"></span><br><span class="line">0 row(s) in 1.2370 seconds</span><br><span class="line"></span><br><span class="line">TABLE                                                                                                                                  </span><br><span class="line">AgentEvent                                                                                                                             </span><br><span class="line">AgentInfo                                                                                                                              </span><br><span class="line">AgentLifeCycle                                                                                                                         </span><br><span class="line">AgentStat                                                                                                                              </span><br><span class="line">AgentStatV2                                                                                                                            </span><br><span class="line">ApiMetaData                                                                                                                            </span><br><span class="line">ApplicationIndex                                                                                                                       </span><br><span class="line">ApplicationMapStatisticsCallee_Ver2                                                                                                    </span><br><span class="line">ApplicationMapStatisticsCaller_Ver2                                                                                                    </span><br><span class="line">ApplicationMapStatisticsSelf_Ver2                                                                                                      </span><br><span class="line">ApplicationTraceIndex                                                                                                                  </span><br><span class="line">HostApplicationMap_Ver2                                                                                                                </span><br><span class="line">SqlMetaData_Ver2                                                                                                                       </span><br><span class="line">StringMetaData                                                                                                                         </span><br><span class="line">TraceV2                                                                                                                                </span><br><span class="line">Traces                                                                                                                                 </span><br><span class="line">16 row(s) in 0.0400 seconds</span><br></pre></td></tr></table></figure>
<p><code>./hbase shell</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">2019-01-09 10:55:54,792 WARN  [main] util.NativeCodeLoader: Unable to load native-hadoop library for your platform... using builtin-java classes where applicable</span><br><span class="line">HBase Shell; enter &#x27;help&lt;RETURN&gt;&#x27; for list of supported commands.</span><br><span class="line">Type &quot;exit&lt;RETURN&gt;&quot; to leave the HBase Shell</span><br><span class="line">Version 1.2.9, rfd0d55b1e5ef54eb9bf60cce1f0a8e4c1da073ef, Sat Nov 17 21:43:34 CST 2018</span><br><span class="line"></span><br><span class="line">hbase(main):001:0&gt; status &#x27;detailed&#x27;</span><br><span class="line">version 1.2.9</span><br><span class="line">0 regionsInTransition</span><br><span class="line">active master:  localhost:44182 1546996425069</span><br><span class="line">0 backup masters</span><br><span class="line">master coprocessors: []</span><br><span class="line">1 live servers</span><br><span class="line">    localhost:33288 1546996426037</span><br><span class="line">        requestsPerSecond=0.0, numberOfOnlineRegions=498, usedHeapMB=456, maxHeapMB=931, numberOfStores=626, numberOfStorefiles=3, storefileUncompressedSizeMB=0, storefileSizeMB=0, memstoreSizeMB=0, storefileIndexSizeMB=0, readRequestsCount=16623, writeRequestsCount=8095, rootIndexSizeKB=6, totalStaticIndexSizeKB=4, totalStaticBloomSizeKB=0, totalCompactingKVs=0, currentCompactedKVs=0, compactionProgressPct=NaN, coprocessors=[MultiRowMutationEndpoint]</span><br><span class="line">……</span><br></pre></td></tr></table></figure>
<p>当然也可以通过web控制台查看数据初始化是否成功！</p>
<h1 id="安装pinpoint-collector"><a href="#安装pinpoint-collector" class="headerlink" title="安装pinpoint-collector"></a>安装pinpoint-collector</h1><p>部署过程很简单，起一个web容器（tomcat），把下载的war包扔进去就可以了</p>
<h2 id="解压tomcat"><a href="#解压tomcat" class="headerlink" title="解压tomcat"></a>解压tomcat</h2><p><code>tar xf apache-tomcat-8.5.32.tar.gz -C /usr/local/</code><br><code>cd /usr/local/</code><br><code>mv apache-tomcat-8.5.32/ tomcat_pinpoint-collector</code><br><code>cd tomcat_pinpoint-collector/</code></p>
<h2 id="删除默认的应用"><a href="#删除默认的应用" class="headerlink" title="删除默认的应用"></a>删除默认的应用</h2><p><code>rm -fr webapps/*</code></p>
<h2 id="部署-pinpoint-collector-1-8-1-war"><a href="#部署-pinpoint-collector-1-8-1-war" class="headerlink" title="部署 pinpoint-collector-1.8.1.war"></a>部署 pinpoint-collector-1.8.1.war</h2><p>拷贝pinpoint-collector-1.8.1.war到webapps目录下，重命名为ROOT.war,改名只是为了访问的时候不用加上下文对象名称，就是懒~~~<br><code>cp /usr/local/src/pinpoint/pinpoint-collector-1.8.1.war webapps/ROOT.war</code></p>
<h2 id="启动tomcat服务"><a href="#启动tomcat服务" class="headerlink" title="启动tomcat服务"></a>启动tomcat服务</h2><p><code>bin/startup.sh</code></p>
<h1 id="安装pinpoint-web"><a href="#安装pinpoint-web" class="headerlink" title="安装pinpoint-web"></a>安装pinpoint-web</h1><h2 id="解压tomcat-1"><a href="#解压tomcat-1" class="headerlink" title="解压tomcat"></a>解压tomcat</h2><p><code>tar xf apache-tomcat-8.5.32.tar.gz -C /usr/local/</code><br><code>cd /usr/local/</code><br><code>mv apache-tomcat-8.5.32 tomcat_pinpoint-web</code></p>
<h2 id="修改tomcat端口"><a href="#修改tomcat端口" class="headerlink" title="修改tomcat端口"></a>修改tomcat端口</h2><p>由于已经有一个tomcat把默认的端口都占用了，我们这里修改一下tomcat使用到的端口<br><code>cd tomcat_pinpoint-web/conf</code><br><code>sed -i &#39;s/port=&quot;8005&quot;/port=&quot;18005&quot;/g&#39; server.xml</code><br><code>sed -i &#39;s/port=&quot;8080&quot;/port=&quot;18080&quot;/g&#39; server.xml</code><br><code>sed -i &#39;s/port=&quot;8443&quot;/port=&quot;18443&quot;/g&#39; server.xml</code><br><code>sed -i &#39;s/port=&quot;8009&quot;/port=&quot;18009&quot;/g&#39; server.xml</code><br><code>sed -i &#39;s/redirectPort=&quot;8443&quot;/redirectPort=&quot;18443&quot;/g&#39; server.xml</code><br><code>sed -i &quot;s/localhost/192.168.6.140/g&quot; server.xml</code></p>
<h2 id="删除默认的应用-1"><a href="#删除默认的应用-1" class="headerlink" title="删除默认的应用"></a>删除默认的应用</h2><p><code>rm -fr ../webapps/*</code><br><code>cp /usr/local/src/pinpoint/pinpoint-web-1.8.1.war /usr/local/tomcat_pinpoint-web/webapps/ROOT.war</code><br><code>bin/startup.sh</code><br>访问web控制台<a href="http://192.168.6.140:18080/">http://192.168.6.140:18080</a><br><img src="/images/2019/0108/04.png" alt="pinpoint"></p>
<h1 id="安装pinpoint-agent"><a href="#安装pinpoint-agent" class="headerlink" title="安装pinpoint-agent"></a>安装pinpoint-agent</h1><p>部署探针也很简单，就是在tomcat的启动配置文件中添加以下三行内容即可</p>
<h2 id="添加linux探针"><a href="#添加linux探针" class="headerlink" title="添加linux探针"></a>添加linux探针</h2><p><code>mkdir -p /usr/local/pinpoint-agent</code><br><code>tar xf pinpoint-agent-1.8.1.tar.gz -C  /usr/local/pinpoint-agent</code><br><code>/usr/local/pinpoint-agent</code><br><code>vim pinpoint.config</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">profiler.collector.ip=192.168.6.140</span><br></pre></td></tr></table></figure>
<h3 id="检测一下agent和服务端的通信情况"><a href="#检测一下agent和服务端的通信情况" class="headerlink" title="检测一下agent和服务端的通信情况"></a>检测一下agent和服务端的通信情况</h3><p>如果有问题，大部分情况下是pinpoint和hbase之间的连通性问题<br><code>sh script/networktest.sh</code><br><img src="/images/2019/0108/05.png" alt="pinpoint"></p>
<p><code>tar xf apache-tomcat-8.5.32.tar.gz -C /usr/local/</code><br><code>mv apache-tomcat-8.5.32/ tomcat_test</code><br><code>cd tomcat_test/conf/</code><br>和之前一样，因为本机的tomcat端口被占用，我们修改一下相关端口<br><code>sed -i &#39;s/port=&quot;8005&quot;/port=&quot;28005&quot;/g&#39; server.xml</code><br><code>sed -i &#39;s/port=&quot;8080&quot;/port=&quot;28080&quot;/g&#39; server.xml</code><br><code>sed -i &#39;s/port=&quot;8443&quot;/port=&quot;28443&quot;/g&#39; server.xml</code><br><code>sed -i &#39;s/port=&quot;8009&quot;/port=&quot;28009&quot;/g&#39; server.xml</code><br><code>sed -i &#39;s/redirectPort=&quot;8443&quot;/redirectPort=&quot;28443&quot;/g&#39; server.xml</code><br><code>sed -i &quot;s/localhost/192.168.6.140/g&quot; server.xml</code></p>
<p><code>vim catalina.sh</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># for pinpoint agent</span><br><span class="line">AGENT_PATH=/usr/local/pinpoint-agent</span><br><span class="line">AGENT_VERSION=1.8.1</span><br><span class="line">AGENT_ID=&quot;agent001&quot;</span><br><span class="line">APPLICATION_NAME=&quot;test_140_28080&quot;</span><br><span class="line">CATALINA_OPTS=&quot;$CATALINA_OPTS -javaagent:$AGENT_PATH/pinpoint-bootstrap-$AGENT_VERSION.jar&quot;</span><br><span class="line">CATALINA_OPTS=&quot;$CATALINA_OPTS -Dpinpoint.agentId=$AGENT_ID&quot;</span><br><span class="line">CATALINA_OPTS=&quot;$CATALINA_OPTS -Dpinpoint.applicationName=$APPLICATION_NAME&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/images/2019/0108/06.png" alt="pinpoint"><br><code>bin/startup.sh</code><br><img src="/images/2019/0108/07.png" alt="pinpoint"></p>
<h2 id="添加windows探针"><a href="#添加windows探针" class="headerlink" title="添加windows探针"></a>添加windows探针</h2><p>由于我这边目前大部分项目都是在windows跑的，我们添加两个windows探针看一下真实的效果<br>解压pinpoint-agent-1.8.1.tar.gz到D:&#x2F;pinpoint-agent&#x2F;<br>修改配置文件pinpoint.config</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">profiler.collector.ip=192.168.6.140</span><br></pre></td></tr></table></figure>
<p>修改D:\apache-tomcat-8082\bin\catalina.bat文件，添加到最前边即可</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">set CATALINA_OPTS=%CATALINA_OPTS% -javaagent:D:/pinpoint-agent/pinpoint-bootstrap-1.8.1.jar</span><br><span class="line">set CATALINA_OPTS=%CATALINA_OPTS% -Dpinpoint.agentId=agent002</span><br><span class="line">set CATALINA_OPTS=%CATALINA_OPTS% -Dpinpoint.applicationName=172_8082</span><br></pre></td></tr></table></figure>
<p><img src="/images/2019/0108/08.png" alt="pinpoint"><br>修改D:\apache-tomcat-ou\bin\catalina.bat文件，添加到最前边即可</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">set CATALINA_OPTS=%CATALINA_OPTS% -javaagent:D:/pinpoint-agent/pinpoint-bootstrap-1.8.1.jar</span><br><span class="line">set CATALINA_OPTS=%CATALINA_OPTS% -Dpinpoint.agentId=agent003</span><br><span class="line">set CATALINA_OPTS=%CATALINA_OPTS% -Dpinpoint.applicationName=172_8081</span><br></pre></td></tr></table></figure>
<p>启动tomcat后，我们打开pinpoint-web控制台<br><img src="/images/2019/0108/09.png" alt="pinpoint"></p>
<h2 id="微服务springboot添加pinpoint探针"><a href="#微服务springboot添加pinpoint探针" class="headerlink" title="微服务springboot添加pinpoint探针"></a>微服务springboot添加pinpoint探针</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/usr/local/jdk1.8.0_202/bin/java -jar -javaagent:/usr/local/ths/pinpoint-agent/pinpoint-bootstrap-1.8.4.jar  -Dpinpoint.agentId=monitor-china-server -Dpinpoint.applicationName=chinaserver /usr/local/ths/monitor-china-server.jar </span><br></pre></td></tr></table></figure>
<h1 id="web控制台简单应用"><a href="#web控制台简单应用" class="headerlink" title="web控制台简单应用"></a>web控制台简单应用</h1><p>通过这个图，我们就能看到项目应用直接的依赖关系<br><img src="/images/2019/0108/10.png" alt="pinpoint"><br><img src="/images/2019/0108/11.png" alt="pinpoint"><br><img src="/images/2019/0108/12.png" alt="pinpoint"></p>
<h1 id="删除应用"><a href="#删除应用" class="headerlink" title="删除应用"></a>删除应用</h1><p>如果有调试时产生已经废弃的应用，我们可以使用管理员api调用删除，可以使用应用名称（ <code>/admin/removeApplicationName.pinpoint?applicationName=$APPLICATION_NAME&amp;password=$PASSWORD</code>）或者客户端id（<code>/admin/removeAgentId.pinpoint?applicationName=$APPLICATION_NAME&amp;agentId=$AGENT_ID&amp;password=$PASSWORD</code>）两种方法删除；$PASSWORD为<code>pinpoint-web.properties</code>文件中的<code>admin.password</code>配置项值。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#示例</span><br><span class="line">http://172.16.10.24:8080/admin/removeApplicationName.pinpoint?applicationName=chinaserver.jar&amp;password=admin</span><br></pre></td></tr></table></figure>



<p>参考链接；<br><a href="https://www.infoq.cn/article/apm-Pinpoint-practice">https://www.infoq.cn/article/apm-Pinpoint-practice</a><br><a href="https://www.cnblogs.com/yyhh/p/6106472.html">https://www.cnblogs.com/yyhh/p/6106472.html</a><br><a href="https://github.com/naver/pinpoint/releases">https://github.com/naver/pinpoint/releases</a><br><a href="https://blog.csdn.net/wh211212/article/details/80437696">https://blog.csdn.net/wh211212/article/details/80437696</a></p>
<hr>
]]></content>
      <categories>
        <category>监控</category>
      </categories>
      <tags>
        <tag>监控</tag>
        <tag>pinpoint</tag>
        <tag>APM</tag>
      </tags>
  </entry>
  <entry>
    <title>持续检测端口连通性</title>
    <url>/arlo/50806164/</url>
    <content><![CDATA[<p>一个地址端口有时候可以通，有时候不行，telnet只能检测某一时刻的连通状态；为了持续检测，我这边写了一个shell脚本，内容如下。</p>
<span id="more"></span>

<h1 id="编写一个非交互式shell检测脚本"><a href="#编写一个非交互式shell检测脚本" class="headerlink" title="编写一个非交互式shell检测脚本"></a>编写一个非交互式shell检测脚本</h1><p><code>vim check_port.sh</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">IP=&#x27;192.168.100.130&#x27;</span><br><span class="line">PORT_LIST=&quot;22 8080&quot;</span><br><span class="line">TIME_STAMP=`date &quot;+%Y-%m-%d %T&quot;`</span><br><span class="line">for PORT in $PORT_LIST</span><br><span class="line">do</span><br><span class="line">    RESULT=`echo &quot;&quot; | telnet $IP $PORT 2&gt;/dev/null | grep &quot;]&quot; | wc -l`</span><br><span class="line">    if [ $RESULT -eq 1 ];then</span><br><span class="line">        echo &quot;$TIME_STAMP $IP的$PORT端口可以连通&quot; &gt;&gt; /tmp/1.txt</span><br><span class="line">    else </span><br><span class="line">        echo &quot;$TIME_STAMP $IP的$PORT端口不能连通&quot; &gt;&gt; /tmp/1.txt</span><br><span class="line">    fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h1 id="添加执行权限"><a href="#添加执行权限" class="headerlink" title="添加执行权限"></a>添加执行权限</h1><p><code>chmod +x /opt/check_post.sh</code></p>
<h1 id="使用crontab定时执行脚本"><a href="#使用crontab定时执行脚本" class="headerlink" title="使用crontab定时执行脚本"></a>使用crontab定时执行脚本</h1><p><code>crontab -l</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">*/5 * * * * /opt/check_post.sh</span><br></pre></td></tr></table></figure>



<p>ps：我发现了一个好工具tcping，可以直接实现ping+telnet, 下载地址：<a href="https://www.elifulkerson.com/projects/tcping.php">https://www.elifulkerson.com/projects/tcping.php</a></p>
<p>参考：<a href="https://www.jianshu.com/p/92adf516a62d">https://www.jianshu.com/p/92adf516a62d</a></p>
]]></content>
      <categories>
        <category>监控</category>
      </categories>
      <tags>
        <tag>监控</tag>
        <tag>shell</tag>
      </tags>
  </entry>
  <entry>
    <title>Ambari+HDP大数据平台搭建</title>
    <url>/arlo/34b2c7a7/</url>
    <content><![CDATA[<h1 id="Ambari-是什么？"><a href="#Ambari-是什么？" class="headerlink" title="Ambari 是什么？"></a>Ambari 是什么？</h1><p>Ambari 跟 Hadoop 等开源软件一样，也是 Apache Software Foundation 中的一个项目，并且是顶级项目。（<a href="http://ambari.apache.org)/">http://ambari.apache.org）</a> 目前最新的发布版本是 2.6.2.0；Ambari可以简单的理解为开源的Hadoop生态圈（Hive，Yarn，Hbase，Hive，Sqoop，Kafka，Zookeeper，spark 等）平台的管理软件，具备Hadoop组件的安装、管理、运维等基本功能，提供Web UI进行可视化的集群管理，简化了大数据平台的安装、使用难度。</p>
<span id="more"></span>
<h1 id="基础环境配置"><a href="#基础环境配置" class="headerlink" title="基础环境配置"></a>基础环境配置</h1><h2 id="资源规划"><a href="#资源规划" class="headerlink" title="资源规划"></a>资源规划</h2><table>
<thead>
<tr>
<th align="center">主机名</th>
<th align="center">IP地址</th>
<th align="center">操作系统</th>
</tr>
</thead>
<tbody><tr>
<td align="center">bigdata01.islocal.cc</td>
<td align="center">192.168.6.164</td>
<td align="center">CentOS Linux release 7.4.1708 (Core)</td>
</tr>
<tr>
<td align="center">bigdata02.islocal.cc</td>
<td align="center">192.168.6.181</td>
<td align="center">CentOS Linux release 7.4.1708 (Core)</td>
</tr>
<tr>
<td align="center">bigdata03.islocal.cc</td>
<td align="center">192.168.6.183</td>
<td align="center">CentOS Linux release 7.4.1708 (Core)</td>
</tr>
<tr>
<td align="center">bigdata04.islocal.cc</td>
<td align="center">192.168.6.194</td>
<td align="center">CentOS Linux release 7.4.1708 (Core)</td>
</tr>
</tbody></table>
<h2 id="软件版本"><a href="#软件版本" class="headerlink" title="软件版本"></a>软件版本</h2><p>JDK		1.8.1.8.0_112<br>postgresql	10.3<br>Ambari		2.6.2.0-155<br>HDP		2.6.4.0-91<br>HDP-GPL		2.6.4.0-91<br>HDP-UTILS	1.1.0.22	</p>
<h2 id="下载地址"><a href="#下载地址" class="headerlink" title="下载地址"></a>下载地址</h2><ol>
<li>首先登陆官方页面<br><a href="https://docs.hortonworks.com/index.html">https://docs.hortonworks.com/index.html</a></li>
<li>选择需要的版本</li>
<li>点击installation</li>
<li>选择Install Ambari</li>
<li>选择左侧的Ambari Repositories、HDP Stack Repositories</li>
</ol>
<h2 id="关闭防火墙和Selinux"><a href="#关闭防火墙和Selinux" class="headerlink" title="关闭防火墙和Selinux"></a>关闭防火墙和Selinux</h2><h3 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h3><p><code>systemctl stop firewalld.service</code></p>
<h3 id="禁用防火墙"><a href="#禁用防火墙" class="headerlink" title="禁用防火墙"></a>禁用防火墙</h3><p><code>systemctl disable firewalld.service</code><br>#查询防火墙服务状态</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@bigdata01 ~]# systemctl status firewalld.service</span><br><span class="line">● firewalld.service - firewalld - dynamic firewall daemon</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; disabled; vendor preset: enabled)</span><br><span class="line">   Active: inactive (dead)</span><br><span class="line">     Docs: man:firewalld(1)</span><br></pre></td></tr></table></figure>
<h3 id="关闭Selinux"><a href="#关闭Selinux" class="headerlink" title="关闭Selinux"></a>关闭Selinux</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/&#x27; /etc/selinux/config</span><br><span class="line">grep SELINUX=disabled /etc/selinux/config</span><br><span class="line">setenforce 0</span><br></pre></td></tr></table></figure>
<h3 id="查看Selinux状态"><a href="#查看Selinux状态" class="headerlink" title="查看Selinux状态"></a>查看Selinux状态</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@bigdata01 ~]# sestatus </span><br><span class="line">SELinux status:                 disabled</span><br><span class="line"></span><br><span class="line">or</span><br><span class="line"></span><br><span class="line">[root@bigdata01 ~]# getenforce </span><br><span class="line">Disabled</span><br></pre></td></tr></table></figure>
<h2 id="新建用户"><a href="#新建用户" class="headerlink" title="新建用户"></a>新建用户</h2><p><code>useradd hadoop &amp;&amp; echo &quot;hadoop:hadoop&quot; | chpasswd</code><br><code>visudo</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">## Allow root to run any commands anywhere </span><br><span class="line">root    ALL=(ALL)       ALL</span><br><span class="line">hadoop  ALL=(ALL)       ALL			#赋予hadoop用户所有权限</span><br><span class="line"></span><br><span class="line">## Allows members of the &#x27;sys&#x27; group to run networking, software, </span><br><span class="line">## service management apps and more.</span><br><span class="line"># %sys ALL = NETWORKING, SOFTWARE, SERVICES, STORAGE, DELEGATING, PROCESSES, LOCATE, DRIVERS</span><br><span class="line"></span><br><span class="line">## Allows people in group wheel to run all commands</span><br><span class="line">%wheel  ALL=(ALL)       ALL</span><br><span class="line">hadoop          ALL=(ALL)       NOPASSWD: ALL	#hadoop用户执行sudo不用输入密码</span><br></pre></td></tr></table></figure>
<h2 id="hadoop用户免密配置"><a href="#hadoop用户免密配置" class="headerlink" title="hadoop用户免密配置"></a>hadoop用户免密配置</h2><h3 id="配置bigdata01主机上的hosts"><a href="#配置bigdata01主机上的hosts" class="headerlink" title="配置bigdata01主机上的hosts"></a>配置bigdata01主机上的hosts</h3><p><code>[root@bigdata01 ~]# cat /etc/hosts</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.6.164	bigdata01.islocal.cc</span><br><span class="line">192.168.6.181	bigdata02.islocal.cc</span><br><span class="line">192.168.6.183	bigdata03.islocal.cc</span><br><span class="line">192.168.6.194	bigdata04.islocal.cc</span><br></pre></td></tr></table></figure>
<h3 id="复制-x2F-etc-x2F-hosts到其他主机"><a href="#复制-x2F-etc-x2F-hosts到其他主机" class="headerlink" title="复制&#x2F;etc&#x2F;hosts到其他主机"></a>复制&#x2F;etc&#x2F;hosts到其他主机</h3><p><code>scp /etc/hosts bigdata02.islocal.cc:/etc/hosts</code><br><code>scp /etc/hosts bigdata03.islocal.cc:/etc/hosts</code><br><code>scp /etc/hosts bigdata04.islocal.cc:/etc/hosts</code></p>
<h3 id="配置免密"><a href="#配置免密" class="headerlink" title="配置免密"></a>配置免密</h3><p><code>su - hadoop</code><br><code>ssh-keygen	#默认一路回车 </code></p>
<h3 id="拷贝秘钥到其他主机"><a href="#拷贝秘钥到其他主机" class="headerlink" title="拷贝秘钥到其他主机"></a>拷贝秘钥到其他主机</h3><p><code>ssh-copy-id bigdata01.islocal.cc</code><br><code>ssh-copy-id bigdata02.islocal.cc</code><br><code>ssh-copy-id bigdata03.islocal.cc</code><br><code>ssh-copy-id bigdata04.islocal.cc</code></p>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p><code>ssh bigdata01.islocal.cc date</code><br><code>ssh bigdata02.islocal.cc date</code><br><code>ssh bigdata03.islocal.cc date</code><br><code>ssh bigdata04.islocal.cc date</code></p>
<h2 id="配置时间同步"><a href="#配置时间同步" class="headerlink" title="配置时间同步"></a>配置时间同步</h2><p>如果服务器可以上外网，直接使用公网时间服务器即可<br><code>yum -y install ntpdate</code><br><code>crontab -e</code><br>添加下边这行，保存。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">*/10 * * * * /usr/sbin/ntpdate cn.ntp.org.cn &amp;&amp; hwclock -w</span><br></pre></td></tr></table></figure>
<h2 id="安装JDK"><a href="#安装JDK" class="headerlink" title="安装JDK"></a>安装JDK</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir /usr/ths</span><br><span class="line">tar xf jdk1.8.0_112.tgz -C /usr/ths</span><br><span class="line"># 安装jce</span><br><span class="line">http://www.oracle.com/technetwork/java/javase/downloads/jce8-download-2133166.html</span><br><span class="line">unzip -o -j -q jce_policy-8.zip -d /usr/ths/jdk1.8.0_112/jre/lib/security/</span><br><span class="line"></span><br><span class="line">vim /etc/profile</span><br><span class="line">export EDITOR=/usr/bin/vim</span><br><span class="line">export HISTSIZE=10000</span><br><span class="line">export HISTTIMEFORMAT=&quot;%F %T &quot;</span><br><span class="line">export JAVA_HOME=/usr/ths/jdk1.8.0_112</span><br><span class="line">export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</span><br><span class="line"></span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>
<h2 id="系统参数优化"><a href="#系统参数优化" class="headerlink" title="系统参数优化"></a>系统参数优化</h2><p><code>vim /etc/security/limits.conf</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">* soft nofile 65536</span><br><span class="line">* hard nofile 65536</span><br></pre></td></tr></table></figure>
<h1 id="本地仓库搭建"><a href="#本地仓库搭建" class="headerlink" title="本地仓库搭建"></a>本地仓库搭建</h1><p>由于ambari，hdp软件包很大，使用官方的yum源安装比较慢，我们搭建一个本地仓库，使用本地yum源</p>
<h2 id="安装配置web服务器"><a href="#安装配置web服务器" class="headerlink" title="安装配置web服务器"></a>安装配置web服务器</h2><h3 id="安装依赖包"><a href="#安装依赖包" class="headerlink" title="安装依赖包"></a>安装依赖包</h3><p><code>yum install gcc gcc-c++ make automake autoconf libtool pcre pcre-devel zlib zlib-devel openssl openssl-devel wget</code></p>
<h3 id="安装nginx"><a href="#安装nginx" class="headerlink" title="安装nginx"></a>安装nginx</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wget http://nginx.org/download/nginx-1.14.0.tar.gz</span><br><span class="line">tar xf nginx-1.14.0.tar.gz</span><br><span class="line">cd nginx-1.14.0</span><br><span class="line">./configure --prefix=/usr/ths/nginx-1.14.0/ &amp;&amp; make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<h3 id="更换nginx根目录"><a href="#更换nginx根目录" class="headerlink" title="更换nginx根目录"></a>更换nginx根目录</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir -p /var/www/html/</span><br><span class="line">vim /usr/ths/nginx-1.14.0/conf/nginx.conf</span><br><span class="line">...</span><br><span class="line">location / &#123;</span><br><span class="line">            root   /var/www/html;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">            autoindex on;	#允许列出目录</span><br><span class="line">        &#125;</span><br><span class="line">...</span><br><span class="line">#监测配置文件是否正确</span><br><span class="line">cd /usr/ths/nginx-1.14.0/sbin</span><br><span class="line">./nginx -t</span><br><span class="line">#启动</span><br><span class="line">./nginx</span><br></pre></td></tr></table></figure>
<h2 id="解压文件到nginx发布目录下"><a href="#解压文件到nginx发布目录下" class="headerlink" title="解压文件到nginx发布目录下"></a>解压文件到nginx发布目录下</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir -p  /var/www/html/hdp/</span><br><span class="line">tar xf ambari-2.6.2.0-centos7.tar.gz -C /var/www/html/</span><br><span class="line">tar xf HDP-GPL-2.6.4.0-centos7-rpm.tar.gz -C /var/www/html/hdp/</span><br><span class="line">tar xf HDP-UTILS-1.1.0.22-centos7.tar.gz -C /var/www/html/hdp/</span><br><span class="line">tar xf HDP-2.6.4.0-centos7-rpm.tar.gz -C /var/www/html/hdp/</span><br></pre></td></tr></table></figure>
<p>目录结构如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@bigdata01 ~]# tree -L 4 /var/www/html/</span><br><span class="line">/var/www/html/</span><br><span class="line">├── ambari</span><br><span class="line">│   └── centos7</span><br><span class="line">│       └── 2.6.2.0-155</span><br><span class="line">│           ├── ambari</span><br><span class="line">│           ├── ambari.repo</span><br><span class="line">│           ├── artifacts.txt</span><br><span class="line">│           ├── build.id</span><br><span class="line">│           ├── build_metadata.txt</span><br><span class="line">│           ├── repodata</span><br><span class="line">│           ├── RPM-GPG-KEY</span><br><span class="line">│           ├── smartsense</span><br><span class="line">│           └── tars</span><br><span class="line">└── hdp</span><br><span class="line">    ├── HDP</span><br><span class="line">    │   └── centos7</span><br><span class="line">    │       └── 2.6.4.0-91</span><br><span class="line">    ├── HDP-GPL</span><br><span class="line">    │   └── centos7</span><br><span class="line">    │       └── 2.6.4.0-91</span><br><span class="line">    └── HDP-UTILS</span><br><span class="line">        └── centos7</span><br><span class="line">            └── 1.1.0.22</span><br><span class="line"></span><br><span class="line">18 directories, 4 files</span><br></pre></td></tr></table></figure>
<h2 id="安装本地源制作相关工具"><a href="#安装本地源制作相关工具" class="headerlink" title="安装本地源制作相关工具"></a>安装本地源制作相关工具</h2><p><code>yum install yum-utils createrepo</code></p>
<h2 id="编辑repo文件"><a href="#编辑repo文件" class="headerlink" title="编辑repo文件"></a>编辑repo文件</h2><p><code>cat /etc/yum.repos.d/ambari.repo </code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#VERSION_NUMBER=2.6.2.0-155</span><br><span class="line">[ambari-2.6.2.0]</span><br><span class="line">name=ambari Version - ambari-2.6.2.0</span><br><span class="line">baseurl=http://192.168.6.164/ambari/centos7/2.6.2.0-155/</span><br><span class="line">gpgcheck=0</span><br></pre></td></tr></table></figure>
<h1 id="安装数据库"><a href="#安装数据库" class="headerlink" title="安装数据库"></a>安装数据库</h1><p>Ambari支持PostgreSQL 9.1.13+,9.3, 9.4 MariaDB 10.1 MySQL 5.6 Oracle 11gr2 Oracle 12c 等版本数据库，我们这里使用postgres数据库。</p>
<h2 id="创建用户和组"><a href="#创建用户和组" class="headerlink" title="创建用户和组"></a>创建用户和组</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">groupadd postgres    #新增用户组</span><br><span class="line">useradd -g postgres postgres    #新增用户</span><br><span class="line">passwd postgres    #为用户设置密码</span><br></pre></td></tr></table></figure>
<h2 id="创建数据目录，并授予权限"><a href="#创建数据目录，并授予权限" class="headerlink" title="创建数据目录，并授予权限"></a>创建数据目录，并授予权限</h2><p><code> mkdir -p /usr/ths/data/PGDATA</code><br><code> chown postgres:postgres /usr/ths/data/PGDATA</code><br><code> chmod 700 /usr/ths/data/PGDATA</code></p>
<h2 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tar -zxvf  postgresql-10.3.tar.gz</span><br><span class="line">cd postgresql-10.3</span><br><span class="line">./configure --prefix=/usr/ths/pgsql-10.3 --without-readline</span><br><span class="line">sudo make</span><br><span class="line">sudo make install</span><br><span class="line">su - postgres   </span><br><span class="line">/usr/ths/pgsql-10.3/bin/initdb -D /usr/ths/data/PGDATA  #初始化配置和数据库</span><br></pre></td></tr></table></figure>
<h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># -D 为数据文件位置  -l 为日志文件位置(日志文件不存在会自动创建)</span><br><span class="line">/usr/ths/pgsql-10.3/bin/pg_ctl start -D /usr/ths/data/PGDATA -l /usr/ths/data/PGDATA/pgsql.log</span><br></pre></td></tr></table></figure>
<p>#可选。 配置环境变量<br><code>vi cat /etc/profile</code><br>追加以下两行到&#x2F;etc&#x2F;profile</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">export PG_HOME=/usr/ths/pgsql-10.3</span><br><span class="line">export PATH=$PG_HOME/bin:$PATH   </span><br><span class="line">#注意，环境变量要把:$PATH写在后面，可以避免一些版本冲突问题</span><br></pre></td></tr></table></figure>
<h2 id="配置文件修改"><a href="#配置文件修改" class="headerlink" title="配置文件修改"></a>配置文件修改</h2><p>&#x2F;usr&#x2F;ths&#x2F;data&#x2F;PGDATA&#x2F;postgresql.conf</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">listen_addresses = &#x27;*&#x27;</span><br></pre></td></tr></table></figure>
<p>pg_hba.conf</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">host 	all 	all 	192.168.6.1/24 	trust</span><br></pre></td></tr></table></figure>
<h2 id="新建ambari数据库"><a href="#新建ambari数据库" class="headerlink" title="新建ambari数据库"></a>新建ambari数据库</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">su - postgres</span><br><span class="line">#进入psql命令行工具</span><br><span class="line">psql</span><br><span class="line">#依次执行以下建库建用户语句</span><br><span class="line">CREATE DATABASE ambari; </span><br><span class="line">CREATE USER hdp WITH PASSWORD &#x27;solution&#x27;;</span><br><span class="line">GRANT ALL PRIVILEGES ON DATABASE ambari TO hdp; </span><br><span class="line">\connect ambari; </span><br><span class="line">CREATE SCHEMA AMBARI AUTHORIZATION hdp;</span><br><span class="line">ALTER SCHEMA AMBARI OWNER TO hdp;</span><br><span class="line">ALTER ROLE hdp SET search_path to &#x27;AMBARI&#x27;, &#x27;public&#x27;;</span><br><span class="line">#退出</span><br><span class="line">\q</span><br></pre></td></tr></table></figure>
<p>执行Ambari的DDL语句</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 以hdp用户，连接ambari库</span><br><span class="line">psql -U hdp -d ambari</span><br><span class="line"># 执行DDL语句</span><br><span class="line">\i /var/lib/ambari-server/resources/Ambari-DDL-Postgres-CREATE.sql</span><br><span class="line">#执行完毕后，退出</span><br><span class="line">\q</span><br></pre></td></tr></table></figure>
<h2 id="设置Ambari使用的PostgreSQL驱动包"><a href="#设置Ambari使用的PostgreSQL驱动包" class="headerlink" title="设置Ambari使用的PostgreSQL驱动包"></a>设置Ambari使用的PostgreSQL驱动包</h2><p><code>wget https://jdbc.postgresql.org/download/postgresql-42.2.2.jar -O /usr/ths/lib/postgresql-42.2.2.jar</code><br>root用户执行<br><code>ambari-server setup --jdbc-db=postgres --jdbc-driver=/usr/ths/lib/postgresql-42.2.2.jar</code></p>
<h1 id="安装Ambari"><a href="#安装Ambari" class="headerlink" title="安装Ambari"></a>安装Ambari</h1><p><code>yum -y install ambari-server</code></p>
<h2 id="配置Ambari"><a href="#配置Ambari" class="headerlink" title="配置Ambari"></a>配置Ambari</h2><p><code>ambari-server setup</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#Customize user account for ambari-server daemon [y/n] (n)?  y		#自定义设置</span><br><span class="line">#Enter user account for ambari-server daemon (postgres): hadoop</span><br><span class="line">#Do you want to change Oracle JDK [y/n] (n)? y		#是否修改Jdk</span><br><span class="line">#Enter choice (1): 3					#输入3</span><br><span class="line">#Path to JAVA_HOME: /usr/ths/jdk1.8.0_112		#设置jdk路径	</span><br><span class="line">#Enter advanced database configuration [y/n] (n)? y	#是否进入高级数据库设置</span><br><span class="line">#Enter choice (1): 4					#数据库类型4（PostgreSQL）</span><br><span class="line">#Hostname (localhost): 192.168.6.164			#数据库地址</span><br><span class="line">#Port (5432): 5432					#数据库端口</span><br><span class="line">#Database name (ambari): ambari				#数据库名</span><br><span class="line">#Postgres schema (ambari): ambari			</span><br><span class="line">#Username (ambari): hdp					#数据库用户名</span><br><span class="line">#Enter Database Password (bigdata): solution		#数据库密码	</span><br><span class="line">#Re-enter password:你的密码</span><br><span class="line">#Proceed with configuring remote database connection properties [y/n] (y)? y</span><br></pre></td></tr></table></figure>
<h2 id="启动ambari-server"><a href="#启动ambari-server" class="headerlink" title="启动ambari-server"></a>启动ambari-server</h2><p><code>ambari-server start</code><br>访问地址：<a href="http://192.168.6.164:8080/">http://192.168.6.164:8080</a> 默认用户名密码： admin&#x2F;admin	<br><img src="/images/2018/0615/01.png" alt="ambari"></p>
<h1 id="安装HDP集群"><a href="#安装HDP集群" class="headerlink" title="安装HDP集群"></a>安装HDP集群</h1><h2 id="点击图中的蓝色按钮“Launch-Install-Wizard”启动安装向导。"><a href="#点击图中的蓝色按钮“Launch-Install-Wizard”启动安装向导。" class="headerlink" title="点击图中的蓝色按钮“Launch Install Wizard”启动安装向导。"></a>点击图中的蓝色按钮“Launch Install Wizard”启动安装向导。</h2><p><img src="/images/2018/0615/02.png" alt="ambari"></p>
<h2 id="设置HDP集群名称"><a href="#设置HDP集群名称" class="headerlink" title="设置HDP集群名称"></a>设置HDP集群名称</h2><p><img src="/images/2018/0615/03.png" alt="ambari"></p>
<h2 id="选择要安装的HDP版本和本地仓库配置"><a href="#选择要安装的HDP版本和本地仓库配置" class="headerlink" title="选择要安装的HDP版本和本地仓库配置"></a>选择要安装的HDP版本和本地仓库配置</h2><p><img src="/images/2018/0615/04.png" alt="ambari"></p>
<h2 id="设置ssh私钥"><a href="#设置ssh私钥" class="headerlink" title="设置ssh私钥"></a>设置ssh私钥</h2><p>私钥内容为&#x2F;home&#x2F;hadoop&#x2F;.ssh&#x2F;id_rsa文件内容，可以下载该文件或者直接复制文件内容<br><img src="/images/2018/0615/05.png" alt="ambari"></p>
<h2 id="监测ssh免密通信"><a href="#监测ssh免密通信" class="headerlink" title="监测ssh免密通信"></a>监测ssh免密通信</h2><p><img src="/images/2018/0615/06.png" alt="ambari"></p>
<h2 id="选择要安装的服务"><a href="#选择要安装的服务" class="headerlink" title="选择要安装的服务"></a>选择要安装的服务</h2><p>这里根据自己的安装选择，安装完成后也可以在Services-Action中添加<br><img src="/images/2018/0615/07.png" alt="ambari"></p>
<h2 id="配置各个服务Master"><a href="#配置各个服务Master" class="headerlink" title="配置各个服务Master"></a>配置各个服务Master</h2><p>这里可以在下拉选项里选择调整一下默认的主机设置，保持资源均衡<br><img src="/images/2018/0615/08.png" alt="ambari"></p>
<h2 id="服务的Slaves-和-Clients节配置"><a href="#服务的Slaves-和-Clients节配置" class="headerlink" title="服务的Slaves 和 Clients节配置"></a>服务的Slaves 和 Clients节配置</h2><p><img src="/images/2018/0615/09.png" alt="ambari"></p>
<h2 id="服务器自定义配置"><a href="#服务器自定义配置" class="headerlink" title="服务器自定义配置"></a>服务器自定义配置</h2><p>这里一般出现的红色警告都是需要设置密码的地方，手动填一下即可！<br><img src="/images/2018/0615/10.png" alt="ambari"><br>这里填写之前设置过的postgres数据库hdp用户，填写完成后测试一下<br><img src="/images/2018/0615/11.png" alt="ambari"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Admin Name : admin</span><br><span class="line"></span><br><span class="line">Cluster Name : ARLO</span><br><span class="line"></span><br><span class="line">Total Hosts : 4 (4 new)</span><br><span class="line"></span><br><span class="line">Repositories:</span><br><span class="line"></span><br><span class="line">redhat7 (HDP-2.6): </span><br><span class="line">http://192.168.6.164/hdp/HDP/centos7/2.6.4.0-91/</span><br><span class="line">redhat7 (HDP-2.6-GPL): </span><br><span class="line">http://192.168.6.164/hdp/HDP-GPL/centos7/2.6.4.0-91/</span><br><span class="line">redhat7 (HDP-UTILS-1.1.0.22): </span><br><span class="line">http://192.168.6.164/hdp/HDP-UTILS/centos7/1.1.0.22/</span><br><span class="line">Services:</span><br><span class="line"></span><br><span class="line">HDFS</span><br><span class="line">DataNode : 3 hosts</span><br><span class="line">NameNode : bigdata01.islocal.cc</span><br><span class="line">NFSGateway : 1 host</span><br><span class="line">SNameNode : bigdata02.islocal.cc</span><br><span class="line">YARN + MapReduce2</span><br><span class="line">App Timeline Server : bigdata04.islocal.cc</span><br><span class="line">NodeManager : 1 host</span><br><span class="line">ResourceManager : bigdata04.islocal.cc</span><br><span class="line">Tez</span><br><span class="line">Clients : 1 host</span><br><span class="line">Hive</span><br><span class="line">Metastore : bigdata02.islocal.cc</span><br><span class="line">HiveServer2 : bigdata02.islocal.cc</span><br><span class="line">WebHCat Server : bigdata02.islocal.cc</span><br><span class="line">Database : Existing PostgreSQL Database</span><br><span class="line">HBase</span><br><span class="line">Master : bigdata01.islocal.cc</span><br><span class="line">RegionServer : 1 host</span><br><span class="line">Phoenix Query Server : 0 host</span><br><span class="line">Pig</span><br><span class="line">Clients : 1 host</span><br><span class="line">ZooKeeper</span><br><span class="line">Server : 3 hosts</span><br><span class="line">Ambari Metrics</span><br><span class="line">Metrics Collector : bigdata03.islocal.cc</span><br><span class="line">Grafana : bigdata03.islocal.cc</span><br><span class="line">SmartSense</span><br><span class="line">Activity Analyzer : bigdata01.islocal.cc</span><br><span class="line">Activity Explorer : bigdata01.islocal.cc</span><br><span class="line">HST Server : bigdata01.islocal.cc</span><br><span class="line">Slider</span><br><span class="line">Clients : 1 host</span><br></pre></td></tr></table></figure>
<h2 id="开始安装"><a href="#开始安装" class="headerlink" title="开始安装"></a>开始安装</h2><p><img src="/images/2018/0615/12.png" alt="ambari"><br><img src="/images/2018/0615/13.png" alt="ambari"><br><img src="/images/2018/0615/14.png" alt="ambari"><br><img src="/images/2018/0615/15.png" alt="ambari"><br>出现警告，在安装过程完成后，可以进入到service里单独启动一下，看看日志报错详细解决。</p>
<h2 id="解决完所有告警，效果图如下"><a href="#解决完所有告警，效果图如下" class="headerlink" title="解决完所有告警，效果图如下"></a>解决完所有告警，效果图如下</h2><p><img src="/images/2018/0615/16.png" alt="ambari"></p>
<h1 id="NameNode-HA配置"><a href="#NameNode-HA配置" class="headerlink" title="NameNode HA配置"></a>NameNode HA配置</h1><h2 id="关闭HBase服务"><a href="#关闭HBase服务" class="headerlink" title="关闭HBase服务"></a>关闭HBase服务</h2><p><strong>这一步非常重要</strong><br><img src="/images/2018/0615/17.png" alt="ambari"></p>
<h2 id="点击Services-HDFS-Enable-NameNode-HA"><a href="#点击Services-HDFS-Enable-NameNode-HA" class="headerlink" title="点击Services-HDFS-Enable NameNode HA"></a>点击Services-HDFS-Enable NameNode HA</h2><p><img src="/images/2018/0615/18.png" alt="ambari"></p>
<h2 id="输入Nameservice-ID"><a href="#输入Nameservice-ID" class="headerlink" title="输入Nameservice ID"></a>输入Nameservice ID</h2><p><img src="/images/2018/0615/19.png" alt="ambari"></p>
<h2 id="选择要安装的主机"><a href="#选择要安装的主机" class="headerlink" title="选择要安装的主机"></a>选择要安装的主机</h2><p><img src="/images/2018/0615/20.png" alt="ambari"></p>
<h2 id="默认即可"><a href="#默认即可" class="headerlink" title="默认即可"></a>默认即可</h2><p><img src="/images/2018/0615/21.png" alt="ambari"></p>
<h2 id="根据提示登录到对应主机上执行提示命令"><a href="#根据提示登录到对应主机上执行提示命令" class="headerlink" title="根据提示登录到对应主机上执行提示命令"></a>根据提示登录到对应主机上执行提示命令</h2><p>如下图所示<br><img src="/images/2018/0615/23.png" alt="ambari"></p>
<h2 id="开始安装组件"><a href="#开始安装组件" class="headerlink" title="开始安装组件"></a>开始安装组件</h2><p><img src="/images/2018/0615/24.png" alt="ambari"><br><img src="/images/2018/0615/25.png" alt="ambari"><br><img src="/images/2018/0615/26.png" alt="ambari"></p>
<h2 id="初始化组件"><a href="#初始化组件" class="headerlink" title="初始化组件"></a>初始化组件</h2><p><img src="/images/2018/0615/27.png" alt="ambari"><br><img src="/images/2018/0615/28.png" alt="ambari"></p>
<h2 id="Namenode-HA启用完成，如图所示"><a href="#Namenode-HA启用完成，如图所示" class="headerlink" title="Namenode HA启用完成，如图所示"></a>Namenode HA启用完成，如图所示</h2><p><img src="/images/2018/0615/29.png" alt="ambari"></p>
<p>参考链接：<br><a href="http://www.cnblogs.com/zhijianliutang/articles/5195045.html">http://www.cnblogs.com/zhijianliutang/articles/5195045.html</a><br><a href="https://blog.csdn.net/mawenwu1983/article/details/78983275">https://blog.csdn.net/mawenwu1983/article/details/78983275</a><br><a href="http://wiki.ttxit.com/display/hortonworks/Hortonworks">http://wiki.ttxit.com/display/hortonworks/Hortonworks</a><br><a href="https://www.ibm.com/developerworks/cn/opensource/os-cn-bigdata-ambari/index.html">https://www.ibm.com/developerworks/cn/opensource/os-cn-bigdata-ambari/index.html</a><br><a href="http://blog.51cto.com/hsbxxl/1981411">http://blog.51cto.com/hsbxxl/1981411</a></p>
]]></content>
      <categories>
        <category>大数据</category>
      </categories>
      <tags>
        <tag>Ambari</tag>
        <tag>HDP</tag>
      </tags>
  </entry>
  <entry>
    <title>使用sqlldr导入txt数据</title>
    <url>/arlo/2d7abdb2/</url>
    <content><![CDATA[<p>将txt或者csv数据导入数据库最方便的方法就是使用sqlldr，使用sqlldr必须有一个控制文件，控制文件能把外部数据和数据库的表和列联系起来。</p>
<span id="more"></span>
<h1 id="新建数据表"><a href="#新建数据表" class="headerlink" title="新建数据表"></a>新建数据表</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE TABLE &quot;TENVAIR&quot;.&quot;TEST&quot;</span><br><span class="line">   (&quot;EMISS_GRIDID&quot; NUMBER(*,0) NOT NULL ENABLE,</span><br><span class="line">&quot;X&quot; NUMBER(*,0) NOT NULL ENABLE,</span><br><span class="line">&quot;Y&quot; NUMBER(*,0) NOT NULL ENABLE,</span><br><span class="line">&quot;EMISS_TYPE&quot; VARCHAR2(16) NOT NULL ENABLE,</span><br><span class="line">&quot;POLLUTION_TYPE&quot; VARCHAR2(16) NOT NULL ENABLE,</span><br><span class="line">&quot;JAN&quot; NUMBER(20,10),</span><br><span class="line">&quot;FEB&quot; NUMBER(20,10),</span><br><span class="line">&quot;MAR&quot; NUMBER(20,10),</span><br><span class="line">&quot;APR&quot; NUMBER(20,10),</span><br><span class="line">&quot;MAY&quot; NUMBER(20,10),</span><br><span class="line">&quot;JUN&quot; NUMBER(20,10),</span><br><span class="line">&quot;JUL&quot; NUMBER(20,10),</span><br><span class="line">&quot;AUG&quot; NUMBER(20,10),</span><br><span class="line">&quot;SEP&quot; NUMBER(20,10),</span><br><span class="line">&quot;OCT&quot; NUMBER(20,10),</span><br><span class="line">&quot;NOV&quot; NUMBER(20,10),</span><br><span class="line">&quot;DEC&quot; NUMBER(20,10),</span><br><span class="line">&quot;TOTAL&quot; NUMBER(20,10));</span><br></pre></td></tr></table></figure>
<h1 id="数据格式"><a href="#数据格式" class="headerlink" title="数据格式"></a>数据格式</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">EMISS_GRIDID,X,Y,EMISS_TYPE,POLLUTION_TYPE,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC,TOTAL</span><br><span class="line">10398,158,33,agriculture,NH3,,,,,,,,,,,,,57.5565528870</span><br><span class="line">10398,158,33,industry,ALD2,,,,,,,,,,,,,0.0081295827</span><br><span class="line">10398,158,33,industry,ALDX,,,,,,,,,,,,,0.0782553777</span><br><span class="line">10398,158,33,industry,BC,,,,,,,,,,,,,2.5780515671</span><br></pre></td></tr></table></figure>
<h1 id="编写控制文件t-ctl"><a href="#编写控制文件t-ctl" class="headerlink" title="编写控制文件t.ctl"></a>编写控制文件t.ctl</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">load data</span><br><span class="line">append into table TENVAIR.TEST</span><br><span class="line">fields terminated by &#x27;,&#x27;</span><br><span class="line">TRAILING NULLCOLS</span><br><span class="line">(</span><br><span class="line">EMISS_GRIDID,</span><br><span class="line">X,</span><br><span class="line">Y,</span><br><span class="line">EMISS_TYPE,</span><br><span class="line">POLLUTION_TYPE,</span><br><span class="line">JAN,</span><br><span class="line">FEB,</span><br><span class="line">MAR,</span><br><span class="line">APR,</span><br><span class="line">MAY,</span><br><span class="line">JUN,</span><br><span class="line">JUL,</span><br><span class="line">AUG,</span><br><span class="line">SEP,</span><br><span class="line">OCT,</span><br><span class="line">NOV,</span><br><span class="line">DEC,</span><br><span class="line">TOTAL)</span><br></pre></td></tr></table></figure>
<p><strong>infile ‘EMISS_MEIC.txt’</strong> 表示要导入的文本名为EMISS_MEIC.txt，也可以在执行sqlldr的时候加data&#x3D;EMISS_MEIC.txt<br><strong>append&#x2F;insert&#x2F;replace&#x2F;truncate into table TABLE_NAME</strong>   append表示使用追加的方式将数据写入表中；insert 表示导入空表，有数据则停止；replace表示原来表中如果有数据，则会被删除（用delete from table语句）;truncate表示原来表中如果有数据，则会被清除（用truncate table语句）<br><strong>fields terminated by ‘,’</strong>  数据中每行记录用”,”分隔<br><strong>TRAILING NULLCOLS</strong>    表的字段没有对应的值时允许为空</p>
<h1 id="使用sqlldr导入"><a href="#使用sqlldr导入" class="headerlink" title="使用sqlldr导入"></a>使用sqlldr导入</h1><p>如果数据文件是从windows传到linux操作系统上的，需要转换一下文件格式<br><code>dos2unix EMISS_MEIC.txt</code><br><code>sqlldr userid=user/&#39;passwd&#39; control=t.ctl data=EMISS_MEIC.txt  readsize=4194304</code></p>
<h1 id="查看导入结果"><a href="#查看导入结果" class="headerlink" title="查看导入结果"></a>查看导入结果</h1><p>从日志文件中我们可以看到导入详情，导入1279319条数据，耗时33秒，效率还是非常高的！<br><img src="/images/2019/0420/01.png" alt="sqlldr"><br><img src="/images/2019/0420/02.png" alt="sqlldr"></p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>Oracle</tag>
      </tags>
  </entry>
  <entry>
    <title>表空间操作常用语句</title>
    <url>/arlo/b76e9b6/</url>
    <content><![CDATA[<h1 id="创建表空间T-WORK"><a href="#创建表空间T-WORK" class="headerlink" title="创建表空间T_WORK"></a>创建表空间T_WORK</h1><p><code>create tablespace T_WORK_DATA datafile &#39;/u01/app/oracle/oradata/airforecast/t_work01.dbf&#39; SIZE 200m AUTOEXTEND ON NEXT 32m MAXSIZE 32767M EXTENT MANAGEMENT LOCAL;</code><br><code>alter tablespace T_WORK_DATA add datafile &#39;/u01/app/oracle/oradata/airforecast/t_work02.dbf&#39; size 5M autoextend on maxsize 32767M;</code></p>
<h1 id="创建临时表空间"><a href="#创建临时表空间" class="headerlink" title="创建临时表空间"></a>创建临时表空间</h1><p><code>CREATE TEMPORARY TABLESPACE T_WORK_TEMP TEMPFILE &#39;/u01/app/oracle/oradata/airforecast/t_work_tmp01.dbf&#39; SIZE 200m AUTOEXTEND ON NEXT 32m MAXSIZE 2048m EXTENT MANAGEMENT LOCAL;</code></p>
<h1 id="创建T-WORK用户"><a href="#创建T-WORK用户" class="headerlink" title="创建T_WORK用户"></a>创建T_WORK用户</h1><p><code>CREATE USER T_WORK IDENTIFIED BY solution#123 DEFAULT TABLESPACE T_WORK_DATA TEMPORARY TABLESPACE T_WORK_TEMP;</code></p>
<h1 id="赋予权限"><a href="#赋予权限" class="headerlink" title="赋予权限"></a>赋予权限</h1><p><code>GRANT CONNECT,RESOURCE TO T_WORK;</code></p>
<span id="more"></span>
<h1 id="修改用户表所属表空间"><a href="#修改用户表所属表空间" class="headerlink" title="修改用户表所属表空间"></a>修改用户表所属表空间</h1><p><code>alter table TABLE_NAME move tablespace TABLESPACENAME</code></p>
<h1 id="删除表空间"><a href="#删除表空间" class="headerlink" title="删除表空间"></a>删除表空间</h1><p><code>DROP USER T_WORK CASCADE;</code><br><code>DROP TABLESPACE T_WORK_DATA INCLUDING CONTENTS AND DATAFILES;</code></p>
<h1 id="删除临时表空间"><a href="#删除临时表空间" class="headerlink" title="删除临时表空间"></a>删除临时表空间</h1><p><code>DROP TABLESPACE T_WORK_TEMP INCLUDING CONTENTS AND DATAFILES;</code></p>
<h1 id="开启自动扩展功能语法"><a href="#开启自动扩展功能语法" class="headerlink" title="开启自动扩展功能语法"></a>开启自动扩展功能语法</h1><p><code>alter database datafile &#39;对应的数据文件路径信息&#39; autoextend on;</code></p>
<h1 id="关闭自动扩展功能语法"><a href="#关闭自动扩展功能语法" class="headerlink" title="关闭自动扩展功能语法"></a>关闭自动扩展功能语法</h1><p><code>alter database datafile &#39;对应的数据文件路径信息&#39; autoextend off;</code></p>
<h1 id="查看默认数据表空间"><a href="#查看默认数据表空间" class="headerlink" title="查看默认数据表空间"></a>查看默认数据表空间</h1><p><code>SELECT PROPERTY_NAME, PROPERTY_VALUE FROM DATABASE_PROPERTIES;</code></p>
<h1 id="查看默认临时表空间"><a href="#查看默认临时表空间" class="headerlink" title="查看默认临时表空间"></a>查看默认临时表空间</h1><p><code>SELECT PROPERTY_NAME, PROPERTY_VALUE FROM DATABASE_PROPERTIES WHERE PROPERTY_NAME=&#39;DEFAULT_TEMP_TABLESPACE&#39;;</code></p>
<h1 id="查看普通用户的默认表空间和临时表空间"><a href="#查看普通用户的默认表空间和临时表空间" class="headerlink" title="查看普通用户的默认表空间和临时表空间"></a>查看普通用户的默认表空间和临时表空间</h1><p><code>SELECT USERNAME, DEFAULT_TABLESPACE, TEMPORARY_TABLESPACE FROM DBA_USERS;</code><br><code>SELECT DEFAULT_TABLESPACE,TEMPORARY_TABLESPACE FROM DBA_USERS WHERE USERNAME=&#39;T_WORK&#39;;</code></p>
<h1 id="修改表空间名称"><a href="#修改表空间名称" class="headerlink" title="修改表空间名称"></a>修改表空间名称</h1><p><code>alter tablespace T_WORK RENAME TO T_WORK_DATA;</code></p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>Oracle</tag>
        <tag>数据库</tag>
      </tags>
  </entry>
  <entry>
    <title>没有PE的情况下，如何强行修改Windows Server 2012密码？</title>
    <url>/arlo/fba0cc3c/</url>
    <content><![CDATA[<p>对windows环境比较熟悉的朋友都知道，windows下修改密码最常用的就是PE工具了，一键修改；最近服务器上有台Windows Server 2012的虚拟机密码忘记了，无奈又不能直接挂载PE上去，在网上看到这个方法，感觉很方便，在此记录一下！（服务器是Xen Server环境虚拟机，本教程是vmware workstations，方法差不多）</p>
<span id="more"></span>

<h1 id="挂载iso镜像到虚拟机"><a href="#挂载iso镜像到虚拟机" class="headerlink" title="挂载iso镜像到虚拟机"></a>挂载iso镜像到虚拟机</h1><p>重启虚拟机，从cd&#x2F;dvd-rom启动</p>
<p><img src="/images/2019/1111/01.png" alt="windows"></p>
<h1 id="引导至安装操作系统界面，点击下一步"><a href="#引导至安装操作系统界面，点击下一步" class="headerlink" title="引导至安装操作系统界面，点击下一步"></a>引导至安装操作系统界面，点击下一步</h1><p><img src="/images/2019/1111/02.png" alt="windows"></p>
<h1 id="进入安装界面，点击左下角开始修复"><a href="#进入安装界面，点击左下角开始修复" class="headerlink" title="进入安装界面，点击左下角开始修复"></a>进入安装界面，点击左下角开始修复</h1><p><img src="/images/2019/1111/06.png" alt="windows"></p>
<h1 id="选择一个选项界面-“疑难杂症”"><a href="#选择一个选项界面-“疑难杂症”" class="headerlink" title="选择一个选项界面-“疑难杂症”"></a>选择一个选项界面-“疑难杂症”</h1><p><img src="/images/2019/1111/03.png" alt="windows"></p>
<h1 id="高级选项界面-命令提示符"><a href="#高级选项界面-命令提示符" class="headerlink" title="高级选项界面-命令提示符"></a>高级选项界面-命令提示符</h1><p><img src="/images/2019/1111/04.png" alt="windows"></p>
<h1 id="在弹出的命令提示符窗口操作"><a href="#在弹出的命令提示符窗口操作" class="headerlink" title="在弹出的命令提示符窗口操作"></a>在弹出的命令提示符窗口操作</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">d:</span><br><span class="line">cd Windows\System32</span><br><span class="line">move Utilman.exe Utilman.exe.bak</span><br><span class="line">copy cmd.exe Utilman.exe</span><br><span class="line">shutdown /r /t 0</span><br></pre></td></tr></table></figure>

<p><img src="/images/2019/1111/05.png" alt="windows"></p>
<h1 id="重启虚拟机"><a href="#重启虚拟机" class="headerlink" title="重启虚拟机"></a>重启虚拟机</h1><p>点击左下角，弹出命令行提示框</p>
<p><img src="/images/2019/1111/07.png" alt="windows"></p>
<p>将administrator密码修改为111.com？</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">net user administrator 111.com?</span><br></pre></td></tr></table></figure>

<p><img src="/images/2019/1111/08.png" alt="windows"></p>
<p>成功登录操作系统。</p>
<p><img src="/images/2019/1111/09.png" alt="windows"></p>
]]></content>
      <categories>
        <category>Troubleshooting</category>
      </categories>
      <tags>
        <tag>Windows</tag>
      </tags>
  </entry>
  <entry>
    <title>Ambari集成HUE</title>
    <url>/arlo/8591b53b/</url>
    <content><![CDATA[<h1 id="Hue介绍"><a href="#Hue介绍" class="headerlink" title="Hue介绍"></a>Hue介绍</h1><p>Hue 是运营和开发Hadoop应用的图形化用户界面。Hue程序被整合到一个类似桌面的环境，以web程序的形式发布，对于单独的用户来说不需要额外的安装。</p>
<span id="more"></span>

<h1 id="依赖环境配置"><a href="#依赖环境配置" class="headerlink" title="依赖环境配置"></a>依赖环境配置</h1><h2 id="配置Maven3-5-4"><a href="#配置Maven3-5-4" class="headerlink" title="配置Maven3.5.4"></a>配置Maven3.5.4</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cd /usr/local/src/</span><br><span class="line">wget http://apache.mirrors.lucidnetworks.net/maven/maven-3/3.5.4/binaries/apache-maven-3.5.4-bin.tar.gz </span><br><span class="line">tar xf apache-maven-3.5.4-bin.tar.gz -C /usr/local/</span><br><span class="line">vim  /etc/profile</span><br><span class="line">export MAVEN_HOME=/usr/local/apache-maven-3.5.4</span><br><span class="line">export PATH=$PATH:$MAVEN_HOME/bin</span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>
<h2 id="python-版本2-6-6"><a href="#python-版本2-6-6" class="headerlink" title="python 版本2.6.6+"></a>python 版本2.6.6+</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python -V</span><br><span class="line">Python 2.7.5</span><br></pre></td></tr></table></figure>
<h2 id="其他依赖工具和包"><a href="#其他依赖工具和包" class="headerlink" title="其他依赖工具和包"></a>其他依赖工具和包</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum -y install ant asciidoc krb5-devel cyrus-sasl-gssapi cyrus-sasl-devel libxml2-devel libxslt-devel libtidy mysql mysql-devel openldap-devel python-devel python-simplejson python-setuptools sqlite-devel gcc gcc-c++ rsync saslwrapper-devel pycrypto gmp-devel libyaml-devel cyrus-sasl-plain cyrus-sasl-devel cyrus-sasl-gssapi libssl-devel libffi-devel libsasl2-dev libsasl2-modules-gssapi-mit libkrb5-dev</span><br></pre></td></tr></table></figure>
<h2 id="python模块依赖安装"><a href="#python模块依赖安装" class="headerlink" title="python模块依赖安装"></a>python模块依赖安装</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pip install --upgrade pip</span><br><span class="line">pip install ipdb</span><br><span class="line">pip install psycopg2</span><br><span class="line">pip install psycopg2-binary</span><br></pre></td></tr></table></figure>
<h1 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git clone https://github.com/cloudera/hue.git</span><br><span class="line">make apps（这一步可能遇到很多问题，比如某个包无法下载等，多执行几次就可以通过了）</span><br><span class="line">make locales（编译多语言版本）</span><br><span class="line">#注：若只编译简体中文版，需修改$HUE/desktop/core/src/desktop/settings.py文件中：LANGUAGE_CODE = &#x27;zh_CN&#x27;，并删除LANGUAGES中的其它语言项。</span><br><span class="line">make install  #（make install PREFIX=/usr/hdp/2.3.4.0-3485/hue HADOOP_HOME=/usr/hdp/current/hadoop-client）</span><br><span class="line">$HUE/build/env/bin/hue test all  #测试</span><br><span class="line">ln -s /usr/local/hue/desktop/libs/hadoop/java-lib/hue-plugins-3.9.0-SNAPSHOT.jar /opt/hadoop/hadoop-2.6.0/lib</span><br><span class="line">useradd hue</span><br><span class="line">chown -R hue:hue /usr/local/hue #必须新建hue用户，且hue存在home目录，并赋hue目录权限，否则启动报错</span><br></pre></td></tr></table></figure>
<h1 id="修改-x2F-usr-x2F-local-x2F-hue-x2F-desktop-x2F-conf-x2F-pseudo-distributed-ini配置"><a href="#修改-x2F-usr-x2F-local-x2F-hue-x2F-desktop-x2F-conf-x2F-pseudo-distributed-ini配置" class="headerlink" title="修改&#x2F;usr&#x2F;local&#x2F;hue&#x2F;desktop&#x2F;conf&#x2F;pseudo-distributed.ini配置"></a>修改&#x2F;usr&#x2F;local&#x2F;hue&#x2F;desktop&#x2F;conf&#x2F;pseudo-distributed.ini配置</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[desktop]</span><br><span class="line">secret_key=qwertyuiopasdfghjklzxcvbnm1234567890   #key随便写一串就行</span><br><span class="line">http_host=bigdata05.islocal.cc</span><br><span class="line">http_port=8888</span><br><span class="line">time_zone=Asia/Shanghai</span><br><span class="line">app_blacklist = search,indexer,security   #黑名单：如果不安装oozie的话，jobsub和oozie需同时加入黑名单才能禁用oozie,因为jobsub依赖oozie，否则启动会报错。</span><br></pre></td></tr></table></figure>
<h1 id="启动hue"><a href="#启动hue" class="headerlink" title="启动hue"></a>启动hue</h1><p>$HUE&#x2F;build&#x2F;env&#x2F;bin&#x2F;supervisor &amp;		#在生产环境中使用这个命令<br>$HUE&#x2F;build&#x2F;env&#x2F;bin&#x2F;hue runcpserver &amp;   #用于development模式<br>打开web页面：<a href="http://bigdata05.islocal.cc:8888/">http://bigdata05.islocal.cc:8888</a>  #第一次输入的用户名密码为超级管理员的用户密码。<br><strong>启动访问没有问题，即可将&#x2F;usr&#x2F;local&#x2F;hue打成tar包，使用ambari进行集成安装</strong></p>
<h1 id="Ambari-集成安装HUE"><a href="#Ambari-集成安装HUE" class="headerlink" title="Ambari 集成安装HUE"></a>Ambari 集成安装HUE</h1><h2 id="制作hue-tar包"><a href="#制作hue-tar包" class="headerlink" title="制作hue tar包"></a>制作hue tar包</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tar cvzf hue-3.11.0.tgz 、/usr/local/hue/</span><br><span class="line">cp hue-3.11.0.tgz /var/www/html/hdp/HDP/centos7/2.6.5.0-292/hue/hue-3.11.0.tgz</span><br><span class="line"></span><br><span class="line">cat /etc/yum.repos.d/HDP.repo</span><br><span class="line">[HDP-2.6-repo-1]</span><br><span class="line">name=HDP-2.6-repo-1</span><br><span class="line">baseurl=http://192.168.6.157/hdp/HDP/centos7/2.6.5.0-292/</span><br><span class="line">path=/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line"></span><br><span class="line">vim /usr/lib/ambari-agent/lib/resource_management/core/sudo.py +142</span><br><span class="line">fp.write(content.encode(&quot;utf-8&quot;))</span><br></pre></td></tr></table></figure>
<h2 id="版本说明"><a href="#版本说明" class="headerlink" title="版本说明"></a>版本说明</h2><p>Github中提供了两个版本的Ambari-Hue：v1.0.0和v2.0.0<br><strong>release-1.0.0</strong></p>
<ul>
<li>Ambari: 2.1.0~2.2.2</li>
<li>Hue: 3.9.0</li>
</ul>
<p><strong>release-2.0.0</strong></p>
<ul>
<li>Ambari: 2.4.0+</li>
<li>Hue: 3.10.0+</li>
</ul>
<h2 id="下载ambari-hue到Ambari组件服务目录"><a href="#下载ambari-hue到Ambari组件服务目录" class="headerlink" title="下载ambari-hue到Ambari组件服务目录"></a>下载ambari-hue到Ambari组件服务目录</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">VERSION=`hdp-select status hadoop-client | sed &#x27;s/hadoop-client - \([0-9]\.[0-9]\).*/\1/&#x27;`</span><br><span class="line">rm -rf /var/lib/ambari-server/resources/stacks/HDP/$VERSION/services/HUE  </span><br><span class="line"># 我们这里使用hue 3.11版本，手动下载v2.0.0</span><br><span class="line">wget https://github.com/EsharEditor/ambari-hue-service/archive/v2.0.0.tar.gz</span><br><span class="line">mkdir -p /var/lib/ambari-server/resources/stacks/HDP/$VERSION/services/HUE</span><br><span class="line">tar xf v2.0.0.tar.gz -C /var/lib/ambari-server/resources/stacks/HDP/$VERSION/services/HUE</span><br><span class="line">rm -fr /usr/hdp/current/hadoop-client/lib/hue-plugins-3.11.0-SNAPSHOT.jar</span><br></pre></td></tr></table></figure>
<h2 id="重启ambari-server"><a href="#重启ambari-server" class="headerlink" title="重启ambari-server"></a>重启ambari-server</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ambari-server restart</span><br></pre></td></tr></table></figure>
<h2 id="通过Ambari安装Hue"><a href="#通过Ambari安装Hue" class="headerlink" title="通过Ambari安装Hue"></a>通过Ambari安装Hue</h2><p><code>On bottom left -&gt; Actions -&gt; Add service -&gt; check Hue server -&gt; Next -&gt; Next -&gt; Change any config you like (e.g. install dir, port) -&gt; Next -&gt; Deploy</code>	<br>数据库使用默认的SqlLite即可，改成postgresql未安装成功！<br><img src="/images/2018/0726/01.png"><br><img src="/images/2018/0726/02.png"></p>
<h1 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h1><h2 id="Q1：编译报错信息：error-ffi-h-No-such-file-or-directory-HUE-3-10-0编译时报此错误"><a href="#Q1：编译报错信息：error-ffi-h-No-such-file-or-directory-HUE-3-10-0编译时报此错误" class="headerlink" title="Q1：编译报错信息：error: ffi.h: No such file or directory (HUE 3.10.0编译时报此错误)"></a>Q1：编译报错信息：error: ffi.h: No such file or directory (HUE 3.10.0编译时报此错误)</h2><p>A1：解决办法：yum -y install libssl-devel libffi-devel</p>
<h2 id="Q2：启动运行报错：UnicodeDecodeError-‘ascii’-codec-can’t-decode-byte-0xef-in-position-166-ordinal-not-in-range-128"><a href="#Q2：启动运行报错：UnicodeDecodeError-‘ascii’-codec-can’t-decode-byte-0xef-in-position-166-ordinal-not-in-range-128" class="headerlink" title="Q2：启动运行报错：UnicodeDecodeError: ‘ascii’ codec can’t decode byte 0xef in position 166: ordinal not in range(128)"></a>Q2：启动运行报错：UnicodeDecodeError: ‘ascii’ codec can’t decode byte 0xef in position 166: ordinal not in range(128)</h2><p>A2:<br>问题分析：编码问题,Python的str默认是ascii编码，和unicode编码冲突<br>解决办法：在出现问题的python文件或者页面添加如下3行信息：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import sys</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(&#x27;utf-8&#x27;)</span><br></pre></td></tr></table></figure>
<h2 id="Q3-Hue提交Oozie任务，任务一直处于运行状态，Log日志报错信息如下：org-apache-oozie-action-ActionExecutorException-JA009-Cannot-initialize-Cluster-Please-check-your-configuration-for-mapreduce-framework-name-and-the-correspond-server-addresses"><a href="#Q3-Hue提交Oozie任务，任务一直处于运行状态，Log日志报错信息如下：org-apache-oozie-action-ActionExecutorException-JA009-Cannot-initialize-Cluster-Please-check-your-configuration-for-mapreduce-framework-name-and-the-correspond-server-addresses" class="headerlink" title="Q3: Hue提交Oozie任务，任务一直处于运行状态，Log日志报错信息如下：org.apache.oozie.action.ActionExecutorException: JA009: Cannot initialize Cluster. Please check your configuration for mapreduce.framework.name and the correspond server addresses"></a>Q3: Hue提交Oozie任务，任务一直处于运行状态，Log日志报错信息如下：org.apache.oozie.action.ActionExecutorException: JA009: Cannot initialize Cluster. Please check your configuration for mapreduce.framework.name and the correspond server addresses</h2><p>A3: 解决办法：在HDFS是ha模式下，需要配置hue-hadoop中配置信息为：logical_name&#x3D; hdfs:&#x2F;&#x2F;nncluster</p>
<h2 id="Q4-NoteBook中提交spark-shell任务："><a href="#Q4-NoteBook中提交spark-shell任务：" class="headerlink" title="Q4: NoteBook中提交spark shell任务："></a>Q4: NoteBook中提交spark shell任务：</h2><p>报错：The Spark session could not be created in the cluster: at org.apache.hadoop.hdfs.protocolPB.ClientNamenodeProtocolTranslatorPB.mkdirs(ClientNamenodeProtocolTranslatorPB.java:558) at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57) at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) at java.lang.reflect.Method.invoke(Method.java:606) at org.apache.hadoop.io.retry.RetryInvocationHandler.invokeMethod(RetryInvocationHandler.java:252) at org.apache.hadoop.io.retry.RetryInvocationHandler.invoke(RetryInvocationHandler.java:104) at com.sun.proxy.$Proxy28.mkdirs(Unknown Source) at org.apache.hadoop.hdfs.DFSClient.primitiveMkdir(DFSClient.java:3018) … 28 more<br>A4: 解决办法：在hadoop的core-site.xml文件中添加spark用户的授权信息：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;property&gt;</span><br><span class="line">  &lt;name&gt;hadoop.proxyuser.spark.groups&lt;/name&gt;</span><br><span class="line">  &lt;value&gt;*&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line">&lt;property&gt;</span><br><span class="line">  &lt;name&gt;hadoop.proxyuser.spark.hosts&lt;/name&gt;</span><br><span class="line">  &lt;value&gt;*&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br></pre></td></tr></table></figure>
<h2 id="Q5-Hue中确认配置好hive以及在hive中添加了相关配置后，发现依旧无法连接Hiveserver2-无Kerberos认证"><a href="#Q5-Hue中确认配置好hive以及在hive中添加了相关配置后，发现依旧无法连接Hiveserver2-无Kerberos认证" class="headerlink" title="Q5: Hue中确认配置好hive以及在hive中添加了相关配置后，发现依旧无法连接Hiveserver2,无Kerberos认证"></a>Q5: Hue中确认配置好hive以及在hive中添加了相关配置后，发现依旧无法连接Hiveserver2,无Kerberos认证</h2><p>Hue中的报错信息：  Could not start SASL: Error in sasl_client_start (-4) SASL(-4): no mechanism available: No worthy mechs foundHiveserver2日志中的报错信息：  ERROR [HiveServer2-Handler-Pool: Thread-31]: server.TThreadPoolServer (TThreadPoolServer.java:run(296)) - Error occurred during processing of message.  java.lang.RuntimeException: org.apache.thrift.transport.TSaslTransportException: No data or no sasl data in the stream<br>A5: 问题分析：Hue连接Hiveserver2使用的是Python，在Centos操作系统上丢失了一些依赖：cyrus-sasl-plain cyrus-sasl-devel cyrus-sasl-gssapi<br>解决办法：yum -y install cyrus-sasl-plain cyrus-sasl-devel cyrus-sasl-gssapi<br>设置以下配置像为NOSASL或None</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;property&gt;</span><br><span class="line">  &lt;name&gt;hive.server2.authentication&lt;/name&gt;</span><br><span class="line">  &lt;value&gt;NOSASL&lt;/value&gt;</span><br><span class="line">  &lt;!--或者设置为</span><br><span class="line">    &lt;value&gt;None&lt;/value&gt;</span><br><span class="line">  --&gt;</span><br><span class="line">&lt;/property&gt;</span><br></pre></td></tr></table></figure>
<h2 id="Q6-报错信息：django-core-exceptions-ImproperlyConfigured-psycopg2-version-2-5-4-or-newer-is-required-you-have-2-5-1-dt-dec-pq3-ext"><a href="#Q6-报错信息：django-core-exceptions-ImproperlyConfigured-psycopg2-version-2-5-4-or-newer-is-required-you-have-2-5-1-dt-dec-pq3-ext" class="headerlink" title="Q6 报错信息：django.core.exceptions.ImproperlyConfigured: psycopg2_version 2.5.4 or newer is required; you have 2.5.1 (dt dec pq3 ext)"></a>Q6 报错信息：django.core.exceptions.ImproperlyConfigured: psycopg2_version 2.5.4 or newer is required; you have 2.5.1 (dt dec pq3 ext)</h2><p>A6: 解决方法</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pip install --upgrade pip</span><br><span class="line">pip upgrade psycopg2</span><br><span class="line">pip install psycopg2-binary</span><br></pre></td></tr></table></figure>
<h2 id="Q7报错信息：RuntimeError-Model-class-beeswax-models-QueryHistory-doesn’t-declare-an-explicit-app-label-and-isn’t-in-an-application-in-INSTALLED-APPS"><a href="#Q7报错信息：RuntimeError-Model-class-beeswax-models-QueryHistory-doesn’t-declare-an-explicit-app-label-and-isn’t-in-an-application-in-INSTALLED-APPS" class="headerlink" title="Q7报错信息：RuntimeError: Model class beeswax.models.QueryHistory doesn’t declare an explicit app_label and isn’t in an application in INSTALLED_APPS."></a>Q7报错信息：RuntimeError: Model class beeswax.models.QueryHistory doesn’t declare an explicit app_label and isn’t in an application in INSTALLED_APPS.</h2><p>A7:  解决方法，修改配置文件&#x2F;usr&#x2F;local&#x2F;hue&#x2F;desktop&#x2F;core&#x2F;src&#x2F;desktop&#x2F;settings.py</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">    &#x27;beeswax&#x27;,</span><br><span class="line">    &#x27;oozie&#x27;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h2 id="Q8-web也没访问报错信息：Invalid-HTTP-HOST-header-’bigdata05-islocal-cc-8888’-You-may-need-to-add-u’bigdata05-islocal-cc’-to-ALLOWED-HOSTS"><a href="#Q8-web也没访问报错信息：Invalid-HTTP-HOST-header-’bigdata05-islocal-cc-8888’-You-may-need-to-add-u’bigdata05-islocal-cc’-to-ALLOWED-HOSTS" class="headerlink" title="Q8 web也没访问报错信息：Invalid HTTP_HOST header:’bigdata05.islocal.cc:8888’.You may need to add u’bigdata05.islocal.cc’ to ALLOWED_HOSTS."></a>Q8 web也没访问报错信息：Invalid HTTP_HOST header:’bigdata05.islocal.cc:8888’.You may need to add u’bigdata05.islocal.cc’ to ALLOWED_HOSTS.</h2><p>A8： 解决方法，修改配置文件&#x2F;usr&#x2F;local&#x2F;hue&#x2F;desktop&#x2F;core&#x2F;src&#x2F;desktop&#x2F;settings.py</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ALLOWED_HOSTS = [&#x27;*&#x27;]</span><br></pre></td></tr></table></figure>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p><a href="https://eshareditor.github.io/2016/09/14/Hue-%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/">https://eshareditor.github.io/2016/09/14/Hue-编译安装/</a><br><a href="https://eshareditor.github.io/2016/10/11/Ambari-Hue-Service/">https://eshareditor.github.io/2016/10/11/Ambari-Hue-Service/</a><br>SDK文档：<a href="http://cloudera.github.io/hue/docs-3.7.0/sdk/sdk.html#introduction-and-overview">http://cloudera.github.io/hue/docs-3.7.0/sdk/sdk.html#introduction-and-overview</a><br>Hue配置信息说明(中文):2018&#x2F;7&#x2F;26 <a href="http://www.cloudera.com/content/www/zh-CN/documentation/enterprise/5-3-x/topics/cdh_ig_hue_config.html">http://www.cloudera.com/content/www/zh-CN/documentation/enterprise/5-3-x/topics/cdh_ig_hue_config.html</a><br>(英文)<a href="http://archive.cloudera.com/cdh5/cdh/5/hue/user-guide/index.html">http://archive.cloudera.com/cdh5/cdh/5/hue/user-guide/index.html</a></p>
]]></content>
      <categories>
        <category>大数据</category>
      </categories>
      <tags>
        <tag>Ambari</tag>
        <tag>HDP</tag>
      </tags>
  </entry>
  <entry>
    <title>Bginfo--Windows系统信息显示工具</title>
    <url>/arlo/ea6f862b/</url>
    <content><![CDATA[<p>经常维护多台Windows服务器，在服务器之间来回切换，经常容易搞混，为大家推荐一个维护利器BGinfo。</p>
<span id="more"></span>
<h1 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h1><p>下载地址：<a href="https://download.sysinternals.com/files/BGInfo.zip">https://download.sysinternals.com/files/BGInfo.zip</a>	<br>下载、解压完成后，双击Bginfo64,同意即可价值默认信息；这里是我觉得平时会用到的参数信息。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">主机名称:	&lt;Host Name&gt;</span><br><span class="line">系统版本:	&lt;OS Version&gt;</span><br><span class="line">服务补丁包:	&lt;Service Pack&gt;</span><br><span class="line">系统启动时间:	&lt;Boot Time&gt;</span><br><span class="line">当前用户名:	&lt;User Name&gt;</span><br><span class="line">------------------------------</span><br><span class="line">CPU:	&lt;CPU&gt;</span><br><span class="line">内存:	&lt;Memory&gt;</span><br><span class="line">磁盘可用空间:	&lt;Free Space&gt;</span><br><span class="line">------------------------------</span><br><span class="line">IP Address:	&lt;IP Address&gt;</span><br><span class="line">MAC Address:	&lt;MAC Address&gt;</span><br><span class="line">Subnet Mask:	&lt;Subnet Mask&gt;</span><br><span class="line">Default Gateway:	&lt;Default Gateway&gt;</span><br><span class="line">DNS Server:	&lt;DNS Server&gt;</span><br></pre></td></tr></table></figure>
<p>点击file-save as 保存D:\BGInfo为名为systeminfo.cgi<br><img src="/images/2018/0122/01.png" alt="bginfo"><br>Background：可以定义直接在当前壁纸上显示、指定一个壁纸路径或纯色显示。<br>Position：可配置信息输出位置（9个选项）以及多显示器输出支持*(偏爱右上)*<br>Desktops：用于配置用户远程登录、控制台登录时的显示方式<br>Preview：预览配置效果<br><img src="/images/2018/0122/02.png" alt="bginfo"></p>
<h1 id="配置开机启动"><a href="#配置开机启动" class="headerlink" title="配置开机启动"></a>配置开机启动</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. </span><br><span class="line">在windows资源管理器输入shell:startup 快速打开当前用户的「启动」文件夹</span><br><span class="line">2. </span><br><span class="line">新建一个.bat文件，内容为D:\BGInfo\Bginfo64.exe systeminfo.bgi /timer:0 /nolicprompt /silent</span><br></pre></td></tr></table></figure>
<p>PS:</p>
<ol>
<li>此工具很方便，但是不能根据系统信息，自行刷新，可以添加计划任务进行刷新。</li>
<li>此工具大规模部署建议使用域环境操作。</li>
</ol>
<p>参考链接：<br><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/bginfo">https://docs.microsoft.com/en-us/sysinternals/downloads/bginfo</a><br><a href="https://www.sysgeek.cn/bginfo/">https://www.sysgeek.cn/bginfo/</a></p>
]]></content>
      <categories>
        <category>常识</category>
      </categories>
      <tags>
        <tag>windows</tag>
        <tag>bginfo</tag>
      </tags>
  </entry>
  <entry>
    <title>Centos6环境下搭建及破解confluence</title>
    <url>/arlo/58cb2af9/</url>
    <content><![CDATA[<blockquote>
<p>Confluence是一个专业的企业知识管理与协同软件，也可以用于构建企业wiki。使用简单，但它强大的编辑和站点管理特征能够帮助团队成员之间共享信息、文档协作、集体讨论，信息推送。【来自百度百科】</p>
</blockquote>
<span id="more"></span>
<p>我们只是需要一个知识库……<br>公司没有专门的知识库，企业wiki，团队的人资料文档都放在自己手里，你懂的？工作的文档一直都是svn提交，查看起来很不方便；长时间下来，没有技术共享、交流，积累；多方询问，别人推荐使用confluence，先搭建起来用用看。</p>
<h1 id="系统环境"><a href="#系统环境" class="headerlink" title="系统环境"></a>系统环境</h1><p>Centos 6.9<br>Jdk 1.8.112<br>Mysql 5.7.20<br>Atlassian-confluence-6.3.1</p>
<h1 id="安装jdk"><a href="#安装jdk" class="headerlink" title="安装jdk"></a>安装jdk</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tar xf jdk-8u112-linux-x64.tar.gz -C /usr/local/</span><br><span class="line">-- 配置环境变量</span><br><span class="line">vim /etc/profile</span><br><span class="line">export JAVA_HOME=/usr/local/jdk1.8.0_112/</span><br><span class="line">export CLASSPATH=.:$JAVA_HOME/lib/:$JAVA_HOME/jre/lib/</span><br><span class="line">export PATH=$JAVA_HOME/bin:$PATH</span><br><span class="line">-- 使环境变量生效</span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>
<h1 id="安装mysql"><a href="#安装mysql" class="headerlink" title="安装mysql"></a>安装mysql</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wget https://mirrors.huaweicloud.com/repository/toolkit/mysql/Downloads/MySQL-5.7/mysql-5.7.20-1.el6.x86_64.rpm-bundle.tar</span><br><span class="line">tar xf mysql-5.7.20-1.el6.x86_64.rpm-bundle.tar </span><br><span class="line">yum localinstall mysql-community-common-5.7.20-1.el6.x86_64.rpm mysql-community-client-5.7.20-1.el6.x86_64.rpm mysql-community-server-5.7.20-1.el6.x86_64.rpm mysql-community-libs-compat-5.7.20-1.el6.x86_64.rpm mysql-community-libs-5.7.20-1.el6.x86_64.rpm mysql-community-devel-5.7.20-1.el6.x86_64.rpm</span><br><span class="line">-- 修改mysql参数</span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">max_allowed_packet = 256M</span><br><span class="line">innodb_log_file_size=512M</span><br><span class="line">--启动mysqld服务</span><br><span class="line">/etc/init.d/mysqld start</span><br><span class="line">--查看初始密码</span><br><span class="line">grep &#x27;temporary password&#x27; /var/log/mysqld.log </span><br><span class="line">2018-04-03T02:44:31.357861Z 1 [Note] A temporary password is generated for root@localhost: OUGiG=n-l8lY</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@3g3MplC6 ~]# mysql -uroot -pOUGiG=n-l8lY</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 12</span><br><span class="line">Server version: 5.7.20</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &#x27;help;&#x27; or &#x27;\h&#x27; for help. Type &#x27;\c&#x27; to clear the current input statement.</span><br><span class="line">--mysql5.7密码策略比较高，设置一下复杂度和长度</span><br><span class="line">mysql&gt; set global validate_password_policy=0;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; set global validate_password_length=1;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">--修改一下root用户的密码为&#x27;ffffff&#x27;(生产环境不建议这么操作)</span><br><span class="line">mysql&gt; alter user root@localhost identified by &#x27;ffffff&#x27;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">--创建一个mysql数据库confluence，创建用户confluence，密码为confluencepwd</span><br><span class="line">mysql -uroot -p&#x27;ffffff&#x27; -e &quot;create database confluence default character set utf8 collate utf8_bin;grant  all on confluence.* to &#x27;confluence&#x27;@&#x27;%&#x27; identified by &#x27;confluencepwd&#x27;;&quot;</span><br></pre></td></tr></table></figure>
<h1 id="安装confluence"><a href="#安装confluence" class="headerlink" title="安装confluence"></a>安装confluence</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wget https://www.atlassian.com/software/confluence/downloads/binary/atlassian-confluence-6.3.1-x64.bin</span><br><span class="line">数据库驱动包和破解补丁包: 链接: https://pan.baidu.com/s/1YfwGC2NDBVs3udsVb-i6fA 密码: ix7u</span><br><span class="line">chmod +x atlassian-confluence-6.3.1-x64.bin</span><br><span class="line">./atlassian-confluence-6.3.1-x64.bin</span><br><span class="line">/etc/init.d/confluence stop</span><br><span class="line">上传以下两个包到此目录下/opt/atlassian/confluence/confluence/WEB-INF/lib</span><br><span class="line">atlassian-extras-3.2.jar</span><br><span class="line">mysql-connector-java-5.1.42-bin.jar</span><br><span class="line">/etc/init.d/confluence start</span><br></pre></td></tr></table></figure>
<p>可以看到安装目录为<br>Installation Directory: &#x2F;opt&#x2F;atlassian&#x2F;confluence<br>Home Directory: &#x2F;var&#x2F;atlassian&#x2F;application-data&#x2F;confluence<br>默认端口为8090<br><img src="/images/2018/0403/01.png" alt="confluence"></p>
<h1 id="配置confluence"><a href="#配置confluence" class="headerlink" title="配置confluence"></a>配置confluence</h1><p><a href="http://192.168.6.186:8090/">http://192.168.6.186:8090</a></p>
<h2 id="设置为中文语言"><a href="#设置为中文语言" class="headerlink" title="设置为中文语言"></a>设置为中文语言</h2><p><img src="/images/2018/0403/02.png" alt="confluence"></p>
<h2 id="产品安装"><a href="#产品安装" class="headerlink" title="产品安装"></a>产品安装</h2><p><img src="/images/2018/0403/03.png" alt="confluence"></p>
<h2 id="直接下一步"><a href="#直接下一步" class="headerlink" title="直接下一步"></a>直接下一步</h2><p><img src="/images/2018/0403/04.png" alt="confluence"></p>
<h2 id="复制服务器ID，点击获得授权码"><a href="#复制服务器ID，点击获得授权码" class="headerlink" title="复制服务器ID，点击获得授权码"></a>复制服务器ID，点击获得授权码</h2><p><img src="/images/2018/0403/05.png" alt="confluence"></p>
<h2 id="参考图片设置"><a href="#参考图片设置" class="headerlink" title="参考图片设置"></a>参考图片设置</h2><p><img src="/images/2018/0403/06.png" alt="confluence"><br><img src="/images/2018/0403/07.png" alt="confluence"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">服务器ID：</span><br><span class="line">BZ0A-OLZE-ZYYB-3PFX</span><br><span class="line">授权码：</span><br><span class="line">AAABLA0ODAoPeNptkF9rwjAUxd/zKQJ72PYQSaOiCIFp24FQragbU/aShesWqLHepKLffqmdzP15C</span><br><span class="line">ISce8753dwsK6DDEilvU84HXT4QEY2TJRU86pMEnEZTerOzMt7ZTVGB1UDvFoAHwPvXAU0PqqhUP</span><br><span class="line">UBihPMlUR5kbWe8w3ibBKNX2k/VFmTE+/2e6ImH/b6ld1uiQ2griOYA0mMFzcPCK/SAcqMKBxd/O</span><br><span class="line">lGm+BPw3X/lz4wG62B5KuHcGueTSTqPx8OMFI30DOhqjyAh1XqwKuyVHkuDpyv8bo2f47uyxjUdR</span><br><span class="line">3OrLGnWHydytOZDlmfrlK1XqxFrzx5fyCKdynBYFkWdnhC8S75wwnw2Tn5KZ9xptX0DzDdPLlBJF</span><br><span class="line">l0M//PMKtQfysHvb/4EqFmR3DAtAhUAjJ5DzWcXkYufaw72NYIZs/rFeJgCFEocDK77ZwHKpPhhI</span><br><span class="line">vo1bD3HDmJIX02f3</span><br></pre></td></tr></table></figure>
<p><img src="/images/2018/0403/08.png" alt="confluence"></p>
<h2 id="选择MySQL"><a href="#选择MySQL" class="headerlink" title="选择MySQL"></a>选择MySQL</h2><p><img src="/images/2018/0403/09.png" alt="confluence"></p>
<h2 id="选择JDBC"><a href="#选择JDBC" class="headerlink" title="选择JDBC"></a>选择JDBC</h2><p><img src="/images/2018/0403/10.png" alt="confluence"><br>根据下图显示，在数据库URL添加<code>?useSSL=false&amp;amp;useUnicode=true&amp;amp;characterEncoding=utf8</code><br><code>&amp;amp;是代替&amp;</code>，否则启动会报错，这里没有改的话，可以在&#x2F;var&#x2F;atlassian&#x2F;application-data&#x2F;confluence&#x2F;confluence.cfg.xml文件中修改<br><img src="/images/2018/0403/11.png" alt="confluence"></p>
<h2 id="选择空白站点"><a href="#选择空白站点" class="headerlink" title="选择空白站点"></a>选择空白站点</h2><p><img src="/images/2018/0403/12.png" alt="confluence"></p>
<h2 id="在Confluence中管理用户与组"><a href="#在Confluence中管理用户与组" class="headerlink" title="在Confluence中管理用户与组"></a>在Confluence中管理用户与组</h2><p><img src="/images/2018/0403/13.png" alt="confluence"></p>
<h2 id="配置系统管理员账户"><a href="#配置系统管理员账户" class="headerlink" title="配置系统管理员账户"></a>配置系统管理员账户</h2><p><img src="/images/2018/0403/14.png" alt="confluence"></p>
<h2 id="配置完成"><a href="#配置完成" class="headerlink" title="配置完成"></a>配置完成</h2><p><img src="/images/2018/0403/15.png" alt="confluence"></p>
<h1 id="破解confluence"><a href="#破解confluence" class="headerlink" title="破解confluence"></a>破解confluence</h1><p>替换<code>/opt/atlassian/confluence/confluence/WEB-INF/lib/atlassian-extras-decoder-v2-3.2.jar</code>包，进行破解</p>
<p>参考链接:<br><a href="https://blog.csdn.net/wh211212/article/details/76131569">https://blog.csdn.net/wh211212/article/details/76131569</a><br><a href="http://www.confluence.cn/">http://www.confluence.cn</a></p>
]]></content>
      <categories>
        <category>服务器搭建</category>
      </categories>
      <tags>
        <tag>confluence</tag>
      </tags>
  </entry>
  <entry>
    <title>Centos7关闭IPv6</title>
    <url>/arlo/244042e3/</url>
    <content><![CDATA[<h1 id="验证ipv6是否关闭"><a href="#验证ipv6是否关闭" class="headerlink" title="验证ipv6是否关闭"></a>验证ipv6是否关闭</h1><p>cat &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv6&#x2F;conf&#x2F;all&#x2F;disable_ipv6<br>0：开启状态<br>1：关闭状态</p>
<span id="more"></span>
<h1 id="方法一：-开机不加载IPv6模块"><a href="#方法一：-开机不加载IPv6模块" class="headerlink" title="方法一： 开机不加载IPv6模块"></a>方法一： 开机不加载IPv6模块</h1><h2 id="修改grub文件"><a href="#修改grub文件" class="headerlink" title="修改grub文件"></a>修改grub文件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vi /etc/default/grub </span><br><span class="line">GRUB_CMDLINE_LINUX=&quot;ipv6.disable=1 crashkernel=auto rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">grub2-mkconfig -o /boot/grub2/grub.cfg</span><br></pre></td></tr></table></figure>
<h2 id="重启服务器，查看模块"><a href="#重启服务器，查看模块" class="headerlink" title="重启服务器，查看模块"></a>重启服务器，查看模块</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">reboot</span><br><span class="line">lsmod |grep ipv6</span><br></pre></td></tr></table></figure>
<h1 id="方法二：命令行修改（推荐）"><a href="#方法二：命令行修改（推荐）" class="headerlink" title="方法二：命令行修改（推荐）"></a>方法二：命令行修改（推荐）</h1><h2 id="修改内核参数"><a href="#修改内核参数" class="headerlink" title="修改内核参数"></a>修改内核参数</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vi /etc/sysctl.conf</span><br><span class="line">net.ipv6.conf.all.disable_ipv6=1</span><br></pre></td></tr></table></figure>
<h2 id="修改网络配置文件"><a href="#修改网络配置文件" class="headerlink" title="修改网络配置文件"></a>修改网络配置文件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vi /etc/sysconfig/network</span><br><span class="line">NETWORKING_IPV6=no</span><br></pre></td></tr></table></figure>
<h2 id="修改网卡配置文件"><a href="#修改网卡配置文件" class="headerlink" title="修改网卡配置文件"></a>修改网卡配置文件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vi /etc/sysconfig/network-scripts/ifcfg-XX</span><br><span class="line">IPV6INIT=no</span><br></pre></td></tr></table></figure>
<h2 id="加载内核参数，使其生效"><a href="#加载内核参数，使其生效" class="headerlink" title="加载内核参数，使其生效"></a>加载内核参数，使其生效</h2><p><code>sysctl -p</code></p>
]]></content>
      <categories>
        <category>常识</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>N2N内网穿透(打洞)软件使用</title>
    <url>/arlo/1d2bb16a/</url>
    <content><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>首先说一下这个<a href="https://github.com/ntop/n2n">N2N</a>软件的背景，这个是培训oracle的时候，安装rac需要多块网卡，云服务器不像本地服务器或者虚拟机那边方便，可以随便随便添加网口，使用到N2N这款软件模拟出多块网卡；<br>其实N2N软件的主要功能是内网穿透，就是将服务器的网段可以和本地环境打穿到一个网段里；这个软件如果用在服务器上还是挺可怕的，类似windows下的teamviewer，类似linux下的ssh隧道模式;只要服务器可以上外网(严格说是连接到supermode)，就可以打通，慎用！</p>
<span id="more"></span>

<h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>N2N 是一款开源的P2P VPN 软件，其作者是著名的开源网管软件ntop的作者Luca Deri。<br>N2N 是一个双层架构的VPN ，它让用户可以在网络层上开发P2P应用的典型功能，而不是在应用层上开发。这意味着用户可以获取本地IP一样的可见度（比如说，同一个n2n网络内的两台PC机可以相互ping通），并且可以通过n2n虚拟网内的IP地址相互访问，而不必关心当前所属的物理网络地址。可以这样说，OpenVPN是把SSL从应用层转移到网络层实现（比如说实现https协议），而n2n则是把P2P的实现从应用层转移到网络层。</p>
<h1 id="N2N-设计的主要功能"><a href="#N2N-设计的主要功能" class="headerlink" title="N2N 设计的主要功能"></a>N2N 设计的主要功能</h1><ul>
<li>N2N 是基于P2P 协议之上的两个私有网络间的加密层</li>
<li>加密是在edge 节点上执行的，使用开放的协议，用户自己定义密钥：你自己控制自己的安全，不需要委托给第三方公司</li>
<li>每个n2n 用户可以同时隶属于多个网络</li>
<li>有NAT和穿越防火墙的功能，即使n2n节点位于私网中，也能够访问，防火墙不再是在 IP 层的直接沟通和交流的障碍</li>
<li>N2N 网络不是独立的，它是能够跨越N2N 和非N2N网络路由的</li>
</ul>
<h1 id="N2N-架构组件"><a href="#N2N-架构组件" class="headerlink" title="N2N 架构组件"></a>N2N 架构组件</h1><ul>
<li>Edge 节点：用户PC 机上安装的用于建立n2n网络的软件。几乎每个edge节点都会建立一个tun&#x2F;tap设备，作为接入n2n网络的入口。</li>
<li>Supernode 超级节点：它在edge 节点间建立握手，或为位于防火墙之后的节点中转数据。它的基础作用是注册节点的网络路径，并为不能直通的节点做路由，能够直通的节点间通信，是P2P的。<br>Edge 节点间通过虚拟的tap 网卡交互。每个tap网卡都是一个n2n edge节点。每台PC机可以有多个tap网卡，所以，在n2n网络中，同一台PC机可以属于多个网络。</li>
</ul>
<h1 id="搭建N2N环境"><a href="#搭建N2N环境" class="headerlink" title="搭建N2N环境"></a>搭建N2N环境</h1><p>首先我们需要一个公网IP地址，一个可以访问的公网端口(UDP), 我这里刚好有一个华为云的服务器可以用<br>IP: 114.116.xx.xx<br>Port: 6666</p>
<h2 id="安装软件"><a href="#安装软件" class="headerlink" title="安装软件"></a>安装软件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum install -y subversion gcc-c++ openssl-devel git cmake</span><br><span class="line">cd /usr/src</span><br><span class="line">svn co https://svn.ntop.org/svn/ntop/trunk/n2n</span><br><span class="line">cd n2n/n2n_v2</span><br><span class="line">make</span><br><span class="line">make PREFIX=/opt/n2n install</span><br><span class="line">cp supernode /usr/sbin/</span><br><span class="line">cp edge /usr/sbin/</span><br></pre></td></tr></table></figure>
<h2 id="搭建中心服务器-supermode节点"><a href="#搭建中心服务器-supermode节点" class="headerlink" title="搭建中心服务器(supermode节点)"></a>搭建中心服务器(supermode节点)</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#创建一个端口为6666的supermode服务，用于建立握手</span><br><span class="line">/usr/sbin/supernode -l 6666</span><br><span class="line">#查看6666端口是否存在，可以看到是udp端口</span><br><span class="line">ss -tnulp |grep 6666</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#新建一个虚拟设备edge0，用于测试</span><br><span class="line">edge -d edge0 -a 10.10.10.101 -s 255.255.255.0 -c fff -k fff -l 114.116.xxx.xxx:6666 -E -r</span><br></pre></td></tr></table></figure>
<p><img src="/images/2018/1205/01.png" alt="n2n"></p>
<h2 id="创建客户端-egdg节点"><a href="#创建客户端-egdg节点" class="headerlink" title="创建客户端(egdg节点)"></a>创建客户端(egdg节点)</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#新建一个虚拟设备edge0，用于测试</span><br><span class="line">edge -d edge0 -a 10.10.10.102 -s 255.255.255.0 -c fff -k fff -l 114.116.xxx.xxx:6666 -E -r</span><br></pre></td></tr></table></figure>
<p>参数：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-d  &lt;接口名&gt; 选项指定了由 edge 命令创建的 TAP 接口的名字; 创建一个虚拟的网卡设备，edge0 就是它的名称</span><br><span class="line">-a &lt;IP 地址&gt; 选项（静态地）指定了分配给 TAP 接口的 VPN 的 IP 地址。如果你想要使用 DHCP，你需要在其中一台边缘节点上配置一台 DHCP 服务器，然后使用“-a dhcp:0.0.0.0”选项来代替。</span><br><span class="line">-s &lt;子网掩码&gt;</span><br><span class="line">-c &lt;组名&gt; 选项指定了 VPN 组的名字（最大长度为 16 个字节）。这个选项可以被用来在同样一组节点中创建多个 VPN。</span><br><span class="line">-k &lt;密钥&gt; 选项指定了一个由 twofish 加密的密钥来使用。如果你想要将密钥从命令行中隐藏，你可以使用 N2N_KEY 环境变量。</span><br><span class="line">-u 和 -g选项被用来在创建一个 TAP 接口后降权放弃 root 权限。edge 守护进程将会作为指定的用户/组 ID 运行。</span><br><span class="line">-l &lt;IP 地址:端口&gt; 选项指定了超级节点的监听 IP 地址和端口号。为了冗余，你可以指定最多两个不同的超级节点（比如 -l &lt;超级节点 A&gt; -l &lt;超级节点 B&gt;）。</span><br><span class="line">-m 给 TAP 接口分配了一个静态的 MAC 地址。不使用这个参数的话，edge 命令将会随机生成一个 MAC地址。事实上，为一个 VPN 接口强制指定一个静态的 MAC 地址是被强烈推荐的做法。否则，比如当你在一个节点上重启了 edge 守护程序的时候，其它节点的 ARP 缓存将会由于新生成的 MAC 地址而遭到污染，它们将不能向这个节点发送数据，直到被污染的 ARP 记录被消除。</span><br><span class="line">在使用过程中不免遇到一些奇葩的事，调试是个关键，开启调试模式，可以使用参数“-v -f”。记住先kill 掉之前的 edge 或 supernode 进程再进行调试以免冲突。</span><br></pre></td></tr></table></figure>

<p><font color="#FF0000"><em>PS:如果想让新建的虚拟网卡开机后依然生效，需要将以上创建命令写入到&#x2F;etc&#x2F;rc.local 文件中，另外centos7操作系统需要chmod +x &#x2F;etc&#x2F;rc.d&#x2F;rc.local</em></font></p>
<hr>
]]></content>
      <categories>
        <category>服务器搭建</category>
      </categories>
      <tags>
        <tag>vpn</tag>
        <tag>n2n</tag>
      </tags>
  </entry>
  <entry>
    <title>IDM+油猴脚本实现百度云不限速下载</title>
    <url>/arlo/94c43a11/</url>
    <content><![CDATA[<p>上周从JimV(<a href="http://template.iit.im/">http://template.iit.im/</a>) 上下载了一个系统镜像模板用了两天，为解决这一问题，我使用了IDM下载工具和油猴脚本（chrome插件），测试了一下，速度基本上可以保持在300k左右，这里简单记录一下实现方法。</p>
<span id="more"></span>
<h1 id="安装IDM下载工具"><a href="#安装IDM下载工具" class="headerlink" title="安装IDM下载工具"></a>安装IDM下载工具</h1><p>官网：<a href="https://www.internetdownloadmanager.com/">https://www.internetdownloadmanager.com/</a><br>也可以自己在网上找破解版，安装完成后会监测本机上的浏览器，根据提示安装浏览器插件。</p>
<h1 id="安装油猴脚本"><a href="#安装油猴脚本" class="headerlink" title="安装油猴脚本"></a>安装油猴脚本</h1><p>在chrome应用市场搜索“Tampermonkey”，安装油猴脚本管理器<br><img src="/images/2018/1126/01.png" alt="idm"><br><img src="/images/2018/1126/02.png" alt="idm"><br><img src="/images/2018/1126/03.png" alt="idm"><br>添加“EX-百度云盘”脚本<br><img src="/images/2018/1126/05.png" alt="idm"><br>打开百度云盘，刷新页面，可以看到多了一个“EX-下载”的按钮<br><img src="/images/2018/1126/06.png" alt="idm"></p>
<h1 id="分享百度云文件链接，实现下载"><a href="#分享百度云文件链接，实现下载" class="headerlink" title="分享百度云文件链接，实现下载"></a>分享百度云文件链接，实现下载</h1><ul>
<li>必须把要下载的文件分享出去，在隐身窗口或者退出登录后，打开分享链接，再使用脚本，方才有效！</li>
<li>现在账户已登录的情况下使用脚本没有效果！！！</li>
</ul>
<p><img src="/images/2018/1126/07.png" alt="idm"><br><img src="/images/2018/1126/08.png" alt="idm"></p>
]]></content>
  </entry>
  <entry>
    <title>SSH隧道实现Yum等代理</title>
    <url>/arlo/f49b27ae/</url>
    <content><![CDATA[<p><strong>背景</strong><br>Linux服务器环境中有部分服务器不能上网，使用yum安装软件极为不便；<br><strong>解决方案</strong><br>可以搭建一个本地代理服务器，在不能联通外网的服务器上将1080端口跳转到另外一台可以上外网的22端口上，实现ssh跳转，设置yum代理，实现软件安装<br><strong>注意事项</strong></p>
<ul>
<li>需要一台可以连接公网的服务器A（192.168.6.123）</li>
<li>需要安装软件的服务器B（192.168.6.141）可以连接上A（192.168.6.123）</li>
<li>服务器B（192.168.6.141）上需要安装privoxy 和git 基础软件</li>
<li>所有操作在服务器B（192.168.6.141）上完成</li>
<li>在centos 6 上，yum只能使用 http, https, ftp 协议的代理。 但在 centos 7上 yum 可以使用 socks5 的代理。</li>
</ul>
<span id="more"></span>
<h1 id="建立SSH隧道"><a href="#建立SSH隧道" class="headerlink" title="建立SSH隧道"></a>建立SSH隧道</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ssh -p 22 -gfND 1080 root@192.168.6.123</span><br><span class="line">ss -tlnup |grep 1080</span><br></pre></td></tr></table></figure>
<h1 id="安装配置privoxy"><a href="#安装配置privoxy" class="headerlink" title="安装配置privoxy"></a>安装配置privoxy</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum -y install privoxy</span><br><span class="line">vim /etc/privoxy/config</span><br><span class="line">forward-socks5 / 127.0.0.1:1080 .</span><br><span class="line">#如果允许其他机器访问，需要修改listen-address</span><br><span class="line">listen-address  0.0.0.0:8118</span><br></pre></td></tr></table></figure>
<p>启动privoxy服务</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl start privoxy</span><br><span class="line">systemctl enable privoxy</span><br></pre></td></tr></table></figure>
<h1 id="为YUM配置代理"><a href="#为YUM配置代理" class="headerlink" title="为YUM配置代理"></a>为YUM配置代理</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#centos7配置方法</span><br><span class="line">[main]</span><br><span class="line">proxy=socks5h://localhost:1080</span><br><span class="line">#centos6配置方法</span><br><span class="line">[main]</span><br><span class="line">proxy=http://localhost:8118</span><br></pre></td></tr></table></figure>
<h1 id="扩展、配置其他代理"><a href="#扩展、配置其他代理" class="headerlink" title="扩展、配置其他代理"></a>扩展、配置其他代理</h1><h2 id="为CURL配置代理"><a href="#为CURL配置代理" class="headerlink" title="为CURL配置代理"></a>为CURL配置代理</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim ~/.curlc</span><br><span class="line"># socks5h 中的 h 意为远程主机名解析</span><br><span class="line">socks5 = &quot;socks5h://127.0.0.1:1080&quot;</span><br></pre></td></tr></table></figure>
<h2 id="为wget配置代理"><a href="#为wget配置代理" class="headerlink" title="为wget配置代理"></a>为wget配置代理</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/wgetrc</span><br><span class="line">http_proxy = http://localhost:8118</span><br><span class="line">https_proxy = http://localhost:8118</span><br><span class="line">ftp_proxy = http://localhost:8118</span><br><span class="line">use_proxy = on</span><br><span class="line">wait = 15</span><br></pre></td></tr></table></figure>
<h2 id="为pip配置代理"><a href="#为pip配置代理" class="headerlink" title="为pip配置代理"></a>为pip配置代理</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir ~/.pip</span><br><span class="line">vim ~/.pip/pip.conf</span><br><span class="line">[global]</span><br><span class="line">proxy = 127.0.0.1:8118</span><br><span class="line">trusted-host = mirrors.aliyun.com</span><br></pre></td></tr></table></figure>
<h2 id="为git设置http-https-代理"><a href="#为git设置http-https-代理" class="headerlink" title="为git设置http https 代理"></a>为git设置http https 代理</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#设置</span><br><span class="line">git config --global https.proxy &#x27;socks5h://127.0.0.1:1080&#x27;</span><br><span class="line">git config --global http.proxy &#x27;socks5h://127.0.0.1:1080&#x27;</span><br><span class="line">#查看</span><br><span class="line">git config --global --get http.proxy</span><br><span class="line">git config --global --get https.proxy</span><br><span class="line">#取消</span><br><span class="line">git config --global --unset http.proxy</span><br><span class="line">git config --global --unset https.proxy</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>常识</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>SSH</tag>
      </tags>
  </entry>
  <entry>
    <title>Oracle 11g静默安装官方提供的examples</title>
    <url>/arlo/56125275/</url>
    <content><![CDATA[<p>之前安装oracle的时候，没有安装默认的示例，练习过程中，教程常用的hr等用户都没有，可以从官网下载示例来安装。</p>
<h1 id="下载官方example包"><a href="#下载官方example包" class="headerlink" title="下载官方example包"></a>下载官方example包</h1><p>登录<a href="http://www.oracle.com/">http://www.oracle.com</a> 到下载页浏览就可以找到名为 linux.x64_11gR2_examples.zip<br><code>unzip linux.x64_11gR2_examples.zip</code></p>
<span id="more"></span>
<h1 id="编辑rsp静默安装文件"><a href="#编辑rsp静默安装文件" class="headerlink" title="编辑rsp静默安装文件"></a>编辑rsp静默安装文件</h1><p><code>cp examples/response/demos_install.rsp .</code><br><code>egrep -v &quot;^$|^#&quot; /home/oracle/demos_install.rsp</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ORACLE_HOSTNAME=siluxa_oracle</span><br><span class="line">UNIX_GROUP_NAME=oinstall</span><br><span class="line">INVENTORY_LOCATION=/u01/app/oraInventory/</span><br><span class="line">SELECTED_LANGUAGES=en,zh_CN</span><br><span class="line">ORACLE_HOME=/u01/app/oracle/product/11.1.0/db_1</span><br><span class="line">ORACLE_BASE=/u01/app/oracle</span><br></pre></td></tr></table></figure>
<h1 id="静默安装example"><a href="#静默安装example" class="headerlink" title="静默安装example"></a>静默安装example</h1><p><code>./runInstaller -silent -responseFile /home/oracle/demos_install.rsp -ignorePrereq</code></p>
<h1 id="执行sql脚本文件，安装特定模式"><a href="#执行sql脚本文件，安装特定模式" class="headerlink" title="执行sql脚本文件，安装特定模式"></a>执行sql脚本文件，安装特定模式</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[oracle@siluxa_oracle human_resources]$ sqlplus sys/solution as sysdba</span><br><span class="line"></span><br><span class="line">SQL*Plus: Release 11.2.0.1.0 Production on Fri May 4 18:01:11 2018</span><br><span class="line"></span><br><span class="line">Copyright (c) 1982, 2009, Oracle.  All rights reserved.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Connected to:</span><br><span class="line">Oracle Database 11g Enterprise Edition Release 11.2.0.1.0 - 64bit Production</span><br><span class="line">With the Partitioning, OLAP, Data Mining and Real Application Testing options</span><br><span class="line"></span><br><span class="line">SYS@orcl&gt;  @?/demo/schema/human_resources/hr_main.sql</span><br><span class="line"></span><br><span class="line">specify password for HR as parameter 1:</span><br><span class="line">Enter value for 1: 123</span><br><span class="line"></span><br><span class="line">specify default tablespeace for HR as parameter 2:</span><br><span class="line">Enter value for 2: users</span><br><span class="line"></span><br><span class="line">specify temporary tablespace for HR as parameter 3:</span><br><span class="line">Enter value for 3: temp</span><br><span class="line"></span><br><span class="line">specify password for SYS as parameter 4:</span><br><span class="line">Enter value for 4: solution</span><br><span class="line"></span><br><span class="line">specify log path as parameter 5:</span><br><span class="line">Enter value for 5: $ORACLE_HOME/demo/schema/log/</span><br></pre></td></tr></table></figure>
<p><img src="/images/2018/0504/01.png" alt="z"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">HR@orcl&gt; select table_name from user_tables;</span><br><span class="line"></span><br><span class="line">TABLE_NAME</span><br><span class="line">------------------------------</span><br><span class="line">REGIONS</span><br><span class="line">LOCATIONS</span><br><span class="line">JOB_HISTORY</span><br><span class="line">JOBS</span><br><span class="line">EMPLOYEES</span><br><span class="line">DEPARTMENTS</span><br><span class="line">COUNTRIES</span><br><span class="line"></span><br><span class="line">7 rows selected.</span><br></pre></td></tr></table></figure>
<p>这样就算安装完成了，可以使用hr进行学习了。</p>
<p>参考地址：<a href="https://blog.csdn.net/smstong/article/details/45891187">https://blog.csdn.net/smstong/article/details/45891187</a></p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>Oracle</tag>
        <tag>数据库</tag>
      </tags>
  </entry>
  <entry>
    <title>Oracle 12c远程连接报ORA28040和ORA01017错误</title>
    <url>/arlo/cb23bc66/</url>
    <content><![CDATA[<p>ORA-28040: 没有匹配的验证协议<br>修改<code>$ORACLE_HOME\NETWORK\ADMIN\sqlnet.ora</code>文件，添加以下两行</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SQLNET.ALLOWED_LOGON_VERSION_SERVER=9</span><br><span class="line">SQLNET.ALLOWED_LOGON_VERSION_CLIENT=9</span><br></pre></td></tr></table></figure>
<p>ORA-01017的错误的解决方法：<br><code>sqlplus / as sysdba</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ALTER USER username IDENTIFIED BY password</span><br></pre></td></tr></table></figure>

<p>参考链接：<br><a href="http://blog.itpub.net/28612416/viewspace-2138896/">http://blog.itpub.net/28612416/viewspace-2138896/</a><br><a href="https://m.aliyun.com/yunqi/articles/415260">https://m.aliyun.com/yunqi/articles/415260</a></p>
]]></content>
      <categories>
        <category>Troubleshooting</category>
      </categories>
      <tags>
        <tag>Oracle</tag>
      </tags>
  </entry>
  <entry>
    <title>Oracle RAC手动启动与关闭及常用命令</title>
    <url>/arlo/d56aba68/</url>
    <content><![CDATA[<p>在经历了几次服务器意外断电，启动rac报错；觉得之前直接“shutdown -h now”这种方式还是太“粗暴”，需要一种“温柔”的方式来操作她。</p>
<h1 id="查看一下RAC节点的服务状态"><a href="#查看一下RAC节点的服务状态" class="headerlink" title="查看一下RAC节点的服务状态"></a>查看一下RAC节点的服务状态</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[grid@rac1 ~]$ crs_stat -t -v</span><br><span class="line">Name           Type           R/RA   F/FT   Target    State     Host        </span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line">ora.DATA.dg    ora....up.type 0/5    0/     ONLINE    ONLINE    rac1        </span><br><span class="line">ora....ER.lsnr ora....er.type 0/5    0/     ONLINE    ONLINE    rac1        </span><br><span class="line">ora....N1.lsnr ora....er.type 0/5    0/0    ONLINE    ONLINE    rac1        </span><br><span class="line">ora.OCR.dg     ora....up.type 0/5    0/     ONLINE    ONLINE    rac1        </span><br><span class="line">ora....DISK.dg ora....up.type 0/5    0/     ONLINE    ONLINE    rac1        </span><br><span class="line">ora.asm        ora.asm.type   0/5    0/     ONLINE    ONLINE    rac1        </span><br><span class="line">ora.cvu        ora.cvu.type   0/5    0/0    ONLINE    ONLINE    rac1        </span><br><span class="line">ora.gsd        ora.gsd.type   0/5    0/     OFFLINE   OFFLINE               </span><br><span class="line">ora....network ora....rk.type 0/5    0/     ONLINE    ONLINE    rac1        </span><br><span class="line">ora.oc4j       ora.oc4j.type  0/1    0/2    ONLINE    ONLINE    rac2        </span><br><span class="line">ora.ons        ora.ons.type   0/3    0/     ONLINE    ONLINE    rac1        </span><br><span class="line">ora.orcl.db    ora....se.type 0/2    0/1    ONLINE    ONLINE    rac1        </span><br><span class="line">ora....SM1.asm application    0/5    0/0    ONLINE    ONLINE    rac1        </span><br><span class="line">ora....C1.lsnr application    0/5    0/0    ONLINE    ONLINE    rac1        </span><br><span class="line">ora.rac1.gsd   application    0/5    0/0    OFFLINE   OFFLINE               </span><br><span class="line">ora.rac1.ons   application    0/3    0/0    ONLINE    ONLINE    rac1        </span><br><span class="line">ora.rac1.vip   ora....t1.type 0/0    0/0    ONLINE    ONLINE    rac1        </span><br><span class="line">ora....SM2.asm application    0/5    0/0    ONLINE    ONLINE    rac2        </span><br><span class="line">ora....C2.lsnr application    0/5    0/0    OFFLINE   OFFLINE               </span><br><span class="line">ora.rac2.gsd   application    0/5    0/0    OFFLINE   OFFLINE               </span><br><span class="line">ora.rac2.ons   application    0/3    0/0    ONLINE    ONLINE    rac2        </span><br><span class="line">ora.rac2.vip   ora....t1.type 0/0    0/0    ONLINE    ONLINE    rac2        </span><br><span class="line">ora.scan1.vip  ora....ip.type 0/0    0/0    ONLINE    ONLINE    rac1        </span><br><span class="line">ora.sx21.db    ora....se.type 0/2    0/1    ONLINE    ONLINE    rac1</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<h1 id="关闭RAC"><a href="#关闭RAC" class="headerlink" title="关闭RAC"></a>关闭RAC</h1><p>关闭顺序：关闭数据库(实例)–&gt;关闭ASM实例–&gt;关闭节点服务</p>
<h2 id="关闭数据库"><a href="#关闭数据库" class="headerlink" title="关闭数据库"></a>关闭数据库</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">--关闭数据库</span><br><span class="line">srvctl stop database -d sx21</span><br><span class="line">srvctl stop database -d orcl</span><br></pre></td></tr></table></figure>
<h2 id="关闭ASM实例"><a href="#关闭ASM实例" class="headerlink" title="关闭ASM实例"></a>关闭ASM实例</h2><p>从11.2 Grid Infrastructure开始， ASM diskgroups也注册为CRS资源。而diskgroup资源是依赖于ASM的，所以不能首先要停止’ora.ASM.dg’这个服务，或者直接使用-f选项强制停止ASM。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-- 查看asm磁盘相关信息</span><br><span class="line">sqlplus / as sysasm</span><br><span class="line">SQL&gt; select instance_name,status from v$instance;</span><br><span class="line">SQL&gt; col name format a10</span><br><span class="line">SQL&gt; set line 9999</span><br><span class="line">SQL&gt; col path format a15</span><br><span class="line">SQL&gt; select group_number,path,name,disk_number,total_mb,free_mb,create_date,mount_status,mount_date from v$asm_disk order by group_number desc,disk_number;</span><br><span class="line">SQL&gt; select name,state,free_mb,required_mirror_free_mb,usable_file_mb from v$asm_diskgroup;</span><br></pre></td></tr></table></figure>
<p><img src="/images/2018/0402/01.png" alt="rac"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">--关闭磁盘组， 状态从ONLINE变成OFFLINE</span><br><span class="line">srvctl stop diskgroup -g data</span><br><span class="line">srvctl stop diskgroup -g ocr</span><br><span class="line">srvctl stop diskgroup -g votingdisk</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">--关闭asm</span><br><span class="line">srvctl stop asm -n rac1</span><br><span class="line">srvctl stop asm -n rac2</span><br></pre></td></tr></table></figure>
<h2 id="关闭各节点的服务包括：listener、gsd、ons、vip"><a href="#关闭各节点的服务包括：listener、gsd、ons、vip" class="headerlink" title="关闭各节点的服务包括：listener、gsd、ons、vip"></a>关闭各节点的服务包括：listener、gsd、ons、vip</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">srvctl stop nodeapps -n rac1</span><br><span class="line">srvctl stop nodeapps -n rac2</span><br></pre></td></tr></table></figure>
<h1 id="启动RAC"><a href="#启动RAC" class="headerlink" title="启动RAC"></a>启动RAC</h1><p>启动顺序：启动节点服务–&gt;启动ASM实例–&gt;启动数据库实例</p>
<h2 id="启动各节点的服务包括：listener、gsd、ons、vip"><a href="#启动各节点的服务包括：listener、gsd、ons、vip" class="headerlink" title="启动各节点的服务包括：listener、gsd、ons、vip"></a>启动各节点的服务包括：listener、gsd、ons、vip</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">srvctl start nodeapps -n rac1</span><br><span class="line">srvctl start nodeapps -n rac2</span><br></pre></td></tr></table></figure>
<h2 id="启动asm"><a href="#启动asm" class="headerlink" title="启动asm"></a>启动asm</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">srvctl start asm -n rac1</span><br><span class="line">srvctl start asm -n rac2</span><br></pre></td></tr></table></figure>
<h2 id="启动数据库"><a href="#启动数据库" class="headerlink" title="启动数据库"></a>启动数据库</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">srvctl start database -d sx21</span><br><span class="line">srvctl start database -d orcl</span><br></pre></td></tr></table></figure>
<h1 id="RAC常用操作命令"><a href="#RAC常用操作命令" class="headerlink" title="RAC常用操作命令"></a>RAC常用操作命令</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">--查看集群状态</span><br><span class="line">crsctl stat res -t</span><br><span class="line">crsctl check cluster -all</span><br><span class="line">crs_stat -t -v</span><br><span class="line">--查看数据库配置</span><br><span class="line">srvctl config database -d sx21</span><br><span class="line">--查看数据库状态</span><br><span class="line">srvctl status database -d sx21</span><br><span class="line">--启动数据库</span><br><span class="line">srvctl start database -d sx21</span><br><span class="line">--关闭数据库</span><br><span class="line">srvctl stop database -d sx21</span><br><span class="line"></span><br><span class="line">--查看asm状态</span><br><span class="line">srvctl status asm -n rac1</span><br><span class="line">srvctl status asm -n rac2</span><br><span class="line">--关闭asm 状态从ONLINE变成OFFLINE</span><br><span class="line">srvctl stop diskgroup -g data</span><br><span class="line">srvctl stop diskgroup -g ocr</span><br><span class="line">srvctl stop diskgroup -g votingdisk</span><br><span class="line">--开启asm </span><br><span class="line">srvctl start diskgroup -g data</span><br><span class="line">srvctl start diskgroup -g ocr</span><br><span class="line">srvctl start diskgroup -g votingdisk</span><br><span class="line"></span><br><span class="line">--查看vip状态</span><br><span class="line">srvctl status vip -n rac1 -v</span><br><span class="line">--启动vip</span><br><span class="line">srvctl start vip -n rac1 -v</span><br><span class="line">--停止vip</span><br><span class="line">srvctl stop vip -n rac2 -f -v</span><br><span class="line">srvctl stop vip -n rac1 -f -v</span><br><span class="line">-- 查看asm磁盘相关信息</span><br><span class="line">sqlplus / as sysasm</span><br><span class="line">SQL&gt; select instance_name,status from v$instance;</span><br><span class="line">SQL&gt; col name format a10</span><br><span class="line">SQL&gt; set line 9999</span><br><span class="line">SQL&gt; col path format a15</span><br><span class="line">SQL&gt; select group_number,path,name,disk_number,total_mb,free_mb,create_date,mount_status,mount_date from v$asm_disk order by group_number desc,disk_number;</span><br><span class="line">SQL&gt; select name,state,free_mb,required_mirror_free_mb,usable_file_mb from v$asm_diskgroup;</span><br><span class="line">---------------------------------------------------------</span><br><span class="line">以下操作需要使用root用户</span><br><span class="line">-- 单一节点启动</span><br><span class="line">crsctl start has</span><br><span class="line">crsctl start crs</span><br><span class="line">crsctl check crs</span><br><span class="line">-- 所有节点启动</span><br><span class="line">crsctl status cluster -n rac1 rac2</span><br><span class="line">crsctl start cluster -all</span><br><span class="line">crsctl check cluster -all</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>Oracle</tag>
        <tag>数据库</tag>
      </tags>
  </entry>
  <entry>
    <title>Scp拷贝大文件出现stalled故障解决方法</title>
    <url>/arlo/8954c4ab/</url>
    <content><![CDATA[<p>最近倒腾oracle数据库异地备份，由于端口限制不能使用rsync（首选），只能使用scp脚本自动拷贝到本地服务器，数据库按用户备份的，最大一个文件53G，发现每次都拷贝不完就中断了；之前以为是网络的问题导致shell退出，今天开了screen，手动执行脚本，特地跟踪了一下，发现出现stalled的故障；网上有找到的方法有以下几种，个人认为第三种更治根。</p>
<span id="more"></span>
<h1 id="限速"><a href="#限速" class="headerlink" title="限速"></a>限速</h1><p><code>scp -l 1000 /from/path  /to/path  #单位为Kbit，1000Kbit/8=125Kb</code></p>
<h1 id="修改内核参数"><a href="#修改内核参数" class="headerlink" title="修改内核参数"></a>修改内核参数</h1><p><code>echo 0 &gt; /proc/sys/net/ipv4/tcp_sack</code></p>
<h1 id="调整mtu值"><a href="#调整mtu值" class="headerlink" title="调整mtu值"></a>调整mtu值</h1><p>由于我的网络是PPPoE拨号的，最佳mtu值应为1492</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ifconfig eth0 mtu 1492</span><br><span class="line"></span><br><span class="line">or</span><br><span class="line"></span><br><span class="line">ip link set dev eth0 mtu 1492</span><br></pre></td></tr></table></figure>

<p>参考资料<br><a href="https://www.gpforums.co.nz/threads/399001-MTU-Value-1492-vs-1500">https://www.gpforums.co.nz/threads/399001-MTU-Value-1492-vs-1500</a><br><a href="https://stackoverflow.com/questions/11985008/sending-a-large-file-with-scp-to-a-certain-server-stalls-at-exactly-2112-kb">https://stackoverflow.com/questions/11985008/sending-a-large-file-with-scp-to-a-certain-server-stalls-at-exactly-2112-kb</a><br><a href="http://www.tp-link.com/tw/article/?faqid=190">http://www.tp-link.com/tw/article/?faqid=190</a><br><a href="http://www.cnblogs.com/wjoyxt/p/6873714.html">http://www.cnblogs.com/wjoyxt/p/6873714.html</a></p>
]]></content>
      <categories>
        <category>Troubleshooting</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>常识</tag>
        <tag>Scp</tag>
        <tag>MTU</tag>
      </tags>
  </entry>
  <entry>
    <title>Shell版俄罗斯方块(转)</title>
    <url>/arlo/8656017b/</url>
    <content><![CDATA[<p>在网上看到一篇shell版本的俄罗斯方块游戏，很有趣，转过来记录一下。<br>地址：<a href="http://www.ywnds.com/?p=12325">http://www.ywnds.com/?p=12325</a></p>
<span id="more"></span>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"> </span><br><span class="line"># Tetris Game</span><br><span class="line"># 10.21.2003 xhchen&lt;[email]xhchen@winbond.com.tw[/email]&gt;</span><br><span class="line"> </span><br><span class="line">#APP declaration</span><br><span class="line">APP_NAME=&quot;$&#123;0##*[\\/]&#125;&quot;</span><br><span class="line">APP_VERSION=&quot;1.0&quot;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">#颜色定义</span><br><span class="line">cRed=1</span><br><span class="line">cGreen=2</span><br><span class="line">cYellow=3</span><br><span class="line">cBlue=4</span><br><span class="line">cFuchsia=5</span><br><span class="line">cCyan=6</span><br><span class="line">cWhite=7</span><br><span class="line">colorTable=($cRed $cGreen $cYellow $cBlue $cFuchsia $cCyan $cWhite)</span><br><span class="line"> </span><br><span class="line">#位置和大小</span><br><span class="line">iLeft=3</span><br><span class="line">iTop=2</span><br><span class="line">((iTrayLeft = iLeft + 2))</span><br><span class="line">((iTrayTop = iTop + 1))</span><br><span class="line">((iTrayWidth = 10))</span><br><span class="line">((iTrayHeight = 15))</span><br><span class="line"> </span><br><span class="line">#颜色设置</span><br><span class="line">cBorder=$cGreen</span><br><span class="line">cScore=$cFuchsia</span><br><span class="line">cScoreValue=$cCyan</span><br><span class="line"> </span><br><span class="line">#控制信号</span><br><span class="line">#改游戏使用两个进程，一个用于接收输入，一个用于游戏流程和显示界面;</span><br><span class="line">#当前者接收到上下左右等按键时，通过向后者发送signal的方式通知后者。</span><br><span class="line">sigRotate=25</span><br><span class="line">sigLeft=26</span><br><span class="line">sigRight=27</span><br><span class="line">sigDown=28</span><br><span class="line">sigAllDown=29</span><br><span class="line">sigExit=30</span><br><span class="line"> </span><br><span class="line">#七中不同的方块的定义</span><br><span class="line">#通过旋转，每种方块的显示的样式可能有几种</span><br><span class="line">box0=(0 0 0 1 1 0 1 1)</span><br><span class="line">box1=(0 2 1 2 2 2 3 2 1 0 1 1 1 2 1 3)</span><br><span class="line">box2=(0 0 0 1 1 1 1 2 0 1 1 0 1 1 2 0)</span><br><span class="line">box3=(0 1 0 2 1 0 1 1 0 0 1 0 1 1 2 1)</span><br><span class="line">box4=(0 1 0 2 1 1 2 1 1 0 1 1 1 2 2 2 0 1 1 1 2 0 2 1 0 0 1 0 1 1 1 2)</span><br><span class="line">box5=(0 1 1 1 2 1 2 2 1 0 1 1 1 2 2 0 0 0 0 1 1 1 2 1 0 2 1 0 1 1 1 2)</span><br><span class="line">box6=(0 1 1 1 1 2 2 1 1 0 1 1 1 2 2 1 0 1 1 0 1 1 2 1 0 1 1 0 1 1 1 2)</span><br><span class="line">#所有其中方块的定义都放到box变量中</span><br><span class="line">box=($&#123;box0[@]&#125; $&#123;box1[@]&#125; $&#123;box2[@]&#125; $&#123;box3[@]&#125; $&#123;box4[@]&#125; $&#123;box5[@]&#125; $&#123;box6[@]&#125;)</span><br><span class="line">#各种方块旋转后可能的样式数目</span><br><span class="line">countBox=(1 2 2 2 4 4 4)</span><br><span class="line">#各种方块再box数组中的偏移</span><br><span class="line">offsetBox=(0 1 3 5 7 11 15)</span><br><span class="line"> </span><br><span class="line">#每提高一个速度级需要积累的分数</span><br><span class="line">iScoreEachLevel=50        #be greater than 7</span><br><span class="line"> </span><br><span class="line">#运行时数据</span><br><span class="line">sig=0                #接收到的signal</span><br><span class="line">iScore=0        #总分</span><br><span class="line">iLevel=0        #速度级</span><br><span class="line">boxNew=()        #新下落的方块的位置定义</span><br><span class="line">cBoxNew=0        #新下落的方块的颜色</span><br><span class="line">iBoxNewType=0        #新下落的方块的种类</span><br><span class="line">iBoxNewRotate=0        #新下落的方块的旋转角度</span><br><span class="line">boxCur=()        #当前方块的位置定义</span><br><span class="line">cBoxCur=0        #当前方块的颜色</span><br><span class="line">iBoxCurType=0        #当前方块的种类</span><br><span class="line">iBoxCurRotate=0        #当前方块的旋转角度</span><br><span class="line">boxCurX=-1        #当前方块的x坐标位置</span><br><span class="line">boxCurY=-1        #当前方块的y坐标位置</span><br><span class="line">iMap=()                #背景方块图表</span><br><span class="line"> </span><br><span class="line">#初始化所有背景方块为-1, 表示没有方块</span><br><span class="line">for ((i = 0; i &lt; iTrayHeight * iTrayWidth; i++)); do iMap[$i]=-1; done</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">#接收输入的进程的主函数</span><br><span class="line">function RunAsKeyReceiver()</span><br><span class="line">&#123;</span><br><span class="line">        local pidDisplayer key aKey sig cESC sTTY</span><br><span class="line"> </span><br><span class="line">        pidDisplayer=$1</span><br><span class="line">        aKey=(0 0 0)</span><br><span class="line"> </span><br><span class="line">        cESC=`echo -ne &quot;\033&quot;`</span><br><span class="line">        cSpace=`echo -ne &quot;\040&quot;`</span><br><span class="line"> </span><br><span class="line">        #保存终端属性。在read -s读取终端键时，终端的属性会被暂时改变。</span><br><span class="line">        #如果在read -s时程序被不幸杀掉，可能会导致终端混乱，</span><br><span class="line">        #需要在程序退出时恢复终端属性。</span><br><span class="line">        sTTY=`stty -g`</span><br><span class="line"> </span><br><span class="line">        #捕捉退出信号</span><br><span class="line">        trap &quot;MyExit;&quot; INT TERM</span><br><span class="line">        trap &quot;MyExitNoSub;&quot; $sigExit</span><br><span class="line"> </span><br><span class="line">        #隐藏光标</span><br><span class="line">        echo -ne &quot;\033[?25l&quot;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        while :</span><br><span class="line">        do</span><br><span class="line">                #读取输入。注-s不回显，-n读到一个字符立即返回</span><br><span class="line">                read -s -n 1 key</span><br><span class="line"> </span><br><span class="line">                aKey[0]=$&#123;aKey[1]&#125;</span><br><span class="line">                aKey[1]=$&#123;aKey[2]&#125;</span><br><span class="line">                aKey[2]=$key</span><br><span class="line">                sig=0</span><br><span class="line"> </span><br><span class="line">                #判断输入了何种键</span><br><span class="line">                if [[ $key == $cESC &amp;&amp; $&#123;aKey[1]&#125; == $cESC ]]</span><br><span class="line">                then</span><br><span class="line">                        #ESC键</span><br><span class="line">                        MyExit</span><br><span class="line">                elif [[ $&#123;aKey[0]&#125; == $cESC &amp;&amp; $&#123;aKey[1]&#125; == &quot;[&quot; ]]</span><br><span class="line">                then</span><br><span class="line">                        if [[ $key == &quot;A&quot; ]]; then sig=$sigRotate        #&lt;向上键&gt;</span><br><span class="line">                        elif [[ $key == &quot;B&quot; ]]; then sig=$sigDown        #&lt;向下键&gt;</span><br><span class="line">                        elif [[ $key == &quot;D&quot; ]]; then sig=$sigLeft        #&lt;向左键&gt;</span><br><span class="line">                        elif [[ $key == &quot;C&quot; ]]; then sig=$sigRight        #&lt;向右键&gt;</span><br><span class="line">                        fi</span><br><span class="line">                elif [[ $key == &quot;W&quot; || $key == &quot;w&quot; ]]; then sig=$sigRotate        #W, w</span><br><span class="line">                elif [[ $key == &quot;S&quot; || $key == &quot;s&quot; ]]; then sig=$sigDown        #S, s</span><br><span class="line">                elif [[ $key == &quot;A&quot; || $key == &quot;a&quot; ]]; then sig=$sigLeft        #A, a</span><br><span class="line">                elif [[ $key == &quot;D&quot; || $key == &quot;d&quot; ]]; then sig=$sigRight        #D, d</span><br><span class="line">                elif [[ &quot;[$key]&quot; == &quot;[]&quot; ]]; then sig=$sigAllDown        #空格键</span><br><span class="line">                elif [[ $key == &quot;Q&quot; || $key == &quot;q&quot; ]]                        #Q, q</span><br><span class="line">                then</span><br><span class="line">                        MyExit</span><br><span class="line">                fi</span><br><span class="line"> </span><br><span class="line">                if [[ $sig != 0 ]]</span><br><span class="line">                then</span><br><span class="line">                        #向另一进程发送消息</span><br><span class="line">                        kill -$sig $pidDisplayer</span><br><span class="line">                fi</span><br><span class="line">        done</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">#退出前的恢复</span><br><span class="line">function MyExitNoSub()</span><br><span class="line">&#123;</span><br><span class="line">        local y</span><br><span class="line"> </span><br><span class="line">        #恢复终端属性</span><br><span class="line">        stty $sTTY</span><br><span class="line">        ((y = iTop + iTrayHeight + 4))</span><br><span class="line"> </span><br><span class="line">        #显示光标</span><br><span class="line">        echo -e &quot;\033[?25h\033[$&#123;y&#125;;0H&quot;</span><br><span class="line">        exit</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">function MyExit()</span><br><span class="line">&#123;</span><br><span class="line">        #通知显示进程需要退出</span><br><span class="line">        kill -$sigExit $pidDisplayer</span><br><span class="line"> </span><br><span class="line">        MyExitNoSub</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">#处理显示和游戏流程的主函数</span><br><span class="line">function RunAsDisplayer()</span><br><span class="line">&#123;</span><br><span class="line">        local sigThis</span><br><span class="line">        InitDraw</span><br><span class="line"> </span><br><span class="line">        #挂载各种信号的处理函数</span><br><span class="line">        trap &quot;sig=$sigRotate;&quot; $sigRotate</span><br><span class="line">        trap &quot;sig=$sigLeft;&quot; $sigLeft</span><br><span class="line">        trap &quot;sig=$sigRight;&quot; $sigRight</span><br><span class="line">        trap &quot;sig=$sigDown;&quot; $sigDown</span><br><span class="line">        trap &quot;sig=$sigAllDown;&quot; $sigAllDown</span><br><span class="line">        trap &quot;ShowExit;&quot; $sigExit</span><br><span class="line"> </span><br><span class="line">        while :</span><br><span class="line">        do</span><br><span class="line">                #根据当前的速度级iLevel不同，设定相应的循环的次数</span><br><span class="line">                for ((i = 0; i &lt; 21 - iLevel; i++))</span><br><span class="line">                do</span><br><span class="line">                        sleep 0.02</span><br><span class="line">                        sigThis=$sig</span><br><span class="line">                        sig=0</span><br><span class="line"> </span><br><span class="line">                        #根据sig变量判断是否接受到相应的信号</span><br><span class="line">                        if ((sigThis == sigRotate)); then BoxRotate;        #旋转</span><br><span class="line">                        elif ((sigThis == sigLeft)); then BoxLeft;        #左移一列</span><br><span class="line">                        elif ((sigThis == sigRight)); then BoxRight;        #右移一列</span><br><span class="line">                        elif ((sigThis == sigDown)); then BoxDown;        #下落一行</span><br><span class="line">                        elif ((sigThis == sigAllDown)); then BoxAllDown;        #下落到底</span><br><span class="line">                        fi</span><br><span class="line">                done</span><br><span class="line">                #kill -$sigDown $$</span><br><span class="line">                BoxDown        #下落一行</span><br><span class="line">        done</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">#BoxMove(y, x), 测试是否可以把移动中的方块移到(x, y)的位置, 返回0则可以, 1不可以</span><br><span class="line">function BoxMove()</span><br><span class="line">&#123;</span><br><span class="line">        local j i x y xTest yTest</span><br><span class="line">        yTest=$1</span><br><span class="line">        xTest=$2</span><br><span class="line">        for ((j = 0; j &lt; 8; j += 2))</span><br><span class="line">        do</span><br><span class="line">                ((i = j + 1))</span><br><span class="line">                ((y = $&#123;boxCur[$j]&#125; + yTest))</span><br><span class="line">                ((x = $&#123;boxCur[$i]&#125; + xTest))</span><br><span class="line">                if (( y &lt; 0 || y &gt;= iTrayHeight || x &lt; 0 || x &gt;= iTrayWidth))</span><br><span class="line">                then</span><br><span class="line">                        #撞到墙壁了</span><br><span class="line">                        return 1</span><br><span class="line">                fi</span><br><span class="line">                if (($&#123;iMap[y * iTrayWidth + x]&#125; != -1 ))</span><br><span class="line">                then</span><br><span class="line">                        #撞到其他已经存在的方块了</span><br><span class="line">                        return 1</span><br><span class="line">                fi</span><br><span class="line">        done</span><br><span class="line">        return 0;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">#将当前移动中的方块放到背景方块中去,</span><br><span class="line">#并计算新的分数和速度级。(即一次方块落到底部)</span><br><span class="line">function Box2Map()</span><br><span class="line">&#123;</span><br><span class="line">        local j i x y xp yp line</span><br><span class="line"> </span><br><span class="line">        #将当前移动中的方块放到背景方块中去</span><br><span class="line">        for ((j = 0; j &lt; 8; j += 2))</span><br><span class="line">        do</span><br><span class="line">                ((i = j + 1))</span><br><span class="line">                ((y = $&#123;boxCur[$j]&#125; + boxCurY))</span><br><span class="line">                ((x = $&#123;boxCur[$i]&#125; + boxCurX))</span><br><span class="line">                ((i = y * iTrayWidth + x))</span><br><span class="line">                iMap[$i]=$cBoxCur</span><br><span class="line">        done</span><br><span class="line"> </span><br><span class="line">        #消去可被消去的行</span><br><span class="line">        line=0</span><br><span class="line">        for ((j = 0; j &lt; iTrayWidth * iTrayHeight; j += iTrayWidth))</span><br><span class="line">        do</span><br><span class="line">                for ((i = j + iTrayWidth - 1; i &gt;= j; i--))</span><br><span class="line">                do</span><br><span class="line">                        if (($&#123;iMap[$i]&#125; == -1)); then break; fi</span><br><span class="line">                done</span><br><span class="line">                if ((i &gt;= j)); then continue; fi</span><br><span class="line"> </span><br><span class="line">                ((line++))</span><br><span class="line">                for ((i = j - 1; i &gt;= 0; i--))</span><br><span class="line">                do</span><br><span class="line">                        ((x = i + iTrayWidth))</span><br><span class="line">                        iMap[$x]=$&#123;iMap[$i]&#125;</span><br><span class="line">                done</span><br><span class="line">                for ((i = 0; i &lt; iTrayWidth; i++))</span><br><span class="line">                do</span><br><span class="line">                        iMap[$i]=-1</span><br><span class="line">                done</span><br><span class="line">        done</span><br><span class="line"> </span><br><span class="line">        if ((line == 0)); then return; fi</span><br><span class="line"> </span><br><span class="line">        #根据消去的行数line计算分数和速度级</span><br><span class="line">        ((x = iLeft + iTrayWidth * 2 + 7))</span><br><span class="line">        ((y = iTop + 11))</span><br><span class="line">        ((iScore += line * 2 - 1))</span><br><span class="line">        #显示新的分数</span><br><span class="line">        echo -ne &quot;\033[1m\033[3$&#123;cScoreValue&#125;m\033[$&#123;y&#125;;$&#123;x&#125;H$&#123;iScore&#125;         &quot;</span><br><span class="line">        if ((iScore % iScoreEachLevel &lt; line * 2 - 1))</span><br><span class="line">        then</span><br><span class="line">                if ((iLevel &lt; 20))</span><br><span class="line">                then</span><br><span class="line">                        ((iLevel++))</span><br><span class="line">                        ((y = iTop + 14))</span><br><span class="line">                        #显示新的速度级</span><br><span class="line">                        echo -ne &quot;\033[3$&#123;cScoreValue&#125;m\033[$&#123;y&#125;;$&#123;x&#125;H$&#123;iLevel&#125;        &quot;</span><br><span class="line">                fi</span><br><span class="line">        fi</span><br><span class="line">        echo -ne &quot;\033[0m&quot;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        #重新显示背景方块</span><br><span class="line">        for ((y = 0; y &lt; iTrayHeight; y++))</span><br><span class="line">        do</span><br><span class="line">                ((yp = y + iTrayTop + 1))</span><br><span class="line">                ((xp = iTrayLeft + 1))</span><br><span class="line">                ((i = y * iTrayWidth))</span><br><span class="line">                echo -ne &quot;\033[$&#123;yp&#125;;$&#123;xp&#125;H&quot;</span><br><span class="line">                for ((x = 0; x &lt; iTrayWidth; x++))</span><br><span class="line">                do</span><br><span class="line">                        ((j = i + x))</span><br><span class="line">                        if (($&#123;iMap[$j]&#125; == -1))</span><br><span class="line">                        then</span><br><span class="line">                                echo -ne &quot;  &quot;</span><br><span class="line">                        else</span><br><span class="line">                                echo -ne &quot;\033[1m\033[7m\033[3$&#123;iMap[$j]&#125;m\033[4$&#123;iMap[$j]&#125;m[]\033[0m&quot;</span><br><span class="line">                        fi</span><br><span class="line">                done</span><br><span class="line">        done</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">#下落一行</span><br><span class="line">function BoxDown()</span><br><span class="line">&#123;</span><br><span class="line">        local y s</span><br><span class="line">        ((y = boxCurY + 1))        #新的y坐标</span><br><span class="line">        if BoxMove $y $boxCurX        #测试是否可以下落一行</span><br><span class="line">        then</span><br><span class="line">                s=&quot;`DrawCurBox 0`&quot;        #将旧的方块抹去</span><br><span class="line">                ((boxCurY = y))</span><br><span class="line">                s=&quot;$s`DrawCurBox 1`&quot;        #显示新的下落后方块</span><br><span class="line">                echo -ne $s</span><br><span class="line">        else</span><br><span class="line">                #走到这儿, 如果不能下落了</span><br><span class="line">                Box2Map                #将当前移动中的方块贴到背景方块中</span><br><span class="line">                RandomBox        #产生新的方块</span><br><span class="line">        fi</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">#左移一列</span><br><span class="line">function BoxLeft()</span><br><span class="line">&#123;</span><br><span class="line">        local x s</span><br><span class="line">        ((x = boxCurX - 1))</span><br><span class="line">        if BoxMove $boxCurY $x</span><br><span class="line">        then</span><br><span class="line">                s=`DrawCurBox 0`</span><br><span class="line">                ((boxCurX = x))</span><br><span class="line">                s=$s`DrawCurBox 1`</span><br><span class="line">                echo -ne $s</span><br><span class="line">        fi</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">#右移一列</span><br><span class="line">function BoxRight()</span><br><span class="line">&#123;</span><br><span class="line">        local x s</span><br><span class="line">        ((x = boxCurX + 1))</span><br><span class="line">        if BoxMove $boxCurY $x</span><br><span class="line">        then</span><br><span class="line">                s=`DrawCurBox 0`</span><br><span class="line">                ((boxCurX = x))</span><br><span class="line">                s=$s`DrawCurBox 1`</span><br><span class="line">                echo -ne $s</span><br><span class="line">        fi</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">#下落到底</span><br><span class="line">function BoxAllDown()</span><br><span class="line">&#123;</span><br><span class="line">        local k j i x y iDown s</span><br><span class="line">        iDown=$iTrayHeight</span><br><span class="line"> </span><br><span class="line">        #计算一共需要下落多少行</span><br><span class="line">        for ((j = 0; j &lt; 8; j += 2))</span><br><span class="line">        do</span><br><span class="line">                ((i = j + 1))</span><br><span class="line">                ((y = $&#123;boxCur[$j]&#125; + boxCurY))</span><br><span class="line">                ((x = $&#123;boxCur[$i]&#125; + boxCurX))</span><br><span class="line">                for ((k = y + 1; k &lt; iTrayHeight; k++))</span><br><span class="line">                do</span><br><span class="line">                        ((i = k * iTrayWidth + x))</span><br><span class="line">                        if (( $&#123;iMap[$i]&#125; != -1)); then break; fi</span><br><span class="line">                done</span><br><span class="line">                ((k -= y + 1))</span><br><span class="line">                if (( $iDown &gt; $k )); then iDown=$k; fi</span><br><span class="line">        done</span><br><span class="line"> </span><br><span class="line">        s=`DrawCurBox 0`        #将旧的方块抹去</span><br><span class="line">        ((boxCurY += iDown))</span><br><span class="line">        s=$s`DrawCurBox 1`        #显示新的下落后的方块</span><br><span class="line">        echo -ne $s</span><br><span class="line">        Box2Map                #将当前移动中的方块贴到背景方块中</span><br><span class="line">        RandomBox        #产生新的方块</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">#旋转方块</span><br><span class="line">function BoxRotate()</span><br><span class="line">&#123;</span><br><span class="line">        local iCount iTestRotate boxTest j i s</span><br><span class="line">        iCount=$&#123;countBox[$iBoxCurType]&#125;        #当前的方块经旋转可以产生的样式的数目</span><br><span class="line"> </span><br><span class="line">        #计算旋转后的新的样式</span><br><span class="line">        ((iTestRotate = iBoxCurRotate + 1))</span><br><span class="line">        if ((iTestRotate &gt;= iCount))</span><br><span class="line">        then</span><br><span class="line">                ((iTestRotate = 0))</span><br><span class="line">        fi</span><br><span class="line"> </span><br><span class="line">        #更新到新的样式, 保存老的样式(但不显示)</span><br><span class="line">        for ((j = 0, i = ($&#123;offsetBox[$iBoxCurType]&#125; + $iTestRotate) * 8; j &lt; 8; j++, i++))</span><br><span class="line">        do</span><br><span class="line">                boxTest[$j]=$&#123;boxCur[$j]&#125;</span><br><span class="line">                boxCur[$j]=$&#123;box[$i]&#125;</span><br><span class="line">        done</span><br><span class="line"> </span><br><span class="line">        if BoxMove $boxCurY $boxCurX        #测试旋转后是否有空间放的下</span><br><span class="line">        then</span><br><span class="line">                #抹去旧的方块</span><br><span class="line">                for ((j = 0; j &lt; 8; j++))</span><br><span class="line">                do</span><br><span class="line">                        boxCur[$j]=$&#123;boxTest[$j]&#125;</span><br><span class="line">                done</span><br><span class="line">                s=`DrawCurBox 0`</span><br><span class="line"> </span><br><span class="line">                #画上新的方块</span><br><span class="line">                for ((j = 0, i = ($&#123;offsetBox[$iBoxCurType]&#125; + $iTestRotate) * 8; j &lt; 8; j++, i++))</span><br><span class="line">                do</span><br><span class="line">                        boxCur[$j]=$&#123;box[$i]&#125;</span><br><span class="line">                done</span><br><span class="line">                s=$s`DrawCurBox 1`</span><br><span class="line">                echo -ne $s</span><br><span class="line">                iBoxCurRotate=$iTestRotate</span><br><span class="line">        else</span><br><span class="line">                #不能旋转，还是继续使用老的样式</span><br><span class="line">                for ((j = 0; j &lt; 8; j++))</span><br><span class="line">                do</span><br><span class="line">                        boxCur[$j]=$&#123;boxTest[$j]&#125;</span><br><span class="line">                done</span><br><span class="line">        fi</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">#DrawCurBox(bDraw), 绘制当前移动中的方块, bDraw为1, 画上, bDraw为0, 抹去方块。</span><br><span class="line">function DrawCurBox()</span><br><span class="line">&#123;</span><br><span class="line">        local i j t bDraw sBox s</span><br><span class="line">        bDraw=$1</span><br><span class="line"> </span><br><span class="line">        s=&quot;&quot;</span><br><span class="line">        if (( bDraw == 0 ))</span><br><span class="line">        then</span><br><span class="line">                sBox=&quot;\040\040&quot;</span><br><span class="line">        else</span><br><span class="line">                sBox=&quot;[]&quot;</span><br><span class="line">                s=$s&quot;\033[1m\033[7m\033[3$&#123;cBoxCur&#125;m\033[4$&#123;cBoxCur&#125;m&quot;</span><br><span class="line">        fi</span><br><span class="line"> </span><br><span class="line">        for ((j = 0; j &lt; 8; j += 2))</span><br><span class="line">        do</span><br><span class="line">                ((i = iTrayTop + 1 + $&#123;boxCur[$j]&#125; + boxCurY))</span><br><span class="line">                ((t = iTrayLeft + 1 + 2 * (boxCurX + $&#123;boxCur[$j + 1]&#125;)))</span><br><span class="line">                #\033[y;xH, 光标到(x, y)处</span><br><span class="line">                s=$s&quot;\033[$&#123;i&#125;;$&#123;t&#125;H$&#123;sBox&#125;&quot;</span><br><span class="line">        done</span><br><span class="line">        s=$s&quot;\033[0m&quot;</span><br><span class="line">        echo -n $s</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">#更新新的方块</span><br><span class="line">function RandomBox()</span><br><span class="line">&#123;</span><br><span class="line">        local i j t</span><br><span class="line"> </span><br><span class="line">        #更新当前移动的方块</span><br><span class="line">        iBoxCurType=$&#123;iBoxNewType&#125;</span><br><span class="line">        iBoxCurRotate=$&#123;iBoxNewRotate&#125;</span><br><span class="line">        cBoxCur=$&#123;cBoxNew&#125;</span><br><span class="line">        for ((j = 0; j &lt; $&#123;#boxNew[@]&#125;; j++))</span><br><span class="line">        do</span><br><span class="line">                boxCur[$j]=$&#123;boxNew[$j]&#125;</span><br><span class="line">        done</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        #显示当前移动的方块</span><br><span class="line">        if (( $&#123;#boxCur[@]&#125; == 8 ))</span><br><span class="line">        then</span><br><span class="line">                #计算当前方块该从顶端哪一行&quot;冒&quot;出来</span><br><span class="line">                for ((j = 0, t = 4; j &lt; 8; j += 2))</span><br><span class="line">                do</span><br><span class="line">                        if (($&#123;boxCur[$j]&#125; &lt; t)); then t=$&#123;boxCur[$j]&#125;; fi</span><br><span class="line">                done</span><br><span class="line">                ((boxCurY = -t))</span><br><span class="line">                for ((j = 1, i = -4, t = 20; j &lt; 8; j += 2))</span><br><span class="line">                do</span><br><span class="line">                        if (($&#123;boxCur[$j]&#125; &gt; i)); then i=$&#123;boxCur[$j]&#125;; fi</span><br><span class="line">                        if (($&#123;boxCur[$j]&#125; &lt; t)); then t=$&#123;boxCur[$j]&#125;; fi</span><br><span class="line">                done</span><br><span class="line">                ((boxCurX = (iTrayWidth - 1 - i - t) / 2))</span><br><span class="line"> </span><br><span class="line">                #显示当前移动的方块</span><br><span class="line">                echo -ne `DrawCurBox 1`</span><br><span class="line"> </span><br><span class="line">                #如果方块一出来就没处放，Game over!</span><br><span class="line">                if ! BoxMove $boxCurY $boxCurX</span><br><span class="line">                then</span><br><span class="line">                        kill -$sigExit $&#123;PPID&#125;</span><br><span class="line">                        ShowExit</span><br><span class="line">                fi</span><br><span class="line">        fi</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        #清除右边预显示的方块</span><br><span class="line">        for ((j = 0; j &lt; 4; j++))</span><br><span class="line">        do</span><br><span class="line">                ((i = iTop + 1 + j))</span><br><span class="line">                ((t = iLeft + 2 * iTrayWidth + 7))</span><br><span class="line">                echo -ne &quot;\033[$&#123;i&#125;;$&#123;t&#125;H        &quot;</span><br><span class="line">        done</span><br><span class="line"> </span><br><span class="line">        #随机产生新的方块</span><br><span class="line">        ((iBoxNewType = RANDOM % $&#123;#offsetBox[@]&#125;))</span><br><span class="line">        ((iBoxNewRotate = RANDOM % $&#123;countBox[$iBoxNewType]&#125;))</span><br><span class="line">        for ((j = 0, i = ($&#123;offsetBox[$iBoxNewType]&#125; + $iBoxNewRotate) * 8; j &lt; 8; j++, i++))</span><br><span class="line">        do</span><br><span class="line">                boxNew[$j]=$&#123;box[$i]&#125;;</span><br><span class="line">        done</span><br><span class="line"> </span><br><span class="line">        ((cBoxNew = $&#123;colorTable[RANDOM % $&#123;#colorTable[@]&#125;]&#125;))</span><br><span class="line"> </span><br><span class="line">        #显示右边预显示的方块</span><br><span class="line">        echo -ne &quot;\033[1m\033[7m\033[3$&#123;cBoxNew&#125;m\033[4$&#123;cBoxNew&#125;m&quot;</span><br><span class="line">        for ((j = 0; j &lt; 8; j += 2))</span><br><span class="line">        do</span><br><span class="line">                ((i = iTop + 1 + $&#123;boxNew[$j]&#125;))</span><br><span class="line">                ((t = iLeft + 2 * iTrayWidth + 7 + 2 * $&#123;boxNew[$j + 1]&#125;))</span><br><span class="line">                echo -ne &quot;\033[$&#123;i&#125;;$&#123;t&#125;H[]&quot;</span><br><span class="line">        done</span><br><span class="line">        echo -ne &quot;\033[0m&quot;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">#初始绘制</span><br><span class="line">function InitDraw()</span><br><span class="line">&#123;</span><br><span class="line">        clear</span><br><span class="line">        RandomBox        #随机产生方块，这时右边预显示窗口中有方快了</span><br><span class="line">        RandomBox        #再随机产生方块，右边预显示窗口中的方块被更新，原先的方块将开始下落</span><br><span class="line">        local i t1 t2 t3</span><br><span class="line"> </span><br><span class="line">        #显示边框</span><br><span class="line">        echo -ne &quot;\033[1m&quot;</span><br><span class="line">        echo -ne &quot;\033[3$&#123;cBorder&#125;m\033[4$&#123;cBorder&#125;m&quot;</span><br><span class="line"> </span><br><span class="line">        ((t2 = iLeft + 1))</span><br><span class="line">        ((t3 = iLeft + iTrayWidth * 2 + 3))</span><br><span class="line">        for ((i = 0; i &lt; iTrayHeight; i++))</span><br><span class="line">        do</span><br><span class="line">                ((t1 = i + iTop + 2))</span><br><span class="line">                echo -ne &quot;\033[$&#123;t1&#125;;$&#123;t2&#125;H||&quot;</span><br><span class="line">                echo -ne &quot;\033[$&#123;t1&#125;;$&#123;t3&#125;H||&quot;</span><br><span class="line">        done</span><br><span class="line"> </span><br><span class="line">        ((t2 = iTop + iTrayHeight + 2))</span><br><span class="line">        for ((i = 0; i &lt; iTrayWidth + 2; i++))</span><br><span class="line">        do</span><br><span class="line">                ((t1 = i * 2 + iLeft + 1))</span><br><span class="line">                echo -ne &quot;\033[$&#123;iTrayTop&#125;;$&#123;t1&#125;H==&quot;</span><br><span class="line">                echo -ne &quot;\033[$&#123;t2&#125;;$&#123;t1&#125;H==&quot;</span><br><span class="line">        done</span><br><span class="line">        echo -ne &quot;\033[0m&quot;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        #显示&quot;Score&quot;和&quot;Level&quot;字样</span><br><span class="line">        echo -ne &quot;\033[1m&quot;</span><br><span class="line">        ((t1 = iLeft + iTrayWidth * 2 + 7))</span><br><span class="line">        ((t2 = iTop + 10))</span><br><span class="line">        echo -ne &quot;\033[3$&#123;cScore&#125;m\033[$&#123;t2&#125;;$&#123;t1&#125;HScore&quot;</span><br><span class="line">        ((t2 = iTop + 11))</span><br><span class="line">        echo -ne &quot;\033[3$&#123;cScoreValue&#125;m\033[$&#123;t2&#125;;$&#123;t1&#125;H$&#123;iScore&#125;&quot;</span><br><span class="line">        ((t2 = iTop + 13))</span><br><span class="line">        echo -ne &quot;\033[3$&#123;cScore&#125;m\033[$&#123;t2&#125;;$&#123;t1&#125;HLevel&quot;</span><br><span class="line">        ((t2 = iTop + 14))</span><br><span class="line">        echo -ne &quot;\033[3$&#123;cScoreValue&#125;m\033[$&#123;t2&#125;;$&#123;t1&#125;H$&#123;iLevel&#125;&quot;</span><br><span class="line">        echo -ne &quot;\033[0m&quot;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">#退出时显示GameOVer!</span><br><span class="line">function ShowExit()</span><br><span class="line">&#123;</span><br><span class="line">        local y</span><br><span class="line">        ((y = iTrayHeight + iTrayTop + 3))</span><br><span class="line">        echo -e &quot;\033[$&#123;y&#125;;0HGameOver!\033[0m&quot;</span><br><span class="line">        exit</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">#显示用法.</span><br><span class="line">function Usage</span><br><span class="line">&#123;</span><br><span class="line">        cat &lt;&lt; EOF</span><br><span class="line">Usage: $APP_NAME</span><br><span class="line">Start tetris game.</span><br><span class="line"> </span><br><span class="line">  -h, --help              display this help and exit</span><br><span class="line">      --version           output version information and exit</span><br><span class="line">EOF</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">#游戏主程序在这儿开始.</span><br><span class="line">if [[ &quot;$1&quot; == &quot;-h&quot; || &quot;$1&quot; == &quot;--help&quot; ]]; then</span><br><span class="line">        Usage</span><br><span class="line">elif [[ &quot;$1&quot; == &quot;--version&quot; ]]; then</span><br><span class="line">        echo &quot;$APP_NAME $APP_VERSION&quot;</span><br><span class="line">elif [[ &quot;$1&quot; == &quot;--show&quot; ]]; then</span><br><span class="line">        #当发现具有参数--show时，运行显示函数</span><br><span class="line">        RunAsDisplayer</span><br><span class="line">else</span><br><span class="line">        bash $0 --show&amp;        #以参数--show将本程序再运行一遍</span><br><span class="line">        RunAsKeyReceiver $!        #以上一行产生的进程的进程号作为参数</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Interesting</category>
      </categories>
      <tags>
        <tag>shell</tag>
      </tags>
  </entry>
  <entry>
    <title>Zabbix(7)监控端口、服务存活</title>
    <url>/arlo/429ab963/</url>
    <content><![CDATA[<p>之前添加的tomcat监控，只能监控到jvm，类，线程之类的参数，不能监控tomcat本身的存活状态，总感觉有点美中不足；网上找了下，监控端口、服务还是挺简单的，这里记录一下。</p>
<span id="more"></span>
<h1 id="zabbix有三种监控端口的监控项方法"><a href="#zabbix有三种监控端口的监控项方法" class="headerlink" title="zabbix有三种监控端口的监控项方法"></a>zabbix有三种监控端口的监控项方法</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1.net.tcp.listen[port] </span><br><span class="line">用于监听端口是否开启</span><br><span class="line">1表示开启 0表示未开启 </span><br><span class="line">2.net.tcp.port[,port] </span><br><span class="line">是否可以连接到指定的TCP端口 </span><br><span class="line">0 – 无法连接 </span><br><span class="line">1 – 可以连接 </span><br><span class="line">ip – IP 地址(默认是 127.0.0.1) </span><br><span class="line">port – 端口 </span><br><span class="line">范例: </span><br><span class="line">net.tcp.port[,80] </span><br><span class="line">检测 web 服务器端口是否运行中</span><br><span class="line">3.net.tcp.service[service,,] </span><br><span class="line">检测服务，是否开启，并且端口可用 </span><br><span class="line">0 – 服务挂了 </span><br><span class="line">1 – 服务运行中 </span><br><span class="line">service – 如下: ssh, ntp, ldap, smtp, ftp, http, pop, nntp,imap, tcp, https, telnet </span><br><span class="line">ip – IP地址 (默认127.0.0.1) </span><br><span class="line">port – 端口 (默认情况为标准端口号) </span><br><span class="line">示例 key: </span><br><span class="line">net.tcp.service[ftp,,21] – 检测 21 端口上得 FTP 是否运行中 </span><br><span class="line">Zabbix 1.8.3 支持的版本请使用 service.ntp 代替 ntp.https 和 telnet 服务从 2.0 和 2.2 开始支持</span><br><span class="line"></span><br><span class="line">4.net.tcp.service.perf[service,,] </span><br><span class="line">检测服务器性能 </span><br><span class="line">0 – 服务挂了; </span><br><span class="line">seconds – 链接到服务器端口消耗的时间 </span><br><span class="line">service – 如下:ssh, ntp,ldap, smtp, ftp, http, pop, nntp,imap, tcp, https,telnet </span><br><span class="line">ip – IP地址 (默认127.0.0.1) </span><br><span class="line">port – 端口 (默认情况为标准端口号)</span><br><span class="line">5.net.udp.listen[port] </span><br><span class="line">检测 UDP端口是否在监听 </span><br><span class="line">0 – 未监听 </span><br><span class="line">1 – 监听中 </span><br><span class="line">port – udp 端口 范例: </span><br><span class="line">net.udp.listen[68]</span><br></pre></td></tr></table></figure>
<h1 id="监控tomcat-8080端口"><a href="#监控tomcat-8080端口" class="headerlink" title="监控tomcat 8080端口"></a>监控tomcat 8080端口</h1><h2 id="添加监控项"><a href="#添加监控项" class="headerlink" title="添加监控项"></a>添加监控项</h2><p><img src="/images/2018/0417/01.png" alt="z"></p>
<h2 id="添加触发器"><a href="#添加触发器" class="headerlink" title="添加触发器"></a>添加触发器</h2><p><img src="/images/2018/0417/02.png" alt="z"></p>
<h2 id="添加图形"><a href="#添加图形" class="headerlink" title="添加图形"></a>添加图形</h2><p><img src="/images/2018/0417/03.png" alt="z"></p>
<p>参考链接：<a href="http://www.cnblogs.com/saneri/p/6126786.html">http://www.cnblogs.com/saneri/p/6126786.html</a></p>
]]></content>
      <categories>
        <category>监控</category>
      </categories>
      <tags>
        <tag>zabbix</tag>
        <tag>监控</tag>
      </tags>
  </entry>
  <entry>
    <title>Sonar代码质量管理工具安装</title>
    <url>/arlo/96c3f480/</url>
    <content><![CDATA[<p>Sonar(SonarQube)是一款静态代码检查工具，采用B&#x2F;S架构，帮助检查代码缺陷，改善代码质量，提高开发速度，通过插件形式，可以支持Java、C、C++、JavaScripe等等二十几种编程语言的代码质量管理与检测；通过客户端插件分析源代码，sonar客户端可以采用IDE插件、Sonar-Scanner插件、Ant插件和Maven插件方式，并通过各种不同的分析机制对项目源代码进行分析和扫描，并把分析扫描后的结果上传到sonar的数据库，通过sonar web界面对分析结果进行管理。</p>
<span id="more"></span>
<p>可以从七个维度检测代码质量:</p>
<ul>
<li>复杂度分布(complexity):代码复杂度过高将难以理解</li>
<li>重复代码(duplications):程序中包含大量复制、粘贴的代码而导致代码臃肿，sonar可以展示源码中重复严重的地方</li>
<li>单元测试统计(unit tests):统计并展示单元测试覆盖率，开发或测试可以清楚测试代码的覆盖情况</li>
<li>代码规则检查(coding rules):通过Findbugs,PMD,CheckStyle等检查代码是否符合规范</li>
<li>注释率(comments):若代码注释过少，特别是人员变动后，其他人接手比较难接手；若过多，又不利于阅读</li>
<li>潜在的Bug(potential bugs):通过Findbugs,PMD,CheckStyle等检测潜在的bug</li>
<li>结构与设计(architecture &amp; design):找出循环，展示包与包、类与类之间的依赖、检查程序之间耦合度<!--more--></li>
</ul>
<h1 id="系统环境"><a href="#系统环境" class="headerlink" title="系统环境"></a>系统环境</h1><p>操作系统： CentOS 7.x<br>Msql Server:   5.7.17<br>Java	： JDK1.8<br>Sonar	： sonarqube-6.7.1.zip<br>Sonar-scanner：sonar-scanner-cli-3.0.3.778-linux.zip</p>
<h1 id="服务器安装"><a href="#服务器安装" class="headerlink" title="服务器安装"></a>服务器安装</h1><h2 id="安装MySQL服务器"><a href="#安装MySQL服务器" class="headerlink" title="安装MySQL服务器"></a>安装MySQL服务器</h2><p><em>MariaDB 10.2在安装过程中检测为Mysql 5.5，不能满足需求</em><br><code>wget http://download.softagency.net/MySQL/Downloads/MySQL-5.7/mysql-5.7.17-1.el7.x86_64.rpm-bundle.tar</code><br><code>tar xf mysql-5.7.17-1.el7.x86_64.rpm-bundle.tar</code><br><code>yum localinstall mysql-community-server-5.7.17-1.el7.x86_64.rpm mysql-community-client-5.7.17-1.el7.x86_64.rpm  mysql-community-common-5.7.17-1.el7.x86_64.rpm mysql-community-client-5.7.17-1.el7.x86_64.rpm mysql-community-libs-5.7.17-1.el7.x86_64.rpm</code><br><code>vim /etc/my.cnf</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#[mysqld]下添加一行 </span><br><span class="line">innodb_buffer_pool_size = 128M</span><br><span class="line">max_allowed_packet = 128M</span><br></pre></td></tr></table></figure>
<p>启动mysql服务<br><code>systemctl start mysqld</code><br>初始化mysql服务<br><code>mysql_secure_installation</code><br>默认密码在日志中可以看到<br><img src="/images/2018/0202/01.png" alt="sonar"><br>创建sonar数据库和用户，并赋予权限<br><code>mysql -uroot -p&#39;mysql_root_password&#39;</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql&gt; select version();</span><br><span class="line">mysql5.7密码强度比较高，我们做实验调整一下；设置一下复杂度和长度</span><br><span class="line">mysql&gt; set global validate_password_policy=0;</span><br><span class="line">mysql&gt; set global validate_password_length=1;</span><br><span class="line">mysql&gt; CREATE DATABASE `sonar` DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci;</span><br><span class="line">mysql&gt; CREATE USER &#x27;sonar&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;sonar&#x27;;</span><br><span class="line">mysql&gt; GRANT ALL ON sonar.* TO &#x27;sonar&#x27;@&#x27;%&#x27;;</span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">mysql -usonar -psonar -hlocalhost</span><br></pre></td></tr></table></figure>
<h2 id="安装JDK"><a href="#安装JDK" class="headerlink" title="安装JDK"></a>安装JDK</h2><p>下载地址：<a href="http://www.oracle.com/technetwork/java/archive-139210.html">http://www.oracle.com/technetwork/java/archive-139210.html</a><br><code>tar xf jdk-8u112-linux-x64.tar.gz -C /usr/local/</code><br><code>vim /etc/profile</code><br>添加以下三行环境变量</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">export JAVA_HOME=/usr/local/jdk1.8.0_112/</span><br><span class="line">export CLASSPATH=.:$JAVA_HOME/lib/:$JAVA_HOME/jre/lib/</span><br><span class="line">export PATH=$JAVA_HOME/bin:$PATH</span><br></pre></td></tr></table></figure>
<h2 id="安装sonar"><a href="#安装sonar" class="headerlink" title="安装sonar"></a>安装sonar</h2><h3 id="系统参数配置"><a href="#系统参数配置" class="headerlink" title="系统参数配置"></a>系统参数配置</h3><p>新建用户<br>sonar 不允许以root用户启动<br><code>useradd sonar</code><br><code>echo sonar|passwd --stdin sonar</code><br>修改内核参数<br><code>sysctl -w vm.max_map_count=262144</code><br><code>sysctl -w fs.file-max=65536</code><br>修改用户文件打开最大数<br><code>vim /etc/security/limits.conf</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sonar       hard    nofile           65536</span><br><span class="line">sonar       soft    nofile           65536</span><br></pre></td></tr></table></figure>
<h3 id="下载地址：https-www-sonarqube-org-downloads"><a href="#下载地址：https-www-sonarqube-org-downloads" class="headerlink" title="下载地址：https://www.sonarqube.org/downloads/"></a>下载地址：<a href="https://www.sonarqube.org/downloads/">https://www.sonarqube.org/downloads/</a></h3><p><code>unzip sonarqube-6.7.1.zip -d /usr/local</code></p>
<h3 id="配置sonar"><a href="#配置sonar" class="headerlink" title="配置sonar"></a>配置sonar</h3><p><code>vim /usr/local/sonarqube-6.7.1/conf/sonar.properties</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sonar.jdbc.username=sonar</span><br><span class="line">sonar.jdbc.password=sonar</span><br><span class="line">sonar.jdbc.url=jdbc:mysql://localhost:3306/sonar?useUnicode=true&amp;characterEncoding=utf8&amp;rewriteBatchedStatements=true&amp;useConfigs=maxPerformance&amp;useSSL=false</span><br><span class="line">sonar.web.host=0.0.0.0</span><br><span class="line">sonar.web.context=/sonar</span><br><span class="line">sonar.web.port=9000</span><br></pre></td></tr></table></figure>
<p><code>vim /usr/local/sonarqube-6.7.1/conf/wrapper.conf</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wrapper.java.command=/usr/local/jdk1.8.0_112/bin/java</span><br></pre></td></tr></table></figure>
<p><code>chown sonar.sonar /usr/local/sonarqube-6.7.1 -R</code><br>切换至sonar用户下<br><code>su - sonar</code><br>可以将此路径加入到环境变量中<br><code>cd /usr/local/sonarqube-6.7.1/bin/linux-x86-64</code><br><code>./sonar.sh start</code><br>可以监控&#x2F;usr&#x2F;local&#x2F;sonarqube-6.7.1&#x2F;logs目录下的log,第一次启动时间会长一些，因为要给数据库建表<br><code>访问地址http://192.168.6.178:9000/sonar/</code><br>默认用户名&#x2F;密码:   admin&#x2F;admin<br><img src="/images/2018/0202/02.png" alt="jenkins"><br>安装一个中文插件，安装完成后重启<br><img src="/images/2018/0202/03.png" alt="jenkins"><br><img src="/images/2018/0202/04.png" alt="jenkins"></p>
<h3 id="开启SCM"><a href="#开启SCM" class="headerlink" title="开启SCM"></a>开启SCM</h3><p><img src="/images/2018/0202/13.png" alt="jenkins"></p>
<h1 id="客户端SonarQube-Scanner安装"><a href="#客户端SonarQube-Scanner安装" class="headerlink" title="客户端SonarQube Scanner安装"></a>客户端SonarQube Scanner安装</h1><p>下载地址<a href="https://docs.sonarqube.org/display/SCAN/Analyzing+with+SonarQube+Scanner">https://docs.sonarqube.org/display/SCAN/Analyzing+with+SonarQube+Scanner</a><br>SonarQube Scanner作为客户端，放在一个可以读取代码的位置即可，可以和SonarQube 服务端放在一台机器上，也可以分开部署；</p>
<h2 id="配置sonarqube-scanner"><a href="#配置sonarqube-scanner" class="headerlink" title="配置sonarqube scanner"></a>配置sonarqube scanner</h2><p>我这里部署在本地windows系统上，将D:\Program Files (x86)\sonar-scanner-3.0.3.778-windows\bin加入到环境变量PATH中<br>编辑D:\Program Files (x86)\sonar-scanner-3.0.3.778-windows\conf\sonar-scanner.properties配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#Configure here general information about the environment, such as SonarQube DB details for example</span><br><span class="line">#No information about specific project should appear here</span><br><span class="line">#----- Default SonarQube server</span><br><span class="line">sonar.host.url=http://192.168.6.178:9000/sonar</span><br><span class="line">sonar.jdbc.username=sonar</span><br><span class="line">sonar.jdbc.password=sonar</span><br><span class="line">sonar.jdbc.url=jdbc:mysql://192.168.6.178:3306/sonar?useUnicode=true&amp;characterEncoding=utf8&amp;rewriteBatchedStatements=true&amp;useConfigs=maxPerformance&amp;useSSL=false</span><br><span class="line">#----- Default source code encoding</span><br><span class="line">sonar.sourceEncoding=UTF-8</span><br></pre></td></tr></table></figure>
<h2 id="配置项目"><a href="#配置项目" class="headerlink" title="配置项目"></a>配置项目</h2><p>在项目代码根目录下新建一个sonar-project.properties文件,内容如下<br><code>sonar.projectKey和sonar.projectName自己定义即可。</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># must be unique in a given SonarQube instance</span><br><span class="line">sonar.projectKey=silu</span><br><span class="line"># this is the name and version displayed in the SonarQube UI. Was mandatory prior to SonarQube 6.1.</span><br><span class="line">sonar.projectName=sxapp</span><br><span class="line">sonar.projectVersion=1.0</span><br><span class="line"> </span><br><span class="line"># Path is relative to the sonar-project.properties file. Replace &quot;\&quot; by &quot;/&quot; on Windows.</span><br><span class="line"># This property is optional if sonar.modules is set. </span><br><span class="line">sonar.sources=.</span><br><span class="line">sonar.language=java</span><br><span class="line"># Encoding of the source code. Default is default system encoding</span><br><span class="line">sonar.sourceEncoding=UTF-8</span><br></pre></td></tr></table></figure>
<h1 id="客户端SonarQube-Scanner使用"><a href="#客户端SonarQube-Scanner使用" class="headerlink" title="客户端SonarQube Scanner使用"></a>客户端SonarQube Scanner使用</h1><h2 id="用SonarQube-Scanner分析"><a href="#用SonarQube-Scanner分析" class="headerlink" title="用SonarQube Scanner分析"></a>用SonarQube Scanner分析</h2><p>在项目根目录下执行sonar-scanner即可开始代码监测<br><img src="/images/2018/0202/06.png" alt="jenkins"><br>在web页面上刷新一下就看到看到结果了<br><img src="/images/2018/0202/07.png" alt="jenkins"><br>**Q:**Please provide compiled classes of your project with sonar.java.binaries property<br><img src="/images/2018/0202/05.png" alt="jenkins"><br>**A:**这是因为sonar-java插件太新了，可以下载一个旧版本的插件进行替换<br><a href="https://sonarsource.bintray.com/Distribution/sonar-java-plugin/sonar-java-plugin-4.10.0.10260.jar">https://sonarsource.bintray.com/Distribution/sonar-java-plugin/sonar-java-plugin-4.10.0.10260.jar</a><br>下载完成后拷贝到C:\Users\nsxq.sonar\cache\2936e4ebd1e34b1646a3b66a51d30af7\ （类似这个）目录下，<br>并修改名称为sonar-java-plugin-4.15.0.12310.jar(不要问我为什么要改成这个版本号，因为运行sonar-scanner提示是这个版本号)</p>
<h2 id="用Maven调用SonarQube-Scanner分析"><a href="#用Maven调用SonarQube-Scanner分析" class="headerlink" title="用Maven调用SonarQube Scanner分析"></a>用Maven调用SonarQube Scanner分析</h2><h3 id="安装maven3"><a href="#安装maven3" class="headerlink" title="安装maven3"></a>安装maven3</h3><p>下载地址<a href="http://apache.mirrors.lucidnetworks.net/maven/maven-3/">http://apache.mirrors.lucidnetworks.net/maven/maven-3/</a><br>下载完成解压后，配置环境变量，验证</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mvn --version</span><br><span class="line">Apache Maven 3.3.9 (bb52d8502b132ec0a5a3f4c09453c07478323dc5; 2015-11-11T00:41:47+08:00)</span><br><span class="line">Maven home: D:\Program Files (x86)\apache-maven-3.3.9-bin\apache-maven-3.3.9\bin\..</span><br><span class="line">Java version: 1.8.0_141, vendor: Oracle Corporation</span><br><span class="line">Java home: C:\Program Files\Java\jdk1.8.0_141\jre</span><br><span class="line">Default locale: zh_CN, platform encoding: GBK</span><br><span class="line">OS name: &quot;windows 10&quot;, version: &quot;10.0&quot;, arch: &quot;amd64&quot;, family: &quot;dos&quot;</span><br></pre></td></tr></table></figure>
<h3 id="配置maven全局设置settings-xml"><a href="#配置maven全局设置settings-xml" class="headerlink" title="配置maven全局设置settings.xml"></a>配置maven全局设置settings.xml</h3><p>添加以下配置到本来的settings.xml</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;settings&gt;</span><br><span class="line">    &lt;pluginGroups&gt;</span><br><span class="line">        &lt;pluginGroup&gt;org.sonarsource.scanner.maven&lt;/pluginGroup&gt;</span><br><span class="line">    &lt;/pluginGroups&gt;</span><br><span class="line">    &lt;profiles&gt;</span><br><span class="line">        &lt;profile&gt;</span><br><span class="line">            &lt;id&gt;sonar&lt;/id&gt;</span><br><span class="line">            &lt;activation&gt;</span><br><span class="line">                &lt;activeByDefault&gt;true&lt;/activeByDefault&gt;</span><br><span class="line">            &lt;/activation&gt;</span><br><span class="line">            &lt;properties&gt;</span><br><span class="line">                &lt;!-- Optional URL to server. Default value is http://localhost:9000 --&gt;</span><br><span class="line">                &lt;sonar.host.url&gt;</span><br><span class="line">                  http://myserver:9000</span><br><span class="line">                &lt;/sonar.host.url&gt;</span><br><span class="line">            &lt;/properties&gt;</span><br><span class="line">        &lt;/profile&gt;</span><br><span class="line">     &lt;/profiles&gt;</span><br><span class="line">&lt;/settings&gt;</span><br></pre></td></tr></table></figure>
<p>添加完成后，我的配置文件如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;settings</span><br><span class="line">	xsi:schemaLocation=&quot;http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd&quot;</span><br><span class="line">	xmlns=&quot;http://maven.apache.org/SETTINGS/1.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&gt;</span><br><span class="line">	&lt;localRepository&gt;C:\Users\nsxq\.m2\repository\&lt;/localRepository&gt;</span><br><span class="line">	&lt;pluginGroups&gt;</span><br><span class="line">        &lt;pluginGroup&gt;org.sonarsource.scanner.maven&lt;/pluginGroup&gt;</span><br><span class="line">    &lt;/pluginGroups&gt;</span><br><span class="line">	&lt;servers&gt;</span><br><span class="line">		&lt;server&gt;</span><br><span class="line">			&lt;username&gt;test&lt;/username&gt;</span><br><span class="line">			&lt;password&gt;test&lt;/password&gt;</span><br><span class="line">			&lt;id&gt;THSArtifactory&lt;/id&gt;</span><br><span class="line">		&lt;/server&gt;</span><br><span class="line">	&lt;/servers&gt;</span><br><span class="line">	&lt;mirrors&gt;</span><br><span class="line">		&lt;mirror&gt;</span><br><span class="line">			&lt;mirrorOf&gt;*&lt;/mirrorOf&gt;</span><br><span class="line">			&lt;name&gt;ths-repos&lt;/name&gt;</span><br><span class="line">			&lt;url&gt;http://192.168.0.45/artifactory/ths-repos&lt;/url&gt;</span><br><span class="line">			&lt;id&gt;THSArtifactory&lt;/id&gt;</span><br><span class="line">		&lt;/mirror&gt;</span><br><span class="line">		&lt;mirror&gt;</span><br><span class="line">       			&lt;id&gt;alimaven&lt;/id&gt;</span><br><span class="line">      			&lt;mirrorOf&gt;central&lt;/mirrorOf&gt;</span><br><span class="line">      			&lt;name&gt;aliyun maven&lt;/name&gt;</span><br><span class="line">       			&lt;url&gt;http://maven.aliyun.com/nexus/content/repositories/central/&lt;/url&gt;</span><br><span class="line"> 		  &lt;/mirror&gt;</span><br><span class="line">	&lt;/mirrors&gt;</span><br><span class="line">	&lt;profiles&gt;</span><br><span class="line">		&lt;profile&gt;</span><br><span class="line">			&lt;repositories&gt;</span><br><span class="line">				&lt;repository&gt;</span><br><span class="line">					&lt;snapshots&gt;</span><br><span class="line">						&lt;enabled&gt;false&lt;/enabled&gt;</span><br><span class="line">					&lt;/snapshots&gt;</span><br><span class="line">					&lt;id&gt;central&lt;/id&gt;</span><br><span class="line">					&lt;name&gt;ths-repos&lt;/name&gt;</span><br><span class="line">					&lt;url&gt;http://192.168.0.45/artifactory/ths-repos&lt;/url&gt;</span><br><span class="line">				&lt;/repository&gt;</span><br><span class="line">				&lt;repository&gt;</span><br><span class="line">					&lt;snapshots /&gt;</span><br><span class="line">					&lt;id&gt;snapshots&lt;/id&gt;</span><br><span class="line">					&lt;name&gt;ths-repos&lt;/name&gt;</span><br><span class="line">					&lt;url&gt;http://192.168.0.45/artifactory/ths-repos&lt;/url&gt;</span><br><span class="line">				&lt;/repository&gt;</span><br><span class="line">			&lt;/repositories&gt;</span><br><span class="line">			&lt;pluginRepositories&gt;</span><br><span class="line">				&lt;pluginRepository&gt;</span><br><span class="line">					&lt;snapshots&gt;</span><br><span class="line">						&lt;enabled&gt;false&lt;/enabled&gt;</span><br><span class="line">					&lt;/snapshots&gt;</span><br><span class="line">					&lt;id&gt;central&lt;/id&gt;</span><br><span class="line">					&lt;name&gt;ths-repos&lt;/name&gt;</span><br><span class="line">					&lt;url&gt;http://192.168.0.45/artifactory/ths-repos&lt;/url&gt;</span><br><span class="line">				&lt;/pluginRepository&gt;</span><br><span class="line">				&lt;pluginRepository&gt;</span><br><span class="line">					&lt;snapshots /&gt;</span><br><span class="line">					&lt;id&gt;snapshots&lt;/id&gt;</span><br><span class="line">					&lt;name&gt;ths-repos&lt;/name&gt;</span><br><span class="line">					&lt;url&gt;http://192.168.0.45/artifactory/ths-repos&lt;/url&gt;</span><br><span class="line">				&lt;/pluginRepository&gt;</span><br><span class="line">			&lt;/pluginRepositories&gt;</span><br><span class="line">			&lt;id&gt;artifactory&lt;/id&gt;</span><br><span class="line">		&lt;/profile&gt;</span><br><span class="line">        &lt;profile&gt;</span><br><span class="line">            &lt;id&gt;sonar&lt;/id&gt;</span><br><span class="line">            &lt;activation&gt;</span><br><span class="line">                &lt;activeByDefault&gt;true&lt;/activeByDefault&gt;</span><br><span class="line">            &lt;/activation&gt;</span><br><span class="line">            &lt;properties&gt;</span><br><span class="line">                &lt;!-- Optional URL to server. Default value is http://localhost:9000 --&gt;</span><br><span class="line">                &lt;sonar.host.url&gt;</span><br><span class="line">                  http://192.168.6.178:9000/sonar</span><br><span class="line">                &lt;/sonar.host.url&gt;</span><br><span class="line">            &lt;/properties&gt;</span><br><span class="line">        &lt;/profile&gt;</span><br><span class="line">	&lt;/profiles&gt;</span><br><span class="line">	&lt;activeProfiles&gt;</span><br><span class="line">		&lt;activeProfile&gt;artifactory&lt;/activeProfile&gt;</span><br><span class="line">	&lt;/activeProfiles&gt;</span><br><span class="line">&lt;/settings&gt; </span><br></pre></td></tr></table></figure>
<h3 id="测试maven项目"><a href="#测试maven项目" class="headerlink" title="测试maven项目"></a>测试maven项目</h3><p>下载一个maven测试项目代码<br><code>git clone https://github.com/SonarSource/sonar-scanning-examples.git</code><br><code>cd D:\sonar-scanning-examples\sonarqube-scanner-maven</code><br><code>mvn clean install sonar:sonar</code><br><img src="/images/2018/0202/08.png" alt="jenkins"><br>web页面查看<br><img src="/images/2018/0202/09.png" alt="jenkins"></p>
<h2 id="用Jenkins调用SonarQube-Scanner分析"><a href="#用Jenkins调用SonarQube-Scanner分析" class="headerlink" title="用Jenkins调用SonarQube Scanner分析"></a>用Jenkins调用SonarQube Scanner分析</h2><h3 id="安装sonarqube插件"><a href="#安装sonarqube插件" class="headerlink" title="安装sonarqube插件"></a>安装sonarqube插件</h3><p>系统管理–&gt;管理插件–&gt;可选插件<br>SonarQube Scanner for Jenkins<br>Mashup Portlets</p>
<h3 id="配置SonarQube-servers"><a href="#配置SonarQube-servers" class="headerlink" title="配置SonarQube servers"></a>配置SonarQube servers</h3><p>系统管理–&gt;系统配置–&gt;SonarQube servers<br><img src="/images/2018/0202/10.png" alt="jenkins"><br>系统管理–&gt;全局工具配置–&gt;SonarQube Scanner<br><img src="/images/2018/0202/11.png" alt="jenkins"><br>JOB配置<br><img src="/images/2018/0202/14.png" alt="jenkins"><br><img src="/images/2018/0202/15.png" alt="jenkins"><br>key,name,version三个字段是自定义的，sources路径是当前路径的话，用.表示就可以了；</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sonar.projectKey=ths.project</span><br><span class="line">sonar.projectName=AirForcast</span><br><span class="line">sonar.projectVersion=1.0</span><br><span class="line">sonar.language=java</span><br><span class="line">sonar.java.binaries=./target/test-classes/ </span><br><span class="line">sonar.sources=.</span><br></pre></td></tr></table></figure>
<p><img src="/images/2018/0202/16.png" alt="jenkins"><br><img src="/images/2018/0202/17.png" alt="jenkins"><br>点击查看监测结果！</p>
<h1 id="其他问题"><a href="#其他问题" class="headerlink" title="其他问题"></a>其他问题</h1><p><strong>Q1：</strong><br>ERROR web[][o.s.s.p.Platform] Web server startup failed: Unsupported mysql version: 5.5. Minimal supported version is 5.6.<br><strong>A1:</strong><br>不要使用mariadb，mariadb10.2检测到是mysql5.5<br><strong>Q2:</strong><br>Native memory allocation (mmap) failed to map 42467328 bytes for committing reserved memory.<br><strong>A2:</strong><br>1.将虚拟机内存调整大，调整到4Gb；<br>2.保证swap空间正常（我安装操作系统的时候没有设置swap分区，折腾了好一会儿）；<br>3.修改此文件中的&#x2F;usr&#x2F;local&#x2F;sonarqube-6.7.1&#x2F;elasticsearch&#x2F;config&#x2F;jvm.options     -Xms512m -Xmx512m<br><strong>Q3:</strong><br>mvn clean install sonar:sonar 上传分析数据时候报错。可以查看sonar日志web.log相关报错“Failed to upload report - 500: An error has occurred. Please contact your administrator”<br><img src="/images/2018/0202/12.png" alt="jenkins"><br><strong>A3:</strong><br>1.修改mysqld参数max_allowed_packet &#x3D; 128M<br>2.重启mysqld服务<br>3.重启sonarqube服务（一定要重启）</p>
<p>参考链接：<br><a href="https://docs.sonarqube.org/display/SONAR/Installing+the+Server">https://docs.sonarqube.org/display/SONAR/Installing+the+Server</a><br><a href="https://docs.sonarqube.org/display/SCAN/Analyzing+with+SonarQube+Scanner">https://docs.sonarqube.org/display/SCAN/Analyzing+with+SonarQube+Scanner</a><br><a href="https://my.oschina.net/zxcholmes/blog/1529732">https://my.oschina.net/zxcholmes/blog/1529732</a><br><a href="https://www.ibm.com/developerworks/cn/devops/1612_qusm_jenkins/index.html">https://www.ibm.com/developerworks/cn/devops/1612_qusm_jenkins/index.html</a><br><a href="https://ken.io/note/jenkins-maven-java-sonar-integration">https://ken.io/note/jenkins-maven-java-sonar-integration</a></p>
]]></content>
      <categories>
        <category>自动化运维</category>
      </categories>
      <tags>
        <tag>运维</tag>
        <tag>自动化</tag>
        <tag>Sonar</tag>
      </tags>
  </entry>
  <entry>
    <title>Zabbix(9)结合sensor监控cpu温度</title>
    <url>/arlo/ce74a028/</url>
    <content><![CDATA[<p>zabbix 可以通过sensors-detect检测内核模块，使用zabbix监控系统自定义监控项，采集监控数据并设置告警。可以监控物理机器(虚拟机获取不到)的温度。</p>
<span id="more"></span>
<h1 id="安装sensors"><a href="#安装sensors" class="headerlink" title="安装sensors"></a>安装sensors</h1><p>安装、运行sensors，可以看到每颗cpu的温度</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@siluxa2 src]# yum install lm_sensors</span><br><span class="line">[root@siluxa2 src]# sensors</span><br><span class="line">i350bb-pci-0100</span><br><span class="line">Adapter: PCI adapter</span><br><span class="line">loc1:         +50.0°C  (high = +120.0°C, crit = +110.0°C)</span><br><span class="line"></span><br><span class="line">coretemp-isa-0000</span><br><span class="line">Adapter: ISA adapter</span><br><span class="line">Physical id 0:  +55.0°C  (high = +80.0°C, crit = +90.0°C)</span><br><span class="line">Core 0:         +45.0°C  (high = +80.0°C, crit = +90.0°C)</span><br><span class="line">Core 1:         +46.0°C  (high = +80.0°C, crit = +90.0°C)</span><br><span class="line">Core 2:         +45.0°C  (high = +80.0°C, crit = +90.0°C)</span><br><span class="line">Core 3:         +46.0°C  (high = +80.0°C, crit = +90.0°C)</span><br><span class="line">Core 4:         +46.0°C  (high = +80.0°C, crit = +90.0°C)</span><br><span class="line">Core 8:         +46.0°C  (high = +80.0°C, crit = +90.0°C)</span><br><span class="line">Core 9:         +46.0°C  (high = +80.0°C, crit = +90.0°C)</span><br><span class="line">Core 10:        +46.0°C  (high = +80.0°C, crit = +90.0°C)</span><br><span class="line">Core 11:        +44.0°C  (high = +80.0°C, crit = +90.0°C)</span><br><span class="line">Core 12:        +45.0°C  (high = +80.0°C, crit = +90.0°C)</span><br><span class="line"></span><br><span class="line">coretemp-isa-0001</span><br><span class="line">Adapter: ISA adapter</span><br><span class="line">Physical id 1:  +49.0°C  (high = +80.0°C, crit = +90.0°C)</span><br><span class="line">Core 0:         +42.0°C  (high = +80.0°C, crit = +90.0°C)</span><br><span class="line">Core 1:         +41.0°C  (high = +80.0°C, crit = +90.0°C)</span><br><span class="line">Core 2:         +41.0°C  (high = +80.0°C, crit = +90.0°C)</span><br><span class="line">Core 3:         +41.0°C  (high = +80.0°C, crit = +90.0°C)</span><br><span class="line">Core 4:         +42.0°C  (high = +80.0°C, crit = +90.0°C)</span><br><span class="line">Core 8:         +41.0°C  (high = +80.0°C, crit = +90.0°C)</span><br><span class="line">Core 9:         +42.0°C  (high = +80.0°C, crit = +90.0°C)</span><br><span class="line">Core 10:        +41.0°C  (high = +80.0°C, crit = +90.0°C)</span><br><span class="line">Core 11:        +41.0°C  (high = +80.0°C, crit = +90.0°C)</span><br><span class="line">Core 12:        +41.0°C  (high = +80.0°C, crit = +90.0°C)</span><br></pre></td></tr></table></figure>
<h1 id="配置zabbix-agent客户端文件"><a href="#配置zabbix-agent客户端文件" class="headerlink" title="配置zabbix agent客户端文件"></a>配置zabbix agent客户端文件</h1><p>修改客户端配置文件zabbix_agentd.conf<br>第一次自定义监控时要设置 </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">UnsafeUserParameters=1</span><br></pre></td></tr></table></figure>
<p>在配置文件中添加一行：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">UserParameter=get_temp_cpu[*],sensors|grep &quot;Physical id $1&quot;|cut -c 17-20</span><br></pre></td></tr></table></figure>
<h1 id="添加监控项"><a href="#添加监控项" class="headerlink" title="添加监控项"></a>添加监控项</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sensor[device,sensor,&lt;mode&gt;]</span><br><span class="line">读取硬件传感器</span><br><span class="line">device - 设备名称  </span><br><span class="line">sensor - 传感器名称  </span><br><span class="line">mode - 可选值:avg, max, min</span><br><span class="line">示例key: sensor[w83781d-i2c-0-2d,temp1] Prior to Zabbix 1.8.4, the sensor[temp1] format was used. On Linux 2.6+, 读取/sys/class/hwmon. On OpenBSD, 读取hw.sensors MIB.示例keys: sensor[cpu0,temp0] – CPU0的温度 sensor[cpu[0-2]$,temp,avg] – cpu平均温度Zabbix 1.8.4开始支持OpenBSD</span><br></pre></td></tr></table></figure>
<p>我这里添加两颗cpu为例！<br><img src="/images/2018/0419/01.png" alt="z"><br><img src="/images/2018/0419/02.png" alt="z"></p>
<h1 id="添加触发器"><a href="#添加触发器" class="headerlink" title="添加触发器"></a>添加触发器</h1><p><img src="/images/2018/0419/03.png" alt="z"><br><img src="/images/2018/0419/04.png" alt="z"></p>
<h1 id="添加图形"><a href="#添加图形" class="headerlink" title="添加图形"></a>添加图形</h1><p><img src="/images/2018/0419/05.png" alt="z"></p>
<h1 id="查看图形"><a href="#查看图形" class="headerlink" title="查看图形"></a>查看图形</h1><p><img src="/images/2018/0419/06.png" alt="z"></p>
<p>参考链接：<a href="http://xy.uyun.cn/post/1865.html">http://xy.uyun.cn/post/1865.html</a></p>
]]></content>
      <categories>
        <category>监控</category>
      </categories>
      <tags>
        <tag>zabbix</tag>
        <tag>运维</tag>
        <tag>自动化</tag>
      </tags>
  </entry>
  <entry>
    <title>Zabbix(8)使用ansible批量部署zabbix agent</title>
    <url>/arlo/7c94dafb/</url>
    <content><![CDATA[<p>相同系统环境部署zabbix agent，可以使用ansible playbook来实现，大概分为以下几步。</p>
<span id="more"></span>
<h1 id="ansible-目录结构"><a href="#ansible-目录结构" class="headerlink" title="ansible 目录结构"></a>ansible 目录结构</h1><p>[root@sl_confluence ansible]# pwd<br>&#x2F;etc&#x2F;ansible<br>[root@sl_confluence ansible]# tree</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">├── ansible.cfg</span><br><span class="line">├── hosts</span><br><span class="line">├── roles</span><br><span class="line">│   └── zabbix_agent</span><br><span class="line">│       ├── files</span><br><span class="line">│       │   └── zabbix-agent-3.4.8-1.el6.x86_64.rpm</span><br><span class="line">│       ├── tasks</span><br><span class="line">│       │   └── main.yml</span><br><span class="line">│       └── templates</span><br><span class="line">│           └── zabbix_agentd.conf.j2</span><br><span class="line">└── zabbix_agent.yml</span><br><span class="line"></span><br><span class="line">5 directories, 6 files</span><br></pre></td></tr></table></figure>
<h1 id="查看-hosts文件"><a href="#查看-hosts文件" class="headerlink" title="查看 hosts文件"></a>查看 hosts文件</h1><p>[root@sl_confluence ansible]#  cat hosts</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[zabbix_agent]</span><br><span class="line">dbserver</span><br></pre></td></tr></table></figure>
<p>[root@sl_confluence ansible]# cat zabbix_agent.yml </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">- hosts: zabbix_agent</span><br><span class="line">  user: root</span><br><span class="line">  vars:</span><br><span class="line">     zabbix_serverip: 192.168.6.186 # zabbix 服务器IP</span><br><span class="line">     zabbix_activeip: 192.168.6.186 # zabbix 服务器IP</span><br><span class="line">     agent_hostname: &#x27;&#123;&#123; ansible_hostname &#125;&#125;&#x27; # 客户端hostname</span><br><span class="line">     agent_ip: &#x27;&#123;&#123; ansible_eth0.ipv4.address &#125;&#125;&#x27; # 客户端IP 根据实际情况修改自己的网卡名字eth0 改成自己服务器</span><br><span class="line">  roles:</span><br><span class="line">    - zabbix_agent</span><br></pre></td></tr></table></figure>
<p>[root@sl_confluence tasks]# cat main.yml </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">- name: copy zabbix_agentd </span><br><span class="line">  copy: src=/etc/ansible/roles/zabbix_agent/files/zabbix-agent-3.4.8-1.el6.x86_64.rpm dest=/usr/local/src/zabbix-agent-3.4.8-1.el6.x86_64.rpm</span><br><span class="line">- name: install zabbix-agend</span><br><span class="line">  shell: rpm -ivh /usr/local/src/zabbix-agent-3.4.8-1.el6.x86_64.rpm # 安装zabbix agentd</span><br><span class="line">- name: up zabbix-agent file client  # 上传配置文件</span><br><span class="line">  template: src=zabbix_agentd.conf.j2 dest=/etc/zabbix/zabbix_agentd.conf</span><br><span class="line">- name: enabled service zabbix-agent # 打开zabbix-agent 开机启动</span><br><span class="line">  service: name=zabbix-agent enabled=yes</span><br><span class="line">- name: start  service zabbix-agent # 启动zabbix-agent</span><br><span class="line">  service: name=zabbix-agent  state=started</span><br></pre></td></tr></table></figure>
<h1 id="定义zabbix-agent-conf模板文件"><a href="#定义zabbix-agent-conf模板文件" class="headerlink" title="定义zabbix_agent.conf模板文件"></a>定义zabbix_agent.conf模板文件</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sl_confluence templates]# cat zabbix_agentd.conf.j2 </span><br><span class="line">PidFile=/var/run/zabbix/zabbix_agentd.pid</span><br><span class="line">LogFile=/var/log/zabbix/zabbix_agentd.log</span><br><span class="line">EnableRemoteCommands=1</span><br><span class="line">Server=&#123;&#123;zabbix_serverip&#125;&#125;</span><br><span class="line">ListenPort=10050</span><br><span class="line">ServerActive=&#123;&#123;zabbix_activeip&#125;&#125;</span><br><span class="line">Hostname=&#123;&#123;ansible_hostname&#125;&#125;</span><br><span class="line">AllowRoot=1</span><br><span class="line">Include=/etc/zabbix/zabbix_agentd.d/*.conf</span><br></pre></td></tr></table></figure>
<h1 id="执行安装"><a href="#执行安装" class="headerlink" title="执行安装"></a>执行安装</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ansible-playbook zabbix_agent.yml</span><br></pre></td></tr></table></figure>
<p><img src="/images/2018/0417/04.png" alt="z"></p>
]]></content>
      <categories>
        <category>监控</category>
      </categories>
      <tags>
        <tag>zabbix</tag>
        <tag>运维</tag>
        <tag>自动化</tag>
        <tag>Ansible</tag>
      </tags>
  </entry>
  <entry>
    <title>expdp/impdp数据泵工具运用</title>
    <url>/arlo/2148c304/</url>
    <content><![CDATA[<p>Oracle数据库常用的备份方式有，exp&#x2F;imp, expdp&#x2F;impdp和rman；<br>RMAN备份内容包括:整个数据库,表空间,数据文件,指定的数据文件,控制文件,归档日志文件,参数文件等，打开归档日志后，可以做到不丢失数据，后期再详细分析研究。</p>
<span id="more"></span>
<p>使用expdp和impdp时应该注重的事项：<br>1、exp和imp是客户端工具程序，它们既可以在客户端使用，也可以在服务端使用。<br>2、expdp和impdp是服务端的工具程序，他们只能在oracle服务端使用，不能在客户端使用。<br>3、imp只适用于exp导出的文件，不适用于expdp导出文件；impdp只适用于expdp导出的文件，而不适用于exp导出文件。<br>4、对于10g以上的服务器，使用exp通常不能导出0行数据的空表，而此时必须使用expdp导出。</p>
<h1 id="查询备份和恢复数据库的数据库信息"><a href="#查询备份和恢复数据库的数据库信息" class="headerlink" title="查询备份和恢复数据库的数据库信息"></a>查询备份和恢复数据库的数据库信息</h1><p>尽量保证数据库的版本和字符集等信息一致，否则会有很多坑。</p>
<h2 id="查看数据库的版本"><a href="#查看数据库的版本" class="headerlink" title="查看数据库的版本"></a>查看数据库的版本</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select * from v$version;</span><br></pre></td></tr></table></figure>
<h2 id="查看数据库编码"><a href="#查看数据库编码" class="headerlink" title="查看数据库编码"></a>查看数据库编码</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT * FROM V$NLS_PARAMETERS WHERE PARAMETER IN (&#x27;NLS_CHARACTERSET&#x27;, &#x27;NLS_NCHAR_CHARACTERSET&#x27;);</span><br></pre></td></tr></table></figure>
<h1 id="查看管理员目录"><a href="#查看管理员目录" class="headerlink" title="查看管理员目录"></a>查看管理员目录</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sqlplus / as sysdba</span><br><span class="line">SQL&gt; select * from dba_directories;</span><br></pre></td></tr></table></figure>
<h1 id="创建管理员目录并授权"><a href="#创建管理员目录并授权" class="headerlink" title="创建管理员目录并授权"></a>创建管理员目录并授权</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SQL&gt; create directory dump_dir as &#x27;/opt/db_backup&#x27;;  #可以使用默认的目录，也可以自己新建目录</span><br><span class="line">SQL&gt; grant read,write on directory dump_dir to scott;</span><br></pre></td></tr></table></figure>
<h1 id="使用expdp导出数据"><a href="#使用expdp导出数据" class="headerlink" title="使用expdp导出数据"></a>使用expdp导出数据</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1)导出用户</span><br><span class="line">expdp scott/tiger@orcl schemas=scott dumpfile=expdp.dmp directory=dump_dir</span><br><span class="line">expdp userid=&quot;&#x27;sys/passwd@orcl as sysdba&#x27;&quot;  schemas=scott dumpfile=scott.dmp directory=DATA_PUMP_DIR   #使用sys用户导出写法</span><br><span class="line">2)导出表</span><br><span class="line">expdp scott/tiger@orcl tables=emp,dept dumpfile=expdp.dmp directory=dump_dir</span><br><span class="line">3)按查询条件导</span><br><span class="line">expdp scott/tiger@orcl directory=dump_dir dumpfile=expdp.dmp tables=emp query=&#x27;where deptno=20&#x27;</span><br><span class="line">4)按表空间导</span><br><span class="line">expdp system/manager@orcl directory=dump_dir dumpfile=tablespace.dmp tablespaces=temp,example</span><br><span class="line">5)导整个数据库</span><br><span class="line">expdp system/manager@orcl directory=dump_dir dumpfile=full.dmp full=y;</span><br><span class="line">expdp userid=&quot;&#x27;sys/passwd@orcl as sysdba&#x27;&quot; full=y directory=DATA_PUMP_DIR dumpfile=full.dmp	#使用sys用户导出写法</span><br></pre></td></tr></table></figure>
<h1 id="用impdp导入数据"><a href="#用impdp导入数据" class="headerlink" title="用impdp导入数据"></a>用impdp导入数据</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1)导入用户（从用户scott导入到用户scott）</span><br><span class="line">impdp scott/tiger@orcl directory=dump_dir dumpfile=expdp.dmp schemas=scott</span><br><span class="line">impdp userid=&quot;&#x27;sys/passwd@orcl as sysdba&#x27;&quot; schemas=scott dumpfile=scott.dmp directory=DATA_PUMP_DIR	#使用sys用户导出写法</span><br><span class="line">2)导入表（从scott用户中把表dept和emp导入到system用户中）</span><br><span class="line">impdp system/manager@orcl directory=dump_dir dumpfile=expdp.dmp tables=scott.dept,scott.emp remap_schema=scott:system</span><br><span class="line">3)导入表空间</span><br><span class="line">impdp system/manager@orcl directory=dump_dir dumpfile=tablespace.dmp tablespaces=example</span><br><span class="line">4)导入数据</span><br><span class="line">impdb system/manager@orcl directory=dump_dir dumpfile=full.dmp full=y</span><br><span class="line">impdp userid=&quot;&#x27;sys/passwd@orcl as sysdba&#x27;&quot; full=y directory=DATA_PUMP_DIR dumpfile=full.dmp</span><br><span class="line">5)追加数据</span><br><span class="line">impdp system/manager@orcl directory=dump_dir dumpfile=expdp.dmp schemas=system table_exists_action</span><br><span class="line"></span><br><span class="line">--#####--</span><br><span class="line">--如果要导到的用户与导出dumpfile的用户名不一样则要使用remap_schema代替schemas，将旧用户名指向新用户名：</span><br><span class="line">impdp user_new/pass_new directory=impexp dumpfile=lsdb.dmp loggfile=lsdb.log remap_schema=user_old:user_new</span><br><span class="line"></span><br><span class="line">--如果要导到的表空间名称不一样，则要使用remap_tablespace将旧表空间名指向新表空间名：</span><br><span class="line">impdp ls/lsdb123# directory=impexp dumpfile=lsdb.dmp loggfile=lsdb.log schemas=ls remap_tablespace=tablespace_old:tablespace_new</span><br><span class="line"></span><br><span class="line">--如果要导到的用户名和表空间名与原来导出时的都不一样，那么要同时使用remap_schema和remap_tablespace：</span><br><span class="line">impdp user_new/pass_new directory=impexp dumpfile=lsdb.dmp logfile=lsdb.log remap_schema=user_old:user_new  remap_tablespace=tablespace_old:tablespace_new</span><br><span class="line"></span><br><span class="line">--如果导出的dmp文件中有多个表空间，那么remap_tablespace写多个：</span><br><span class="line">impdp ls/lsdb123# directory=impexp dumpfile=lsdb.dmp loggfile=lsdb.log schemas=ls remap_tablespace=&#x27;(tablespace_old1:tablespace_new1,tablespace_old2:tablespace_new2)&#x27;</span><br><span class="line"></span><br><span class="line">--如果原先已有数据，想使用覆盖导入使用table_exists_action=replace：</span><br><span class="line">impdp ls/lsdb123# directory=impexp dumpfile= lsdb.dmp logfile= lsdb.log  schemas= ls table_exists_action=replace</span><br><span class="line"></span><br><span class="line">--如果expdp限制了单个文件大小使用%U导出多个文件（比如6个），则导入：</span><br><span class="line">impdp lsdb/lsdb123# directory=impexp dumpfile=lsdb_%U.dmp logfile= lsdb.log  schemas= lsdb  parallel=6</span><br></pre></td></tr></table></figure>
<h1 id="expdp的compression参数选项（压缩）"><a href="#expdp的compression参数选项（压缩）" class="headerlink" title="expdp的compression参数选项（压缩）"></a>expdp的compression参数选项（压缩）</h1><p>*** COMPRESSION&#x3D;[ALL | DATA_ONLY | METADATA_ONLY | NONE] ***<br>Oracle 11g中新增了几种压缩方法。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ALL: 对导出的元数据和表数据都进行压缩，得到的导出文件是最小的，耗时也是最长的。（据说压缩比可以达到 1/7）</span><br><span class="line">DATA_ONLY: 仅对表数据进行压缩，对于大数据量的导出效果明显，会比METADATA_ONLY方式得到更小的压缩文件。</span><br><span class="line">METADATA_ONLY: 仅对元数据进行压缩，而不会对表数据进行压缩，这种压缩执行后效果一般不是很明显，不过速度比较快。</span><br><span class="line">NONE: 不进行任何的压缩，导出后的文件也是最大的。</span><br><span class="line">DEFAULT: 默认方式，即不指定COMPRESSION参数，会采用默认的压缩方式METADATA_ONLY。</span><br></pre></td></tr></table></figure>
<h1 id="impdp的TABLE-EXISTS-ACTION参数选项"><a href="#impdp的TABLE-EXISTS-ACTION参数选项" class="headerlink" title="impdp的TABLE_EXISTS_ACTION参数选项"></a>impdp的TABLE_EXISTS_ACTION参数选项</h1><p>默认值是skip，但若设置了CONTENT&#x3D;DATA_ONLY，则默认值是APPEND，不是SKIP。<br>*** TABLE_EXISTS_ACTION&#x3D;[SKIP | APPEND | TRUNCATE | REPLACE] ***</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SKIP：跳过这张表，继续下一个对象。如果CONTENT设置了DATA_ONLY参数，则不能使用SKIP。</span><br><span class="line">APPEND：会加载数据至对象，但不会影响已存在的行。</span><br><span class="line">TRUNCATE：删除已存在的行，然后加载所有的数据。</span><br><span class="line">REPLACE：drop已存在的表，然后create并加载数据。如果CONTENT设置了DATA_ONLY，则不能使用REPLACE。</span><br></pre></td></tr></table></figure>
<h1 id="导入过程中，常用查询语句"><a href="#导入过程中，常用查询语句" class="headerlink" title="导入过程中，常用查询语句"></a>导入过程中，常用查询语句</h1><h2 id="查询表空间使用量，如果不够，可以添加文件"><a href="#查询表空间使用量，如果不够，可以添加文件" class="headerlink" title="查询表空间使用量，如果不够，可以添加文件"></a>查询表空间使用量，如果不够，可以添加文件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT FILE_NAME, TABLESPACE_NAME, BYTES / 1024 / 1024 &quot;bytes MB&quot;,MAXBYTES / 1024 / 1024 &quot;maxbytes MB&quot;  FROM DBA_DATA_FILES WHERE TABLESPACE_NAME = &#x27;USERS&#x27;;</span><br><span class="line">ALTER TABLESPACE USERS ADD DATAFILE &#x27;/u01/app/oracle/oradata/sjzdb/users02.dbf&#x27; SIZE 5M AUTOEXTEND ON MAXSIZE 32767M;</span><br></pre></td></tr></table></figure>
<h2 id="查看SCHEMAS占用的表空间大小"><a href="#查看SCHEMAS占用的表空间大小" class="headerlink" title="查看SCHEMAS占用的表空间大小"></a>查看SCHEMAS占用的表空间大小</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT OWNER, SUM(BYTES) / 1024 / 1024 / 1024 SCHEMA_SIZE_GIG  FROM SYS.DBA_SEGMENTS GROUP BY OWNER;</span><br></pre></td></tr></table></figure>
<h2 id="查询schemas下的所有表"><a href="#查询schemas下的所有表" class="headerlink" title="查询schemas下的所有表"></a>查询schemas下的所有表</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT TABLE_NAME FROM SYS.DBA_TABLES WHERE OWNER = &#x27;AIR_FORECAST&#x27;;</span><br></pre></td></tr></table></figure>

<p>参考链接：<br><a href="http://blog.sina.com.cn/s/blog_67d41beb0100ixnb.html">http://blog.sina.com.cn/s/blog_67d41beb0100ixnb.html</a><br><a href="https://blog.csdn.net/bisal/article/details/51482968">https://blog.csdn.net/bisal/article/details/51482968</a><br><a href="http://www.htz.pw/2015/05/20/expdp%E7%9A%84compression%E6%B5%8B%E8%AF%95.html">http://www.htz.pw/2015/05/20/expdp的compression测试.html</a><br><a href="https://www.cnblogs.com/lsdb/p/7660774.html">https://www.cnblogs.com/lsdb/p/7660774.html</a></p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>Oracle</tag>
        <tag>数据库</tag>
      </tags>
  </entry>
  <entry>
    <title>ksuapc : ORA-1033 foreground process starts before PMON</title>
    <url>/arlo/1c37e249/</url>
    <content><![CDATA[<p>开发人员反馈，数据库没有做什么操作，突然连不上了！</p>
<h1 id="查看数据库日志"><a href="#查看数据库日志" class="headerlink" title="查看数据库日志"></a>查看数据库日志</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SQL&gt;  select VALUE from v$diag_info where name =&#x27;Diag Trace&#x27;;  </span><br><span class="line"></span><br><span class="line">VALUE</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">/home/u01/app/oracle/diag/rdbms/orcl/ORCL/trace</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cd /home/u01/app/oracle/diag/rdbms/orcl/ORCL/trace</span><br><span class="line">tail -200 alert_ORCL.log</span><br></pre></td></tr></table></figure>
<p>发现日志里大量的报错ksuapc : ORA-1033 foreground process starts before PMON 网上搜了下，这是个bug，,该现象是数据库bug 8991997,该bug影响版本为:11.2.0.1&#x2F;11.1.0.7,在11.2.0.1.1开始修复。<br>大概意思就是监听起来了，数据库还没起来，有大量的外部应用在连接数据库，导致数据库无法正常启动；将数据库监听停止掉，先启动数据库，然后启动监听即可。<br><code>lsnrctl stop</code> 无法正常停止监听程序，我这里使用<code>ps -ef|grep lsnrctl</code>查看监听的进程id,然后使用<code>kill -9 pid</code>杀掉监听，然后安装正常流程启动就可以了。</p>
<h1 id="启动数据库"><a href="#启动数据库" class="headerlink" title="启动数据库"></a>启动数据库</h1><p><code>sqlplus / as sysdba</code><br><code>SQL&gt; startup</code></p>
<h1 id="启动监听"><a href="#启动监听" class="headerlink" title="启动监听"></a>启动监听</h1><p><code>lsnrctl start</code></p>
<p>参考：<a href="http://www.xifenfei.com/2013/05/ksuapc-ora-1033-foreground-process-starts-before-pmon.html">http://www.xifenfei.com/2013/05/ksuapc-ora-1033-foreground-process-starts-before-pmon.html</a></p>
]]></content>
      <categories>
        <category>Troubleshooting</category>
      </categories>
      <tags>
        <tag>Oracle</tag>
      </tags>
  </entry>
  <entry>
    <title>nginx反向代理Jenkins问题</title>
    <url>/arlo/57829448/</url>
    <content><![CDATA[<p>由于只开放了一个端口，要使用jenkins发布业务的话，需要使用nginx把jenkins的端口反向代理出来；关于jenkins搭建参加<a href="http://islocal.cc/arlo/c0b31722/">本博客之前文章</a></p>
<h1 id="修改jenkins配置文件"><a href="#修改jenkins配置文件" class="headerlink" title="修改jenkins配置文件"></a>修改jenkins配置文件</h1><p><code>vim /etc/sysconfig/jenkins</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 由于我这里把8080端口占用了，把jenkins修改为7999端口</span><br><span class="line">JENKINS_PORT=&quot;7999&quot;</span><br><span class="line"># 为jenkins添加一个上下文对象</span><br><span class="line">JENKINS_ARGS=&quot;--prefix=/jenkins&quot;</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<h1 id="修改nginx配置文件"><a href="#修改nginx配置文件" class="headerlink" title="修改nginx配置文件"></a>修改nginx配置文件</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">worker_processes  1;</span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line">    sendfile        on;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line">    client_max_body_size 60M;</span><br><span class="line">    client_body_buffer_size 512k;</span><br><span class="line">    upstream jenkins &#123;</span><br><span class="line">      keepalive 32;</span><br><span class="line">      server 127.0.0.1:7999 ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       8080;</span><br><span class="line">        server_name  localhost;</span><br><span class="line">        ignore_invalid_headers off; </span><br><span class="line">#project config file    </span><br><span class="line">         location /esp-web &#123;</span><br><span class="line">            root   html;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">        location /file &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line">        location /esp &#123;</span><br><span class="line">            proxy_pass   http://127.0.0.1:8081/esp;</span><br><span class="line">        &#125;</span><br><span class="line">#jenkins config file        </span><br><span class="line">    location ~ &quot;^/static/[0-9a-fA-F]&#123;8&#125;\/(.*)$&quot; &#123;</span><br><span class="line">        #rewrite all static files into requests to the root</span><br><span class="line">        #E.g /static/12345678/css/something.css will become /css/something.css</span><br><span class="line">        rewrite &quot;^/static/[0-9a-fA-F]&#123;8&#125;\/(.*)&quot; /$1 last;</span><br><span class="line">    &#125;</span><br><span class="line">    location /userContent &#123;</span><br><span class="line">    #have nginx handle all the static requests to the userContent folder files</span><br><span class="line">    #note : This is the $JENKINS_HOME dir</span><br><span class="line">	root /var/lib/jenkins/;</span><br><span class="line">    if (!-f $request_filename)&#123;</span><br><span class="line">      #this file does not exist, might be a directory or a /**view** url</span><br><span class="line">      rewrite (.*) /$1 last;</span><br><span class="line">	  break;</span><br><span class="line">    &#125;</span><br><span class="line">	sendfile on;</span><br><span class="line">  &#125;</span><br><span class="line">    location @jenkins &#123;</span><br><span class="line">      sendfile off;</span><br><span class="line">      proxy_pass         http://jenkins;</span><br><span class="line">      proxy_redirect     default;</span><br><span class="line">      proxy_http_version 1.1;</span><br><span class="line"></span><br><span class="line">      proxy_set_header   Host              $host;</span><br><span class="line">      proxy_set_header   X-Real-IP         $remote_addr;</span><br><span class="line">      proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;</span><br><span class="line">      proxy_set_header   X-Forwarded-Proto $scheme;</span><br><span class="line">      proxy_max_temp_file_size 0;</span><br><span class="line"></span><br><span class="line">      #this is the maximum upload size</span><br><span class="line">      client_max_body_size       10m;</span><br><span class="line">      client_body_buffer_size    128k;</span><br><span class="line"></span><br><span class="line">      proxy_connect_timeout      90;</span><br><span class="line">      proxy_send_timeout         90;</span><br><span class="line">      proxy_read_timeout         90;</span><br><span class="line">      proxy_buffering            off;</span><br><span class="line">      proxy_request_buffering    off; # Required for HTTP CLI commands in Jenkins &gt; 2.54</span><br><span class="line">      proxy_set_header Connection &quot;&quot;; # Clear for keepalive</span><br><span class="line">  &#125;</span><br><span class="line">   location / &#123;</span><br><span class="line">    # Optional configuration to detect and redirect iPhones</span><br><span class="line">    if ($http_user_agent ~* &#x27;(iPhone|iPod)&#x27;) &#123;</span><br><span class="line">      rewrite ^/$ /view/iphone/ redirect;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    try_files $uri @jenkins;</span><br><span class="line">  &#125;</span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="重启nginx、jenkins"><a href="#重启nginx、jenkins" class="headerlink" title="重启nginx、jenkins"></a>重启nginx、jenkins</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl restart jenkins.service</span><br><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure>

<p>参考文档：<br><a href="https://wiki.jenkins.io/display/JENKINS/Jenkins+says+my+reverse+proxy+setup+is+broken">https://wiki.jenkins.io/display/JENKINS/Jenkins+says+my+reverse+proxy+setup+is+broken</a><br><a href="https://www.jianshu.com/p/8315657465ac">https://www.jianshu.com/p/8315657465ac</a></p>
<hr>
]]></content>
      <categories>
        <category>Troubleshooting</category>
      </categories>
      <tags>
        <tag>Jenkins</tag>
      </tags>
  </entry>
  <entry>
    <title>修改Mariadb数据库存储路径</title>
    <url>/arlo/1b10686d/</url>
    <content><![CDATA[<p>拿到手的服务器大量空间在&#x2F;home分区下，没有在&#x2F;下，考虑到后期数据库增长量，&#x2F;分区空间可能不够，决定把Mariadb数据库数据存储路径修改到&#x2F;home分区下；以下为修改过程</p>
<span id="more"></span>
<h1 id="关闭数据库服务"><a href="#关闭数据库服务" class="headerlink" title="关闭数据库服务"></a>关闭数据库服务</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl stop mariadb.service</span><br></pre></td></tr></table></figure>
<h1 id="新建新的存储路径，并移动之前的文件"><a href="#新建新的存储路径，并移动之前的文件" class="headerlink" title="新建新的存储路径，并移动之前的文件"></a>新建新的存储路径，并移动之前的文件</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir /home/data</span><br><span class="line">mv /var/lib/mysql/ /home/data/</span><br></pre></td></tr></table></figure>
<h1 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h1><blockquote>
<p>cp &#x2F;usr&#x2F;share&#x2F;mysql&#x2F;my-medium.cnf &#x2F;etc&#x2F;my.cnf	#如果是新装的数据库，可以复制一个模板配置文件过来<br><em>注：datadir上面的五行是设置默认字符集为utf8mb4，否则emoji表情是无法正确存储的。</em></p>
</blockquote>
<p><code>vim /etc/my.cnf</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[client]</span><br><span class="line">socket          = /home/data/mysql/mysql.sock</span><br><span class="line">[mysqld]</span><br><span class="line"></span><br><span class="line">init_connect=&#x27;SET collation_connection = utf8mb4_unicode_ci&#x27;</span><br><span class="line">init_connect=&#x27;SET NAMES utf8mb4&#x27;</span><br><span class="line">character_set_server=utf8mb4</span><br><span class="line">collation-server=utf8mb4_unicode_ci</span><br><span class="line">skip-character-set-client-handshake=true</span><br><span class="line"></span><br><span class="line">datadir=/home/data/mysql/</span><br></pre></td></tr></table></figure>
<h1 id="报错"><a href="#报错" class="headerlink" title="报错"></a>报错</h1><p>报错:“[Warning] Can’t create test file &#x2F;home&#x2F;data&#x2F;mysql&#x2F;sthbb_rwdcdb_36_123.lower-test”.<br>解决方式: 修改&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;mariadb.service中配置项</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ProtectHome=false</span><br></pre></td></tr></table></figure>
<h1 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sthbb_rwdcdb_36_123 data]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 3</span><br><span class="line">Server version: 10.1.36-MariaDB MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &#x27;help;&#x27; or &#x27;\h&#x27; for help. Type &#x27;\c&#x27; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; show global variables like &quot;%datadir%&quot;;</span><br><span class="line">+---------------+-------------------+</span><br><span class="line">| Variable_name | Value             |</span><br><span class="line">+---------------+-------------------+</span><br><span class="line">| datadir       | /home/data/mysql/ |</span><br><span class="line">+---------------+-------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; status</span><br><span class="line">--------------</span><br><span class="line">mysql  Ver 15.1 Distrib 10.1.36-MariaDB, for Linux (x86_64) using readline 5.1</span><br><span class="line"></span><br><span class="line">Connection id:		3</span><br><span class="line">Current database:	</span><br><span class="line">Current user:		root@localhost</span><br><span class="line">SSL:			Not in use</span><br><span class="line">Current pager:		stdout</span><br><span class="line">Using outfile:		&#x27;&#x27;</span><br><span class="line">Using delimiter:	;</span><br><span class="line">Server:			MariaDB</span><br><span class="line">Server version:		10.1.36-MariaDB MariaDB Server</span><br><span class="line">Protocol version:	10</span><br><span class="line">Connection:		Localhost via UNIX socket</span><br><span class="line">Server characterset:	utf8mb4</span><br><span class="line">Db     characterset:	utf8mb4</span><br><span class="line">Client characterset:	utf8mb4</span><br><span class="line">Conn.  characterset:	utf8mb4</span><br><span class="line">UNIX socket:		/home/data/mysql/mysql.sock</span><br><span class="line">Uptime:			2 min 29 sec</span><br><span class="line"></span><br><span class="line">Threads: 1  Questions: 5  Slow queries: 0  Opens: 17  Flush tables: 1  Open tables: 11  Queries per second avg: 0.033</span><br><span class="line">--------------</span><br></pre></td></tr></table></figure>
<p>参考链接：<a href="https://stackoverflow.com/questions/38529205/mariadb-cannot-start-after-update-warning-cant-create-test-file-home-mysql">https://stackoverflow.com/questions/38529205/mariadb-cannot-start-after-update-warning-cant-create-test-file-home-mysql</a></p>
]]></content>
      <categories>
        <category>Troubleshooting</category>
      </categories>
      <tags>
        <tag>Mysql</tag>
        <tag>Mariadb</tag>
        <tag>Troubleshooting</tag>
      </tags>
  </entry>
  <entry>
    <title>使用wgrib2将GFS数据导入到mysql</title>
    <url>/arlo/551cdbc9/</url>
    <content><![CDATA[<h1 id="GFS数据来源"><a href="#GFS数据来源" class="headerlink" title="GFS数据来源"></a>GFS数据来源</h1><blockquote>
<p>数据来源采自美国国家环境预报中心的GFS(全球预报系统)，该系统每天发布4次全球范围的气象数据，分辨率最高可达到0.25° x 0.25°，精度还是比较可观的。<br>GFS数据提供FTP下载方式：<a href="http://www.ftp.ncep.noaa.gov/data/nccf/com/gfs/prod/">http://www.ftp.ncep.noaa.gov/data/nccf/com/gfs/prod/</a><br>每次发布的数据保存在命名为gfs.YYYYMMDDHH的文件夹中。本次需要的数据精度为0.25°（0p25），所以数据的文件名为：gfs.t{HH}z.pgrb2.0p25.f{XXX}<br>其中HH表示发布的时间，XXX表示未来几小时的预报数据。例如gfs.t00z.pgrb2.0p25.f001 表示0时发布的未来1小时气象数据信息。<br>那么问题来了，这个文件太大了，因为分辨率比较高，每个文件高达200多MB，不仅下载速度慢，处理慢，对存储空间也是一个考验。<br>于是找到了一个可以在线过滤要下载数据的地址：<br><a href="http://nomads.ncep.noaa.gov/cgi-bin/filter_gfs_0p25.pl">http://nomads.ncep.noaa.gov/cgi-bin/filter_gfs_0p25.pl</a><br>这个网站允许用户仅下载过滤后的文件，并提供下载网址，这样文件就会小很多。<br>例如，在本项目中，仅需要下载降雨数据（PWAT），并且经纬度范围为特定区域，每次发布的数据全部下载下来也才8M多点。<br>那么要想获得GRIB文件中的数据，则需要用到一个软件wgrib2,，该软件在ncep网站上提供源码下载。</p>
</blockquote>
<span id="more"></span>
<h1 id="Mysql安装配置"><a href="#Mysql安装配置" class="headerlink" title="Mysql安装配置"></a>Mysql安装配置</h1><h2 id="查看mysql安装"><a href="#查看mysql安装" class="headerlink" title="查看mysql安装"></a>查看mysql安装</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@siluxa_oracle grib2]# rpm -qa |grep -i mysql</span><br><span class="line">mysql-community-common-5.6.36-2.el6.x86_64</span><br><span class="line">mysql-community-client-5.6.36-2.el6.x86_64</span><br><span class="line">mysql-community-server-5.6.36-2.el6.x86_64</span><br><span class="line">mysql-community-libs-compat-5.6.37-2.el6.x86_64</span><br><span class="line">mysql-community-libs-5.6.36-2.el6.x86_64</span><br><span class="line">mysql-community-devel-5.6.39-2.el6.x86_64</span><br></pre></td></tr></table></figure>
<h1 id="创建数据库和表"><a href="#创建数据库和表" class="headerlink" title="创建数据库和表"></a>创建数据库和表</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 创建数据库</span><br><span class="line">CREATE DATABASE weatherDB DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci;</span><br><span class="line"># 创建表</span><br><span class="line">create table wgrib2 (rt datetime, vt datetime, lat double, lon double, param varchar(80), level varchar(30), value double); </span><br><span class="line"># 创建用户和表，并赋予权限(实验环境可以直接用root，生产环境强烈建议使用普通用户)</span><br><span class="line">-- CREATE USER wgrib2 IDENTIFIED BY &#x27;ffffff&#x27;;</span><br><span class="line">-- GRANT ALL on weatherDB.* to wgrib2@&quot;%&quot; Identified by &quot;ffffff&quot;;</span><br></pre></td></tr></table></figure>
<h1 id="编译安装wgrib2软件包"><a href="#编译安装wgrib2软件包" class="headerlink" title="编译安装wgrib2软件包"></a>编译安装wgrib2软件包</h1><h2 id="编译安装wgrib2"><a href="#编译安装wgrib2" class="headerlink" title="编译安装wgrib2"></a>编译安装wgrib2</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#安装gcc和gfortran编译器</span><br><span class="line">yum install gcc gcc-gfortran -y</span><br><span class="line">#下载wgrib2软件包</span><br><span class="line">wget http://www.ftp.cpc.ncep.noaa.gov/wd51we/wgrib2/wgrib2.tgz -O  /usr/local/src/wgrib2.tgz</span><br><span class="line">cd /usr/local/src</span><br><span class="line">tar wgrib2.tgz</span><br><span class="line">cd grib2/</span><br><span class="line">#设置编译环境</span><br><span class="line">export CC=gcc</span><br><span class="line">export FC=gfortran</span><br><span class="line"># 启用mysql支持，修改第114行</span><br><span class="line">vim makefile  </span><br><span class="line">USE_MYSQL=1</span><br><span class="line"># 编译</span><br><span class="line">make</span><br></pre></td></tr></table></figure>
<h2 id="查看wgrib2配置"><a href="#查看wgrib2配置" class="headerlink" title="查看wgrib2配置"></a>查看wgrib2配置</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@siluxa_oracle grib2]#cd wgrib2</span><br><span class="line">[root@siluxa_oracle grib2]# ./wgrib2 -config</span><br><span class="line">wgrib2 v0.2.0.7 12/2017  Wesley Ebisuzaki, Reinoud Bokhorst, John Howard, Jaakko Hyvätti, Dusan Jovic, Daniel Lee, Kristian Nilssen, Karl Pfeiffer, Pablo Romero, Manfred Schwarb, Gregor Schee, Arlindo da Silva, Niklas Sondell, Sam Trahan, Sergey Varlamov</span><br><span class="line">    stock build</span><br><span class="line"></span><br><span class="line">Compiled on 11:02:41 Mar 15 2018</span><br><span class="line"></span><br><span class="line">Netcdf package: &quot;3.6.3&quot; of Mar 15 2018 11:02:16 $ is installed</span><br><span class="line">libaec-1.0.2.tar.gz is installed</span><br><span class="line">Jasper 1.900.1 is installed</span><br><span class="line">mysql package is installed</span><br><span class="line">regex package is installed</span><br><span class="line">tigge package is installed</span><br><span class="line">IPOLATES iplib.v3.0.0 is installed, default vectors:</span><br><span class="line">    UGRD/VGRD VUCSH/VVCSH UFLX/VFLX UGUST/VGUST USTM/VSTM VDFUA/VDFVA MAXUW/MAXVW </span><br><span class="line">    UOGRD/VOGRD UICE/VICE U-GWD/V-GWD USSD/VSSD </span><br><span class="line">Geolocation library status (by search order)</span><br><span class="line">  gctpc geolocation is enabled</span><br><span class="line">  spherical geolocation is enabled</span><br><span class="line">UDF package is not installed</span><br><span class="line">version ftime=2</span><br><span class="line">maximum number of arguments on command line: 10000</span><br><span class="line">maximum number of -match,-not,-if, and -not_if options: 2000</span><br><span class="line">maximum number of -match_fs,-not_fs,-if_fs, and -not_if_fs options: 2000</span><br><span class="line">maximum number of -fgrep, -egrep, -fgrep_v, -egrep_v options: 200</span><br><span class="line">RPN registers: 0..19</span><br><span class="line">memory files: @mem:0, @mem:1 .. @mem:19</span><br><span class="line">stdout buffer length: 30000</span><br><span class="line">default decoding: g2clib emulation</span><br><span class="line">g2clib decoders are not installed</span><br><span class="line">Supported decoding: simple, complex, rle, ieee, png, jpeg2000, CCSDS AEC</span><br><span class="line">user gribtable: (none)</span><br><span class="line">C compiler: gcc (GCC) 4.4.7 20120313 (Red Hat 4.4.7-18)</span><br><span class="line">Fortran compiler: gfortran</span><br><span class="line">OpenMP: control number of threads with environment variable OMP_NUM_THREADS</span><br><span class="line">INT_MAX:   2147483647</span><br><span class="line">ULONG_MAX: 18446744073709551615</span><br></pre></td></tr></table></figure>
<h1 id="将gfs数据导入到mysql中"><a href="#将gfs数据导入到mysql中" class="headerlink" title="将gfs数据导入到mysql中"></a>将gfs数据导入到mysql中</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./wgrib2 /mnt/wgrib2/gfs_20180313_0000_0p25_240.240 -mysql 192.168.6.123 root ffffff weatherDB wgrib2</span><br></pre></td></tr></table></figure>
<p><img src="/images/2018/0315/01.png" alt="wgrib2"></p>
<h2 id="可以过滤性导入数据，格式为-if-“：”-后跟参数"><a href="#可以过滤性导入数据，格式为-if-“：”-后跟参数" class="headerlink" title="可以过滤性导入数据，格式为 -if “：” 后跟参数"></a>可以过滤性导入数据，格式为 -if “：” 后跟参数</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#下边这条命令是将“10 m above ground”的数据导入到wind表中</span><br><span class="line">./wgrib2  /mnt/wgrib2/gfs.t00z.pgrb2.0p25.f000 -if &quot;:10 m above ground&quot; -mysql 192.168.6.123 root ffffff weatherDB wind</span><br></pre></td></tr></table></figure>
<h2 id="查看导入结果"><a href="#查看导入结果" class="headerlink" title="查看导入结果"></a>查看导入结果</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql -uroot -pffffff</span><br><span class="line">mysql&gt; use weatherDB;</span><br><span class="line">mysql&gt; select * from `weatherDB`.`wgrib2` limit 0, 20;</span><br></pre></td></tr></table></figure>
<p><img src="/images/2018/0315/02.png" alt="wgrib2"></p>
<h1 id="自动下载gfs数据，并导入mysql脚本"><a href="#自动下载gfs数据，并导入mysql脚本" class="headerlink" title="自动下载gfs数据，并导入mysql脚本"></a>自动下载gfs数据，并导入mysql脚本</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@mysql gfs_data]# cat d_gfs00.sh </span><br><span class="line">#!/bin/bash</span><br><span class="line">v_time1=`date &quot;+%Y%m%d00&quot;`</span><br><span class="line">gfs_dir=/data/gfs_data/$v_time1</span><br><span class="line"># 0. 删除2天前的数据</span><br><span class="line">find /data/gfs_data/ -type d -mtime +2 -exec rm -fr &#123;&#125; \;</span><br><span class="line"># 1. 判断目录是否存在，如果不存在新建目录</span><br><span class="line">if [ ! -d &quot;$gfs_dir&quot; ];then</span><br><span class="line">    mkdir -p $gfs_dir</span><br><span class="line">Else</span><br><span class="line">    echo &quot;文件夹已经存在&quot;</span><br><span class="line">fi</span><br><span class="line"># 2. 判断目录下是否有文件</span><br><span class="line">filenum=`ls $gfs_dir |wc -l`</span><br><span class="line">if [ 9 -ne $filenum ];then</span><br><span class="line">    /usr/bin/perl /data/gfs_data/get_gfs.pl data $v_time1 0 24 3 all &#x27;VGRD.10 m above ground|UGRD.10 m above ground&#x27; $gfs_dir  &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">else</span><br><span class="line">    echo &quot;文件已经下载&quot;</span><br><span class="line">fi</span><br><span class="line"># 3. 清空数据库</span><br><span class="line">mysql -uwgrib2 -pwg#123 -e &#x27;truncate table weatherDB.wind&#x27; </span><br><span class="line"># 4. 导入文件到数据库</span><br><span class="line"></span><br><span class="line">for file in $(ls $gfs_dir)</span><br><span class="line">do</span><br><span class="line">    /usr/local/grib2/wgrib2/wgrib2 $gfs_dir/$file -mysql localhost  wgrib2 &#x27;wg#123&#x27; weatherDB wind &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>ps：<br>如果是使用Mariadb数据的话，还需要安装<code>MariaDB-libs mysql-devel MariaDB-shared openssl-devel</code>依赖</p>
<p>参考链接：<br><a href="http://blog.csdn.net/pch1982cn/article/details/74292772">http://blog.csdn.net/pch1982cn/article/details/74292772</a><br><a href="http://www.cpc.ncep.noaa.gov/products/wesley/wgrib2/index.html">http://www.cpc.ncep.noaa.gov/products/wesley/wgrib2/index.html</a><br><a href="http://www.nco.ncep.noaa.gov/pmb/products/gfs/gfs.t00z.pgrb2f00.npoess.shtml">http://www.nco.ncep.noaa.gov/pmb/products/gfs/gfs.t00z.pgrb2f00.npoess.shtml</a><br>数据下载地址:<br><a href="ftp://ftpprd.ncep.noaa.gov/pub/data/nccf/com/gfs/prod/">ftp://ftpprd.ncep.noaa.gov/pub/data/nccf/com/gfs/prod/</a><br>在线过滤要下载数据的地址:<br><a href="http://nomads.ncep.noaa.gov/">http://nomads.ncep.noaa.gov</a></p>
]]></content>
      <categories>
        <category>大气模型</category>
      </categories>
      <tags>
        <tag>mysql</tag>
        <tag>wgrib2</tag>
        <tag>GFS</tag>
      </tags>
  </entry>
  <entry>
    <title>关闭Oracle审计日志，解决因AUD$数据过大，导致SYSTEM表空间暴涨的问题</title>
    <url>/arlo/ddea0a3f/</url>
    <content><![CDATA[<p>生产服务器报错，system表空间满了，拓展了表空间重启服务后正常，但是很好奇system表空间怎么会增长这么快？业务数据默认存放在USERS表空间和TEMP临时表空间中。</p>
<span id="more"></span>
<h1 id="查询一下system表空间中占用空间最大的表"><a href="#查询一下system表空间中占用空间最大的表" class="headerlink" title="查询一下system表空间中占用空间最大的表"></a>查询一下system表空间中占用空间最大的表</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">  FROM (SELECT SEGMENT_NAME, SUM(BYTES) / 1024 / 1024 MB</span><br><span class="line">          FROM DBA_SEGMENTS</span><br><span class="line">         WHERE TABLESPACE_NAME = &#x27;SYSTEM&#x27;</span><br><span class="line">         GROUP BY SEGMENT_NAME</span><br><span class="line">         ORDER BY 2 DESC)</span><br><span class="line"> WHERE ROWNUM &lt; 10;</span><br></pre></td></tr></table></figure>
<h1 id="查询一下system空间占用比"><a href="#查询一下system空间占用比" class="headerlink" title="查询一下system空间占用比"></a>查询一下system空间占用比</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT B.TABLESPACE_NAME &quot;表空间&quot;,</span><br><span class="line">       　B.BYTES / 1024 / 1024 &quot;大小M&quot;,</span><br><span class="line">       　(B.BYTES - SUM(NVL(A.BYTES, 0))) / 1024 / 1024 &quot;已使用M&quot;,</span><br><span class="line">       　SUBSTR((B.BYTES - SUM(NVL(A.BYTES, 0))) / (B.BYTES) * 100, 1, 5) &quot;利用率&quot; 　FROM DBA_FREE_SPACE A,</span><br><span class="line">       DBA_DATA_FILES B 　WHERE A.FILE_ID = B.FILE_ID AND B.TABLESPACE_NAME = &#x27;SYSTEM&#x27; 　GROUP BY B.TABLESPACE_NAME,</span><br><span class="line">       B.FILE_NAME,</span><br><span class="line">       B.BYTES ORDER BY B.TABLESPACE_NAME;</span><br></pre></td></tr></table></figure>
<h1 id="查询AUD-占用空间"><a href="#查询AUD-占用空间" class="headerlink" title="查询AUD$占用空间"></a>查询AUD$占用空间</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT SEGMENT_NAME, BYTES / 1024 / 1024 &quot;占用空间M&quot;</span><br><span class="line">  FROM DBA_SEGMENTS</span><br><span class="line"> WHERE SEGMENT_NAME = &#x27;AUD$&#x27;;</span><br></pre></td></tr></table></figure>
<h1 id="查看aud审计策略"><a href="#查看aud审计策略" class="headerlink" title="查看aud审计策略"></a>查看aud审计策略</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">show parameter audit_trail</span><br></pre></td></tr></table></figure>
<p>发现数据库启用了DB级别的审计功能，相关审计级别如下：<br>None：是默认值，不做审计；<br>DB：将audit trail 记录在数据库的审计相关表中，如aud$，审计的结果只有连接信息；<br>DB,Extended：这样审计结果里面除了连接信息还包含了当时执行的具体语句；<br>OS：将audit trail 记录在操作系统文件中，文件名由audit_file_dest参数指定；</p>
<h1 id="截断数据"><a href="#截断数据" class="headerlink" title="截断数据"></a>截断数据</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">truncate table aud$;  </span><br></pre></td></tr></table></figure>
<h1 id="修改spfile启动文件，关闭审计功能"><a href="#修改spfile启动文件，关闭审计功能" class="headerlink" title="修改spfile启动文件，关闭审计功能"></a>修改spfile启动文件，关闭审计功能</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SQL&gt; alter system set audit_trail=NONE scope=spfile;</span><br><span class="line">SQL&gt; shutdown immediate;</span><br><span class="line">SQL&gt; startup</span><br></pre></td></tr></table></figure>
<p><img src="/images/2018/0725/01.png"><br><img src="/images/2018/0725/02.png"></p>
<p>参考链接：<br><a href="https://blog.csdn.net/melody_mr/article/details/41208849">https://blog.csdn.net/melody_mr/article/details/41208849</a><br><a href="https://blog.csdn.net/lwei_998/article/details/7394638">https://blog.csdn.net/lwei_998/article/details/7394638</a></p>
]]></content>
      <categories>
        <category>Troubleshooting</category>
      </categories>
      <tags>
        <tag>Oracle</tag>
        <tag>数据库</tag>
      </tags>
  </entry>
  <entry>
    <title>安装rlwrap，使SqlPlus工具支持上下左右键</title>
    <url>/arlo/d9547628/</url>
    <content><![CDATA[<p>SqlPlus 工具中默认不支持上下左右键调出历史命令，很不方便；需安装rlwrap。</p>
<span id="more"></span>

<h1 id="安装依赖包"><a href="#安装依赖包" class="headerlink" title="安装依赖包"></a>安装依赖包</h1><p><code>yum -y install gcc libtermcap-devel readline readline-devel</code></p>
<h1 id="获取安装文件"><a href="#获取安装文件" class="headerlink" title="获取安装文件"></a>获取安装文件</h1><p><code>wget https://fossies.org/linux/privat/rlwrap-0.43.tar.gz</code></p>
<h1 id="安装rlwrap"><a href="#安装rlwrap" class="headerlink" title="安装rlwrap"></a>安装rlwrap</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tar xf rlwrap-0.43.tar.gz</span><br><span class="line">cd rlwrap-0.43/</span><br><span class="line">./configure &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">su - oracle</span><br><span class="line">vim .bash_profile</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">alias sqlplus=&#x27;rlwrap sqlplus&#x27;</span><br><span class="line">alias rman=&#x27;rlwrap rman&#x27;</span><br><span class="line">alias asmcmd=&#x27;rlwrap asmcmd&#x27;</span><br></pre></td></tr></table></figure>

<p><code>source .bash_profile</code></p>
<h1 id="扩展，设置sqlplus登录提示符"><a href="#扩展，设置sqlplus登录提示符" class="headerlink" title="扩展，设置sqlplus登录提示符"></a>扩展，设置sqlplus登录提示符</h1><p><code>vim $ORACLE_HOME/sqlplus/admin/glogin.sql</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">set linesize 120 pagesize 9999</span><br><span class="line">SET SQLPROMPT &quot;_USER&#x27;@&#x27;_CONNECT_IDENTIFIER&gt; &quot;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>常识</tag>
        <tag>Oracle</tag>
      </tags>
  </entry>
  <entry>
    <title>数据库hang住，应用连接缓慢甚至无法连接</title>
    <url>/arlo/9598871f/</url>
    <content><![CDATA[<h1 id="问题现象"><a href="#问题现象" class="headerlink" title="问题现象"></a>问题现象</h1><p>数据库抗住，开发人员反映应用断断续续无法连接，远程telnet数据库端口不通</p>
<h2 id="登录数据库，查看日志位置"><a href="#登录数据库，查看日志位置" class="headerlink" title="登录数据库，查看日志位置"></a>登录数据库，查看日志位置</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SQL&gt; select value from v$diag_info where name =&#x27;Diag Trace&#x27;;</span><br><span class="line"></span><br><span class="line">VALUE</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">e:\app\administrator\diag\rdbms\sx21\sx21\trace</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<h1 id="报错1：redo日志无法切换"><a href="#报错1：redo日志无法切换" class="headerlink" title="报错1：redo日志无法切换"></a>报错1：redo日志无法切换</h1><h2 id="查看alert-sx21-log日志，发现大量redo日志报错"><a href="#查看alert-sx21-log日志，发现大量redo日志报错" class="headerlink" title="查看alert_sx21.log日志，发现大量redo日志报错"></a>查看alert_sx21.log日志，发现大量redo日志报错</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Checkpoint not complete</span><br><span class="line">Current log# 2 seq# 76268 mem# 0: E:\APP\ADMINISTRATOR\ORADATA\SX21\REDO02.LOG</span><br><span class="line">Thread 1 advanced to log sequence 76269 (LGWR switch)</span><br><span class="line">Current log# 3 seq# 76269 mem# 0: E:\APP\ADMINISTRATOR\ORADATA\SX21\REDO03.LOG</span><br></pre></td></tr></table></figure>
<h2 id="增加redo日志"><a href="#增加redo日志" class="headerlink" title="增加redo日志"></a>增加redo日志</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">alter database add logfile group 4 (&#x27;E:\APP\ADMINISTRATOR\ORADATA\SX21\REDO04.LOG&#x27;) size 50m;</span><br><span class="line">alter database add logfile group 5 (&#x27;E:\APP\ADMINISTRATOR\ORADATA\SX21\REDO05.LOG&#x27;) size 50m;</span><br></pre></td></tr></table></figure>
<h2 id="查看redo日志"><a href="#查看redo日志" class="headerlink" title="查看redo日志"></a>查看redo日志</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select group#,sequence#,bytes,members,status from v$log;</span><br></pre></td></tr></table></figure>
<h2 id="修改-fast-start-mttr-target参数"><a href="#修改-fast-start-mttr-target参数" class="headerlink" title="修改 fast_start_mttr_target参数"></a>修改 fast_start_mttr_target参数</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">alter system set fast_start_mttr_target = 30 ;</span><br></pre></td></tr></table></figure>
<h1 id="报错2："><a href="#报错2：" class="headerlink" title="报错2："></a>报错2：</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Sat Sep 01 08:37:01 2018</span><br><span class="line">Errors in file e:\app\administrator\diag\rdbms\sx21\sx21\trace\sx21_mmon_6264.trc  (incident=144681):</span><br><span class="line">ORA-00445: 后台进程 &quot;m000&quot; 在 120 秒之后仍没有启动</span><br><span class="line">Sat Sep 01 08:39:06 2018</span><br><span class="line">Errors in file e:\app\administrator\diag\rdbms\sx21\sx21\trace\sx21_smco_13976.trc  (incident=144698):</span><br><span class="line">ORA-00445: 后台进程 &quot;W000&quot; 在 120 秒之后仍没有启动</span><br><span class="line">Sat Sep 01 08:41:12 2018</span><br><span class="line">Errors in file e:\app\administrator\diag\rdbms\sx21\sx21\trace\sx21_cjq0_21740.trc  (incident=144688):</span><br><span class="line">ORA-00445: 后台进程 &quot;J000&quot; 在 120 秒之后仍没有启动</span><br><span class="line">kkjcre1p: unable to spawn jobq slave process </span><br><span class="line">Errors in file e:\app\administrator\diag\rdbms\sx21\sx21\trace\sx21_cjq0_21740.trc:</span><br></pre></td></tr></table></figure>
<p><em>此问题现象为系统内存不足，建议增加内存，或增加sga，由于暂时无法增加系统内存，我先调整了sga</em></p>
<h2 id="修改sga"><a href="#修改sga" class="headerlink" title="修改sga"></a>修改sga</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SQL&gt; show parameter sga;</span><br><span class="line"></span><br><span class="line">NAME TYPE VALUE</span><br><span class="line">------------------------------------ ----------- ----------------------------</span><br><span class="line">lock_sga boolean FALSE</span><br><span class="line">pre_page_sga boolean FALSE</span><br><span class="line">sga_max_size big integer 10G</span><br><span class="line">sga_target big integer 0</span><br><span class="line">SQL&gt; alter system set sga_max_size=20480M scope=spfile;    #一定要保证SGA_MAX_SIZE小于MEMORY_TARGET，否则启动会报错</span><br><span class="line">SQL&gt; shutdown immediate</span><br><span class="line">SQL&gt; startup</span><br></pre></td></tr></table></figure>
<h3 id="一定要保证SGA-MAX-SIZE小于MEMORY-TARGET，否则启动会报以下错误"><a href="#一定要保证SGA-MAX-SIZE小于MEMORY-TARGET，否则启动会报以下错误" class="headerlink" title="一定要保证SGA_MAX_SIZE小于MEMORY_TARGET，否则启动会报以下错误"></a>一定要保证SGA_MAX_SIZE小于MEMORY_TARGET，否则启动会报以下错误</h3><p>ORA-00844: Parameter not taking MEMORY_TARGET into account<br>ORA-00851: SGA_MAX_SIZE 21474836480 cannot be set to more than MEMORY_TARGET 10737418240.</p>
<p><em>解决方法如下，创建一个pfile文件，然后修改内存参数，然后在创建一格spfile，启动数据库</em></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SQL&gt; create pfile from spfile;</span><br></pre></td></tr></table></figure>
<p>修改该文件以下参数E:\app\Administrator\product\11.2.0\dbhome_4\database\INITsx21.ORA<br><code>*.memory_target=27487790694</code><br><code>*.sga_max_size=21990232555</code><br><code>*.sga_target=21990232555</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SQL&gt; create spfile from pfile;</span><br></pre></td></tr></table></figure>

<p>参考文档：</p>
<p><a href="http://blog.51cto.com/mervin/490322">http://blog.51cto.com/mervin/490322</a><br><a href="http://blog.51cto.com/sysadmin/203502">http://blog.51cto.com/sysadmin/203502</a><br><a href="http://blog.51cto.com/leoguan/584494">http://blog.51cto.com/leoguan/584494</a><br><a href="https://blog.csdn.net/ggwxk1990/article/details/78712204">https://blog.csdn.net/ggwxk1990/article/details/78712204</a><br><a href="https://blog.csdn.net/leshami/article/details/5782516">https://blog.csdn.net/leshami/article/details/5782516</a></p>
]]></content>
      <categories>
        <category>Troubleshooting</category>
      </categories>
      <tags>
        <tag>Oracle</tag>
        <tag>数据库</tag>
      </tags>
  </entry>
  <entry>
    <title>将绿色版Tomcat/Nginx注册成服务，实现开机自启动</title>
    <url>/arlo/956f976/</url>
    <content><![CDATA[<p>我们常用的Tomcat，不管是在windows下还是linux下基本上都是绿色版本，解压、启动后直接使用。<br>这就产生了一个问题，不能开机自自动，很不方便，linux下可以添加到&#x2F;etc&#x2F;rc.local实现开机自启，windows下也可以添加到开机启动项里；不过注册为系统服务更加方便一些，这里记录一下方法。</p>
<span id="more"></span>
<h1 id="注册Tomcat服务"><a href="#注册Tomcat服务" class="headerlink" title="注册Tomcat服务"></a>注册Tomcat服务</h1><h2 id="检查系统环境"><a href="#检查系统环境" class="headerlink" title="检查系统环境"></a>检查系统环境</h2><p>确保64位的操作系统下是64位的Jdk<br><img src="/images/2018/0426/01.png" alt="tomcat"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">F:\&gt;java -d64 -version</span><br><span class="line">java version &quot;1.7.0_80&quot;</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.7.0_80-b15)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 24.80-b11, mixed mode)</span><br></pre></td></tr></table></figure>
<h2 id="使用tomcat自身工具注册服务"><a href="#使用tomcat自身工具注册服务" class="headerlink" title="使用tomcat自身工具注册服务"></a>使用tomcat自身工具注册服务</h2><p>进入到tomcat bin目录下，执行</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#注册服务</span><br><span class="line">service.bat install &#x27;服务名&#x27; </span><br><span class="line">#服务名中不能有&quot;-&quot;,&quot;_&quot;，否则在服务中看不到</span><br><span class="line">F:\apache-tomcat-7.0.70(zabbix)\bin&gt;service.bat install tomcat7070 </span><br><span class="line">Installing the service &#x27;tomcat7070&#x27; ...</span><br><span class="line">Using CATALINA_HOME:    &quot;F:\apache-tomcat-7.0.70(zabbix)&quot;</span><br><span class="line">Using CATALINA_BASE:    &quot;F:\apache-tomcat-7.0.70(zabbix)&quot;</span><br><span class="line">Using JAVA_HOME:        &quot;C:\Program Files\Java\jdk1.7.0_80&quot;</span><br><span class="line">Using JRE_HOME:         &quot;C:\Program Files\Java\jdk1.7.0_80\jre&quot;</span><br><span class="line">Using JVM:              &quot;C:\Program Files\Java\jdk1.7.0_80\jre\bin\server\jvm.dll&quot;</span><br><span class="line">The service &#x27;tomcat7070&#x27; has been installed.</span><br><span class="line"></span><br><span class="line">#卸载服务</span><br><span class="line">service.bat remove &#x27;服务名&#x27; </span><br><span class="line"></span><br><span class="line">F:\apache-tomcat-7.0.70(zabbix)\bin&gt;service.bat remove tomcat7070</span><br><span class="line">Removing the service &#x27;tomcat7070&#x27; ...</span><br><span class="line">Using CATALINA_BASE:    &quot;F:\apache-tomcat-7.0.70(zabbix)&quot;</span><br><span class="line">The service &#x27;tomcat7070&#x27; has been removed</span><br></pre></td></tr></table></figure>
<p><img src="/images/2018/0426/02.png" alt="tomcat"></p>
<h1 id="设置服务依赖关系"><a href="#设置服务依赖关系" class="headerlink" title="设置服务依赖关系"></a>设置服务依赖关系</h1><p>如果项目中有多个tomcat，有先后启动顺序的话，可以使用到服务里的依赖关系,比如tomcat8080启动时候监测tomcat8081是否启动（8080依赖8081），就可以按下边这种方法设置。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sc config &quot;tomcat8080&quot; depend= tomcat8081</span><br></pre></td></tr></table></figure>
<h1 id="设置访问自动启动"><a href="#设置访问自动启动" class="headerlink" title="设置访问自动启动"></a>设置访问自动启动</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">set autoconfig enabled=&#123;yes|no&#125; </span><br></pre></td></tr></table></figure>
<h1 id="注册Nginx服务方法一"><a href="#注册Nginx服务方法一" class="headerlink" title="注册Nginx服务方法一"></a>注册Nginx服务方法一</h1><h2 id="进入github下载WinSW-NET4-exe"><a href="#进入github下载WinSW-NET4-exe" class="headerlink" title="进入github下载WinSW.NET4.exe"></a>进入github下载WinSW.NET4.exe</h2><p><a href="https://github.com/kohsuke/winsw/releases/download/winsw-v2.1.2/WinSW.NET4.exe">https://github.com/kohsuke/winsw/releases/download/winsw-v2.1.2/WinSW.NET4.exe</a><br>将WinSW.NET4.exe 拷贝到 D:\nginx-1.16.1目录下，并重命名为nginx-server.exe</p>
<h2 id="编写配置文件"><a href="#编写配置文件" class="headerlink" title="编写配置文件"></a>编写配置文件</h2><p>在D:\nginx-1.16.1目录下新建 nginx-server.xml 配置文件，内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;service&gt;</span><br><span class="line">  &lt;id&gt;Nginx&lt;/id&gt;</span><br><span class="line">  &lt;name&gt;Nginx&lt;/name&gt;</span><br><span class="line">  &lt;description&gt;Nginx&lt;/description&gt;</span><br><span class="line">  &lt;executable&gt;D:\nginx-1.16.1\nginx.exe&lt;/executable&gt;</span><br><span class="line">  &lt;startargument&gt;-p&lt;/startargument&gt;</span><br><span class="line">  &lt;startargument&gt;D:\nginx-1.16.1&lt;/startargument&gt;  </span><br><span class="line">  &lt;logpath&gt;D:\nginx-1.16.1\logs&lt;/logpath&gt;</span><br><span class="line">  &lt;logmode&gt;roll&lt;/logmode&gt;  </span><br><span class="line">  &lt;stopexecutable&gt;D:\nginx-1.16.1\nginx.exe&lt;/stopexecutable&gt;</span><br><span class="line">  &lt;stopargument&gt;-p&lt;/stopargument&gt;</span><br><span class="line">  &lt;stopargument&gt;D:\nginx-1.16.1&lt;/stopargument&gt;</span><br><span class="line">  &lt;stopargument&gt;-s&lt;/stopargument&gt;</span><br><span class="line">  &lt;stopargument&gt;stop&lt;/stopargument&gt;</span><br><span class="line">  &lt;stoptimeout&gt;6sec&lt;/stoptimeout&gt;</span><br><span class="line">&lt;/service&gt;</span><br></pre></td></tr></table></figure>
<h2 id="注册并启动服务"><a href="#注册并启动服务" class="headerlink" title="注册并启动服务"></a>注册并启动服务</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">D:\&gt;d:\nginx-1.16.1\nginx-server.exe install</span><br><span class="line">2019-11-12 15:34:26,555 INFO  - Installing the service with id &#x27;Nginx&#x27;</span><br><span class="line"></span><br><span class="line">D:\nginx-1.16.1&gt;net start Nginx</span><br><span class="line">Nginx 服务正在启动 .</span><br><span class="line">Nginx 服务已经启动成功。</span><br></pre></td></tr></table></figure>

<h1 id="注册Nginx服务方法二"><a href="#注册Nginx服务方法二" class="headerlink" title="注册Nginx服务方法二"></a>注册Nginx服务方法二</h1><h2 id="下载Windows-Server-2003-Resource-Kit-Tools"><a href="#下载Windows-Server-2003-Resource-Kit-Tools" class="headerlink" title="下载Windows Server 2003 Resource Kit Tools"></a>下载Windows Server 2003 Resource Kit Tools</h2><p>其实我们只需要里边instsrv.exe、srvany.exe这两个工具<br><a href="https://www.microsoft.com/en-IE/download/details.aspx?id=17657">https://www.microsoft.com/en-IE/download/details.aspx?id=17657</a></p>
<h2 id="注册Nginx服务"><a href="#注册Nginx服务" class="headerlink" title="注册Nginx服务"></a>注册Nginx服务</h2><p>安装完上述工具，打开C:\Program Files (x86)\Windows Resource Kits\Tools， 复制srvany.exe到nginx.exe同级目录下。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sc create &quot;Nginx&quot; binPath=&quot;D:\deploy\nginx-1.12.1\srvany.exe&quot; start=auto</span><br></pre></td></tr></table></figure>
<h2 id="导入注册表"><a href="#导入注册表" class="headerlink" title="导入注册表"></a>导入注册表</h2><p>复制一下内容，保存为.reg格式文件，双击导入到注册表</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Windows Registry Editor Version 5.00 </span><br><span class="line">[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Nginx\Parameters]  </span><br><span class="line">&quot;Application&quot;=&quot;D:\\deploy\\nginx-1.12.1\\nginx.exe&quot;  </span><br><span class="line">&quot;AppParameters&quot;=&quot;&quot;  </span><br><span class="line">&quot;AppDirectory&quot;=&quot;D:\\deploy\\nginx-1.12.1&quot;  </span><br></pre></td></tr></table></figure>
<h2 id="启动关闭服务"><a href="#启动关闭服务" class="headerlink" title="启动关闭服务"></a>启动关闭服务</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 启动</span><br><span class="line">C:\&gt;net start Nginx</span><br><span class="line">Nginx 服务正在启动 .</span><br><span class="line">Nginx 服务已经启动成功。</span><br><span class="line"># 关闭</span><br><span class="line">windows下nginx默认会启动两个进程，如果使用net stop Nginx的话只能关闭一个nginx进程，不能完全关闭</span><br><span class="line">taskkill /F /IM nginx.exe</span><br></pre></td></tr></table></figure>


<p>参考资料：<br><a href="http://www.cnblogs.com/xwdreamer/p/3411986.html">http://www.cnblogs.com/xwdreamer/p/3411986.html</a><br><a href="http://wlbbswl.iteye.com/blog/840538">http://wlbbswl.iteye.com/blog/840538</a><br><a href="https://blog.csdn.net/qq_16022261/article/details/53836004">https://blog.csdn.net/qq_16022261/article/details/53836004</a><br><a href="http://koda.iteye.com/blog/600725">http://koda.iteye.com/blog/600725</a></p>
]]></content>
      <categories>
        <category>常识</category>
      </categories>
      <tags>
        <tag>Tomcat</tag>
        <tag>Nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>等保三级安全要求之开源软件实现</title>
    <url>/arlo/764ae16c/</url>
    <content><![CDATA[<h1 id="等级划分"><a href="#等级划分" class="headerlink" title="等级划分"></a>等级划分</h1><blockquote>
<p>《信息安全等级保护管理办法》规定，国家信息安全等级保护坚持自主定级、自主保护的原则。信息系统的安全保护等级应当根据信息系统在国家安全、经济建设、社会生活中的重要程度，信息系统遭到破坏后对国家安全、社会秩序、公共利益以及公民、法人和其他组织的合法权益的危害程度等因素确定。<br>信息系统的安全保护等级分为以下五级：<br>第一级，信息系统受到破坏后，会对公民、法人和其他组织的合法权益造成损害，但不损害国家安全、社会秩序和公共利益。第一级信息系统运营、使用单位应当依据国家有关管理规范和技术标准进行保护。<br>第二级，信息系统受到破坏后，会对公民、法人和其他组织的合法权益产生严重损害，或者对社会秩序和公共利益造成损害，但不损害国家安全。国家信息安全监管部门对该级信息系统安全等级保护工作进行指导。<br>第三级，信息系统受到破坏后，会对社会秩序和公共利益造成严重损害，或者对国家安全造成损害。国家信息安全监管部门对该级信息系统安全等级保护工作进行监督、检查。<br>第四级，信息系统受到破坏后，会对社会秩序和公共利益造成特别严重损害，或者对国家安全造成严重损害。国家信息安全监管部门对该级信息系统安全等级保护工作进行强制监督、检查。<br>第五级，信息系统受到破坏后，会对国家安全造成特别严重损害。国家信息安全监管部门对该级信息系统安全等级保护工作进行专门监督、检查。</p>
</blockquote>
<p><strong>本文目的主要是调研等保三级的硬件可以使用哪些软件来替换（有些有硬性要求另说），整理一版放在这里，以后的项目中如果有使用到，就不用在一一查找了。</strong></p>
<span id="more"></span>
<h1 id="安全管理中心系统"><a href="#安全管理中心系统" class="headerlink" title="安全管理中心系统"></a>安全管理中心系统</h1><h2 id="OSSIM"><a href="#OSSIM" class="headerlink" title="OSSIM"></a>OSSIM</h2><p>OSSIM即开源安全信息管理系统(OPEN SOURCE SECURITY INFORMATION MANAGEMENT)，是一个非常流行和完整的开源安全架构体系。OSSIM通过将开源产品进行集成，从而提供一种能够实现安全监控功能的基础平台。 它的目的是提供一种集中式、有组织的、能够更好地进行监测和显示的框架式系统。OSSIM由数据收集、监视、检测、审计以及控制台这五个模块构成。这5个模块包含了目前安全领域从事件预防到事件处理一个完整的过程，在目前的安全架构 中，OSSIM是最为完备的。这五个功能模块又被划分为三个层次，分别是高层的安全信息显示控制面板、中层的风险和活动监控以及底层的证据控制台和网络监控，各个层次提供不同功能，共同保证系统的安全运转。</p>
<h1 id="开源堡垒机-x2F-运维审计系统"><a href="#开源堡垒机-x2F-运维审计系统" class="headerlink" title="开源堡垒机&#x2F;运维审计系统"></a>开源堡垒机&#x2F;运维审计系统</h1><h2 id="Jumpserver"><a href="#Jumpserver" class="headerlink" title="Jumpserver"></a>Jumpserver</h2><p>Jumpserver是全球首款完全开源的堡垒机，使用 GNU GPL v2.0 开源协议，是符合 4A 的专业运维审计系统。支持支持RDP和SSH协议的跳转,支持命令，会话记录，支持资产管理，日志审计；</p>
<h2 id="GateOne"><a href="#GateOne" class="headerlink" title="GateOne"></a>GateOne</h2><p>Gateone是一个基于tornado和html5技术的开源web ssh项目，功能很强大， 支持多个账户多个终端窗口连接远程机器， 支持多种认证登陆方式， 支持嵌入到各种web应用，支持多种插件等等。暂不支持windows</p>
<h2 id="Teleport"><a href="#Teleport" class="headerlink" title="Teleport"></a>Teleport</h2><p>Teleport是触维软件推出的一款简单易用的堡垒机系统，具有小巧、易用、易于集成的特点，支持RDP和SSH协议的跳转。</p>
<h2 id="麒麟开源堡垒机"><a href="#麒麟开源堡垒机" class="headerlink" title="麒麟开源堡垒机"></a>麒麟开源堡垒机</h2><p>麒麟堡垒机全协议支持、网管功能、3A系统功能、动态口令功能、SSL VPN功能、CA证书功能，支持RDP和SSH协议的跳转。</p>
<h1 id="开源入侵检测系统-IDS-x2F-IPS"><a href="#开源入侵检测系统-IDS-x2F-IPS" class="headerlink" title="开源入侵检测系统(IDS&#x2F;IPS)"></a>开源入侵检测系统(IDS&#x2F;IPS)</h1><h2 id="Snort"><a href="#Snort" class="headerlink" title="Snort"></a>Snort</h2><p>Snort是最好的入侵检测系统（IDS）工具。它所需要的是一些在上面运行的硬件以及安装、配置和维护的时间。Snort可以在任何操作系统上运行，包括Windows和Linux。<br>Snort 一直都是网络入侵检测（IDS）和入侵防御工具（IPS）的领导者，并且，随着开源社区的持续发展，为其母公司Sourcefire（多年 来，Sourcefire提供有供应商支持和即时更新的功能齐全的商业版本Snort，同时仍然免费提供功能有限的免费版本Snort）持续不断的支 持，Snort很可能会继续保持其领导地位。<br>虽然Snort“称霸”这个市场，但也有其他供应商提供类似的免费工具。很多这些入侵检测系统（IDS）供应商（即使不是大多数）结合Snort或其他开源软件的引擎来创建强大的免费入侵检测服务。</p>
<h2 id="Security-Onion"><a href="#Security-Onion" class="headerlink" title="Security Onion"></a>Security Onion</h2><p>Security Onion是用于网络监控和入侵检测的基于Ubuntu的Linux发行版。该镜像可以作为传感器分布在网络中，以监控多个VLAN和子网，这很适用于 VMware和虚拟环境。该配置只能用作IDS，目前不能当作IPS运行。然而，你可以选择把它作为网络和主机入侵检测部署，以及利用Squil、Bro IDS和OSSEC等服务来执行该服务的IDS功能。该工具的wiki信息和文档信息很丰富，漏洞和错误也有记录和审查。虽然Security Onion很强大，但它仍然需要不断发展，当然这需要时间。</p>
<h2 id="OSSEC"><a href="#OSSEC" class="headerlink" title="OSSEC"></a>OSSEC</h2><p>OSSEC是一个开源主机入侵检测系统（HIDS），它的功能不只是入侵检测。与大多数开源IDS产品一样，有多种附加模块可以结合该 IDS的核心功能。除了网络入侵检测外，OSSEC客户端能够执行文件完整性监控和rootkit检测，并有实时报警，这些功能都是集中管理，并能根据企 业的需求创建不同政策。OSSEC客户端在大多数操作系统上本地运行，包括Linux各版本、Mac OSX和Windows。它还通过趋势科技的全球支持团队提供商业支持，这是一个非常成熟的产品。</p>
<h2 id="OpenWIPS-NG"><a href="#OpenWIPS-NG" class="headerlink" title="OpenWIPS-NG"></a>OpenWIPS-NG</h2><p>OpenWIPS-NG是一个免费的无线IDS &#x2F; IPS，它依赖于服务器、传感器和接口。它可以在普通硬件上运行。其创建者是Aircrack-NG的开发者，该系统使用Aircrack-NG内置的很 多功能和服务来进行扫描、检测和入侵防御。OpenWIPS-NG是模块化的，允许管理员下载插件来增加功能。其文件并不像某些系统一样详细，但它允许公司在预算紧张的情况下执行WIPS。</p>
<h2 id="Suricata"><a href="#Suricata" class="headerlink" title="Suricata"></a>Suricata</h2><p>在所有目前可用的IDS&#x2F;IPS系统中，Suricata最能够与Snort相抗衡。该系统有一个类似Snort的架构，依赖于像 Snort等的签名，甚至可以使用VRT Snort规则和Snort本身使用的相同的Emerging Threat规则集。Suricata比Snort更新，它将有机会赶超Snort。如果Snort不是你企业的选择，这个免费的工具最适合运行在你的企 业网络中。</p>
<h2 id="Bro-IDS"><a href="#Bro-IDS" class="headerlink" title="Bro IDS"></a>Bro IDS</h2><p>Bro IDS类似于Security Onion，它使用更多IDS规则来确定攻击来源。Bro IDS使用工具组合，曾经它使用基于Snort的签名转换成Bro签名，不过现在不再是如此，现在用户能够为Bro IDS编写自定义签名。该系统有很多详细文档信息，并已有超过15年的历史。</p>
<h2 id="Prelude-IDS"><a href="#Prelude-IDS" class="headerlink" title="Prelude IDS"></a>Prelude IDS</h2><p>从设计的方式来看定位于适应大型网络的需求， 实现了网络探测器、日志分析器、告警信息集中查看分析工具。其网络探测器部分基本上翻版了Snort的功能，完全兼容Snort的规则集。</p>
<h2 id="Firestorm"><a href="#Firestorm" class="headerlink" title="Firestorm"></a>Firestorm</h2><p>是一个非常高性能的网络入侵检测系统(NIDS)。目前它仅实现了探测器部分，完全兼容Snort的规则集，但计划包括对分析、报告、远程控制台和实时传感器配置的真正支持。它完全可插拔，因此非常灵活，，可以把告警信息记录到Prelude IDS的管理器， 自称性能上比Snort强很多。</p>
<h2 id="NetSTAT"><a href="#NetSTAT" class="headerlink" title="NetSTAT"></a>NetSTAT</h2><p>基于STAT(State Transition Analysis Technique，状态迁移分析技术)描述攻击的研究成果，使用特有的STATL语言描述攻击，攻击描述文本被STATL解释工具转换为C++代码编译进检测引擎来实现检测功能，目前已经发布了STATL语言解释转换工具及一个基本的示例网络探测器部分(很少的几个检测功能例子)。要熟练使用这个IDS工具需要比较强的编程功底，但用此IDS可以实现很复杂的检测功能。</p>
<h2 id="Bro"><a href="#Bro" class="headerlink" title="Bro"></a>Bro</h2><p>是一个Vern Paxson实现的实时网络入侵检测软件，于98年对外发布，BSD license，它的最初设计目标是实现一个在100M网络下实时告警、机制与策略分离、高可扩展性的入侵检测及网络监视审计系统。</p>
<h1 id="开源的web应用防火墙"><a href="#开源的web应用防火墙" class="headerlink" title="开源的web应用防火墙"></a>开源的web应用防火墙</h1><p>Web应用防火墙提供应用层的安全。从本质上讲，WAF提供全面的web应用安全解决方案，确保数据和Web应用程序是安全的。<br>Web应用防火墙，适用于跨站点脚本，SQL注入等，可以为Web应用程序提供安全的Web应用程序框架。Web应用防火墙允许您配置规则，通过识别阻止恶意内容。下面给出了10个最流行和广泛使用的开源的Web应用防火墙：</p>
<h2 id="ModSecurity的（Trustwave公司SpiderLabs）"><a href="#ModSecurity的（Trustwave公司SpiderLabs）" class="headerlink" title="ModSecurity的（Trustwave公司SpiderLabs）"></a>ModSecurity的（Trustwave公司SpiderLabs）</h2><p>ModSecurity是一个最古老的和广泛使用的开放源码的Web应用程序防火墙能够检测应用层威胁在互联网上，并针对一系列Web应用程序的安全问题提供了安全保障。它提供非病毒的开放来源执照，它可以集成到Apache程序。近日，ModSecurity的发布2.6.0版提供的功能安全浏览API集成，敏感数据的跟踪和数据修改功能。</p>
<h2 id="AQTRONIX-WebKnight"><a href="#AQTRONIX-WebKnight" class="headerlink" title="AQTRONIX WebKnight"></a>AQTRONIX WebKnight</h2><p>AQTRONIX WebKnight是一个开源应用程序专为Web服务器和IIS防火墙，它是通过GNU - 通用公共许可证授权。它提供了缓冲区溢出，目录遍历编码和SQL注入攻击识别&#x2F;限制功能。</p>
<h2 id="ESAPI-WAF"><a href="#ESAPI-WAF" class="headerlink" title="ESAPI WAF"></a>ESAPI WAF</h2><p>ESAPI WAF是Aspect安全开发的，它被设计为提供保护，而不是在应用层网络层。它是基于Java的WAF提供完整的安全性，从网上攻击。一些解决方案的独特功能包括出站过滤功能，降低信息泄漏。配置驱动的，而不是代码的基础，它使安装方便，只需添加在文本文件中的配置细节。</p>
<h2 id="WebCastellum"><a href="#WebCastellum" class="headerlink" title="WebCastellum"></a>WebCastellum</h2><p>WebCastellum是一个基于Java的Web应用防火墙，可以保护应用程序对跨站脚本，SQL注入，命令注入，参数操纵，它可以轻松地集成到一个基于Java的应用程序。它是基于新技术和提供保护，它可以使用现有的代码。</p>
<h2 id="Binarysec"><a href="#Binarysec" class="headerlink" title="Binarysec"></a>Binarysec</h2><p>Binarysec为Apache是​​Web应用程序防火墙软件，它可以保护应用程序免受非法HTTP和阻止可疑的请求以及。它提供保护，防止跨站点脚本，赞扬注射，参数篡改，缓冲区溢出，目录遍历，SQL注入攻击阻塞。这需要不超过10分钟来安装软件，在一台机器上，其用户界面可以管理Apache服务器和许多网站。</p>
<h2 id="x47-117-97-114-100-x69-x61-110-x40-74-85-77-x50-69-x52-x5a-46-x4e-x45-84"><a href="#x47-117-97-114-100-x69-x61-110-x40-74-85-77-x50-69-x52-x5a-46-x4e-x45-84" class="headerlink" title="&#x47;&#117;&#97;&#114;&#100;&#x69;&#x61;&#110;&#x40;&#74;&#85;&#77;&#x50;&#69;&#x52;&#x5a;&#46;&#x4e;&#x45;&#84;"></a><a href="mailto:&#x47;&#117;&#97;&#114;&#100;&#x69;&#x61;&#110;&#x40;&#74;&#85;&#77;&#x50;&#69;&#x52;&#x5a;&#46;&#x4e;&#x45;&#84;">&#x47;&#117;&#97;&#114;&#100;&#x69;&#x61;&#110;&#x40;&#74;&#85;&#77;&#x50;&#69;&#x52;&#x5a;&#46;&#x4e;&#x45;&#84;</a></h2><p><a href="mailto:&#71;&#117;&#x61;&#114;&#100;&#x69;&#97;&#110;&#64;&#x4a;&#85;&#77;&#x50;&#x45;&#x52;&#90;&#46;&#78;&#x45;&#84;">&#71;&#117;&#x61;&#114;&#100;&#x69;&#97;&#110;&#64;&#x4a;&#85;&#77;&#x50;&#x45;&#x52;&#90;&#46;&#78;&#x45;&#84;</a> HTTPS &#x2F; HTTP是一个开源应用层防火墙，HTTP &#x2F; HTTPS流量评估保护Web应用程序免受外部攻击。<a href="mailto:&#x47;&#x75;&#x61;&#x72;&#100;&#x69;&#97;&#x6e;&#x40;&#74;&#x55;&#x4d;&#80;&#69;&#x52;&#x5a;&#46;&#x4e;&#x45;&#x54;">&#x47;&#x75;&#x61;&#x72;&#100;&#x69;&#97;&#x6e;&#x40;&#74;&#x55;&#x4d;&#80;&#69;&#x52;&#x5a;&#46;&#x4e;&#x45;&#x54;</a>立即断开TCP连接，当应用程序来接触与恶意&#x2F;未经授权的请求。</p>
<h2 id="OpenWAF"><a href="#OpenWAF" class="headerlink" title="OpenWAF"></a>OpenWAF</h2><p>Art of defense是一个总部设在旧金山的Web应用程序的安全性提供者上开源OpenWAF的2011年2月启动了一个项目。这也是第一家提供Apache服务器的分布式Web应用防火墙。</p>
<h2 id="Ironbee"><a href="#Ironbee" class="headerlink" title="Ironbee"></a>Ironbee</h2><p>Qualys公司创建基于云的开源Web应用程序防火墙 - Ironbee代替了传统的IP数据包检查的HTTP评估数据。它甚至可以跟踪跨站点脚本代码的攻击。Ironbee出版通过Apache许可证版本2，它提供无版权转让。它具有模块化结构，是相当容易使用。</p>
<h2 id="Profense"><a href="#Profense" class="headerlink" title="Profense"></a>Profense</h2><p>ZION安全提供了一个开放源码的Web应用防火墙类似ModSecurity的，被称为Profense。Zion所提供的Web应用防火墙本质上是一个7层防火墙（也被称为“代理防火墙”），并检查交通封锁内容。</p>
<h2 id="Smoothwall"><a href="#Smoothwall" class="headerlink" title="Smoothwall"></a>Smoothwall</h2><p>Smoothwall提供了强大的网络安全工具来管理电子邮件。开放源码的网页过滤引擎被称为Smoothwall DansGuardian的。它具有灵活的用户规则和一个完全集成的网页过滤和安全组件。更重要的是，它提供了身份验证的网络访问和 traffic blocking。Smoothwall免费防火墙安全加固Linux的GNU操作系统。</p>
<h2 id="X-WAF"><a href="#X-WAF" class="headerlink" title="X-WAF"></a>X-WAF</h2><p>X-WAF是一款适用中、小企业的云WAF系统，让中、小企业也可以非常方便地拥有自己的免费云WAF。</p>
<h1 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h1><h2 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h2><p>工作在网络的7层之上，可以针对http应用做一些分流的策略，比如针对域名、目录结构，它的正则规则比HAProxy更为强大和灵活，这也是它目前广泛流行的主要原因之一，Nginx单凭这点可利用的场合就远多于LVS了。</p>
<h2 id="HAProxy"><a href="#HAProxy" class="headerlink" title="HAProxy"></a>HAProxy</h2><p>HAProxy 是一款提供高可用性、负载均衡以及基于TCP（第四层）和HTTP（第七层）应用的代理软件，支持虚拟主机，它是免费、快速并且可靠的一种解决方案。 HAProxy特别适用于那些负载特大的web站点，这些站点通常又需要会话保持或七层处理。HAProxy运行在时下的硬件上，完全可以支持数以万计的 并发连接。并且它的运行模式使得它可以很简单安全的整合进您当前的架构中， 同时可以保护你的web服务器不被暴露到网络上。</p>
<h2 id="LVS"><a href="#LVS" class="headerlink" title="LVS"></a>LVS</h2><p>LVS 使用Linux内核集群实现一个高性能、高可用的负载均衡服务器，它具有很好的可伸缩性（Scalability)、可靠性（Reliability)和可管理性（Manageability)。抗负载能力强、是工作在网络4层之上仅作分发之用，没有流量的产生，这个特点也决定了它在负载均衡软件里的性能最强的，对内存和cpu资源消耗比较低。</p>
<h1 id="病毒过滤"><a href="#病毒过滤" class="headerlink" title="病毒过滤"></a>病毒过滤</h1><h2 id="ClamaV"><a href="#ClamaV" class="headerlink" title="ClamaV"></a>ClamaV</h2><p>ClamAV 杀毒是Linux平台最受欢迎的杀毒软件，ClamAV属于免费开源产品，支持多种平台，如：Linux&#x2F;Unix、MAC OS X、Windows、OpenVMS。ClamAV是基于病毒扫描的命令行工具，但同时也有支持图形界面的ClamTK工具。ClamAV主要用于邮件服务器扫描邮件。它有多种接口从邮件服务器扫描邮件，支持文件格式有如：ZIP、RAR、TAR、GZIP、BZIP2、HTML、DOC、PDF,、SIS CHM、RTF等等。ClamAV有自动的数据库更新器，还可以从共享库中运行。命令行的界面让ClamAV运行流畅。</p>
<h2 id="Avria"><a href="#Avria" class="headerlink" title="Avria"></a>Avria</h2><p>另一个Linux下最好的杀毒软件是Avria免费杀毒版，Avria提供可扩展配置，控制你的计算机成为可能。它有一些很强大的特性，例如：简单的脚本安装方式、命令行扫描器、自动更新(产品、引擎、VDF)、自我完整性程序检查等等。</p>
<h2 id="AVG-免费版杀毒"><a href="#AVG-免费版杀毒" class="headerlink" title="AVG 免费版杀毒"></a>AVG 免费版杀毒</h2><p>现在有超过10亿用户使用AVG杀毒，同样是Linux机器中不错的杀毒专家，免费版提供的特性比高级版要少。AVG目前还不支持图形界面。提供防病毒和防间谍工具，AVG运行速度很快，占用系统资源很少，支持主流Linux版本如：Debian、Ubuntu、Red hat、Cent OS、FreeBSD等等</p>
<h1 id="VPN"><a href="#VPN" class="headerlink" title="VPN"></a>VPN</h1><h2 id="OpenVPN"><a href="#OpenVPN" class="headerlink" title="OpenVPN"></a>OpenVPN</h2><p>OpenVPN 是一个基于 OpenSSL 库的应用层 VPN 实现。和传统 VPN 相比，它的优点是简单易用。</p>
<p>参考链接：<br><a href="https://blog.csdn.net/chinajust/article/details/78663972">https://blog.csdn.net/chinajust/article/details/78663972</a><br><a href="http://www.aqniu.com/tools-tech/667.html">http://www.aqniu.com/tools-tech/667.html</a><br><a href="http://www.cnnetsec.com/1006.html">http://www.cnnetsec.com/1006.html</a><br><a href="https://blog.csdn.net/chengxuyuanyonghu/article/details/60468470">https://blog.csdn.net/chengxuyuanyonghu/article/details/60468470</a><br><a href="https://klionsec.github.io/2017/09/22/snortpentest/">https://klionsec.github.io/2017/09/22/snortpentest/</a></p>
]]></content>
      <categories>
        <category>安全</category>
      </categories>
      <tags>
        <tag>等保</tag>
      </tags>
  </entry>
  <entry>
    <title>查询Oracle数据库连接和资源消耗常用语句</title>
    <url>/arlo/5e07e8b7/</url>
    <content><![CDATA[<h1 id="查看数据库连接命令"><a href="#查看数据库连接命令" class="headerlink" title="查看数据库连接命令"></a>查看数据库连接命令</h1><h2 id="查看数据库最大可用连接数"><a href="#查看数据库最大可用连接数" class="headerlink" title="查看数据库最大可用连接数"></a>查看数据库最大可用连接数</h2><p><code>show parameter processes; </code></p>
<h2 id="查看数据库最大session数"><a href="#查看数据库最大session数" class="headerlink" title="查看数据库最大session数"></a>查看数据库最大session数</h2><p><code>show parameter sessions;</code></p>
<h2 id="查看数据库当前session数和活动session"><a href="#查看数据库当前session数和活动session" class="headerlink" title="查看数据库当前session数和活动session"></a>查看数据库当前session数和活动session</h2><p><code>select count(*) from v$session;</code><br><code>select count(*) from v$session where status=&#39;ACTIVE&#39;;</code></p>
<span id="more"></span>
<h2 id="查看数据库当前使用者"><a href="#查看数据库当前使用者" class="headerlink" title="查看数据库当前使用者"></a>查看数据库当前使用者</h2><p><code>SELECT osuser, a.username,cpu_time/executions/1000000||&#39;s&#39;, b.sql_text,machine from v$session a,v$sqlarea b where a.sql_address =b.address order by cpu_time/executions desc;</code></p>
<h1 id="查看数据库资源使用情况命令"><a href="#查看数据库资源使用情况命令" class="headerlink" title="查看数据库资源使用情况命令"></a>查看数据库资源使用情况命令</h1><h2 id="查看各用户的各种资源占用"><a href="#查看各用户的各种资源占用" class="headerlink" title="查看各用户的各种资源占用"></a>查看各用户的各种资源占用</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT SE.SID, SES.USERNAME, SES.OSUSER, N.NAME, SE.VALUE</span><br><span class="line">  FROM V$STATNAME N, V$SESSTAT SE, V$SESSION SES</span><br><span class="line"> WHERE N.STATISTIC# = SE.STATISTIC#</span><br><span class="line">   AND SE.SID = SES.SID</span><br><span class="line">   AND SES.USERNAME IS NOT NULL</span><br><span class="line">   AND N.NAME IN (&#x27;CPU used by this session&#x27;,</span><br><span class="line">                  &#x27;db block gets&#x27;,</span><br><span class="line">                  &#x27;consistent gets&#x27;,</span><br><span class="line">                  &#x27;physical reads&#x27;,</span><br><span class="line">                  &#x27;free buffer requested&#x27;,</span><br><span class="line">                  &#x27;table scans (long tables)&#x27;,</span><br><span class="line">                  &#x27;table scan rows gotten&#x27;,</span><br><span class="line">                  &#x27;sorts (memory)&#x27;,</span><br><span class="line">                  &#x27;sorts (disk)&#x27;,</span><br><span class="line">                  &#x27;sorts (rows)&#x27;,</span><br><span class="line">                  &#x27;session uga memory max&#x27;,</span><br><span class="line">                  &#x27;session pga memory max&#x27;)</span><br><span class="line"> ORDER BY SID, N.STATISTIC#;</span><br></pre></td></tr></table></figure>
<p><img src="/images/2018/0906/01.png" alt="z"></p>
<h2 id="占用资源的SQL-top10之类的数据"><a href="#占用资源的SQL-top10之类的数据" class="headerlink" title="占用资源的SQL top10之类的数据"></a>占用资源的SQL top10之类的数据</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT B.USERNAME USERNAME,</span><br><span class="line">       A.DISK_READS READS,</span><br><span class="line">       A.EXECUTIONS EXEC,</span><br><span class="line">       A.DISK_READS / DECODE(A.EXECUTIONS, 0, 1, A.EXECUTIONS) RDS_EXEC_RATIO,</span><br><span class="line">       A.SQL_TEXT STATEMENT</span><br><span class="line">  FROM V$SQLAREA A, DBA_USERS B</span><br><span class="line"> WHERE A.PARSING_USER_ID = B.USER_ID</span><br><span class="line">   AND A.DISK_READS &gt; 100000</span><br><span class="line"> ORDER BY A.DISK_READS DESC;</span><br></pre></td></tr></table></figure>
<p><img src="/images/2018/0906/02.png" alt="z"></p>
<h2 id="使用频率最高的5个查询"><a href="#使用频率最高的5个查询" class="headerlink" title="使用频率最高的5个查询"></a>使用频率最高的5个查询</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT SQL_TEXT, EXECUTIONS</span><br><span class="line">  FROM (SELECT SQL_TEXT,</span><br><span class="line">               EXECUTIONS,</span><br><span class="line">               RANK() OVER(ORDER BY EXECUTIONS DESC) EXEC_RANK</span><br><span class="line">          FROM V$SQL)</span><br><span class="line">WHERE EXEC_RANK &lt;= 5;</span><br></pre></td></tr></table></figure>
<p><img src="/images/2018/0906/03.png" alt="z"></p>
<h2 id="消耗磁盘读取最多的sql-top5"><a href="#消耗磁盘读取最多的sql-top5" class="headerlink" title="消耗磁盘读取最多的sql top5"></a>消耗磁盘读取最多的sql top5</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT DISK_READS, SQL_TEXT</span><br><span class="line">  FROM (SELECT SQL_TEXT,</span><br><span class="line">               DISK_READS,</span><br><span class="line">               DENSE_RANK() OVER(ORDER BY DISK_READS DESC) DISK_READS_RANK</span><br><span class="line">          FROM V$SQL)</span><br><span class="line"> WHERE DISK_READS_RANK &lt;= 5;</span><br></pre></td></tr></table></figure>
<p><img src="/images/2018/0906/04.png" alt="z"></p>
<h2 id="找出需要大量缓冲读取（逻辑读）操作的查询"><a href="#找出需要大量缓冲读取（逻辑读）操作的查询" class="headerlink" title="找出需要大量缓冲读取（逻辑读）操作的查询"></a>找出需要大量缓冲读取（逻辑读）操作的查询</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT BUFFER_GETS, SQL_TEXT</span><br><span class="line">  FROM (SELECT SQL_TEXT,</span><br><span class="line">               BUFFER_GETS,</span><br><span class="line">               DENSE_RANK() OVER(ORDER BY BUFFER_GETS DESC) BUFFER_GETS_RANK</span><br><span class="line">          FROM V$SQL)</span><br><span class="line"> WHERE BUFFER_GETS_RANK &lt;= 5;</span><br></pre></td></tr></table></figure>
<p><img src="/images/2018/0906/05.png" alt="z"></p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>Oracle</tag>
        <tag>数据库</tag>
      </tags>
  </entry>
  <entry>
    <title>CentOS 5等保二级Linux主机问题整改，升级bash，openssl，openssh</title>
    <url>/arlo/81ca458a/</url>
    <content><![CDATA[<h1 id="设置系统密码长度、复杂度、生存周期"><a href="#设置系统密码长度、复杂度、生存周期" class="headerlink" title="设置系统密码长度、复杂度、生存周期"></a>设置系统密码长度、复杂度、生存周期</h1><p><code>vim /etc/pam.d/system-auth</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">password    requisite     pam_cracklib.so  minlen=12 ucredit=-1   lcredit=-1   ocredit=-1 retry=3 difok=5	</span><br><span class="line">#minlen（最小长度）12位，ucredit(最少大写字母)1位，lcredit(最少小写字母)1位，ocredit(最少其他字符)1位，retry(重试次数)3次，difok(最少不同字符)5个 dcreit(最少数字字符)0位</span><br><span class="line">auth        required      pam_tally.so onerr=fail deny=6 unlock_time=300 even_deny_root root_unlock_time=300</span><br><span class="line">#重试最大次数6次，错误后锁定300秒</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<p><code>vim /etc/login.defs</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PASS_MAX_DAYS   90	#密码最长过期天数</span><br><span class="line">PASS_MIN_DAYS   0	#密码最小过期天数</span><br><span class="line">PASS_MIN_LEN    12	#密码最小长度</span><br><span class="line">PASS_WARN_AGE   7	#密码过期警告天数</span><br></pre></td></tr></table></figure>
<h1 id="设置空闲会话时间"><a href="#设置空闲会话时间" class="headerlink" title="设置空闲会话时间"></a>设置空闲会话时间</h1><p><code>vim /etc/profile</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">export TMOUT=300</span><br></pre></td></tr></table></figure>
<p><code>source /etc/profile</code></p>
<h1 id="升级系统补丁"><a href="#升级系统补丁" class="headerlink" title="升级系统补丁"></a>升级系统补丁</h1><p><em>注：仓库配置文件为centos5的配置文件，如果购买了正版的RHEL操作系统，可以使用RHN服务进行更新</em><br><code>vim /etc/yum.repos.d/CentOS-Base.repo</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[base]</span><br><span class="line">name=CentOS-$releasever - Base</span><br><span class="line">baseurl=http://vault.centos.org/5.11/os/x86_64/</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-5</span><br><span class="line"></span><br><span class="line">#released updates </span><br><span class="line">[updates]</span><br><span class="line">name=CentOS-$releasever - Updates</span><br><span class="line">baseurl=http://vault.centos.org/5.11/updates/x86_64/</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-5 </span><br></pre></td></tr></table></figure>
<p><code>yum update</code></p>
<h1 id="安装杀毒软件clamav"><a href="#安装杀毒软件clamav" class="headerlink" title="安装杀毒软件clamav"></a>安装杀毒软件clamav</h1><h2 id="安装centos5的epel-release扩展包"><a href="#安装centos5的epel-release扩展包" class="headerlink" title="安装centos5的epel-release扩展包"></a>安装centos5的epel-release扩展包</h2><p><code>rpm -ivh http://dl.fedoraproject.org/pub/archive/epel/5/x86_64//epel-release-5-4.noarch.rpm</code></p>
<h2 id="安装杀毒软件clamav-1"><a href="#安装杀毒软件clamav-1" class="headerlink" title="安装杀毒软件clamav"></a>安装杀毒软件clamav</h2><p><code>yum install -y clamav</code></p>
<h2 id="更新病毒库"><a href="#更新病毒库" class="headerlink" title="更新病毒库"></a>更新病毒库</h2><p><code>freshclam</code></p>
<h2 id="测试查杀病毒"><a href="#测试查杀病毒" class="headerlink" title="测试查杀病毒"></a>测试查杀病毒</h2><p><code>clamscan -r /tmp</code></p>
<h1 id="升级bash"><a href="#升级bash" class="headerlink" title="升级bash"></a>升级bash</h1><h2 id="查看bash版本"><a href="#查看bash版本" class="headerlink" title="查看bash版本"></a>查看bash版本</h2><p><code>/bin/bash --version</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GNU bash, version 3.2.25(1)-release (x86_64-redhat-linux-gnu)</span><br><span class="line">Copyright (C) 2005 Free Software Foundation, Inc.</span><br></pre></td></tr></table></figure>
<h2 id="检测漏洞"><a href="#检测漏洞" class="headerlink" title="检测漏洞"></a>检测漏洞</h2><p><code>env -i  X=&#39;() &#123; (a)=&gt;\&#39; bash -c &#39;echo date&#39;; cat echo</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">修复前输出：当前系统时间</span><br></pre></td></tr></table></figure>
<h2 id="安装基础依赖包"><a href="#安装基础依赖包" class="headerlink" title="安装基础依赖包"></a>安装基础依赖包</h2><p><code>yum -y install gcc gcc-c++ glibc</code></p>
<h2 id="下载bash最新版"><a href="#下载bash最新版" class="headerlink" title="下载bash最新版"></a>下载bash最新版</h2><p><code>wget http://ftp.gnu.org/gnu/bash/bash-4.4.tar.gz</code></p>
<h2 id="编译安装bash"><a href="#编译安装bash" class="headerlink" title="编译安装bash"></a>编译安装bash</h2><p><code>./configure</code><br><code>make &amp;&amp; make install</code></p>
<h2 id="备份旧版本bash，并设置软连接"><a href="#备份旧版本bash，并设置软连接" class="headerlink" title="备份旧版本bash，并设置软连接"></a>备份旧版本bash，并设置软连接</h2><p><code>mv /bin/bash /bin/bash.bak &amp;&amp; ln -s /usr/local/bin/bash /bin/bash</code></p>
<h2 id="查询升级后版本"><a href="#查询升级后版本" class="headerlink" title="查询升级后版本"></a>查询升级后版本</h2><p><code>/bin/bash --version</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GNU bash, version 4.4.0(1)-release (x86_64-unknown-linux-gnu)</span><br><span class="line">Copyright (C) 2016 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line"></span><br><span class="line">This is free software; you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.</span><br></pre></td></tr></table></figure>
<h2 id="再次检测漏洞"><a href="#再次检测漏洞" class="headerlink" title="再次检测漏洞"></a>再次检测漏洞</h2><p><code>env -i  X=&#39;() &#123; (a)=&gt;\&#39; bash -c &#39;echo date&#39;; cat echo</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">修复后输出：date</span><br></pre></td></tr></table></figure>
<h1 id="升级openssl"><a href="#升级openssl" class="headerlink" title="升级openssl"></a>升级openssl</h1><h2 id="查询openssl版本"><a href="#查询openssl版本" class="headerlink" title="查询openssl版本"></a>查询openssl版本</h2><p><code>/usr/bin/openssl version -a</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">OpenSSL 0.9.8e-fips-rhel5 01 Jul 2008</span><br><span class="line">built on: Tue May 31 06:58:30 CDT 2016</span><br><span class="line">platform: linux-x86_64</span><br><span class="line">options:  bn(64,64) md2(int) rc4(ptr,int) des(idx,cisc,16,int) blowfish(ptr2) </span><br><span class="line">compiler: gcc -fPIC -DOPENSSL_PIC -DZLIB -DOPENSSL_THREADS -D_REENTRANT -DDSO_DLFCN -DHAVE_DLFCN_H -DKRB5_MIT -I/usr/kerberos/include -DL_ENDIAN -DTERMIO -Wall -DMD32_REG_T=int -O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector --param=ssp-buffer-size=4 -m64 -mtune=generic -Wa,--noexecstack -DOPENSSL_USE_NEW_FUNCTIONS -fno-strict-aliasing -DOPENSSL_BN_ASM_MONT -DSHA1_ASM -DSHA256_ASM -DSHA512_ASM -DMD5_ASM -DAES_ASM</span><br><span class="line">OPENSSLDIR: &quot;/etc/pki/tls&quot;</span><br><span class="line">engines:  dynamic </span><br></pre></td></tr></table></figure>
<p><em>注：受perl版本限制，最新版的openssl1.1.1需要perl5.10+版本，本次升级为1.0.2版本</em></p>
<h2 id="下载openssl"><a href="#下载openssl" class="headerlink" title="下载openssl"></a>下载openssl</h2><p><code>wget -c https://www.openssl.org/source/openssl-1.0.2-latest.tar.gz </code><br><code>tar xf openssl-1.0.2p.tar.gz </code><br><code>cd openssl-1.0.2p</code></p>
<h2 id="编译安装openssl"><a href="#编译安装openssl" class="headerlink" title="编译安装openssl"></a>编译安装openssl</h2><p><code>./config --prefix=/usr/local/openssl</code><br><code>make &amp;&amp; make install</code></p>
<h2 id="备份之前的openssl"><a href="#备份之前的openssl" class="headerlink" title="备份之前的openssl"></a>备份之前的openssl</h2><p><code>mv /usr/bin/openssl /usr/bin/openssl.old &amp;&amp; mv /usr/include/openssl /usr/include/openssl.old</code></p>
<h2 id="添加软连接"><a href="#添加软连接" class="headerlink" title="添加软连接"></a>添加软连接</h2><p><code>ln -s /usr/local/openssl/bin/openssl /usr/bin/openssl &amp;&amp; ln -s /usr/local/openssl/include/openssl /usr/include/openssl</code></p>
<h2 id="再次查看openssl版本"><a href="#再次查看openssl版本" class="headerlink" title="再次查看openssl版本"></a>再次查看openssl版本</h2><p><code>/usr/bin/openssl version -a</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">OpenSSL 1.0.2p  14 Aug 2018</span><br><span class="line">built on: reproducible build, date unspecified</span><br><span class="line">platform: linux-x86_64</span><br><span class="line">options:  bn(64,64) rc4(16x,int) des(idx,cisc,16,int) idea(int) blowfish(idx) </span><br><span class="line">compiler: gcc -I. -I.. -I../include  -DOPENSSL_THREADS -D_REENTRANT -DDSO_DLFCN -DHAVE_DLFCN_H -Wa,--noexecstack -m64 -DL_ENDIAN -O3 -Wall -DOPENSSL_IA32_SSE2 -DOPENSSL_BN_ASM_MONT -DOPENSSL_BN_ASM_MONT5 -DOPENSSL_BN_ASM_GF2m -DRC4_ASM -DSHA1_ASM -DSHA256_ASM -DSHA512_ASM -DMD5_ASM -DAES_ASM -DVPAES_ASM -DBSAES_ASM -DWHIRLPOOL_ASM -DGHASH_ASM -DECP_NISTZ256_ASM</span><br><span class="line">OPENSSLDIR: &quot;/usr/local/openssl/ssl&quot;</span><br></pre></td></tr></table></figure>
<h2 id="将OpenSSL-的动态链接库地址写入动态链接装入器"><a href="#将OpenSSL-的动态链接库地址写入动态链接装入器" class="headerlink" title="将OpenSSL 的动态链接库地址写入动态链接装入器"></a>将OpenSSL 的动态链接库地址写入动态链接装入器</h2><p><code>echo &quot;/usr/local/openssl/lib&quot;  &gt;&gt; /etc/ld.so.conf</code><br><em>由于openssh配置时会使用旧版本的openssl库文件，需要先配置以下三个变量，让其指向新版本的opnessl库文件</em></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">export DEFAULT_LIBPATH=/usr/local/openssl/include/openssl/:/usr/local/openssl/lib/</span><br><span class="line">export LIBPATH=$&#123;LIBPATH:=$DEFAULT_LIBPATH&#125; </span><br><span class="line">export LD_LIBRARY_PATH=$&#123;LD_LIBRARY_PATH:=$DEFAULT_LIBPATH&#125;</span><br><span class="line">export LIBRARY_PATH=$&#123;LIBRARY_PATH:=$DEFAULT_LIBPATH&#125;</span><br></pre></td></tr></table></figure>
<h2 id="重新加载动态链接库"><a href="#重新加载动态链接库" class="headerlink" title="重新加载动态链接库"></a>重新加载动态链接库</h2><p><code>ldconfig -v</code></p>
<h1 id="升级openssh"><a href="#升级openssh" class="headerlink" title="升级openssh"></a>升级openssh</h1><h2 id="安装配置telnet-server"><a href="#安装配置telnet-server" class="headerlink" title="安装配置telnet server"></a>安装配置telnet server</h2><p><code>yum -y install telnet-server</code><br><code>vim /etc/xinetd.d/telnet</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">service telnet</span><br><span class="line">&#123;</span><br><span class="line">        flags           = REUSE</span><br><span class="line">        socket_type     = stream</span><br><span class="line">        wait            = no</span><br><span class="line">        user            = root</span><br><span class="line">        server          = /usr/sbin/in.telnetd</span><br><span class="line">        log_on_failure  += USERID</span><br><span class="line">        disable         = no	#修改yes为no</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>/etc/init.d/xinetd restart</code></p>
<h2 id="设置防火墙，允许访问23端口"><a href="#设置防火墙，允许访问23端口" class="headerlink" title="设置防火墙，允许访问23端口"></a>设置防火墙，允许访问23端口</h2><p><em>也可以暂时关闭防火墙</em><br><code>iptables -A RH-Firewall-1-INPUT -p tcp -m state --state NEW -m tcp --dport 23 -j ACCEPT</code><br>或者<br><code>service iptables stop </code></p>
<h2 id="允许root远程telnet登录主机"><a href="#允许root远程telnet登录主机" class="headerlink" title="允许root远程telnet登录主机"></a>允许root远程telnet登录主机</h2><p><code>vim /etc/securetty</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pts/0</span><br><span class="line">pts/1</span><br><span class="line">pts/2</span><br><span class="line">pts/3</span><br><span class="line">pts/4</span><br><span class="line">pts/5</span><br><span class="line">pts/6</span><br><span class="line">pts/7</span><br><span class="line">pts/8</span><br></pre></td></tr></table></figure>
<h2 id="以下操作使用telnet远程登录主机进行操作"><a href="#以下操作使用telnet远程登录主机进行操作" class="headerlink" title="以下操作使用telnet远程登录主机进行操作"></a>以下操作使用telnet远程登录主机进行操作</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">telnet 192.168.7.70 23</span><br><span class="line">login:root</span><br><span class="line">passwd:xxxxxx</span><br></pre></td></tr></table></figure>
<h2 id="安装基础包"><a href="#安装基础包" class="headerlink" title="安装基础包"></a>安装基础包</h2><p><code>yum install zlib zlib-devel</code></p>
<h2 id="备份配置文件"><a href="#备份配置文件" class="headerlink" title="备份配置文件"></a>备份配置文件</h2><p><code>cp -r /etc/ssh /mnt</code><br><code>cp /etc/init.d/sshd /mnt</code><br><code>cp /etc/pam.d/sshd /mnt</code>  </p>
<h2 id="下载、编译安装openssh"><a href="#下载、编译安装openssh" class="headerlink" title="下载、编译安装openssh"></a>下载、编译安装openssh</h2><p><code>wget https://cdn.openbsd.org/pub/OpenBSD/OpenSSH/portable/openssh-7.9p1.tar.gz </code><br><code>tar xf openssh-7.9p1.tar.gz</code><br><code>cd openssh-7.9p1</code><br><code>./configure --prefix=/usr -sysconfdir=/etc/ssh -with-ssl-dir=/usr/local/openssl -with-zlib -with-pam -with-md5-passwords -with-kerberos5 --without-zlib-version-check</code><br><code>make &amp;&amp; make install</code></p>
<h2 id="启动sshd访问"><a href="#启动sshd访问" class="headerlink" title="启动sshd访问"></a>启动sshd访问</h2><p><code>/etc/init.d/sshd restart</code></p>
<h2 id="查看ssh版本"><a href="#查看ssh版本" class="headerlink" title="查看ssh版本"></a>查看ssh版本</h2><p><code>ssh -V</code></p>
<h1 id="升级后ssh用户无法远程登录"><a href="#升级后ssh用户无法远程登录" class="headerlink" title="升级后ssh用户无法远程登录"></a>升级后ssh用户无法远程登录</h1><h2 id="提示Failed-password-for-root-from-x-x-x-x-port-55776-ssh2"><a href="#提示Failed-password-for-root-from-x-x-x-x-port-55776-ssh2" class="headerlink" title="提示Failed password for root from x.x.x.x port 55776 ssh2"></a>提示Failed password for root from x.x.x.x port 55776 ssh2</h2><p>切记备份&#x2F;etc&#x2F;pam.d&#x2F;sshd, 升级后如果不能远程登录，记得恢复之前备份的&#x2F;etc&#x2F;pam.d&#x2F;sshd,如果忘记备份，可以从同系列主机（centos6就复制centos6的，centos7就复制centos7的）复制该文件，重启sshd服务即可！</p>
<h2 id="Could-not-get-shadow-information-for-root"><a href="#Could-not-get-shadow-information-for-root" class="headerlink" title="Could not get shadow information for root"></a>Could not get shadow information for root</h2><p>查看selinux 状态<br><code>sestatus</code><br>如果是enabled状态，临时解决方案<code>setenforce 0</code><br>永久生效请修改<code>/etc/selinux/config</code>文件中的<code>SELINUX=disabled</code>，在合适的时候重启主机生效<br><code>sed -i s#SELINUX=enforcing#SELINUX=disabled#g /etc/selinux/config</code><br><code>reboot</code></p>
<p><a href="https://blog.csdn.net/zougen/article/details/79570500">https://blog.csdn.net/zougen/article/details/79570500</a><br><a href="http://leung4080.github.io/linux/2013/08/07/OpenSSL-OpenSSH-%E5%8D%87%E7%BA%A7%E9%85%8D%E7%BD%AE/">http://leung4080.github.io/linux/2013/08/07/OpenSSL-OpenSSH-升级配置/</a></p>
]]></content>
      <categories>
        <category>安全</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>自建KMS服务器，激活Windows &amp; Office</title>
    <url>/arlo/8566e00c/</url>
    <content><![CDATA[<p>全文转自：<a href="https://lolico.moe/tutorial/linux-kms-server.html">https://lolico.moe/tutorial/linux-kms-server.html</a></p>
<h1 id="One-key-KMS"><a href="#One-key-KMS" class="headerlink" title="One key KMS"></a>One key KMS</h1><p>Linux 快速搭建 KMS 激活服务器，让 PC 激活 Windows 和 Office 并自动续期，告别网上的来路不明的激活工具，防止意外中毒。虽然目前已经有各种 PC 用的 KMS 激活程序，例如KMSAuto或者KMS VL ALL之类的，但是他们都会被 Windows Defender 或者普通的杀毒软件认为是病毒。虽然你“相信”这些软件被报毒是很正常的，直接加入白名单了事，然而你确实不知道你从网上搜索下载的这些激活程序是不是真的经过别人的改造植入了病毒……<br>因此，我们可以利用自己的 Linux VPS 搭建 KMS 激活服务器给自己的 PC 使用，这样既安全无毒又不怕激活丢失。<br>只能激活<strong>VL 版本</strong>（即“<a href="https://baike.baidu.com/item/VOL%E7%89%88">团体批量许可证</a>”版）的 Windows，Office 则有办法从零售版转成 VL 版所以不用担心</p>
<span id="more"></span>
<h1 id="一键搭建-KMS-服务"><a href="#一键搭建-KMS-服务" class="headerlink" title="一键搭建 KMS 服务"></a>一键搭建 KMS 服务</h1><h2 id="下载脚本并运行，根据提示键入y开始安装"><a href="#下载脚本并运行，根据提示键入y开始安装" class="headerlink" title="下载脚本并运行，根据提示键入y开始安装"></a>下载脚本并运行，根据提示键入y开始安装</h2><p>CentOS &#x2F; Redhat &#x2F; Fedora</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/dakkidaze/one-key-kms/master/one-key-kms-centos.sh &amp;&amp; chmod +x one-key-kms-centos.sh &amp;&amp;./one-key-kms-centos.sh</span><br></pre></td></tr></table></figure>
<p>Debian &#x2F; Ubuntu &#x2F; Mint</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/dakkidaze/one-key-kms/master/one-key-kms-debian.sh &amp;&amp; chmod +x one-key-kms-debian.sh &amp;&amp; ./one-key-kms-debian.sh</span><br></pre></td></tr></table></figure>
<h2 id="下载这个作者写的配套脚本来控制启动-x2F-停止-x2F-重启等"><a href="#下载这个作者写的配套脚本来控制启动-x2F-停止-x2F-重启等" class="headerlink" title="下载这个作者写的配套脚本来控制启动&#x2F;停止&#x2F;重启等"></a>下载这个作者写的配套脚本来控制启动&#x2F;停止&#x2F;重启等</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#下载脚本</span><br><span class="line">wget https://raw.githubusercontent.com/dakkidaze/one-key-kms/master/kms.sh &amp;&amp; chmod +x kms.sh</span><br><span class="line">#启动 KMS 服务</span><br><span class="line">./kms.sh start</span><br><span class="line">#这个脚本可以使用的参数：</span><br><span class="line"># start | stop | restart | status</span><br></pre></td></tr></table></figure>
<h2 id="如果你的防火墙默认-DROP，那么需要手动放行1688端口"><a href="#如果你的防火墙默认-DROP，那么需要手动放行1688端口" class="headerlink" title="如果你的防火墙默认 DROP，那么需要手动放行1688端口"></a>如果你的防火墙默认 DROP，那么需要手动放行1688端口</h2><p>CentOS &#x2F; Redhat &#x2F; Fedora</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">iptables -I INPUT -p tcp --dport 1688 -j ACCEPT</span><br></pre></td></tr></table></figure>
<p>Debian &#x2F; Ubuntu &#x2F; Mint</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#如果有 ufw 的话</span><br><span class="line">ufw allow 1688</span><br><span class="line">#如果没有的话，这么方便的防火墙工具为啥不装一个嘞~</span><br></pre></td></tr></table></figure>
<h1 id="激活-Windows"><a href="#激活-Windows" class="headerlink" title="激活 Windows"></a>激活 Windows</h1><p>再次提醒，只能激活 VL 版的系统<br>以管理员身份运行命令提示符或者PowerShell，然后输入以下命令：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cd /d &quot;%SystemRoot%\system32&quot;</span><br><span class="line">slmgr /skms 你的KMS服务端主机的IP或者域名</span><br><span class="line">slmgr /ato</span><br><span class="line">slmgr /xpr</span><br></pre></td></tr></table></figure>
<p>这样，每过 180 天，系统都会自动与你的 KMS 服务器通信来激活 Windows，只要到时候你的 KMS 服务器还在，Windows 就能继续激活;当然，你也可以随时通过slmgr &#x2F;skms这条命令来更换你的 KMS 服务器地址</p>
<h1 id="激活-Office"><a href="#激活-Office" class="headerlink" title="激活 Office"></a>激活 Office</h1><p>只能激活 VL 版的 Office，如果是零售版，百度一下有很多将零售版转换为 VL 版的方法和批处理脚本；如果你比较懒，也可以直接利用KMSAuto工具来转换<br>首先确定你的 Office 版本所对应的目录名称：</p>
<table>
<thead>
<tr>
<th align="center">版本</th>
<th align="center">目录名称</th>
</tr>
</thead>
<tbody><tr>
<td align="center">2016</td>
<td align="center">Office16</td>
</tr>
<tr>
<td align="center">2013</td>
<td align="center">Office15</td>
</tr>
<tr>
<td align="center">2010</td>
<td align="center">Office14</td>
</tr>
</tbody></table>
<p>如果你的 Office 是 32 位的，那么目录就在<br><code>C:\Program Files (x86)\Microsoft Office\目录名称</code><br>如果是 64 位，那么在<br><code>C:\Program Files\Microsoft Office\目录名称</code><br>接下来以管理员身份运行命令提示符或者PowerShell，然后输入以下命令：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#以 64 位的 Office2016 为例，进入 Office 目录</span><br><span class="line">cd &quot;C:\Program Files\Microsoft Office\Office16&quot;</span><br><span class="line">cscript ospp.vbs /sethst:你的KMS服务端主机的IP或者域名</span><br><span class="line">cscript ospp.vbs /act</span><br></pre></td></tr></table></figure>
<p><img src="/images/2018/0702/01.png" alt="kms"></p>
<h1 id="其他说明"><a href="#其他说明" class="headerlink" title="其他说明"></a>其他说明</h1><h2 id="开机自启"><a href="#开机自启" class="headerlink" title="开机自启"></a>开机自启</h2><p>如果只是想简单的让 KMS 服务在 Linux 上开机自启，那么编辑&#x2F;etc&#x2F;rc.local文件，在exit 0（如果有）前面加上一句</p>
<p>假设之前下载的那个 kms.sh 脚本位于 &#x2F;root&#x2F;kms.sh<br><code>/root/kms.sh start</code><br>然后保存即可</p>
<h2 id="守护进程"><a href="#守护进程" class="headerlink" title="守护进程"></a>守护进程</h2><p>如果你有很高的要求，想让 KMS 服务以守护进程的方式运行，防止服务意外终止</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#Debian / Ubuntu / Mint 使用 apt-get 来安装 supervisor</span><br><span class="line">#CentOS / Redhat / Fedora 使用 yum 来安装 supervisor</span><br><span class="line">#这里以 Debian 系统为例</span><br><span class="line">apt-get install supervisor -y</span><br><span class="line">echo &quot;[program:kms]</span><br><span class="line">command=/usr/local/kms/vlmcsd -L 0.0.0.0:1688</span><br><span class="line">autorestart=true</span><br><span class="line">autostart=true</span><br><span class="line">user=root&quot; &gt; /etc/supervisor/conf.d/kms.conf</span><br><span class="line">/etc/init.d/supervisor restart</span><br></pre></td></tr></table></figure>
<p>如果你使用守护进程方式运行 KMS 服务，那么就不需要在&#x2F;etc&#x2F;rc.local中写入开机启动命令</p>
<h1 id="windows各版本简洁介绍"><a href="#windows各版本简洁介绍" class="headerlink" title="windows各版本简洁介绍"></a>windows各版本简洁介绍</h1><h2 id="Retail版"><a href="#Retail版" class="headerlink" title="Retail版"></a>Retail版</h2><p>RTL版Retail正式零售版，供市面上架零售。<br>另外，在安装盘的i386文件夹里有一个eula.txt文件，最后有一行EULAID，就是你的版本标识。<br>简体中文正式版是EULAID:WX.4_PRO_RTL_CN；<br>繁体中文正式版是WX.4_PRO_RTL_TW；<br>其中：<br>WX.开头是正式版，WB.开头是测试版；<br>_PRE代表家庭版，_PRO代表专业版；</p>
<h2 id="VOL版"><a href="#VOL版" class="headerlink" title="VOL版"></a>VOL版</h2><p>Volume OR Volume Licensing for Organizations 翻译过来就是组织团体批量许可，也就是大客户版，比如ZF部门、大型商业机构等统一购买的一般都是大客户版本，一般根据购买数量又可细分为开放式许可( Open License)、选择式许可(Select License)、企业许可协议(Enterprise Agreement)、教育科研许可(Academic Volume Licensing)等5种版本。</p>
<h2 id="OEM版"><a href="#OEM版" class="headerlink" title="OEM版"></a>OEM版</h2><p>Original Equipment Manufacturer 计算机厂商随机版，只能随计算机一对一出货，不可以单独零售。只能全新安不能从旧有操作系统升级，包装也不像零售版那样精美（反正是随机子打包的，穿的再好也没用*_*），通常只有一面CD盘和使用授权说明书。比如联想、DELL等出售的WINDOWS操作系统计算机一般都是。</p>
<h2 id="Alpha版"><a href="#Alpha版" class="headerlink" title="Alpha版"></a>Alpha版</h2><p>Alpha内部测试版，一般不会向外部发布，会有很多Bug，只供测试人员使用，如果您看到Alpha版本了，一般来讲对于微软来讲可能是个不好的消息。<br>Beta版Beta也是测试版，是继Alpha之后推出，这个阶段的版本会不断加入新的功能，改动也会较大，也会面向市场测试。</p>
<h1 id="RC版"><a href="#RC版" class="headerlink" title="RC版"></a>RC版</h1><p>ReleaseCandidate 测试候选版本，WINDOWS RC版不会再加入新功能，主要测试软件内的BUG。</p>
<h2 id="RTM版"><a href="#RTM版" class="headerlink" title="RTM版"></a>RTM版</h2><p>Release to Manufacture或者Resin Transfer Molding 供给生产工厂大量压片的版本，内容跟正式版是一样的，不过RTM版也会在时间上再次划分出限制版和评估版的。再次进行市场验证。</p>
<h2 id="EVAL版"><a href="#EVAL版" class="headerlink" title="EVAL版"></a>EVAL版</h2><p>Evaluation 与“评估版”类似，功能上和零售版没有区别，需要激活。</p>
<h2 id="CTP版"><a href="#CTP版" class="headerlink" title="CTP版"></a>CTP版</h2><p>Community Test Preview 社区测试试用版</p>
<p>相关链接：<br><a href="https://lolico.moe/tutorial/linux-kms-server.html">https://lolico.moe/tutorial/linux-kms-server.html</a><br><a href="https://hub.docker.com/r/ilemonrain/vlmcsd/">https://hub.docker.com/r/ilemonrain/vlmcsd/</a><br><a href="https://github.com/Wind4/vlmcsd">https://github.com/Wind4/vlmcsd</a><br><a href="https://github.com/SystemRage/py-kms">https://github.com/SystemRage/py-kms</a></p>
<hr>
]]></content>
      <categories>
        <category>服务器搭建</category>
      </categories>
      <tags>
        <tag>Windows</tag>
        <tag>激活</tag>
        <tag>KMS</tag>
      </tags>
  </entry>
  <entry>
    <title>记一次oracle故障排查记录</title>
    <url>/arlo/f82f70f8/</url>
    <content><![CDATA[<h1 id="故障现象"><a href="#故障现象" class="headerlink" title="故障现象"></a>故障现象</h1><p>window操作系统，oracle 11.2.0.1.0版本，意外断电后计算机服务中可以启动oracle服务和监听服务，但是无法连接；<br>使用sqlplus连接上去发现数据库未启动，尝试手动starup启动数据库，提示”ORA-03113:通信通道的文件结尾，进程id:7776 会话  ID: 322 序列号：25”的错误。<br>进入到oracle 日志目录下，在alter_yangquan123.log发现有明显报错“ORA-00338: log 1 of thread 1 is more recent than control file”，该错误意思是redo日志中的记录比控制文件新。</p>
<span id="more"></span>
<h1 id="ORA-00338-log-1-of-thread-1-is-more-recent-than-control-file"><a href="#ORA-00338-log-1-of-thread-1-is-more-recent-than-control-file" class="headerlink" title="ORA-00338: log 1 of thread 1 is more recent than control file"></a>ORA-00338: log 1 of thread 1 is more recent than control file</h1><h2 id="手动创建控制文件"><a href="#手动创建控制文件" class="headerlink" title="手动创建控制文件"></a>手动创建控制文件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">oradebug setmypid</span><br><span class="line">oradebug tracefile_name</span><br><span class="line">alter database backup controlfile to trace;</span><br><span class="line">select value from v$diag_info where name =&#x27;Diag Trace&#x27;;</span><br></pre></td></tr></table></figure>
<p><img src="/images/2018/1214/01.png" alt="ora"></p>
<h2 id="查看错误日志"><a href="#查看错误日志" class="headerlink" title="查看错误日志"></a>查看错误日志</h2><p>在alert_yangquan123.log日志中，我们可以看到以下这段</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">alter database backup controlfile to trace</span><br><span class="line">Backup controlfile written to trace file e:\app\adminsilu\diag\rdbms\yangquan123\trace\yangquan123_ora_20768.trc</span><br><span class="line">Completed: alter database backup controlfile to trace</span><br></pre></td></tr></table></figure>
<p>打开<code>e:\app\adminsilu\diag\rdbms\yangquan123\trace\yangquan123_ora_20768.trc</code>文件，复制一下这段，在sql窗口执行</p>
<h2 id="手动运行sql语句启动"><a href="#手动运行sql语句启动" class="headerlink" title="手动运行sql语句启动"></a>手动运行sql语句启动</h2><p><code>sqlplus / as sysdba</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SQL&gt; STARTUP NOMOUNT		#在sql窗口执行以下命令</span><br><span class="line">CREATE CONTROLFILE REUSE DATABASE &quot;YANGQUAN&quot; NORESETLOGS  NOARCHIVELOG</span><br><span class="line">    MAXLOGFILES 16</span><br><span class="line">    MAXLOGMEMBERS 3</span><br><span class="line">    MAXDATAFILES 100</span><br><span class="line">    MAXINSTANCES 8</span><br><span class="line">    MAXLOGHISTORY 292</span><br><span class="line">LOGFILE</span><br><span class="line">  GROUP 1 &#x27;E:\APP\ADMINSILU\ORADATA\YANGQUAN123\REDO01.LOG&#x27;  SIZE 50M BLOCKSIZE 512,</span><br><span class="line">  GROUP 2 &#x27;E:\APP\ADMINSILU\ORADATA\YANGQUAN123\REDO02.LOG&#x27;  SIZE 50M BLOCKSIZE 512,</span><br><span class="line">  GROUP 3 &#x27;E:\APP\ADMINSILU\ORADATA\YANGQUAN123\REDO03.LOG&#x27;  SIZE 50M BLOCKSIZE 512</span><br><span class="line">-- STANDBY LOGFILE</span><br><span class="line">DATAFILE</span><br><span class="line">  &#x27;E:\APP\ADMINSILU\ORADATA\YANGQUAN123\SYSTEM01.DBF&#x27;,</span><br><span class="line">  &#x27;E:\APP\ADMINSILU\ORADATA\YANGQUAN123\SYSAUX01.DBF&#x27;,</span><br><span class="line">  &#x27;E:\APP\ADMINSILU\ORADATA\YANGQUAN123\UNDOTBS01.DBF&#x27;,</span><br><span class="line">  &#x27;E:\APP\ADMINSILU\ORADATA\YANGQUAN123\USERS01.DBF&#x27;,</span><br><span class="line">  &#x27;E:\APP\ADMINSILU\ORADATA\YANGQUAN123\EXAMPLE01.DBF&#x27;,</span><br><span class="line">  &#x27;E:\ORACLE_DATABASEFILES\AIR_DATA.DBF&#x27;</span><br><span class="line">CHARACTER SET ZHS16GBK</span><br><span class="line">;</span><br></pre></td></tr></table></figure>
<p>启动之后查看数据库状态</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select name,open_mode from v$database;		#数据库状态已经Open了</span><br><span class="line">select * from dual;</span><br></pre></td></tr></table></figure>
<p>但是，但是几秒钟之后实例就宕掉了<br><img src="/images/2018/1214/02.png" alt="ora"></p>
<h1 id="ORA-00600-internal-error-code-arguments-4194"><a href="#ORA-00600-internal-error-code-arguments-4194" class="headerlink" title="ORA-00600: internal error code, arguments: [4194], [], [], [], [], [], [], [], [], [], [], []"></a>ORA-00600: internal error code, arguments: [4194], [], [], [], [], [], [], [], [], [], [], []</h1><p>再次查看alter日志，发现有新的报错了<code>ORA-00600: internal error code, arguments: [4194], [], [], [], [], [], [], [], [], [], [], []</code><br><img src="/images/2018/1214/03.png" alt="ora"></p>
<h2 id="通过spfile创建生成pfile"><a href="#通过spfile创建生成pfile" class="headerlink" title="通过spfile创建生成pfile"></a>通过spfile创建生成pfile</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SQL&gt; create pfile from spfile;	#创建出来的文件windows在$ORACLE_HOME/database目录下，Linux在$ORACLE_HOME/dbs目录下，格式为initORACLE_SID.ora</span><br></pre></td></tr></table></figure>
<h2 id="关闭数据库"><a href="#关闭数据库" class="headerlink" title="关闭数据库"></a>关闭数据库</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SQL&gt; shutdown immediate</span><br></pre></td></tr></table></figure>
<h2 id="修改pfile"><a href="#修改pfile" class="headerlink" title="修改pfile"></a>修改pfile</h2><p>打开inityangquan123.ora文件，修改其中的两行内容</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">*.undo_management=&#x27;MANUAL&#x27;</span><br><span class="line">*.undo_tablespace=&#x27;UNDOTBS&#x27;</span><br></pre></td></tr></table></figure>
<h2 id="使用pfile启动数据库"><a href="#使用pfile启动数据库" class="headerlink" title="使用pfile启动数据库"></a>使用pfile启动数据库</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">startup restrict pfile=&#x27;E:\app\adminsilu\product\11.2.0\dbhome_1\database\inityangquan123.ora&#x27;</span><br></pre></td></tr></table></figure>
<h2 id="查看undo文件"><a href="#查看undo文件" class="headerlink" title="查看undo文件"></a>查看undo文件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SQL&gt; select tablespace_name, status, segment_name from dba_rollback_segs where status != &#x27;OFFLINE&#x27;;</span><br><span class="line"> </span><br><span class="line">TABLESPACE_NAME                STATUS           SEGMENT_NAME</span><br><span class="line">------------------------------ ---------------- ------------------------------</span><br><span class="line">SYSTEM                         ONLINE           SYSTEM</span><br></pre></td></tr></table></figure>
<h2 id="新建一个UNDO表空间"><a href="#新建一个UNDO表空间" class="headerlink" title="新建一个UNDO表空间"></a>新建一个UNDO表空间</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SQL&gt; create undo tablespace UNDOTBS1 datafile &#x27;E:\APP\ADMINSILU\ORADATA\YANGQUAN123\UNDOTBS_01.dbf&#x27; size 4G;</span><br></pre></td></tr></table></figure>
<h2 id="删除旧的UNDO表空间"><a href="#删除旧的UNDO表空间" class="headerlink" title="删除旧的UNDO表空间"></a>删除旧的UNDO表空间</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SQL&gt; drop tablespace UNDOTBS including contents and datafiles;</span><br></pre></td></tr></table></figure>
<h2 id="关闭数据库实例"><a href="#关闭数据库实例" class="headerlink" title="关闭数据库实例"></a>关闭数据库实例</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SQL&gt; shutdown immediate;</span><br></pre></td></tr></table></figure>
<h2 id="启动数据库实例到NOMOUNT状态"><a href="#启动数据库实例到NOMOUNT状态" class="headerlink" title="启动数据库实例到NOMOUNT状态"></a>启动数据库实例到NOMOUNT状态</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SQL&gt; startup nomount;</span><br></pre></td></tr></table></figure>
<h2 id="修改spfile中的undo-tablespace参数"><a href="#修改spfile中的undo-tablespace参数" class="headerlink" title="修改spfile中的undo_tablespace参数"></a>修改spfile中的undo_tablespace参数</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SQL&gt; alter system set undo_tablespace=&#x27;UNDOTBS1&#x27; scope=spfile;</span><br></pre></td></tr></table></figure>
<h2 id="启动数据库实例（使用spfile）"><a href="#启动数据库实例（使用spfile）" class="headerlink" title="启动数据库实例（使用spfile）"></a>启动数据库实例（使用spfile）</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SQL&gt; startup;</span><br><span class="line">SQL&gt; select name,open_mode from v$database;	 #查看数据库状态并监测</span><br></pre></td></tr></table></figure>
<p>几分钟后发现数据库未关闭，但是日志中依然有报错</p>
<h1 id="ORA-08102-index-key-not-found，obj-289，file-1，block-2025-2"><a href="#ORA-08102-index-key-not-found，obj-289，file-1，block-2025-2" class="headerlink" title="ORA-08102: index key not found，obj#289，file 1，block 2025(2);"></a>ORA-08102: index key not found，obj#289，file 1，block 2025(2);</h1><h2 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a>删除索引</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SQL&gt; col object_name format a15;</span><br><span class="line">SQL&gt; col owner format a10;</span><br><span class="line">SQL&gt; select o.owner, o.object_name, o.object_id, o.object_type from dba_objects o where o.object_id = 289;</span><br><span class="line"></span><br><span class="line">OWNER      OBJECT_NAME      OBJECT_ID OBJECT_TYPE</span><br><span class="line">----------    ---------------           ----------      -------------------</span><br><span class="line">SYS           I_JOB_NEXT             289              INDEX</span><br><span class="line"></span><br><span class="line">SQL&gt; drop index i_job_next;</span><br></pre></td></tr></table></figure>
<h2 id="重建索引"><a href="#重建索引" class="headerlink" title="重建索引"></a>重建索引</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SQL&gt; create index i_job_next on job$ (next_date);</span><br></pre></td></tr></table></figure>
<h1 id="数据库实例未能加到监听中"><a href="#数据库实例未能加到监听中" class="headerlink" title="数据库实例未能加到监听中"></a>数据库实例未能加到监听中</h1><p>检查了各种文件都正常，手动<code>alter system register </code>也不行，无奈之下，使用netca重新配置了监听。</p>
<p>参考链接：<br><a href="https://blog.csdn.net/zwk626542417/article/details/39667999">https://blog.csdn.net/zwk626542417/article/details/39667999</a><br><a href="http://www.cnblogs.com/kerrycode/p/6085447.html">http://www.cnblogs.com/kerrycode/p/6085447.html</a><br><a href="https://blog.csdn.net/lwei_998/article/details/5920133">https://blog.csdn.net/lwei_998/article/details/5920133</a></p>
]]></content>
      <categories>
        <category>Troubleshooting</category>
      </categories>
      <tags>
        <tag>Oracle</tag>
      </tags>
  </entry>
  <entry>
    <title>记录一次oracle rac数据库启动故障修复过程</title>
    <url>/arlo/1b263496/</url>
    <content><![CDATA[<p>周末测试服务器意外断电关机了，早上启动起来机器，发现数据库起不来了，以下记录一下排查过程。<br>经过查看sx21和orcl两个数据库都是“Instance Shutdown”状态。</p>
<span id="more"></span>
<h1 id="查看rac启动状态"><a href="#查看rac启动状态" class="headerlink" title="查看rac启动状态"></a>查看rac启动状态</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[grid@rac1 ~]$ crsctl stat res -t</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">NAME           TARGET  STATE        SERVER                   STATE_DETAILS       </span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">Local Resources</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">ora.DATA.dg</span><br><span class="line">               ONLINE  ONLINE       rac1                                         </span><br><span class="line">               ONLINE  ONLINE       rac2                                         </span><br><span class="line">ora.LISTENER.lsnr</span><br><span class="line">               ONLINE  ONLINE       rac1                                         </span><br><span class="line">               ONLINE  ONLINE       rac2                                         </span><br><span class="line">ora.OCR.dg</span><br><span class="line">               ONLINE  ONLINE       rac1                                         </span><br><span class="line">               ONLINE  ONLINE       rac2                                         </span><br><span class="line">ora.VOTINGDISK.dg</span><br><span class="line">               ONLINE  ONLINE       rac1                                         </span><br><span class="line">               ONLINE  ONLINE       rac2                                         </span><br><span class="line">ora.asm</span><br><span class="line">               ONLINE  ONLINE       rac1                     Started             </span><br><span class="line">               ONLINE  ONLINE       rac2                     Started             </span><br><span class="line">ora.gsd</span><br><span class="line">               OFFLINE OFFLINE      rac1                                         </span><br><span class="line">               OFFLINE OFFLINE      rac2                                         </span><br><span class="line">ora.net1.network</span><br><span class="line">               ONLINE  ONLINE       rac1                                         </span><br><span class="line">               ONLINE  ONLINE       rac2                                         </span><br><span class="line">ora.ons</span><br><span class="line">               ONLINE  ONLINE       rac1                                         </span><br><span class="line">               ONLINE  ONLINE       rac2                                         </span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">Cluster Resources</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">ora.LISTENER_SCAN1.lsnr</span><br><span class="line">      1        ONLINE  ONLINE       rac1                                         </span><br><span class="line">ora.cvu</span><br><span class="line">      1        ONLINE  ONLINE       rac1                                         </span><br><span class="line">ora.oc4j</span><br><span class="line">      1        ONLINE  ONLINE       rac2                                         </span><br><span class="line">ora.orcl.db</span><br><span class="line">      1        ONLINE  OFFLINE                               Instance Shutdown   </span><br><span class="line">      2        ONLINE  OFFLINE                               Instance Shutdown   </span><br><span class="line">ora.rac1.vip</span><br><span class="line">      1        ONLINE  ONLINE       rac1                                         </span><br><span class="line">ora.rac2.vip</span><br><span class="line">      1        ONLINE  ONLINE       rac2                                         </span><br><span class="line">ora.scan1.vip</span><br><span class="line">      1        ONLINE  ONLINE       rac1                                         </span><br><span class="line">ora.sx21.db</span><br><span class="line">      1        ONLINE  OFFLINE                               Instance Shutdown   </span><br><span class="line">      2        ONLINE  OFFLINE                               Instance Shutdown   </span><br></pre></td></tr></table></figure>
<h1 id="手动启动数据库"><a href="#手动启动数据库" class="headerlink" title="手动启动数据库"></a>手动启动数据库</h1><h2 id="手动启动sx21数据库报错"><a href="#手动启动sx21数据库报错" class="headerlink" title="手动启动sx21数据库报错"></a>手动启动sx21数据库报错</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[grid@rac1 ~]$ srvctl start database -d sx21</span><br><span class="line">PRCR-1079 : Failed to start resource ora.sx21.db</span><br><span class="line">CRS-5017: The resource action &quot;ora.sx21.db start&quot; encountered the following error: </span><br><span class="line">ORA-00600: internal error code, arguments: [kcratr_scan_lastbwr], [], [], [], [], [], [], [], [], [], [], []</span><br><span class="line">. For details refer to &quot;(:CLSN00107:)&quot; in &quot;/u01/app/11.2.0/grid/log/rac1/agent/crsd/oraagent_oracle/oraagent_oracle.log&quot;.</span><br><span class="line"></span><br><span class="line">CRS-5017: The resource action &quot;ora.sx21.db start&quot; encountered the following error: </span><br><span class="line">ORA-01157: cannot identify/lock data file 6 - see DBWR trace file</span><br><span class="line">ORA-01110: data file 6: &#x27;/u01/app/oracle/11g/dbs/E:APPADMINISTRATORORADATASX21ALK.DBF&#x27;</span><br><span class="line">. For details refer to &quot;(:CLSN00107:)&quot; in &quot;/u01/app/11.2.0/grid/log/rac2/agent/crsd/oraagent_oracle/oraagent_oracle.log&quot;.</span><br><span class="line"></span><br><span class="line">CRS-2674: Start of &#x27;ora.sx21.db&#x27; on &#x27;rac1&#x27; failed</span><br><span class="line">CRS-2674: Start of &#x27;ora.sx21.db&#x27; on &#x27;rac2&#x27; failed</span><br><span class="line">CRS-2632: There are no more servers to try to place resource &#x27;ora.sx21.db&#x27; on that would satisfy its placement policy</span><br></pre></td></tr></table></figure>
<h2 id="手动启动orcl数据库报错"><a href="#手动启动orcl数据库报错" class="headerlink" title="手动启动orcl数据库报错"></a>手动启动orcl数据库报错</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[grid@rac1 ~]$ srvctl start database -d orcl</span><br><span class="line">PRCC-1014 : orcl was already running</span><br><span class="line">PRCR-1004 : Resource ora.orcl.db is already running</span><br><span class="line">PRCR-1079 : Failed to start resource ora.orcl.db</span><br><span class="line">CRS-5017: The resource action &quot;ora.orcl.db start&quot; encountered the following error: </span><br><span class="line">ORA-01589: must use RESETLOGS or NORESETLOGS option for database open</span><br><span class="line">. For details refer to &quot;(:CLSN00107:)&quot; in &quot;/u01/app/11.2.0/grid/log/rac2/agent/crsd/oraagent_oracle/oraagent_oracle.log&quot;.</span><br><span class="line"></span><br><span class="line">CRS-2674: Start of &#x27;ora.orcl.db&#x27; on &#x27;rac2&#x27; failed</span><br><span class="line">CRS-2528: Unable to place an instance of &#x27;ora.orcl.db&#x27; as all possible servers are occupied by the resource</span><br></pre></td></tr></table></figure>
<h1 id="恢复数据库sx21"><a href="#恢复数据库sx21" class="headerlink" title="恢复数据库sx21"></a>恢复数据库sx21</h1><p>另外开一个窗口，连接sx21数据库；恢复数据库</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@rac1 ~]# su - oracle</span><br><span class="line">[oracle@rac1 ~]$ export ORACLE_SID=sx211</span><br><span class="line">[oracle@rac1 ~]$ sqlplus / as sysdba</span><br><span class="line"></span><br><span class="line">SQL*Plus: Release 11.2.0.4.0 Production on Mon Apr 2 09:43:52 2018</span><br><span class="line"></span><br><span class="line">Copyright (c) 1982, 2013, Oracle.  All rights reserved.</span><br><span class="line"></span><br><span class="line">Connected to an idle instance.</span><br><span class="line"></span><br><span class="line">SQL&gt; startup</span><br><span class="line">ORACLE instance started.</span><br><span class="line"></span><br><span class="line">Total System Global Area 2471931904 bytes</span><br><span class="line">Fixed Size		    2255752 bytes</span><br><span class="line">Variable Size		  687867000 bytes</span><br><span class="line">Database Buffers	 1761607680 bytes</span><br><span class="line">Redo Buffers		   20201472 bytes</span><br><span class="line">Database mounted.</span><br><span class="line">ORA-00600: internal error code, arguments: [kcratr_scan_lastbwr], [], [], [],</span><br><span class="line">[], [], [], [], [], [], [], []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SQL&gt; select open_mode from v$database;</span><br><span class="line"></span><br><span class="line">OPEN_MODE</span><br><span class="line">--------------------</span><br><span class="line">MOUNTED</span><br><span class="line"></span><br><span class="line">SQL&gt; alter database open resetlogs;</span><br><span class="line">alter database open resetlogs</span><br><span class="line">*</span><br><span class="line">ERROR at line 1:</span><br><span class="line">ORA-01139: RESETLOGS option only valid after an incomplete database recovery</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SQL&gt; recover database;</span><br><span class="line">Media recovery complete.</span><br><span class="line">SQL&gt; alter database open;</span><br><span class="line"></span><br><span class="line">Database altered.</span><br></pre></td></tr></table></figure>
<h1 id="恢复数据库orcl"><a href="#恢复数据库orcl" class="headerlink" title="恢复数据库orcl"></a>恢复数据库orcl</h1><p>另外orcl实例，情况不太一样；直接恢复的话，会报错；需要我们手动指定恢复文件。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[oracle@rac1 ~]$ export ORACLE_SID=orcl11</span><br><span class="line">[oracle@rac1 ~]$ sqlplus / as sysdba</span><br><span class="line"></span><br><span class="line">SQL*Plus: Release 11.2.0.4.0 Production on Mon Apr 2 09:51:24 2018</span><br><span class="line"></span><br><span class="line">Copyright (c) 1982, 2013, Oracle.  All rights reserved.</span><br><span class="line"></span><br><span class="line">Connected to an idle instance.</span><br><span class="line"></span><br><span class="line">SQL&gt; startup</span><br><span class="line">ORACLE instance started.</span><br><span class="line"></span><br><span class="line">Total System Global Area 2471931904 bytes</span><br><span class="line">Fixed Size		    2255752 bytes</span><br><span class="line">Variable Size		  687867000 bytes</span><br><span class="line">Database Buffers	 1761607680 bytes</span><br><span class="line">Redo Buffers		   20201472 bytes</span><br><span class="line">Database mounted.</span><br><span class="line">ORA-00600: internal error code, arguments: [kcratr_nab_less_than_odr], [1],</span><br><span class="line">[115], [49383], [49388], [], [], [], [], [], [], []</span><br><span class="line"></span><br><span class="line">-- 查看数据库模式</span><br><span class="line">SQL&gt; select open_mode from v$database;</span><br><span class="line"></span><br><span class="line">OPEN_MODE</span><br><span class="line">--------------------</span><br><span class="line">MOUNTED</span><br><span class="line">--此时数据库启动到mount状态，尝试以resetlogs方式open数据库，也无法打开</span><br><span class="line">SQL&gt;  alter database open resetlogs;        </span><br><span class="line"> alter database open resetlogs</span><br><span class="line">*</span><br><span class="line">ERROR at line 1:</span><br><span class="line">ORA-01139: RESETLOGS option only valid after an incomplete database recovery</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SQL&gt; recover database;</span><br><span class="line">ORA-00283: recovery session canceled due to errors</span><br><span class="line">ORA-00600: internal error code, arguments: [krr_read_5], [115], [49383], [],</span><br><span class="line">[], [], [], [], [], [], [], []</span><br><span class="line">--查看当前日志文件情况</span><br><span class="line">SQL&gt; select v1.group#, member, sequence#, first_change#  from v$log v1, v$logfile v2 where v1.group# = v2.group#;</span><br><span class="line"></span><br><span class="line">    GROUP#</span><br><span class="line">----------</span><br><span class="line">MEMBER</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line"> SEQUENCE# FIRST_CHANGE#</span><br><span class="line">---------- -------------</span><br><span class="line">	 1</span><br><span class="line">+DATA/orcl/onlinelog/group_1.261.970078827</span><br><span class="line">       115	 4674751</span><br><span class="line"></span><br><span class="line">	 2</span><br><span class="line">+DATA/orcl/onlinelog/group_2.262.970078829</span><br><span class="line">       114	 4622551</span><br><span class="line"></span><br><span class="line">    GROUP#</span><br><span class="line">----------</span><br><span class="line">MEMBER</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line"> SEQUENCE# FIRST_CHANGE#</span><br><span class="line">---------- -------------</span><br><span class="line"></span><br><span class="line">	 3</span><br><span class="line">+DATA/orcl/onlinelog/group_3.266.970078993</span><br><span class="line">	65	 4646182</span><br><span class="line"></span><br><span class="line">	 4</span><br><span class="line">+DATA/orcl/onlinelog/group_4.267.970078995</span><br><span class="line"></span><br><span class="line">    GROUP#</span><br><span class="line">----------</span><br><span class="line">MEMBER</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line"> SEQUENCE# FIRST_CHANGE#</span><br><span class="line">---------- -------------</span><br><span class="line">	66	 4688519</span><br><span class="line"></span><br><span class="line">SQL&gt; recover database using backup controlfile until cancel;</span><br><span class="line">ORA-00279: change 4674751 generated at 04/01/2018 15:33:57 needed for thread 1</span><br><span class="line">ORA-00289: suggestion : /u01/app/oracle/11g/dbs/arch1_115_970078828.dbf</span><br><span class="line">ORA-00280: change 4674751 for thread 1 is in sequence #115</span><br><span class="line">-- 记录住这里提示的change号和sqeuence号，去上边记录中查找文件名</span><br><span class="line"></span><br><span class="line">Specify log: &#123;&lt;RET&gt;=suggested | filename | AUTO | CANCEL&#125;</span><br><span class="line">+DATA/orcl/onlinelog/group_1.261.970078827</span><br><span class="line">-- 输入文件路径名称，进行恢复</span><br><span class="line">ORA-00279: change 4674751 generated at 04/01/2018 10:23:59 needed for thread 2</span><br><span class="line">ORA-00289: suggestion : /u01/app/oracle/11g/dbs/arch2_65_970078828.dbf</span><br><span class="line">ORA-00280: change 4674751 for thread 2 is in sequence #65</span><br><span class="line"></span><br><span class="line">Specify log: &#123;&lt;RET&gt;=suggested | filename | AUTO | CANCEL&#125;</span><br><span class="line">+DATA/orcl/onlinelog/group_3.266.970078993</span><br><span class="line">ORA-00279: change 4688519 generated at 04/01/2018 18:01:42 needed for thread 2</span><br><span class="line">ORA-00289: suggestion : /u01/app/oracle/11g/dbs/arch2_66_970078828.dbf</span><br><span class="line">ORA-00280: change 4688519 for thread 2 is in sequence #66</span><br><span class="line">ORA-00278: log file &#x27;+DATA/orcl/onlinelog/group_3.266.970078993&#x27; no longer</span><br><span class="line">needed for this recovery</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Specify log: &#123;&lt;RET&gt;=suggested | filename | AUTO | CANCEL&#125;</span><br><span class="line">+DATA/orcl/onlinelog/group_4.267.970078995</span><br><span class="line">Log applied.</span><br><span class="line">Media recovery complete.</span><br><span class="line">--恢复完成后，再次可以正常打开数据库，重启数据库正常。</span><br><span class="line">SQL&gt; alter database open resetlogs;</span><br><span class="line"></span><br><span class="line">Database altered.</span><br><span class="line"></span><br><span class="line">SQL&gt; select open_mode from v$database;</span><br><span class="line"></span><br><span class="line">OPEN_MODE</span><br><span class="line">--------------------</span><br><span class="line">READ WRITE</span><br></pre></td></tr></table></figure>


<p>参考链接：<br><a href="https://www.cnblogs.com/jionjionyou/p/5602019.html">https://www.cnblogs.com/jionjionyou/p/5602019.html</a><br><a href="https://blog.csdn.net/linucle/article/details/8778046">https://blog.csdn.net/linucle/article/details/8778046</a></p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>Oracle</tag>
        <tag>数据库</tag>
      </tags>
  </entry>
  <entry>
    <title>部署office在线预览服务器(Office Web Apps Server)</title>
    <url>/arlo/5b552504/</url>
    <content><![CDATA[<p>Office Web Apps Server 是一种 Office 服务器产品，可提供在浏览器中查看和编辑 Office 文件的服务。可提供浏览器版 Word、PowerPoint、Excel 和 OneNote。</p>
<span id="more"></span>
<h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><p>网络环境</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">服务器名	ip地址</span><br><span class="line">dc.islocal.cc	192.168.6.111</span><br><span class="line">apps.islocal.cc	192.168.6.112</span><br></pre></td></tr></table></figure>
<p>软件环境</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">操作系统			Windows Server 2012 R2 Standard</span><br><span class="line">				.NET Framework 4.5.2</span><br><span class="line">Office Web Apps Server		cn_office_web_apps_server_2013_with_sp1_x64_dvd_3832995.iso</span><br><span class="line">Office Web Apps Server SP1	wacserversp2013-kb2880558-fullfile-x64-glb.exe</span><br><span class="line">语言包				wacserverlanguagepack.exe</span><br></pre></td></tr></table></figure>
<h1 id="规划-Office-Web-Apps-Server"><a href="#规划-Office-Web-Apps-Server" class="headerlink" title="规划 Office Web Apps Server"></a>规划 Office Web Apps Server</h1><h2 id="Office-Web-Apps-Server-支持的操作系统"><a href="#Office-Web-Apps-Server-支持的操作系统" class="headerlink" title="Office Web Apps Server 支持的操作系统"></a>Office Web Apps Server 支持的操作系统</h2><p>您可以在以下操作系统上运行 Office Web Apps Server：</p>
<blockquote>
<p>安装了 Windows Server 2008 R2 x64 版本更新的 64 位版本 Windows Server 2008 R2 Service Pack 1 (SP1) Standard、Enterprise 或 Datacenter<br>Windows Server 2012 Standard 或 Datacenter 的 64 位版本<br>64 位版本的 Windows Server 2012 R2。若要使用此操作系统，则必须使用 Office Web Apps Server Service Pack 1 (SP1)。</p>
</blockquote>
<h2 id="Office-Web-Apps-Server-的域要求"><a href="#Office-Web-Apps-Server-的域要求" class="headerlink" title="Office Web Apps Server 的域要求"></a>Office Web Apps Server 的域要求</h2><p>Office Web Apps Server 场中的服务器都必须是域的一部分。它们可以在同一个域 （推荐） 中或位于同一个林中的不同域中。但是，如果您尝试在域控制器上安装它，Office Web Apps Server 将不起作用。</p>
<h2 id="Office-Web-Apps-Server-需要的服务器角色、服务及其他软件"><a href="#Office-Web-Apps-Server-需要的服务器角色、服务及其他软件" class="headerlink" title="Office Web Apps Server 需要的服务器角色、服务及其他软件"></a>Office Web Apps Server 需要的服务器角色、服务及其他软件</h2><p>首先，以下是部署 Office Web Apps Server 时不应执行的一些操作。</p>
<blockquote>
<p>请勿在运行 Office Web Apps Server 的服务器上安装任何其他服务器应用程序。包括 Exchange Server、SharePoint Server、Lync Server 和 SQL Server。如果您的服务器不足，则可以在这些服务器的其中一台上的虚拟机实例中运行 Office Web Apps Server。<br>不要在端口 80、443 或 809 上安装依赖 Web 服务器 (IIS) 角色的任何服务或角色，因为 Office Web Apps Server 会定期删除这些端口上的 Web 应用程序。<br>不要安装任何版本的 Office。如果已经安装，在安装 Office Web Apps Server 之前必须将其卸载。<br>不要在域控制器上安装 Office Web Apps Server。它不会在包含 Active Directory 域服务 (AD DS) 的服务器上运行。</p>
</blockquote>
<p><img src="/images/2018/0119/00.png" alt="owa"></p>
<h1 id="搭建域控服务器-DC"><a href="#搭建域控服务器-DC" class="headerlink" title="搭建域控服务器(DC)"></a>搭建域控服务器(DC)</h1><p>打开服务器管理，添加角色和功能<br><img src="/images/2018/0119/01.png" alt="owa"><br>默认下一步<br><img src="/images/2018/0119/02.png" alt="owa"><br>基于角色或基于功能的安装<br><img src="/images/2018/0119/03.png" alt="owa"><br>从服务器池中选择服务器，可以看到本机名称和ip地址<br><img src="/images/2018/0119/04.png" alt="owa"><br>勾选“DNS服务器”和“Active Directory域服务”<br><img src="/images/2018/0119/05.png" alt="owa"><br>默认下一步<br><img src="/images/2018/0119/06.png" alt="owa"><br><img src="/images/2018/0119/07.png" alt="owa"><br><img src="/images/2018/0119/08.png" alt="owa"><br>最后确认一下所有选择，开始安装<br><img src="/images/2018/0119/09.png" alt="owa"><br><img src="/images/2018/0119/10.png" alt="owa"><br>安装完成<br><img src="/images/2018/0119/11.png" alt="owa"><br>服务器管理器-AD DS- 将此服务器升级为域控制器<br><img src="/images/2018/0119/12.png" alt="owa"><br>添加新林，输入根域名islocal.cc<br><img src="/images/2018/0119/14.png" alt="owa"><br>设置一个目录服务还原模式密码<br><img src="/images/2018/0119/15.png" alt="owa"><br><img src="/images/2018/0119/16.png" alt="owa"><br><img src="/images/2018/0119/17.png" alt="owa"><br><img src="/images/2018/0119/18.png" alt="owa"><br><img src="/images/2018/0119/19.png" alt="owa"><br><img src="/images/2018/0119/20.png" alt="owa"><br>至此，与控制搭建工作已经完成！</p>
<h1 id="owa服务器加入域控"><a href="#owa服务器加入域控" class="headerlink" title="owa服务器加入域控"></a>owa服务器加入域控</h1><h2 id="apps服务器上操作"><a href="#apps服务器上操作" class="headerlink" title="apps服务器上操作"></a>apps服务器上操作</h2><p>设置apps服务器ip地址，将dns地址设置为域控地址192.168.6.111<br><img src="/images/2018/0119/21.png" alt="owa"><br>点击系统属性-计算机名-更改-域-输入域名；输入域控服务器的用户名密码，成功加入，重启服务器<br><img src="/images/2018/0119/22.png" alt="owa"></p>
<h2 id="域控上操作"><a href="#域控上操作" class="headerlink" title="域控上操作"></a>域控上操作</h2><p>服务器管理器-管理-添加服务器<br><img src="/images/2018/0119/23.png" alt="owa"><br>输入服务器名称，添加到计算机<br><img src="/images/2018/0119/24.png" alt="owa"><br>在所有服务器可以看到已经添加完成<br><img src="/images/2018/0119/25.png" alt="owa"><br><em>使用域管理员登录apps服务器，登录格式为：用户名：islocal\administrator，密码：域管理员密码</em><br><em>加入域后，ping不通服务器，服务器本地关闭域防火墙</em></p>
<h1 id="owa软件安装"><a href="#owa软件安装" class="headerlink" title="owa软件安装"></a>owa软件安装</h1><h2 id="安装-NET-Framework-4-5-2"><a href="#安装-NET-Framework-4-5-2" class="headerlink" title="安装.NET Framework 4.5.2"></a>安装.NET Framework 4.5.2</h2><p>下载地址 <a href="https://www.microsoft.com/zh-cn/download/details.aspx?id=42643">https://www.microsoft.com/zh-cn/download/details.aspx?id=42643</a></p>
<h2 id="安装IIS"><a href="#安装IIS" class="headerlink" title="安装IIS"></a>安装IIS</h2><p><strong><font color="red">参考本文贴的第一张图，一定要安装全iis组件。</font></strong></p>
<h2 id="以管理员身份打开-Windows-PowerShell-提示符，然后运行此命令示例来安装必需的角色和服务"><a href="#以管理员身份打开-Windows-PowerShell-提示符，然后运行此命令示例来安装必需的角色和服务" class="headerlink" title="以管理员身份打开 Windows PowerShell 提示符，然后运行此命令示例来安装必需的角色和服务"></a>以管理员身份打开 Windows PowerShell 提示符，然后运行此命令示例来安装必需的角色和服务</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Add-WindowsFeature Web-Server,Web-Mgmt-Tools,Web-Mgmt-Console,Web-WebServer,Web-Common-Http,Web-Default-Doc,Web-Static-Content,Web-Performance,Web-Stat-Compression,Web-Dyn-Compression,Web-Security,Web-Filtering,Web-Windows-Auth,Web-App-Dev,Web-Net-Ext45,Web-Asp-Net45,Web-ISAPI-Ext,Web-ISAPI-Filter,Web-Includes,InkandHandwritingServices,NET-Framework-Features,NET-Framework-Core,NET-HTTP-Activation,NET-Non-HTTP-Activ,NET-WCF-HTTP-Activation45</span><br></pre></td></tr></table></figure>
<p><img src="/images/2018/0119/26.png" alt="owa"></p>
<h2 id="安装Office-Web-Apps-Server"><a href="#安装Office-Web-Apps-Server" class="headerlink" title="安装Office Web Apps Server"></a>安装Office Web Apps Server</h2><p>下载地址Office Web Apps Server </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ed2k://|file|cn_office_web_apps_server_2013_with_sp1_x64_dvd_3832995.iso|530315264|C33F5E985FB1B7CC74A28FAA4857458C|/</span><br></pre></td></tr></table></figure>
<p>加载到本地光驱，双击setup.exe开始安装<br><img src="/images/2018/0119/28.png" alt="owa"><br>选择文件安装位置<br><img src="/images/2018/0119/29.png" alt="owa"><br><img src="/images/2018/0119/30.png" alt="owa"><br><img src="/images/2018/0119/31.png" alt="owa"></p>
<h2 id="安装Office-Web-Apps-Server-SP1补丁包（2012R2必须项）"><a href="#安装Office-Web-Apps-Server-SP1补丁包（2012R2必须项）" class="headerlink" title="安装Office Web Apps Server SP1补丁包（2012R2必须项）"></a>安装Office Web Apps Server SP1补丁包（2012R2必须项）</h2><p>下载地址：<a href="https://support.microsoft.com/zh-cn/help/2880558/description-of-microsoft-office-web-apps-server-service-pack-1-sp1">https://support.microsoft.com/zh-cn/help/2880558/description-of-microsoft-office-web-apps-server-service-pack-1-sp1</a><br><img src="/images/2018/0119/32.png" alt="owa"><br><img src="/images/2018/0119/33.png" alt="owa"></p>
<h2 id="安装语言包"><a href="#安装语言包" class="headerlink" title="安装语言包"></a>安装语言包</h2><p>下载地址：<a href="https://www.microsoft.com/zh-cn/download/details.aspx?id=35490">https://www.microsoft.com/zh-cn/download/details.aspx?id=35490</a><br><img src="/images/2018/0119/34.png" alt="owa"></p>
<h1 id="owa服务器配置"><a href="#owa服务器配置" class="headerlink" title="owa服务器配置"></a>owa服务器配置</h1><h2 id="导入OfficeWebApps模块"><a href="#导入OfficeWebApps模块" class="headerlink" title="导入OfficeWebApps模块"></a>导入OfficeWebApps模块</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Import-Module -Name OfficeWebApps</span><br></pre></td></tr></table></figure>
<h2 id="创建一个Office-Web-Apps-Server"><a href="#创建一个Office-Web-Apps-Server" class="headerlink" title="创建一个Office Web Apps Server"></a>创建一个Office Web Apps Server</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">New-OfficeWebAppsFarm -InternalURL http://192.168.6.112 -AllowHttp -EditingEnabled</span><br><span class="line">Set-OfficeWebAppsFarm -OpenFromUrlEnabled:$true</span><br></pre></td></tr></table></figure>
<p><img src="/images/2018/0119/35.png" alt="owa"></p>
<h1 id="验证安装结果"><a href="#验证安装结果" class="headerlink" title="验证安装结果"></a>验证安装结果</h1><p><a href="http://192.168.6.112/hosting/discovery">http://192.168.6.112/hosting/discovery</a><br><img src="/images/2018/0119/36.png" alt="owa"><br><a href="http://192.168.6.112/op/generate.aspx">http://192.168.6.112/op/generate.aspx</a><br><img src="/images/2018/0119/37.png" alt="owa"><br>这里的测试文档URL必须使用域名，IP地址会报错“<span>很抱歉，由于某种原因不能为您打开。如果是本地定义的域名，只需要在预览服务器上添加一条hosts即可。<br><img src="/images/2018/0119/38.png" alt="owa"><br><img src="/images/2018/0119/39.png" alt="owa"></p>
<h1 id="其他解决方案"><a href="#其他解决方案" class="headerlink" title="其他解决方案"></a>其他解决方案</h1><ul>
<li>Collabora Online<br><code>https://www.collaboraoffice.com/collabora-online/</code></li>
<li>ONLYOFFICE<br><code>https://helpcenter.onlyoffice.com/server/document.aspx</code></li>
<li>永中DCS<br><code>http://dcs.yozosoft.com/examples.html</code></li>
<li>idocv<br><code>https://www.idocv.com</code></li>
<li>百度<br><code>https://cloud.baidu.com/product/doc.html</code></li>
</ul>
<p>参考链接：<br><a href="https://technet.microsoft.com/zh-cn/library/jj219455.aspx">https://technet.microsoft.com/zh-cn/library/jj219455.aspx</a><br><a href="http://www.cnblogs.com/timelyxyz/p/3645134.html">http://www.cnblogs.com/timelyxyz/p/3645134.html</a><br><a href="http://blog.csdn.net/duanchuanttao/article/details/53467060">http://blog.csdn.net/duanchuanttao/article/details/53467060</a><br><a href="http://blog.csdn.net/ituff/article/details/23880431">http://blog.csdn.net/ituff/article/details/23880431</a></p>
]]></content>
      <categories>
        <category>服务器搭建</category>
      </categories>
      <tags>
        <tag>Windows</tag>
        <tag>域控</tag>
        <tag>office</tag>
        <tag>在线预览</tag>
      </tags>
  </entry>
  <entry>
    <title>CentOS GRUB损坏怎么办?</title>
    <url>/arlo/741cda82/</url>
    <content><![CDATA[<p>点进来看~</p>
<span id="more"></span>

<h1 id="CentOS-6-x"><a href="#CentOS-6-x" class="headerlink" title="CentOS 6.x"></a>CentOS 6.x</h1><ol>
<li>启动显示grub损坏界面，首先要猜测boot分区，一般来说，boot分区是安装操作系统时候划分的第一个分区，猜测为（hd0,0）（sd0,0）</li>
<li>猜测boot名称，标准分区一般为&#x2F;dev&#x2F;sda1, lvm如果没有特特殊定，一般为 &#x2F;dev&#x2F;mapper&#x2F;VolGroup-lv_root</li>
</ol>
<p><img src="/images/2020/1201/09.png" alt="01"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">grub&gt; root (hd0,0)</span><br><span class="line">grub&gt; kernel /vmlinuz-2.6.32-696.el6.x86-64 ro root=/dev/mapper/VolGroup-lv_root</span><br><span class="line">grub&gt; initrd /initramfs-2.6.32-696.el6.x86-64.img</span><br><span class="line">grub&gt; boot</span><br></pre></td></tr></table></figure>

<p><img src="/images/2020/1201/10.png" alt="01"></p>
<ol start="3">
<li>进入系统后，新建一个&#x2F;boot&#x2F;grub&#x2F;grub.conf文件，内容如下</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># grub.conf generated by anaconda</span><br><span class="line">#</span><br><span class="line"># Note that you do not have to rerun grub after making changes to this file</span><br><span class="line"># NOTICE: You have a /boot partition. This means that</span><br><span class="line"># all kernel and initrd paths are relative to /boot/, eg.</span><br><span class="line"># root (hd0,0)</span><br><span class="line"># kernel /vmlinuz-version ro root=/dev/mapper/VolGroup-lv_root</span><br><span class="line"># initrd /initrd-[generic-]version.img</span><br><span class="line">#boot=/dev/sda</span><br><span class="line">default=0</span><br><span class="line">timeout=5</span><br><span class="line">splashimage=(hd0,0)/grub/splash.xpm.gz</span><br><span class="line">hiddenmenu</span><br><span class="line">title CentOS 6 (2.6.32-696.el6.x86_64)</span><br><span class="line"></span><br><span class="line">root (hd0,0)</span><br><span class="line">kernel /vmlinuz-2.6.32-696.el6.x86_64 ro root=/dev/mapper/VolGroup-lv_root rd_NO_LUKS LANG=en_US.UTF-</span><br><span class="line">8 rd_NO_MD rd_LVM_LV=VolGroup/lv_swap SYSFONT=latarcyrheb-sun16 crashkernel=auto</span><br><span class="line">rd_LVM_LV=VolGroup/lv_root KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM rhgb quiet</span><br><span class="line">initrd /initramfs-2.6.32-696.el6.x86_64.img</span><br></pre></td></tr></table></figure>

<p>最简单的方法就是找到相同方式安装的服务器，直接copy一个过来~</p>
<h1 id="CentOS-7-x"><a href="#CentOS-7-x" class="headerlink" title="CentOS 7.x"></a>CentOS 7.x</h1><p>centos 7.x 使用的是grub2，方法更加简单方便。</p>
<p><img src="/images/2020/1201/11.png" alt="01"></p>
<p>挂载镜像，从光驱引导启动，选择“Troubleshooting（故障排错）”</p>
<p><img src="/images/2020/1201/12.png" alt="01"></p>
<p>选择“Recuse a CentOS System”</p>
<p><img src="/images/2020/1201/13.png" alt="01"></p>
<p><img src="/images/2020/1201/14.png" alt="01"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Grub2 用到的命令如下:</span><br><span class="line">chroot /mnt/sysimage</span><br><span class="line">grub2-install /dev/sda</span><br><span class="line">grub2-mkconfig -o /boot/grub2/grub.cfg</span><br><span class="line">exit</span><br><span class="line">reboot</span><br><span class="line"></span><br><span class="line">早期非 grub2 用到的命令如下:</span><br><span class="line">chroot /mnt/sysroot</span><br><span class="line">grub-install /dev/sda</span><br><span class="line">grub-mkconfig -o /boot/grub/grub.cfg</span><br><span class="line">exit</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>



<p>参考：<a href="https://wiki.centos.org/zh/HowTos/Grub2">https://wiki.centos.org/zh/HowTos/Grub2</a></p>
]]></content>
      <categories>
        <category>常识</category>
      </categories>
      <tags>
        <tag>Troubleshooting</tag>
      </tags>
  </entry>
  <entry>
    <title>CentOS 忘记密码怎么办?</title>
    <url>/arlo/f8526eea/</url>
    <content><![CDATA[<p>忘记密码不要慌，Linux系统修改密码不需要借助第三方类PE工具，非常简单，操作如下~</p>
<span id="more"></span>

<h1 id="CentOS-6-x"><a href="#CentOS-6-x" class="headerlink" title="CentOS 6.x"></a>CentOS 6.x</h1><ol>
<li><p>重启操作系统</p>
</li>
<li><p>进入到grub启动界面</p>
</li>
<li><p>按字母e编辑grub启动项</p>
<p><img src="/images/2020/1201/01.png" alt="01"></p>
</li>
<li><p>按键盘上下键选择第2行，再次按字母e进入编辑模式</p>
<p><img src="/images/2020/1201/02.png" alt="01"></p>
</li>
<li><p>移动光标到行末，输入数字1&#x2F;大写字母S&#x2F;Single 都可以进入单用户模式</p>
<p><img src="/images/2020/1201/03.png" alt="01"></p>
</li>
<li><p>按enter键返回</p>
</li>
<li><p>按字母b启动</p>
<p><img src="/images/2020/1201/04.png" alt="01"></p>
</li>
<li><p>进入单用户模式，修改root密码</p>
<p><img src="/images/2020/1201/05.png" alt="01"></p>
</li>
</ol>
<h1 id="CentOS-7-x"><a href="#CentOS-7-x" class="headerlink" title="CentOS 7.x"></a>CentOS 7.x</h1><ol>
<li><p>重启操作系统</p>
</li>
<li><p>进入到grub启动界面</p>
</li>
<li><p>按字母e编辑grub启动项</p>
<p><img src="/images/2020/1201/06.png" alt="02"></p>
</li>
<li><p>将光标移动到 linux16 这一行，将 ro 修改为 rw init&#x3D;sysroot&#x2F;bin&#x2F;sh, 然后按 ctrl+x</p>
<p><img src="/images/2020/1201/07.png" alt="02"></p>
</li>
<li><p>切换根目录 chroot &#x2F;sysroot</p>
<p>修改密码<br>touch &#x2F;.autorelabel（ 新建 &#x2F;.autorelabel 文件 , 否则重启之后密码未生效 ）<br>再输入 exec &#x2F;sbin&#x2F;init 进行重启（直接 reboot 会卡主，只能强行重启了…）</p>
<p><img src="/images/2020/1201/08.png" alt="02"></p>
</li>
</ol>
]]></content>
      <categories>
        <category>常识</category>
      </categories>
      <tags>
        <tag>Troubleshooting</tag>
      </tags>
  </entry>
  <entry>
    <title>Docker|1.安装部署</title>
    <url>/arlo/4470a347/</url>
    <content><![CDATA[<h1 id="CentOS7-安装Docker"><a href="#CentOS7-安装Docker" class="headerlink" title="CentOS7 安装Docker"></a>CentOS7 安装Docker</h1><h2 id="删掉之前的docker版本"><a href="#删掉之前的docker版本" class="headerlink" title="删掉之前的docker版本"></a>删掉之前的docker版本</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum remove docker docker-common docker-selinux docker-engine</span><br></pre></td></tr></table></figure>

<h2 id="安装相关依赖"><a href="#安装相关依赖" class="headerlink" title="安装相关依赖"></a>安装相关依赖</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2</span><br></pre></td></tr></table></figure>

<h2 id="添加软件源信息"><a href="#添加软件源信息" class="headerlink" title="添加软件源信息"></a>添加软件源信息</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure>

<h2 id="更新并安装Docker-CE"><a href="#更新并安装Docker-CE" class="headerlink" title="更新并安装Docker-CE"></a>更新并安装Docker-CE</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum makecache fast</span><br><span class="line">sudo yum -y install docker-ce</span><br></pre></td></tr></table></figure>

<h2 id="开启Docker服务"><a href="#开启Docker服务" class="headerlink" title="开启Docker服务"></a>开启Docker服务</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl start docker</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h2 id="查看安装信息"><a href="#查看安装信息" class="headerlink" title="查看安装信息"></a>查看安装信息</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# docker version</span><br><span class="line">Client: Docker Engine - Community</span><br><span class="line"> Version:           19.03.5</span><br><span class="line"> API version:       1.40</span><br><span class="line"> Go version:        go1.12.12</span><br><span class="line"> Git commit:        633a0ea</span><br><span class="line"> Built:             Wed Nov 13 07:25:41 2019</span><br><span class="line"> OS/Arch:           linux/amd64</span><br><span class="line"> Experimental:      false</span><br><span class="line"></span><br><span class="line">Server: Docker Engine - Community</span><br><span class="line"> Engine:</span><br><span class="line">  Version:          19.03.5</span><br><span class="line">  API version:      1.40 (minimum version 1.12)</span><br><span class="line">  Go version:       go1.12.12</span><br><span class="line">  Git commit:       633a0ea</span><br><span class="line">  Built:            Wed Nov 13 07:24:18 2019</span><br><span class="line">  OS/Arch:          linux/amd64</span><br><span class="line">  Experimental:     false</span><br><span class="line"> containerd:</span><br><span class="line">  Version:          1.2.10</span><br><span class="line">  GitCommit:        b34a5c8af56e510852c35414db4c1f4fa6172339</span><br><span class="line"> runc:</span><br><span class="line">  Version:          1.0.0-rc8+dev</span><br><span class="line">  GitCommit:        3e425f80a8c931f88e6d94a8c831b9d5aa481657</span><br><span class="line"> docker-init:</span><br><span class="line">  Version:          0.18.0</span><br><span class="line">  GitCommit:        fec3683</span><br></pre></td></tr></table></figure>

<h1 id="配置阿里云镜像加速"><a href="#配置阿里云镜像加速" class="headerlink" title="配置阿里云镜像加速"></a>配置阿里云镜像加速</h1><p>推荐安装1.10.0以上版本的Docker客户端</p>
<h2 id="使用阿里云账号登录"><a href="#使用阿里云账号登录" class="headerlink" title="使用阿里云账号登录"></a>使用阿里云账号登录</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors</span><br></pre></td></tr></table></figure>

<h2 id="配置镜像加速器"><a href="#配置镜像加速器" class="headerlink" title="配置镜像加速器"></a>配置镜像加速器</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir -p /etc/docker</span><br><span class="line">tee /etc/docker/daemon.json &lt;&lt;-&#x27;EOF&#x27;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://yk5r9j0f.mirror.aliyuncs.com&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>DevOps</category>
      </categories>
      <tags>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>Docker|2.常用操作命令</title>
    <url>/arlo/4846dd1c/</url>
    <content><![CDATA[<h1 id="查看版本信息"><a href="#查看版本信息" class="headerlink" title="查看版本信息"></a>查看版本信息</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker version</span><br><span class="line"></span><br><span class="line">docker info</span><br></pre></td></tr></table></figure>

<h1 id="获取帮助"><a href="#获取帮助" class="headerlink" title="获取帮助"></a>获取帮助</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker --help</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h1 id="镜像命令"><a href="#镜像命令" class="headerlink" title="镜像命令"></a>镜像命令</h1><h2 id="列出本地镜像docker-images"><a href="#列出本地镜像docker-images" class="headerlink" title="列出本地镜像docker images"></a>列出本地镜像docker images</h2><p>-a:	列出本地所有镜像（包含中间层镜像）</p>
<p>-q：只显示镜像ID</p>
<p>–digests: 显示镜像的摘要信息</p>
<p>–no-trunc: 显示完整的镜像信息</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# docker images</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">tomcat              latest              b56d8850aed5        4 days ago          529MB</span><br><span class="line">centos              latest              470671670cac        3 weeks ago         237MB</span><br><span class="line">hello-world         latest              fce289e99eb9        13 months ago       1.84kB</span><br><span class="line"></span><br><span class="line">REPOSITORY: 镜像仓库源</span><br><span class="line">TAG：镜像标签</span><br><span class="line">IMAGE ID ：镜像ID</span><br><span class="line">CREATED：镜像创建时间</span><br><span class="line">SIZE: 镜像大小</span><br><span class="line">同一仓库源可以有多个TAG，代表这个仓库源的不同个版本，我们使用REPOSITORY:TAG来定义不同的镜像。</span><br><span class="line">如果不指定一个镜像的标签版本，docker将默认使用REPOSITORY:lastest镜像</span><br></pre></td></tr></table></figure>

<h2 id="查找镜像docker-search"><a href="#查找镜像docker-search" class="headerlink" title="查找镜像docker search"></a>查找镜像docker search</h2><p>虽然本地已经修改为阿里云加速镜像站，但是查询还是从<a href="https://hub.docker.com/%E4%B8%8A%E6%9F%A5%E6%89%BE%E9%95%9C%E5%83%8F%E3%80%82">https://hub.docker.com/上查找镜像。</a></p>
<p><strong>–no-trunc:</strong> 显示完整的镜像描述</p>
<p><strong>-s:</strong> 列出收藏数不小于指定的镜像</p>
<p><strong>–automated:</strong> 只列出automated build类型的镜像</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# docker search tomcat -s 50</span><br><span class="line">Flag --stars has been deprecated, use --filter=stars=3 instead</span><br><span class="line">NAME                DESCRIPTION                                     STARS               OFFICIAL            AUTOMATED</span><br><span class="line">tomcat              Apache Tomcat is an open source implementati…   2637                [OK]                </span><br><span class="line">tomee               Apache TomEE is an all-Apache Java EE certif…   74                  [OK]                </span><br><span class="line">dordoka/tomcat      Ubuntu 14.04, Oracle JDK 8 and Tomcat 8 base…   53                                      [OK]</span><br><span class="line">                                    </span><br><span class="line">NAME：镜像名称</span><br><span class="line">DESCRIPTION：镜像描述</span><br><span class="line">STARS：点赞数</span><br><span class="line">OFFICIAL：官方镜像</span><br><span class="line">AUTOMATED：自动更新</span><br></pre></td></tr></table></figure>

<h2 id="拉取镜像dockerpull"><a href="#拉取镜像dockerpull" class="headerlink" title="拉取镜像dockerpull"></a>拉取镜像dockerpull</h2><p>下载镜像 **docker pull 镜像名称[:TAG]**，如果不指定TAG，默认为lastest</p>
<h2 id="删除镜像docker-rmi"><a href="#删除镜像docker-rmi" class="headerlink" title="删除镜像docker rmi"></a>删除镜像docker rmi</h2><p><strong>删除镜像：</strong>	docker rmi  镜像名称&#x2F;镜像ID</p>
<p><strong>删除单个镜像：</strong>	docker rmi -f 镜像名称&#x2F;镜像ID</p>
<p><strong>删除多个镜像：</strong>	docker rmi -f 镜像名称1:TAG&#x2F;镜像ID1[空格]镜像名称2:TAG&#x2F;镜像ID2</p>
<p><strong>删除全部镜像：</strong>	docker rmi -f $(docker images -qa)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">删除镜像</span><br><span class="line">[root@localhost ~]# docker rmi hello-world</span><br><span class="line">Error response from daemon: conflict: unable to remove repository reference &quot;hello-world&quot; (must force) - container c0c56d69276d is using its referenced image fce289e99eb9</span><br><span class="line">强行删除镜像</span><br><span class="line">[root@localhost ~]# docker rmi -f fce289e99eb9</span><br><span class="line">Untagged: hello-world:latest</span><br><span class="line">Untagged: hello-world@sha256:9572f7cdcee8591948c2963463447a53466950b3fc15a247fcad1917ca215a2f</span><br><span class="line">Deleted: sha256:fce289e99eb9bca977dae136fbe2a82b6b7d4c372474c9235adc1741675f587e</span><br><span class="line">删除多个镜像</span><br><span class="line">[root@localhost ~]# docker rmi -f hello-world nginx</span><br><span class="line">Untagged: hello-world:latest</span><br><span class="line">Untagged: hello-world@sha256:9572f7cdcee8591948c2963463447a53466950b3fc15a247fcad1917ca215a2f</span><br><span class="line">Deleted: sha256:fce289e99eb9bca977dae136fbe2a82b6b7d4c372474c9235adc1741675f587e</span><br><span class="line">Untagged: nginx:latest</span><br><span class="line">Untagged: nginx@sha256:ad5552c786f128e389a0263104ae39f3d3c7895579d45ae716f528185b36bc6f</span><br><span class="line">Deleted: sha256:2073e0bcb60ee98548d313ead5eacbfe16d9054f8800a32bedd859922a99a6e1</span><br><span class="line">Deleted: sha256:a3136fbf38691346715cac8360bcdfca0fff812cede416469653670f04e2cab0</span><br><span class="line">Deleted: sha256:99360ffcb2da18fd9ede194efaf5d4b90e7aee99f45737e918113e6833dcf278</span><br><span class="line">Deleted: sha256:488dfecc21b1bc607e09368d2791cb784cf8c4ec5c05d2952b045b3e0f8cc01e</span><br></pre></td></tr></table></figure>

<h1 id="容器命令"><a href="#容器命令" class="headerlink" title="容器命令"></a>容器命令</h1><h2 id="新建并启动容器"><a href="#新建并启动容器" class="headerlink" title="新建并启动容器"></a>新建并启动容器</h2><p>启动容器必须有一个镜像，如果本地有镜像就从本地启动，如果本地没有则先去镜像站点拉取镜像然后启动，并保存镜像到本地；</p>
<p><strong>docker run 镜像名称</strong>   </p>
<p><strong>–name&#x3D;”容器新名字”：</strong>为容器指定一个名称；</p>
<p><strong>-d：</strong>后台运行容器，并返回容器ID，即启动守护式容器；</p>
<p><strong>-i：</strong>已交互模式运行容器，通常与-t同时使用；</p>
<p><strong>-t：</strong>为容器重新分配一个伪输入终端，通常与-i同时使用；</p>
<p><strong>-P：</strong>随机端口映射；</p>
<p><strong>-p：</strong>指定端口映射，有以下四种格式  	 ip:hostPort:containerPort  &#x2F;		ip::containerPort  &#x2F;		hostPort:containerPort &#x2F;		containerPort</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# docker images</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">tomcat              latest              b56d8850aed5        4 days ago          529MB</span><br><span class="line">centos              latest              470671670cac        3 weeks ago         237MB</span><br><span class="line"># 启动交互式容器</span><br><span class="line">[root@localhost ~]# docker run -it --name centos20200211 470671670cac</span><br><span class="line">[root@8ec89289309a /]# pwd</span><br><span class="line">/</span><br><span class="line">[root@8ec89289309a /]# ls</span><br><span class="line">bin  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var</span><br><span class="line">[root@8ec89289309a /]#</span><br><span class="line"># 启动守护式容器</span><br><span class="line">docker run -d </span><br><span class="line"># 启动一个mysql容器</span><br><span class="line">docker run -p 3306:3306 --name db1 -v /data/mysql/conf:/etc/mysql/conf.d -v /data/mysql/logs:/logs -v /data/mysql/data:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=111 -d mysql:5.7.29</span><br></pre></td></tr></table></figure>

<h2 id="列出的容器"><a href="#列出的容器" class="headerlink" title="列出的容器"></a>列出的容器</h2><p>docker ps</p>
<p><strong>-a：</strong> 列出所有的容器，包含已经停止的容器</p>
<p><strong>-l：</strong> 显示最新创建的容器</p>
<p><strong>-n：</strong> 显示最近n次创建的容器</p>
<p><strong>-q：</strong> 静默模式，只显示容器编号</p>
<p><strong>–no-trunc ：</strong>不截断输出</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">8ec89289309a        470671670cac        &quot;/bin/bash&quot;         3 minutes ago       Up 3 minutes                            centos20200211</span><br><span class="line">8a5da2a84c74        centos              &quot;/bin/bash&quot;         3 hours ago         Up 3 hours                              centos0211</span><br></pre></td></tr></table></figure>

<h2 id="退出容器"><a href="#退出容器" class="headerlink" title="退出容器"></a>退出容器</h2><ul>
<li><p>exit             容器停止退出</p>
</li>
<li><p>Ctrl+P+Q    容器不停止退出</p>
</li>
</ul>
<p>开两个终端做个操作</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# docker ps </span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">8ec89289309a        470671670cac        &quot;/bin/bash&quot;         6 minutes ago       Up 6 minutes                            centos20200211</span><br><span class="line">8a5da2a84c74        centos              &quot;/bin/bash&quot;         3 hours ago         Up 3 hours                              centos0211</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@8ec89289309a /]# exit</span><br><span class="line">exit</span><br><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# docker ps </span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">8a5da2a84c74        centos              &quot;/bin/bash&quot;         3 hours ago         Up 3 hours                              centos0211</span><br></pre></td></tr></table></figure>

<h2 id="启动容器"><a href="#启动容器" class="headerlink" title="启动容器"></a>启动容器</h2><p><strong>docker start 容器id&#x2F;容器名称</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# docker ps -a</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                        PORTS               NAMES</span><br><span class="line">ba4a8278426e        470671670cac        &quot;/bin/bash&quot;         12 minutes ago      Up 12 minutes                                     centos20200211</span><br><span class="line">f34465900de2        centos              &quot;/bin/bash&quot;         28 minutes ago      Exited (127) 27 minutes ago                       stoic_ride</span><br><span class="line">8a5da2a84c74        centos              &quot;/bin/bash&quot;         3 hours ago         Up 3 hours                                        centos0211</span><br><span class="line">899f21d7be4f        470671670cac        &quot;/bin/bash&quot;         4 hours ago         Exited (0) 3 hours ago                            dazzling_hypatia</span><br><span class="line">8821a07e9822        470671670cac        &quot;/bin/bash&quot;         4 hours ago         Exited (130) 4 hours ago                          infallible_jones</span><br><span class="line">c0c56d69276d        fce289e99eb9        &quot;/hello&quot;            31 hours ago        Exited (0) 31 hours ago                           interesting_dirac</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# docker start 899f21d7be4f</span><br><span class="line">899f21d7be4f</span><br><span class="line">[root@localhost ~]# docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">ba4a8278426e        470671670cac        &quot;/bin/bash&quot;         12 minutes ago      Up 12 minutes                           centos20200211</span><br><span class="line">8a5da2a84c74        centos              &quot;/bin/bash&quot;         3 hours ago         Up 3 hours                              centos0211</span><br><span class="line">899f21d7be4f        470671670cac        &quot;/bin/bash&quot;         4 hours ago         Up 5 seconds                            dazzling_hypatia</span><br></pre></td></tr></table></figure>

<h2 id="重启容器"><a href="#重启容器" class="headerlink" title="重启容器"></a>重启容器</h2><p><strong>docker restart 容器id&#x2F;容器名称</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# docker restart 899f21d7be4f</span><br><span class="line">899f21d7be4f</span><br><span class="line">[root@localhost ~]# docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">ba4a8278426e        470671670cac        &quot;/bin/bash&quot;         14 minutes ago      Up 14 minutes                           centos20200211</span><br><span class="line">8a5da2a84c74        centos              &quot;/bin/bash&quot;         4 hours ago         Up 4 hours                              centos0211</span><br><span class="line">899f21d7be4f        470671670cac        &quot;/bin/bash&quot;         4 hours ago         Up 1 second                             dazzling_hypatia</span><br></pre></td></tr></table></figure>

<h2 id="停止容器"><a href="#停止容器" class="headerlink" title="停止容器"></a>停止容器</h2><p><strong>docker stop 容器id&#x2F;容器名称</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">ba4a8278426e        470671670cac        &quot;/bin/bash&quot;         16 minutes ago      Up 16 minutes                           centos20200211</span><br><span class="line">8a5da2a84c74        centos              &quot;/bin/bash&quot;         4 hours ago         Up 4 hours                              centos0211</span><br><span class="line">899f21d7be4f        470671670cac        &quot;/bin/bash&quot;         4 hours ago         Up About a minute                       dazzling_hypatia</span><br><span class="line">[root@localhost ~]# docker stop 899f21d7be4f</span><br><span class="line">899f21d7be4f</span><br><span class="line">[root@localhost ~]# docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">ba4a8278426e        470671670cac        &quot;/bin/bash&quot;         16 minutes ago      Up 16 minutes                           centos20200211</span><br><span class="line">8a5da2a84c74        centos              &quot;/bin/bash&quot;         4 hours ago         Up 4 hours                              centos0211</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="强行停止容器"><a href="#强行停止容器" class="headerlink" title="强行停止容器"></a>强行停止容器</h2><p><strong>docker kill 容器id&#x2F;容器名称</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">ba4a8278426e        470671670cac        &quot;/bin/bash&quot;         16 minutes ago      Up 16 minutes                           centos20200211</span><br><span class="line">8a5da2a84c74        centos              &quot;/bin/bash&quot;         4 hours ago         Up 4 hours                              centos0211</span><br><span class="line">[root@localhost ~]# docker kill 8a5da2a84c74</span><br><span class="line">8a5da2a84c74</span><br><span class="line">[root@localhost ~]# docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">ba4a8278426e        470671670cac        &quot;/bin/bash&quot;         18 minutes ago      Up 18 minutes                           centos20200211</span><br></pre></td></tr></table></figure>

<h2 id="删除容器"><a href="#删除容器" class="headerlink" title="删除容器"></a>删除容器</h2><p>删除已经停止的单个容器	 <strong>docker rm 容器id&#x2F;容器名称</strong></p>
<p>删除正在运行的单个容器	 <strong>docker rm  -f 容器id&#x2F;容器名称</strong></p>
<p>一次性删除多个容器			 **docker rm -f $(docker ps -a -q)	&#x2F;	docker ps -a -q |xargs docker rm **</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# docker ps -a</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">ba4a8278426e        470671670cac        &quot;/bin/bash&quot;         43 minutes ago      Up 43 minutes                           centos20200211</span><br><span class="line"># 不加-f，只会删除已经停止退出的容器</span><br><span class="line">[root@localhost ~]# docker rm -f $(docker ps -a -q)</span><br><span class="line">ba4a8278426e</span><br><span class="line">[root@localhost ~]# docker ps -a</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="查看容器日志"><a href="#查看容器日志" class="headerlink" title="查看容器日志"></a>查看容器日志</h2><p><strong>docker logs  容器id</strong></p>
<p>-t 加入时间戳</p>
<p>-t 跟随最新的日志打印</p>
<p>–tail 数字显示最后的多少条</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# docker logs -t -f --tail 20  4f30ee04eac7</span><br><span class="line">2020-02-11T17:00:51.830836896Z bash: ll: command not found</span><br><span class="line">2020-02-11T17:01:56.146309331Z [root@4f30ee04eac7 /]# ss</span><br><span class="line">2020-02-11T17:01:56.279428980Z Netid     State      Recv-Q      Send-Q             Local Address:Port             Peer Address:Port      </span><br><span class="line">2020-02-11T17:02:08.128296224Z [root@4f30ee04eac7 /]# ps</span><br><span class="line">2020-02-11T17:02:08.134374708Z bash: $&#x27;\345\271ps&#x27;: command not found</span><br><span class="line">2020-02-11T17:02:13.669104746Z [root@4f30ee04eac7 /]ps -ef</span><br><span class="line">2020-02-11T17:02:13.685931632Z UID        PID  PPID  C STIME TTY          TIME CMD</span><br><span class="line">2020-02-11T17:02:13.687150066Z root         1     0  0 16:59 pts/0    00:00:00 /bin/bash</span><br><span class="line">2020-02-11T17:02:13.687185878Z root        18     1  0 17:02 pts/0    00:00:00 ps -ef</span><br><span class="line">[root@4f30ee04eac7 /]# </span><br><span class="line">[root@4f30ee04eac7 /]# ps -ef</span><br><span class="line">2020-02-11T17:05:14.601317299Z UID        PID  PPID  C STIME TTY          TIME CMD</span><br><span class="line">2020-02-11T17:05:14.601362985Z root         1     0  0 16:59 pts/0    00:00:00 /bin/bash</span><br><span class="line">2020-02-11T17:05:14.601375403Z root        19     1  0 17:05 pts/0    00:00:00 ps -ef</span><br><span class="line">2020-02-11T17:05:15.511402720Z [root@4f30ee04eac7 /]# pwd</span><br><span class="line">2020-02-11T17:05:15.511432928Z /</span><br><span class="line">2020-02-11T17:05:16.155997418Z [root@4f30ee04eac7 /]# ls</span><br><span class="line">2020-02-11T17:05:16.160923769Z bin  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var</span><br><span class="line">2020-02-11T17:05:18.225781961Z [root@4f30ee04eac7 /]# cd </span><br><span class="line">2020-02-11T17:05:20.175387626Z [root@4f30ee04eac7 ~]# id</span><br><span class="line">2020-02-11T17:05:20.180529056Z uid=0(root) gid=0(root) groups=0(root)</span><br></pre></td></tr></table></figure>

<h2 id="查看容器内进程"><a href="#查看容器内进程" class="headerlink" title="查看容器内进程"></a>查看容器内进程</h2><p><strong>docker top 容器id</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# docker top 4f30ee04eac7</span><br><span class="line">UID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD</span><br><span class="line">root                4648                4631                0                   00:59               pts/0               00:00:00            /bin/bash</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="进入容器"><a href="#进入容器" class="headerlink" title="进入容器"></a>进入容器</h2><p><strong>docker exec -it 容器ID bash</strong></p>
<p><strong>docker attach 容器ID</strong></p>
<p>attach 直接进入容器启动命令的终端，不会启动新的进程</p>
<p>exec 是在容器中打开新的终端，并且可以启动新的进程</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# docker run -it centos</span><br><span class="line">[root@cd7a272e8786 /]# </span><br><span class="line"># 按Ctrl+P+Q退出容器</span><br><span class="line">[root@localhost ~]# </span><br><span class="line">[root@localhost ~]# docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">cd7a272e8786        centos              &quot;/bin/bash&quot;         12 seconds ago      Up 11 seconds                           heuristic_perlman</span><br><span class="line">[root@localhost ~]# docker attach cd7a272e8786</span><br><span class="line">[root@cd7a272e8786 /]# </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# docker exec -it -t cd7a272e8786 ls -l /tmp</span><br><span class="line">total 8</span><br><span class="line">-rwx------ 1 root root  671 Jan 13 21:49 ks-script-_srt3u3c</span><br><span class="line">-rwx------ 1 root root 1379 Jan 13 21:49 ks-script-gpqu_kuo</span><br></pre></td></tr></table></figure>

<h2 id="查看容器内部细节"><a href="#查看容器内部细节" class="headerlink" title="查看容器内部细节"></a>查看容器内部细节</h2><p><strong>docker inspect 容器id</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# docker inspect 4f30ee04eac7</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Id&quot;: &quot;4f30ee04eac790df1edc4d1ae87df1096cb4aac78f8b5a741602068f5a3ad1ba&quot;,</span><br><span class="line">        &quot;Created&quot;: &quot;2020-02-11T16:59:07.103035515Z&quot;,</span><br><span class="line">        &quot;Path&quot;: &quot;/bin/bash&quot;,</span><br><span class="line">        &quot;Args&quot;: [],</span><br><span class="line">        &quot;State&quot;: &#123;</span><br><span class="line">            &quot;Status&quot;: &quot;running&quot;,</span><br><span class="line">            &quot;Running&quot;: true,</span><br><span class="line">            &quot;Paused&quot;: false,</span><br><span class="line">            &quot;Restarting&quot;: false,</span><br><span class="line">            &quot;OOMKilled&quot;: false,</span><br><span class="line">            &quot;Dead&quot;: false,</span><br><span class="line">            &quot;Pid&quot;: 4648,</span><br><span class="line">            &quot;ExitCode&quot;: 0,</span><br><span class="line">            &quot;Error&quot;: &quot;&quot;,</span><br><span class="line">            &quot;StartedAt&quot;: &quot;2020-02-11T16:59:07.625242514Z&quot;,</span><br><span class="line">            &quot;FinishedAt&quot;: &quot;0001-01-01T00:00:00Z&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Image&quot;: &quot;sha256:470671670cac686c7cf0081e0b37da2e9f4f768ddc5f6a26102ccd1c6954c1ee&quot;,</span><br><span class="line">        &quot;ResolvConfPath&quot;: &quot;/var/lib/docker/containers/4f30ee04eac790df1edc4d1ae87df1096cb4aac78f8b5a741602068f5a3ad1ba/resolv.conf&quot;,</span><br><span class="line">        &quot;HostnamePath&quot;: &quot;/var/lib/docker/containers/4f30ee04eac790df1edc4d1ae87df1096cb4aac78f8b5a741602068f5a3ad1ba/hostname&quot;,</span><br><span class="line">        &quot;HostsPath&quot;: &quot;/var/lib/docker/containers/4f30ee04eac790df1edc4d1ae87df1096cb4aac78f8b5a741602068f5a3ad1ba/hosts&quot;,</span><br><span class="line">        &quot;LogPath&quot;: &quot;/var/lib/docker/containers/4f30ee04eac790df1edc4d1ae87df1096cb4aac78f8b5a741602068f5a3ad1ba/4f30ee04eac790df1edc4d1ae87df1096cb4aac78f8b5a741602068f5a3ad1ba-json.log&quot;,</span><br><span class="line">        &quot;Name&quot;: &quot;/centos20200211&quot;,</span><br><span class="line">        &quot;RestartCount&quot;: 0,</span><br><span class="line">        &quot;Driver&quot;: &quot;devicemapper&quot;,</span><br><span class="line">        &quot;Platform&quot;: &quot;linux&quot;,</span><br><span class="line">        &quot;MountLabel&quot;: &quot;&quot;,</span><br><span class="line">        &quot;ProcessLabel&quot;: &quot;&quot;,</span><br><span class="line">        &quot;AppArmorProfile&quot;: &quot;&quot;,</span><br><span class="line">        &quot;ExecIDs&quot;: null,</span><br><span class="line">        &quot;HostConfig&quot;: &#123;</span><br><span class="line">            &quot;Binds&quot;: null,</span><br><span class="line">            &quot;ContainerIDFile&quot;: &quot;&quot;,</span><br><span class="line">            &quot;LogConfig&quot;: &#123;</span><br><span class="line">                &quot;Type&quot;: &quot;json-file&quot;,</span><br><span class="line">                &quot;Config&quot;: &#123;&#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;NetworkMode&quot;: &quot;default&quot;,</span><br><span class="line">            &quot;PortBindings&quot;: &#123;&#125;,</span><br><span class="line">            &quot;RestartPolicy&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;no&quot;,</span><br><span class="line">                &quot;MaximumRetryCount&quot;: 0</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;AutoRemove&quot;: false,</span><br><span class="line">            &quot;VolumeDriver&quot;: &quot;&quot;,</span><br><span class="line">            &quot;VolumesFrom&quot;: null,</span><br><span class="line">            &quot;CapAdd&quot;: null,</span><br><span class="line">            &quot;CapDrop&quot;: null,</span><br><span class="line">            &quot;Capabilities&quot;: null,</span><br><span class="line">            &quot;Dns&quot;: [],</span><br><span class="line">            &quot;DnsOptions&quot;: [],</span><br><span class="line">            &quot;DnsSearch&quot;: [],</span><br><span class="line">            &quot;ExtraHosts&quot;: null,</span><br><span class="line">            &quot;GroupAdd&quot;: null,</span><br><span class="line">            &quot;IpcMode&quot;: &quot;private&quot;,</span><br><span class="line">            &quot;Cgroup&quot;: &quot;&quot;,</span><br><span class="line">            &quot;Links&quot;: null,</span><br><span class="line">            &quot;OomScoreAdj&quot;: 0,</span><br><span class="line">            &quot;PidMode&quot;: &quot;&quot;,</span><br><span class="line">            &quot;Privileged&quot;: false,</span><br><span class="line">            &quot;PublishAllPorts&quot;: false,</span><br><span class="line">            &quot;ReadonlyRootfs&quot;: false,</span><br><span class="line">            &quot;SecurityOpt&quot;: null,</span><br><span class="line">            &quot;UTSMode&quot;: &quot;&quot;,</span><br><span class="line">            &quot;UsernsMode&quot;: &quot;&quot;,</span><br><span class="line">            &quot;ShmSize&quot;: 67108864,</span><br><span class="line">            &quot;Runtime&quot;: &quot;runc&quot;,</span><br><span class="line">            &quot;ConsoleSize&quot;: [</span><br><span class="line">                0,</span><br><span class="line">                0</span><br><span class="line">            ],</span><br><span class="line">            &quot;Isolation&quot;: &quot;&quot;,</span><br><span class="line">            &quot;CpuShares&quot;: 0,</span><br><span class="line">            &quot;Memory&quot;: 0,</span><br><span class="line">            &quot;NanoCpus&quot;: 0,</span><br><span class="line">            &quot;CgroupParent&quot;: &quot;&quot;,</span><br><span class="line">            &quot;BlkioWeight&quot;: 0,</span><br><span class="line">            &quot;BlkioWeightDevice&quot;: [],</span><br><span class="line">            &quot;BlkioDeviceReadBps&quot;: null,</span><br><span class="line">            &quot;BlkioDeviceWriteBps&quot;: null,</span><br><span class="line">            &quot;BlkioDeviceReadIOps&quot;: null,</span><br><span class="line">            &quot;BlkioDeviceWriteIOps&quot;: null,</span><br><span class="line">            &quot;CpuPeriod&quot;: 0,</span><br><span class="line">            &quot;CpuQuota&quot;: 0,</span><br><span class="line">            &quot;CpuRealtimePeriod&quot;: 0,</span><br><span class="line">            &quot;CpuRealtimeRuntime&quot;: 0,</span><br><span class="line">            &quot;CpusetCpus&quot;: &quot;&quot;,</span><br><span class="line">            &quot;CpusetMems&quot;: &quot;&quot;,</span><br><span class="line">            &quot;Devices&quot;: [],</span><br><span class="line">            &quot;DeviceCgroupRules&quot;: null,</span><br><span class="line">            &quot;DeviceRequests&quot;: null,</span><br><span class="line">            &quot;KernelMemory&quot;: 0,</span><br><span class="line">            &quot;KernelMemoryTCP&quot;: 0,</span><br><span class="line">            &quot;MemoryReservation&quot;: 0,</span><br><span class="line">            &quot;MemorySwap&quot;: 0,</span><br><span class="line">            &quot;MemorySwappiness&quot;: null,</span><br><span class="line">            &quot;OomKillDisable&quot;: false,</span><br><span class="line">            &quot;PidsLimit&quot;: null,</span><br><span class="line">            &quot;Ulimits&quot;: null,</span><br><span class="line">            &quot;CpuCount&quot;: 0,</span><br><span class="line">            &quot;CpuPercent&quot;: 0,</span><br><span class="line">            &quot;IOMaximumIOps&quot;: 0,</span><br><span class="line">            &quot;IOMaximumBandwidth&quot;: 0,</span><br><span class="line">            &quot;MaskedPaths&quot;: [</span><br><span class="line">                &quot;/proc/asound&quot;,</span><br><span class="line">                &quot;/proc/acpi&quot;,</span><br><span class="line">                &quot;/proc/kcore&quot;,</span><br><span class="line">                &quot;/proc/keys&quot;,</span><br><span class="line">                &quot;/proc/latency_stats&quot;,</span><br><span class="line">                &quot;/proc/timer_list&quot;,</span><br><span class="line">                &quot;/proc/timer_stats&quot;,</span><br><span class="line">                &quot;/proc/sched_debug&quot;,</span><br><span class="line">                &quot;/proc/scsi&quot;,</span><br><span class="line">                &quot;/sys/firmware&quot;</span><br><span class="line">            ],</span><br><span class="line">            &quot;ReadonlyPaths&quot;: [</span><br><span class="line">                &quot;/proc/bus&quot;,</span><br><span class="line">                &quot;/proc/fs&quot;,</span><br><span class="line">                &quot;/proc/irq&quot;,</span><br><span class="line">                &quot;/proc/sys&quot;,</span><br><span class="line">                &quot;/proc/sysrq-trigger&quot;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;GraphDriver&quot;: &#123;</span><br><span class="line">            &quot;Data&quot;: &#123;</span><br><span class="line">                &quot;DeviceId&quot;: &quot;32&quot;,</span><br><span class="line">                &quot;DeviceName&quot;: &quot;docker-253:0-102243954-b0ecd426ae759df49cab32c752911e1dcd35a84afc31955ba49a4699db11092d&quot;,</span><br><span class="line">                &quot;DeviceSize&quot;: &quot;10737418240&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;Name&quot;: &quot;devicemapper&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Mounts&quot;: [],</span><br><span class="line">        &quot;Config&quot;: &#123;</span><br><span class="line">            &quot;Hostname&quot;: &quot;4f30ee04eac7&quot;,</span><br><span class="line">            &quot;Domainname&quot;: &quot;&quot;,</span><br><span class="line">            &quot;User&quot;: &quot;&quot;,</span><br><span class="line">            &quot;AttachStdin&quot;: true,</span><br><span class="line">            &quot;AttachStdout&quot;: true,</span><br><span class="line">            &quot;AttachStderr&quot;: true,</span><br><span class="line">            &quot;Tty&quot;: true,</span><br><span class="line">            &quot;OpenStdin&quot;: true,</span><br><span class="line">            &quot;StdinOnce&quot;: true,</span><br><span class="line">            &quot;Env&quot;: [</span><br><span class="line">                &quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span><br><span class="line">            ],</span><br><span class="line">            &quot;Cmd&quot;: [</span><br><span class="line">                &quot;/bin/bash&quot;</span><br><span class="line">            ],</span><br><span class="line">            &quot;Image&quot;: &quot;470671670cac&quot;,</span><br><span class="line">            &quot;Volumes&quot;: null,</span><br><span class="line">            &quot;WorkingDir&quot;: &quot;&quot;,</span><br><span class="line">            &quot;Entrypoint&quot;: null,</span><br><span class="line">            &quot;OnBuild&quot;: null,</span><br><span class="line">            &quot;Labels&quot;: &#123;</span><br><span class="line">                &quot;org.label-schema.build-date&quot;: &quot;20200114&quot;,</span><br><span class="line">                &quot;org.label-schema.license&quot;: &quot;GPLv2&quot;,</span><br><span class="line">                &quot;org.label-schema.name&quot;: &quot;CentOS Base Image&quot;,</span><br><span class="line">                &quot;org.label-schema.schema-version&quot;: &quot;1.0&quot;,</span><br><span class="line">                &quot;org.label-schema.vendor&quot;: &quot;CentOS&quot;,</span><br><span class="line">                &quot;org.opencontainers.image.created&quot;: &quot;2020-01-14 00:00:00-08:00&quot;,</span><br><span class="line">                &quot;org.opencontainers.image.licenses&quot;: &quot;GPL-2.0-only&quot;,</span><br><span class="line">                &quot;org.opencontainers.image.title&quot;: &quot;CentOS Base Image&quot;,</span><br><span class="line">                &quot;org.opencontainers.image.vendor&quot;: &quot;CentOS&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;NetworkSettings&quot;: &#123;</span><br><span class="line">            &quot;Bridge&quot;: &quot;&quot;,</span><br><span class="line">            &quot;SandboxID&quot;: &quot;6b6ff8333ff7e94732a09dddc37744728b0febc6c1bf06bfaaf54bf791e576d3&quot;,</span><br><span class="line">            &quot;HairpinMode&quot;: false,</span><br><span class="line">            &quot;LinkLocalIPv6Address&quot;: &quot;&quot;,</span><br><span class="line">            &quot;LinkLocalIPv6PrefixLen&quot;: 0,</span><br><span class="line">            &quot;Ports&quot;: &#123;&#125;,</span><br><span class="line">            &quot;SandboxKey&quot;: &quot;/var/run/docker/netns/6b6ff8333ff7&quot;,</span><br><span class="line">            &quot;SecondaryIPAddresses&quot;: null,</span><br><span class="line">            &quot;SecondaryIPv6Addresses&quot;: null,</span><br><span class="line">            &quot;EndpointID&quot;: &quot;66edac9cd524223f0a57e4c58d5080114826f6a90db64f1e734f6f6f5371627e&quot;,</span><br><span class="line">            &quot;Gateway&quot;: &quot;172.17.0.1&quot;,</span><br><span class="line">            &quot;GlobalIPv6Address&quot;: &quot;&quot;,</span><br><span class="line">            &quot;GlobalIPv6PrefixLen&quot;: 0,</span><br><span class="line">            &quot;IPAddress&quot;: &quot;172.17.0.2&quot;,</span><br><span class="line">            &quot;IPPrefixLen&quot;: 16,</span><br><span class="line">            &quot;IPv6Gateway&quot;: &quot;&quot;,</span><br><span class="line">            &quot;MacAddress&quot;: &quot;02:42:ac:11:00:02&quot;,</span><br><span class="line">            &quot;Networks&quot;: &#123;</span><br><span class="line">                &quot;bridge&quot;: &#123;</span><br><span class="line">                    &quot;IPAMConfig&quot;: null,</span><br><span class="line">                    &quot;Links&quot;: null,</span><br><span class="line">                    &quot;Aliases&quot;: null,</span><br><span class="line">                    &quot;NetworkID&quot;: &quot;cd648ca5b88f8ec9e946884ed18c21fe1f2bbf214a5e3bd0094bdd61cc36f41c&quot;,</span><br><span class="line">                    &quot;EndpointID&quot;: &quot;66edac9cd524223f0a57e4c58d5080114826f6a90db64f1e734f6f6f5371627e&quot;,</span><br><span class="line">                    &quot;Gateway&quot;: &quot;172.17.0.1&quot;,</span><br><span class="line">                    &quot;IPAddress&quot;: &quot;172.17.0.2&quot;,</span><br><span class="line">                    &quot;IPPrefixLen&quot;: 16,</span><br><span class="line">                    &quot;IPv6Gateway&quot;: &quot;&quot;,</span><br><span class="line">                    &quot;GlobalIPv6Address&quot;: &quot;&quot;,</span><br><span class="line">                    &quot;GlobalIPv6PrefixLen&quot;: 0,</span><br><span class="line">                    &quot;MacAddress&quot;: &quot;02:42:ac:11:00:02&quot;,</span><br><span class="line">                    &quot;DriverOpts&quot;: null</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>DevOps</category>
      </categories>
      <tags>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>Centos7.x静默安装Oracle 12.2.0.1.0</title>
    <url>/arlo/e3c25d94/</url>
    <content><![CDATA[<p>今天项目上让安装一台12c的数据库，和之前的11g静默安装过程大致差不多，在此记录一下，方便日后查看。</p>
<h1 id="关闭selinux和firewalld"><a href="#关闭selinux和firewalld" class="headerlink" title="关闭selinux和firewalld"></a>关闭selinux和firewalld</h1><h2 id="关闭selinux"><a href="#关闭selinux" class="headerlink" title="关闭selinux"></a>关闭selinux</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/&#x27; /etc/selinux/config</span><br><span class="line">grep SELINUX=disabled /etc/selinux/config</span><br><span class="line">setenforce 0</span><br></pre></td></tr></table></figure>

<h2 id="关闭firewalld"><a href="#关闭firewalld" class="headerlink" title="关闭firewalld"></a>关闭firewalld</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl stop firewalld.service</span><br><span class="line">systemctl disable firewalld.service</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h1 id="系统基础信息配置"><a href="#系统基础信息配置" class="headerlink" title="系统基础信息配置"></a>系统基础信息配置</h1><h2 id="基础软件安装"><a href="#基础软件安装" class="headerlink" title="基础软件安装"></a>基础软件安装</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#默认是不安装32位软件包的，添加此选项</span><br><span class="line">echo &#x27;multilib_policy=all&#x27; &gt;&gt; /etc/yum.conf</span><br><span class="line">yum -y install  binutils-* compat-libstdc++-* elfutils-libelf-*  elfutils-libelf-devel-* gcc-* gcc-c++-* glibc-* glibc-common-* glibc-devel-*  glibc-headers-* ksh-* libaio-*  libaio-devel-* libgcc-*  libstdc++* libstdc++-devel* make-*  sysstat-* unixODBC-* unixODBC-devel-* compat-libcap1* mksh </span><br><span class="line"># 非必须要安装的包，个人习惯</span><br><span class="line">yum -y install vim unzip lrzsz</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#监测一下软件是否安装全</span><br><span class="line">rpm -q \</span><br><span class="line">binutils \</span><br><span class="line">compat-libstdc++-33 \</span><br><span class="line">elfutils-libelf \</span><br><span class="line">elfutils-libelf-devel \</span><br><span class="line">expat \</span><br><span class="line">gcc \</span><br><span class="line">gcc-c++ \</span><br><span class="line">glibc \</span><br><span class="line">glibc-common \</span><br><span class="line">glibc-devel \</span><br><span class="line">glibc-headers \</span><br><span class="line">libaio \</span><br><span class="line">libaio-devel \</span><br><span class="line">libgcc \</span><br><span class="line">libstdc++ \</span><br><span class="line">libstdc++-devel \</span><br><span class="line">make \</span><br><span class="line">pdksh \</span><br><span class="line">sysstat \</span><br><span class="line">unixODBC \</span><br><span class="line">unixODBC-devel \</span><br><span class="line">compat-libcap1 | grep &quot;not installed&quot;</span><br></pre></td></tr></table></figure>



<h2 id="配置主机名"><a href="#配置主机名" class="headerlink" title="配置主机名"></a>配置主机名</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hostnamectl set-hostname db-server</span><br></pre></td></tr></table></figure>

<h2 id="添加hosts记录"><a href="#添加hosts记录" class="headerlink" title="添加hosts记录"></a>添加hosts记录</h2><p><code>vim /etc/hosts</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">127.0.0.1   db-server</span><br></pre></td></tr></table></figure>

<h2 id="修改PAM配置文件"><a href="#修改PAM配置文件" class="headerlink" title="修改PAM配置文件"></a>修改PAM配置文件</h2><p><code>vim /etc/pam.d/login</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">session    required     /lib64/security/pam_limits.so</span><br><span class="line">session    required     pam_limits.so</span><br></pre></td></tr></table></figure>

<h2 id="修改内核参数"><a href="#修改内核参数" class="headerlink" title="修改内核参数"></a>修改内核参数</h2><p><code>vim /etc/sysctl.conf</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">fs.aio-max-nr = 1048576 </span><br><span class="line">fs.file-max = 6815744 </span><br><span class="line">kernel.shmmni = 4096 </span><br><span class="line">kernel.sem = 250 32000 100 128 </span><br><span class="line">net.ipv4.ip_local_port_range = 9000 65500 </span><br><span class="line">net.core.rmem_default = 262144 </span><br><span class="line">net.core.rmem_max = 4194304 </span><br><span class="line">net.core.wmem_default = 262144 </span><br><span class="line">net.core.wmem_max = 1048586</span><br></pre></td></tr></table></figure>

<p>重新加载生效<br><code>sysctl -p</code></p>
<h2 id="修改系统资源限制"><a href="#修改系统资源限制" class="headerlink" title="修改系统资源限制"></a>修改系统资源限制</h2><p><code>vim /etc/security/limits.conf</code>  </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">oracle  soft  nproc   2047 </span><br><span class="line">oracle  hard  nproc   16384 </span><br><span class="line">oracle  soft  nofile  1024 </span><br><span class="line">oracle  hard  nofile  65536</span><br><span class="line">oracle	soft  stack   10240</span><br></pre></td></tr></table></figure>

<h1 id="Oracle相关环境配置"><a href="#Oracle相关环境配置" class="headerlink" title="Oracle相关环境配置"></a>Oracle相关环境配置</h1><h2 id="新建用户"><a href="#新建用户" class="headerlink" title="新建用户"></a>新建用户</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">groupadd -g 1000 oinstall</span><br><span class="line">groupadd -g 1001 dba</span><br><span class="line">useradd -u 1000 -g oinstall -G dba oracle</span><br><span class="line">#设置oracle用户密码为oracle#123</span><br><span class="line">echo &quot;oracle:oracle#123&quot; | chpasswd</span><br></pre></td></tr></table></figure>

<h2 id="修改用户配置文件"><a href="#修改用户配置文件" class="headerlink" title="修改用户配置文件"></a>修改用户配置文件</h2><p><code>vim /etc/profile</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#添加到文件末尾即可</span><br><span class="line"></span><br><span class="line">if [ $USER = &quot;oracle&quot; ]; then</span><br><span class="line">   if [ $SHELL = &quot;/bin/ksh&quot; ]; then</span><br><span class="line">       ulimit -p 16384</span><br><span class="line">       ulimit -n 65536</span><br><span class="line">   else</span><br><span class="line">       ulimit -u 16384 -n 65536</span><br><span class="line">   fi</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<h2 id="新建目录并设置权限"><a href="#新建目录并设置权限" class="headerlink" title="新建目录并设置权限"></a>新建目录并设置权限</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir -p /u01/app/oracle/product/12.2.0/db_1</span><br><span class="line">mkdir -p /u01/app/oraInventory</span><br><span class="line">chown -R oracle.oinstall /u01/app/oracle</span><br><span class="line">chown -R oracle.oinstall /u01/app/oraInventory</span><br><span class="line">chmod -R 775 /u01/app</span><br></pre></td></tr></table></figure>

<h2 id="设置oracle用户环境变量"><a href="#设置oracle用户环境变量" class="headerlink" title="设置oracle用户环境变量"></a>设置oracle用户环境变量</h2><p><code>su - oracle</code><br><code>vim ~/.bash_profile </code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">export ORACLE_BASE=/u01/app/oracle</span><br><span class="line">export ORACLE_HOME=$ORACLE_BASE/product/12.2.0/db_1</span><br><span class="line">export ORACLE_SID=orcl</span><br><span class="line">export PATH=$PATH:$ORACLE_HOME/bin</span><br><span class="line">export LD_LIBRARY_PATH=$ORACLE_HOME/lib:/lib:/usr/lib</span><br><span class="line">export NLS_LANG=American_America.ZHS16GBK</span><br></pre></td></tr></table></figure>

<h2 id="检查环境变量是否生效"><a href="#检查环境变量是否生效" class="headerlink" title="检查环境变量是否生效"></a>检查环境变量是否生效</h2><p><code>source ~/.bash_profile</code><br><code>env |grep ORA</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ORACLE_SID=orcl</span><br><span class="line">ORACLE_BASE=/u01/app/oracle</span><br><span class="line">ORACLE_HOME=/u01/app/oracle/product/12.2.0/db_1</span><br></pre></td></tr></table></figure>

<h1 id="安装Oracle数据库"><a href="#安装Oracle数据库" class="headerlink" title="安装Oracle数据库"></a>安装Oracle数据库</h1><p>下载地址：<a href="https://www.oracle.com/database/technologies/oracle-database-software-downloads.html">https://www.oracle.com/database/technologies/oracle-database-software-downloads.html</a></p>
<p>12.2.0.1.0只有一个软件包，(3,453,696,911 bytes) (cksum - 4170261901)，将<code>linuxx64_12201_database.zip</code>传到服务器&#x2F;usr&#x2F;local&#x2F;src&#x2F; 目录下并解压。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@db-server src]# pwd</span><br><span class="line">/usr/local/src</span><br><span class="line">[root@db-server src]# unzip linuxx64_12201_database.zip </span><br><span class="line">……</span><br></pre></td></tr></table></figure>

<h2 id="安装Oracle数据库软件"><a href="#安装Oracle数据库软件" class="headerlink" title="安装Oracle数据库软件"></a>安装Oracle数据库软件</h2><p>解压后在&#x2F;usr&#x2F;local&#x2F;src&#x2F;database&#x2F;response&#x2F; 目录下有三个rsp文件，用来作为静默安装时的应答文件的模板。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">db_install.rsp	安装应答</span><br><span class="line">netca.rsp	建立监听、本地服务名等网络设置的应答</span><br><span class="line">dbca.rsp	创建数据库应答</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">--备份以下两个响应文件</span><br><span class="line">cp db_install.rsp db_install.bak</span><br><span class="line">cp dbca.rsp dbca.bak</span><br></pre></td></tr></table></figure>

<h3 id="修改db-install-rsp-文件"><a href="#修改db-install-rsp-文件" class="headerlink" title="修改db_install.rsp 文件"></a>修改db_install.rsp 文件</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@db-server response]# egrep -v &quot;^#|^$&quot; db_install.rsp </span><br><span class="line"></span><br><span class="line">oracle.install.responseFileVersion=/oracle/install/rspfmt_dbinstall_response_schema_v12.2.0</span><br><span class="line">oracle.install.option=INSTALL_DB_SWONLY</span><br><span class="line">UNIX_GROUP_NAME=oinstall</span><br><span class="line">INVENTORY_LOCATION=/u01/app/oraInventory</span><br><span class="line">ORACLE_HOME=/u01/app/oracle/product/12.2.0/db_1</span><br><span class="line">ORACLE_BASE=/u01/app/oracle</span><br><span class="line">      </span><br><span class="line">                               </span><br><span class="line">oracle.install.db.InstallEdition=EE</span><br><span class="line">oracle.install.db.OSDBA_GROUP=dba</span><br><span class="line">oracle.install.db.OSOPER_GROUP=</span><br><span class="line">oracle.install.db.OSBACKUPDBA_GROUP=dba</span><br><span class="line">oracle.install.db.OSDGDBA_GROUP=dba</span><br><span class="line">oracle.install.db.OSKMDBA_GROUP=dba</span><br><span class="line">oracle.install.db.OSRACDBA_GROUP=dba</span><br><span class="line">oracle.install.db.rac.configurationType=</span><br><span class="line">oracle.install.db.CLUSTER_NODES=</span><br><span class="line">oracle.install.db.isRACOneInstall=false</span><br><span class="line">oracle.install.db.racOneServiceName=</span><br><span class="line">oracle.install.db.rac.serverpoolName=</span><br><span class="line">oracle.install.db.rac.serverpoolCardinality=0</span><br><span class="line">oracle.install.db.config.starterdb.type=GENERAL_PURPOSE</span><br><span class="line">oracle.install.db.config.starterdb.globalDBName=</span><br><span class="line">oracle.install.db.config.starterdb.SID=</span><br><span class="line">oracle.install.db.ConfigureAsContainerDB=false</span><br><span class="line">oracle.install.db.config.PDBName=</span><br><span class="line">oracle.install.db.config.starterdb.characterSet=ZHS16GBK</span><br><span class="line">oracle.install.db.config.starterdb.memoryOption=false</span><br><span class="line">oracle.install.db.config.starterdb.memoryLimit=</span><br><span class="line">oracle.install.db.config.starterdb.installExampleSchemas=false</span><br><span class="line">oracle.install.db.config.starterdb.password.ALL=</span><br><span class="line">oracle.install.db.config.starterdb.password.SYS=</span><br><span class="line">oracle.install.db.config.starterdb.password.SYSTEM=</span><br><span class="line">oracle.install.db.config.starterdb.password.DBSNMP=</span><br><span class="line">oracle.install.db.config.starterdb.password.PDBADMIN=</span><br><span class="line">oracle.install.db.config.starterdb.managementOption=DEFAULT</span><br><span class="line">oracle.install.db.config.starterdb.omsHost=</span><br><span class="line">oracle.install.db.config.starterdb.omsPort=0</span><br><span class="line">oracle.install.db.config.starterdb.emAdminUser=</span><br><span class="line">oracle.install.db.config.starterdb.emAdminPassword=</span><br><span class="line">oracle.install.db.config.starterdb.enableRecovery=false</span><br><span class="line">oracle.install.db.config.starterdb.storageType=</span><br><span class="line">oracle.install.db.config.starterdb.fileSystemStorage.dataLocation=</span><br><span class="line">oracle.install.db.config.starterdb.fileSystemStorage.recoveryLocation=</span><br><span class="line">oracle.install.db.config.asm.diskGroup=</span><br><span class="line">oracle.install.db.config.asm.ASMSNMPPassword=</span><br><span class="line">MYORACLESUPPORT_USERNAME=</span><br><span class="line">MYORACLESUPPORT_PASSWORD=</span><br><span class="line">SECURITY_UPDATES_VIA_MYORACLESUPPORT=false</span><br><span class="line">DECLINE_SECURITY_UPDATES=true</span><br><span class="line">PROXY_HOST=</span><br><span class="line">PROXY_PORT=</span><br><span class="line">PROXY_USER=</span><br><span class="line">PROXY_PWD=</span><br><span class="line">COLLECTOR_SUPPORTHUB_URL=</span><br></pre></td></tr></table></figure>

<h3 id="执行静默安装"><a href="#执行静默安装" class="headerlink" title="执行静默安装"></a>执行静默安装</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[oracle@db-server database]$ pwd</span><br><span class="line">/usr/local/src/database</span><br><span class="line">[oracle@db-server database]$ ./runInstaller -silent -ignorePrereq -ignoreSysPrereqs -responseFile /usr/local/src/database/response/db_install.rsp </span><br><span class="line">Starting Oracle Universal Installer...</span><br><span class="line"></span><br><span class="line">Checking Temp space: must be greater than 500 MB.   Actual 29865 MB    Passed</span><br><span class="line">Checking swap space: must be greater than 150 MB.   Actual 2047 MB    Passed</span><br><span class="line">Preparing to launch Oracle Universal Installer from /tmp/OraInstall2020-06-18_03-36-22AM. Please wait ...[oracle@db-server database]$ You can find the log of this install session at:</span><br><span class="line"> /u01/app/oraInventory/logs/installActions2020-06-18_03-36-22AM.log</span><br><span class="line">The installation of Oracle Database 12c was successful.</span><br><span class="line">Please check &#x27;/u01/app/oraInventory/logs/silentInstall2020-06-18_03-36-22AM.log&#x27; for more details.</span><br><span class="line"></span><br><span class="line">As a root user, execute the following script(s):</span><br><span class="line">	1. /u01/app/oraInventory/orainstRoot.sh</span><br><span class="line">	2. /u01/app/oracle/product/12.2.0/db_1/root.sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Successfully Setup Software.</span><br></pre></td></tr></table></figure>

<p>安装过程中，我们可以另开一个终端查看安装日志</p>
<p><code>tail -f /u01/app/oraInventory/logs/silentInstall2020-06-18_03-36-22AM.log</code></p>
<h3 id="以root身份执行以下脚本，然后在刚才的安装界面敲回车，完成安装"><a href="#以root身份执行以下脚本，然后在刚才的安装界面敲回车，完成安装" class="headerlink" title="以root身份执行以下脚本，然后在刚才的安装界面敲回车，完成安装"></a>以root身份执行以下脚本，然后在刚才的安装界面敲回车，完成安装</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@db-server response]# /u01/app/oraInventory/orainstRoot.sh</span><br><span class="line">Changing permissions of /u01/app/oraInventory.</span><br><span class="line">Adding read,write permissions for group.</span><br><span class="line">Removing read,write,execute permissions for world.</span><br><span class="line"></span><br><span class="line">Changing groupname of /u01/app/oraInventory to oinstall.</span><br><span class="line">The execution of the script is complete.</span><br><span class="line">[root@db-server response]# /u01/app/oracle/product/12.2.0/db_1/root.sh</span><br><span class="line">Check /u01/app/oracle/product/12.2.0/db_1/install/root_db-server_2020-06-18_03-46-08-638987704.log for the output of root script</span><br></pre></td></tr></table></figure>

<h2 id="静默安装监听"><a href="#静默安装监听" class="headerlink" title="静默安装监听"></a>静默安装监听</h2><h3 id="安装监听"><a href="#安装监听" class="headerlink" title="安装监听"></a>安装监听</h3><p>静默安装使用默认的监听响应文件即可，不用修改。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[oracle@db-server ~]$ $ORACLE_HOME/bin/netca /silent /responseFile /usr/local/src/database/response/netca.rsp </span><br><span class="line"></span><br><span class="line">Parsing command line arguments:</span><br><span class="line">    Parameter &quot;silent&quot; = true</span><br><span class="line">    Parameter &quot;responsefile&quot; = /usr/local/src/database/response/netca.rsp</span><br><span class="line">Done parsing command line arguments.</span><br><span class="line">Oracle Net Services Configuration:</span><br><span class="line">Profile configuration complete.</span><br><span class="line">Oracle Net Listener Startup:</span><br><span class="line">The information provided for this listener is currently in use by other software on this computer. </span><br><span class="line">    Listener start failed.</span><br><span class="line">Check the trace file for details: /u01/app/oracle/cfgtoollogs/netca/trace_OraDB12Home1-2006183AM4751.log</span><br><span class="line">Oracle Net Services configuration failed.  The exit code is 1</span><br></pre></td></tr></table></figure>

<h3 id="启动监听"><a href="#启动监听" class="headerlink" title="启动监听"></a>启动监听</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[oracle@db-server ~]$ lsnrctl start</span><br><span class="line"></span><br><span class="line">LSNRCTL for Linux: Version 12.2.0.1.0 - Production on 18-JUN-2020 03:48:13</span><br><span class="line"></span><br><span class="line">Copyright (c) 1991, 2016, Oracle.  All rights reserved.</span><br><span class="line"></span><br><span class="line">Starting /u01/app/oracle/product/12.2.0/db_1/bin/tnslsnr: please wait...</span><br><span class="line"></span><br><span class="line">TNSLSNR for Linux: Version 12.2.0.1.0 - Production</span><br><span class="line">System parameter file is /u01/app/oracle/product/12.2.0/db_1/network/admin/listener.ora</span><br><span class="line">Log messages written to /u01/app/oracle/diag/tnslsnr/db-server/listener/alert/log.xml</span><br><span class="line">Listening on: (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=db-server)(PORT=1539)))</span><br><span class="line">Listening on: (DESCRIPTION=(ADDRESS=(PROTOCOL=ipc)(KEY=EXTPROC1521)))</span><br><span class="line"></span><br><span class="line">Connecting to (DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=localhost)(PORT=1539)))</span><br><span class="line">STATUS of the LISTENER</span><br><span class="line">------------------------</span><br><span class="line">Alias                     LISTENER</span><br><span class="line">Version                   TNSLSNR for Linux: Version 12.2.0.1.0 - Production</span><br><span class="line">Start Date                18-JUN-2020 03:48:14</span><br><span class="line">Uptime                    0 days 0 hr. 0 min. 0 sec</span><br><span class="line">Trace Level               off</span><br><span class="line">Security                  ON: Local OS Authentication</span><br><span class="line">SNMP                      OFF</span><br><span class="line">Listener Parameter File   /u01/app/oracle/product/12.2.0/db_1/network/admin/listener.ora</span><br><span class="line">Listener Log File         /u01/app/oracle/diag/tnslsnr/db-server/listener/alert/log.xml</span><br><span class="line">Listening Endpoints Summary...</span><br><span class="line">  (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=db-server)(PORT=1539)))</span><br><span class="line">  (DESCRIPTION=(ADDRESS=(PROTOCOL=ipc)(KEY=EXTPROC1521)))</span><br><span class="line">The listener supports no services</span><br><span class="line">The command completed successfully</span><br></pre></td></tr></table></figure>

<p><em><u>ps:细心的朋友应该发现了，我这里有点问题，启动的是1539端口，不是响应文件里定义的1521端口，暂时还没找到原因，先手动修改了。</u></em></p>
<h2 id="静默安装数据库"><a href="#静默安装数据库" class="headerlink" title="静默安装数据库"></a>静默安装数据库</h2><h3 id="修改安装数据库响应文件"><a href="#修改安装数据库响应文件" class="headerlink" title="修改安装数据库响应文件"></a>修改安装数据库响应文件</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@db-server ~]# egrep -v &quot;^#|^$&quot; /usr/local/src/database/response/dbca.rsp</span><br><span class="line">responseFileVersion=/oracle/assistants/rspfmt_dbca_response_schema_v12.2.0</span><br><span class="line">gdbName=orcl</span><br><span class="line">sid=orcl</span><br><span class="line">databaseConfigType=SI</span><br><span class="line">RACOneNodeServiceName=</span><br><span class="line">policyManaged=false</span><br><span class="line">createServerPool=false</span><br><span class="line">serverPoolName=</span><br><span class="line">cardinality=</span><br><span class="line">force=false</span><br><span class="line">pqPoolName=</span><br><span class="line">pqCardinality=</span><br><span class="line">createAsContainerDatabase=false</span><br><span class="line">numberOfPDBs=0</span><br><span class="line">pdbName=</span><br><span class="line">useLocalUndoForPDBs=true</span><br><span class="line">pdbAdminPassword=</span><br><span class="line">nodelist=</span><br><span class="line">templateName=/u01/app/oracle/product/12.2.0/db_1/assistants/dbca/templates/General_Purpose.dbc</span><br><span class="line">sysPassword=Ths#123%</span><br><span class="line">systemPassword=Ths#123% </span><br><span class="line">serviceUserPassword=</span><br><span class="line">emConfiguration=</span><br><span class="line">emExpressPort=0</span><br><span class="line">runCVUChecks=false</span><br><span class="line">dbsnmpPassword=</span><br><span class="line">omsHost=</span><br><span class="line">omsPort=0</span><br><span class="line">emUser=</span><br><span class="line">emPassword=</span><br><span class="line">dvConfiguration=false</span><br><span class="line">dvUserName=</span><br><span class="line">dvUserPassword=</span><br><span class="line">dvAccountManagerName=</span><br><span class="line">dvAccountManagerPassword=</span><br><span class="line">olsConfiguration=false</span><br><span class="line">datafileJarLocation=&#123;ORACLE_HOME&#125;/assistants/dbca/templates/</span><br><span class="line">datafileDestination=&#123;ORACLE_BASE&#125;/oradata/&#123;DB_UNIQUE_NAME&#125;/</span><br><span class="line">recoveryAreaDestination=&#123;ORACLE_BASE&#125;/fast_recovery_area/&#123;DB_UNIQUE_NAME&#125;</span><br><span class="line">storageType=FS</span><br><span class="line">diskGroupName=</span><br><span class="line">asmsnmpPassword=</span><br><span class="line">recoveryGroupName=</span><br><span class="line">characterSet=ZHS16GBK</span><br><span class="line">nationalCharacterSet=</span><br><span class="line">registerWithDirService=false</span><br><span class="line">dirServiceUserName=</span><br><span class="line">dirServicePassword=</span><br><span class="line">walletPassword=</span><br><span class="line">listeners=</span><br><span class="line">variablesFile=</span><br><span class="line">variables=DB_UNIQUE_NAME=orcl,ORACLE_BASE=/u01/app/oracle,PDB_NAME=,DB_NAME=orcl,ORACLE_HOME=/u01/app/oracle/product/12.2.0/db_1,SID=orcl</span><br><span class="line">initParams=undo_tablespace=UNDOTBS1,memory_target=1577MB,processes=320,db_recovery_file_dest_size=8016MB,dispatchers=(PROTOCOL=TCP) (SERVICE=&#123;SID&#125;XDB),db_recovery_file_dest=&#123;ORACLE_BASE&#125;/fast_recovery_area/&#123;DB_UNIQUE_NAME&#125;,db_block_size=8KB,diagnostic_dest=&#123;ORACLE_BASE&#125;,audit_file_dest=&#123;ORACLE_BASE&#125;/admin/&#123;DB_UNIQUE_NAME&#125;/adump,db_create_file_dest=&#123;ORACLE_BASE&#125;/oradata/&#123;DB_UNIQUE_NAME&#125;/,compatible=12.2.0,db_name=orcl,audit_trail=db,remote_login_passwordfile=EXCLUSIVE,open_cursors=300</span><br><span class="line">sampleSchema=false</span><br><span class="line">memoryPercentage=40</span><br><span class="line">databaseType=MULTIPURPOSE</span><br><span class="line">automaticMemoryManagement=true</span><br><span class="line">totalMemory=0</span><br></pre></td></tr></table></figure>

<h3 id="执行静默建库"><a href="#执行静默建库" class="headerlink" title="执行静默建库"></a>执行静默建库</h3><p><strong>12c和11不同的地方就是在这里要加一个-createDatabase的参数。</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">[oracle@db-server ~]$ $ORACLE_HOME/bin/dbca -silent -createDatabase -responseFile /home/oracle/dbca.rsp </span><br><span class="line">Copying database files</span><br><span class="line">1% complete</span><br><span class="line">2% complete</span><br><span class="line">18% complete</span><br><span class="line">33% complete</span><br><span class="line">Creating and starting Oracle instance</span><br><span class="line">35% complete</span><br><span class="line">40% complete</span><br><span class="line">44% complete</span><br><span class="line">49% complete</span><br><span class="line">50% complete</span><br><span class="line">53% complete</span><br><span class="line">55% complete</span><br><span class="line">Completing Database Creation</span><br><span class="line">56% complete</span><br><span class="line">57% complete</span><br><span class="line">58% complete</span><br><span class="line">62% complete</span><br><span class="line">65% complete</span><br><span class="line">66% complete</span><br><span class="line">Executing Post Configuration Actions</span><br><span class="line">100% complete</span><br><span class="line">Look at the log file &quot;/u01/app/oracle/cfgtoollogs/dbca/orcl/orcl.log&quot; for further details.</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[oracle@db-server ~]$ lsnrctl status</span><br><span class="line"></span><br><span class="line">LSNRCTL for Linux: Version 12.2.0.1.0 - Production on 17-JUN-2020 19:09:02</span><br><span class="line"></span><br><span class="line">Copyright (c) 1991, 2016, Oracle.  All rights reserved.</span><br><span class="line"></span><br><span class="line">Connecting to (DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=localhost)(PORT=1521)))</span><br><span class="line">STATUS of the LISTENER</span><br><span class="line">------------------------</span><br><span class="line">Alias                     LISTENER</span><br><span class="line">Version                   TNSLSNR for Linux: Version 12.2.0.1.0 - Production</span><br><span class="line">Start Date                17-JUN-2020 19:08:16</span><br><span class="line">Uptime                    0 days 0 hr. 0 min. 46 sec</span><br><span class="line">Trace Level               off</span><br><span class="line">Security                  ON: Local OS Authentication</span><br><span class="line">SNMP                      OFF</span><br><span class="line">Listener Parameter File   /u01/app/oracle/product/12.2.0/db_1/network/admin/listener.ora</span><br><span class="line">Listener Log File         /u01/app/oracle/diag/tnslsnr/db-server/listener/alert/log.xml</span><br><span class="line">Listening Endpoints Summary...</span><br><span class="line">  (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=db-server)(PORT=1521)))</span><br><span class="line">Services Summary...</span><br><span class="line">Service &quot;orcl&quot; has 1 instance(s).</span><br><span class="line">  Instance &quot;orcl&quot;, status READY, has 1 handler(s) for this service...</span><br><span class="line">Service &quot;orclXDB&quot; has 1 instance(s).</span><br><span class="line">  Instance &quot;orcl&quot;, status READY, has 1 handler(s) for this service...</span><br><span class="line">The command completed successfully</span><br></pre></td></tr></table></figure>

<h1 id="配置开机启动"><a href="#配置开机启动" class="headerlink" title="配置开机启动"></a>配置开机启动</h1><h2 id="修改oratab"><a href="#修改oratab" class="headerlink" title="修改oratab"></a>修改oratab</h2><p><code>vim /etc/oratab</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">orcl:/u01/app/oracle/product/12.2.0/db_1:Y</span><br></pre></td></tr></table></figure>

<h2 id="修改dbstart文件"><a href="#修改dbstart文件" class="headerlink" title="修改dbstart文件"></a>修改dbstart文件</h2><p><code>vim /u01/app/oracle/product/12.2.0/db_1/bin/dbstart</code></p>
<p><em>修改第80行: ORACLE_HOME_LISTNER&#x3D;$1为ORACLE_HOME_LISTNER&#x3D;$ORACLE_HOME</em></p>
<h2 id="修改dbshut文件"><a href="#修改dbshut文件" class="headerlink" title="修改dbshut文件"></a>修改dbshut文件</h2><p><code>vim /u01/app/oracle/product/12.2.0/db_1/bin/dbshut</code></p>
<p><em>修改第50行: ORACLE_HOME_LISTNER&#x3D;$1为ORACLE_HOME_LISTNER&#x3D;$ORACLE_HOME</em></p>
<h2 id="修改开机启动文件"><a href="#修改开机启动文件" class="headerlink" title="修改开机启动文件"></a>修改开机启动文件</h2><p><code> vim /etc/rc.d/rc.local</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">su - oracle -lc &quot;/u01/app/oracle/product/12.2.0/db_1/bin/lsnrctl start&quot;</span><br><span class="line">su - oracle -lc &quot;/u01/app/oracle/product/12.2.0/db_1/bin/dbstart&quot;</span><br></pre></td></tr></table></figure>

<p>添加可执行权限</p>
<p><code>chmod +x /etc/rc.d/rc.local</code></p>
<h1 id="关闭审计日志"><a href="#关闭审计日志" class="headerlink" title="关闭审计日志"></a>关闭审计日志</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">由于默认审计日志默认是开启状态，长时间使用后会早上SYSTEM表空间撑爆，磁盘占用率高，建议关闭</span><br><span class="line">sqlplus / as sysdba</span><br><span class="line"></span><br><span class="line">SQL&gt; show parameter audit_trail</span><br><span class="line">SQL&gt; alter system set audit_trail=none scope=spfile;</span><br><span class="line">SQL&gt; shutdown immediate;</span><br><span class="line">SQL&gt; startup</span><br></pre></td></tr></table></figure>

<h1 id="使SqlPlus工具支持上下左右键"><a href="#使SqlPlus工具支持上下左右键" class="headerlink" title="使SqlPlus工具支持上下左右键"></a>使SqlPlus工具支持上下左右键</h1><p>安装rlwrap： <a href="http://islocal.cc/arlo/d9547628/">http://islocal.cc/arlo/d9547628/</a></p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>Oracle</tag>
        <tag>数据库</tag>
      </tags>
  </entry>
  <entry>
    <title>Docker|3.文件、数据共享</title>
    <url>/arlo/a27711a4/</url>
    <content><![CDATA[<h1 id="文件拷贝"><a href="#文件拷贝" class="headerlink" title="文件拷贝"></a>文件拷贝</h1><p><strong>docker cp 容器ID:&#x2F;文件路径&#x2F;文件名称 本地文件路径</strong></p>
<p>**docker cp 本地文件路径 容器ID:&#x2F;文件路径&#x2F;文件名称 **</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#从容器内拷贝文件到本地</span><br><span class="line">[root@localhost ~]# docker cp cd7a272e8786:/etc/passwd /tmp</span><br><span class="line">[root@localhost ~]# head -3 /tmp/passwd </span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">bin:x:1:1:bin:/bin:/sbin/nologin</span><br><span class="line">daemon:x:2:2:daemon:/sbin:/sbin/nologin</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#将本地文件拷贝到容器内</span><br><span class="line">[root@localhost ~]# echo &quot;123&quot; &gt; file1</span><br><span class="line">[root@localhost ~]# docker cp file1 cd7a272e8786:/tmp</span><br><span class="line">[root@localhost ~]# docker exec -it cd7a272e8786 cat /tmp/file1</span><br><span class="line">123</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h1 id="数据卷"><a href="#数据卷" class="headerlink" title="数据卷"></a>数据卷</h1><h2 id="v命令实现"><a href="#v命令实现" class="headerlink" title="-v命令实现"></a>-v命令实现</h2><p><strong>docker run -it -v &#x2F;宿主机的绝对路径目录:&#x2F;容器内目录 镜像名</strong>    #如果不能写，需要添加–privileged&#x3D;true</p>
<p><strong>docker run -it -v &#x2F;宿主机的绝对路径目录:&#x2F;容器内目录:ro  镜像名</strong>    #容器内文件只读</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# docker run --name centos0211 -it -v /HostDataVolume:/ContainerDataVolume centos</span><br><span class="line">[root@cde93366c404 /]# cd /ContainerDataVolume/</span><br><span class="line">[root@cde93366c404 ContainerDataVolume]# ls</span><br><span class="line">[root@cde93366c404 ContainerDataVolume]# echo &quot;123&quot; &gt; file1</span><br><span class="line">[root@cde93366c404 ContainerDataVolume]# exit</span><br><span class="line">exit</span><br><span class="line">[root@localhost ~]# cat /HostDataVolume/file1 </span><br><span class="line">123</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="dockerfile方式数据卷"><a href="#dockerfile方式数据卷" class="headerlink" title="dockerfile方式数据卷"></a>dockerfile方式数据卷</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /root/mydocker/Dockerfile</span><br><span class="line">#volume test</span><br><span class="line">FROM centos</span><br><span class="line">VOLUME [&quot;/DataVolumeContainer1&quot;,&quot;/DataVolumeContainer2&quot;]</span><br><span class="line">CMD echo &quot;finished, ------success!&quot;</span><br><span class="line">CMD /bin/bash</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost mydocker]# docker build -f /root/mydocker/Dockerfile -t test/centos .</span><br><span class="line">Sending build context to Docker daemon  2.048kB</span><br><span class="line">Step 1/4 : FROM centos</span><br><span class="line"> ---&gt; 470671670cac</span><br><span class="line">Step 2/4 : VOLUME [&quot;/DataVolumeContainer1&quot;,&quot;/DataVolumeContainer2&quot;]</span><br><span class="line"> ---&gt; Running in ad5cdf37264a</span><br><span class="line">Removing intermediate container ad5cdf37264a</span><br><span class="line"> ---&gt; 3e834cfa3923</span><br><span class="line">Step 3/4 : CMD echo &quot;finished, ------success!&quot;</span><br><span class="line"> ---&gt; Running in 033f927a7220</span><br><span class="line">Removing intermediate container 033f927a7220</span><br><span class="line"> ---&gt; d1b3cc53d482</span><br><span class="line">Step 4/4 : CMD /bin/bash</span><br><span class="line"> ---&gt; Running in 47ebcfb99158</span><br><span class="line">Removing intermediate container 47ebcfb99158</span><br><span class="line"> ---&gt; c8ed8caf62e2</span><br><span class="line">Successfully built c8ed8caf62e2</span><br><span class="line">Successfully tagged test/centos:latest</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost mydocker]# docker images</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">test/centos         latest              c8ed8caf62e2        10 seconds ago      237MB</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost mydocker]# docker run -it test/centos</span><br><span class="line">[root@7f54ea649e73 /]# ls -l</span><br><span class="line">total 16</span><br><span class="line">drwxr-xr-x   2 root root    6 Feb 11 23:18 DataVolumeContainer1</span><br><span class="line">drwxr-xr-x   2 root root    6 Feb 11 23:18 DataVolumeContainer2</span><br><span class="line">……</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# docker inspect 7f54ea649e73</span><br><span class="line">……</span><br><span class="line">……</span><br><span class="line">&quot;Mounts&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;Type&quot;: &quot;volume&quot;,</span><br><span class="line">                &quot;Name&quot;: &quot;db383db0ed0f634dca3b88ac7b1b5eb7aaf1eb45aa5e198c1dbb672717cbadc4&quot;,</span><br><span class="line">                &quot;Source&quot;: &quot;/var/lib/docker/volumes/db383db0ed0f634dca3b88ac7b1b5eb7aaf1eb45aa5e198c1dbb672717cbadc4/_data&quot;,</span><br><span class="line">                &quot;Destination&quot;: &quot;/DataVolumeContainer1&quot;,</span><br><span class="line">                &quot;Driver&quot;: &quot;local&quot;,</span><br><span class="line">                &quot;Mode&quot;: &quot;&quot;,</span><br><span class="line">                &quot;RW&quot;: true,</span><br><span class="line">                &quot;Propagation&quot;: &quot;&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;Type&quot;: &quot;volume&quot;,</span><br><span class="line">                &quot;Name&quot;: &quot;ed238e4c4a3bf80274f6bd6dd5d4a1aa00020e081a38d9ae668567d9a9301344&quot;,</span><br><span class="line">                &quot;Source&quot;: &quot;/var/lib/docker/volumes/ed238e4c4a3bf80274f6bd6dd5d4a1aa00020e081a38d9ae668567d9a9301344/_data&quot;,</span><br><span class="line">                &quot;Destination&quot;: &quot;/DataVolumeContainer2&quot;,</span><br><span class="line">                &quot;Driver&quot;: &quot;local&quot;,</span><br><span class="line">                &quot;Mode&quot;: &quot;&quot;,</span><br><span class="line">                &quot;RW&quot;: true,</span><br><span class="line">                &quot;Propagation&quot;: &quot;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">……</span><br><span class="line">……</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@7f54ea649e73 /]# echo &quot;123&quot; &gt; /DataVolumeContainer1/file1</span><br><span class="line">[root@localhost ~]# cat /var/lib/docker/volumes/db383db0ed0f634dca3b88ac7b1b5eb7aaf1eb45aa5e198c1dbb672717cbadc4/_data/file1 </span><br><span class="line">123</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="数据卷容器"><a href="#数据卷容器" class="headerlink" title="数据卷容器"></a>数据卷容器</h1><p>命名的容器挂载数据卷，其他容器通过挂载这个（父容器）实现数据共享，挂载数据卷的容器，称之为数据卷容器。</p>
<h2 id="先启动一个父容器"><a href="#先启动一个父容器" class="headerlink" title="先启动一个父容器"></a>先启动一个父容器</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# docker run -it --name dc01 test/centos</span><br><span class="line"></span><br><span class="line">[root@fe649066e76e /]# cd DataVolumeContainer1/</span><br><span class="line"></span><br><span class="line">[root@fe649066e76e DataVolumeContainer1]# touch add_dc01.txt</span><br></pre></td></tr></table></figure>

<h2 id="新建dc02-x2F-dc03容器，继承dc01"><a href="#新建dc02-x2F-dc03容器，继承dc01" class="headerlink" title="新建dc02&#x2F;dc03容器，继承dc01"></a>新建dc02&#x2F;dc03容器，继承dc01</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#新建dc02</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# docker run -it --name dc02 --volumes-from dc01 test/centos</span><br><span class="line"></span><br><span class="line">[root@c14197144fe7 /]# cd /DataVolumeContainer1/</span><br><span class="line"></span><br><span class="line">[root@c14197144fe7 DataVolumeContainer1]# touch add_dc02.txt</span><br><span class="line"></span><br><span class="line">#新建dc03</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# docker run -it --name dc03 --volumes-from dc01 test/centos</span><br><span class="line"></span><br><span class="line">[root@c409dacf9084 /]# cd /DataVolumeContainer1/</span><br><span class="line"></span><br><span class="line">[root@c409dacf9084 DataVolumeContainer1]# touch add_dc03.txt</span><br></pre></td></tr></table></figure>

<h2 id="在dc01上查看数据"><a href="#在dc01上查看数据" class="headerlink" title="在dc01上查看数据"></a>在dc01上查看数据</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES</span><br><span class="line">c409dacf9084        test/centos         &quot;/bin/sh -c /bin/bash&quot;   4 minutes ago       Up 4 minutes                            dc03</span><br><span class="line">c14197144fe7        test/centos         &quot;/bin/sh -c /bin/bash&quot;   4 minutes ago       Up 4 minutes                            dc02</span><br><span class="line">fe649066e76e        test/centos         &quot;/bin/sh -c /bin/bash&quot;   9 minutes ago       Up 9 minutes                            dc01</span><br><span class="line">[root@localhost ~]# docker attach fe649066e76e</span><br><span class="line">[root@fe649066e76e DataVolumeContainer1]# ls -l</span><br><span class="line">total 0</span><br><span class="line">-rw-r--r-- 1 root root 0 Feb 12 00:02 add_dc01.txt</span><br><span class="line">-rw-r--r-- 1 root root 0 Feb 12 00:09 add_dc02.txt</span><br><span class="line">-rw-r--r-- 1 root root 0 Feb 12 00:10 add_dc03.txt</span><br></pre></td></tr></table></figure>

<h2 id="删除dc01-在dc02上添加数据，在dc03上查看"><a href="#删除dc01-在dc02上添加数据，在dc03上查看" class="headerlink" title="删除dc01,在dc02上添加数据，在dc03上查看"></a>删除dc01,在dc02上添加数据，在dc03上查看</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES</span><br><span class="line">c409dacf9084        test/centos         &quot;/bin/sh -c /bin/bash&quot;   5 minutes ago       Up 5 minutes                            dc03</span><br><span class="line">c14197144fe7        test/centos         &quot;/bin/sh -c /bin/bash&quot;   5 minutes ago       Up 5 minutes                            dc02</span><br><span class="line">fe649066e76e        test/centos         &quot;/bin/sh -c /bin/bash&quot;   10 minutes ago      Up 10 minutes                           dc01</span><br><span class="line">[root@localhost ~]# docker rm -f fe649066e76e</span><br><span class="line">fe649066e76e</span><br><span class="line">[root@localhost ~]# docker attach c14197144fe7</span><br><span class="line">[root@c14197144fe7 DataVolumeContainer1]# ls -l</span><br><span class="line">total 0</span><br><span class="line">-rw-r--r-- 1 root root 0 Feb 12 00:02 add_dc01.txt</span><br><span class="line">-rw-r--r-- 1 root root 0 Feb 12 00:09 add_dc02.txt</span><br><span class="line">-rw-r--r-- 1 root root 0 Feb 12 00:10 add_dc03.txt</span><br><span class="line">[root@c14197144fe7 DataVolumeContainer1]# touch update_dc02.txt</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# docker attach dc03</span><br><span class="line">[root@c409dacf9084 DataVolumeContainer1]# ls -l</span><br><span class="line">total 0</span><br><span class="line">-rw-r--r-- 1 root root 0 Feb 12 00:02 add_dc01.txt</span><br><span class="line">-rw-r--r-- 1 root root 0 Feb 12 00:09 add_dc02.txt</span><br><span class="line">-rw-r--r-- 1 root root 0 Feb 12 00:10 add_dc03.txt</span><br><span class="line">-rw-r--r-- 1 root root 0 Feb 12 00:13 update_dc02.txt</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="删除dc02，测试dc03数据是否可以访问"><a href="#删除dc02，测试dc03数据是否可以访问" class="headerlink" title="删除dc02，测试dc03数据是否可以访问"></a>删除dc02，测试dc03数据是否可以访问</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# docker rm -f dc02</span><br><span class="line">dc02</span><br><span class="line">[root@localhost ~]# docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES</span><br><span class="line">c409dacf9084        test/centos         &quot;/bin/sh -c /bin/bash&quot;   10 minutes ago      Up 10 minutes                           dc03</span><br><span class="line">[root@localhost ~]# docker attach dc03</span><br><span class="line">[root@c409dacf9084 DataVolumeContainer1]# ls -l</span><br><span class="line">total 0</span><br><span class="line">-rw-r--r-- 1 root root 0 Feb 12 00:02 add_dc01.txt</span><br><span class="line">-rw-r--r-- 1 root root 0 Feb 12 00:09 add_dc02.txt</span><br><span class="line">-rw-r--r-- 1 root root 0 Feb 12 00:10 add_dc03.txt</span><br><span class="line">-rw-r--r-- 1 root root 0 Feb 12 00:13 update_dc02.txt</span><br></pre></td></tr></table></figure>

<h2 id="新建dc04继承dc03，然后删除dc03"><a href="#新建dc04继承dc03，然后删除dc03" class="headerlink" title="新建dc04继承dc03，然后删除dc03"></a>新建dc04继承dc03，然后删除dc03</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# docker run -it --name dc04 --volumes-from dc03 test/centos</span><br><span class="line">[root@localhost ~]# docker rm -f dc03</span><br><span class="line">dc03</span><br><span class="line">[root@localhost ~]# docker ps </span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES</span><br><span class="line">5156e4538e53        test/centos         &quot;/bin/sh -c /bin/bash&quot;   59 seconds ago      Up 58 seconds                           dc04</span><br><span class="line">[root@localhost ~]# docker attach dc04</span><br><span class="line">[root@5156e4538e53 DataVolumeContainer1]# cd /DataVolumeContainer1/</span><br><span class="line">[root@5156e4538e53 DataVolumeContainer1]# ls -l</span><br><span class="line">total 0</span><br><span class="line">-rw-r--r-- 1 root root 0 Feb 12 00:02 add_dc01.txt</span><br><span class="line">-rw-r--r-- 1 root root 0 Feb 12 00:09 add_dc02.txt</span><br><span class="line">-rw-r--r-- 1 root root 0 Feb 12 00:10 add_dc03.txt</span><br><span class="line">-rw-r--r-- 1 root root 0 Feb 12 00:13 update_dc02.txt</span><br></pre></td></tr></table></figure>

<p><strong>结论：容器之间配置信息的传递，数据卷的生命周期一直持续到没有容器使用它为止</strong></p>
]]></content>
      <categories>
        <category>DevOps</category>
      </categories>
      <tags>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>Docker|4.Dockerfile编写</title>
    <url>/arlo/d9e6ac98/</url>
    <content><![CDATA[<p>Dockerfile是用来构建Docker镜像的构建文件，是由一系列命令和参数构成的脚本。</p>
<h1 id="Dockerfile构建过程解析"><a href="#Dockerfile构建过程解析" class="headerlink" title="Dockerfile构建过程解析"></a>Dockerfile构建过程解析</h1><h2 id="Dockerfile基础知识"><a href="#Dockerfile基础知识" class="headerlink" title="Dockerfile基础知识"></a>Dockerfile基础知识</h2><ul>
<li>每条保留指令都必须为大写字母且后面要跟随至少一个参数</li>
<li>指令按照从上到下，顺序执行</li>
<li>#表示注释</li>
<li>每条指令都会创建一个新的镜像层，并对镜像进行提交</li>
</ul>
<span id="more"></span>

<h2 id="Docker执行Dockerfile的大概流程"><a href="#Docker执行Dockerfile的大概流程" class="headerlink" title="Docker执行Dockerfile的大概流程"></a>Docker执行Dockerfile的大概流程</h2><ul>
<li>docker从基础镜像运行一个容器</li>
<li>执行一条指令并对容器做出修改</li>
<li>执行类似docker commit的操作提交一个新的镜像层</li>
<li>docker再基于刚提交的镜像运行一个新容器</li>
<li>执行dockerfile中的下一条指令直到所有指令都执行完成</li>
</ul>
<p>Dockerfile，需要定义一个Dockerfile，Dockerfile定义了进程需要的一切东西。Dockerfile涉及的内容包括执行代码或者是文件、环境变量、依赖包、运行时环境、动态链接库、操作系统的发行版、服务进程和内核进程（当应用进程需要和系统服务和内核进程打交道，这时需要考虑如何设计namespace的权限控制）等等；</p>
<p>Docker镜像，在用Dockerfile定义一个文件之后，docker build时会产生一个Docker镜像，当运行Docker镜像时，会真正开始提供服务；</p>
<p>Docker容器，容器是直接提供服务的。</p>
<h1 id="Dockerfile体系结构"><a href="#Dockerfile体系结构" class="headerlink" title="Dockerfile体系结构"></a>Dockerfile体系结构</h1><table>
<thead>
<tr>
<th>保留字指令</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>FROM</td>
<td>基础镜像，当前新镜像是基于哪个镜像的</td>
</tr>
<tr>
<td>MAINTAINER</td>
<td>镜像维护者的姓名和邮箱地址</td>
</tr>
<tr>
<td>RUN</td>
<td>容器构建时需要运行的指令</td>
</tr>
<tr>
<td>EXPOSE</td>
<td>容器对外暴漏的端口</td>
</tr>
<tr>
<td>WORKDIR</td>
<td>指定在创建容器后，终端默认登录进来的工作目录，一个落脚点</td>
</tr>
<tr>
<td>ENV</td>
<td>在构建镜像过程中设置环境变量</td>
</tr>
<tr>
<td>ADD</td>
<td>将宿主机目录下的文件拷贝进镜像且ADD命令会自动处理URL和解压tar压缩包</td>
</tr>
<tr>
<td>COPY</td>
<td>类似ADD，拷贝文件和目录到镜像中。将从构建上下文目录中的&lt;原路径&gt;的文件&#x2F;目标复制到新的一层的镜像内的&lt;目标路径&gt;位置</td>
</tr>
<tr>
<td>VOLUME</td>
<td>容器数据卷，用于数据保存和持久化工作</td>
</tr>
<tr>
<td>CMD</td>
<td>指定一个容器启动时要运行的命令。Dockfile中可以有多个CMD指令，但只有最后一个生效，CMD会被docker run之后的参数替换（替换）</td>
</tr>
<tr>
<td>ENTRYPOINT</td>
<td>指定一个容器启动时要运行的命令。ENTRYPOINT的目标和CMD一样，都是在指定容器启动程序及参数（追加）</td>
</tr>
<tr>
<td>ONBUILD</td>
<td>当构建一个被继承的Dockerfile时运行命令，父镜像在被子镜像继承后父镜像的onbuild被触发。</td>
</tr>
</tbody></table>
<h1 id="编写tomcat-dockerfile"><a href="#编写tomcat-dockerfile" class="headerlink" title="编写tomcat dockerfile"></a>编写tomcat dockerfile</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost tomcat]# pwd</span><br><span class="line">/root/mydocker/tomcat</span><br><span class="line">[root@localhost tomcat]# ls -l</span><br><span class="line">total 199896</span><br><span class="line">-rw-r--r-- 1 root root   9584807 Jul  6  2018 apache-tomcat-8.5.32.tar.gz</span><br><span class="line">-rw-r--r-- 1 root root         5 Feb 13 00:15 c.txt</span><br><span class="line">-rw-r--r-- 1 root root       614 Feb 13 00:21 dockerfile</span><br><span class="line">-rw-r--r-- 1 root root 195094741 Oct 31 15:00 jdk-8u221-linux-x64.tar.gz</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost tomcat]# cat /root/mydocker/tomcat/dockerfile </span><br><span class="line">FROM centos</span><br><span class="line">MAINTAINER arlo&lt;10887272@qq.com&gt;</span><br><span class="line">WORKDIR /usr/local</span><br><span class="line">#安装vim,lsof软件</span><br><span class="line">RUN yum -y install vim lsof</span><br><span class="line">#拷贝并解压jdk,tomcat</span><br><span class="line">COPY c.txt /usr/local/ctext.txt</span><br><span class="line">ADD jdk-8u221-linux-x64.tar.gz /usr/local/</span><br><span class="line">ADD apache-tomcat-8.5.32.tar.gz /usr/local/</span><br><span class="line">#配置环境变量</span><br><span class="line">ENV JAVA_HOME /usr/local/jdk1.8.0_221/</span><br><span class="line">ENV CLASSPATH .:$JAVA_HOME/lib/:$JAVA_HOME/jre/lib/</span><br><span class="line">ENV CATALINA_HOME /usr/local/apache-tomcat-8.5.32</span><br><span class="line">ENV CATALINA_BASE /usr/local/apache-tomcat-8.5.32</span><br><span class="line">ENV PATH $JAVA_HOME/bin:$PATH</span><br><span class="line">#暴漏容器服务端口</span><br><span class="line">EXPOSE 8080</span><br><span class="line">#启动服务</span><br><span class="line">CMD [&quot;/usr/local/apache-tomcat-8.5.32/bin/catalina.sh&quot;,&quot;run&quot;]</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost tomcat]# docker build -f /root/mydocker/tomcat/dockerfile -t test/tomcat .</span><br><span class="line">Sending build context to Docker daemon  204.7MB</span><br><span class="line">Step 1/14 : FROM centos</span><br><span class="line"> ---&gt; 470671670cac</span><br><span class="line">Step 2/14 : MAINTAINER arlo&lt;10887272@qq.com&gt;</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 9fe35c7393cf</span><br><span class="line">Step 3/14 : WORKDIR /usr/local</span><br><span class="line"> ---&gt; Running in 32918030b909</span><br><span class="line">Removing intermediate container 32918030b909</span><br><span class="line"> ---&gt; d3d46c9c0512</span><br><span class="line">Step 4/14 : RUN yum -y install vim lsof</span><br><span class="line"> ---&gt; Running in 897a79906fc7</span><br><span class="line">CentOS-8 - AppStream                            251 kB/s | 6.4 MB     00:26    </span><br><span class="line">CentOS-8 - Base                                 1.3 MB/s | 5.0 MB     00:03    </span><br><span class="line">CentOS-8 - Extras                               907  B/s | 2.1 kB     00:02    </span><br><span class="line">Dependencies resolved.</span><br><span class="line">================================================================================</span><br><span class="line"> Package             Arch        Version                   Repository      Size</span><br><span class="line">================================================================================</span><br><span class="line">Installing:</span><br><span class="line"> vim-enhanced        x86_64      2:8.0.1763-13.el8         AppStream      1.4 M</span><br><span class="line"> lsof                x86_64      4.91-2.el8                BaseOS         253 k</span><br><span class="line">Installing dependencies:</span><br><span class="line"> gpm-libs            x86_64      1.20.7-15.el8             AppStream       39 k</span><br><span class="line"> vim-common          x86_64      2:8.0.1763-13.el8         AppStream      6.3 M</span><br><span class="line"> vim-filesystem      noarch      2:8.0.1763-13.el8         AppStream       48 k</span><br><span class="line"> which               x86_64      2.21-10.el8               BaseOS          49 k</span><br><span class="line"></span><br><span class="line">Transaction Summary</span><br><span class="line">================================================================================</span><br><span class="line">Install  6 Packages</span><br><span class="line"></span><br><span class="line">Total download size: 8.1 M</span><br><span class="line">Installed size: 31 M</span><br><span class="line">Downloading Packages:</span><br><span class="line">(1/6): gpm-libs-1.20.7-15.el8.x86_64.rpm        212 kB/s |  39 kB     00:00    </span><br><span class="line">(2/6): vim-filesystem-8.0.1763-13.el8.noarch.rp 961 kB/s |  48 kB     00:00    </span><br><span class="line">(3/6): lsof-4.91-2.el8.x86_64.rpm               530 kB/s | 253 kB     00:00    </span><br><span class="line">(4/6): which-2.21-10.el8.x86_64.rpm             918 kB/s |  49 kB     00:00    </span><br><span class="line">(5/6): vim-common-8.0.1763-13.el8.x86_64.rpm    2.5 MB/s | 6.3 MB     00:02    </span><br><span class="line">(6/6): vim-enhanced-8.0.1763-13.el8.x86_64.rpm  538 kB/s | 1.4 MB     00:02    </span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">Total                                           2.0 MB/s | 8.1 MB     00:03     </span><br><span class="line">warning: /var/cache/dnf/AppStream-02e86d1c976ab532/packages/gpm-libs-1.20.7-15.el8.x86_64.rpm: Header V3 RSA/SHA256 Signature, key ID 8483c65d: NOKEY</span><br><span class="line">CentOS-8 - AppStream                            1.6 MB/s | 1.6 kB     00:00    </span><br><span class="line">Importing GPG key 0x8483C65D:</span><br><span class="line"> Userid     : &quot;CentOS (CentOS Official Signing Key) &lt;security@centos.org&gt;&quot;</span><br><span class="line"> Fingerprint: 99DB 70FA E1D7 CE22 7FB6 4882 05B5 55B3 8483 C65D</span><br><span class="line"> From       : /etc/pki/rpm-gpg/RPM-GPG-KEY-centosofficial</span><br><span class="line">Key imported successfully</span><br><span class="line">Running transaction check</span><br><span class="line">Transaction check succeeded.</span><br><span class="line">Running transaction test</span><br><span class="line">Transaction test succeeded.</span><br><span class="line">Running transaction</span><br><span class="line">  Preparing        :                                                        1/1 </span><br><span class="line">  Installing       : which-2.21-10.el8.x86_64                               1/6 </span><br><span class="line">  Installing       : vim-filesystem-2:8.0.1763-13.el8.noarch                2/6 </span><br><span class="line">  Installing       : vim-common-2:8.0.1763-13.el8.x86_64                    3/6 </span><br><span class="line">  Installing       : gpm-libs-1.20.7-15.el8.x86_64                          4/6 </span><br><span class="line">  Running scriptlet: gpm-libs-1.20.7-15.el8.x86_64                          4/6 </span><br><span class="line">  Installing       : vim-enhanced-2:8.0.1763-13.el8.x86_64                  5/6 </span><br><span class="line">  Installing       : lsof-4.91-2.el8.x86_64                                 6/6 </span><br><span class="line">  Running scriptlet: lsof-4.91-2.el8.x86_64                                 6/6 </span><br><span class="line">  Running scriptlet: vim-common-2:8.0.1763-13.el8.x86_64                    6/6 </span><br><span class="line">  Verifying        : gpm-libs-1.20.7-15.el8.x86_64                          1/6 </span><br><span class="line">  Verifying        : vim-common-2:8.0.1763-13.el8.x86_64                    2/6 </span><br><span class="line">  Verifying        : vim-enhanced-2:8.0.1763-13.el8.x86_64                  3/6 </span><br><span class="line">  Verifying        : vim-filesystem-2:8.0.1763-13.el8.noarch                4/6 </span><br><span class="line">  Verifying        : lsof-4.91-2.el8.x86_64                                 5/6 </span><br><span class="line">  Verifying        : which-2.21-10.el8.x86_64                               6/6 </span><br><span class="line"></span><br><span class="line">Installed:</span><br><span class="line">  vim-enhanced-2:8.0.1763-13.el8.x86_64    lsof-4.91-2.el8.x86_64              </span><br><span class="line">  gpm-libs-1.20.7-15.el8.x86_64            vim-common-2:8.0.1763-13.el8.x86_64 </span><br><span class="line">  vim-filesystem-2:8.0.1763-13.el8.noarch  which-2.21-10.el8.x86_64            </span><br><span class="line"></span><br><span class="line">Complete!</span><br><span class="line">Removing intermediate container 897a79906fc7</span><br><span class="line"> ---&gt; 13121fca3153</span><br><span class="line">Step 5/14 : COPY c.txt /usr/local/ctext.txt</span><br><span class="line"> ---&gt; 295b1db8995d</span><br><span class="line">Step 6/14 : ADD jdk-8u221-linux-x64.tar.gz /usr/local/</span><br><span class="line"> ---&gt; 8f55fab3cee8</span><br><span class="line">Step 7/14 : ADD apache-tomcat-8.5.32.tar.gz /usr/local/</span><br><span class="line"> ---&gt; 19390cab29cb</span><br><span class="line">Step 8/14 : ENV JAVA_HOME /usr/local/jdk1.8.0_221/</span><br><span class="line"> ---&gt; Running in d7db7c594c17</span><br><span class="line">Removing intermediate container d7db7c594c17</span><br><span class="line"> ---&gt; 0e316b643b87</span><br><span class="line">Step 9/14 : ENV CLASSPATH .:$JAVA_HOME/lib/:$JAVA_HOME/jre/lib/</span><br><span class="line"> ---&gt; Running in fb8be4c72efe</span><br><span class="line">Removing intermediate container fb8be4c72efe</span><br><span class="line"> ---&gt; 9b2d22114da9</span><br><span class="line">Step 10/14 : ENV CATALINA_HOME /usr/local/apache-tomcat-8.5.32</span><br><span class="line"> ---&gt; Running in 0026d43d76ef</span><br><span class="line">Removing intermediate container 0026d43d76ef</span><br><span class="line"> ---&gt; 1780fa4f640e</span><br><span class="line">Step 11/14 : ENV CATALINA_BASE /usr/local/apache-tomcat-8.5.32</span><br><span class="line"> ---&gt; Running in 2c843fa05104</span><br><span class="line">Removing intermediate container 2c843fa05104</span><br><span class="line"> ---&gt; b3e0da022f22</span><br><span class="line">Step 12/14 : ENV PATH $JAVA_HOME/bin:$PATH</span><br><span class="line"> ---&gt; Running in 7366d7cb77a1</span><br><span class="line">Removing intermediate container 7366d7cb77a1</span><br><span class="line"> ---&gt; afefbc99ba9c</span><br><span class="line">Step 13/14 : EXPOSE 8080</span><br><span class="line"> ---&gt; Running in a65838b19573</span><br><span class="line">Removing intermediate container a65838b19573</span><br><span class="line"> ---&gt; cf9fbf0a77e9</span><br><span class="line">Step 14/14 : CMD [&quot;/usr/local/apache-tomcat-8.5.32/bin/startup.sh&quot;,&quot;run&quot;]</span><br><span class="line"> ---&gt; Running in 51d8114e1305</span><br><span class="line">Removing intermediate container 51d8114e1305</span><br><span class="line"> ---&gt; fd478a528ca4</span><br><span class="line">Successfully built fd478a528ca4</span><br><span class="line">Successfully tagged test/tomcat:latest</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost tomcat]# docker images</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">test/tomcat         latest              fd478a528ca4        32 seconds ago      721MB</span><br><span class="line">test/centos2        latest              9c47c178eb61        3 hours ago         314MB</span><br><span class="line">test/centos         latest              c8ed8caf62e2        17 hours ago        237MB</span><br><span class="line">tomcat              latest              b56d8850aed5        5 days ago          529MB</span><br><span class="line">centos              latest              470671670cac        3 weeks ago         237MB</span><br><span class="line">[root@localhost tomcat]# docker history test/tomcat</span><br><span class="line">IMAGE               CREATED              CREATED BY                                      SIZE                COMMENT</span><br><span class="line">fd478a528ca4        42 seconds ago       /bin/sh -c #(nop)  CMD [&quot;/usr/local/apache-t…   0B                  </span><br><span class="line">cf9fbf0a77e9        46 seconds ago       /bin/sh -c #(nop)  EXPOSE 8080                  0B                  </span><br><span class="line">afefbc99ba9c        49 seconds ago       /bin/sh -c #(nop)  ENV PATH=/usr/local/jdk1.…   0B                  </span><br><span class="line">b3e0da022f22        53 seconds ago       /bin/sh -c #(nop)  ENV CATALINA_BASE=/usr/lo…   0B                  </span><br><span class="line">1780fa4f640e        57 seconds ago       /bin/sh -c #(nop)  ENV CATALINA_HOME=/usr/lo…   0B                  </span><br><span class="line">9b2d22114da9        About a minute ago   /bin/sh -c #(nop)  ENV CLASSPATH=.:/usr/loca…   0B                  </span><br><span class="line">0e316b643b87        About a minute ago   /bin/sh -c #(nop)  ENV JAVA_HOME=/usr/local/…   0B                  </span><br><span class="line">19390cab29cb        About a minute ago   /bin/sh -c #(nop) ADD file:047cf33d1eac02dd1…   13.6MB              </span><br><span class="line">8f55fab3cee8        About a minute ago   /bin/sh -c #(nop) ADD file:cd29f38ce9a4a50a3…   407MB               </span><br><span class="line">295b1db8995d        About a minute ago   /bin/sh -c #(nop) COPY file:ba9516c02edf6166…   5B                  </span><br><span class="line">13121fca3153        About a minute ago   /bin/sh -c yum -y install vim lsof              63.6MB              </span><br><span class="line">d3d46c9c0512        2 minutes ago        /bin/sh -c #(nop) WORKDIR /usr/local            0B                  </span><br><span class="line">9fe35c7393cf        3 hours ago          /bin/sh -c #(nop)  MAINTAINER arlo&lt;10887272@…   0B                  </span><br><span class="line">470671670cac        3 weeks ago          /bin/sh -c #(nop)  CMD [&quot;/bin/bash&quot;]            0B                  </span><br><span class="line">&lt;missing&gt;           3 weeks ago          /bin/sh -c #(nop)  LABEL org.label-schema.sc…   0B                  </span><br><span class="line">&lt;missing&gt;           4 weeks ago          /bin/sh -c #(nop) ADD file:aa54047c80ba30064…   237MB</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost tomcat]# docker run -d -p 8888:8080 --name tomcat0212 -v /data/tomcatwar:/usr/local/apache-tomcat-8.5.32/webapps -v /data/tomcatlogs:/usr/local/apache-tomcat-8.5.32/logs --privileged=true test/tomcat</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>DevOps</category>
      </categories>
      <tags>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>Nginx模块块stream和ngx_http_proxy_connect_module使用体验</title>
    <url>/arlo/baeb958b/</url>
    <content><![CDATA[<p>因项目环境限制，部署环境分为互联网环境（可访问互联网）和政务外网环境（不可访问互联网）；但是因业务需要，需要实现政务外网环境访问访问外网；（原因不究~~~）</p>
<span id="more"></span>

<p><img src="/images/2020/0812/01.png" alt="01"></p>
<p><img src="/images/2020/0812/02.png" alt="02"></p>
<h1 id="互联网区Server1-nginx搭建"><a href="#互联网区Server1-nginx搭建" class="headerlink" title="互联网区Server1 nginx搭建"></a>互联网区Server1 nginx搭建</h1><p><strong>ngx_http_proxy_connect_module</strong> ：<a href="https://github.com/chobits/ngx_http_proxy_connect_module">https://github.com/chobits/ngx_http_proxy_connect_module</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum install gcc gcc-c++ make automake autoconf libtool pcre pcre-devel zlib zlib-devel openssl openssl-devel wget</span><br><span class="line">wget https://nginx.org/download/nginx-1.18.0.tar.gz</span><br><span class="line">wget https://github.com/chobits/ngx_http_proxy_connect_module/archive/master.zip</span><br><span class="line">tar xf nginx-1.18.0.tar.gz </span><br><span class="line">unzip master.zip</span><br><span class="line">cd nginx-1.18.0</span><br><span class="line">patch -p1 &lt; /usr/local/src/ngx_http_proxy_connect_module-master/patch/proxy_connect.patch </span><br><span class="line"></span><br><span class="line"># nginx版本高于1.9.11，可以使用--add-dynamic-module=/path加载动态模块,配置文件里需要load_module模块位置；使用--add-module=PATH编译，配置文件里不用使用load_module指定模块; </span><br><span class="line"></span><br><span class="line">./configure --prefix=/usr/local/nginx-1.18.0  --with-stream --add-dynamic-module=/usr/local/src/ngx_http_proxy_connect_module-master/</span><br><span class="line"></span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">worker_processes  auto;</span><br><span class="line">error_log  logs/error.log  info;</span><br><span class="line"></span><br><span class="line">load_module /usr/local/nginx-1.18.0/modules/ngx_http_proxy_connect_module.so; #加载模块的配置必须必须放在这个位置</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">                      &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">                      &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line">    access_log  logs/access.log  main;</span><br><span class="line">    sendfile        on;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">       listen       11001;</span><br><span class="line">       server_name  localhost;</span><br><span class="line">       </span><br><span class="line">       location /forecast_pic&#123;</span><br><span class="line">		proxy_pass http://x.x.x.x:xx/forecast_pic ;</span><br><span class="line">            root   html;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">include proxy.conf;		 #为了方便查看，我把ngx_http_proxy_connect_module代理的配置单独放在这个文件里了</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># cat proxy.conf </span><br><span class="line">server &#123;</span><br><span class="line">     listen			    11003;</span><br><span class="line">    </span><br><span class="line">     # dns resolver used by forward proxying</span><br><span class="line">     resolver                       100.125.0.14;</span><br><span class="line"></span><br><span class="line">     location / &#123;</span><br><span class="line">                proxy_pass http://$host$request_uri;      </span><br><span class="line">                proxy_set_header HOST $http_host;</span><br><span class="line">                proxy_buffers 256 4k;</span><br><span class="line">                proxy_max_temp_file_size 0k;</span><br><span class="line">                proxy_connect_timeout 30;</span><br><span class="line">                proxy_send_timeout 60;</span><br><span class="line">                proxy_read_timeout 60;</span><br><span class="line">                proxy_next_upstream error timeout invalid_header http_502;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen                         11004;</span><br><span class="line">    # dns resolver used by forward proxying</span><br><span class="line">    resolver                       100.125.0.14;  #指定cns</span><br><span class="line"></span><br><span class="line">     # forward proxy for CONNECT request</span><br><span class="line">    proxy_connect;</span><br><span class="line">    proxy_connect_allow            443;			#指定https端口</span><br><span class="line">    proxy_connect_connect_timeout  10s;</span><br><span class="line">    proxy_connect_read_timeout     10s;</span><br><span class="line">    proxy_connect_send_timeout     10s;</span><br><span class="line"></span><br><span class="line">    # forward proxy for non-CONNECT request</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://$host;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="政务外网区-Server2-Nginx搭建"><a href="#政务外网区-Server2-Nginx搭建" class="headerlink" title="政务外网区 Server2 Nginx搭建"></a>政务外网区 Server2 Nginx搭建</h1><p><strong>stream</strong> ：<a href="https://nginx.org/en/docs/stream/ngx_stream_core_module.html">https://nginx.org/en/docs/stream/ngx_stream_core_module.html</a></p>
<p>nginx从1.9.0开始，新增加了一个stream模块，用来实现四层协议的转发、代理或者负载均衡等。（代理oracle、mysql等也是非常好用的，推荐~）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum install gcc gcc-c++ make automake autoconf libtool pcre pcre-devel zlib zlib-devel openssl openssl-devel wget</span><br><span class="line">wget https://nginx.org/download/nginx-1.18.0.tar.gz</span><br><span class="line">tar xf nginx-1.18.0.tar.gz </span><br><span class="line">cd nginx-1.18.0/</span><br><span class="line">./configure --prefix=/usr/local/nginx-1.18.0/ --with-stream &amp;&amp; make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">worker_processes  1;</span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line">stream &#123;</span><br><span class="line">   upstream proxy1 &#123;   </span><br><span class="line">        server 16.168.135.174:11003 weight=1 max_fails=2 fail_timeout=30s;   </span><br><span class="line">    &#125;</span><br><span class="line">    upstream proxy2 &#123;   </span><br><span class="line">        server 16.168.135.174:11004 weight=1 max_fails=2 fail_timeout=30s;   </span><br><span class="line">    &#125;</span><br><span class="line"> server &#123;</span><br><span class="line">        listen       11003;</span><br><span class="line">        proxy_connect_timeout 1s;</span><br><span class="line">        proxy_timeout 3s;</span><br><span class="line">        proxy_pass proxy1;</span><br><span class="line">   &#125;</span><br><span class="line"> server &#123;</span><br><span class="line">        listen       11004;</span><br><span class="line">        proxy_connect_timeout 1s;</span><br><span class="line">        proxy_timeout 3s;</span><br><span class="line">        proxy_pass proxy2;</span><br><span class="line">	  &#125;</span><br><span class="line">&#125;</span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line">    sendfile        on;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       11001;</span><br><span class="line">        server_name  localhost;</span><br><span class="line">		location / &#123;</span><br><span class="line">             if ($request_method = &#x27;OPTIONS&#x27;) &#123;</span><br><span class="line">	   			add_header &#x27;Access-Control-Allow-Origin&#x27; *;</span><br><span class="line">            	add_header &#x27;Access-Control-Allow-Credentials&#x27; &#x27;true&#x27;;</span><br><span class="line">           		add_header &#x27;Access-Control-Allow-Methods&#x27; &#x27;GET, POST, PUT, DELETE, OPTIONS&#x27;;</span><br><span class="line">            	add_header &#x27;Access-Control-Allow-Headers&#x27; &#x27;DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,token,timestamp&#x27;;</span><br><span class="line">            	add_header &#x27;Access-Control-Max-Age&#x27; 1728000;</span><br><span class="line">            	add_header &#x27;Content-Type&#x27; &#x27;text/plain charset=UTF-8&#x27;;</span><br><span class="line">            	add_header &#x27;Content-Length&#x27; 0;</span><br><span class="line">           	 return 204;	</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">        location /forecast_pic &#123;</span><br><span class="line">	    	proxy_pass http://x.x.x.x:xx1/forecast_pic;</span><br><span class="line">            root   html;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">		location /FJAtmoCompr &#123;</span><br><span class="line">	    	proxy_pass http://x.x.x.x:xx2/FJAtmoCompr;</span><br><span class="line">		&#125;</span><br><span class="line">		location /cdwarn &#123;</span><br><span class="line">	    	proxy_pass http://x.x.x.x:xx3/cdwarn;</span><br><span class="line">		&#125;</span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="政务外网区-Server3-代理使用测试"><a href="#政务外网区-Server3-代理使用测试" class="headerlink" title="政务外网区 Server3 代理使用测试"></a>政务外网区 Server3 代理使用测试</h1><p><img src="/images/2020/0812/03.png" alt="03"></p>
<p>为了长期使用，我们将代理设置为系统环境变量</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/profile</span><br><span class="line"></span><br><span class="line">export http_proxy=&#x27;16.167.5.198:11003&#x27;</span><br><span class="line">export https_proxy=&#x27;16.167.5.198:11004&#x27;</span><br><span class="line">export ftp_proxy=&#x27;16.167.5.198:11003&#x27;</span><br><span class="line"></span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>

<p><img src="/images/2020/0812/04.png" alt="04"></p>
]]></content>
      <categories>
        <category>服务器搭建</category>
      </categories>
      <tags>
        <tag>nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>The valid characters are defined in RFC 7230 and RFC 3986</title>
    <url>/arlo/a534b34d/</url>
    <content><![CDATA[<h1 id="当项目升级到tomcat高版本（tomcat7-）请求时报“The-valid-characters-are-defined-in-RFC-7230-and-RFC-3986”的400错误该怎么解决"><a href="#当项目升级到tomcat高版本（tomcat7-）请求时报“The-valid-characters-are-defined-in-RFC-7230-and-RFC-3986”的400错误该怎么解决" class="headerlink" title="当项目升级到tomcat高版本（tomcat7+）请求时报“The valid characters are defined in RFC 7230 and RFC 3986”的400错误该怎么解决"></a>当项目升级到tomcat高版本（tomcat7+）请求时报“The valid characters are defined in RFC 7230 and RFC 3986”的400错误该怎么解决</h1><p>在tomcat的server.xml<Connector port="8080" protocol="HTTP/1.1" /> 标签中添加属性relaxedQueryChars，属性配置为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">relaxedQueryChars=&quot;[,],|,&#123;,&#125;,^,&amp;#x5c;,&amp;#x60;,&amp;quot;,&amp;lt;,&amp;gt;&quot;</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<p><img src="/images/2020/1026/01.png" alt="01"></p>
<p>解释如下：</p>
<p>“The valid characters are defined in RFC 7230 and RFC 3986”错误提示，说明访问地址中出现特殊不符合规范的特殊字符。根据rfc规范（RFC 3986规范定义了Url中只允许包含英文字母（a-zA-Z）、数字（0-9）、-_.~4个特殊字符以及所有保留字符(RFC3986中指定了以下字符为保留字符：! * ’ ( ) ; : @ &amp; &#x3D; + $ , &#x2F; ? # [ ])）,当在URL中使用保留字符时，需要对保留字符进行转义。【详见<a href="https://ningyu1.github.io/blog/20190626/117-tomcat-RFC3986.html%E3%80%91">https://ningyu1.github.io/blog/20190626/117-tomcat-RFC3986.html】</a></p>
<p>tomcat从特定版本开始进行了特殊字符校验，Tomcat 7.0.73+，Tomcat 8.0.39+，Tomcat 8.5.7+，Tomcat 9.0.0.M12 (markt)+,因为大多数浏览器并不会对这些保留字符进行转义，所以tomcat会拒绝这些请求，为此tomcat提供了属性配置：relaxedQueryChars,可以支持” &lt; &gt; [ \ ] ^ &#96; { | }这11个字符的访问</p>
<h1 id="Tomcat-7-‘javax-el-ELException’-的解决方式（failed-to-parse-the-expression-xxx-）"><a href="#Tomcat-7-‘javax-el-ELException’-的解决方式（failed-to-parse-the-expression-xxx-）" class="headerlink" title="Tomcat 7 ‘javax.el.ELException’ 的解决方式（failed to parse the expression [${xxx}]）"></a>Tomcat 7 ‘javax.el.ELException’ 的解决方式（failed to parse the expression [${xxx}]）</h1><p>Tomcat 7 ‘javax.el.ELException’ 的解决方式<br>tomcat 7对EL表达式的语法要求比较严格，例如”${owner.new}”因包含关键字new就会导致解析出错。<br>问题是出来了，怎么解决呢？有三种，如下：<br>第一种：严格遵守java规范，修改对象的属性名称，要求不包含java关键字;<br>第二种：修改EL表达式，例如”${owner.new}”可以修改为”${owner[‘new’]}”;<br>第三种：修改tomcat属性，忽略对EL表达式的关键字检查。修改$CATALINA_BASE&#x2F;conf&#x2F;catalina.properties文件，添加org.apache.el.parser.SKIP_IDENTIFIER_CHECK&#x3D;true选项。</p>
<h1 id="Tomcat启动时出现乱码"><a href="#Tomcat启动时出现乱码" class="headerlink" title="Tomcat启动时出现乱码"></a>Tomcat启动时出现乱码</h1><p>找到<strong>Tomcat</strong>目录下<strong>conf</strong>文件夹中的<strong>logging.properties</strong>文件，打开<strong>logging.properties</strong>文件，找到文件中的<strong>java.util.logging.ConsoleHandler.encoding &#x3D; UTF-8</strong>, 修改为<strong>java.util.logging.ConsoleHandler.encoding &#x3D; GBK</strong></p>
]]></content>
      <categories>
        <category>Troubleshooting</category>
      </categories>
      <tags>
        <tag>Troubleshooting</tag>
        <tag>Tomcat</tag>
      </tags>
  </entry>
  <entry>
    <title>Thread 1 cannot allocate new log 故障处理</title>
    <url>/arlo/2cd5eb70/</url>
    <content><![CDATA[<p>开发反馈业务系统无法登录，排查了到数据库部分时候，发现日志里有“ Thread 1 cannot allocate new log ”错误，该错误是redo日志组无法切换，初步查看了日志情况，没有可切换空余的日志组。</p>
<span id="more"></span>

<h1 id="各种状态含义"><a href="#各种状态含义" class="headerlink" title="各种状态含义"></a>各种状态含义</h1><p><strong>CURRENT</strong>：指当前的日志文件,在进行实例恢复时是必须的；</p>
<p><strong>ACTIVE</strong>：是指活动的非当前日志,在进行实例恢复时会被用到。Active状态意味着,Checkpoint尚未完成,因此该日志文件不能被覆盖。这时也不能drop掉,应该执行alter system checkpoint; –强制执行检查点;然后在操作。</p>
<p><strong>INACTIVE</strong>：是非活动日志,在实例恢复时不再需要,但在介质恢复时可能需要。</p>
<p><strong>UNUSED</strong>：表示该日志从未被写入,可能是刚添加的,或RESETLOGS后被重置。</p>
<h1 id="查看日志状态"><a href="#查看日志状态" class="headerlink" title="查看日志状态"></a>查看日志状态</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">--查看日志组状态</span><br><span class="line">select group#,sequence#,bytes,members,status from v$log;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">--查看当前日志组成员</span><br><span class="line">select * from v$logfile;</span><br><span class="line">select * from v$log;</span><br></pre></td></tr></table></figure>

<h1 id="增加日志组"><a href="#增加日志组" class="headerlink" title="增加日志组"></a>增加日志组</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SQL&gt; alter database add logfile group 4 (&#x27;/u01/app/oracle/oradata/orcl/redo04.log&#x27;) size 1024m;</span><br><span class="line"></span><br><span class="line">SQL&gt; alter database add logfile group 5 (&#x27;/u01/app/oracle/oradata/orcl/redo05.log&#x27;) size 1024m;</span><br><span class="line"></span><br><span class="line">SQL&gt; alter database add logfile group 6 (&#x27;/u01/app/oracle/oradata/orcl/redo06.log&#x27;) size 1024m;</span><br></pre></td></tr></table></figure>

<h1 id="切换到新增的日志组上"><a href="#切换到新增的日志组上" class="headerlink" title="切换到新增的日志组上"></a>切换到新增的日志组上</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SQL&gt; alter system switch logfile;   --可多次执行,直到CURRENT指向新建的日志组</span><br></pre></td></tr></table></figure>

<h1 id="删除日志组"><a href="#删除日志组" class="headerlink" title="删除日志组"></a>删除日志组</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-- 只能删除INACTIVE状态日志， 只能从数据库中删除日志，并不删除物理文件，需要手动rm删除系统中的物理文件。</span><br><span class="line">alter database drop logfile group 1;</span><br><span class="line">alter database drop logfile group 2;</span><br><span class="line">alter database drop logfile group 3;</span><br></pre></td></tr></table></figure>

<p>ps：</p>
<p>查看占用资源较多的进程，根据进程系统进程id查看sql语句；</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT addr FROM v$process WHERE spid=&#x27;418736&#x27;;</span><br><span class="line">SELECT sql_id FROM v$session WHERE paddr=&#x27;0000000978F9B0E0&#x27;</span><br><span class="line">SELECT sql_text FROM v$sql WHERE sql_id =&#x27;0uy9j8b502c4r&#x27;;</span><br></pre></td></tr></table></figure>

<p>如果遇到复杂的性能问题，还是建议生成awr报告，更加详细的反馈数据库的性能，瓶颈，根据具体项去做优化。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SYS@orcl&gt; @?/rdbms/admin/awrrpt.sql</span><br></pre></td></tr></table></figure>



<p>参考链接：</p>
<p><a href="https://www.cnblogs.com/xqzt/p/5034826.html">https://www.cnblogs.com/xqzt/p/5034826.html</a></p>
<p><a href="https://blog.51cto.com/4709096/1741983">https://blog.51cto.com/4709096/1741983</a></p>
]]></content>
  </entry>
  <entry>
    <title>Zabbix(12)升级php版本</title>
    <url>/arlo/af5322c5/</url>
    <content><![CDATA[<p>漏扫设备扫描处理zabbix服务器有很多漏洞，看了一眼基本上都是openssh和php相关的漏洞，决定升级一下版本。</p>
<p>zabbix4.4.8默认安装的php是5.4.16</p>
<span id="more"></span>

<h1 id="查看php版本"><a href="#查看php版本" class="headerlink" title="查看php版本"></a>查看php版本</h1><p><img src="/images/2020/0602/01.png" alt="01"></p>
<h1 id="升级php版本"><a href="#升级php版本" class="headerlink" title="升级php版本"></a>升级php版本</h1><p><code>rpm -Uvh https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm</code></p>
<p><code>rpm -Uvh https://rpms.remirepo.net/enterprise/remi-release-7.rpm</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cat &lt;&lt;EOF&gt; /etc/yum.repos.d/remi.repo</span><br><span class="line">[remi]</span><br><span class="line">name=Remi&#x27;s RPM repository for Enterprise Linux 7 - $basearch</span><br><span class="line">#baseurl=http://rpms.remirepo.net/enterprise/7/remi/$basearch/</span><br><span class="line">#mirrorlist=https://rpms.remirepo.net/enterprise/7/remi/httpsmirror</span><br><span class="line">mirrorlist=http://cdn.remirepo.net/enterprise/7/remi/mirror</span><br><span class="line">enabled=0</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-remi</span><br><span class="line">EOF</span><br><span class="line">cat &lt;&lt;EOF&gt; /etc/yum.repos.d/remi-php73.repo</span><br><span class="line">[remi-php73]</span><br><span class="line">name=Remi&#x27;s PHP 7.3 RPM repository for Enterprise Linux 7 - $basearch</span><br><span class="line">#baseurl=http://rpms.remirepo.net/enterprise/7/php73/$basearch/</span><br><span class="line">mirrorlist=https://rpms.remirepo.net/enterprise/7/php73/httpsmirror</span><br><span class="line">mirrorlist=http://cdn.remirepo.net/enterprise/7/php73/mirror</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-remi</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p><code>yum -y upgrade php*</code></p>
<h1 id="验证php版本"><a href="#验证php版本" class="headerlink" title="验证php版本"></a>验证php版本</h1><p><img src="/images/2020/0602/02.png" alt="01"></p>
]]></content>
      <categories>
        <category>监控</category>
      </categories>
      <tags>
        <tag>zabbix</tag>
        <tag>监控</tag>
      </tags>
  </entry>
  <entry>
    <title>Zabbix(11)使用zabbix监控VMware虚拟化</title>
    <url>/arlo/1faeef66/</url>
    <content><![CDATA[<p>zabbix也可以监控VMware虚拟化，支持VMware vCenter或vSphere版本最低为4.1。 </p>
<p>以下配置文件参数可用于调整虚拟机监控： </p>
<p><strong>StartVMwareCollectors</strong> - 预先启动Vmware collector收集器实例的数量。 </p>
<p>此值取决于要监控的VMware服务的数量。在大多数情况下，这应该是： servicenum &lt; StartVMwareCollectors &lt; (servicenum * 2)其中 servicenum 是 VMware 服务的数量。例如：如果您有1个VMware服务，请将 StartVMwareCollectors 设置为 2，那么果您有 3 个 VMware 服务，请将其设置为 5。请注意，在大多数情况下，此值不应小于 2，不应大于 VMware 数量的 2 倍服务。还要记住，此值还取决于 VMware 环境大小和 VMwareFrequency 和 VMwarePerfFrequency 配置参数。 </p>
<p><strong>VMwareCacheSize</strong> - 用于存储VMware数据的缓存容量，默认为8M，取值范围：256K-2G。</p>
<p><strong>VMwareFrequency</strong> - 接到VMware服务收集一个新数据的频率，默认为60秒，取值范围：10-86400。</p>
<p> <strong>VMwarePerfFrequency</strong> - 连接到VMware服务收集性能数据的频率，默认为60秒，取值范围：10-86400。 </p>
<p><strong>VMwareTimeout</strong> - VMware collector等待VMware服务响应的时间，默认为10秒，取值范围：1-300。</p>
<span id="more"></span>

<h1 id="配置zabbix服务器"><a href="#配置zabbix服务器" class="headerlink" title="配置zabbix服务器"></a>配置zabbix服务器</h1><p><code>egrep -v &quot;^#|^$&quot; /etc/zabbix/zabbix_server.conf |grep -i vmware</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">StartVMwareCollectors=5</span><br><span class="line">VMwareFrequency=60</span><br><span class="line">VMwarePerfFrequency=60</span><br><span class="line">VMwareTimeout=60</span><br></pre></td></tr></table></figure>

<p><code>systemctl restart zabbix-server</code></p>
<p><code>systemctl status zabbix-server</code></p>
<p><img src="/images/2020/0515/01.png" alt="01"></p>
<h1 id="添加vCenter"><a href="#添加vCenter" class="headerlink" title="添加vCenter"></a>添加vCenter</h1><p><img src="/images/2020/0515/02.png" alt="01"></p>
<p>关联模板</p>
<p><img src="/images/2020/0515/03.png" alt="01"></p>
<p>点击宏，添加以下内容</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;$USERNAME&#125;：vcenter超管</span><br><span class="line">&#123;$PASSWORD&#125;：vcenter超管密码</span><br><span class="line">&#123;$URL&#125;：https://vcenterip/sdk</span><br></pre></td></tr></table></figure>

<p><img src="/images/2020/0515/04.png" alt="01"></p>
<h1 id="自动发现"><a href="#自动发现" class="headerlink" title="自动发现"></a>自动发现</h1><p>点击vcenter主机-自动发现规则-勾选自动发现规则-点击现在检查</p>
<p><img src="/images/2020/0515/05.png" alt="01"></p>
<p><img src="/images/2020/0515/06.png" alt="01"></p>
<p><img src="/images/2020/0515/07.png" alt="01"></p>
<p>至此，已经实现了对vmware虚拟化平台的监控，但是默认的模板里没有图形和触发器，我还需要继续研究一下。</p>
<p>可以参考：</p>
<p><a href="https://www.mr-mao.cn/archives/zabbix-monitor-vcenter-esxi-vm.html">https://www.mr-mao.cn/archives/zabbix-monitor-vcenter-esxi-vm.html</a></p>
<p><a href="https://www.zabbix.com/documentation/4.0/zh/manual/config/items/itemtypes/simple_checks/vmware_keys">https://www.zabbix.com/documentation/4.0/zh/manual/config/items/itemtypes/simple_checks/vmware_keys</a></p>
]]></content>
      <categories>
        <category>监控</category>
      </categories>
      <tags>
        <tag>zabbix</tag>
        <tag>监控</tag>
      </tags>
  </entry>
  <entry>
    <title>jenkins权限管理插件&#39;Role-based Authorization Strategy&#39;使用</title>
    <url>/arlo/bf292362/</url>
    <content><![CDATA[<p>由于项目组人员比较多，为了更加方便，安全的使用jenkins；我们使用“Role-based Authorization Strategy”细化jenkins的权限。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>分配一个用户，仅能操作以下图中所示项目</p>
<p><img src="/%5Cimages%5C2020%5C1109%5C00.jpg" alt="01"></p>
<span id="more"></span>

<h1 id="安装插件"><a href="#安装插件" class="headerlink" title="安装插件"></a>安装插件</h1><p>系统管理–&gt;插件管理–&gt;可选插件–&gt;Role-based Authorization Strategy–&gt;直接安装然后重启jenkins</p>
<h1 id="新建用户"><a href="#新建用户" class="headerlink" title="新建用户"></a>新建用户</h1><p>系统管理–&gt;安全–&gt;管理用户–&gt;新建用户</p>
<p><img src="/images/2020/1109/02.jpg" alt="01"></p>
<h1 id="配置jenkins"><a href="#配置jenkins" class="headerlink" title="配置jenkins"></a>配置jenkins</h1><p>系统管理–&gt;安全–&gt;全局安全配置–&gt;授权策略–&gt;选择“Role-Based Strategy”</p>
<p><img src="/images/2020/1109/01.png" alt="01"></p>
<h2 id="为角色分配权限"><a href="#为角色分配权限" class="headerlink" title="为角色分配权限"></a>为角色分配权限</h2><p>系统管理–&gt;安全–&gt;Manage and Assign Roles–&gt;Manage Roles</p>
<p><img src="/images/2020/1109/03.png" alt="01"></p>
<p><img src="/images/2020/1109/04.png" alt="01"></p>
<p>*<em>Ps：如果需要使用通配符匹配多个，需使用  .</em> **</p>
<h2 id="为jenkins分配角色"><a href="#为jenkins分配角色" class="headerlink" title="为jenkins分配角色"></a>为jenkins分配角色</h2><p>系统管理–&gt;安全–&gt;Manage and Assign Roles–&gt;Assign Roles</p>
<p><img src="/images/2020/1109/05.jpg" alt="01"></p>
<h1 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h1><p><img src="/images/2020/1109/06.jpg" alt="01"></p>
<p>参考：<a href="https://www.cnblogs.com/cyleon/p/11046521.html">https://www.cnblogs.com/cyleon/p/11046521.html</a></p>
]]></content>
      <categories>
        <category>Jenkins</category>
      </categories>
      <tags>
        <tag>Jenkins</tag>
      </tags>
  </entry>
  <entry>
    <title>zabbix(13)实现短信接口告警</title>
    <url>/arlo/c254fd0e/</url>
    <content><![CDATA[<p>最近有个内网项目搭建了一套zabbix监控，由于不能访问互联网，导致告警无法使用邮件，钉钉类的方式推送告警通知；了解到之前项目上采购过一个金笛短信设备，拿来一试。</p>
<h1 id="官方文档说明"><a href="#官方文档说明" class="headerlink" title="官方文档说明"></a>官方文档说明</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">短信发送URL：</span><br><span class="line">http://127.0.0.1:8060/send?password=[password]&amp;text=[text]&amp;recipient=[cell-phone number]&amp;encoding=U</span><br><span class="line">短信接收URL：</span><br><span class="line">http://127.0.0.1:8060/read?password=[password]&amp;gateway=modem[id]&amp;count=[number]</span><br><span class="line">短信发送状态URL：</span><br><span class="line">http://127.0.0.1:8060/sendstatus?msgid=[msgid]</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h1 id="使用浏览器测试短信发送"><a href="#使用浏览器测试短信发送" class="headerlink" title="使用浏览器测试短信发送"></a>使用浏览器测试短信发送</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://10.206.2.108:8060/send?password=1&amp;text=[tes20200611]&amp;recipient=18xxxxxxxxx&amp;encoding=U</span><br></pre></td></tr></table></figure>

<p>手机可以正常收到。</p>
<h1 id="编写短信发送脚本"><a href="#编写短信发送脚本" class="headerlink" title="编写短信发送脚本"></a>编写短信发送脚本</h1><p><code>grep -E AlertScriptsPath /etc/zabbix/zabbix_server.conf</code><br><code>cd /usr/lib/zabbix/alertscripts</code></p>
<p><code>vim sendSMS.sh</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@zw_zabbix_server alertscripts]# vim sendSMS.sh </span><br><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line"># 脚本的日志文件</span><br><span class="line">LOGFILE=&quot;/tmp/SMS.log&quot;</span><br><span class="line">:&gt;&quot;$LOGFILE&quot;</span><br><span class="line">exec 1&gt;&quot;$LOGFILE&quot;</span><br><span class="line">exec 2&gt;&amp;1</span><br><span class="line"></span><br><span class="line">MOBILE_NUMBER=$1    # 手机号码</span><br><span class="line">MESSAGE_UTF8=$3     # 短信内容</span><br><span class="line">XXD=&quot;/usr/bin/xxd&quot;</span><br><span class="line">CURL=&quot;/usr/bin/curl&quot;</span><br><span class="line">TIMEOUT=5</span><br><span class="line"></span><br><span class="line"># 短信内容要经过URL编码处理</span><br><span class="line">MESSAGE_ENCODE=$(echo &quot;$MESSAGE_UTF8&quot; | $&#123;XXD&#125; -ps | sed &#x27;s/\(..\)/%\1/g&#x27; | tr -d &#x27;\n&#x27;)</span><br><span class="line"></span><br><span class="line"># SMS API</span><br><span class="line">URL=&quot;http://10.206.2.108:8060/send?password=1&amp;text=$&#123;MESSAGE_ENCODE&#125;&amp;recipient=$MOBILE_NUMBER&amp;encoding=U&quot;</span><br><span class="line"></span><br><span class="line"># Send it</span><br><span class="line">set -x</span><br><span class="line">$&#123;CURL&#125; -s --connect-timeout $&#123;TIMEOUT&#125; &quot;$&#123;URL&#125;&quot;</span><br></pre></td></tr></table></figure>

<p><code> chmod +x sendSMS.sh</code></p>
<p><code>./sendSMS.sh 18xxxxxxxxx &quot;&quot; &quot;test zabbix sendmail&quot;</code></p>
<p>手机可以正常收到。</p>
<h1 id="配置zabbix"><a href="#配置zabbix" class="headerlink" title="配置zabbix"></a>配置zabbix</h1><h2 id="管理-报警媒介类型-创建媒体类型"><a href="#管理-报警媒介类型-创建媒体类型" class="headerlink" title="管理-报警媒介类型-创建媒体类型"></a>管理-报警媒介类型-创建媒体类型</h2><p><img src="/images/2020/0611/01.png" alt="01"></p>
<p><img src="/images/2020/0611/02.png" alt="01"></p>
<p>脚本参数</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">名称：sendSMS</span><br><span class="line">类型：脚本</span><br><span class="line">脚本名称：sendSMS.sh</span><br><span class="line">添加以下3个参数，分别对应sendSMS.sh脚本需要的3个参数</span><br><span class="line">收短信电话号码:&#123;ALERT.SENDTO&#125;</span><br><span class="line">主题:&#123;ALERT.SUBJECT&#125;	#好像没什么用</span><br><span class="line">短信内容:&#123;ALERT.MESSAGE&#125;</span><br></pre></td></tr></table></figure>

<h2 id="设置用户报警媒介"><a href="#设置用户报警媒介" class="headerlink" title="设置用户报警媒介"></a>设置用户报警媒介</h2><p><img src="/images/2020/0611/03.png" alt="01"></p>
<p><img src="/%5Cimages%5C2020%5C0611/04.png" alt="01"></p>
<p><img src="/images/2020/0611/05.png" alt="01"></p>
<h2 id="触发告警器"><a href="#触发告警器" class="headerlink" title="触发告警器"></a>触发告警器</h2><p><img src="/images/2020/0611/06.png" alt="01"></p>
<p><img src="/images/2020/0611/07.png" alt="01"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">默认接收人:藏_故障&#123;TRIGGER.STATUS&#125;:服务器 &#123;HOSTNAME1&#125;:&#123;TRIGGER.NAME&#125;</span><br><span class="line">默认信息:</span><br><span class="line">告警主机:&#123;HOSTNAME1&#125;</span><br><span class="line">告警时间:&#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125;</span><br><span class="line">告警等级:&#123;TRIGGER.SEVERITY&#125;</span><br><span class="line">告警信息: &#123;TRIGGER.NAME&#125;</span><br><span class="line">告警项目:&#123;TRIGGER.KEY1&#125;</span><br><span class="line">问题详情:&#123;ITEM.NAME&#125;:&#123;ITEM.VALUE&#125;</span><br><span class="line">当前状态:&#123;TRIGGER.STATUS&#125;:&#123;ITEM.VALUE1&#125;</span><br><span class="line">事件ID:&#123;EVENT.ID&#125;</span><br><span class="line">请至Montoring-Events中查看详细情况。</span><br></pre></td></tr></table></figure>

<p><img src="/images/2020/0611/08.png" alt="01"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">默认接收人:藏_故障&#123;TRIGGER.STATUS&#125;:服务器 &#123;HOSTNAME1&#125;:&#123;TRIGGER.NAME&#125;</span><br><span class="line">告警主机:&#123;HOSTNAME1&#125;</span><br><span class="line">告警时间:&#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125;</span><br><span class="line">告警等级:&#123;TRIGGER.SEVERITY&#125;</span><br><span class="line">告警信息: &#123;TRIGGER.NAME&#125;</span><br><span class="line">告警项目:&#123;TRIGGER.KEY1&#125;</span><br><span class="line">问题详情:&#123;ITEM.NAME&#125;:&#123;ITEM.VALUE&#125;</span><br><span class="line">当前状态:&#123;TRIGGER.STATUS&#125;:&#123;ITEM.VALUE1&#125;</span><br><span class="line">事件ID:&#123;EVENT.ID&#125;</span><br><span class="line">报警已恢复，请放松心情。</span><br></pre></td></tr></table></figure>

<h2 id="测试告警"><a href="#测试告警" class="headerlink" title="测试告警"></a>测试告警</h2><p>关闭agent，测试告警</p>
<p><img src="/images/2020/0611/09.png" alt="01"></p>
<p>测试成功。</p>
<p><em>ps：第二天测试的时候发现短信平台成功发送了，但是手机收不到短信，咨询厂家，怀疑是运营商拦截了。</em></p>
]]></content>
      <categories>
        <category>监控</category>
      </categories>
      <tags>
        <tag>zabbix</tag>
        <tag>监控</tag>
      </tags>
  </entry>
  <entry>
    <title>处理Oracle故障：error=27072 txt: &#39;Linux-x86_64 Error: 5: Input/output error</title>
    <url>/arlo/bd0ffc81/</url>
    <content><![CDATA[<p>今天周末，一大早开发经理发消息说项目上有个数据库连不上了，让上去排查一下。连上数据库之后，监听是启动状态，但是并没有注册数据库，看日志早上8点多的时候数据库出错，自动关掉了，错误日志如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tail -n 1000 /u01/app/oracle/diag/rdbms/orcl/orcl/trace/alert_orcl.log</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Sat Apr 18 23:50:29 2020</span><br><span class="line">Thread 1 cannot allocate new log, sequence 11779</span><br><span class="line">Private strand flush not complete</span><br><span class="line">  Current log# 3 seq# 11778 mem# 0: /u01/app/oracle/oradata/orcl/redo03.log</span><br><span class="line">Thread 1 advanced to log sequence 11779 (LGWR switch)</span><br><span class="line">  Current log# 1 seq# 11779 mem# 0: /u01/app/oracle/oradata/orcl/redo01.log</span><br><span class="line">Sun Apr 19 01:29:06 2020</span><br><span class="line">Thread 1 advanced to log sequence 11780 (LGWR switch)</span><br><span class="line">  Current log# 2 seq# 11780 mem# 0: /u01/app/oracle/oradata/orcl/redo02.log</span><br><span class="line">Sun Apr 19 02:00:00 2020</span><br><span class="line">Closing scheduler window</span><br><span class="line">Closing Resource Manager plan via scheduler window</span><br><span class="line">Clearing Resource Manager plan via parameter</span><br><span class="line">Sun Apr 19 03:02:45 2020</span><br><span class="line">Thread 1 advanced to log sequence 11781 (LGWR switch)</span><br><span class="line">  Current log# 3 seq# 11781 mem# 0: /u01/app/oracle/oradata/orcl/redo03.log</span><br><span class="line">Sun Apr 19 04:49:42 2020</span><br><span class="line">Thread 1 advanced to log sequence 11782 (LGWR switch)</span><br><span class="line">  Current log# 1 seq# 11782 mem# 0: /u01/app/oracle/oradata/orcl/redo01.log</span><br><span class="line">Sun Apr 19 06:00:00 2020</span><br><span class="line">Setting Resource Manager plan SCHEDULER[0x32DF]:DEFAULT_MAINTENANCE_PLAN via scheduler window</span><br><span class="line">Setting Resource Manager plan DEFAULT_MAINTENANCE_PLAN via parameter</span><br><span class="line">Sun Apr 19 06:00:00 2020</span><br><span class="line">Starting background process VKRM</span><br><span class="line">Sun Apr 19 06:00:00 2020</span><br><span class="line">VKRM started with pid=58, OS id=17023 </span><br><span class="line">Sun Apr 19 06:00:02 2020</span><br><span class="line">Begin automatic SQL Tuning Advisor run for special tuning task  &quot;SYS_AUTO_SQL_TUNING_TASK&quot;</span><br><span class="line">Sun Apr 19 06:00:07 2020</span><br><span class="line">Thread 1 advanced to log sequence 11783 (LGWR switch)</span><br><span class="line">  Current log# 2 seq# 11783 mem# 0: /u01/app/oracle/oradata/orcl/redo02.log</span><br><span class="line">Sun Apr 19 06:00:51 2020</span><br><span class="line">End automatic SQL Tuning Advisor run for special tuning task  &quot;SYS_AUTO_SQL_TUNING_TASK&quot;</span><br><span class="line">Sun Apr 19 07:10:49 2020</span><br><span class="line">Thread 1 advanced to log sequence 11784 (LGWR switch)</span><br><span class="line">  Current log# 3 seq# 11784 mem# 0: /u01/app/oracle/oradata/orcl/redo03.log</span><br><span class="line">Sun Apr 19 08:00:49 2020</span><br><span class="line">KCF: read, write or open error, block=0xe0 online=1</span><br><span class="line">        file=3 &#x27;/u01/app/oracle/oradata/orcl/undotbs01.dbf&#x27;</span><br><span class="line">        error=27072 txt: &#x27;Linux-x86_64 Error: 5: Input/output error</span><br><span class="line">Additional information: 4</span><br><span class="line">Additional information: 224</span><br><span class="line">Additional information: -1&#x27;</span><br><span class="line">Errors in file /u01/app/oracle/diag/rdbms/orcl/orcl/trace/orcl_dbw1_19450.trc:</span><br><span class="line">Errors in file /u01/app/oracle/diag/rdbms/orcl/orcl/trace/orcl_dbw1_19450.trc:</span><br><span class="line">ORA-63999: data file suffered media failure</span><br><span class="line">ORA-01114: IO error writing block to file 3 (block # 224)</span><br><span class="line">ORA-01110: data file 3: &#x27;/u01/app/oracle/oradata/orcl/undotbs01.dbf&#x27;</span><br><span class="line">ORA-27072: File I/O error</span><br><span class="line">Linux-x86_64 Error: 5: Input/output error</span><br><span class="line">Additional information: 4</span><br><span class="line">Additional information: 224</span><br><span class="line">Additional information: -1</span><br><span class="line">DBW1 (ospid: 19450): terminating the instance due to error 63999</span><br><span class="line">Sun Apr 19 08:00:49 2020</span><br><span class="line">System state dump requested by (instance=1, osid=19450 (DBW1)), summary=[abnormal instance termination].</span><br><span class="line">System State dumped to trace file /u01/app/oracle/diag/rdbms/orcl/orcl/trace/orcl_diag_19440_20200419080049.trc</span><br><span class="line">Dumping diagnostic data in directory=[cdmp_20200419080049], requested by (instance=1, osid=19450 (DBW1)), summary=[abnormal instance termination].</span><br><span class="line">Instance terminated by DBW1, pid = 19450</span><br></pre></td></tr></table></figure>

<p>第一反应是磁盘空间是不是满了，查看了系统空间，&#x2F;u01分区剩余还很多</p>
<p><img src="/images/2020/0419/01.png" alt="oracle"></p>
<p>经查看，这台机器是虚拟机环境，非实体机，可能存在存储超分的情况（分配出去的存储空间大于实际可用的物理空间，倒是物理空间被耗尽后，系统中依然看到存在富裕剩余空间）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@db-23-200 ~]# dmidecode |grep -i prod</span><br><span class="line">	Product Name: Bochs</span><br></pre></td></tr></table></figure>

<p>为了进一步验证是否存在超分，删除了一个本地的备份文件，然后启动oracle数据库服务，居然拉起来了。原来这tmd就叫惊喜╰(<em>°▽°</em>)╯</p>
<p>参考链接：<a href="https://blog.csdn.net/weixin_39133690/article/details/102799091">https://blog.csdn.net/weixin_39133690/article/details/102799091</a></p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>Oracle</tag>
        <tag>数据库</tag>
      </tags>
  </entry>
  <entry>
    <title>恢复/boot 分区和/etc/fstab 文件</title>
    <url>/arlo/63543e5/</url>
    <content><![CDATA[<p>​		boot 分区是系统启动中最重要的部分，如果服务器由于病毒攻击又或者被管理员误删除了 boot 分区。那么就会存在潜在的风险。为什么说是潜在的风险？因为 boot 分区被删除后系统仍在继续运行，看似无状况但是在执行关机操作后就会无法启动。正常情况下&#x2F;boot 分区都是普通文件系统，ext3&#x2F;ext4&#x2F;xfs（安装操作系统的时候要注意这一点），其他分区为 lvm 逻辑分区，我们这里来模拟一下这个故障，手动删除&#x2F;etc&#x2F;fstab，&#x2F;boot 目录！ （no zuo no die!!! ）</p>
<p><strong>严重声明：禁止在生产环境操作，出现任何问题，和本人无关~</strong></p>
<span id="more"></span>

<h1 id="模拟故障场景"><a href="#模拟故障场景" class="headerlink" title="模拟故障场景"></a>模拟故障场景</h1><p>删除&#x2F;etc&#x2F;fstab、&#x2F;boot 分区文件，然后重启服务器</p>
<p><img src="/images/2020/1201/16.png" alt="03"></p>
<p>重启后故障现象如下</p>
<p><img src="/images/2020/1201/17.png" alt="03"></p>
<h1 id="恢复chroot"><a href="#恢复chroot" class="headerlink" title="恢复chroot"></a>恢复chroot</h1><p>我们挂载 iso 镜像（插入系统光盘），进入到救援模式</p>
<p>由于我们把&#x2F;etc&#x2F;fstab 删除了，所以救援系统找不到原来系统的路径了，我们熟悉的 chroot &#x2F;mnt&#x2F;sysimage 选项提示不见了，所以我们要先恢复&#x2F;etc&#x2F;fstab 文件</p>
<p><img src="/images/2020/1201/18.png" alt="03"></p>
<h1 id="恢复磁盘"><a href="#恢复磁盘" class="headerlink" title="恢复磁盘"></a>恢复磁盘</h1><h2 id="查看磁盘信息"><a href="#查看磁盘信息" class="headerlink" title="查看磁盘信息"></a>查看磁盘信息</h2><p>我们使用 blkid 命令，可以查看到磁盘信息，默认的&#x2F;dev&#x2F;sda1 为&#x2F;boot 分区，看不到 lvm 逻辑卷的存在</p>
<p><img src="/images/2020/1201/19.png" alt="03"></p>
<h2 id="激活逻辑卷"><a href="#激活逻辑卷" class="headerlink" title="激活逻辑卷"></a>激活逻辑卷</h2><p>我们查看一下逻辑卷的状态，都是非激活状态的，我们手动激活一下</p>
<p><img src="/images/2020/1201/20.png" alt="03"></p>
<p>lvscan 查看逻辑卷的状态，此时显示为非激活状态。vgchange -ay 激活所有逻辑卷</p>
<p><img src="/images/2020/1201/21.png" alt="03"></p>
<p>再次查看 lvm 逻辑卷的状态，已经由 INACTIVE（非激活状态）变成 ACTIVE（激活状态）了。</p>
<p><img src="/images/2020/1201/22.png" alt="03"></p>
<h1 id="恢复-x2F-etc-x2F-fstab-文件"><a href="#恢复-x2F-etc-x2F-fstab-文件" class="headerlink" title="恢复&#x2F;etc&#x2F;fstab 文件"></a>恢复&#x2F;etc&#x2F;fstab 文件</h1><p>再次 blkid 查看磁盘状态的时候，发现 swap 和&#x2F;分区的逻辑卷已经出现了；新建一个&#x2F;mnt&#x2F;tmp 目录，将&#x2F;分区挂载到&#x2F;mnt&#x2F;tmp 目录下，然后使用 blkid 命令将输出信息导入到&#x2F;mnt&#x2F;tmp&#x2F;etc&#x2F;fstab 文件中，然后进行编辑</p>
<p><img src="/images/2020/1201/23.png" alt="03"></p>
<p>编辑完成的内容如下</p>
<p><img src="/images/2020/1201/24.png" alt="03"></p>
<h2 id="重启之后再次引导到救援模式"><a href="#重启之后再次引导到救援模式" class="headerlink" title="重启之后再次引导到救援模式"></a>重启之后再次引导到救援模式</h2><p>这里就可以看到提示，可以 chroot &#x2F;mnt&#x2F;sysimage 了，然后我们挂载一下 iso 光驱镜像文件，强行安装（ 虽然我们把 &#x2F;boot 目录下的文件删除了，但是系统里的 kernel 包是已经安装的状态，直接安装的话，会提示已经安装了，我们加一个 —force 参数，表示覆盖安装 ）内核 kernel 文件，然后就可以看到&#x2F;boot 目录下已经有文件产生了</p>
<p><img src="/images/2020/1201/25.png" alt="03"></p>
<h1 id="恢复grub"><a href="#恢复grub" class="headerlink" title="恢复grub"></a>恢复grub</h1><p>我们在用之前学过的方法，恢复一下 grub.conf 文件就可以了。</p>
<p><img src="/images/2020/1201/26.png" alt="03"></p>
<p><img src="/images/2020/1201/27.png" alt="03"></p>
<p>可以正常启动到登录界面了，恢复完成！！！</p>
]]></content>
      <categories>
        <category>常识</category>
      </categories>
      <tags>
        <tag>Troubleshooting</tag>
        <tag>磁盘</tag>
      </tags>
  </entry>
  <entry>
    <title>Ansible Playbook入门篇</title>
    <url>/arlo/45b10f7e/</url>
    <content><![CDATA[<p>playbook 是由一组ansible调用module命令的集合，使用yaml语言编写，执行顺序自上而下；</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">命令格式：ansible-playbook test.yml</span><br></pre></td></tr></table></figure>
<span id="more"></span>

<h1 id="Playbook-组成"><a href="#Playbook-组成" class="headerlink" title="Playbook 组成"></a>Playbook 组成</h1><p><strong>Target section: 定义将要执行playbook的远程主机组</strong>  </p>
<ul>
<li>name：执行过程中会打印出来变量的值</li>
<li>hosts：定义远程的主机组</li>
<li>user：执行该任务组的用户</li>
<li>remote_user: 与user一样，任选其一</li>
<li>sudo：如果设置为yes，执行该任务组的用户在执行任务的时候获取root权限</li>
<li>sudo_user：如果sudo设置为yes，user设置为user1，sudo_user设置为user2，那么user1会获取user2权限</li>
<li>connection：通过什么方式连接到远程主机，默认是ssh</li>
<li>gather_facts：除非明确定义不需要在远程主机上执行setup模块，否则会默认自动执行；不需要执行setup模块，需False该选项。</li>
</ul>
<p><strong>Variable section：定义playbook运行时需要使用的变量</strong>  </p>
<ul>
<li>vars：格式为“变量名称:变量值”</li>
<li>vars_files：将变量名称和变量值定义在一个文件中，调用该文件，文件格式为每行一个“变量名称:变量值”</li>
<li>vars_prompt：定义一个变量，通过交互方式让用户输入变量值</li>
</ul>
<p><strong>Task section：定义将要在远程主机上执行的任务列表</strong>  </p>
<ul>
<li>tasks： #三种写法如下</li>
</ul>
<ol>
<li>调用模块<br>name: 定义名称<br>action：模块名称 模块参数调用</li>
<li>直接使用模块<br>name: 定义名称<br>模块名称：调用方法</li>
<li>模块使用<br>name：定义名称<br>模块名称：<br>模块参数调用</li>
</ol>
<p><strong>Handler section：定义task执行完成以后需要调用的任务</strong><br>满足一下两点才能达到触发的效果，否则会不生效。</p>
<ol>
<li>必须在tasks中使用notify调用</li>
<li>在notify中定义内容一定要和tasks中定义的 - name 内容一样</li>
</ol>
<h1 id="新建用户的示例"><a href="#新建用户的示例" class="headerlink" title="新建用户的示例"></a>新建用户的示例</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm00 ~]# cat test.yaml </span><br><span class="line">- name: &quot;新建用户&quot;</span><br><span class="line">  hosts: test</span><br><span class="line">  user: root</span><br><span class="line">  vars:</span><br><span class="line">    user: &quot;user3&quot;</span><br><span class="line">    password: &quot;$1$01a9gEpb$nlv.OmSa1c4jDaGgeoDKi0&quot;   #加密后的密码，可以参考上篇文章中user模块使用</span><br><span class="line">    uid: &quot;700&quot;</span><br><span class="line">  tasks:</span><br><span class="line">    - name: &quot;新建用户&quot;</span><br><span class="line">      user: name=&quot;&#123;&#123;user&#125;&#125;&quot; password=&quot;&#123;&#123;password&#125;&#125;&quot; uid=&quot;&#123;&#123;uid&#125;&#125;&quot;</span><br><span class="line">#      user: name=&quot;&#123;&#123;user&#125;&#125;&quot; state=absent remove=yes    #删除用户的话就使用这行</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm00 ~]# ansible-playbook test.yaml</span><br></pre></td></tr></table></figure>
<p><img src="/images/2017/0622/00.png" alt="playbook"></p>
<h1 id="修改selinux，安装epel扩展包"><a href="#修改selinux，安装epel扩展包" class="headerlink" title="修改selinux，安装epel扩展包"></a>修改selinux，安装epel扩展包</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm00 ~]# cat test2.yml</span><br><span class="line">- hosts: test</span><br><span class="line">  vars:</span><br><span class="line">    packages: &quot;epel-release&quot;</span><br><span class="line">  tasks:</span><br><span class="line">    - name: &quot;永久关闭selinux&quot;</span><br><span class="line">      command: sed -i s/SELINUX=enforcing/SELINUX=disabled/g /etc/selinux/config</span><br><span class="line">    - name: &quot;安装epel扩展包&quot;</span><br><span class="line">      yum: name=&#123;&#123;packages&#125;&#125; state=present</span><br><span class="line">      notify:</span><br><span class="line">      - reboot system</span><br><span class="line">  handlers:</span><br><span class="line">    - name: reboot system</span><br><span class="line">      command: reboot</span><br></pre></td></tr></table></figure>


<p>参考链接：<a href="http://breezey.blog.51cto.com/2400275/1757624">http://breezey.blog.51cto.com/2400275/1757624</a></p>
]]></content>
      <categories>
        <category>自动化运维</category>
      </categories>
      <tags>
        <tag>运维</tag>
        <tag>自动化</tag>
        <tag>Ansible</tag>
      </tags>
  </entry>
  <entry>
    <title>Aansible palybook 创建lvm并自动挂载</title>
    <url>/arlo/1e1aab57/</url>
    <content><![CDATA[<p>由于工作中经常会遇到添加磁盘，分区，挂载这种操作，使用ansible后再也不用一台台的搞了；主要使用到lvg，lvol，filesystem，mount模块；</p>
<span id="more"></span>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">- hosts: test</span><br><span class="line">  vars:</span><br><span class="line">    vg_name: &quot;vgtest&quot;</span><br><span class="line">    lv_name: &quot;lvtest&quot;</span><br><span class="line">    pvs_name: &quot;/dev/sdb&quot;</span><br><span class="line">    dir_path: &quot;/data&quot;</span><br><span class="line">  tasks:</span><br><span class="line">    - name: 创建一个vg</span><br><span class="line">      lvg: </span><br><span class="line">        vg: &quot;&#123;&#123;vg_name&#125;&#125;&quot; </span><br><span class="line">        pvs: &quot;&#123;&#123;pvs_name&#125;&#125;&quot;</span><br><span class="line">        pesize: 4</span><br><span class="line">    - name: 创建一个lv </span><br><span class="line">      lvol:</span><br><span class="line">        vg: &quot;&#123;&#123;vg_name&#125;&#125;&quot;</span><br><span class="line">        lv: &quot;&#123;&#123;lv_name&#125;&#125;&quot;</span><br><span class="line">        size: 100%PVS</span><br><span class="line">    - name: 格式化lv</span><br><span class="line">      filesystem: </span><br><span class="line">        fstype: ext4 </span><br><span class="line">        dev: &quot;/dev/&#123;&#123;vg_name&#125;&#125;/&#123;&#123;lv_name&#125;&#125;&quot;</span><br><span class="line">    - name: 获取UUID</span><br><span class="line">      shell: blkid /dev/&quot;&#123;&#123;vg_name&#125;&#125;&quot;/&quot;&#123;&#123;lv_name&#125;&#125;&quot; |awk &#x27;&#123;print $2&#125;&#x27;</span><br><span class="line">      register: result</span><br><span class="line">      ignore_errors: True</span><br><span class="line">    - name: 创建挂载目录 </span><br><span class="line">      file: </span><br><span class="line">        path: &quot;&#123;&#123;dir_path&#125;&#125;&quot;</span><br><span class="line">        state: directory</span><br><span class="line">        mode: 0755</span><br><span class="line">    - name: 使用UUID挂载lvm分区 </span><br><span class="line">      mount: </span><br><span class="line">         path: /data</span><br><span class="line">         src:  &quot;&#123;&#123;result.stdout&#125;&#125;&quot;</span><br><span class="line">         fstype: ext4</span><br><span class="line">         state: mounted</span><br></pre></td></tr></table></figure>
<p>由于我一直习惯使用UUID挂载分区（UUID是每个分区的唯一标识），所以我加了一步获取UUID的操作，这步也可以略去，挂载的时候使用分区名称进行挂载；还有一点就是使用lvm分区的时候，将整个磁盘做成pv是不需要进行分区操作的，这点比较方便；如果要做分区操作的话，可以使用以下playbook：</p>
<figure class="highlight plaintext"><figcaption><span>hosts: test</span></figcaption><table><tr><td class="code"><pre><span class="line">vars:</span><br><span class="line">  dev_name1: &quot;/dev/sdb&quot;</span><br><span class="line">  dev_name2: &quot;/dev/sdb1&quot;</span><br><span class="line">tasks:</span><br><span class="line">  - name: Disk Partition    </span><br><span class="line">    shell : fdisk &quot;&#123;&#123;dev_name1&#125;&#125;&quot; &lt; /tmp/fdisk_temp.conf  </span><br><span class="line">  - name: Disk Mkfs ext4    </span><br><span class="line">    filesystem: </span><br><span class="line">      fstype: ext4 </span><br><span class="line">      dev: &quot;&#123;&#123;dev_name2&#125;&#125;&quot;</span><br><span class="line">  - name: Disk Mount    </span><br><span class="line">    shell: blkid /dev/sdb1 |awk &#x27;&#123;print $2&#125;&#x27;| sed -n &#x27;s/$/     \/data     ext4     defaults     0 0/p&#x27; &gt;&gt; /etc/fstab &amp;&amp; mount -a</span><br></pre></td></tr></table></figure>
<p>受控机&#x2F;tmp&#x2F;fdisk_temp.conf内容</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">n</span><br><span class="line">p</span><br><span class="line">1</span><br><span class="line">1</span><br><span class="line"></span><br><span class="line">w</span><br><span class="line">q</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>自动化运维</category>
      </categories>
      <tags>
        <tag>运维</tag>
        <tag>自动化</tag>
        <tag>Ansible</tag>
      </tags>
  </entry>
  <entry>
    <title>Ansible 入门篇</title>
    <url>/arlo/40fad05f/</url>
    <content><![CDATA[<p>Ansible (is Simple IT Automation) ,是一款自动化运维工具，基于强大的模块功能通过SSH协议推送到被管理端，可以实现的批量系统部署，批量程序部署，批量执行命令等</p>
<p><strong>特性</strong></p>
<ul>
<li>不需要安装客户端，基于ssh连接管理</li>
<li>不需要配置服务，安装Ansible工具，可以执行命令就可以</li>
<li>拥有大量的模块</li>
<li>支持YAML语法</li>
<li>安装配置简单(门槛低)</li>
<li>被管理机器支持Windows</li>
</ul>
<p><strong>组成部分</strong></p>
<ul>
<li>Ansible 核心</li>
<li>Inventory Ansible管理主机的清单</li>
<li>Modules 包括Ansible自带的核心模块和自定义模块</li>
<li>Plugins 完成模块功能的补充，包括连接插件、邮件插件等</li>
<li>Playbooks 编排文件，定义Ansible多任务配置文件，实现Ansible自动执行<span id="more"></span></li>
</ul>
<h1 id="安装ansible软件"><a href="#安装ansible软件" class="headerlink" title="安装ansible软件"></a>安装ansible软件</h1><p>需要主机有python环境，这个安装没啥说的，一键搞定，so easy！</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum -y install ansible</span><br></pre></td></tr></table></figure>
<h1 id="配置管理主机清单"><a href="#配置管理主机清单" class="headerlink" title="配置管理主机清单"></a>配置管理主机清单</h1><p>默认的主机清单文件是&#x2F;etc&#x2F;ansible&#x2F;hosts </p>
<ol>
<li>可以修改&#x2F;etc&#x2F;ansible&#x2F;ansible.cfg文件中[defaults]下的#inventory参数来修改，</li>
<li>可以在执行命令时候使用-i参数来指定hosts文件</li>
</ol>
<h2 id="最简单的配置主机和组"><a href="#最简单的配置主机和组" class="headerlink" title="最简单的配置主机和组"></a>最简单的配置主机和组</h2><p>配置成主机名的时候，要确保主机名可以被解析(hosts或dns)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[web]</span><br><span class="line">vm01</span><br><span class="line">vm02</span><br><span class="line">[db]</span><br><span class="line">192.168.6.100</span><br><span class="line">192.168.6.101</span><br></pre></td></tr></table></figure>
<h2 id="自定义参数"><a href="#自定义参数" class="headerlink" title="自定义参数"></a>自定义参数</h2><p>ansible_ssh_user 用于指定管理远程主机的账号<br>ansible_ssh_pass 用于指定管理远程主机的密码<br>ansible_ssh_host 用于指定被管理的主机<br>ansible_ssh_port 用于指定ssh的端口<br>ansible_sudo_pass 用于sudo连接用户时的密码<br>ansible_sudo_exec 如果sudo命令不在默认路径，需要指定sudo命令路径<br>ansible_shell_type 目标系统的shell的类型，默认sh<br>ansible_ssh_private_key_file 指定key文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[webservers]</span><br><span class="line">192.168.10.12  ansible_ssh_pass=123456 ansible_ssh_user=root</span><br><span class="line">192.168.10.13  ansible_ssh_pass=123456 ansible_ssh_user=root ansible_ssh_port=3055</span><br><span class="line">vm03 ansible_ssh_pass=123567 ansible_ssh_user=root</span><br></pre></td></tr></table></figure>
<h2 id="指定主机范围"><a href="#指定主机范围" class="headerlink" title="指定主机范围"></a>指定主机范围</h2><p>01:20 表示192.168.6.1到192.168.6.20共20台主机<br>a:f   表示dba.islocal.cc 到dbf.islocal.cc共6台主机</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[db]</span><br><span class="line">192.168.6.[01:20]</span><br><span class="line">db[a:f].islocal.cc</span><br></pre></td></tr></table></figure>
<h2 id="主机组嵌套，"><a href="#主机组嵌套，" class="headerlink" title="主机组嵌套，"></a>主机组嵌套，</h2><p>使用children关键字</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[mfs:children]</span><br><span class="line">mfs_a</span><br><span class="line">mfs_b</span><br><span class="line">mfs_c</span><br><span class="line">[mfs_a]</span><br><span class="line">vm01</span><br><span class="line">[mfs_b]</span><br><span class="line">vm02</span><br><span class="line">[mfs_c]</span><br><span class="line">vm03</span><br></pre></td></tr></table></figure>
<p>测试一下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ansible mfs -m ping</span><br><span class="line">ansible mfs_c -m ping</span><br></pre></td></tr></table></figure>
<h2 id="调用匹配主机或主机组"><a href="#调用匹配主机或主机组" class="headerlink" title="调用匹配主机或主机组"></a>调用匹配主机或主机组</h2><h3 id="匹配所有"><a href="#匹配所有" class="headerlink" title="匹配所有"></a>匹配所有</h3><p>all 或者 *</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ansible all -m ping</span><br></pre></td></tr></table></figure>
<h3 id="匹配组"><a href="#匹配组" class="headerlink" title="匹配组"></a>匹配组</h3><p>直接写组名就ok </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ansible test -m ping</span><br></pre></td></tr></table></figure>
<h3 id="逻辑非"><a href="#逻辑非" class="headerlink" title="逻辑非"></a>逻辑非</h3><p>目标主机在nsxq组不在test组中，逻辑非使用！</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ansible nsxq:!test -m ping</span><br></pre></td></tr></table></figure>
<h3 id="逻辑与"><a href="#逻辑与" class="headerlink" title="逻辑与"></a>逻辑与</h3><p>目标主机在nsxq组并在test中，逻辑与使用&amp;</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ansible nsxq:&amp;test -m ping</span><br></pre></td></tr></table></figure>
<h3 id="支持正则匹配"><a href="#支持正则匹配" class="headerlink" title="支持正则匹配"></a>支持正则匹配</h3><p>匹配一web或者db开头.islocal.cc 的主机</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ansible ~(web|db).*\.islocal\.cc -m ping</span><br></pre></td></tr></table></figure>
<h1 id="设置主机互信，配置SSH免密码登录"><a href="#设置主机互信，配置SSH免密码登录" class="headerlink" title="设置主机互信，配置SSH免密码登录"></a>设置主机互信，配置SSH免密码登录</h1><p>由于ansible是基于ssh来远程管理，执行操作命令的，每次输入密码的话会很繁琐，配置ssh免密码就显得很方便</p>
<ol>
<li>-k 命令会提示输入密码</li>
<li>修改配置文件&#x2F;etc&#x2F;ansible&#x2F;ansible.cfg<br>host_key_checking&#x3D;False   #当第一次连接远程主机时，会提示输入yes&#x2F;no,跳过此环节</li>
</ol>
<p>配置ssh免密码登录，可以参考我之前的另一篇文章**<a href="http://islocal.cc/2017/06/18/%E6%89%B9%E9%87%8F%E4%BF%AE%E6%94%B9%E4%B8%BB%E6%9C%BA%E5%AF%86%E7%A0%81-%E6%89%B9%E9%87%8Fssh%E5%85%8D%E5%AF%86%E7%A0%81%E9%AA%8C%E8%AF%81/">SSH免密码验证</a>**</p>
<h1 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h1><p>查看模块</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ansible-doc -l</span><br></pre></td></tr></table></figure>
<p>查看模块参数用法</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ansible-doc -s module</span><br><span class="line">ansible-doc help module</span><br></pre></td></tr></table></figure>
<h2 id="setup-模块"><a href="#setup-模块" class="headerlink" title="setup 模块"></a>setup 模块</h2><p>查看主机参数配置</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ansible all -m setup</span><br></pre></td></tr></table></figure>
<h2 id="ping-模块"><a href="#ping-模块" class="headerlink" title="ping 模块"></a>ping 模块</h2><p>测试主机连通性</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ansible all -m ping</span><br></pre></td></tr></table></figure>
<h2 id="file-模块"><a href="#file-模块" class="headerlink" title="file 模块"></a>file 模块</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm00 ~]# ansible nsxq -m file -a &#x27;src=/etc/hosts dest=/tmp/hosts&#x27;</span><br><span class="line">[root@vm00 ~]# ansible nsxq -a &#x27;ls -lh /tmp/hosts&#x27;</span><br><span class="line">[root@vm00 ~]# ansible nsxq -m file -&quot;path=/tmp/file1 state=touch&quot;</span><br><span class="line">[root@vm00 ~]# ansible nsxq -m file -a &quot;dest=/tmp/hosts mode=600 owner=airmodel group=airmodel&quot;</span><br><span class="line">[root@vm00 ~]# ansible nsxq -m file -a &quot;dest=/opt/test mode=755 owner=airmodel group=airmodel state=directory&quot;</span><br></pre></td></tr></table></figure>
<h2 id="copy模块"><a href="#copy模块" class="headerlink" title="copy模块"></a>copy模块</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ansible nsxq -m copy -a &quot;src=/etc/hosts dest=/tmp/hosts&quot; </span><br></pre></td></tr></table></figure>
<h2 id="command-模块【默认模块】"><a href="#command-模块【默认模块】" class="headerlink" title="command 模块【默认模块】"></a>command 模块【默认模块】</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ansible all -m command -a &quot;/bin/echo &#x27;hello,sir.&#x27;&quot;</span><br><span class="line">ansible all -a &#x27;chdir=/usr/local/src/ tar -cvzf test.tgz file&#x27;</span><br></pre></td></tr></table></figure>
<h2 id="shell-模块"><a href="#shell-模块" class="headerlink" title="shell 模块"></a>shell 模块</h2><p>和command一样；支持管道</p>
<h2 id="raw-模块"><a href="#raw-模块" class="headerlink" title="raw 模块"></a>raw 模块</h2><p>和command一样</p>
<h2 id="service-模块"><a href="#service-模块" class="headerlink" title="service 模块"></a>service 模块</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ansible nsxq -m service -a &#x27;name=nginx state=started enabled=yes&#x27;</span><br></pre></td></tr></table></figure>
<h2 id="cron-模块"><a href="#cron-模块" class="headerlink" title="cron 模块"></a>cron 模块</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ansible nsxq -m cron -a &#x27;name=&quot;update ntp time&quot; hour=2 user=root job=&quot;/usr/sbin/ntpdate cn.ntp.org.cn&quot;&#x27;</span><br><span class="line">ansible nsxq -m cron -a &#x27;name=&quot;update ntp time&quot; state=absent&#x27;</span><br></pre></td></tr></table></figure>
<h2 id="filesystem-模块"><a href="#filesystem-模块" class="headerlink" title="filesystem 模块"></a>filesystem 模块</h2><h2 id="yum-模块"><a href="#yum-模块" class="headerlink" title="yum 模块"></a>yum 模块</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ansible nsxq -m yum a &#x27;name=httpd state=installed&#x27;</span><br><span class="line">ansible nsxq -m yum a &#x27;name=&quot;@Development Tools&quot; state=present&#x27;</span><br></pre></td></tr></table></figure>
<h2 id="user-模块"><a href="#user-模块" class="headerlink" title="user 模块"></a>user 模块</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ansible nsxq -m user -a &#x27;createhome=yes home=/home/user1 password=&quot;ffffff&quot; name=user1 state=present shell=/bin/bash&#x27;</span><br></pre></td></tr></table></figure>
<h2 id="synchronize-模块"><a href="#synchronize-模块" class="headerlink" title="synchronize 模块"></a>synchronize 模块</h2><p>目录后边跟&#x2F;表示同步目录下内容，不加&#x2F;把目录同步过去</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ansible nsxq -m synchronize -a &#x27;src=/etc/hosts dest=/opt/&#x27;</span><br></pre></td></tr></table></figure>
<h2 id="filesystem-模块-1"><a href="#filesystem-模块-1" class="headerlink" title="filesystem 模块"></a>filesystem 模块</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ansible test -m filesystem -a &#x27;dev=/disk.img fstype=ext4 opts=-F&#x27;</span><br></pre></td></tr></table></figure>
<h2 id="mount-模块"><a href="#mount-模块" class="headerlink" title="mount 模块"></a>mount 模块</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ansible test -m mount -a &#x27;fstype=ext4 name=/aaa src=/dev/loop0 state=mounted&#x27;</span><br></pre></td></tr></table></figure>



<hr>
]]></content>
      <categories>
        <category>自动化运维</category>
      </categories>
      <tags>
        <tag>运维</tag>
        <tag>自动化</tag>
        <tag>Ansible</tag>
      </tags>
  </entry>
  <entry>
    <title>Ansible 模块篇</title>
    <url>/arlo/7a718f23/</url>
    <content><![CDATA[<p>Ansible 之所以能自动化完成这么多操作，都是依赖于丰富的模块；类似Jenkins软件的强大的插件支持</p>
<p>查看模块</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm00 ~]# ansible-doc -l</span><br></pre></td></tr></table></figure>
<p>查看模块参数用法</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm00 ~]# ansible-doc -s module</span><br><span class="line">[root@vm00 ~]# ansible-doc help module</span><br></pre></td></tr></table></figure>
<p>ansible 命令格式</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ansible 主机或组-m 模块名-a &#x27;模块参数&#x27;  </span><br></pre></td></tr></table></figure>
<span id="more"></span>
<h1 id="command-模块"><a href="#command-模块" class="headerlink" title="command 模块"></a>command 模块</h1><p><strong>默认缺省模块</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm00 ~]# ansible all -m command -a &quot;/bin/echo &#x27;hello,sir.&#x27;&quot;</span><br><span class="line">[root@vm00 ~]# ansible all -a &#x27;chdir=/usr/local/src/ tar -cvzf test.tgz file&#x27;</span><br></pre></td></tr></table></figure>
<h1 id="shell-模块"><a href="#shell-模块" class="headerlink" title="shell 模块"></a>shell 模块</h1><p>和command一样；支持管道</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm00 ~]# ansible test -m shell -a &#x27;ps -ef |grep java&#x27;</span><br></pre></td></tr></table></figure>
<h1 id="raw-模块"><a href="#raw-模块" class="headerlink" title="raw 模块"></a>raw 模块</h1><p>和command一样；支持管道</p>
<h1 id="ping-模块"><a href="#ping-模块" class="headerlink" title="ping 模块"></a>ping 模块</h1><p>测试主机连通性，没有参数</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm00 ~]# ansible all -m ping</span><br></pre></td></tr></table></figure>
<h1 id="setup-模块"><a href="#setup-模块" class="headerlink" title="setup 模块"></a>setup 模块</h1><p>查看主机参数配置<br>filter 过滤参数，相当于grep功能</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm00 ~]# ansible vm02 -m setup</span><br></pre></td></tr></table></figure>
<p>将所有主机的信息输入到&#x2F;tmp&#x2F;facts目录下，每台主机的信息输入到主机名文件中（&#x2F;etc&#x2F;ansible&#x2F;hosts里的主机名）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm00 ~]# ansible all -m setup --tree /tmp/facts </span><br></pre></td></tr></table></figure>
<p>获取主机ip地址</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm00 ~]# ansible vm02 -m setup -a &#x27;filter=ansible_default_ipv4&#x27;</span><br></pre></td></tr></table></figure>
<p>获取主机内存使用情况</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm00 ~]# ansible vm02 -m setup -a &#x27;filter=ansible_memory_mb&#x27;</span><br></pre></td></tr></table></figure>
<p>获取主机名</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ansible vm02 -m setup -a &#x27;filter=ansible_nodename&#x27;</span><br></pre></td></tr></table></figure>
<h1 id="file-模块"><a href="#file-模块" class="headerlink" title="file 模块"></a>file 模块</h1><p>file模块主要用于远程主机上的文件操作，file模块包含如下选项：<br>force：需要在两种情况下强制创建软链接，一种是源文件不存在但之后会建立的情况下；另一种是目标软链接已存在,需要先取消之前的软链，然后创建新的软链，有两个选项：yes|no<br>group：定义文件&#x2F;目录的属组<br>mode：定义文件&#x2F;目录的权限<br>owner：定义文件&#x2F;目录的属主<br>path：必选项，定义文件&#x2F;目录的路径<br>recurse：递归的设置文件的属性，只对目录有效<br>src：要被链接的源文件的路径，只应用于state&#x3D;link的情况<br>dest：被链接到的路径，只应用于state&#x3D;link的情况<br>state：  </p>
<ul>
<li>directory：如果目录不存在，创建目录</li>
<li>file：即使文件不存在，也不会被创建</li>
<li>link：创建软链接</li>
<li>hard：创建硬链接</li>
<li>touch：如果文件不存在，则会创建一个新的文件，如果文件或目录已存在，则更新其最后修改时间</li>
<li>absent：删除目录、文件或者取消链接文件</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm00 ~]# ansible nsxq -m file -a &#x27;src=/etc/hosts dest=/tmp/hosts&#x27;</span><br><span class="line">[root@vm00 ~]# ansible nsxq -a &#x27;ls -lh /tmp/hosts&#x27;</span><br><span class="line">[root@vm00 ~]# ansible nsxq -m file -a &quot;path=/tmp/file1 state=touch&quot;</span><br><span class="line">[root@vm00 ~]# ansible nsxq -m file -a &quot;dest=/tmp/hosts mode=600 owner=airmodel group=airmodel&quot;</span><br><span class="line">[root@vm00 ~]# ansible nsxq -m file -a &quot;dest=/opt/test mode=755 owner=airmodel group=airmodel state=directory&quot;</span><br></pre></td></tr></table></figure>
<h1 id="copy模块"><a href="#copy模块" class="headerlink" title="copy模块"></a>copy模块</h1><p>复制文件到远程主机，copy模块包含如下选项：<br>backup：在覆盖之前将原文件备份，备份文件包含时间信息。有两个选项：yes|no<br>content：用于替代”src”,可以直接设定指定文件的值<br>dest：必选项。要将源文件复制到的远程主机的绝对路径，如果源文件是一个目录，那么该路径也必须是个目录<br>directory_mode：递归的设定目录的权限，默认为系统默认权限<br>force：如果目标主机包含该文件，但内容不同，如果设置为yes，则强制覆盖，如果为no，则只有当目标主机的目标位置不存在该文件时，才复制。默认为yes<br>others：所有的file模块里的选项都可以在这里使用<br>src：要复制到远程主机的文件在本地的地址，可以是绝对路径，也可以是相对路径。如果路径是一个目录，它将递归复制。在这种情况下，如果路径使用”&#x2F;“来结尾，则只复制目录里的内容，如果没有使用”&#x2F;“来结尾，则包含目录在内的整个内容全部复制，类似于rsync。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm00 ~]# ansible nsxq -m copy -a &quot;src=/etc/hosts dest=/tmp/hosts&quot;</span><br><span class="line">[root@vm00 ~]# ansible test -m copy -a &#x27;src=/etc/fstab dest=/tmp/fstab owner=airmodel group=airmodel mode=644 backup=yes&#x27;</span><br></pre></td></tr></table></figure>
<h1 id="service-模块"><a href="#service-模块" class="headerlink" title="service 模块"></a>service 模块</h1><p>管理服务，该模块包含如下选项：<br>arguments：给命令行提供一些选项<br>enabled：是否开机启动 yes|no<br>name：必选项，服务名称<br>pattern：定义一个模式，如果通过status指令来查看服务的状态时，没有响应，就会通过ps指令在进程中根据该模式进行查找，如果匹配到，则认为该服务依然在运行<br>runlevel：运行级别<br>sleep：如果执行了restarted，在则stop和start之间沉睡几秒钟<br>state：对当前服务执行启动，停止、重启、重新加载等操作（started,stopped,restarted,reloaded）<br>ansible nsxq -m service -a ‘name&#x3D;nginx state&#x3D;started enabled&#x3D;yes’</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm00 ~]# ansible test -m service -a &#x27;name=httpd state=started enabled=yes&#x27;</span><br></pre></td></tr></table></figure>
<h1 id="cron-模块"><a href="#cron-模块" class="headerlink" title="cron 模块"></a>cron 模块</h1><p>用于管理计划任务包含如下选项：<br>backup：对远程主机上的原任务计划内容修改之前做备份<br>cron_file：如果指定该选项，则用该文件替换远程主机上的cron.d目录下的用户的任务计划<br>day：日（1-31，<em>，</em>&#x2F;2,……）<br>hour：小时（0-23，<em>，</em>&#x2F;2，……）<br>minute：分钟（0-59，<em>，</em>&#x2F;2，……）<br>month：月（1-12，<em>，</em>&#x2F;2，……）<br>weekday：周（0-7，*，……）<br>job：要执行的任务，依赖于state&#x3D;present<br>name：该任务的描述<br>special_time：指定什么时候执行，参数：reboot,yearly,annually,monthly,weekly,daily,hourly<br>state：确认该任务计划是创建还是删除<br>user：以哪个用户的身份执行<br>时间不特意指定的话，默认是 * * * * * </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm00 ~]# ansible nsxq -m cron -a &#x27;name=&quot;update ntp time&quot; hour=2 user=root job=&quot;/usr/sbin/ntpdate cn.ntp.org.cn&quot;&#x27;</span><br><span class="line">[root@vm00 ~]# ansible nsxq -m cron -a &#x27;name=&quot;update ntp time&quot; state=absent&#x27;</span><br><span class="line">[root@vm00 ~]# ansible test -m cron -a &quot;name=&#x27;show date&#x27; job=&#x27;/root/test.sh&#x27; backup=&#x27;True&#x27; hour=2 minute=*/5&quot;</span><br></pre></td></tr></table></figure>
<h1 id="yum-模块"><a href="#yum-模块" class="headerlink" title="yum 模块"></a>yum 模块</h1><p>使用yum包管理器来管理软件包，其选项有：<br>config_file：yum的配置文件<br>disable_gpg_check：关闭gpg_check<br>disablerepo：不启用某个源<br>enablerepo：启用某个源<br>name：要进行操作的软件包的名字，也可以传递一个url或者一个本地的rpm包的路径<br>state：状态（present，absent，latest，installed）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm00 ~]# ansible nsxq -m yum -a &#x27;name=httpd state=latest&#x27;</span><br><span class="line">[root@vm00 ~]# ansible nsxq -m yum -a &#x27;name=&quot;@Development Tools&quot; state=present&#x27;</span><br><span class="line">卸载操作</span><br><span class="line">[root@vm00 ~]# ansible test -m yum -a &quot;name=httpd state=absent&quot;</span><br></pre></td></tr></table></figure>
<h1 id="user模块"><a href="#user模块" class="headerlink" title="user模块"></a>user模块</h1><p>user模块是请求的是useradd, userdel, usermod三个指令。</p>
<p>home：指定用户的家目录，需要与createhome配合使用<br>groups：指定用户的属组<br>uid：指定用的uid<br>password：指定用户的密码<br>name：指定用户名<br>createhome：是否创建家目录 yes|no<br>system：是否为系统用户<br>remove：当state&#x3D;absent时，remove&#x3D;yes则表示连同家目录一起删除，等价于userdel -r<br>state：是创建还是删除<br>shell：指定用户的shell环境<br>指定password的时候，需要指定加密后的密码，明文会直接写到&#x2F;etc&#x2F;shadow文件中，用户无法登陆</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm00 ~]# echo &quot;ffffff&quot; | openssl passwd -1 -salt $(&lt; /dev/urandom tr -dc &#x27;[:alnum:]&#x27; | head -c 32) -stdin</span><br><span class="line">[root@vm00 ~]# ansible test -m user -a &#x27;createhome=yes home=/home/user1 password=&quot;$1$01a9gEpb$nlv.OmSa1c4jDaGgeoDKi0&quot; name=user1 state=present shell=/bin/bash&#x27;</span><br><span class="line">[root@vm00 ~]# ansible test -m user -a &#x27;name=user1 state=absent remove=yes&#x27;</span><br></pre></td></tr></table></figure>
<h1 id="group-模块"><a href="#group-模块" class="headerlink" title="group 模块"></a>group 模块</h1><p>goup模块请求的是groupadd, groupdel, groupmod 三个指令。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm00 ~]# ansible test -m group -a &#x27;name=group1 gid=700 state=present&#x27;</span><br></pre></td></tr></table></figure>
<h1 id="synchronize-模块"><a href="#synchronize-模块" class="headerlink" title="synchronize 模块"></a>synchronize 模块</h1><p>使用rsync同步文件，其参数如下：<br>archive: 归档，相当于同时开启recursive(递归)、links、perms、times、owner、group、-D选项都为yes ，默认该项为开启<br>checksum: 跳过检测sum值，默认关闭<br>compress:是否开启压缩<br>copy_links：复制链接文件，默认为no ，注意后面还有一个links参数<br>delete: 删除不存在的文件，默认no<br>dest：目录路径<br>dest_port：默认目录主机上的端口 ，默认是22，走的ssh协议<br>dirs：传速目录不进行递归，默认为no，即进行目录递归<br>rsync_opts：rsync参数部分<br>set_remote_user：主要用于&#x2F;etc&#x2F;ansible&#x2F;hosts中定义或默认使用的用户与rsync使用的用户不同的情况<br>mode: push或pull 模块，缺省模式是push；push模的话，一般用于从本机向远程主机上传文件，push的时候src是本机上的文件或目录; pull 模式用于从远程主机上取文件；pull的时候src是目标主机上的文件或目录<br>目录后边跟&#x2F;表示同步目录下内容，不加&#x2F;把目录同步过去</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm00 ~]# ansible test -m synchronize -a &#x27;src=/etc/hosts dest=/tmp mode=push&#x27;</span><br><span class="line">[root@vm00 ~]# ansible test -m synchronize -a &#x27;src=/etc/fstab dest=/tmp mode=pull&#x27;</span><br></pre></td></tr></table></figure>
<h1 id="filesystem-模块"><a href="#filesystem-模块" class="headerlink" title="filesystem 模块"></a>filesystem 模块</h1><p>在块设备上创建文件系统<br>选项：<br>dev：目标块设备<br>force：在一个已有文件系统 的设备上强制创建<br>fstype：文件系统的类型<br>opts：传递给mkfs命令的选项</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm00 ~]# ansible test -a &#x27;dd if=/dev/zero of=/abc.img bs=4k count=10000&#x27;</span><br><span class="line">[root@vm00 ~]# ansible test -a &#x27;losetup /dev/loop0 /abc.img&#x27;</span><br><span class="line">[root@vm00 ~]# ansible test -m filesystem -a &#x27;fstype=ext4 dev=/dev/loop0 force=yes opts=-F&#x27;</span><br></pre></td></tr></table></figure>
<h1 id="mount-模块"><a href="#mount-模块" class="headerlink" title="mount 模块"></a>mount 模块</h1><p>配置挂载点<br>选项：<br>dump<br>fstype：必选项，挂载文件的类型<br>name：必选项，挂载点<br>opts：传递给mount命令的参数<br>src：必选项，要挂载的文件<br>state：必选项 </p>
<ul>
<li>present：只处理fstab中的配置 </li>
<li>absent：删除挂载点 </li>
<li>mounted：自动创建挂载点并挂载之 </li>
<li>umounted：卸载</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm00 ~]# ansible test -m mount -a &#x27;name=/opt/abc src=/abc.img fstype=ext4 opts=loop state=mounted&#x27;</span><br></pre></td></tr></table></figure>

<p>模块的参数太多了，这篇文章基本上是copy过来的，这里贴一下出处：<a href="http://breezey.blog.51cto.com/2400275/1555530">http://breezey.blog.51cto.com/2400275/1555530</a></p>
]]></content>
      <categories>
        <category>自动化运维</category>
      </categories>
      <tags>
        <tag>运维</tag>
        <tag>自动化</tag>
        <tag>Ansible</tag>
      </tags>
  </entry>
  <entry>
    <title>CentOS6.9环境静默安装Oracle11g</title>
    <url>/arlo/6dacbf16/</url>
    <content><![CDATA[<h1 id="系统基础环境"><a href="#系统基础环境" class="headerlink" title="系统基础环境"></a>系统基础环境</h1><p>操作系统：CentOS 6.9 x64<br>Iptables：off<br>Selinux：disabled</p>
<span id="more"></span>
<h2 id="修改主机名"><a href="#修改主机名" class="headerlink" title="修改主机名"></a>修改主机名</h2><p>安装oracle后不要修改主机名，会引起故障</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/sysconfig/network</span><br><span class="line">NETWORKING=yes</span><br><span class="line">HOSTNAME=&quot;dbserver&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hostname dbserver</span><br></pre></td></tr></table></figure>
<p>添加一条hosts记录，主机名映射</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">127.0.0.1	dbserver</span><br></pre></td></tr></table></figure>
<h2 id="基础软件安装"><a href="#基础软件安装" class="headerlink" title="基础软件安装"></a>基础软件安装</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#默认是不安装32位软件包的，添加此选项</span><br><span class="line">echo &#x27;multilib_policy=all&#x27; &gt;&gt; /etc/yum.conf</span><br><span class="line">yum -y install  binutils-* compat-libstdc++-* elfutils-libelf-*  elfutils-libelf-devel-* gcc-* gcc-c++-* glibc-* glibc-common-* glibc-devel-*  glibc-headers-* ksh-* libaio-*  libaio-devel-* libgcc-*  libstdc++* libstdc++-devel* make-*  sysstat-* unixODBC-* unixODBC-devel-* mksh</span><br><span class="line">#监测一下软件是否安装全</span><br><span class="line">rpm -q \</span><br><span class="line">binutils \</span><br><span class="line">compat-libstdc++-33 \</span><br><span class="line">elfutils-libelf \</span><br><span class="line">elfutils-libelf-devel \</span><br><span class="line">expat \</span><br><span class="line">gcc \</span><br><span class="line">gcc-c++ \</span><br><span class="line">glibc \</span><br><span class="line">glibc-common \</span><br><span class="line">glibc-devel \</span><br><span class="line">glibc-headers \</span><br><span class="line">libaio \</span><br><span class="line">libaio-devel \</span><br><span class="line">libgcc \</span><br><span class="line">libstdc++ \</span><br><span class="line">libstdc++-devel \</span><br><span class="line">make \</span><br><span class="line">pdksh \</span><br><span class="line">sysstat \</span><br><span class="line">unixODBC \</span><br><span class="line">unixODBC-devel | grep &quot;not installed&quot;</span><br></pre></td></tr></table></figure>
<h2 id="修改PAM配置文件"><a href="#修改PAM配置文件" class="headerlink" title="修改PAM配置文件"></a>修改PAM配置文件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/pam.d/login</span><br><span class="line">session    required     /lib64/security/pam_limits.so</span><br><span class="line">session    required     pam_limits.so</span><br></pre></td></tr></table></figure>
<h2 id="修改内核参数"><a href="#修改内核参数" class="headerlink" title="修改内核参数"></a>修改内核参数</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/sysctl.conf</span><br><span class="line">fs.aio-max-nr = 1048576 </span><br><span class="line">fs.file-max = 6815744 </span><br><span class="line">kernel.shmmni = 4096 </span><br><span class="line">kernel.sem = 250 32000 100 128 </span><br><span class="line">net.ipv4.ip_local_port_range = 9000 65500 </span><br><span class="line">net.core.rmem_default = 262144 </span><br><span class="line">net.core.rmem_max = 4194304 </span><br><span class="line">net.core.wmem_default = 262144 </span><br><span class="line">net.core.wmem_max = 1048586</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#重新加载生效</span><br><span class="line">sysctl –p</span><br></pre></td></tr></table></figure>
<h2 id="修改系统资源限制"><a href="#修改系统资源限制" class="headerlink" title="修改系统资源限制"></a>修改系统资源限制</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/security/limits.conf  </span><br><span class="line">oracle  soft  nproc   2047 </span><br><span class="line">oracle  hard  nproc   16384 </span><br><span class="line">oracle  soft  nofile  1024 </span><br><span class="line">oracle  hard  nofile  65536</span><br><span class="line">oracle	soft  stack   10240</span><br></pre></td></tr></table></figure>

<h1 id="Oracle相关环境配置"><a href="#Oracle相关环境配置" class="headerlink" title="Oracle相关环境配置"></a>Oracle相关环境配置</h1><h2 id="新建用户"><a href="#新建用户" class="headerlink" title="新建用户"></a>新建用户</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">groupadd -g 500 oinstall</span><br><span class="line">groupadd -g 501 dba</span><br><span class="line">useradd -u 500 -g oinstall -G dba oracle</span><br><span class="line">#设置oracle用户密码为oracle</span><br><span class="line">echo &quot;oracle:oracle&quot; | chpasswd</span><br></pre></td></tr></table></figure>
<h2 id="修改用户配置文件"><a href="#修改用户配置文件" class="headerlink" title="修改用户配置文件"></a>修改用户配置文件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/profile</span><br><span class="line">if [ $USER = &quot;oracle&quot; ]; then</span><br><span class="line">   if [ $SHELL = &quot;/bin/ksh&quot; ]; then</span><br><span class="line">       ulimit -p 16384</span><br><span class="line">       ulimit -n 65536</span><br><span class="line">   else</span><br><span class="line">       ulimit -u 16384 -n 65536</span><br><span class="line">   fi</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<h2 id="新建目录并设置权限"><a href="#新建目录并设置权限" class="headerlink" title="新建目录并设置权限"></a>新建目录并设置权限</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir -p /u01/app/oracle/product/11.2.0/db_1</span><br><span class="line">mkdir -p /u01/app/oraInventory</span><br><span class="line">chown -R oracle.oinstall /u01/app/oracle</span><br><span class="line">chown -R oracle.oinstall /u01/app/oraInventory</span><br><span class="line">chmod -R 775 /u01/app</span><br></pre></td></tr></table></figure>
<h2 id="设置oracle用户环境变量"><a href="#设置oracle用户环境变量" class="headerlink" title="设置oracle用户环境变量"></a>设置oracle用户环境变量</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">su - oracle</span><br><span class="line">$ vim ~/.bash_profile </span><br><span class="line">export ORACLE_BASE=/u01/app/oracle</span><br><span class="line">export ORACLE_HOME=$ORACLE_BASE/product/11.2.0/db_1</span><br><span class="line">export ORACLE_SID=sx21</span><br><span class="line">export PATH=$PATH:$ORACLE_HOME/bin</span><br><span class="line">export LD_LIBRARY_PATH=$ORACLE_HOME/lib:/lib:/usr/lib</span><br><span class="line">export NLS_LANG=American_America.ZHS16GBK</span><br></pre></td></tr></table></figure>
<h2 id="检查环境变量是否生效"><a href="#检查环境变量是否生效" class="headerlink" title="检查环境变量是否生效"></a>检查环境变量是否生效</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">source ~/.bash_profile</span><br><span class="line">env |grep ORA</span><br><span class="line">ORACLE_SID=sx21</span><br><span class="line">ORACLE_BASE=/u01/app/oracle</span><br><span class="line">ORACLE_HOME=/u01/app/oracle/product/11.2.0/db_1</span><br></pre></td></tr></table></figure>
<h2 id="准备软件安装包"><a href="#准备软件安装包" class="headerlink" title="准备软件安装包"></a>准备软件安装包</h2><p>下载地址: <a href="http://www.oracle.com/technetwork/database/enterprise-edition/downloads/112010-linx8664soft-100572.html">http://www.oracle.com/technetwork/database/enterprise-edition/downloads/112010-linx8664soft-100572.html</a><br>可以使用cksum校验文件完整性<br>linux.x64_11gR2_database_1of2.zip (1,239,269,270 bytes) (cksum - 3152418844)<br>linux.x64_11gR2_database_2of2.zip (1,111,416,131 bytes) (cksum - 3669256139)</p>
<h2 id="解压软件包"><a href="#解压软件包" class="headerlink" title="解压软件包"></a>解压软件包</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">unzip linux.x64_11gR2_database_1of2.zip</span><br><span class="line">unzip linux.x64_11gR2_database_2of2.zip</span><br></pre></td></tr></table></figure>
<p>解压后得到&#x2F;home&#x2F;oracle&#x2F;database&#x2F;response目录，该目录中有三个rsp文件，用来作为静默安装时的应答文件的模板。<br>备份三个文件并修改其内容</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">db_install.rsp	安装应答</span><br><span class="line">netca.rsp	建立监听、本地服务名等网络设置的应答</span><br><span class="line">dbca.rsp	创建数据库应答</span><br></pre></td></tr></table></figure>
<h1 id="静默安装数据库软件"><a href="#静默安装数据库软件" class="headerlink" title="静默安装数据库软件"></a>静默安装数据库软件</h1><h2 id="修改db-install-rsp-文件"><a href="#修改db-install-rsp-文件" class="headerlink" title="修改db_install.rsp 文件"></a>修改db_install.rsp 文件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">egrep -v &quot;^#|^$&quot; db_install.rsp</span><br><span class="line">oracle.install.responseFileVersion=/oracle/install/rspfmt_dbinstall_response_schema_v11_2_0</span><br><span class="line">oracle.install.option=INSTALL_DB_SWONLY</span><br><span class="line">ORACLE_HOSTNAME=dbserver</span><br><span class="line">UNIX_GROUP_NAME=oinstall</span><br><span class="line">INVENTORY_LOCATION=/u01/app/oraInventory</span><br><span class="line">SELECTED_LANGUAGES=en,zh_CN</span><br><span class="line">ORACLE_HOME=/u01/app/oracle/product/11.2.0/db_1</span><br><span class="line">ORACLE_BASE=/u01/app/oracle/</span><br><span class="line">oracle.install.db.InstallEdition=EE</span><br><span class="line">oracle.install.db.EEOptionsSelection=false</span><br><span class="line">oracle.install.db.optionalComponents=oracle.rdbms.partitioning:11.2.0.4.0,oracle.oraolap:11.2.0.4.0,oracle.rdbms.dm:11.2.0.4.0,oracle.rdbms.dv:11.2.0.4.0,oracle.rdbms.lbac:11.2.0.4.0,oracle.rdbms.rat:11.2.0.4.0</span><br><span class="line">oracle.install.db.DBA_GROUP=dba</span><br><span class="line">oracle.install.db.OPER_GROUP=dba</span><br><span class="line">oracle.install.db.CLUSTER_NODES=</span><br><span class="line">oracle.install.db.isRACOneInstall=</span><br><span class="line">oracle.install.db.racOneServiceName=</span><br><span class="line">oracle.install.db.config.starterdb.type=</span><br><span class="line">oracle.install.db.config.starterdb.globalDBName=orcl</span><br><span class="line">oracle.install.db.config.starterdb.SID=orcl</span><br><span class="line">oracle.install.db.config.starterdb.characterSet=ZHS16GBK</span><br><span class="line">oracle.install.db.config.starterdb.memoryOption=true</span><br><span class="line">oracle.install.db.config.starterdb.memoryLimit=81920</span><br><span class="line">oracle.install.db.config.starterdb.installExampleSchemas=false</span><br><span class="line">oracle.install.db.config.starterdb.enableSecuritySettings=true</span><br><span class="line">oracle.install.db.config.starterdb.password.ALL=solution#123$$</span><br><span class="line">oracle.install.db.config.starterdb.password.SYS=</span><br><span class="line">oracle.install.db.config.starterdb.password.SYSTEM=</span><br><span class="line">oracle.install.db.config.starterdb.password.SYSMAN=</span><br><span class="line">oracle.install.db.config.starterdb.password.DBSNMP=</span><br><span class="line">oracle.install.db.config.starterdb.control=DB_CONTROL</span><br><span class="line">oracle.install.db.config.starterdb.gridcontrol.gridControlServiceURL=</span><br><span class="line">oracle.install.db.config.starterdb.automatedBackup.enable=false</span><br><span class="line">oracle.install.db.config.starterdb.automatedBackup.osuid=</span><br><span class="line">oracle.install.db.config.starterdb.automatedBackup.ospwd=</span><br><span class="line">oracle.install.db.config.starterdb.storageType=</span><br><span class="line">oracle.install.db.config.starterdb.fileSystemStorage.dataLocation=</span><br><span class="line">oracle.install.db.config.starterdb.fileSystemStorage.recoveryLocation=</span><br><span class="line">oracle.install.db.config.asm.diskGroup=</span><br><span class="line">oracle.install.db.config.asm.ASMSNMPPassword=</span><br><span class="line">MYORACLESUPPORT_USERNAME=</span><br><span class="line">MYORACLESUPPORT_PASSWORD=</span><br><span class="line">SECURITY_UPDATES_VIA_MYORACLESUPPORT=</span><br><span class="line">DECLINE_SECURITY_UPDATES=true</span><br><span class="line">PROXY_HOST=</span><br><span class="line">PROXY_PORT=</span><br><span class="line">PROXY_USER=</span><br><span class="line">PROXY_PWD=</span><br><span class="line">PROXY_REALM=</span><br><span class="line">COLLECTOR_SUPPORTHUB_URL=</span><br><span class="line">oracle.installer.autoupdates.option=</span><br><span class="line">oracle.installer.autoupdates.downloadUpdatesLoc=</span><br><span class="line">AUTOUPDATES_MYORACLESUPPORT_USERNAME=</span><br><span class="line">AUTOUPDATES_MYORACLESUPPORT_PASSWORD=</span><br></pre></td></tr></table></figure>
<h2 id="执行静默安装"><a href="#执行静默安装" class="headerlink" title="执行静默安装"></a>执行静默安装</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ pwd</span><br><span class="line">/home/oracle/database</span><br><span class="line">./runInstaller -silent -ignorePrereq -ignoreSysPrereqs -responseFile /home/oracle/database/response/db_install.rsp</span><br><span class="line"></span><br><span class="line">Starting Oracle Universal Installer...</span><br><span class="line"></span><br><span class="line">Checking Temp space: must be greater than 120 MB.   Actual 26363 MB    Passed</span><br><span class="line">Checking swap space: must be greater than 150 MB.   Actual 4095 MB    Passed</span><br><span class="line">Preparing to launch Oracle Universal Installer from /tmp/OraInstall2017-12-27_02-06-55PM. Please wait ...[oracle@dbserver database]$ You can find the log of this install session at:</span><br><span class="line"> /u01/app/oraInventory/logs/installActions2017-12-27_02-06-55PM.log</span><br></pre></td></tr></table></figure>
<p>安装过程中可以另开一个窗口跟踪查看日志</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tailf /u01/app/oraInventory/logs/installActions2017-12-27_02-06-55PM.log</span><br><span class="line"></span><br><span class="line">……</span><br><span class="line"></span><br><span class="line">INFO: Completed validating state &lt;finish&gt;</span><br><span class="line">INFO: Terminating all background operations</span><br><span class="line">INFO: Terminated all background operations</span><br><span class="line">INFO: Successfully executed the flow in SILENT mode</span><br><span class="line">INFO: Finding the most appropriate exit status for the current application</span><br><span class="line">INFO: Exit Status is 0</span><br><span class="line">INFO: Shutdown Oracle Database 11g Release 2 Installer</span><br><span class="line">INFO: Unloading Setup Driver</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"> #!/bin/sh </span><br><span class="line"> #Root scripts to run</span><br><span class="line"></span><br><span class="line">/u01/app/oraInventory/orainstRoot.sh</span><br><span class="line">/u01/app/oracle/product/11.2.0/db_1/root.sh</span><br><span class="line">To execute the configuration scripts:</span><br><span class="line">	 1. Open a terminal window </span><br><span class="line">	 2. Log in as &quot;root&quot; </span><br><span class="line">	 3. Run the scripts </span><br><span class="line">	 4. Return to this window and hit &quot;Enter&quot; key to continue </span><br><span class="line"></span><br><span class="line">Successfully Setup Software.</span><br></pre></td></tr></table></figure>
<p>一直到主窗口出现以上提示，以root用户打开一个窗口，一次执行下面操作</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@dbserver ~]# /u01/app/oraInventory/orainstRoot.sh</span><br><span class="line">Changing permissions of /u01/app/oraInventory.</span><br><span class="line">Adding read,write permissions for group.</span><br><span class="line">Removing read,write,execute permissions for world.</span><br><span class="line"></span><br><span class="line">Changing groupname of /u01/app/oraInventory to oinstall.</span><br><span class="line">The execution of the script is complete.</span><br><span class="line">[root@dbserver ~]# /u01/app/oracle/product/11.2.0/db_1/root.sh</span><br><span class="line">Check /u01/app/oracle/product/11.2.0/db_1/install/root_dbserver_2017-12-27_14-23-43.log for the output of root script</span><br></pre></td></tr></table></figure>
<h1 id="静默安装监听"><a href="#静默安装监听" class="headerlink" title="静默安装监听"></a>静默安装监听</h1><p>使用默认配置文件，不用修改</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ORACLE_HOME/bin/netca /silent /responseFile /home/oracle/database/response/netca.rsp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Parsing command line arguments:</span><br><span class="line">    Parameter &quot;silent&quot; = true</span><br><span class="line">    Parameter &quot;responsefile&quot; = /home/oracle/database/response/netca.rsp</span><br><span class="line">Done parsing command line arguments.</span><br><span class="line">Oracle Net Services Configuration:</span><br><span class="line">Profile configuration complete.</span><br><span class="line">Oracle Net Listener Startup:</span><br><span class="line">    Running Listener Control: </span><br><span class="line">      /u01/app/oracle/product/11.2.0/db_1/bin/lsnrctl start LISTENER</span><br><span class="line">    Listener Control complete.</span><br><span class="line">    Listener started successfully.</span><br><span class="line">Listener configuration complete.</span><br><span class="line">Oracle Net Services configuration successful. The exit code is 0</span><br></pre></td></tr></table></figure>
<p>默认监听是开启状态</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[oracle@dbserver database]$ lsnrctl status</span><br><span class="line"></span><br><span class="line">LSNRCTL for Linux: Version 11.2.0.1.0 - Production on 27-DEC-2017 14:26:34</span><br><span class="line"></span><br><span class="line">Copyright (c) 1991, 2009, Oracle.  All rights reserved.</span><br><span class="line"></span><br><span class="line">Connecting to (DESCRIPTION=(ADDRESS=(PROTOCOL=IPC)(KEY=EXTPROC1521)))</span><br><span class="line">STATUS of the LISTENER</span><br><span class="line">------------------------</span><br><span class="line">Alias                     LISTENER</span><br><span class="line">Version                   TNSLSNR for Linux: Version 11.2.0.1.0 - Production</span><br><span class="line">Start Date                27-DEC-2017 14:25:48</span><br><span class="line">Uptime                    0 days 0 hr. 0 min. 50 sec</span><br><span class="line">Trace Level               off</span><br><span class="line">Security                  ON: Local OS Authentication</span><br><span class="line">SNMP                      OFF</span><br><span class="line">Listener Parameter File   /u01/app/oracle/product/11.2.0/db_1/network/admin/listener.ora</span><br><span class="line">Listener Log File         /u01/app/oracle/diag/tnslsnr/dbserver/listener/alert/log.xml</span><br><span class="line">Listening Endpoints Summary...</span><br><span class="line">  (DESCRIPTION=(ADDRESS=(PROTOCOL=ipc)(KEY=EXTPROC1521)))</span><br><span class="line">  (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=dbserver)(PORT=1521)))</span><br><span class="line">The listener supports no services</span><br><span class="line">The command completed successfully</span><br></pre></td></tr></table></figure>
<h1 id="静默新建实例"><a href="#静默新建实例" class="headerlink" title="静默新建实例"></a>静默新建实例</h1><h2 id="修改dbca-rsp配置"><a href="#修改dbca-rsp配置" class="headerlink" title="修改dbca.rsp配置"></a>修改dbca.rsp配置</h2><p>这里只需要修改[CREATEDATABASE]部分即可，其他的保持默认</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ egrep -v &quot;^#|^$&quot; dbca.rsp </span><br><span class="line">[GENERAL]</span><br><span class="line">RESPONSEFILE_VERSION = &quot;11.2.0&quot;</span><br><span class="line">OPERATION_TYPE = &quot;createDatabase&quot;</span><br><span class="line">[CREATEDATABASE]</span><br><span class="line">GDBNAME = &quot;sx21&quot;</span><br><span class="line">SID = &quot;sx21&quot;</span><br><span class="line">TEMPLATENAME = &quot;General_Purpose.dbc&quot;</span><br><span class="line">SYSPASSWORD = &quot;solution#123&quot;</span><br><span class="line">SYSTEMPASSWORD = &quot;solution#123&quot;</span><br><span class="line">CHARACTERSET = &quot;ZHS16GBK&quot;</span><br><span class="line">NATIONALCHARACTERSET= &quot;AL16UTF16&quot;</span><br><span class="line">[createTemplateFromDB]</span><br><span class="line">SOURCEDB = &quot;myhost:1521:orcl&quot;</span><br><span class="line">SYSDBAUSERNAME = &quot;system&quot;</span><br><span class="line">TEMPLATENAME = &quot;My Copy TEMPLATE&quot;</span><br><span class="line">[createCloneTemplate]</span><br><span class="line">SOURCEDB = &quot;orcl&quot;</span><br><span class="line">TEMPLATENAME = &quot;My Clone TEMPLATE&quot;</span><br><span class="line">[DELETEDATABASE]</span><br><span class="line">SOURCEDB = &quot;orcl&quot;</span><br><span class="line">[generateScripts]</span><br><span class="line">TEMPLATENAME = &quot;New Database&quot;</span><br><span class="line">GDBNAME = &quot;orcl11.us.oracle.com&quot;</span><br><span class="line">[CONFIGUREDATABASE]</span><br><span class="line">[ADDINSTANCE]</span><br><span class="line">DB_UNIQUE_NAME = &quot;orcl11g.us.oracle.com&quot;</span><br><span class="line">NODELIST=</span><br><span class="line">SYSDBAUSERNAME = &quot;sys&quot;</span><br><span class="line">[DELETEINSTANCE]</span><br><span class="line">DB_UNIQUE_NAME = &quot;orcl11g.us.oracle.com&quot;</span><br><span class="line">INSTANCENAME = &quot;orcl11g&quot;</span><br><span class="line">SYSDBAUSERNAME = &quot;sys&quot;</span><br></pre></td></tr></table></figure>
<h2 id="执行静默安装-1"><a href="#执行静默安装-1" class="headerlink" title="执行静默安装"></a>执行静默安装</h2><p>不清楚是什么原因，我执行静默安装命令，屏幕就一直闪烁，不能输入密码，所以我将密码写到dbca.rsp文件中了，可以避免此问题！</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ORACLE_HOME/bin/dbca -silent -responseFile /home/oracle/database/response/dbca.rsp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Copying database files</span><br><span class="line">1% complete</span><br><span class="line">2% complete</span><br><span class="line">4% complete</span><br><span class="line">37% complete</span><br><span class="line">Creating and starting Oracle instance</span><br><span class="line">38% complete</span><br><span class="line">40% complete</span><br><span class="line">45% complete</span><br><span class="line">50% complete</span><br><span class="line">51% complete</span><br><span class="line">56% complete</span><br><span class="line">57% complete</span><br><span class="line">61% complete</span><br><span class="line">62% complete</span><br><span class="line">Completing Database Creation</span><br><span class="line">66% complete</span><br><span class="line">70% complete</span><br><span class="line">73% complete</span><br><span class="line">74% complete</span><br><span class="line">85% complete</span><br><span class="line">86% complete</span><br><span class="line">98% complete</span><br><span class="line">100% complete</span><br><span class="line">Look at the log file &quot;/u01/app/oracle/cfgtoollogs/dbca/sx21/sx21.log&quot; for further details.</span><br></pre></td></tr></table></figure>
<h1 id="验证安装结果"><a href="#验证安装结果" class="headerlink" title="验证安装结果"></a>验证安装结果</h1><h2 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[oracle@dbserver app]$ ps -ef |grep ora_</span><br><span class="line">oracle    5432     1  0 17:02 ?        00:00:00 ora_pmon_sx21</span><br><span class="line">oracle    5434     1  0 17:02 ?        00:00:00 ora_vktm_sx21</span><br><span class="line">oracle    5438     1  0 17:02 ?        00:00:00 ora_gen0_sx21</span><br><span class="line">oracle    5440     1  0 17:02 ?        00:00:00 ora_diag_sx21</span><br><span class="line">oracle    5442     1  0 17:02 ?        00:00:00 ora_dbrm_sx21</span><br><span class="line">oracle    5444     1  0 17:02 ?        00:00:00 ora_psp0_sx21</span><br><span class="line">oracle    5446     1  0 17:02 ?        00:00:00 ora_dia0_sx21</span><br><span class="line">oracle    5448     1  0 17:02 ?        00:00:01 ora_mman_sx21</span><br><span class="line">oracle    5450     1  0 17:02 ?        00:00:00 ora_dbw0_sx21</span><br><span class="line">oracle    5452     1  0 17:02 ?        00:00:00 ora_lgwr_sx21</span><br><span class="line">oracle    5454     1  0 17:02 ?        00:00:00 ora_ckpt_sx21</span><br><span class="line">oracle    5456     1  0 17:02 ?        00:00:00 ora_smon_sx21</span><br><span class="line">oracle    5458     1  0 17:02 ?        00:00:00 ora_reco_sx21</span><br><span class="line">oracle    5460     1  0 17:02 ?        00:00:00 ora_mmon_sx21</span><br><span class="line">oracle    5462     1  0 17:02 ?        00:00:00 ora_mmnl_sx21</span><br><span class="line">oracle    5464     1  0 17:02 ?        00:00:00 ora_d000_sx21</span><br><span class="line">oracle    5466     1  0 17:02 ?        00:00:00 ora_s000_sx21</span><br><span class="line">oracle    5558     1  0 17:02 ?        00:00:00 ora_qmnc_sx21</span><br><span class="line">oracle    5575     1  0 17:02 ?        00:00:00 ora_cjq0_sx21</span><br><span class="line">oracle    5579     1  0 17:02 ?        00:00:00 ora_q000_sx21</span><br><span class="line">oracle    5581     1  0 17:02 ?        00:00:00 ora_q001_sx21</span><br><span class="line">oracle    5585  1550  0 17:04 pts/0    00:00:00 grep ora_</span><br></pre></td></tr></table></figure>
<h2 id="监听"><a href="#监听" class="headerlink" title="监听"></a>监听</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[oracle@dbserver app]$ lsnrctl status</span><br><span class="line"></span><br><span class="line">LSNRCTL for Linux: Version 11.2.0.1.0 - Production on 27-DEC-2017 17:04:44</span><br><span class="line"></span><br><span class="line">Copyright (c) 1991, 2009, Oracle.  All rights reserved.</span><br><span class="line"></span><br><span class="line">Connecting to (DESCRIPTION=(ADDRESS=(PROTOCOL=IPC)(KEY=EXTPROC1521)))</span><br><span class="line">STATUS of the LISTENER</span><br><span class="line">------------------------</span><br><span class="line">Alias                     LISTENER</span><br><span class="line">Version                   TNSLSNR for Linux: Version 11.2.0.1.0 - Production</span><br><span class="line">Start Date                27-DEC-2017 16:49:14</span><br><span class="line">Uptime                    0 days 0 hr. 15 min. 32 sec</span><br><span class="line">Trace Level               off</span><br><span class="line">Security                  ON: Local OS Authentication</span><br><span class="line">SNMP                      OFF</span><br><span class="line">Listener Parameter File   /u01/app/oracle/product/11.2.0/db_1/network/admin/listener.ora</span><br><span class="line">Listener Log File         /u01/app/oracle/diag/tnslsnr/dbserver/listener/alert/log.xml</span><br><span class="line">Listening Endpoints Summary...</span><br><span class="line">  (DESCRIPTION=(ADDRESS=(PROTOCOL=ipc)(KEY=EXTPROC1521)))</span><br><span class="line">  (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=dbserver)(PORT=1521)))</span><br><span class="line">Services Summary...</span><br><span class="line">Service &quot;sx21&quot; has 1 instance(s).</span><br><span class="line">  Instance &quot;sx21&quot;, status READY, has 1 handler(s) for this service...</span><br><span class="line">Service &quot;sx21XDB&quot; has 1 instance(s).</span><br><span class="line">  Instance &quot;sx21&quot;, status READY, has 1 handler(s) for this service...</span><br><span class="line">The command completed successfully</span><br></pre></td></tr></table></figure>
<h2 id="连接"><a href="#连接" class="headerlink" title="连接"></a>连接</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[oracle@dbserver app]$ sqlplus /nolog</span><br><span class="line"></span><br><span class="line">SQL*Plus: Release 11.2.0.1.0 Production on Wed Dec 27 17:05:57 2017</span><br><span class="line"></span><br><span class="line">Copyright (c) 1982, 2009, Oracle.  All rights reserved.</span><br><span class="line"></span><br><span class="line">SQL&gt; conn /as sysdba</span><br><span class="line">Connected.</span><br><span class="line">SQL&gt; shutdown immediate</span><br><span class="line">Database closed.</span><br><span class="line">Database dismounted.</span><br><span class="line">ORACLE instance shut down.</span><br><span class="line">SQL&gt; startup</span><br><span class="line">ORACLE instance started.</span><br><span class="line"></span><br><span class="line">Total System Global Area 3340451840 bytes</span><br><span class="line">Fixed Size		    2217952 bytes</span><br><span class="line">Variable Size		 1811941408 bytes</span><br><span class="line">Database Buffers	 1509949440 bytes</span><br><span class="line">Redo Buffers		   16343040 bytes</span><br><span class="line">Database mounted.</span><br><span class="line">Database opened.</span><br></pre></td></tr></table></figure>
<h2 id="静默删除数据库实例"><a href="#静默删除数据库实例" class="headerlink" title="静默删除数据库实例"></a>静默删除数据库实例</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dbca -silent -deleteDatabase -sourcedb orcl -sid orcl -sysDBAUserName sys -sysDBAPassword password</span><br></pre></td></tr></table></figure>
<h1 id="扩展配置"><a href="#扩展配置" class="headerlink" title="扩展配置"></a>扩展配置</h1><p>由于默认审计日志默认是开启状态，长时间使用后会早上SYSTEM表空间撑爆，磁盘占用率高，建议关闭<br>sqlplus &#x2F; as sysdba</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SQL&gt; show parameter audit_trail</span><br><span class="line">SQL&gt; alter system set audit_trail=none scope=spfile;</span><br><span class="line">SQL&gt; shutdown immediate;</span><br><span class="line">SQL&gt; startup</span><br></pre></td></tr></table></figure>
<h1 id="错误解析"><a href="#错误解析" class="headerlink" title="错误解析"></a>错误解析</h1><h2 id="WARNING-My-Oracle-Support-Username-x2F-Email-Address-Not-Specified"><a href="#WARNING-My-Oracle-Support-Username-x2F-Email-Address-Not-Specified" class="headerlink" title="[WARNING] - My Oracle Support Username&#x2F;Email Address Not Specified"></a>[WARNING] - My Oracle Support Username&#x2F;Email Address Not Specified</h2><p><code>DECLINE_SECURITY_UPDATES=true </code></p>
<h2 id="FATAL-INS-10101-The-given-response-file-response-x2F-db-install-rsp-is-not-found"><a href="#FATAL-INS-10101-The-given-response-file-response-x2F-db-install-rsp-is-not-found" class="headerlink" title="[FATAL] [INS-10101] The given response file response&#x2F;db_install.rsp is not found."></a>[FATAL] [INS-10101] The given response file response&#x2F;db_install.rsp is not found.</h2><p><code>响应文件写为绝对路径/usr/local/src/oracle/database/response/db_install.rsp</code></p>
<h2 id="FATAL-INS-00001-Unknown-irrecoverable-error"><a href="#FATAL-INS-00001-Unknown-irrecoverable-error" class="headerlink" title="[FATAL] [INS-00001] Unknown irrecoverable error"></a>[FATAL] [INS-00001] Unknown irrecoverable error</h2><p><code>设置的密码中不能有%</code></p>
<h1 id="常用语句"><a href="#常用语句" class="headerlink" title="常用语句"></a>常用语句</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">--创建表空间</span><br><span class="line">CREATE TABLESPACE TS_TENV datafile &#x27;/u01/app/oracle/oradata/monitor/ts_tenv01.dbf&#x27; SIZE 200m AUTOEXTEND ON NEXT 32m MAXSIZE 32767M EXTENT MANAGEMENT LOCAL;</span><br><span class="line">CREATE TABLESPACE TS_WEATHER datafile &#x27;/u01/app/oracle/oradata/monitor/ts_weather01.dbf&#x27; SIZE 200m AUTOEXTEND ON NEXT 32m MAXSIZE 32767M EXTENT MANAGEMENT LOCAL;</span><br><span class="line"></span><br><span class="line">--创建临时表空间</span><br><span class="line">CREATE TEMPORARY TABLESPACE TS_TENV_TEMP TEMPFILE &#x27;/u01/app/oracle/oradata/monitor/ts_tenv_temp01.dbf&#x27; SIZE 200m AUTOEXTEND ON NEXT 32m MAXSIZE 2048m EXTENT MANAGEMENT LOCAL;</span><br><span class="line">CREATE TEMPORARY TABLESPACE TS_WEATHER_TEMP TEMPFILE &#x27;/u01/app/oracle/oradata/monitor/ts_weather_temp01.dbf&#x27; SIZE 200m AUTOEXTEND ON NEXT 32m MAXSIZE 2048m EXTENT MANAGEMENT LOCAL;</span><br><span class="line"></span><br><span class="line">创建用户指定默认表空间</span><br><span class="line">--新建用户</span><br><span class="line">CREATE USER TENV IDENTIFIED BY tenv#123 DEFAULT TABLESPACE TS_TENV TEMPORARY TABLESPACE TS_TENV;</span><br><span class="line">CREATE USER WEATHER IDENTIFIED BY weather#123 DEFAULT TABLESPACE TS_WEATHER TEMPORARY TABLESPACE TS_WEATHER;</span><br><span class="line"></span><br><span class="line">--如果先新建用户了，使用以下命令修改默认表空间</span><br><span class="line">alter user TENV default tablespace TS_TENV;</span><br><span class="line">alter user WEATHER default tablespace TS_WEATHER;</span><br><span class="line">--授权连接权限</span><br><span class="line">GRANT CONNECT TO TENV; </span><br><span class="line">GRANT CONNECT TO WEATHER; </span><br><span class="line">--授权表空间</span><br><span class="line">GRANT UNLIMITED TABLESPACE TO TENV;</span><br><span class="line">GRANT UNLIMITED TABLESPACE TO WEATHER;</span><br><span class="line"></span><br><span class="line">--修改密码有效期为永久</span><br><span class="line">ALTER PROFILE DEFAULT LIMIT PASSWORD_LIFE_TIME UNLIMITED ;</span><br><span class="line">SELECT * FROM dba_profiles WHERE profile=&#x27;DEFAULT&#x27; AND resource_name=&#x27;PASSWORD_LIFE_TIME&#x27;;</span><br><span class="line">--解锁账号</span><br><span class="line">alter user 用户名 identified by 原密码;</span><br><span class="line">alter user db_user account unlock;</span><br><span class="line">--查看每个用户连接数</span><br><span class="line">select username,count(username) from v$session where username is not null group by username;</span><br><span class="line">--修改最大连接数</span><br><span class="line">1. 查看最大连接数</span><br><span class="line">show parameter processes</span><br><span class="line">2. 修改最大连接数</span><br><span class="line">alter system set processes = 1500 scope = spfile;</span><br><span class="line">3. 重启数据库</span><br><span class="line">shutdown immediate;  </span><br><span class="line">startup;</span><br></pre></td></tr></table></figure>

<p>参考文档：<br><a href="https://www.jianshu.com/p/b4200e721bfd">https://www.jianshu.com/p/b4200e721bfd</a><br><a href="http://blog.51cto.com/wzlinux/1710941">http://blog.51cto.com/wzlinux/1710941</a></p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>Oracle</tag>
        <tag>数据库</tag>
      </tags>
  </entry>
  <entry>
    <title>Centos 7下KVM 虚拟机搭建</title>
    <url>/arlo/8ae03ce9/</url>
    <content><![CDATA[<p>KVM（Kernel-based Virtual Machine）是支持虚拟化扩展（Intel VT 或 AMD-V技术）x86硬件的Linux完全虚拟化解决方案。它包括了一个可加载的内核模块kvm.ko，提供了核心的虚拟化架构以及一个处理器特定模块（kvm-intel.ko或kvm-amd.ko）。<br>使用KVM，用户可以运行多个无需修改的Linux或Windows虚拟机。每个虚拟机有自己私有的虚拟硬件：网卡、磁盘、显卡等等。</p>
<span id="more"></span>

<p><strong>系统化境</strong><br>iptables off<br>selinux disabled</p>
<h1 id="安装kvm虚拟化"><a href="#安装kvm虚拟化" class="headerlink" title="安装kvm虚拟化"></a>安装kvm虚拟化</h1><p>查看cpu是否支持全虚拟化</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">grep -E &#x27;(vmx|svm)&#x27; /proc/cpuinfo</span><br></pre></td></tr></table></figure>
<p>安装虚拟化组件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum install qemu-kvm qemu-img virt-manager libvirt libvirt-python libvirt-client virt-install virt-viewer bridge-utils</span><br></pre></td></tr></table></figure>
<p>启动并设置开机自启动虚拟化服务</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl start libvirtd</span><br><span class="line">systemctl enable libvirtd</span><br></pre></td></tr></table></figure>
<p>检查虚拟化模块是否加载</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">lsmod | grep kvm</span><br></pre></td></tr></table></figure>
<p>安装图形界面</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum -y groupinstall &quot;GNOME Desktop&quot;</span><br></pre></td></tr></table></figure>
<p>图形化管理工具</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">virt-manager</span><br></pre></td></tr></table></figure>
<h1 id="配置桥接网络"><a href="#配置桥接网络" class="headerlink" title="配置桥接网络"></a>配置桥接网络</h1><p>拷贝一个br0网络配置文件<br>cd &#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;<br>cp ifcfg-em1 ifcfg-br0<br>配置ifcfg-em1</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">TYPE=Ethernet</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">DEVICE=em1</span><br><span class="line">ONBOOT=yes</span><br><span class="line">BRIDGE=br0</span><br></pre></td></tr></table></figure>
<p>配置ifcfg-br0</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">TYPE=Bridge</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">DEVICE=br0</span><br><span class="line">ONBOOT=yes</span><br><span class="line">IPADDR=192.168.6.122</span><br><span class="line">NETMASK=255.255.255.0</span><br><span class="line">GATEWAY=192.168.6.1</span><br><span class="line">DNS1=223.5.5.5</span><br></pre></td></tr></table></figure>
<p>重启网络</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl restart network</span><br></pre></td></tr></table></figure>
<p>查看br0状态</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ip addr show br0</span><br><span class="line">brctl show</span><br></pre></td></tr></table></figure>
<h1 id="创建一个存储池"><a href="#创建一个存储池" class="headerlink" title="创建一个存储池"></a>创建一个存储池</h1><p>centos7操作系统安装的时候，自动分区时，大部分空间划分给&#x2F;home分区了，默认的存储在&#x2F;var&#x2F;lib&#x2F;libvirt&#x2F;images目录下，在创建虚拟机之前我需要创建一个存储池；规划在&#x2F;home&#x2F;kvm&#x2F;images 目录下<br>新建目录并设置权限</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir -p /home/kvm/images;chown root:root /home/kvm/images;chmod 755 /home/kvm/images;</span><br></pre></td></tr></table></figure>
<p>创建存储池</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#定义一个存储池绑定目录</span><br><span class="line"></span><br><span class="line">virsh pool-define-as StoragePool --type dir --target /home/kvm/images;</span><br><span class="line">#建立基于文件夹的存储池</span><br><span class="line">virsh pool-build StoragePool;</span><br><span class="line">#激活StoragePool</span><br><span class="line">virsh pool-start StoragePool;</span><br><span class="line">#存储池开机自动运行,使用virsh pool-autostart</span><br><span class="line">virsh pool-autostart StoragePool;</span><br><span class="line">#查看存储池的信息</span><br><span class="line">virsh pool-info StoragePool</span><br><span class="line">#查看创建的所有存储池</span><br><span class="line">virsh pool-list</span><br></pre></td></tr></table></figure>
<p>创建一个数据卷</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">virsh vol-create-as --pool StoragePool --name sql_server_2012.qcow2 100G --format qcow2</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>查看存储卷信息</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">virsh vol-info --pool StoragePool sql_server_2012.qcow2 </span><br><span class="line">virsh vol-info /home/kvm/images/sql_server_2012.qcow2 </span><br></pre></td></tr></table></figure>
<p>删除一个数据卷</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">virsh vol-delete --pool StoragePool sql_server_2012.qcow2</span><br></pre></td></tr></table></figure>
<h1 id="创建虚拟机"><a href="#创建虚拟机" class="headerlink" title="创建虚拟机"></a>创建虚拟机</h1><p>命令行创建虚拟机</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">virt-install --name sql_server_2012 --memory 4096 --vcpus sockets=1,cores=2,threads=2 --disk device=cdrom,path=/home/cn_windows_server_2012_r2_x64_dvd_2707961.iso --disk path=/home/kvm/images/sql_server_2012.qcow2 --network bridge=br0,model=e1000  --noautoconsole --accelerate --hvm --graphics vnc,listen=0.0.0.0,password=123456,port=20007 --cpu host-passthrough --autostart</span><br></pre></td></tr></table></figure>
<p>图形界面创建安虚拟机</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">virt-manager</span><br></pre></td></tr></table></figure>
<p>（过程略）</p>
<h1 id="virtsh-常用指令"><a href="#virtsh-常用指令" class="headerlink" title="virtsh 常用指令"></a>virtsh 常用指令</h1><p>1）virsh list 列出当前虚拟机列表，不包括未启动的<br>2）virsh list –all 列出所有虚拟机，包括所有已经定义的虚拟机<br>3）virsh destroy vm-name 关闭虚拟机<br>4）virsh start vm-name 启动虚拟机<br>5）virsh edit vm-name 编辑虚拟机xml文件<br>6）virsh undefine vm-name 删除虚拟机<br>7）virsh shutdown vm-name 停止虚拟机<br>8）virsh reboot vm-name 重启虚拟机<br>9）virsh autostart vm-name 虚拟机随宿主机启动</p>
<h1 id="virsh-pool与vol命令帮助"><a href="#virsh-pool与vol命令帮助" class="headerlink" title="virsh pool与vol命令帮助"></a>virsh pool与vol命令帮助</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Storage Pool (help keyword &#x27;pool&#x27;)</span><br><span class="line">    find-storage-pool-sources-as   找到潜在存储池源</span><br><span class="line">    find-storage-pool-sources      发现潜在存储池源</span><br><span class="line">    pool-autostart                 自动启动某个池</span><br><span class="line">    pool-build                     建立池</span><br><span class="line">    pool-create-as                 从一组变量中创建一个池</span><br><span class="line">    pool-create                    从一个 XML 文件中创建一个池</span><br><span class="line">    pool-define-as                 在一组变量中定义池</span><br><span class="line">    pool-define                    define an inactive persistent storage pool or modify an existing persistent one from an XML file</span><br><span class="line">    pool-delete                    删除池</span><br><span class="line">    pool-destroy                   销毁（删除）池</span><br><span class="line">    pool-dumpxml                   XML 中的池信息</span><br><span class="line">    pool-edit                      为存储池编辑 XML 配置</span><br><span class="line">    pool-info                      存储池信息</span><br><span class="line">    pool-list                      列出池</span><br><span class="line">    pool-name                      将池 UUID 转换为池名称</span><br><span class="line">    pool-refresh                   刷新池</span><br><span class="line">    pool-start                     启动一个（以前定义的）非活跃的池</span><br><span class="line">    pool-undefine                  取消定义一个不活跃的池</span><br><span class="line">    pool-uuid                      把一个池名称转换为池 UUID</span><br><span class="line"></span><br><span class="line"> Storage Volume (help keyword &#x27;volume&#x27;)</span><br><span class="line">    vol-clone                      克隆卷。</span><br><span class="line">    vol-create-as                  从一组变量中创建卷</span><br><span class="line">    vol-create                     从一个 XML 文件创建一个卷</span><br><span class="line">    vol-create-from                生成卷，使用另一个卷作为输入。</span><br><span class="line">    vol-delete                     删除卷</span><br><span class="line">    vol-download                   将卷内容下载到文件中</span><br><span class="line">    vol-dumpxml                    XML 中的卷信息</span><br><span class="line">    vol-info                       存储卷信息</span><br><span class="line">    vol-key                        为给定密钥或者路径返回卷密钥</span><br><span class="line">    vol-list                       列出卷</span><br><span class="line">    vol-name                       为给定密钥或者路径返回卷名</span><br><span class="line">    vol-path                       为给定密钥或者路径返回卷路径</span><br><span class="line">    vol-pool                       为给定密钥或者路径返回存储池</span><br><span class="line">    vol-resize                     创新定义卷大小</span><br><span class="line">    vol-upload                     将文件内容上传到卷中</span><br><span class="line">    vol-wipe                       擦除卷</span><br></pre></td></tr></table></figure>
<p>参考：<br><a href="http://www.linuxtechi.com/install-kvm-hypervisor-on-centos-7-and-rhel-7/">http://www.linuxtechi.com/install-kvm-hypervisor-on-centos-7-and-rhel-7/</a><br><a href="http://wangying.sinaapp.com/archives/1893">http://wangying.sinaapp.com/archives/1893</a><br><a href="http://wangying.sinaapp.com/archives/1914">http://wangying.sinaapp.com/archives/1914</a></p>
]]></content>
      <categories>
        <category>虚拟化</category>
      </categories>
      <tags>
        <tag>虚拟化</tag>
        <tag>kvm</tag>
      </tags>
  </entry>
  <entry>
    <title>Centos7下Rsync服务器搭建配置</title>
    <url>/arlo/98679d8a/</url>
    <content><![CDATA[<p>之前写了个<a href="http://islocal.cc/2017/06/16/windows-%E4%B8%8B%E4%BD%BF%E7%94%A8expdp%E8%87%AA%E5%8A%A8%E5%A4%87%E4%BB%BD%E5%A4%9A%E7%94%A8%E6%88%B7oracle%E8%84%9A%E6%9C%AC">Windows下oracle多用户自动备份的脚本</a>，这个备份完数据还是存在服务器本地的，如果系统宕机的话，数据还是没有了，这样的备份是没有意义滴；所以我们需要把数据转移到其他的存储上，常用的方式是使用Rsync工具来保持同步数据，接下来我们搭建一个简单的Rsync服务器。</p>
<span id="more"></span>
<h1 id="安装部署rsync服务器"><a href="#安装部署rsync服务器" class="headerlink" title="安装部署rsync服务器"></a>安装部署rsync服务器</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sftp_server ~]# yum -y install rsync</span><br><span class="line">[root@sftp_server ~]# mkdir -p /etc/rsyncd/</span><br><span class="line">[root@sftp_server ~]# touch /etc/rsyncd/rsyncd.conf</span><br><span class="line">[root@sftp_server ~]# ln -s /etc/rsyncd/rsyncd.conf /etc/rsyncd.conf</span><br></pre></td></tr></table></figure>
<h1 id="配置rsync服务器"><a href="#配置rsync服务器" class="headerlink" title="配置rsync服务器"></a>配置rsync服务器</h1><h2 id="主配置文件-x2F-etc-x2F-rsyncd-conf"><a href="#主配置文件-x2F-etc-x2F-rsyncd-conf" class="headerlink" title="主配置文件&#x2F;etc&#x2F;rsyncd.conf"></a>主配置文件&#x2F;etc&#x2F;rsyncd.conf</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sftp_server ~]# cat /etc/rsyncd.conf </span><br><span class="line">uid = root                         </span><br><span class="line">gid = root                                  </span><br><span class="line">use chroot = yes                             </span><br><span class="line">hosts allow=192.168.10.33/24</span><br><span class="line">hosts deny=*</span><br><span class="line">max connections=5</span><br><span class="line">pid file = /var/run/rsyncd.pid </span><br><span class="line">secrets file = /etc/rsyncd/rsyncd.secrets </span><br><span class="line">motd file = /etc/rsyncd/rsyncd.motd  </span><br><span class="line">log file = /var/log/rsync.log</span><br><span class="line">transfer logging = yes  </span><br><span class="line">log format = %t %a %m %f %b</span><br><span class="line">syslog facility = local3</span><br><span class="line">timeout = 300</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[db_backup]                               </span><br><span class="line">path = /data/backup/                       </span><br><span class="line">list=yes                                   </span><br><span class="line">read only = no    </span><br><span class="line">ignore errors                              </span><br><span class="line">auth users = rdatabase                          </span><br><span class="line">comment = Oracle Database Backup</span><br></pre></td></tr></table></figure>
<h2 id="密码验证文件-x2F-etc-x2F-rsyncd-x2F-rsyncd-secrets"><a href="#密码验证文件-x2F-etc-x2F-rsyncd-x2F-rsyncd-secrets" class="headerlink" title="密码验证文件&#x2F;etc&#x2F;rsyncd&#x2F;rsyncd.secrets"></a>密码验证文件&#x2F;etc&#x2F;rsyncd&#x2F;rsyncd.secrets</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sftp_server ~]# cat /etc/rsyncd/rsyncd.secrets </span><br><span class="line">rdatabase:sss</span><br><span class="line">[root@sftp_server ~]# chown root.root /etc/rsyncd/rsyncd.secrets</span><br><span class="line">[root@sftp_server ~]# chmod 600 /etc/rsyncd/rsyncd.secrets</span><br></pre></td></tr></table></figure>
<h2 id="欢迎提示信息文件-x2F-etc-x2F-rsyncd-x2F-rsyncd-motd"><a href="#欢迎提示信息文件-x2F-etc-x2F-rsyncd-x2F-rsyncd-motd" class="headerlink" title="欢迎提示信息文件&#x2F;etc&#x2F;rsyncd&#x2F;rsyncd.motd"></a>欢迎提示信息文件&#x2F;etc&#x2F;rsyncd&#x2F;rsyncd.motd</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sftp_server ~]# cat /etc/rsyncd/rsyncd.motd</span><br><span class="line">+++++++++++++++++++++++++++</span><br><span class="line">+ Oracle Database Backup! +</span><br><span class="line">+++++++++++++++++++++++++++</span><br></pre></td></tr></table></figure>
<h2 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sftp_server ~]# systemctl start rsyncd.service</span><br><span class="line">[root@sftp_server ~]# systemctl enable rsyncd.service</span><br></pre></td></tr></table></figure>
<h2 id="防火墙配置"><a href="#防火墙配置" class="headerlink" title="防火墙配置"></a>防火墙配置</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">firewall-cmd --zone=public --add-port=873/tcp --permanent</span><br><span class="line">firewall-cmd --zone=public --add-service=rsyncd --permanent</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>
<h1 id="客户端配置"><a href="#客户端配置" class="headerlink" title="客户端配置"></a>客户端配置</h1><p>有几个细节地方需要主机</p>
<ol>
<li>rsync命令执行的时候，前边的是src(源)，后边的是dest(目标)</li>
<li>路径后有&#x2F;只会同步目录下的内容，路径后没有&#x2F;，会把当前目录（路径的最后一层）同步过去</li>
</ol>
<h2 id="linux客户端配置"><a href="#linux客户端配置" class="headerlink" title="linux客户端配置"></a>linux客户端配置</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># yum install -y rsync</span><br><span class="line">[airmodel@silu ~]$ rsync -avzP /tmp/data/ rdatabase@192.168.6.23::db_backup  #把本机/tmp/data/目录下的内容同步到rsync服务器db_backup模块配置的目录中去，如果要将rsync服务器上内容同步至本机，路径位置换一下即可</span><br></pre></td></tr></table></figure>
<h2 id="windows-客户端配置"><a href="#windows-客户端配置" class="headerlink" title="windows 客户端配置"></a>windows 客户端配置</h2><ol>
<li>下载free版本的cwrsync软件 <a href="https://itefix.net/cwrsync">https://itefix.net/cwrsync</a> </li>
<li>在c盘根目录新建一个密码文件password.rsync，内容为sss（这里写的密码和rsync服务器上的要对应，只写密码，不需要用户名）</li>
<li>cwrsync不识别Windows路径，C盘需要写为&#x2F;cygdrive&#x2F;c，E盘需要写为&#x2F;cygdrive&#x2F;e</li>
<li>新建一个计划任务，实现自动化备份，操作可以参考以下示例<br>以下实例内容为：将本地E:\database_backup\目录下的内容同步至rsync服务的db_backup模块中定义的路径中去，密码文件为C:\password.rsync</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">C:\cwRsync_5.5.0_x86_Free\bin\rsync.exe -azvP --password-file=/cygdrive/c/password.rsync /cygdrive/e/database_backup/ rdatabase@192.168.6.23::db_backup </span><br></pre></td></tr></table></figure>
<h1 id="更优方式"><a href="#更优方式" class="headerlink" title="更优方式"></a>更优方式</h1><p>linux下可以部署inotify+rsync，实现实时同步数据</p>
<hr>
]]></content>
      <categories>
        <category>常识</category>
      </categories>
      <tags>
        <tag>rsync</tag>
        <tag>同步</tag>
        <tag>备份</tag>
      </tags>
  </entry>
  <entry>
    <title>Except实践之 修改主机密码&amp;添加用户&amp;ssh免密码验证</title>
    <url>/arlo/45fa6416/</url>
    <content><![CDATA[<p>最近运维工作中遇到大批量的主机需要添加账户，修改密码，实现无密码验证等工作，由于这种工作完全是重复性的，可以借助脚本（更好的方式是自动化运维工具）来解决，主要是使用到expect工具，该工具主要用来处理自动交互式任务进行通信，不需要人为干预；今天就把用到的脚本在此记录一下，以备后用。</p>
<span id="more"></span>
<h1 id="批量修改主机密码"><a href="#批量修改主机密码" class="headerlink" title="批量修改主机密码"></a>批量修改主机密码</h1><p>脚本内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm00 ~]# cat chpasswd.sh </span><br><span class="line">#!/bin/bash</span><br><span class="line">file=&quot;iplist.txt&quot;</span><br><span class="line">for ip in `awk &#x27;/^[^#]/&#123;print $1&#125;&#x27; $file`; do</span><br><span class="line">    port=`awk -v I=$ip &#x27;&#123;if(I==$1)print $3&#125;&#x27; $file`</span><br><span class="line">    user=`awk -v I=$ip &#x27;&#123;if(I==$1)print $2&#125;&#x27; $file`</span><br><span class="line">    pass=`awk -v I=$ip &#x27;&#123;if(I==$1)print $4&#125;&#x27; $file`</span><br><span class="line">    newpass=`awk -v I=$ip &#x27;&#123;if(I==$1)print $5&#125;&#x27; $file`</span><br><span class="line"></span><br><span class="line">expect -c &quot;</span><br><span class="line">    spawn ssh -p$port $user@$ip</span><br><span class="line">    set timeout 2</span><br><span class="line">    expect &#123;</span><br><span class="line">        \&quot;(yes/no)\&quot; &#123;send \&quot;yes\r\&quot;;exp_continue&#125;</span><br><span class="line">        \&quot;password:\&quot; &#123;send \&quot;$pass\r\&quot;;exp_continue&#125;</span><br><span class="line">        \&quot;$user@*\&quot; &#123;send \&quot;echo \&#x27;$newpass\&#x27; |passwd --stdin $user\r exit\r\&quot;;exp_continue&#125;</span><br><span class="line"></span><br><span class="line">#\&quot;$user@*\&quot;  &#123;send \&quot;df -h\r exit\r\&quot;;exp_continue&#125;</span><br><span class="line">    &#125;&quot;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p>iplist.txt 格式如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm00 ~]# cat iplist.txt </span><br><span class="line">#     ip     user    port    passwd    newpasswd</span><br><span class="line">#------------------------------------------------</span><br><span class="line">192.168.6.101  root    22    ffffff    gggggg</span><br><span class="line">192.168.6.102  root    22    ffffff    gggggg</span><br></pre></td></tr></table></figure>
<h1 id="批量主机ssh免密码验证"><a href="#批量主机ssh免密码验证" class="headerlink" title="批量主机ssh免密码验证"></a>批量主机ssh免密码验证</h1><h2 id="手动操作ssh无密码验证"><a href="#手动操作ssh无密码验证" class="headerlink" title="手动操作ssh无密码验证"></a>手动操作ssh无密码验证</h2><h3 id="设置hosts记录"><a href="#设置hosts记录" class="headerlink" title="设置hosts记录"></a>设置hosts记录</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm00 ~]# cat /etc/hosts</span><br><span class="line">\#127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4 oracle11g</span><br><span class="line">\#::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.6.100 vm00</span><br><span class="line">192.168.6.101 vm01</span><br><span class="line">192.168.6.102 vm02</span><br></pre></td></tr></table></figure>
<h3 id="新建用户并设置密码（每台机器都执行）"><a href="#新建用户并设置密码（每台机器都执行）" class="headerlink" title="新建用户并设置密码（每台机器都执行）"></a>新建用户并设置密码（每台机器都执行）</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm00 ~]# useradd -u 600 airmodel</span><br><span class="line">[root@vm00 ~]# echo &quot;ffffff&quot; |passwd --stdin airmodel</span><br><span class="line">Changing password for user airmodel.</span><br><span class="line">passwd: all authentication tokens updated successfully.</span><br></pre></td></tr></table></figure>
<h3 id="配置无密码访问key"><a href="#配置无密码访问key" class="headerlink" title="配置无密码访问key"></a>配置无密码访问key</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm00 ~]# su - airmodel</span><br><span class="line">[airmodel@vm00 ~]$ ssh-keygen </span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/home/airmodel/.ssh/id_rsa): </span><br><span class="line">Created directory &#x27;/home/airmodel/.ssh&#x27;.</span><br><span class="line">Enter passphrase (empty for no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved in /home/airmodel/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /home/airmodel/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">3a:d9:04:80:20:6a:90:8a:cd:c7:ee:fb:2d:d9:03:cd airmodel@vm00</span><br><span class="line">The key&#x27;s randomart image is:</span><br><span class="line">+--[ RSA 2048]----+</span><br><span class="line">|+o ..            |</span><br><span class="line">|= .  .           |</span><br><span class="line">|++ .  .          |</span><br><span class="line">|+ o o  .         |</span><br><span class="line">|   o   oS        |</span><br><span class="line">|    . .=E        |</span><br><span class="line">|   .  ++.        |</span><br><span class="line">|    . ooo        |</span><br><span class="line">|    .o....       |</span><br><span class="line">+-----------------+</span><br></pre></td></tr></table></figure>
<p><img src="/images/2017/0618/01.png" alt="图片"></p>
<h3 id="将生成的公钥拷贝到其他主机"><a href="#将生成的公钥拷贝到其他主机" class="headerlink" title="将生成的公钥拷贝到其他主机"></a>将生成的公钥拷贝到其他主机</h3><p>标准命令格式：ssh-copy-id -i ~&#x2F;.ssh&#x2F;id_rsa.pub user@server<br>偷懒可以写成下边这种：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[airmodel@vm00 ~]$ ssh-copy-id -i vm02</span><br><span class="line">airmodel@vm02&#x27;s password: </span><br><span class="line">Now try logging into the machine, with &quot;ssh &#x27;vm02&#x27;&quot;, and check in:</span><br><span class="line"></span><br><span class="line">  .ssh/authorized_keys</span><br><span class="line"></span><br><span class="line">to make sure we haven&#x27;t added extra keys that you weren&#x27;t expecting.</span><br></pre></td></tr></table></figure>
<h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><p>1.公钥会被拷贝到目标主机的 &#x2F;home&#x2F;user&#x2F;.ssh&#x2F;authorized_keys 文件中<br>2.[airmodel@vm00 ~]$ ssh vm02 无密码访问</p>
<h2 id="多主机自动化配置ssh免密脚本"><a href="#多主机自动化配置ssh免密脚本" class="headerlink" title="多主机自动化配置ssh免密脚本"></a>多主机自动化配置ssh免密脚本</h2><h3 id="添加用户脚本"><a href="#添加用户脚本" class="headerlink" title="添加用户脚本"></a>添加用户脚本</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm00 ~]# cat padduser.sh </span><br><span class="line">#!/bin/bash</span><br><span class="line">file=&quot;iplist2.txt&quot;</span><br><span class="line">newuser=&quot;airmodel&quot;</span><br><span class="line">newpass=&quot;ffffff&quot;</span><br><span class="line">for ip in `awk &#x27;/^[^#]/&#123;print $1&#125;&#x27; $file`; do</span><br><span class="line">    port=`awk -v I=$ip &#x27;&#123;if(I==$1)print $3&#125;&#x27; $file`</span><br><span class="line">    loginuser=`awk -v I=$ip &#x27;&#123;if(I==$1)print $2&#125;&#x27; $file`</span><br><span class="line">    pass=`awk -v I=$ip &#x27;&#123;if(I==$1)print $4&#125;&#x27; $file`</span><br><span class="line">expect -c &quot;</span><br><span class="line">    spawn ssh -p$port $loginuser@$ip</span><br><span class="line">    set timeout 2</span><br><span class="line">    expect &#123;</span><br><span class="line">        \&quot;(yes/no)\&quot; &#123;send \&quot;yes\r\&quot;;exp_continue&#125;</span><br><span class="line">        \&quot;password:\&quot; &#123;send \&quot;$pass\r\&quot;;exp_continue&#125;</span><br><span class="line">        \&quot;$user@*\&quot; &#123;send \&quot;useradd -u 600 $newuser &amp;&amp; echo \&#x27;$newpass\&#x27; |passwd --stdin $newuser\r exit\r\&quot;;exp_continue&#125;</span><br><span class="line">#\&quot;$user@*\&quot;  &#123;send \&quot;df -h\r exit\r\&quot;;exp_continue&#125;</span><br><span class="line">    &#125;&quot;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p>iplist2.txt内容</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#     ip     user    port    passwd    </span><br><span class="line">#--------------------------------------</span><br><span class="line">192.168.6.102  root    22    ffffff</span><br></pre></td></tr></table></figure>
<h3 id="多主机拷贝ssh公钥"><a href="#多主机拷贝ssh公钥" class="headerlink" title="多主机拷贝ssh公钥"></a>多主机拷贝ssh公钥</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">#批量ssh无密码验证</span><br><span class="line">for p in $(cat /opt/iplist3.txt)</span><br><span class="line">do</span><br><span class="line">ip=$(echo &quot;$p&quot;|cut -f1 -d &quot;:&quot;)</span><br><span class="line">password=$(echo &quot;$p&quot;|cut -f2 -d &quot;:&quot;)</span><br><span class="line"></span><br><span class="line">expect -c &quot;   </span><br><span class="line">spawn ssh-copy-id -i /home/airmodel/.ssh/id_rsa.pub airmodel@$ip  </span><br><span class="line">        expect &#123;   </span><br><span class="line">                \&quot;*yes/no*\&quot; &#123;send \&quot;yes\r\&quot;; exp_continue&#125;   </span><br><span class="line">                \&quot;*password*\&quot; &#123;send \&quot;$password\r\&quot;; exp_continue&#125;   </span><br><span class="line">                \&quot;*Password*\&quot; &#123;send \&quot;$password\r\&quot;;&#125;   </span><br><span class="line">        &#125;   </span><br><span class="line">&quot;   </span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p>iplist3.txt 格式</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#user:passwd</span><br><span class="line">#-----------</span><br><span class="line">vm01:ffffff</span><br><span class="line">vm02:ffffff</span><br><span class="line">vm03:ffffff</span><br><span class="line">vm04:ffffff</span><br><span class="line">vm05:ffffff</span><br></pre></td></tr></table></figure>

<p>参考连接：<br><a href="http://zqscm.qiniucdn.com/data/20110709133541/index.html">http://zqscm.qiniucdn.com/data/20110709133541/index.html</a><br><a href="https://blog.slogra.com/post-674.html">https://blog.slogra.com/post-674.html</a><br><a href="http://blog.csdn.net/fanren224/article/details/63250184">http://blog.csdn.net/fanren224/article/details/63250184</a></p>
]]></content>
      <categories>
        <category>自动化运维</category>
      </categories>
      <tags>
        <tag>运维</tag>
        <tag>自动化</tag>
        <tag>expect</tag>
        <tag>脚本</tag>
      </tags>
  </entry>
  <entry>
    <title>jenkins 持续集成环境搭建</title>
    <url>/arlo/c0b31722/</url>
    <content><![CDATA[<h1 id="持续集成"><a href="#持续集成" class="headerlink" title="持续集成"></a>持续集成</h1><blockquote>
<p> 持续集成（CI）是一种软件工程流程，将所有工程师对于软件的工作复本，每天集成数次到共用主线（mainline）上。</p>
</blockquote>
<h2 id="依赖以下原则达到目标"><a href="#依赖以下原则达到目标" class="headerlink" title="依赖以下原则达到目标"></a>依赖以下原则达到目标</h2><ul>
<li>维护一个代码库</li>
<li>自动建置</li>
<li>让建置时会自我测试</li>
<li>所有人每天至少提交一次</li>
<li>应该要建置每一个提交</li>
<li>让建置维持快速</li>
<li>用在线环境的复本测试</li>
<li>让获取最新发布版本更容易</li>
<li>任何人都可以查看最后建置的结果</li>
<li>自动部署</li>
</ul>
<h2 id="产生的效益"><a href="#产生的效益" class="headerlink" title="产生的效益"></a>产生的效益</h2><ul>
<li>及早发现集成错误且由于修订的内容较小所以易于追踪，这可以节省项目的时间与成本。</li>
<li>避免发布日期的前一分钟发生混乱，当每个人都会尝试为他们所造成的那一点点不兼容的版本做检查。</li>
<li>当单元测试失败或发生错误，若开发人员需要在不除错的情况下还原代码库到一个没有问题的状态，只需要放弃一小部分的更改 (因为集成的次数频繁)。</li>
<li>让 “最新” 的程序可保持可用的状态供测试、展示或发布用。</li>
<li>频繁的提交代码会促使开发人员创建模块化，低复杂性的代码。<span id="more"></span>
Jenkins是一个用Java编写的开源的持续集成工具，前身是Hudson (软件)项目，有丰富的插件支持；</li>
</ul>
<h1 id="Jenkins安装"><a href="#Jenkins安装" class="headerlink" title="Jenkins安装"></a>Jenkins安装</h1><h2 id="安装jdk"><a href="#安装jdk" class="headerlink" title="安装jdk"></a>安装jdk</h2><p>jdk下载地址： <a href="http://www.oracle.com/technetwork/java/archive-139210.html">http://www.oracle.com/technetwork/java/archive-139210.html</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tar xf jdk-8u112-linux-x64.tar.gz -C /usr/local/</span><br></pre></td></tr></table></figure>
<p>配置jdk环境变量<br>vim &#x2F;etc&#x2F;profile</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">export JAVA_HOME=/usr/local/jdk1.8.0_112</span><br><span class="line">export CLASSPATH=.:$JAVA_HOME/lib/:$JAVA_HOME/jre/lib/</span><br><span class="line">export PATH=$JAVA_HOME/bin:$PATH</span><br></pre></td></tr></table></figure>
<h2 id="安装jenkins"><a href="#安装jenkins" class="headerlink" title="安装jenkins"></a>安装jenkins</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wget -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo</span><br><span class="line">rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key</span><br><span class="line">yum install jenkins</span><br></pre></td></tr></table></figure>
<p>添加java路径到jenkins启动脚本中<br>vim &#x2F;etc&#x2F;init.d&#x2F;jenkins</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/usr/local/jdk1.8.0_112/bin/java</span><br></pre></td></tr></table></figure>
<p><img src="/images/2017/0427/00.png" alt="jenkins"><br>修改jenkins默认时区</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/sysconfig/jenkins</span><br><span class="line">JENKINS_JAVA_OPTIONS=&quot;-Djava.awt.headless=true -Dorg.apache.commons.jelly.tags.fmt.timeZone=Asia/Shanghai&quot;</span><br></pre></td></tr></table></figure>
<h2 id="启动jenkins"><a href="#启动jenkins" class="headerlink" title="启动jenkins"></a>启动jenkins</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/etc/init.d/jenkins start</span><br><span class="line">chkconfig --level 35 jenkins on</span><br></pre></td></tr></table></figure>
<p>访问路径 <a href="http://192.168.6.102:8080/">http://192.168.6.102:8080</a><br>默认密码存在这个文件中 &#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;secrets&#x2F;initialAdminPassword<br><img src="/images/2017/0427/01.png" alt="jenkins"><br>创建一个管理用户<br><img src="/images/2017/0427/02.png" alt="jenkins"><br><img src="/images/2017/0427/03.png" alt="jenkins"></p>
<h2 id="Jenkins-配置"><a href="#Jenkins-配置" class="headerlink" title="Jenkins 配置"></a>Jenkins 配置</h2><h2 id="安装maven"><a href="#安装maven" class="headerlink" title="安装maven"></a>安装maven</h2><p>jdk下载地址：<code> https://dlcdn.apache.org/maven/</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tar xf apache-maven-3.3.9-bin.tar.gz -C /usr/local/</span><br></pre></td></tr></table></figure>
<p>配置maven环境变量<br>vim &#x2F;etc&#x2F;profile</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">export JAVA_HOME=/usr/local/jdk1.8.0_112</span><br><span class="line">export CLASSPATH=.:$JAVA_HOME/lib/:$JAVA_HOME/jre/lib/</span><br><span class="line">export M3_HOME=/usr/local/apache-maven-3.3.9</span><br><span class="line">export PATH=$JAVA_HOME/bin:$PATH:$M3_HOME/bin</span><br></pre></td></tr></table></figure>
<h2 id="全局工具配置"><a href="#全局工具配置" class="headerlink" title="全局工具配置"></a>全局工具配置</h2><p>点击系统配置-Global Tool Configuration<br><img src="/images/2017/0427/04.png" alt="jenkins"><br>针对项目中使用的jdk和maven情况添加对应的版本<br><img src="/images/2017/0427/05.png" alt="jenkins"></p>
<h2 id="插件安装配置"><a href="#插件安装配置" class="headerlink" title="插件安装配置"></a>插件安装配置</h2><p>点击系统配置-插件管理<br><img src="/images/2017/0427/06.png" alt="jenkins"></p>
<ul>
<li>可选插件直接安装<br>右上角的过滤功能很好用，可以直接搜索安装<br>安装以下插件<br>Hudson SCP publisher plugin<br>Deploy to container Plugin<br>Maven Integration plugin<br>Publish Over SSH<br>Publish Over CIFS<br>Backup plugin &#x2F; ThinBackup<br>Email Ext Recipients Column Plugin<br>Localization: Chinese (Simplified)</li>
<li>高级选项中上传插件安装<br><a href="http://mirrors.jenkins-ci.org/plugins/">http://mirrors.jenkins-ci.org/plugins/</a><br>安装完插件之后，建议重启一下jenkins，防止插件未加载上，不生效；</li>
</ul>
<h1 id="发布一个静态网站"><a href="#发布一个静态网站" class="headerlink" title="发布一个静态网站"></a>发布一个静态网站</h1><h2 id="配置Hudson-SCP-publisher-plugin插件"><a href="#配置Hudson-SCP-publisher-plugin插件" class="headerlink" title="配置Hudson SCP publisher plugin插件"></a>配置Hudson SCP publisher plugin插件</h2><p>此插件用于发布静态网站，拷贝文件很方便<br><img src="/images/2017/0427/07.png" alt="jenkins"><br>配置需要发布的服务器hostname，端口，路径，用户名，密码（如果是正式环境，不建议使用root用户）</p>
<blockquote>
<p>ps:这里有个小技巧，如果这台机器上有多个静态网站目录的话，可以在服务器设置多个hosts记录，这里使用主机名来分区不同的路径</p>
</blockquote>
<h2 id="新建一个软件项目test"><a href="#新建一个软件项目test" class="headerlink" title="新建一个软件项目test"></a>新建一个软件项目test</h2><p><img src="/images/2017/0427/08.png" alt="jenkins"><br>源码管理：<br>填写svn路径<br>有获取代码权限的用户名密码<br><img src="/images/2017/0427/09.png" alt="jenkins"><br>构建后操作：<br>选择需要scp的路径<br>Source ** 表示所有<br>Keep Hierarchy  保持目录结构（否则不能拷贝文件夹）<br><img src="/images/2017/0427/10.png" alt="jenkins"><br>点击立即构建<br><img src="/images/2017/0427/11.png" alt="jenkins"><br>通过 Console Output可以看到详细日志<br><img src="/images/2017/0427/12.png" alt="jenkins"><br>至此，一个静态网站就发布完成了！</p>
<h1 id="发布一个java后台工程"><a href="#发布一个java后台工程" class="headerlink" title="发布一个java后台工程"></a>发布一个java后台工程</h1><h2 id="安装Deploy-to-container-Plugin插件"><a href="#安装Deploy-to-container-Plugin插件" class="headerlink" title="安装Deploy to container Plugin插件"></a>安装Deploy to container Plugin插件</h2><p>此插件可以将war&#x2F;ear 包发布到tomcat，glassfish，jetty，weblogic等中间件上</p>
<h2 id="配置tomcat-web管理"><a href="#配置tomcat-web管理" class="headerlink" title="配置tomcat web管理"></a>配置tomcat web管理</h2><p>vim &#x2F;usr&#x2F;local&#x2F;apache-tomcat-7.0.77&#x2F;conf&#x2F;tomcat-users.xml</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;role rolename=&quot;tomcat&quot;/&gt;</span><br><span class="line">&lt;role rolename=&quot;role1&quot;/&gt;</span><br><span class="line">&lt;role rolename=&quot;manager-gui&quot;/&gt;</span><br><span class="line">&lt;role rolename=&quot;manager-gui,manager-script,manager-jmx,manager-status&quot;/&gt;</span><br><span class="line">&lt;user username=&quot;tomcat&quot; password=&quot;tomcat&quot; roles=&quot;manager-gui&quot;/&gt;</span><br><span class="line">&lt;user username=&quot;admin&quot; password=&quot;admin&quot; roles=&quot;manager-gui,manager-script,manager-jmx,manager-status&quot;/&gt;</span><br></pre></td></tr></table></figure>
<p>由于jenkins把8080端口占用，我这里修改tomcat端口为8081<br>vim &#x2F;usr&#x2F;local&#x2F;apache-tomcat-7.0.77&#x2F;conf&#x2F;server.xml</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;Connector port=&quot;8081&quot; protocol=&quot;HTTP/1.1&quot;</span><br></pre></td></tr></table></figure>
<p>tomcat8之后的版本，为了安全，默认只有本机可以访问管理控制台，因此需要修改$TOMCAT&#x2F;webapp&#x2F;manager&#x2F;META-INF和$TOMCAT&#x2F;webapp&#x2F;host-manager&#x2F;META-INF目录下的content.xml<br>修改</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;Valve className=&quot;org.apache.catalina.valves.RemoteAddrValve&quot;</span><br><span class="line">         allow=&quot;127\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1&quot; /&gt;</span><br></pre></td></tr></table></figure>
<p>为</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;Valve className=&quot;org.apache.catalina.valves.RemoteAddrValve&quot;</span><br><span class="line">         allow=&quot;\d+\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1&quot; /&gt;</span><br></pre></td></tr></table></figure>

<h2 id="一个简单的maven工程代码"><a href="#一个简单的maven工程代码" class="headerlink" title="一个简单的maven工程代码"></a>一个简单的maven工程代码</h2><p><a href="https://github.com/nsxq/hello-world-war">https://github.com/nsxq/hello-world-war</a></p>
<h2 id="maven-的简单使用"><a href="#maven-的简单使用" class="headerlink" title="maven 的简单使用"></a>maven 的简单使用</h2><p>查看版本</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mvn -version</span><br></pre></td></tr></table></figure>
<p>查看详细信息</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mvn X</span><br></pre></td></tr></table></figure>
<p>测试</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mvn test</span><br></pre></td></tr></table></figure>
<p>清理（target目录下的编译内容）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mvn clean</span><br></pre></td></tr></table></figure>
<p>编译项目</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mvn compile</span><br></pre></td></tr></table></figure>
<p>打包发布</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mvn package</span><br></pre></td></tr></table></figure>
<p>生成eclipse项目文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mvn eclipse:eclipse</span><br></pre></td></tr></table></figure>
<p>产生site</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mvn site   </span><br></pre></td></tr></table></figure>
<p>安装当前工程的jar安装到本地仓库</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mvn install</span><br></pre></td></tr></table></figure>
<p>安装jar包到本地仓库</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mvn install:install-file -DgroupId=com.oracle -DartifactId=ojdbc14 -Dversion=10.2.0.4.0 -Dpackaging=jar -Dfile=/usr/local/src/ojdbc14-10.2.0.4.0.jar</span><br></pre></td></tr></table></figure>
<p>分析项目的依赖信息</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mvn dependency:analyze / mvn dependency:tree</span><br></pre></td></tr></table></figure>
<h2 id="新建一个maven工程"><a href="#新建一个maven工程" class="headerlink" title="新建一个maven工程"></a>新建一个maven工程</h2><p>获取代码<br><img src="/images/2017/0427/14.png" alt="jenkins"><br>编译参数<br><img src="/images/2017/0427/15.png" alt="jenkins"><br>构建后发布<br><img src="/images/2017/0427/16.png" alt="jenkins"><br>点击立即构建<br>查看日志，已经发布完成了<br><img src="/images/2017/0427/17.png" alt="jenkins"><br>访问项目<br><a href="http://192.168.6.102:8081/hello">http://192.168.6.102:8081/hello</a><br><img src="/images/2017/0427/18.png" alt="jenkins"><br>至此，一个maven工程已经实现自动化编译、打包、发布！</p>
<h1 id="版本回退"><a href="#版本回退" class="headerlink" title="版本回退"></a>版本回退</h1><p>有时候发布一个新版本失败或发布有问题，我们需要回滚到指定版本的构建，这样才能更灵活的进行项目的构建部署。我们可以选择“参数化的构建过程”进行传递不同的参数来选择是进行新的构建还是退</p>
<h2 id="对文件进行存档"><a href="#对文件进行存档" class="headerlink" title="对文件进行存档"></a>对文件进行存档</h2><p>为了能够进行版本回退，构建完成的需要对文件进行存档<br><img src="/images/2017/0427/19.png" alt="jenkins"></p>
<h2 id="使用参数化构建过程"><a href="#使用参数化构建过程" class="headerlink" title="使用参数化构建过程"></a>使用参数化构建过程</h2><p>让后面的脚步可以根据不同的变量执行不同的操作。添加“Choice”参数配置不同的选项，让选择发布还是回滚，添加“String Parameter”参数来传递要回退的版本号。<br><img src="/images/2017/0427/20.png" alt="jenkins"></p>
<h2 id="构建选择“Execute-Shell”的方式"><a href="#构建选择“Execute-Shell”的方式" class="headerlink" title="构建选择“Execute Shell”的方式"></a>构建选择“Execute Shell”的方式</h2><p>自己根据变量，自定义构建的脚本，此时如果是发布安装maven的构建过程进行新的构建，如果是回滚，知道历史构建后的文件，复制到当前构建结果目录。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">case $deploy_env in</span><br><span class="line">	deploy)</span><br><span class="line">    	echo &quot;deploy:$deploy_env&quot;</span><br><span class="line">        mvn clean test compile install package</span><br><span class="line">        ;;</span><br><span class="line">    rollback)</span><br><span class="line">    	echo &quot;rollback:$deploy_env&quot;</span><br><span class="line">        echo &quot;version: $version&quot;</span><br><span class="line">        rm -fr target/hello-1.war</span><br><span class="line">        cp -R $&#123;JENKINS_HOME&#125;/jobs/myapp/builds/$&#123;version&#125;/com.efsavage\$hello/archive/com.efsavage/hello/1/hello-1.war .</span><br><span class="line">        pwd &amp;&amp; ls</span><br><span class="line">        ;;</span><br><span class="line">	*)</span><br><span class="line">    exit</span><br><span class="line">    	;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>
<h2 id="执行回退操作"><a href="#执行回退操作" class="headerlink" title="执行回退操作"></a>执行回退操作</h2><p>点击构建，根据不同的参数选择发布还是版本回退，回退的时候填写要回退到的历史版本号<br><img src="/images/2017/0427/21.png" alt="jenkins"><br><img src="/images/2017/0427/22.png" alt="jenkins"></p>
<p>PS: Tomcat8配置web管理后，Tomcat访问 manager页面 报403的解决办法：<a href="https://blog.52itstyle.com/archives/274/">https://blog.52itstyle.com/archives/274/</a></p>
]]></content>
      <categories>
        <category>自动化运维</category>
      </categories>
      <tags>
        <tag>Jenkins</tag>
        <tag>运维</tag>
        <tag>自动化</tag>
      </tags>
  </entry>
  <entry>
    <title>Intel编译器(parallel_studio_xe)安装</title>
    <url>/arlo/e5fb788a/</url>
    <content><![CDATA[<h1 id="软件环境"><a href="#软件环境" class="headerlink" title="软件环境"></a>软件环境</h1><p>CentOS 7.2 x64<br>parallel_studio_xe_2013_update2_intel64.tgz<br>intel_eval.lic</p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><h2 id="安装依赖环境"><a href="#安装依赖环境" class="headerlink" title="安装依赖环境"></a>安装依赖环境</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm00 ~]# yum -y install libstdc++.so.5 gcc-c++</span><br></pre></td></tr></table></figure>
<h2 id="开始安装"><a href="#开始安装" class="headerlink" title="开始安装"></a>开始安装</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm00 src]# tar xf parallel_studio_xe_2013_update2_intel64</span><br><span class="line">[root@vm00 src]# cd parallel_studio_xe_2013_update2_intel64</span><br><span class="line">[root@vm00 parallel_studio_xe_2013_update2_intel64]# ./install.sh</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<h2 id="初始化，欢迎界面"><a href="#初始化，欢迎界面" class="headerlink" title="初始化，欢迎界面"></a>初始化，欢迎界面</h2><p>-——————————————————————————-<br>Initializing, please wait…<br>-——————————————————————————-</p>
<p>Step no: 1 of 7 | Welcome<br>-——————————————————————————-<br>Welcome to the Intel(R) Parallel Studio XE 2013 Update 2 for Linux* installation<br>program.</p>
<p>-——————————————————————————-<br>You will complete the steps below during this installation:<br>Step 1 : Welcome<br>Step 2 : License<br>Step 3 : Activation<br>Step 4 : Intel(R) Software Improvement Program<br>Step 5 : Options<br>Step 6 : Installation<br>Step 7 : Complete<br>-——————————————————————————-<br>Press “Enter” key to continue or “q” to quit: <font color=red><strong>回车</strong></font><br>-——————————————————————————-<br>Checking the prerequisites. It can take several minutes. Please wait…<br>-——————————————————————————-</p>
<h2 id="提示不支持的操作系统，跳过即可"><a href="#提示不支持的操作系统，跳过即可" class="headerlink" title="提示不支持的操作系统，跳过即可"></a>提示不支持的操作系统，跳过即可</h2><p>Step no: 1 of 7 | Options &gt; Missing Optional Pre-requisite(s)<br>-——————————————————————————-<br>There are one or more optional unresolved issues. It is highly recommended to<br>resolve them all before you continue the installation. You can fix them without<br>exiting from the installation and re-check. Or you can quit from the<br>installation, fix them and run the installation again.<br>-——————————————————————————-<br>Missing optional pre-requisites<br>– Intel(R) Composer XE 2013 Update 2 for Linux*: unsupported OS<br>-——————————————————————————-</p>
<ol>
<li>Skip missing optional pre-requisites [default]</li>
<li>Show the detailed info about issue(s)</li>
<li>Re-check the pre-requisites</li>
</ol>
<p>h. Help<br>b. Back to the previous menu<br>q. Quit<br>-——————————————————————————-<br>Please type a selection or press “Enter” to accept default choice [1]: <font color=red>回车</font> </p>
<h2 id="接受条约，输入accept"><a href="#接受条约，输入accept" class="headerlink" title="接受条约，输入accept"></a>接受条约，输入accept</h2><p>Step no: 2 of 7 | License<br>-——————————————————————————-<br>As noted in the Intel(R) Software Development Product End User License<br>Agreement, the Intel(R) Software Development Product you install will send Intel<br>the products serial number and other system information to help Intel improve<br>the product and validate license compliance. No personal information will be<br>transmitted.<br>-——————————————————————————-<br>To continue with the installation of this product you are required to accept<br>the terms and conditions of the End User License Agreement (EULA). The EULA<br>is displayed using the “more” utility. Press the spacebar to advance to the<br>next page or enter “q” to skip to the end. After reading the EULA, you must<br>enter “accept” to continue the installation or “decline” to return to the<br>previous menu.<br>-——————————————————————————-<br>IMPORTANT - READ BEFORE COPYING, INSTALLING OR USING.<br>Do not copy, install, distribute, public display, or use the Materials provided<br>under this license agreement (“Agreement”), until you have carefully read the<br>following terms and conditions.</p>
<p>By copying, installing, distributing, publicly displaying, or otherwise using<br>the Materials, you agree to be bound by the terms of this Agreement.<br>If you do not agree to the terms of this Agreement, do not copy,<br>install, distribute, publicly display, or use the Materials.</p>
<p>End User License Agreement for the Intel(R) Software Development Products<br>(Version May 2012)</p>
<ol>
<li><pre><code>LICENSE DEFINITIONS:
</code></pre>
</li>
</ol>
<p>A.	“Materials” are defined as the software, documentation, license key<br>codes (if applicable) and other materials, including any updates and upgrade<br>thereto, that are provided to you under this Agreement.  Materials also<br>include the Redistributables, Cluster OpenMP Library, and Sample Source<br>as defined below.</p>
<p>B.	“Redistributables” are the files listed in the following text files that<br>may be included in the Materials for the applicable Intel Software Development<br>Product: clredist.txt, credist.txt, fredist.txt, redist.txt, redist-rt.txt.</p>
<p>C.	“Cluster OpenMP Library”, is comprised of the files listed in the<br>“clredist.txt” file specified above, is the Intel(R) Cluster OpenMP* Library<br>add-on option to the Intel(R) C++ Compiler for Linux* and<br>Intel(R) Fortran Compiler for Linux* products (“Intel Compiler for Linux”).<br>The use of the Cluster OpenMP Library is conditioned on having a valid license<br>from Intel for the Cluster OpenMP Library and for either Intel(R) C++ Compiler<br>for Linux or Intel(R) Fortran Compiler for Linux, and further is governed by the<br>terms and conditions of the license agreement for applicable the Intel Compiler<br>for Linux.</p>
<p>D.	“Source Code” is defined as the Materials provided in human readable<br>format, and includes modification that you make or are made on your behalf.  </p>
<p>E.	“Sample Source” is the Source Code file(s) that: (i) demonstrate certain<br>limited functions included in the binary libraries of the Intel(R) Integrated<br>Performance Primitives (“Intel(R) IPPs”); (ii) are identified as Intel IPP<br>sample source code; (iii) are obtained separately from Intel after you register<br>your copy of the Intel(R) IPPs product with Intel; and (iv) are subject to all<br>of the terms and conditions of this Agreement.</p>
<p>F.	“Microsoft Platforms” means any current and future Microsoft operating<br>system products, Microsoft run-time technologies (such as the .NET Framework),<br>and Microsoft application platforms<br>(such as Microsoft Office or Microsoft Dynamics) that Microsoft offers.</p>
<ol start="2">
<li><pre><code>LICENSE GRANT:
</code></pre>
</li>
</ol>
<p>A.	Subject to all of the terms and conditions of this Agreement,<br>Intel Corporation (“Intel”) grants to you a non-exclusive, non-assignable,<br>copyright license to use the Materials. </p>
<p>B.	Subject to all of the terms and conditions of this Agreement, Intel<br>grants to you a non-exclusive, non-assignable copyright license to modify the<br>Materials, or any portions thereof, that are (i) provided in Source Code form<br>or, (ii) are defined as Redistributables and are provided in text form.</p>
<p>C.	Subject to all of the terms and conditions of this Agreement and any<br>specific restrictions which may appear in the Redistributables text files, Intel<br>grants to you a non-exclusive, non-assignable, fully-paid copyright license to<br>distribute (except if you received the Materials under an Evaluation License<br>as specified below) the Redistributables, including any modifications pursuant<br>to Section 2.B, or any portions thereof, as part of the product or application<br>you developed using the Materials.  If such application is a software<br>development library, then attribution, as specified in the product release notes<br>of the corresponding Materials shall be displayed prominently in that product’s<br>or application’s associated documentation and on the product or application’s<br>web site (if any). </p>
<ol start="3">
<li><pre><code>LICENSE RESTRICTIONS:
</code></pre>
</li>
</ol>
<p>A.	If you receive your first copy of the Materials electronically, and a<br>second copy on media, then you may use the second copy only in accordance with<br>your applicable license stated in this Agreement, or for backup or archival<br>purposes.  You may not provide the second copy to another user.</p>
<p>B.	You may NOT:  (i) use, copy, distribute, or publicly display the<br>Materials except as provided in this Agreement; (ii) rent or lease the Materials<br>to any third party; (iii) assign this Agreement or transfer the Materials<br>without the express written consent of Intel; (iv) modify, adapt, or translate<br>the Materials in whole or in part except as provided in this Agreement;<br>(v) reverse engineer, decompile, or disassemble the Materials; (vi) attempt to<br>modify or tamper with the normal function of a license manager that regulates<br>usage of the Materials; (vii) distribute, sublicense or transfer the Source<br>Code form of any components of the Materials or derivatives thereof to any third<br>party except as provided in this Agreement; (viii) distribute Redistributables<br>except as part of a larger program that adds significant primary functionality<br>different from that of the Redistributables; (ix) distribute the<br>Redistributables to run on a platform other than a Microsoft Platform if per the<br>accompanying user documentation the Materials are meant to execute only on a<br>Microsoft Platform; (x) include the Redistributables in malicious, deceptive,<br>or unlawful programs; or (xi) modify or distribute the Source Code of any<br>Redistributable so that any part of it becomes subject to an Excluded License.<br>An “Excluded License” is one that requires, as a condition of use, modification,<br>or distribution, that the licensed software or other software incorporated into,<br>derived from or distributed with such software (a) be disclosed or distributed<br>in Source Code form; (b) be licensed by the user to third parties for the<br>purpose of making and&#x2F;or distributing derivative works;<br>or (c) be redistributable at no charge.  Open source software includes, without<br>limitation, software licensed or distributed under any of the<br>following licenses or distribution models, or licenses or distribution models<br>substantially similar to any of the following: (a) GNU’s General Public License<br>(GPL) or Lesser&#x2F;Library GPL (LGPL), (b) the Artistic License (e.g., PERL),<br>(c) the Mozilla Public License, (d) the Netscape Public License, (e) the Sun<br>Community Source License (SCSL), (f) the Sun Industry Source License (SISL),<br>and (g) the Common Public License (CPL).</p>
<p>C.	The scope and term of your license depends on the type of license you<br>are provided by Intel.  The variety of license types are set forth below, which<br>may not be available for all “Intel(R) Software Development Products” and<br>therefore may not apply to the Materials.  For more information on the types of<br>licenses, please contact Intel or your sales representative.</p>
<p>i.	PRE-RELEASE LICENSE:  If you are using the Materials under the control<br>of a pre-release license, (a) the Materials are deemed to be pre-release code<br>(e.g., alpha or beta release, etc), which may not be fully functional and which<br>Intel may substantially modify in development of a  commercial version, and for<br>which Intel makes no assurances that it will ever develop or make generally<br>available a commercial version, and (b) if you are an individual, you have the<br>right to use the Materials only for the duration of the pre-release term, which<br>is specified in the Materials, or until the commercial release, if any, of the<br>Materials, whichever is shorter.  You may install copies of the Materials on an<br>unlimited number of computers provided that you are the only individual using<br>the Materials and only one copy of the Materials is in use at any one time.<br>A separate license is required for each additional use and&#x2F;or individual user<br>in all other cases, including without limitation, use by persons, computer<br>systems, and other use methods known now and in the future.  If you are an<br>entity, Intel grants you the right to designate one individual within your<br>organization to have the sole right to use the Materials in the manner<br>specified provided above.</p>
<p>ii.	EVALUATION LICENSE: If you are using the Materials under the control<br>of an evaluation license, you as an individual may use the Materials only for<br>internal evaluation purposes and only for the term of the evaluation, which<br>may be controlled by the license key code for the Materials.<br>NOTWITHSTANDING ANYTHING TO THE CONTRARY ELSEWHERE IN THIS<br>AGREEMENT, YOU MAY NOT DISTRIBUTE ANY PORTION OF THE MATERIALS, AND THE<br>APPLICATION AND&#x2F;OR PRODUCT DEVELOPED BY YOU MAY ONLY BE USED FOR<br>EVALUATION PURPOSES AND ONLY FOR THE TERM OF THE EVALUATION.  You may<br>install copies of the Materials on a reasonable number of computers to conduct<br>your evaluation provided that you are the only individual using the Materials<br>and only one copy of the Materials is in use at any one time.  A separate<br>license is required for each additional use and&#x2F;or individual user in all other<br>cases, including without limitation, use by persons, computer systems, and other<br>use methods known now and in the future.  Intel may provide you with a license<br>code key that enables the Materials for an evaluation license.  If you are an<br>entity, Intel grants you the right to designate one individual within your<br>organization to have the sole right to use the Materials in the manner<br>provided above.</p>
<p>iii.	NONCOMMERCIAL-USE LICENSE:  If you are using the Materials under the<br>control of a noncommercial-use license, if you are an individual, you as an<br>individual may use the Materials only for non-commercial use where you receive<br>no fee, salary or any other form of compensation.  The Materials may not be used<br>for any other purpose, whether “for profit” or “not for profit.”  Any work<br>performed or produced as a result of use of the Materials cannot be performed<br>or produced for the benefit of other parties for a fee, compensation or any<br>other<br>reimbursement or remuneration.  You may install copies of the Materials on an<br>unlimited number of computers provided that you are the only individual using<br>the Materials and only one copy of the Materials is in use at any one time.<br>A separate license is required for each additional use and&#x2F;or individual user<br>in all other cases, including without limitation, use by persons, computer<br>systems, and other methods of use known now and in the future.  Intel will<br>provide you with a license code key that enables the Materials for a<br>noncommercial-use license.  If you obtained a time-limited noncommercial-use<br>license, the duration (time period) of your license and your ability to use the<br>Materials is limited to the time period of the obtained license, which is<br>controlled by the license key code for the Materials.  If you are an entity,<br>Intel grants you the right to designate one individual within your organization<br>to have the sole right to use the Materials in the manner provided above.</p>
<p>iv.	SINGLE-USER LICENSE: If you are using the Materials under the control<br>of a single-user license, you as an individual may install and use the Materials<br>on an unlimited number of computers provided that you are the only individual<br>using the Materials and only one copy of the Materials is in use at any one<br>time.  A separate license is required for each additional use and&#x2F;or individual<br>user in all other cases, including without limitation, use by persons, computer<br>systems, and other methods of use known now and in the future.  Intel will<br>provide you with a license code key that enables the Materials for a single-user<br>license.  If you obtained a time-limited single-user license, the term of your<br>license and your ability to use the Materials is limited to the specified time<br>period, which is controlled by the license key code for the Materials.  If you<br>are an entity, Intel grants you the right to designate one individual within<br>your organization to have the sole right to use the Materials in the manner<br>provided above.</p>
<p>v.	NODE-LOCKED LICENSE: If you are using the Materials under the control of<br> a node-locked license, you may use the Materials only on a single designated<br>computer by no more than the authorized number of concurrent users.  A separate<br>license is required for each additional concurrent user and use, and&#x2F;or computer<br>systems in all other cases, including without limitation, use by persons,<br>computer systems, and other methods of use known now and in the future.  Intel<br>will provide you with a license code key that enables the Materials for a Node-<br>Locked license up to the authorized number of concurrent users.  If you obtained<br>a time-limited node-locked license, the term of your license and your ability to<br>use the Materials is limited to the specified time, which is controlled by the<br>license key code for the Materials.</p>
<p>vi.	FLOATING LICENSE: If you are using the Materials under the control of a<br>floating license, you may (a) install the Materials on an unlimited number of<br>computers that are connected to the designated network and (b) use the Material<br>by no more than the authorized number of concurrent individual users.<br>A separate license is required for each additional concurrent individual user<br>and each additional use by a computer system and&#x2F;or network on which the<br>Materials are used. You understand that you must obtain a  separate license for<br>every and any use of the Materials under a floating license, regardless of<br>whether such use is, without limitation, by persons, computer systems, and other<br>methods of use known now and in the future.  Intel will provide you with a<br>license code key that enables the Materials for a floating license up to the<br>authorized number of concurrent users.  If you obtained a time-limited Floating<br>license, the duration (time period) of your license and your ability to use the<br>Materials is limited to the time period of the obtained license, which is<br>controlled by the license key code for the Materials.  Intel Library Floating<br>License: If the Materials are the Intel(R) Math Kernel Library or the Intel(R)<br>Integrated Performance Primitives Library or the Intel(R) Threading Building<br>Blocks (either “Intel Library”), then the Intel Library is provided to you as an<br>add-on option to either the Intel(R) C++ Compiler product or the Intel(R)<br>Fortran Compiler product (either, an “Intel Compiler”) for which you have a<br>Floating license, and as such, in addition to the terms and conditions above,<br>the Intel Library may only be used by the authorized concurrent users (as noted<br>above) of that Intel Compiler Floating license.</p>
<p>D.	DISTRIBUTION:  Distribution of the Redistributables is also subject to<br>the following limitations:  You (i) shall be solely responsible to your<br>customers for any update or support obligation or other liability which may<br>arise from the distribution, (ii) shall not make any statement that your product<br>is “certified”, or that its performance is guaranteed, by Intel, (iii) shall not<br>use Intel’s name or trademarks to market your product without written<br>permission, (iv) shall use a license agreement that prohibits disassembly and<br>reverse engineering of the Redistributables, (v) shall indemnify, hold harmless,<br>and defend Intel and its suppliers from and against any claims or lawsuits,<br>including attorney’s fees, that arise or result from your distribution of<br>any product.</p>
<p>E.	Intel(R) Integrated Performance Primitives (Intel IPP). The following<br>terms and conditions apply only to the Intel IPP.</p>
<p>i.	Notwithstanding anything in this Agreement to the contrary, if you<br>implement the Sample Sources in your application or if you use Intel IPP to<br>implement algorithms that are protected by others’ licenses then you may need<br>additional licenses from various entities. Should any such additional licenses<br>be required, you are solely responsible for obtaining any such licenses and<br>agree to obtain any such licenses at your own expense.</p>
<p>ii.	Notwithstanding anything herein to the contrary, a valid license to<br>Intel IPP is a prerequisite to any license for Sample Source, and possession of<br>Sample Source does not grant any license to Intel IPP (or any portion thereof).<br>To access Sample Source, you must first register your licensed copy of the Intel<br>IPP with Intel.  By downloading, installing or copying any Sample Source file,<br>you agree to be bound by terms of this Agreement.</p>
<p>F.	SOFTWARE TRANSFER:  Except for Pre-Release Licenses or Evaluation<br>Licenses or Non-Commercial Licenses, as specified above, you may permanently<br>transfer the Materials you received pursuant to a license type listed in<br>Section 3(C) above, and all of your rights under this Agreement, to another<br>party (“Recipient”) solely in conjunction with a change of ownership, merger,<br>acquisition, sale or transfer of all, substantially all or any part of your<br>business or assets or otherwise, either voluntarily, by operation of law of<br>otherwise subject to the following: You must notify Intel of the transfer by<br>sending a letter to Intel (i) identifying the legal entities of Recipient and<br>you, (ii) identifying the Materials (i.e., the specific Intel software products)<br>and the associated serial numbers to be transferred, (iii) certifying that you<br>retain no copies of the Materials, (iv) certifying that the Recipient has agreed<br>in writing to be bound by all of the terms and conditions of this Agreement, (v)<br>certifying that the Recipient has been notified that in order to receive support<br>from Intel for the Materials they must notify Intel in writing of the transfer<br>and provide Intel with the information specified in subsection (ii) above along<br>with the name and email address of the individual assigned to use the Materials,<br>and (vi) providing your email address so that we may confirm receipt of your<br>letter.  Please send such letter to:</p>
<p>Intel Corporation<br>2111 NE 25th Avenue<br>Hillsboro, OR 97124<br>Attn: DPD Contracts Management, JF1-15</p>
<ol start="4">
<li><pre><code>COPYRIGHT: Title to the Materials, modifications thereto provided by 
</code></pre>
<p>Intel and all copies thereof remain with Intel or its suppliers.  The Materials<br>are protected by intellectual property rights, including without limitation,<br>United States copyright laws and international treaty provisions.  You will not<br>remove any copyright or other proprietary notice from the Materials.  You agree<br>to prevent any unauthorized copying of the Materials.  Except as expressly<br>provided herein, no license or right is granted to you directly or by<br>implication, inducement, estoppel or otherwise; specifically Intel does not<br>grant any express or implied right to you under Intel patents, copyrights,<br>trademarks, or trade secrets.</p>
</li>
<li><pre><code>NO WARRANTY, NO SUPPORT AND LIMITED REPLACEMENT:  THE MATERIALS AND 
</code></pre>
<p>INFORMATION ARE PROVIDED “AS IS” WITH NO WARRANTIES, EXPRESS OR IMPLIED. INTEL<br>SPECIFICALLY DISCLAIMS ANY AND ALL WARRANTIES, INCLUDING WITHOUT LIMITATION,<br>ANY IMPLIED WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE,<br>NON-INFRINGEMENT OF INTELLECTUAL PROPERTY RIGHTS, OR ANY WARRANTY OTHERWISE<br>ARISING OUT OF ANY PROPOSAL, SPECIFICATION, OR SAMPLE.  If the media on which<br>the Materials are furnished are found to be defective in material or workmanship<br>under normal use for a period of ninety (90) days from the date of receipt,<br>Intel’s entire liability and your exclusive remedy shall be the replacement of<br>the media.  This offer is void if the media defect results from accident, abuse,<br>or misapplication.</p>
</li>
</ol>
<p>Intel may make changes to the Materials, or to items referenced therein, at any<br>time without notice, but is not obligated to support, update or provide training<br>for the Materials. Intel may in its sole discretion offer such support, update<br>or training services under separate terms at Intel’s then-current rates. You may<br>request additional information on Intel’s service offerings from an Intel sales<br>representative.</p>
<ol start="6">
<li><pre><code>LIMITATION OF LIABILITY:  NEITHER INTEL NOR ITS SUPPLIERS SHALL BE 
</code></pre>
<p>LIABLE FOR ANY DAMAGES WHATSOEVER (INCLUDING, WITHOUT LIMITATION, DAMAGES FOR<br>LOSS OF BUSINESS PROFITS, BUSINESS INTERRUPTION, LOSS OF BUSINESS INFORMATION,<br>OR OTHER LOSS) ARISING OUT OF THE USE OF OR INABILITY TO USE THE SOFTWARE, EVEN<br>IF INTEL HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGES.  BECAUSE SOME<br>JURISDICTIONS PROHIBIT THE EXCLUSION OR LIMITATION OF LIABILITY FOR<br>CONSEQUENTIAL OR INCIDENTAL DAMAGES, THE ABOVE LIMITATION MAY NOT APPLY TO<br>YOU.</p>
</li>
<li><pre><code>UNAUTHORIZED USE:  THE MATERIALS ARE NOT DESIGNED, INTENDED, OR 
</code></pre>
<p>AUTHORIZED FOR USE IN ANY TYPE OF SYSTEM OR APPLICATION IN WHICH THE FAILURE OF<br>THE MATERIALS COULD CREATE A SITUATION WHERE PERSONAL INJURY OR DEATH MAY OCCUR<br>(e.g.,  MEDICAL SYSTEMS, LIFE SUSTAINING OR LIFE SAVING SYSTEMS).  Should you<br>use the Materials for any such unintended or unauthorized use, you hereby<br>indemnify, defend, and hold Intel and its officers, subsidiaries and affiliates<br>harmless against all claims, costs, damages, and expenses, and reasonable<br>attorney fees arising out of, directly or indirectly, such use and any claim of<br>product liability, personal injury or death associated with such unintended or<br>unauthorized use, even if such claim alleges that Intel was negligent regarding<br>the design or manufacture of the Materials.</p>
</li>
<li><pre><code>USER SUBMISSIONS:  This Agreement does not obligate you to provide Intel
</code></pre>
<p>with materials, information, comments, suggestions or other communication<br>regarding the Materials.  However, you agree that any material, information,<br>comments, suggestions or other communication you transmit or post to an Intel<br>website (including but not limited to, submissions to the Intel Premier Support<br>and&#x2F;or other customer support websites or online portals) or provide to Intel<br>under this Agreement related to the features, functions, performance or use<br>of the Materials are deemed non-confidential and non-proprietary<br>(“Communications”).  Intel will have no obligations with respect to the<br>Communications.  You hereby grant to Intel a non-exclusive, perpetual,<br>irrevocable, royalty-free, copyright license to copy, modify, create derivative<br>works, publicly display, disclose, distribute, license and sublicense through<br>multiple tiers of distribution and licensees, incorporate and otherwise use the<br>Communications and all data, images, sounds, text, and other things embodied<br>therein, including derivative works thereto, for any and all commercial or<br>non-commercial purposes. You are prohibited from posting or transmitting to or<br>from an Intel website or provide to Intel any unlawful, threatening, libelous,<br>defamatory, obscene, pornographic, or other material that would violate any law.<br>If you wish to provide Intel with information that you intend to be treated as<br>confidential information, Intel requires that such confidential information be<br>provided pursuant to a non-disclosure agreement (“NDA”), so please contact your<br>Intel representative to ensure the proper NDA is in place.</p>
</li>
</ol>
<p>Nothing in this Agreement will be construed as preventing Intel from reviewing<br>your Communications and errors or defects in Intel products discovered while<br>reviewing your Communications. Furthermore, nothing in this Agreement will be<br>construed as preventing Intel from implementing independently-developed<br>enhancements to Intel’s own error diagnosis methodology to detect errors or<br>defects in Intel products discovered while reviewing your Communications or to<br>implement bug fixes or enhancements in Intel products. The foregoing may include<br>the right to include your Communications in regression test suites. </p>
<ol start="9">
<li><pre><code>CONSENT.  You agree that Intel, its subsidiaries or suppliers may 
</code></pre>
<p>collect and use technical and related information, including but not limited to<br>technical information about your computer, system and application software, and<br>peripherals, that is gathered periodically to facilitate the provision of<br>software updates, product support and other services to you (if any) related to<br>the Materials, and to verify compliance with the terms of this Agreement.  Intel<br>may use this information, as long as it is in a form that does not personally<br>identify you, to improve our products or to develop and provide services or<br>technologies to you.</p>
</li>
<li><pre><code>TERMINATION OF THIS LICENSE: This Agreement becomes effective on the 
</code></pre>
<p>date you accept this Agreement and will continue until terminated as provided<br>for in this Agreement.  If you are using the Materials under the control of a<br>time-limited license, for example an Evaluation License, this Agreement<br>terminates without notice on the last day of the time period, which is specified<br>in the Materials, and&#x2F;or controlled by the license key code for the Materials.<br>Intel may terminate this license immediately if you are in breach of any of its<br>terms and conditions and such breach is not cured within thirty (30) days of<br>written notice from Intel.  Upon termination, you will immediately return to<br>Intel or destroy the Materials and all copies thereof.  In the event of<br>termination of this Agreement, the license grant to any Redistributables<br>distributed by you in accordance with the terms and conditions of this<br>Agreement, prior to the effective date of such termination, shall survive any<br>such termination of this Agreement</p>
</li>
<li><pre><code>U.S. GOVERNMENT RESTRICTED RIGHTS: The technical data and computer 
</code></pre>
<p>software covered by this license is a “Commercial Item,” as such term is defined<br>by the FAR 2.101 (48 C.F.R. 2.101) and is “commercial computer software” and<br>“commercial computer software documentation” as specified under FAR 12.212<br>(48 C.F.R. 12.212) or DFARS 227.7202 (48 C.F.R. 227.7202), as applicable. This<br>commercial computer software and related documentation is provided to end users<br>for use by and on behalf of the U.S. Government, with only those rights as are<br>granted to all other end users pursuant to the terms and conditions herein. Use<br>for or on behalf of the U.S. Government is permitted only if the party acquiring<br>or using this software is properly authorized by an appropriate U.S. Government<br>official. This use by or for the U.S. Government clause is in lieu of, and<br>supersedes, any other FAR, DFARS, or other provision that addresses Government<br>rights in the computer software or documentation covered by this license.  All<br>copyright licenses granted to the U.S. Government are coextensive with the<br>technical data and computer software licenses granted herein. The U.S.<br>Government shall only have the right to reproduce, distribute, perform, display,<br>and prepare derivative works as needed to implement those rights.</p>
</li>
<li><pre><code>GENERAL PROVISIONS
</code></pre>
</li>
</ol>
<p>A.	ENTIRE AGREEMENT: This Agreement is intended to be the entire agreement<br>between you and Intel with respect to matters contained herein, and supersedes<br>all prior or contemporaneous agreements and negotiations with respect to those<br>matters.  No waiver of any breach or default shall constitute a waiver of any<br>subsequent breach or default.  If any provision of this Agreement is determined<br>by a court to be unenforceable, you and Intel will deem the provision to be<br>modified to the extent necessary to allow it to be enforced to the extent<br>permitted by law, or if it cannot be modified, the provision will be severed and<br>deleted from this Agreement, and the remainder of the Agreement will continue in<br>effect.  Any change, modification or waiver to this Agreement must be in writing<br>and signed by an authorized representative of you and an officer (or delegate)<br>of Intel, and must specifically identify this Agreement by its title (e.g.,<br>“End User License Agreement for the Intel(R) Software Development Products”) and<br>version, i.e., May 2012).</p>
<p>B.	APPLICABLE LAWS: Any claim arising under or relating to this Agreement<br>shall be governed by the internal substantive laws of the State of Delaware,<br>without regard to principles of conflict of laws.  You agree that the terms of<br>the United Nations Convention on Contracts for the Sale of Goods do not apply<br>to this Agreement. You agree that your distribution and export&#x2F;re-export of the<br>Software and permitted modifications shall be in compliance with the laws,<br>regulations, orders or other restrictions of applicable export laws.</p>
<ol start="13">
<li><pre><code>THIRD PARTY PROGRAMS.  The Materials may include third party programs 
</code></pre>
or materials that are governed by the third party’s license terms, including<br>without limitation, open source software.  The license terms associated with<br>such third party programs or materials govern your use of same, and Intel is<br>not liable for such third party programs or materials.</li>
</ol>
<ul>
<li>Other names and brands may be claimed as the property of others</li>
</ul>
<p>-——————————————————————————-<br>Do you agree to be bound by the terms and conditions of this license agreement?<br>Type “accept” to continue or “decline” to back to the previous menu:  <font color=red><strong>accept</strong></font> </p>
<h2 id="选择激活方式，选择4使用激活文件"><a href="#选择激活方式，选择4使用激活文件" class="headerlink" title="选择激活方式，选择4使用激活文件"></a>选择激活方式，选择4使用激活文件</h2><p>Step no: 3 of 7 | Activation<br>-——————————————————————————-<br>If you have purchased this product and have the serial number and a connection<br>to the internet you can choose to activate the product at this time. Activation<br>is a secure and anonymous one-time process that verifies your software licensing<br>rights to use the product. Alternatively, you can choose to evaluate the<br>product or defer activation by choosing the evaluate option. Evaluation software<br>will time out in about one month. Also you can use license file, license<br>manager, or remote activation if the system you are installing on does not<br>have internet access activation options.<br>-——————————————————————————-</p>
<ol>
<li>Use existing license [default]</li>
<li>I want to activate my product using a serial number</li>
<li>I want to evaluate my product or activate later </li>
<li>I want to activate either remotely, or by using a license file, or by using a<br>license manager</li>
</ol>
<p>h. Help<br>b. Back to the previous menu<br>q. Quit<br>-——————————————————————————-<br>Please type a selection or press “Enter” to accept default choice [1]: <font color=red>4</font> </p>
<h2 id="指定license文件"><a href="#指定license文件" class="headerlink" title="指定license文件"></a>指定license文件</h2><p>Step no: 3 of 7 | Activation &gt; Advanced activation<br>-——————————————————————————-<br>You can use license file, license manager, or the system you are installing on<br>does not have internet access activation options.<br>-——————————————————————————-</p>
<ol>
<li>Use a different computer with internet access [default]</li>
<li>Use a license file</li>
<li>Use a license server</li>
</ol>
<p>h. Help<br>b. Back to the previous menu<br>q. Quit<br>-——————————————————————————-<br>Please type a selection or press “Enter” to accept default choice [1]:  <font color=red><strong>2</strong></font><br>Note: Press “Enter” key to back to the previous menu.<br>Please type the full path to your license file(s):<font color=red><strong>&#x2F;root&#x2F;intel_eval.lic</strong></font><br>-——————————————————————————-<br>Activation completed successfully.<br>-——————————————————————————-<br>Press “Enter” key to continue:  <font color=red><strong>回车</strong></font></p>
<h2 id="是否加入改进，2为不加入"><a href="#是否加入改进，2为不加入" class="headerlink" title="是否加入改进，2为不加入"></a>是否加入改进，2为不加入</h2><p>Step no: 4 of 7 | Intel(R) Software Improvement Program<br>-——————————————————————————-<br>Help improve your experience with Intel(R) software</p>
<p>Participate in the design of future Intel software. Select ‘Yes’ to give us<br>permission to learn about how you use your Intel software and we will do the<br>rest.<br>    - No Personal contact information is collected<br>    - There are no surveys or additional follow-up emails by opting in<br>    - You can stop participating at any time</p>
<pre><code>Learn more about Intel(R) Software Improvement Program
http://software.intel.com/en-us/articles/software-improvement-program
</code></pre>
<p>With your permission, Intel may automatically receive anonymous information<br>about how you use your current and future Intel software.<br>-——————————————————————————-</p>
<ol>
<li>Yes, I am willing to participate and improve Intel software. (Recommended)</li>
<li>No, I don’t want to participate in the Intel(R) Software Improvement Program<br>at this time.</li>
</ol>
<p>b. Back to the previous menu<br>q. Quit<br>-——————————————————————————-<br>Please type a selection: <font color=red>2</font></p>
<h2 id="最后一次确认安装路径，可修改"><a href="#最后一次确认安装路径，可修改" class="headerlink" title="最后一次确认安装路径，可修改"></a>最后一次确认安装路径，可修改</h2><p>Step no: 5 of 7 | Options<br>-——————————————————————————-<br>You are now ready to begin installation. You can use all default installation<br>settings by simply choosing the “Start installation Now” option or you can<br>customize these settings by selecting any of the change options given below<br>first. You can view a summary of the settings by selecting<br>“Show pre-install summary”.<br>-——————————————————————————-</p>
<ol>
<li><p>Start installation Now</p>
</li>
<li><p>Change install directory      [ &#x2F;opt&#x2F;intel ]</p>
</li>
<li><p>Change components to install  [ Custom ]</p>
</li>
<li><p>Change advanced options</p>
</li>
<li><p>Show pre-install summary</p>
</li>
</ol>
<p>h. Help<br>b. Back to the previous menu<br>q. Quit<br>-——————————————————————————-<br>Please type a selection or press “Enter” to accept default choice [1]: <font color=red>回车</font></p>
<h2 id="检测安装环境，跳过即可"><a href="#检测安装环境，跳过即可" class="headerlink" title="检测安装环境，跳过即可"></a>检测安装环境，跳过即可</h2><p>Step no: 5 of 7 | Options &gt; Missing Optional Pre-requisite(s)<br>-——————————————————————————-<br>There are one or more optional unresolved issues. It is highly recommended to<br>resolve them all before you continue the installation. You can fix them without<br>exiting from the installation and re-check. Or you can quit from the<br>installation, fix them and run the installation again.<br>-——————————————————————————-<br>Missing optional pre-requisites<br>– Intel(R) Composer XE 2013 Update 2 for Linux*: No compatible Java* Runtime<br>Environment (JRE) found<br>-——————————————————————————-</p>
<ol>
<li>Skip missing optional pre-requisites [default]</li>
<li>Show the detailed info about issue(s)</li>
<li>Re-check the pre-requisites</li>
</ol>
<p>h. Help<br>b. Back to the previous menu<br>q. Quit<br>-——————————————————————————-<br>Please type a selection or press “Enter” to accept default choice [1]: <font color=red>回车</font></p>
<h2 id="开始安装-1"><a href="#开始安装-1" class="headerlink" title="开始安装"></a>开始安装</h2><p>Step no: 6 of 7 | Installation<br>-——————————————————————————-<br>Each component will be installed individually. If you cancel the installation,<br>components that have been completely installed will remain on your system. This<br>installation may take several minutes, depending on your system and the options<br>you selected.<br>-——————————————————————————-<br>Installing Intel Debugger 13.0 on Intel(R) 64 component… done<br>-——————————————————————————-<br>Finalizing installation… done<br>-——————————————————————————-</p>
<h2 id="安装完成"><a href="#安装完成" class="headerlink" title="安装完成"></a>安装完成</h2><p>Step no: 7 of 7 | Complete<br>-——————————————————————————-<br>Thank you for installing and using the<br>Intel(R) Parallel Studio XE 2013 Update 2 for Linux*</p>
<p>Reminder: Intel(R) VTune(TM) Amplifier XE users must be members of the “vtune”<br>permissions group in order to use Event-based Sampling.</p>
<p>To register your product purchase, visit<br><a href="https://registrationcenter.intel.com/RegCenter/registerexpress.aspx?media=5G9">https://registrationcenter.intel.com/RegCenter/registerexpress.aspx?media=5G9</a></p>
<p>To get started using Intel(R) VTune(TM) Amplifier XE 2013 Update 4:<br>    - To set your environment variables: source<br>&#x2F;opt&#x2F;intel&#x2F;vtune_amplifier_xe_2013&#x2F;amplxe-vars.sh<br>    - To start the graphical user interface: amplxe-gui<br>    - To use the command-line interface: amplxe-cl<br>    - For more getting started resources: &#x2F;opt&#x2F;intel&#x2F;vtune_amplifier_xe_2013&#x2F;<br>      documentation&#x2F;en&#x2F;welcomepage&#x2F;get_started.html.<br>To get started using Intel(R) Inspector XE 2013 Update 4:<br>    - To set your environment variables: source<br>&#x2F;opt&#x2F;intel&#x2F;inspector_xe_2013&#x2F;inspxe-vars.sh<br>    - To start the graphical user interface: inspxe-gui<br>    - To use the command-line interface: inspxe-cl<br>    - For more getting started resources: &#x2F;opt&#x2F;intel&#x2F;inspector_xe_2013&#x2F;<br>      documentation&#x2F;en&#x2F;welcomepage&#x2F;get_started.html.<br>To get started using Intel(R) Advisor XE 2013 Update 2:<br>    - To set your environment variables: source<br>&#x2F;opt&#x2F;intel&#x2F;advisor_xe_2013&#x2F;advixe-vars.sh<br>    - To start the graphical user interface: advixe-gui<br>    - To use the command-line interface: advixe-cl<br>    - For more getting started resources: &#x2F;opt&#x2F;intel&#x2F;advisor_xe_2013&#x2F;<br>      documentation&#x2F;en&#x2F;welcomepage&#x2F;get_started.html.<br>To get started using Intel(R) Composer XE 2013 Update 2 for Linux*:<br>    - Set the environment variables for a terminal window using one of the<br>      following (replace “intel64” with “ia32” if you are using a 32-bit<br>      platform).<br>      For csh&#x2F;tcsh:<br>           $ source &#x2F;opt&#x2F;intel&#x2F;bin&#x2F;compilervars.csh intel64<br>      For bash:<br>           $ source &#x2F;opt&#x2F;intel&#x2F;bin&#x2F;compilervars.sh intel64<br>      To invoke the installed compilers:<br>           For C++: icpc<br>           For C: icc<br>           For Fortran: ifort</p>
<pre><code>  To get help, append the -help option or precede with the man command.
- For more getting started resources:
       /opt/intel/composer_xe_2013/Documentation/en_US/get_started_lc.htm.
       /opt/intel/composer_xe_2013/Documentation/en_US/get_started_lf.htm.

  
</code></pre>
<p>To view movies and additional training, visit<br><a href="http://www.intel.com/software/products">http://www.intel.com/software/products</a>.</p>
<p>-——————————————————————————-<br>q. Quit [default]<br>-——————————————————————————-<br>Please type a selection or press “Enter” to accept default choice [q]: <font color=red>回车</font></p>
<h2 id="设置环境变量"><a href="#设置环境变量" class="headerlink" title="设置环境变量"></a>设置环境变量</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm00 parallel_studio_xe_2013_update2_intel64]# source /opt/intel/bin/compilervars.sh intel64</span><br><span class="line">将此行内容加入到/etc/profile中，否则重启后失效</span><br></pre></td></tr></table></figure>
<h2 id="验证安装的正确性"><a href="#验证安装的正确性" class="headerlink" title="验证安装的正确性"></a>验证安装的正确性</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm00 parallel_studio_xe_2013_update2_intel64]# icc -v</span><br><span class="line">icc version 13.1.0 (gcc version 4.4.7 compatibility)</span><br></pre></td></tr></table></figure>

<p>参考链接：<a href="http://www.cnblogs.com/iDove/p/4103231.html">http://www.cnblogs.com/iDove/p/4103231.html</a></p>
]]></content>
      <categories>
        <category>HPC</category>
      </categories>
      <tags>
        <tag>Intel</tag>
      </tags>
  </entry>
  <entry>
    <title>JDK环境变量配置</title>
    <url>/arlo/3f60947a/</url>
    <content><![CDATA[<h1 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h1><p>我的jdk安装在 C:\Program Files\Java\jdk1.8.0_202 目录下，以下为配置过程：<br>1.我的电脑-（右键）属性-高级系统设置-高级-环境变量<br>2.系统变量-新建</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">变量名：JAVA_HOME</span><br><span class="line">变量值：C:\Program Files\Java\jdk1.8.0_202</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">变量名：CLASSPATH</span><br><span class="line">变量值：%JAVA_HOME%\lib\tools.jar;%JAVA_HOME%\lib\dt.jar</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">变量名：Path</span><br><span class="line">变量值：C:\Program Files (x86)\Intel\iCLS Client\;C:\Program Files\Intel\iCLS Client\;%SystemRoot%\system32;%SystemRoot%;%SystemRoot%\System32\Wbem;%SYSTEMROOT%\System32\WindowsPowerShell\v1.0\;C:\Program Files (x86)\Intel\OpenCL SDK\2.0\bin\x86;C:\Program Files (x86)\Intel\OpenCL SDK\2.0\bin\x64;C:\Program Files\Intel\Intel(R) Management Engine Components\DAL;C:\Program Files\Intel\Intel(R) Management Engine Components\IPT;C:\Program Files (x86)\Intel\Intel(R) Management Engine Components\DAL;C:\Program Files (x86)\Intel\Intel(R) Management Engine Components\IPT;E:\Program Files\TortoiseSVN\bin;%JAVA_HOME%\bin;%JAVA_HOME%\jre\bin</span><br></pre></td></tr></table></figure>
<h1 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h1><p>编辑&#x2F;etc&#x2F;profile 文件，在文件最后添加以下内容</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">export JAVA_HOME=/usr/local/jdk1.8.0_202/</span><br><span class="line">export CLASSPATH=.:$JAVA_HOME/lib/:$JAVA_HOME/jre/lib/</span><br><span class="line">export PATH=$JAVA_HOME/bin:$PATH</span><br></pre></td></tr></table></figure>
<p><code>source /etc/profile</code><br><font color=red><strong>保留系统以前自己配置的项，不要动！</strong></font>  </p>
]]></content>
      <categories>
        <category>常识</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>常识</tag>
        <tag>Windows</tag>
        <tag>jdk</tag>
      </tags>
  </entry>
  <entry>
    <title>Jenkins使用Publish Over CIFS插件实现静态页面部署到Windows服务器</title>
    <url>/arlo/9a888771/</url>
    <content><![CDATA[<p>发布静态内容操作很简单，一般分两步；一、获取svn内容。二、拷贝到服务器发布目录；<br>以前静态内容都是在Linux环境下使用Nginx发布，持续集成发布的时候<a href="http://wiki.hudson-ci.org/display/HUDSON/SCP+plugin">Hudson SCP publisher plugin</a>,调用linux下Scp命令，通过SSH协议拷贝到发布目录就可以了；<br>最近遇到一个问题，需要发布静态页面到Windows服务器下。不论是IIS，还是Nginx，也都存在一个拷贝内容到发布目录的问题，Windows下采取目录共享方式，通过CIFS协议拷贝。</p>
<span id="more"></span>
<h1 id="共享发布目录"><a href="#共享发布目录" class="headerlink" title="共享发布目录"></a>共享发布目录</h1><p>共享nginx发布目录jzhome<br><img src="/images/2017/1024/01.png" alt="jenkins"></p>
<h1 id="Nginx-配置文件修改"><a href="#Nginx-配置文件修改" class="headerlink" title="Nginx 配置文件修改"></a>Nginx 配置文件修改</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">……</span><br><span class="line"> server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line">        location / &#123;</span><br><span class="line">	    root   html;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">	location /mypic &#123;</span><br><span class="line">	    proxy_pass   http://127.0.0.1:8888/mypic;</span><br><span class="line">	&#125;</span><br><span class="line">	location /JzAir &#123;</span><br><span class="line">	    proxy_pass   http://127.0.0.1:9999/JzAir;</span><br><span class="line">	&#125;</span><br><span class="line">        location /Jzapp &#123;</span><br><span class="line">	    proxy_pass   http://127.0.0.1:8080/Jzapp;</span><br><span class="line">	&#125;</span><br><span class="line">	location /jzhome &#123;</span><br><span class="line">	    root   F:\\deploy\\nginx-1.12.1\\;</span><br><span class="line">	    index  index.html index.htm;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">……</span><br></pre></td></tr></table></figure>
<h1 id="安装Jenkins插件"><a href="#安装Jenkins插件" class="headerlink" title="安装Jenkins插件"></a>安装Jenkins插件</h1><p>安装<a href="https://plugins.jenkins.io/publish-over-cifs">Publish Over CIFS</a>插件，安装完成后重启Jenkins</p>
<h1 id="配置CIFS"><a href="#配置CIFS" class="headerlink" title="配置CIFS"></a>配置CIFS</h1><p>Jenkins-系统管理-系统配置-Publish over CIFS<br><img src="/images/2017/1024/02.png" alt="jenkins"></p>
<h1 id="配置Job"><a href="#配置Job" class="headerlink" title="配置Job"></a>配置Job</h1><p>Job-构建后步骤<br><img src="/images/2017/1024/03.png" alt="jenkins"><br><em>PS:这里有点比较难懂一点，Source files要一个能包含所有发布内容的父级目录，所以当发布内容为abc&#x2F;html&#x2F;xxx,我们在获取svn代码的时候，获取到abc这一层，这里Source files填写html&#x2F;**,Remove prefix填写html,Remote directory为空，就可以将html目录下的所有内容发布到共享服务器上</em><br><img src="/images/2017/1024/04.png" alt="jenkins"><br><img src="/images/2017/1024/05.png" alt="jenkins"></p>
<hr>
]]></content>
      <categories>
        <category>自动化运维</category>
      </categories>
      <tags>
        <tag>Jenkins</tag>
        <tag>运维</tag>
        <tag>自动化</tag>
      </tags>
  </entry>
  <entry>
    <title>Jenkins打包不能发现本地仓库包</title>
    <url>/arlo/d4636f97/</url>
    <content><![CDATA[<p>jenkins里新建了一个maven风格的项目，打包过程中找不到ojdbc的包，然后手动下载，加载到本地仓库中了，jenkins依然提示找不到这个包。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[ERROR] Failed to execute goal on project atmosphere: Could not resolve dependencies for project com.ths:atmosphere:war:0.0.1-SNAPSHOT: Failure to find com.oracle:ojdbc14:jar:10.2.0.4.0 in https://repo.maven.apache.org/maven2 was cached in the local repository, resolution will not be reattempted until the update interval of central has elapsed or updates are forced -&gt; [Help 1]</span><br><span class="line">org.apache.maven.lifecycle.LifecycleExecutionException: Failed to execute goal on project atmosphere: Could not resolve dependencies for project com.ths:atmosphere:war:0.0.1-SNAPSHOT: Failure to find com.oracle:ojdbc14:jar:10.2.0.4.0 in https://repo.maven.apache.org/maven2 was cached in the local repository, resolution will not be reattempted until the update interval of central has elapsed or updates are forced</span><br><span class="line">at org.apache.maven.lifecycle.internal.LifecycleDependencyResolver.getDependencies(LifecycleDependencyResolver.java:221)</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<h1 id="手动加载jar包到本地仓库"><a href="#手动加载jar包到本地仓库" class="headerlink" title="手动加载jar包到本地仓库"></a>手动加载jar包到本地仓库</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/usr/local/apache-maven-3.3.9/bin/mvn install:install-file -DgroupId=com.oracle -DartifactId=ojdbc14 -Dversion=10.2.0.4.0 -Dpackaging=jar -Dfile=/usr/local/src/ojdbc14-10.2.0.4.0.jar</span><br></pre></td></tr></table></figure>
<h1 id="手动maven编译打包"><a href="#手动maven编译打包" class="headerlink" title="手动maven编译打包"></a>手动maven编译打包</h1><p>在工作目录下尝试手动编译打包，可以成功</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/usr/local/apache-maven-3.3.9/bin/mvn compile install package</span><br></pre></td></tr></table></figure>
<p>然后我茫然了，同一台机器，同一个版本的jdk，同一个版本的mvn，同一份代码；本地maven编译打包可以成功，通过jenkins调用maven打包就找不到ojdbc的包，失败了；容我喝杯白开水压压惊！<br>我仔细排查了jenkins里边的配置，maven的全局配置使用的是默认的；maven版本和本地是一样的3.3.9；maven的仓库是默认地址~&#x2F;.m2&#x2F;repository;终于发现问题的所在了，<br><em><strong>原因就是maven的仓库是不一样的；本地执行maven编译打包使用的是root用户，仓库地址为&#x2F;root&#x2F;.m2&#x2F;repository; jenkins程序是以jenkins用户启动起来的，默认的仓库地址为&#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;.m2&#x2F;repository&#x2F;;</strong></em><br>我之前手动导入jar只导入到root用户下的仓库中了；</p>
<h1 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h1><h2 id="直接拷贝jar包到"><a href="#直接拷贝jar包到" class="headerlink" title="直接拷贝jar包到"></a>直接拷贝jar包到</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cp /root/.m2/repository/com/oracle/ojdbc14/10.2.0.4.0/ojdbc14-10.2.0.4.0.jar /var/lib/jenkins/.m2/repository/com/oracle/ojdbc14/10.2.0.4.0/ojdbc14-10.2.0.4.0.jar</span><br></pre></td></tr></table></figure>
<h2 id="修改本地maven仓库的地址"><a href="#修改本地maven仓库的地址" class="headerlink" title="修改本地maven仓库的地址"></a>修改本地maven仓库的地址</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim $MAVEN_HOME/conf/settings.xml</span><br><span class="line"></span><br><span class="line">&lt;localRepository&gt;/path/.m2/repository&lt;/localRepository&gt;</span><br></pre></td></tr></table></figure>
<h1 id="扩展阅读"><a href="#扩展阅读" class="headerlink" title="扩展阅读"></a>扩展阅读</h1><p>maven仓库的优先级别：<em>本地仓库 &gt;profile &gt; pom中的repository &gt; mirror</em><br><a href="http://toozhao.com/2012/07/13/compare-priority-of-maven-repository/">http://toozhao.com/2012/07/13/compare-priority-of-maven-repository/</a>	</p>
]]></content>
      <categories>
        <category>自动化运维</category>
      </categories>
      <tags>
        <tag>Jenkins</tag>
        <tag>运维</tag>
        <tag>自动化</tag>
      </tags>
  </entry>
  <entry>
    <title>Jenkins持续集成发布时tomcat不能删除目录下文件</title>
    <url>/arlo/fd00fe8d/</url>
    <content><![CDATA[<p>使用jenkins自动发布到tomcat时遇到一个问题，发布的时候不能自动删除tomcat下的工程目录，必须关闭tomcat之后，才能删除；提示如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&quot;org.codehaus.cargo.container.tomcat.internal.TomcatManagerException: The Tomcat Manager responded &quot;FAIL - Unable to delete [C:\ths\Tomcat8082-alk\webapps\SuperStation]. The continued presence of this file may cause problems.&quot;</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<p><img src="/images/2017/0829/00.png" alt="jenkins"></p>
<h1 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h1><p>在<Context>元素中增加一个属性antiResourceLocking&#x3D;”true” antiJARLocking&#x3D;”true”，默认是”false”。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;Context reloadable=&quot;true&quot; antiJARLocking=&quot;true&quot; antiResourceLocking=&quot;true&quot;&gt;</span><br></pre></td></tr></table></figure>
<p>实际上，这两个参数就是配置Tomcat的资源锁定和Jar包锁定策略。</p>
<h2 id="antiJARLocking"><a href="#antiJARLocking" class="headerlink" title="antiJARLocking"></a>antiJARLocking</h2><p>先来看看应用的antiJARLocking属性设置为true时，Tomcat是怎么处理的。<br>针对antiJARLocking属性的处理集中在WebappClassLoader的getResource和findResourceInternal方法里，主要原理是将包含在Jar包里的资源抽取放到应用的工作目录（work里应用对应的目录）下去。<br>把这个属性设置为true之后，部署应用就可以在work\Catalina\localhost\struts2-blank\loader目录下看到被解压的Jar包内容。<br>antiJARLocking属性在有的时候并不会生效，从WebappClassLoader的getResource和findResource方法逻辑里可以看出一些端倪，在一些情况下（通过对Loader的delegate、searchExternalFirst等相关属性进行配置），资源的获取并不是WebappClassLoader去做的，而是其父加载器的getResource方法或父类的findResource方法去做的，WebappClassLoader的父类是URLClassLoader、父加载器是URLClassLoader实例。</p>
<h2 id="antiResourceLocking"><a href="#antiResourceLocking" class="headerlink" title="antiResourceLocking"></a>antiResourceLocking</h2><p>当antiResourceLocking设置为true的时候，Tomcat不会锁定应用下的任何文件。那Tomcat是怎么做到这一点的呢？<br>在Tomcat的架构里，应用也是一个级别的容器，对应的接口是Context；各级容器本身都具备生命周期，而且配置了多个生命周期监听器来监听容器不同的生命周期过程。Tomcat在初始化的时候，给Context增加了一个生命周期监听器org.apache.catalina.startup.ContextConfig；然后在Context真正开始启动之前，会有一个BEFORE_START_EVENT状态，ContextConfig监听到这个状态的事件后，就会针对antiResourceLocking进行处理。<br>总结一下，就是如果应用的antiResourceLocking属性设置为true，就将应用的doc base移到临时目录下，让Tomca不会占用webapps下的文件。Tomcat里java.io.tmpdir默认指向Tomcat的temp目录。</p>
<h1 id="副作用"><a href="#副作用" class="headerlink" title="副作用"></a>副作用</h1><p>从上面的分析来看，antiResourceLocking为true有几个副作用：</p>
<ol>
<li>会延长应用的启动时间，因为多了临时目录的清理和往临时目录拷贝应用内容的操作；</li>
<li>如果不知道这个属性的原理，修改webapps下应用的JSP，那就不会动态重加载到新的页面内容了，因为应用的doc base已经不再在webapps下了；</li>
<li>停止Tomcat的时候，临时目录下实际的doc base会被删掉，<br>结合第二条和第三条，如果要修改应用的JSP，那必须将改动同时拷贝到两个目录下（原始doc base和临时目录下的doc base）。<br>所以Tomcat里这个属性缺省为false。在使用Tomcat 6.0.24之前的版本时，如果要用这个属性解决文件被锁的问题，三思而行。</li>
</ol>
<p>参考链接：<a href="http://blog.csdn.net/yanjun008/article/details/41249753">http://blog.csdn.net/yanjun008/article/details/41249753</a></p>
]]></content>
      <categories>
        <category>Troubleshooting</category>
      </categories>
      <tags>
        <tag>Jenkins</tag>
        <tag>运维</tag>
        <tag>自动化</tag>
        <tag>tomcat</tag>
      </tags>
  </entry>
  <entry>
    <title>Jenkins邮件通知配置</title>
    <url>/arlo/c26ec4ea/</url>
    <content><![CDATA[<p>Jenkins<a href="http://islocal.cc/2017/04/27/jenkins-%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">环境搭建</a>完成了,项目自动化编译打包也调通了，但是我们不能保证每次都是正常的，根据自己的情况(构建失败，构建状态不稳定)配置邮件通知是有必要的；这篇文章我采用腾讯qq邮箱来发送，使用公司邮箱来接收；</p>
<h1 id="常用的几种方式"><a href="#常用的几种方式" class="headerlink" title="常用的几种方式"></a>常用的几种方式</h1><ul>
<li>使用内置的邮件插进（使用全局的配置，只能有一个接收方）</li>
<li>使用邮件扩展插件【Email Extension Plugin】（使用全局的配置，能有多个接收方，但是只能有一个发送方）</li>
<li>使用邮件扩展插件【Email Extension Plugin】+Groovy脚本（实现每个Job对应不同的发送邮件，多个发送方）</li>
<li>开发邮件转发中间件或者使用Foxmail这些工具来转发（每个Job发送到对应的邮箱，然后中间件负责转发到成员列表的邮箱。对发送插件没什么要求，只要能发送即可）<br><em>(这篇文章只说一下前两种方式)</em><span id="more"></span></li>
</ul>
<h1 id="使用QQ邮箱发送"><a href="#使用QQ邮箱发送" class="headerlink" title="使用QQ邮箱发送"></a>使用QQ邮箱发送</h1><p>qq授权码设置参考：<a href="http://service.mail.qq.com/cgi-bin/help?subtype=1&amp;&amp;id=28&amp;&amp;no=1001256">http://service.mail.qq.com/cgi-bin/help?subtype=1&amp;&amp;id=28&amp;&amp;no=1001256</a></p>
<h1 id="使用内置的邮件插件"><a href="#使用内置的邮件插件" class="headerlink" title="使用内置的邮件插件"></a>使用内置的邮件插件</h1><h2 id="配置管理员邮件地址"><a href="#配置管理员邮件地址" class="headerlink" title="配置管理员邮件地址"></a>配置管理员邮件地址</h2><p>系统管理–&gt;系统设置–&gt;Jenkins Location<br><img src="/images/2017/0822/03.png" alt="jenkins"></p>
<h2 id="配置邮件通知"><a href="#配置邮件通知" class="headerlink" title="配置邮件通知"></a>配置邮件通知</h2><p>系统管理–&gt;系统设置–&gt;邮件通知–&gt;高级，配置如下：<br><strong>这里密码填写我们神的“qq授权码”</strong><br><img src="/images/2017/0822/00.png" alt="jenkins"></p>
<h2 id="测试邮件提醒"><a href="#测试邮件提醒" class="headerlink" title="测试邮件提醒"></a>测试邮件提醒</h2><p>勾选“通过发送测试邮件测试配置”<br><img src="/images/2017/0822/01.png" alt="jenkins"><br>看到“Email was successfully sent”即为成功，去邮箱里看一下<br><img src="/images/2017/0822/02.png" alt="jenkins"></p>
<h1 id="使用邮件拓展插件"><a href="#使用邮件拓展插件" class="headerlink" title="使用邮件拓展插件"></a>使用邮件拓展插件</h1><p>系统管理–&gt;系统设置–&gt;Extended E-mail Notification<br><img src="/images/2017/0822/04.png" alt="jenkins"><br><img src="/images/2017/0822/05.png" alt="jenkins"></p>
<h2 id="邮件内容配置"><a href="#邮件内容配置" class="headerlink" title="邮件内容配置"></a>邮件内容配置</h2><p>以下是参考<a href="http://blog.csdn.net/wangmuming/article/details/22925357">网上的配置</a>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Default Subject: 构建通知:$PROJECT_NAME - Build # $BUILD_NUMBER - $BUILD_STATUS!  Default Content!</span><br><span class="line">Default Content:</span><br><span class="line">(本邮件是程序自动下发的，请勿回复！)&lt;br/&gt;&lt;hr/&gt;</span><br><span class="line"></span><br><span class="line">项目名称：$PROJECT_NAME&lt;br/&gt;&lt;hr/&gt;</span><br><span class="line"></span><br><span class="line">构建编号：$BUILD_NUMBER&lt;br/&gt;&lt;hr/&gt;</span><br><span class="line"></span><br><span class="line">svn版本号：$&#123;SVN_REVISION&#125;&lt;br/&gt;&lt;hr/&gt;</span><br><span class="line"></span><br><span class="line">构建状态：$BUILD_STATUS&lt;br/&gt;&lt;hr/&gt;</span><br><span class="line"></span><br><span class="line">触发原因：$&#123;CAUSE&#125;&lt;br/&gt;&lt;hr/&gt;</span><br><span class="line"></span><br><span class="line">构建日志地址：&lt;a href=&quot;$&#123;BUILD_URL&#125;console&quot;&gt;$&#123;BUILD_URL&#125;console&lt;/a&gt;&lt;br/&gt;&lt;hr/&gt;</span><br><span class="line"></span><br><span class="line">构建地址：&lt;a href=&quot;$BUILD_URL&quot;&gt;$BUILD_URL&lt;/a&gt;&lt;br/&gt;&lt;hr/&gt;</span><br><span class="line"></span><br><span class="line">变更集:$&#123;JELLY_SCRIPT,template=&quot;html&quot;&#125;&lt;br/&gt;&lt;hr/&gt;</span><br></pre></td></tr></table></figure>
<h2 id="全局属性详解"><a href="#全局属性详解" class="headerlink" title="全局属性详解"></a>全局属性详解</h2><ul>
<li>Default Content Type：指定构建后发送邮件内容的类型，有Text和HTML两种。<br>Use List-ID Email Header：为所有的邮件设置一个List-ID的邮件信头，这样你就可以在邮件客户端使用过滤。<br>Add ‘Precedence: bulk’ Email Header：设置优先级。<br>Default Recipients：自定义默认电子邮件收件人列表。如果没有被项目配置覆盖,该插件会使用这个列表。<br>Reply To List：回复列表<br>Emergency reroute：如果这个字段不为空，所有的电子邮件将被单独发送到该地址（或地址列表）。<br>Excluded Committers：防止邮件被邮件系统认为是垃圾邮件,邮件列表应该没有扩展的账户名(如:@domain.com),并且使用逗号分隔。<br>Default Subject：自定义邮件通知的默认主题名称。该选项能在邮件的主题字段中替换一些参数，这样你就可以在构建中包含指定的输出信息。<br>Maximum Attachment Size：邮件最大附件大小。<br>Default Pre-send Script：默认发送前执行的脚本。<br>Enable Debug Mode：启用插件的调试模式。这将增加额外的日志输出，构建日志以及Jenkins的日志。在调试时是有用的，但不能用于生产。<br>Enable Security：启用时，会禁用发送脚本的能力，直接进入Jenkins实例。如果用户试图访问Jenkins管理对象实例，将抛出一个安全异常。<br>Content Token Reference：邮件中可以使用的变量，所有的变量都是可选的。具体介绍请查看全局邮件变量章节。</li>
<li></li>
</ul>
<h2 id="Job中邮件配置"><a href="#Job中邮件配置" class="headerlink" title="Job中邮件配置"></a>Job中邮件配置</h2><p>在构建后操作——”Add Post-build Actions”选项中勾选”Editable Email Notification”标签<br><img src="/images/2017/0822/06.png" alt="jenkins"><br>*<br>Project Recipient List：这是一个以逗号(或者空格)分隔的收件人邮件的邮箱地址列表。允许您为每封邮件指定单独的列表。Ps：如果你想在默认收件人的基础上添加收件人：$DEFAULT_RECIPIENTS,&lt;新的收件人&gt;<br>Default Subject：允许你配置此项目邮件的主题。<br>Default Content：跟Default Subject的作用一样，但是是替换邮件内容。<br>Attach Build Log：附件构建日志。<br>Compress Build Log before sending：发送前压缩生成日志（zip格式）。<br>*</p>
<h3 id="添加触发器"><a href="#添加触发器" class="headerlink" title="添加触发器"></a>添加触发器</h3><p><img src="/images/2017/0822/07.png" alt="jenkins"></p>
<h3 id="查看构建失败日志"><a href="#查看构建失败日志" class="headerlink" title="查看构建失败日志"></a>查看构建失败日志</h3><p><img src="/images/2017/0822/08.png" alt="jenkins"></p>
<h3 id="查看收件箱"><a href="#查看收件箱" class="headerlink" title="查看收件箱"></a>查看收件箱</h3><p><img src="/images/2017/0822/09.png" alt="jenkins"></p>
<p>参考链接：<a href="http://www.cnblogs.com/yangxia-test/p/4366172.html">http://www.cnblogs.com/yangxia-test/p/4366172.html</a></p>
<hr>
]]></content>
      <categories>
        <category>自动化运维</category>
      </categories>
      <tags>
        <tag>Jenkins</tag>
        <tag>运维</tag>
        <tag>自动化</tag>
      </tags>
  </entry>
  <entry>
    <title>Jumpserver跳转机搭建过程中的疑问</title>
    <url>/arlo/ef870e7c/</url>
    <content><![CDATA[<h1 id="跳转机"><a href="#跳转机" class="headerlink" title="跳转机"></a>跳转机</h1><p>跳转机又名堡垒机，主要作用是在终端连接服务器之间加一层防护保障，保障连接到服务器的方式更加安全，更加透明，更加可控。<br><img src="/images/2016/0830/1.png" alt="Jumpserver 架构图"> </p>
<span id="more"></span>
<p>Jumpserver官网的wiki、图解、视频教程做的已经很详细了，参考地址如下：<br>[Jumpserver 官网地址:]<a href="http://www.jumpserver.org/">http://www.jumpserver.org/</a><br>[Jumpserver WiKi]<a href="https://github.com/jumpserver/jumpserver/wiki">https://github.com/jumpserver/jumpserver/wiki</a><br>[Jumpserver v3 视频教程]<a href="http://bbs.jumpserver.org/read/639.html">http://bbs.jumpserver.org/read/639.html</a></p>
<h1 id="记录问题"><a href="#记录问题" class="headerlink" title="记录问题"></a>记录问题</h1><p>以下是我在安装搭建过程中遇到的几个问题，在此记录一下。</p>
<h2 id="用户"><a href="#用户" class="headerlink" title="用户"></a>用户</h2><p><strong>用户管理中的用户:</strong> 用于登陆jumpserver跳转机和jumpserver web平台的用户；表示该类用户拥有登陆跳转机权限。<br><strong>设置中的默认管理员用户:</strong> 只适用于设置资产管理的时候，管理账号，使用默认选项；其实是一个缺省的管理员用户，只有大规模客户端使用相同的管理员用户名和密码是作用最大。<br><strong>添加资产时候的管理用户:</strong> 必须是真实存在于被添加的资产上，拥有管理权限（或sudo权限）的用户；被连接的资产设备上真是存在的管理员用户，如root。<br><strong>授权管理中的系统用户:</strong> 此用户是在添加jumpserver平台，通过推送在服务器上真是创建的用户；</p>
<h2 id="服务器，客户端"><a href="#服务器，客户端" class="headerlink" title="服务器，客户端"></a>服务器，客户端</h2><p>服务器：jms，安装jumpserver的这台服务器<br>客户端：通过跳转机链接的资产，如被连接的服务器，网络设备等</p>
<h2 id="推送"><a href="#推送" class="headerlink" title="推送"></a>推送</h2><p>推送是通过资产管理里的管理用户在服务器上建立系统用户和赋予sudo权限（如果管理sudo别名的话）</p>
]]></content>
      <tags>
        <tag>跳转机</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux下多线程下载工具Axel</title>
    <url>/arlo/1a27e5da/</url>
    <content><![CDATA[<p>Linux 平台下默认的下载工具是wget，可在慢速或不稳定的网络连接下保持健壮性，如果由于网络问题下载失败，它将继续重试，直到整个文件下载完成；但是wget不支持多线程下载，这里推荐一个axel，可实现对同一个文件建立多个连接，每个连接下载单独的文件片段以更快地完成下载，支持HTTP,HTTPS,FTP,FTPS协议；</p>
<span id="more"></span>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><h2 id="源码安装"><a href="#源码安装" class="headerlink" title="源码安装"></a>源码安装</h2><p>下载地址<a href="https://sourceforge.net/projects/axel2/files/">https://sourceforge.net/projects/axel2/files/</a></p>
<h2 id="包管理器安装"><a href="#包管理器安装" class="headerlink" title="包管理器安装"></a>包管理器安装</h2><p>看教程说epel源中带有这个工具，但是我Centos 6.8 没发现；于是自已下载一个rpm包安装，推荐下载地址 <a href="http://pkgs.org/">http://pkgs.org/</a></p>
<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><h2 id="基本用法如下："><a href="#基本用法如下：" class="headerlink" title="基本用法如下："></a>基本用法如下：</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">alex [选项][下载目录][下载地址]</span><br></pre></td></tr></table></figure>
<h2 id="参数如下："><a href="#参数如下：" class="headerlink" title="参数如下："></a>参数如下：</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-s 指定每秒下载最大的比特数（如限速为512KB/s，设置为 -s 512000）</span><br><span class="line">-n 指定同时打开的下载线程数 (如指定10个线程，设置为 -n 10)</span><br><span class="line">-o 指定下载路径（如下载到/tmp目录，设置为 -o /tmp；也可以指定下载后的文件名，如下载后文件名为test.tgz,设置为 -o /tmp/test.tgz）</span><br><span class="line">-S 搜索镜像，并下载</span><br><span class="line">-v 打印更多状态信息</span><br><span class="line">-a 打印简洁的进度信息</span><br><span class="line">-q 不显示下载进度</span><br></pre></td></tr></table></figure>
<h1 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">axel -n 10 -a -o /tmp ftp://ftpprd.ncep.noaa.gov/pub/data/nccf/com/gfs/prod/enkf.20170724/12/gdas.t12z.atmf009s.mem011.nemsio</span><br></pre></td></tr></table></figure>
<h1 id="断点续传"><a href="#断点续传" class="headerlink" title="断点续传"></a>断点续传</h1><p><strong>如果下载过程中下载中断可以再执行下载命令即可恢复上次的下载进度</strong>。axel 默认具有恢复未完成的下载的行为。Axel 在下载文件时定期更新状态文件（扩展名为 .st）。由于某些原因，下载中途停止了？不用担心，只要使用相同的 axel 命令，它将会检查 file 和 file.st，如果找到，它会从停止处恢复下载。</p>
<p>参考：<a href="http://man.linuxde.net/axel">http://man.linuxde.net/axel</a></p>
]]></content>
      <categories>
        <category>常识</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>常识</tag>
        <tag>下载</tag>
        <tag>axel</tag>
      </tags>
  </entry>
  <entry>
    <title>Lustre文件系统简介</title>
    <url>/arlo/ab1d26cf/</url>
    <content><![CDATA[<p>Lustre是一款开源的，基于对象存储的集群并行分布式文件系统，具有很高的扩展性、可用性、易用性、性能等，在高性能计算中应用很广泛，世界十大超级计算中心当中的七个以及超过50%的全球top50超级计算机都在使用Lustre。可以支持上万个节点，数以PB的数量存储系统。从1999年lustre项目起，他的版权所有者就在不断的变换，从lustre项目组到Sun公司到Oracle再到Whamclound，最终被因特尔收购。</p>
<span id="more"></span>
<p>基于对象的文件系统将文件的元数据和文件数据分离开来，存储在不同的服务器上。文件系统的客户用利用元数据服务器和对象存储服务器来为用户提供一个完整的文件系统抽象。基于对象的文件系统具有性能优势，文件系统客户通过对象存储服务器来访问文件内容，而元数据服务器只有在文件打开时才需要连接。</p>
<h1 id="Lustre文件系统包括三种主要的功能单元"><a href="#Lustre文件系统包括三种主要的功能单元" class="headerlink" title="Lustre文件系统包括三种主要的功能单元"></a>Lustre文件系统包括三种主要的功能单元</h1><h2 id="元数据服务器MDS-Metadata-Server"><a href="#元数据服务器MDS-Metadata-Server" class="headerlink" title="元数据服务器MDS(Metadata Server)"></a>元数据服务器MDS(Metadata Server)</h2><p>元数据服务器（metadata servers，MDSes）。一个Lustre文件系统通常拥有两个元数据服务器（active和standby），一个元数据服务器则拥有若干元数据目标（metadata targets，MDTs）。元数据目标存储名字空间元数据：文件名、目录、访问权限、文件结构等信息。不同于诸如GPFS和PanFS等基于块并由元数据服务器控制所有块分配的分布式文件系统，Lustre元数据服务器仅仅关心路径搜索和权限检查而不会牵涉任何的文件I&#x2F;O操作。该特性避免元数据服务器成为集群扩展的瓶颈。单个文件系统拥有多个元数据目标是从2.4开始引入的新特性。</p>
<h2 id="对象存储服务器OSS-Object-Storage-Server"><a href="#对象存储服务器OSS-Object-Storage-Server" class="headerlink" title="对象存储服务器OSS(Object Storage Server)"></a>对象存储服务器OSS(Object Storage Server)</h2><p>对象存储服务器（object storage servers，OSSes）将文件数据存储于一个或多个对象存储目标（object storage targets，OSTs）中。取决于服务器硬件，一个对象存储服务器通常有二到八个对象存储目标，每个对象存储目标管理一个本地文件系统。Lustre文件系统的空间等于所有对象存储目标的容量总和。</p>
<h2 id="客户端Client"><a href="#客户端Client" class="headerlink" title="客户端Client"></a>客户端Client</h2><p>客户机（Clients）能访问并使用数据。Lustre为所有客户机提供统一的命名空间。<br>Lustre支持多种网络类型，包括Infiniband，Omni-Path，以太网等。如果远程直接内存访问（RDMA）传输可用，Lustre将利用它提高吞吐量降低CPU使用率。</p>
<p>参考链接：<br><a href="https://zh.wikipedia.org/wiki/Lustre">https://zh.wikipedia.org/wiki/Lustre</a><br><a href="https://www.ibm.com/developerworks/cn/linux/l-ofs/index.html">https://www.ibm.com/developerworks/cn/linux/l-ofs/index.html</a><br><a href="http://blog.csdn.net/fsdev/article/details/7310975">http://blog.csdn.net/fsdev/article/details/7310975</a><br><a href="http://mp.weixin.qq.com/s/QvBEU6yebkChMPNmcCZrWQ">http://mp.weixin.qq.com/s/QvBEU6yebkChMPNmcCZrWQ</a></p>
]]></content>
      <categories>
        <category>HPC</category>
      </categories>
      <tags>
        <tag>Lustre</tag>
        <tag>文件系统</tag>
        <tag>分布式</tag>
        <tag>集群</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux下如何拨VPN</title>
    <url>/arlo/350a96fc/</url>
    <content><![CDATA[<p>由于公司的svn和maven仓库地址都在内网，使用Centos系统搭建持续集成的时候，没有办法访问服务器，又不想换Windows环境；于是想办法在linux下拨通vpn！</p>
<span id="more"></span>
<h1 id="安装vpn客户端"><a href="#安装vpn客户端" class="headerlink" title="安装vpn客户端"></a>安装vpn客户端</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum -y install pptp pptp-setup</span><br></pre></td></tr></table></figure>
<h1 id="创建一个vpn连接"><a href="#创建一个vpn连接" class="headerlink" title="创建一个vpn连接"></a>创建一个vpn连接</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pptpsetup --create pptpd --server SERVER_IP --username USERNAME --password PASSWORD --encrypt --start</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">–create是创建的连接名称</span><br><span class="line">–server是vpn的ip地址;</span><br><span class="line">–username是用户名</span><br><span class="line">–password是密码，也可以没这个参数，命令稍后会自动询问。这样可以保证账号安全</span><br><span class="line">–encrypt 是表示需要加密，不必指定加密方式，命令会读取配置文件中的加密方式</span><br><span class="line">–start是表示创建连接完后马上连接</span><br></pre></td></tr></table></figure>

<h1 id="编辑配置文件"><a href="#编辑配置文件" class="headerlink" title="编辑配置文件"></a>编辑配置文件</h1><p>创建vpn连接完成后，会有两个配置文件(ps:*<em>有域的情况下，配置文件中\需要写成\*</em>)<br>vim &#x2F;etc&#x2F;ppp&#x2F;peers&#x2F;pptpd</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># written by pptpsetup</span><br><span class="line">pty &quot;pptp 1.2.3.4 --nolaunchpppd&quot;</span><br><span class="line">lock</span><br><span class="line">noauth</span><br><span class="line">nobsdcomp</span><br><span class="line">nodeflate</span><br><span class="line">name domain\\username                                                                                                                                                                       </span><br><span class="line">remotename pptpd</span><br><span class="line">ipparam pptpd</span><br><span class="line">require-mppe-128</span><br></pre></td></tr></table></figure>
<p>vim &#x2F;etc&#x2F;ppp&#x2F;chap-secrets</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># Secrets for authentication using CHAP</span><br><span class="line"># client    server  secret          IP addresses</span><br><span class="line"></span><br><span class="line"># added by pptpsetup for pptpd</span><br><span class="line">domain\\username pptpd &quot;password&quot; *</span><br></pre></td></tr></table></figure>
<h1 id="复制开启-断开脚本"><a href="#复制开启-断开脚本" class="headerlink" title="复制开启\断开脚本"></a>复制开启\断开脚本</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cp /usr/share/doc/ppp-2.4.5/scripts/pon /usr/sbin/</span><br><span class="line">cp /usr/share/doc/ppp-2.4.5/scripts/poff /usr/sbin/</span><br><span class="line">chmod +x /usr/sbin/pon /usr/sbin/poff</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pon vpnname 开启vpn</span><br><span class="line">poff vpnname 断开vpn</span><br></pre></td></tr></table></figure>

<h1 id="尝试拨vpn"><a href="#尝试拨vpn" class="headerlink" title="尝试拨vpn"></a>尝试拨vpn</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pon pptpd</span><br></pre></td></tr></table></figure>
<h1 id="查看连接情况"><a href="#查看连接情况" class="headerlink" title="查看连接情况"></a>查看连接情况</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ip a</span><br></pre></td></tr></table></figure>
<p><img src="/images/2017/0823/00.png" alt="vpn"><br>如果有异常的话，可以跟踪系统日志排查</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tailf /var/log/messages</span><br></pre></td></tr></table></figure>
<h1 id="设置路由"><a href="#设置路由" class="headerlink" title="设置路由"></a>设置路由</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">route add -net 192.168.0.0/24 dev ppp0</span><br></pre></td></tr></table></figure>
<p><img src="/images/2017/0823/01.png" alt="vpn"></p>
]]></content>
      <categories>
        <category>常识</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>常识</tag>
        <tag>vpn</tag>
      </tags>
  </entry>
  <entry>
    <title>MPICHI3 并行计算环境搭建</title>
    <url>/arlo/undefined/</url>
    <content><![CDATA[<p>新工作接触到HPC高性能计算项目，最近看了一些HPC高性能计算的理论资料，今天搭建MPICHI 并行计算环境，算是开始HPC的学习之路吧！</p>
<span id="more"></span>
<h1 id="系统环境"><a href="#系统环境" class="headerlink" title="系统环境"></a>系统环境</h1><p>CentOS 6_x64</p>
<h2 id="设置hosts"><a href="#设置hosts" class="headerlink" title="设置hosts"></a>设置hosts</h2><p>vim &#x2F;etc&#x2F;hosts</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">192.168.6.100 vm00</span><br><span class="line">192.168.6.101 vm01</span><br><span class="line">192.168.6.102 vm02</span><br></pre></td></tr></table></figure>
<h2 id="新建用户"><a href="#新建用户" class="headerlink" title="新建用户"></a>新建用户</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># useradd -u 600 pxb</span><br><span class="line"># echo ffffff|passwd --stdin pxb</span><br></pre></td></tr></table></figure>
<h2 id="配置机器ssh无密码连接"><a href="#配置机器ssh无密码连接" class="headerlink" title="配置机器ssh无密码连接"></a>配置机器ssh无密码连接</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># su - pxb</span><br><span class="line">$ ssh-keygen 默认一直回车</span><br><span class="line">$ ssh-copy-id vm00</span><br><span class="line">$ ssh-copy-id vm01</span><br><span class="line">$ ssh-copy-id vm02</span><br><span class="line">$ ssh vm00</span><br><span class="line">$ ssh vm01</span><br><span class="line">$ ssh vm03</span><br></pre></td></tr></table></figure>
<h1 id="安装MPICHI（三台服务器上执行以下相同操作）"><a href="#安装MPICHI（三台服务器上执行以下相同操作）" class="headerlink" title="安装MPICHI（三台服务器上执行以下相同操作）"></a>安装MPICHI（三台服务器上执行以下相同操作）</h1><h2 id="获取mpichi"><a href="#获取mpichi" class="headerlink" title="获取mpichi"></a>获取mpichi</h2><p><a href="https://www.mpich.org/downloads/">https://www.mpich.org/downloads/</a></p>
<h2 id="安装配置MPICHI"><a href="#安装配置MPICHI" class="headerlink" title="安装配置MPICHI"></a>安装配置MPICHI</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># tar -xf mpich-3.2.tar.gz</span><br><span class="line"># cd mpich-3.2</span><br><span class="line"># ./configure --prefix=/usr/local/mpich/</span><br><span class="line"># make &amp;&amp; make install</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>$ vim ~&#x2F;.bash_profile<br>$ export PATH&#x3D;$PATH:&#x2F;usr&#x2F;local&#x2F;mpich&#x2F;bin&#x2F;<br>$ source ~&#x2F;.bash_profile<br>$ echo $PATH</p>
<h2 id="新建machinefile"><a href="#新建machinefile" class="headerlink" title="新建machinefile"></a>新建machinefile</h2><p>$ vim ~&#x2F;machinefile</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vm00</span><br><span class="line">vm01</span><br><span class="line">vm02</span><br></pre></td></tr></table></figure>
<h1 id="测试MPICHI，跑圆周率程序"><a href="#测试MPICHI，跑圆周率程序" class="headerlink" title="测试MPICHI，跑圆周率程序"></a>测试MPICHI，跑圆周率程序</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ /usr/local/mpich/bin/mpiexec -n 3 -machinefile machinefile ~/mpich-3.2/examples/cpi</span><br></pre></td></tr></table></figure>
<p>-n 是使用多少节点<br>-machinefile 集群节点文件<br><img src="/images/2017/0329/0.png" alt="计算圆周率"> </p>
]]></content>
      <categories>
        <category>HPC</category>
      </categories>
      <tags>
        <tag>HPC</tag>
      </tags>
  </entry>
  <entry>
    <title>Mariadb主从复制集群</title>
    <url>/arlo/fe63d61c/</url>
    <content><![CDATA[<p>Centos7系统中将Mysql置换为Mariadb了；Mariadb是Mysql数据库被Oracle公司收购之后Mysql之前的开发者基于mysql开发的开源数据库，完全兼容mysql；更详细的纠葛请自行google。<br>Mysql的主从复制是指从服务器向主服务器索取二进制binlog文件，在从服务器上把日志文件重新执行，从而获取主服务器数据，保证从服务器和主服务器的数据保持同步。但由于是异步的复制，从服务器在一定程度上落后于主服务器，刚写入到主服务器上的数据可能服务在从服务器上查询得到。</p>
<span id="more"></span>
<h1 id="复制原理过程"><a href="#复制原理过程" class="headerlink" title="复制原理过程"></a>复制原理过程</h1><ul>
<li>从服务器创建I&#x2F;O线程连接主数据库，向主数据请库服务器求二进制日志文件（binlog）</li>
<li>主服务器上启动Binlog Dump,将二进制日志文件发送给I&#x2F;O线程，I&#x2F;O线程获取数据后将数据卸载从库的中继日志中（relay log）</li>
<li>SQL线程读取中继日志并执行</li>
</ul>
<h1 id="日志方式"><a href="#日志方式" class="headerlink" title="日志方式"></a>日志方式</h1><ul>
<li><strong>statement</strong>：基于语句级别的binlog，记录修改数据的sql语句。</li>
<li><strong>row</strong>： 基于行级别的binlog逐行记录数据的变更。</li>
<li><strong>mixed</strong>：由Mysql数据库自动选择哪种方式记录binlog。<br>raw格式下日志文件会很大，会影响磁盘的I&#x2F;O,在传输过程中也会影响带宽，根据情况自行选择。</li>
</ul>
<h1 id="集群环境搭建"><a href="#集群环境搭建" class="headerlink" title="集群环境搭建"></a>集群环境搭建</h1><p>系统：Centos7 x64<br>软件：Mariadb 10.2 stable</p>
<h2 id="保持服务器时间同步"><a href="#保持服务器时间同步" class="headerlink" title="保持服务器时间同步"></a>保持服务器时间同步</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">timedatectl set-timezone Asia/Shanghai</span><br><span class="line">timedatectl set-ntp true</span><br><span class="line">ntpdate cn.ntp.org.cn</span><br></pre></td></tr></table></figure>
<h2 id="安装Mariadb软件"><a href="#安装Mariadb软件" class="headerlink" title="安装Mariadb软件"></a>安装Mariadb软件</h2><h3 id="配置yum源"><a href="#配置yum源" class="headerlink" title="配置yum源"></a>配置yum源</h3><p>参考<a href="https://downloads.mariadb.org/mariadb/repositories/">https://downloads.mariadb.org/mariadb/repositories/</a><br>vim &#x2F;etc&#x2F;yum.repos.d&#x2F;MariaDB.repo</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># MariaDB 10.2 CentOS repository list - created 2017-07-27 03:36 UTC</span><br><span class="line"># http://downloads.mariadb.org/mariadb/repositories/</span><br><span class="line">[mariadb]</span><br><span class="line">name = MariaDB</span><br><span class="line">baseurl = http://yum.mariadb.org/10.2/centos7-amd64</span><br><span class="line">gpgkey=https://yum.mariadb.org/RPM-GPG-KEY-MariaDB</span><br><span class="line">gpgcheck=1</span><br></pre></td></tr></table></figure>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum -y install MariaDB-server MariaDB-client</span><br></pre></td></tr></table></figure>
<h2 id="启动服务，并设置开机启动"><a href="#启动服务，并设置开机启动" class="headerlink" title="启动服务，并设置开机启动"></a>启动服务，并设置开机启动</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl start mariadb.service</span><br><span class="line">systemctl enable mariadb.service</span><br></pre></td></tr></table></figure>
<h2 id="初始化服务器"><a href="#初始化服务器" class="headerlink" title="初始化服务器"></a>初始化服务器</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">可以初始化过程中设置密码</span><br><span class="line">mysql_secure_installation</span><br><span class="line">也可以进入数据库后设置密码</span><br><span class="line">update user set password=PASSWORD(&quot;SOME_ROOT_PASSWORD&quot;) where User=&#x27;root&#x27;;</span><br></pre></td></tr></table></figure>
<h2 id="配置主服务器"><a href="#配置主服务器" class="headerlink" title="配置主服务器"></a>配置主服务器</h2><p>将以下配置添加到my.cnf中[mysqld]下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">server-id=102			#服务器ID号(取值范围为1到2的32次方-1的整数，建议使用ip地址最后一位，保持唯一性),写成server_id 不生效</span><br><span class="line">log-bin=/var/lib/mysql/mariadb-bin #二进制文件存放位置</span><br><span class="line">binlog_format=row		#日志类型为raw</span><br><span class="line">sync_binlog = 1			#事务一提交，就将二进制日志同步至磁盘上</span><br><span class="line">innodb_support_xa = 1		#支持分布式事务</span><br><span class="line">innodb-flush-log-at-trx-commit=1	#针对innodb的设置</span><br></pre></td></tr></table></figure>
<p>给slave开相应的权限</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GRANT REPLICATION SLAVE ON *.* TO ‘repl’@‘192.168.6.103’ IDENTIFIED BY ‘123456’;</span><br></pre></td></tr></table></figure>
<h2 id="配置从服务器"><a href="#配置从服务器" class="headerlink" title="配置从服务器"></a>配置从服务器</h2><p>将以下配置添加到my.cnf中[mysqld]下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">server-id=103			#服务器ID号(取值范围为1到2的32次方-1的整数，建议使用ip地址最后一位，保持唯一性)</span><br><span class="line">read_only = 1			#从服务器为只读状态（确保数据的一致性）</span><br><span class="line">log-bin=/var/lib/mysql/mariadb-bin #中继日志存放目录   </span><br><span class="line">replicate-ignore-db=mysql	#不需要同步的数据库（忽略的库最好配置在slave上，让master有最全的binlog）</span><br></pre></td></tr></table></figure>
<p><font color=red>Mysql版本从5.1.7以后开始就不支持“master-host”类似的参数；</font><br>在从库上执行如下命令；</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">change master to master_host=&#x27;192.168.6.102&#x27;, master_user=&#x27;repl&#x27;, master_password=&#x27;123456&#x27;;    #好像不需要master_log_file和master_log_pos也可以;</span><br><span class="line">slave start;</span><br><span class="line">show slave status\G  #查看同步状态</span><br></pre></td></tr></table></figure>
<p><img src="/images/2017/0726/00.png" alt="mariadb"></p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>在主服务器上新建数据库，建表，插入数据;在从库上查询；</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql -uroot -pffffff</span><br><span class="line">MariaDB [(none)]&gt; create database test_repl;</span><br><span class="line">MariaDB [(none)]&gt; use test_repl;</span><br><span class="line">MariaDB [test_repl]&gt; CREATE TABLE Persons (</span><br><span class="line">PersonID int,</span><br><span class="line">LastName varchar(255),</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255)</span><br><span class="line">);</span><br><span class="line">MariaDB [test_repl]&gt; INSERT INTO Persons VALUES (1, &quot;LastName1&quot;, &quot;FirstName1&quot;, &quot;Address1&quot;, &quot;City1&quot;);</span><br></pre></td></tr></table></figure>
<p>在从库上查询；</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql -uroot -pffffff</span><br><span class="line">MariaDB [(none)]&gt; use test_repl;</span><br><span class="line">MariaDB [test_repl]&gt; select * from Persons;</span><br></pre></td></tr></table></figure>
<p>可以在主库上看到连接的从库信息（一主多从很有用）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">MariaDB [test_repl]&gt; show slave hosts;</span><br><span class="line">+-----------+------+------+-----------+</span><br><span class="line">| Server_id | Host | Port | Master_id |</span><br><span class="line">+-----------+------+------+-----------+</span><br><span class="line">|         3 |      | 3306 |         1 |</span><br><span class="line">+-----------+------+------+-----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<h1 id="问题记录"><a href="#问题记录" class="headerlink" title="问题记录"></a>问题记录</h1><h2 id="Q1："><a href="#Q1：" class="headerlink" title="Q1："></a>Q1：</h2><p>Q：Got fatal error 1236 from master when reading data from binary log: ‘Could not find first log file name in binary log index file’<br>A：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">MariaDB [test_repl]&gt; stop slave;</span><br><span class="line">MariaDB [test_repl]&gt; reset slave;</span><br><span class="line">MariaDB [test_repl]&gt; start slave;</span><br></pre></td></tr></table></figure>
<h2 id="Q2"><a href="#Q2" class="headerlink" title="Q2:"></a>Q2:</h2><p>Q:Could not execute Update_rows event on table mysql.user; Can’t find record in ‘user’, Error_code: 1032; handler error HA_ERR_KEY_NOT_FOUND; the event’s master log mariadb-bin.000003, end_log_pos 1749<br>A:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">MariaDB [test_repl]&gt; stop slave;  </span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [test_repl]&gt; set global sql_slave_skip_counter=1;  </span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [test_repl]&gt; start slave;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure>
<h2 id="Q3："><a href="#Q3：" class="headerlink" title="Q3："></a>Q3：</h2><p>Q：<br>Last_SQL_Errno: 1146<br>Last_SQL_Error: Unable to load replication GTID slave state from mysql.gtid_slave_pos: Table ‘mysql.gtid_slave_pos’ doesn’t exist<br>A:<br>主从的版本是一样是，不清楚为什么会出现这样的问题，使用mysql_upgrade升级修复了一下好了；</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql_upgrade -uroot -pffffff</span><br></pre></td></tr></table></figure>
<h1 id="扩展阅读"><a href="#扩展阅读" class="headerlink" title="扩展阅读"></a>扩展阅读</h1><p>Mysql默认的复制是异步的，Mysql(5.5以后版本)<strong><a href="http://www.cnblogs.com/ivictor/p/5735580.html">半同步复制</a></strong></p>
<p>参考链接：<br><a href="https://linux.cn/article-5491-1.html">https://linux.cn/article-5491-1.html</a><br><a href="http://joelhy.github.io/2015/02/06/mariadb-master-slave-replication/">http://joelhy.github.io/2015/02/06/mariadb-master-slave-replication/</a><br><a href="http://www.cnblogs.com/gomysql/p/3662492.html">http://www.cnblogs.com/gomysql/p/3662492.html</a></p>
<hr>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>数据库</tag>
        <tag>Mysql</tag>
        <tag>Mariadb</tag>
      </tags>
  </entry>
  <entry>
    <title>Mariadb(MHA)高可用集群搭建</title>
    <url>/arlo/49c257f9/</url>
    <content><![CDATA[<p>MHA（Master High Availability）目前在MySQL高可用方面是一个相对成熟的解决方案，它由日本DeNA公司youshimaton（现就职于Facebook公司）开发，是一套优秀的作为MySQL高可用性环境下故障切换和主从提升的高可用软件。在MySQL故障切换过程中，MHA能做到在0~30秒之内自动完成数据库的故障切换操作，并且在进行故障切换的过程中，MHA能在最大程度上保证数据的一致性，以达到真正意义上的高可用。</p>
<span id="more"></span>
<p>该软件由两部分组成：MHA Manager（管理节点）和MHA Node（数据节点）。MHA Manager可以单独部署在一台独立的机器上管理多个master-slave集群，也可以部署在一台slave节点上。MHA Node运行在每台MySQL服务器上，MHA Manager会定时探测集群中的master节点，当master出现故障时，它可以自动将最新数据的slave提升为新的master，然后将所有其他的slave重新指向新的master。整个故障转移过程对应用程序完全透明。</p>
<p>在MHA自动故障切换过程中，MHA试图从宕机的主服务器上保存二进制日志，最大程度的保证数据的不丢失，但这并不总是可行的。例如，如果主服务器硬件故障或无法通过ssh访问，MHA没法保存二进制日志，只进行故障转移而丢失了最新的数据。使用MySQL 5.5的半同步复制，可以大大降低数据丢失的风险。MHA可以与半同步复制结合起来。如果只有一个slave已经收到了最新的二进制日志，MHA可以将最新的二进制日志应用于其他所有的slave服务器上，因此可以保证所有节点的数据一致性。<br>目前MHA主要支持一主多从的架构，要搭建MHA,要求一个复制集群中必须最少有三台数据库服务器，一主二从，即一台充当master，一台充当备用master，另外一台充当从库，因为至少需要三台服务器，出于机器成本的考虑，淘宝也在该基础上进行了改造，目前淘宝TMHA已经支持一主一从。</p>
<p>MHA工作原理总结为以下几条：</p>
<ul>
<li>从宕机崩溃的master保存二进制日志事件（binlog events）;</li>
<li>识别含有最新更新的slave;</li>
<li>应用差异的中继日志(relay log) 到其他slave;</li>
<li>应用从master保存的二进制日志事件(binlog events);</li>
<li>提升一个slave为新master;</li>
<li>使用其他的slave连接新的master进行复制。</li>
</ul>
<h1 id="配置基础环境"><a href="#配置基础环境" class="headerlink" title="配置基础环境"></a>配置基础环境</h1><h2 id="mysql主充复制集群搭建"><a href="#mysql主充复制集群搭建" class="headerlink" title="mysql主充复制集群搭建"></a>mysql主充复制集群搭建</h2><p>mha的环境是基于mysql主从复制环境上搭建的，主从复制请参考<strong><a href="http://islocal.cc/arlo/b48c6366/">http://islocal.cc/arlo/b48c6366/</a></strong> ，本文搭建的为一主三从环境</p>
<h1 id="配置互相无密码验证"><a href="#配置互相无密码验证" class="headerlink" title="配置互相无密码验证"></a>配置互相无密码验证</h1><h2 id="配置hosts"><a href="#配置hosts" class="headerlink" title="配置hosts"></a>配置hosts</h2><p>复制到到其他几台机器</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cat /etc/hosts</span><br><span class="line">192.168.6.126	mysql_a		#从库		#node</span><br><span class="line">192.168.6.127	mysql_b		#主库		#node</span><br><span class="line">192.168.6.128	mysql_c		#备用主库	#node</span><br><span class="line">192.168.6.102	vm02		#从库		#manager</span><br></pre></td></tr></table></figure>
<h2 id="mysql-a"><a href="#mysql-a" class="headerlink" title="mysql_a"></a>mysql_a</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ssh-keygen </span><br><span class="line">ssh-copy-id mysql_b</span><br><span class="line">ssh-copy-id mysql_c</span><br><span class="line">sssh-copy-id vm02</span><br></pre></td></tr></table></figure>
<h2 id="mysql-b"><a href="#mysql-b" class="headerlink" title="mysql_b"></a>mysql_b</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ssh-keygen </span><br><span class="line">ssh-copy-id mysql_a</span><br><span class="line">ssh-copy-id mysql_c</span><br><span class="line">sssh-copy-id vm02</span><br></pre></td></tr></table></figure>
<h2 id="mysql-c"><a href="#mysql-c" class="headerlink" title="mysql_c"></a>mysql_c</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ssh-keygen </span><br><span class="line">ssh-copy-id mysql_a</span><br><span class="line">ssh-copy-id mysql_b</span><br><span class="line">ssh-copy-id vm02</span><br></pre></td></tr></table></figure>
<h2 id="vm02"><a href="#vm02" class="headerlink" title="vm02"></a>vm02</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ssh-keygen </span><br><span class="line">ssh-copy-id mysql_a</span><br><span class="line">ssh-copy-id mysql_b</span><br><span class="line">ssh-copy-id mysql_c</span><br></pre></td></tr></table></figure>
<h1 id="mysql-配置"><a href="#mysql-配置" class="headerlink" title="mysql 配置"></a>mysql 配置</h1><h2 id="建立mysql用户，赋予权限"><a href="#建立mysql用户，赋予权限" class="headerlink" title="建立mysql用户，赋予权限"></a>建立mysql用户，赋予权限</h2><p>在3台mysql服务器上分别新建mha用户，并授权</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">MariaDB [test_repl]&gt; grant all privileges on *.* to &#x27;mha&#x27;@&#x27;mysql_a&#x27; identified by &#x27;222222&#x27;;</span><br><span class="line">MariaDB [test_repl]&gt; grant all privileges on *.* to &#x27;mha&#x27;@&#x27;mysql_b&#x27; identified by &#x27;222222&#x27;;</span><br><span class="line">MariaDB [test_repl]&gt; grant all privileges on *.* to &#x27;mha&#x27;@&#x27;mysql_c&#x27; identified by &#x27;222222&#x27;;</span><br><span class="line">MariaDB [test_repl]&gt; grant all privileges on *.* to &#x27;mha&#x27;@&#x27;vm02&#x27; identified by &#x27;222222&#x27;;</span><br></pre></td></tr></table></figure>
<h2 id="修改mysql参数"><a href="#修改mysql参数" class="headerlink" title="修改mysql参数"></a>修改mysql参数</h2><p>在2台slave上修改</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql -e &#x27;set global read_only=1&#x27;</span><br><span class="line">mysql -uroot -pffffff -e &#x27;show slave status\G&#x27;|egrep &#x27;Slave_IO|Slave_SQL&#x27;</span><br></pre></td></tr></table></figure>
<h1 id="安装mha-manager"><a href="#安装mha-manager" class="headerlink" title="安装mha manager"></a>安装mha manager</h1><h2 id="安装mha-manager-1"><a href="#安装mha-manager-1" class="headerlink" title="安装mha manager"></a>安装mha manager</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm02 src]# yum install perl-DBD-MySQL perl-Config-Tiny perl-Log-Dispatch perl-Parallel-ForkManager perl-Time-HiRes -y</span><br><span class="line">[root@vm02 src]# cd mha4mysql-manager-0.56/</span><br><span class="line">[root@vm02 mha4mysql-manager-0.56]# perl Makefile.PL </span><br><span class="line">[root@vm02 mha4mysql-manager-0.56]# make &amp;&amp; make install</span><br><span class="line">[root@vm02 ~]# cp /usr/local/src/mha4mysql-manager-0.56/samples/scripts/master_ip_failover /usr/local/bin/</span><br><span class="line">[root@vm02 ~]# cp /usr/local/src/mha4mysql-manager-0.56/samples/scripts/master_ip_online_change /usr/local/bin/</span><br></pre></td></tr></table></figure>
<h2 id="主配置文件"><a href="#主配置文件" class="headerlink" title="主配置文件"></a>主配置文件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[server default]</span><br><span class="line">user=mha</span><br><span class="line">password=222222</span><br><span class="line">ping_interval=1</span><br><span class="line">remote_workdir=/tmp</span><br><span class="line">repl_user=repl</span><br><span class="line">repl_password=111111</span><br><span class="line">ssh_user=root</span><br><span class="line"></span><br><span class="line">manager_workdir=/var/log/masterha/app1</span><br><span class="line">manager_log=/var/log/masterha/app1/manager.log</span><br><span class="line">master_binlog_dir= /var/lib/mysql/</span><br><span class="line">master_ip_failover_script= /usr/local/bin/master_ip_failover</span><br><span class="line">master_ip_online_change_script= /usr/local/bin/master_ip_online_change</span><br><span class="line">report_script=/usr/local/send_report</span><br><span class="line">secondary_check_script= /usr/local/bin/masterha_secondary_check -s mysql_b -s mysql_c --master_host=mysql_b --master_ip=192.168.6.127 --master_port=3306</span><br><span class="line">shutdown_script=&quot;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[server1]</span><br><span class="line">hostname=mysql_b</span><br><span class="line">port=3306</span><br><span class="line"></span><br><span class="line">[server2]</span><br><span class="line">master_binlog_dir=/var/lib/mysql</span><br><span class="line">hostname=mysql_c</span><br><span class="line">port=3306</span><br><span class="line">candidate_master=1</span><br><span class="line">check_repl_delay=0</span><br><span class="line"></span><br><span class="line">[server3]</span><br><span class="line">master_binlog_dir=/var/lib/mysql</span><br><span class="line">hostname=mysql_a</span><br><span class="line">port=3306</span><br><span class="line"></span><br><span class="line">[server4]</span><br><span class="line">master_binlog_dir=/var/lib/mysql</span><br><span class="line">hostname=vm02</span><br><span class="line">port=3306</span><br></pre></td></tr></table></figure>
<h1 id="安装mha-node"><a href="#安装mha-node" class="headerlink" title="安装mha node"></a>安装mha node</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># yum install perl-ExtUtils-CBuilder perl-ExtUtils-MakeMaker  perl-DBD-MySQL </span><br><span class="line">[root@mysql_a mha4mysql-node-0.56]# ansible mysql -a &#x27;perl Makefile.PL chdir=/usr/local/src/mha4mysql-node-0.56/&#x27;</span><br><span class="line">[root@mysql_a mha4mysql-node-0.56]# ansible mysql -a &#x27;make chdir=/usr/local/src/mha4mysql-node-0.56/&#x27;</span><br><span class="line">[root@mysql_a mha4mysql-node-0.56]# ansible mysql -a &#x27;make install chdir=/usr/local/src/mha4mysql-node-0.56/&#x27;</span><br></pre></td></tr></table></figure>
<h2 id="测试ssh连通性"><a href="#测试ssh连通性" class="headerlink" title="测试ssh连通性"></a>测试ssh连通性</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm02 ~]# masterha_check_ssh --conf=/etc/mastermha/app1.cnf</span><br><span class="line">Wed Aug  2 17:12:59 2017 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Wed Aug  2 17:12:59 2017 - [info] Reading application default configurations from /etc/mastermha/app1.cnf..</span><br><span class="line">Wed Aug  2 17:12:59 2017 - [info] Reading server configurations from /etc/mastermha/app1.cnf..</span><br><span class="line">Wed Aug  2 17:12:59 2017 - [info] Starting SSH connection tests..</span><br><span class="line">Wed Aug  2 17:13:00 2017 - [debug] </span><br><span class="line">Wed Aug  2 17:13:00 2017 - [debug]  Connecting via SSH from root@mysql_a(192.168.6.126:22) to root@mysql_b(192.168.6.127:22)..</span><br><span class="line">Wed Aug  2 17:13:00 2017 - [debug]   ok.</span><br><span class="line">Wed Aug  2 17:13:00 2017 - [debug]  Connecting via SSH from root@mysql_a(192.168.6.126:22) to root@mysql_c(192.168.6.128:22)..</span><br><span class="line">Wed Aug  2 17:13:00 2017 - [debug]   ok.</span><br><span class="line">Wed Aug  2 17:13:01 2017 - [debug] </span><br><span class="line">Wed Aug  2 17:13:00 2017 - [debug]  Connecting via SSH from root@mysql_b(192.168.6.127:22) to root@mysql_a(192.168.6.126:22)..</span><br><span class="line">Wed Aug  2 17:13:00 2017 - [debug]   ok.</span><br><span class="line">Wed Aug  2 17:13:00 2017 - [debug]  Connecting via SSH from root@mysql_b(192.168.6.127:22) to root@mysql_c(192.168.6.128:22)..</span><br><span class="line">Wed Aug  2 17:13:00 2017 - [debug]   ok.</span><br><span class="line">Wed Aug  2 17:13:01 2017 - [debug] </span><br><span class="line">Wed Aug  2 17:13:01 2017 - [debug]  Connecting via SSH from root@mysql_c(192.168.6.128:22) to root@mysql_a(192.168.6.126:22)..</span><br><span class="line">Wed Aug  2 17:13:01 2017 - [debug]   ok.</span><br><span class="line">Wed Aug  2 17:13:01 2017 - [debug]  Connecting via SSH from root@mysql_c(192.168.6.128:22) to root@mysql_b(192.168.6.127:22)..</span><br><span class="line">Wed Aug  2 17:13:01 2017 - [debug]   ok.</span><br><span class="line">Wed Aug  2 17:13:01 2017 - [info] All SSH connection tests passed successfully.</span><br></pre></td></tr></table></figure>
<p><img src="/images/2017/0807/01.png" alt="mariadb"></p>
<h2 id="测试主从复制"><a href="#测试主从复制" class="headerlink" title="测试主从复制"></a>测试主从复制</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm02 ~]# masterha_check_repl --conf=/etc/mastermha/app1.cnf</span><br></pre></td></tr></table></figure>

<h1 id="报错"><a href="#报错" class="headerlink" title="报错"></a>报错</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Thu Aug  3 17:10:16 2017 - [info] MHA::MasterMonitor version 0.56.</span><br><span class="line">Thu Aug  3 17:10:18 2017 - [error][/usr/local/share/perl5/MHA/MasterMonitor.pm, ln401] Error happend on checking configurations. Use of uninitialized value in string eq at /usr/local/share/perl5/MHA/Server.pm line 236.</span><br><span class="line">Thu Aug  3 17:10:18 2017 - [error][/usr/local/share/perl5/MHA/MasterMonitor.pm, ln500] Error happened on monitoring servers.</span><br><span class="line">Thu Aug  3 17:10:18 2017 - [info] Got exit code 1 (Not master dead).</span><br></pre></td></tr></table></figure>
<p><em>解决方法还没找到，所以就卡在这里了，网上也没找到有效的解决方法；好悲催，有知道的可以知道我一下，联系方式关于里边有；我怀疑是不是因为我mha0.56和Mariadb10.2.7版本不匹配，或者Mariadb太新导致的；先放一放，后期找到解决方法了再处理吧。</em></p>
<p>参考：<a href="http://www.cnblogs.com/gomysql/p/3675429.html">http://www.cnblogs.com/gomysql/p/3675429.html</a></p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>集群</tag>
        <tag>数据库</tag>
        <tag>Mysql</tag>
        <tag>Mariadb</tag>
      </tags>
  </entry>
  <entry>
    <title>Mariadb 读写分离集群搭建</title>
    <url>/arlo/b48c6366/</url>
    <content><![CDATA[<h1 id="基础环境配置"><a href="#基础环境配置" class="headerlink" title="基础环境配置"></a>基础环境配置</h1><p>iptables: disabled<br>selinux:  disabled<br>|系统		|主机名		|IP地址	        |角色          |<br>|CentOS 7.2 x64	|mysql_a	|192.168.6.126	|Atlas代理服务 |<br>|CentOS 7.2 x64	|mysql_b	|192.168.6.127	|Mysql主服务器 |<br>|CentOS 7.2 x64	|mysql_c	|192.168.6.128	|Mysql 从服务器|</p>
<span id="more"></span>
<h2 id="在mysql-a上安装ansible"><a href="#在mysql-a上安装ansible" class="headerlink" title="在mysql_a上安装ansible"></a>在mysql_a上安装ansible</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@mysql_a ~]# yum -y install epel-release</span><br><span class="line">[root@mysql_a ~]# yum -y install ansible</span><br><span class="line">[root@mysql_a ~]# vim /etc/ansible/hosts</span><br><span class="line">[mysql]</span><br><span class="line">mysql_b</span><br><span class="line">mysql_c</span><br></pre></td></tr></table></figure>
<h2 id="建立无密码通信"><a href="#建立无密码通信" class="headerlink" title="建立无密码通信"></a>建立无密码通信</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@mysql_a ~]# ssh-keygen -t rsa</span><br><span class="line">[root@mysql_a ~]# ssh-copy-id -i ~/.ssh/id_rsa.pub mysql_b</span><br><span class="line">[root@mysql_a ~]# ssh-copy-id -i ~/.ssh/id_rsa.pub mysql_c</span><br></pre></td></tr></table></figure>
<h2 id="保持服务器时间同步"><a href="#保持服务器时间同步" class="headerlink" title="保持服务器时间同步"></a>保持服务器时间同步</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@mysql_a ~]# ansible mysql -a &#x27;timedatectl set-timezone Asia/Shanghai&#x27;</span><br><span class="line">[root@mysql_a ~]# ansible mysql -a &#x27;timedatectl set-ntp true&#x27;</span><br><span class="line">[root@mysql_a ~]# ansible mysql -a &#x27;ntpdate cn.ntp.org.cn&#x27;</span><br></pre></td></tr></table></figure>
<h2 id="配置三台服务器的hosts"><a href="#配置三台服务器的hosts" class="headerlink" title="配置三台服务器的hosts"></a>配置三台服务器的hosts</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cat /etc/hosts</span><br><span class="line">192.168.6.126   mysql_a</span><br><span class="line">192.168.6.127   mysql_b</span><br><span class="line">192.168.6.128   mysql_c</span><br><span class="line">[root@mysql_a ~]# ansible mysql -m copy -a &#x27;src=/etc/hosts dest=/etc/hosts&#x27;</span><br></pre></td></tr></table></figure>
<h1 id="搭建Mariadb-mysql-主从复制"><a href="#搭建Mariadb-mysql-主从复制" class="headerlink" title="搭建Mariadb(mysql)主从复制"></a>搭建Mariadb(mysql)主从复制</h1><h2 id="配置Mariadb-yum源"><a href="#配置Mariadb-yum源" class="headerlink" title="配置Mariadb yum源"></a>配置Mariadb yum源</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@mysql_a ~]# vim /etc/yum.repos.d/MariaDB.repo</span><br><span class="line"># MariaDB 10.2 CentOS repository list - created 2017-07-27 03:36 UTC</span><br><span class="line"># http://downloads.mariadb.org/mariadb/repositories/</span><br><span class="line">[mariadb]</span><br><span class="line">name = MariaDB</span><br><span class="line">baseurl = http://yum.mariadb.org/10.2/centos7-amd64</span><br><span class="line">gpgkey=https://yum.mariadb.org/RPM-GPG-KEY-MariaDB</span><br><span class="line">gpgcheck=1</span><br></pre></td></tr></table></figure>
<h2 id="安装Mariadb-mysql"><a href="#安装Mariadb-mysql" class="headerlink" title="安装Mariadb(mysql)"></a>安装Mariadb(mysql)</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@mysql_a ~]# ansible mysql -m copy -a &#x27;src=/etc/yum.repos.d/MariaDB.repo dest=/etc/yum.repos.d/MariaDB.repo&#x27;</span><br><span class="line">[root@mysql_a ~]# ansible mysql -m yum -a &#x27;name=MariaDB-server state=installed&#x27;</span><br><span class="line">[root@mysql_a ~]# ansible mysql -m yum -a &#x27;name=MariaDB-client state=installed&#x27;</span><br></pre></td></tr></table></figure>
<p>*<em>Ps：也可以下载以下几个rpm包，使用yum localinstall <em>.rpm 进行安装（速度会快一些）</em></em></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@mysql_b mariadb]# ll</span><br><span class="line">total 171204</span><br><span class="line">-rw-r--r-- 1 root root   8353220 Aug  1 13:56 galera-25.3.20-1.rhel7.el7.centos.x86_64.rpm</span><br><span class="line">-rw-r--r-- 1 root root  50251656 Aug  1 09:46 MariaDB-10.2.7-centos7-x86_64-client.rpm</span><br><span class="line">-rw-r--r-- 1 root root    158012 Aug  1 09:46 MariaDB-10.2.7-centos7-x86_64-common.rpm</span><br><span class="line">-rw-r--r-- 1 root root   2975776 Aug  1 09:46 MariaDB-10.2.7-centos7-x86_64-compat.rpm</span><br><span class="line">-rw-r--r-- 1 root root 113565340 Aug  1 09:46 MariaDB-10.2.7-centos7-x86_64-server.rpm</span><br></pre></td></tr></table></figure>
<h2 id="拷贝模板配置文件"><a href="#拷贝模板配置文件" class="headerlink" title="拷贝模板配置文件"></a>拷贝模板配置文件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@mysql_a ~]# ansible mysql -a &#x27;cp /usr/share/mysql/my-medium.cnf /etc/my.cnf&#x27;</span><br></pre></td></tr></table></figure>
<h2 id="各服务器上执行初始化操作"><a href="#各服务器上执行初始化操作" class="headerlink" title="各服务器上执行初始化操作"></a>各服务器上执行初始化操作</h2><p>mysql_secure_installation</p>
<h2 id="修改mysql-b配置文件"><a href="#修改mysql-b配置文件" class="headerlink" title="修改mysql_b配置文件"></a>修改mysql_b配置文件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/my.cnf</span><br><span class="line">log-bin=/var/lib/mysql/mysql-bin</span><br><span class="line">binlog_format=row</span><br><span class="line">server-id = 127</span><br><span class="line">sync_binlog = 1</span><br><span class="line">innodb_support_xa = 1</span><br><span class="line">innodb-flush-log-at-trx-commit=1</span><br></pre></td></tr></table></figure>
<h2 id="建立授权账号"><a href="#建立授权账号" class="headerlink" title="建立授权账号"></a>建立授权账号</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@mysql_b mariadb]# mysql -uroot -pffffff</span><br><span class="line">MariaDB [mysql]&gt; grant replication slave on *.* to &#x27;repl&#x27;@&#x27;192.168.6.%&#x27; identified by &#x27;111111&#x27;;</span><br><span class="line">MariaDB [(none)]&gt; show master status;</span><br><span class="line">+------------------+----------+--------------+------------------+</span><br><span class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |</span><br><span class="line">+------------------+----------+--------------+------------------+</span><br><span class="line">| mysql-bin.000002 |      342 |              |                  |</span><br><span class="line">+------------------+----------+--------------+------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<h2 id="修改mysql-c配置文件"><a href="#修改mysql-c配置文件" class="headerlink" title="修改mysql_c配置文件"></a>修改mysql_c配置文件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/my.cnf</span><br><span class="line">binlog_format=row</span><br><span class="line">server-id  = 128</span><br><span class="line">replicate-ignore-db=mysql</span><br><span class="line">relay_log=relay-bin</span><br></pre></td></tr></table></figure>
<h2 id="重启两台Mariadb-mysql-服务"><a href="#重启两台Mariadb-mysql-服务" class="headerlink" title="重启两台Mariadb(mysql)服务"></a>重启两台Mariadb(mysql)服务</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@mysql_a ~]# ansible mysql -a &#x27;systemctl restart mariadb.service&#x27;</span><br></pre></td></tr></table></figure>
<h2 id="开启主从同步"><a href="#开启主从同步" class="headerlink" title="开启主从同步"></a>开启主从同步</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@mysql_c mysql]# mysql -uroot –pffffff</span><br><span class="line">MariaDB [(none)]&gt; stop slave;</span><br><span class="line">MariaDB [(none)]&gt; change master to master_host=&#x27;mysql_b&#x27;, master_user=&#x27;repl&#x27;, master_password=&#x27;111111&#x27;,master_log_file=&#x27;mysql-bin.000002&#x27;,master_log_pos=342;</span><br><span class="line">MariaDB [(none)]&gt; start slave;</span><br><span class="line">MariaDB [(none)]&gt; show slave status\G</span><br></pre></td></tr></table></figure>
<p><img src="/images/2017/0801/01.png" alt="mariadb"></p>
<h1 id="Atlas安装配置"><a href="#Atlas安装配置" class="headerlink" title="Atlas安装配置"></a>Atlas安装配置</h1><h2 id="安装Mariadb-Mysql-客户端"><a href="#安装Mariadb-Mysql-客户端" class="headerlink" title="安装Mariadb(Mysql)客户端"></a>安装Mariadb(Mysql)客户端</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@mysql_a mariadb]# yum install MariaDB-client</span><br><span class="line">[root@mysql_a mariadb]# systemctl status mariadb.service //确保Atlas本机没有mysql服务被启动</span><br><span class="line">Unit mariadb.service could not be found.</span><br></pre></td></tr></table></figure>
<h2 id="安装atlas"><a href="#安装atlas" class="headerlink" title="安装atlas"></a>安装atlas</h2><p>下载的时候有两个软件包带分片功能的Atlas-sharding 和Atlas，我们下后边这个（el6的包centos7可以安装）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@mysql_a src]# axel https://github.com/Qihoo360/Atlas/releases/download/2.2.1/Atlas-2.2.1.el6.x86_64.rpm</span><br><span class="line">[root@mysql_a src]# rpm -ivh Atlas-2.2.1.el6.x86_64.rpm</span><br></pre></td></tr></table></figure>
<p>安装目录为&#x2F;usr&#x2F;local&#x2F;mysql-proxy&#x2F;，会在此目录下生成bin,conf,lib,log四个目录</p>
<h2 id="生成一个加密字符串，配置文件中会用到"><a href="#生成一个加密字符串，配置文件中会用到" class="headerlink" title="生成一个加密字符串，配置文件中会用到"></a>生成一个加密字符串，配置文件中会用到</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@mysql_a bin]# ./encrypt 111111</span><br><span class="line">kOVJsquUepY=</span><br></pre></td></tr></table></figure>
<h2 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h2><p><em>360团队很良心，中文注释很详细</em></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@mysql_a bin]# vim /usr/local/mysql-proxy/conf/test.cnf</span><br><span class="line">[mysql-proxy]</span><br><span class="line"></span><br><span class="line">#带#号的为非必需的配置项目</span><br><span class="line"></span><br><span class="line">#管理接口的用户名</span><br><span class="line">admin-username = nsxq</span><br><span class="line"></span><br><span class="line">#管理接口的密码</span><br><span class="line">admin-password = ffffff</span><br><span class="line"></span><br><span class="line">#Atlas后端连接的MySQL主库的IP和端口，可设置多项，用逗号分隔</span><br><span class="line">proxy-backend-addresses = 192.168.6.127:3306</span><br><span class="line"></span><br><span class="line">#Atlas后端连接的MySQL从库的IP和端口，@后面的数字代表权重，用来作负载均衡，若省略则默认为1，可设置多项，用逗号分隔</span><br><span class="line">proxy-read-only-backend-addresses = 192.168.6.128:3306@1</span><br><span class="line"></span><br><span class="line">#用户名与其对应的加密过的MySQL密码，密码使用PREFIX/bin目录下的加密程序encrypt加密，下行的user1和user2为示例，将其替换为你的MySQL的用户名和加密密码！</span><br><span class="line">pwds = atlas:kOVJsquUepY=</span><br><span class="line"></span><br><span class="line">#设置Atlas的运行方式，设为true时为守护进程方式，设为false时为前台方式，一般开发调试时设为false，线上运行时设为true,true后面不能有空格。</span><br><span class="line">daemon = true</span><br><span class="line"></span><br><span class="line">#设置Atlas的运行方式，设为true时Atlas会启动两个进程，一个为monitor，一个为worker，monitor在worker意外退出后会自动将其重启，设为false时只有worker，没有monitor，一般开发调试时设为false，线上&gt;</span><br><span class="line">运行时设为true,true后面不能有空格。</span><br><span class="line">keepalive = true</span><br><span class="line"></span><br><span class="line">#工作线程数，对Atlas的性能有很大影响，可根据情况适当设置</span><br><span class="line">event-threads = 8</span><br><span class="line"></span><br><span class="line">#日志级别，分为message、warning、critical、error、debug五个级别</span><br><span class="line">log-level = message</span><br><span class="line"></span><br><span class="line">#日志存放的路径</span><br><span class="line">log-path = /usr/local/mysql-proxy/log</span><br><span class="line"></span><br><span class="line">#SQL日志的开关，可设置为OFF、ON、REALTIME，OFF代表不记录SQL日志，ON代表记录SQL日志，REALTIME代表记录SQL日志且实时写入磁盘，默认为OFF</span><br><span class="line">#sql-log = OFF</span><br><span class="line"></span><br><span class="line">#慢日志输出设置。当设置了该参数时，则日志只输出执行时间超过sql-log-slow（单位：ms)的日志记录。不设置该参数则输出全部日志。</span><br><span class="line">#sql-log-slow = 10</span><br><span class="line"></span><br><span class="line">#实例名称，用于同一台机器上多个Atlas实例间的区分</span><br><span class="line">#instance = test</span><br><span class="line"></span><br><span class="line">#Atlas监听的工作接口IP和端口</span><br><span class="line">proxy-address = 0.0.0.0:1234 </span><br><span class="line">#分表设置，此例中person为库名，mt为表名，id为分表字段，3为子表数量，可设置多项，以逗号分隔，若不分表则不需要设置该项</span><br><span class="line">#tables = person.mt.id.3</span><br><span class="line"></span><br><span class="line">#默认字符集，设置该项后客户端不再需要执行SET NAMES语句</span><br><span class="line">#charset = utf8</span><br><span class="line"></span><br><span class="line">#允许连接Atlas的客户端的IP，可以是精确IP，也可以是IP段，以逗号分隔，若不设置该项则允许所有IP连接，否则只允许列表中的IP连接</span><br><span class="line">#client-ips = 127.0.0.1, 192.168.1</span><br><span class="line"></span><br><span class="line">#Atlas前面挂接的LVS的物理网卡的IP(注意不是虚IP)，若有LVS且设置了client-ips则此项必须设置，否则可以不设置</span><br><span class="line">#lvs-ips = 192.168.1.1</span><br></pre></td></tr></table></figure>
<h2 id="启动Atlas服务"><a href="#启动Atlas服务" class="headerlink" title="启动Atlas服务"></a>启动Atlas服务</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@mysql_a bin]# ./mysql-proxyd test start</span><br><span class="line">[root@mysql_a mariadb]# ps -ef |grep mysql</span><br><span class="line">root     21456     1  0 15:24 ?        00:00:00 /usr/local/mysql-proxy/bin/mysql-proxy --defaults-file=/usr/local/mysql-proxy/conf/test.cnf</span><br><span class="line">root     21457 21456  0 15:24 ?        00:00:00 /usr/local/mysql-proxy/bin/mysql-proxy --defaults-file=/usr/local/mysql-proxy/conf/test.cnf</span><br><span class="line">root     21607 20025  0 15:35 pts/0    00:00:00 grep --color=auto mysql</span><br></pre></td></tr></table></figure>
<h2 id="通过Atlas访问"><a href="#通过Atlas访问" class="headerlink" title="通过Atlas访问"></a>通过Atlas访问</h2><h3 id="通过管理接口访问"><a href="#通过管理接口访问" class="headerlink" title="通过管理接口访问"></a>通过管理接口访问</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@mysql_a mariadb]# mysql -h127.0.0.1 -P2345 -unsxq –pffffff</span><br></pre></td></tr></table></figure>
<h3 id="通过工作接口访问"><a href="#通过工作接口访问" class="headerlink" title="通过工作接口访问"></a>通过工作接口访问</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">要保证这个用户在主从节点上都有权限，在主从节点上都添加一个用户</span><br><span class="line">MariaDB [mysql]&gt; grant all on *.* to atlas@&#x27;192.168.6.%&#x27; identified by &#x27;111111&#x27;;</span><br><span class="line">[root@mysql_a mariadb]# mysql -h127.0.0.1 -P1234 -uatlas -p111111  </span><br></pre></td></tr></table></figure>

<p>参考连接：<br><a href="https://github.com/Qihoo360/Atlas/wiki">https://github.com/Qihoo360/Atlas/wiki</a><br><a href="http://www.cnblogs.com/yyhh/p/5084844.html">http://www.cnblogs.com/yyhh/p/5084844.html</a></p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>数据库</tag>
        <tag>Mysql</tag>
        <tag>Mariadb</tag>
      </tags>
  </entry>
  <entry>
    <title>NFS 服务器搭建记录</title>
    <url>/arlo/dd17c5bd/</url>
    <content><![CDATA[<h1 id="系统环境"><a href="#系统环境" class="headerlink" title="系统环境"></a>系统环境</h1><p>Centos 6.5<br>Iptables：off<br>Selinux：disabled</p>
<p>由于MBR分区表只支持2T的硬盘，&#x2F;dev&#x2F;sdb是一块10T的硬盘，使用GPT分区表，需要使用parted工具分区</p>
<span id="more"></span>
<h1 id="使用fdisk查看磁盘"><a href="#使用fdisk查看磁盘" class="headerlink" title="使用fdisk查看磁盘"></a>使用fdisk查看磁盘</h1><p>ps：这个之后又增加了一块10T的硬盘，这个截图早一点，没提现出来<br><img src="/images/2017/0613/00.png" alt="插入图片01"></p>
<h1 id="使用parted工具分区"><a href="#使用parted工具分区" class="headerlink" title="使用parted工具分区"></a>使用parted工具分区</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sg020 ~]# parted /dev/sdb </span><br></pre></td></tr></table></figure>
<p>GNU Parted 2.1<br>Using &#x2F;dev&#x2F;sdb<br>Welcome to GNU Parted! Type ‘help’ to view a list of commands.<br>(parted) <font color=red>print</font><br>Model: VMware Virtual disk (scsi)<br>Disk &#x2F;dev&#x2F;sdb: 9896GB<br>Sector size (logical&#x2F;physical): 512B&#x2F;512B<br>Partition Table:  <font color=red>gpt</font>  </p>
<p>Number  Start  End  Size  File system  Name  Flags</p>
<p>(parted)<font color=red> mkpart primary 0 10T</font><br>Warning: The resulting partition is not properly aligned for best performance.<br>Ignore&#x2F;Cancel?<font color=red> Ignore </font><br>(parted)<font color=red> print </font><br>Model: VMware Virtual disk (scsi)<br>Disk &#x2F;dev&#x2F;sdb: 9896GB<br>Sector size (logical&#x2F;physical): 512B&#x2F;512B<br>Partition Table: gpt</p>
<p>Number  Start   End     Size    File system  Name     Flags<br> 1      17.4kB  9896GB  9896GB               primary</p>
<p>(parted) <font color=red> quit </font><br>Information: You may need to update &#x2F;etc&#x2F;fstab.<br><img src="/images/2017/0613/01.png" alt="插入图片01"><br>(parted) <font color=red> set 1 lvm on </font><br>(parted) <font color=red> print  </font><br>Model: VMware Virtual disk (scsi)<br>Disk &#x2F;dev&#x2F;sdb: 9896GB<br>Sector size (logical&#x2F;physical): 512B&#x2F;512B<br>Partition Table: gpt</p>
<p>Number  Start   End     Size    File system  Name     Flags<br> 1      17.4kB  9896GB  9896GB  ext4         primary  lvm<br>(parted) <font color=red> quit </font><br>Information: You may need to update &#x2F;etc&#x2F;fstab.<br><img src="/images/2017/0613/05.png" alt="插入图片01"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sg020 ~]# parted /dev/sdc</span><br></pre></td></tr></table></figure>
<p>GNU Parted 2.1<br>Using &#x2F;dev&#x2F;sdc<br>Welcome to GNU Parted! Type ‘help’ to view a list of commands.<br>(parted)<font color=red> print   </font><br>Error: &#x2F;dev&#x2F;sdc: unrecognised disk label<br>(parted) <font color=red> mklabel gpt </font><br>(parted) <font color=red> print </font><br>Model: VMware Virtual disk (scsi)<br>Disk &#x2F;dev&#x2F;sdc: 11.0TB<br>Sector size (logical&#x2F;physical): 512B&#x2F;512B<br>Partition Table: gpt</p>
<p>Number  Start  End  Size  File system  Name  Flags</p>
<p>(parted)<font color=red> mkpart primary 0 10995G </font><br>Warning: The resulting partition is not properly aligned for best performance.<br>Ignore&#x2F;Cancel?<font color=red> Ignore   </font><br>(parted)<font color=red> print </font><br>Model: VMware Virtual disk (scsi)<br>Disk &#x2F;dev&#x2F;sdc: 11.0TB<br>Sector size (logical&#x2F;physical): 512B&#x2F;512B<br>Partition Table: gpt</p>
<p>Number  Start   End     Size    File system  Name     Flags<br> 1      17.4kB  11.0TB  11.0TB               primary</p>
<p>(parted) <font color=red> set 1 lvm on   </font><br>(parted) <font color=red> print  </font><br>Model: VMware Virtual disk (scsi)<br>Disk &#x2F;dev&#x2F;sdc: 11.0TB<br>Sector size (logical&#x2F;physical): 512B&#x2F;512B<br>Partition Table: gpt</p>
<p>Number  Start   End     Size    File system  Name     Flags<br> 1      17.4kB  11.0TB  11.0TB               primary  lvm</p>
<p>(parted) <font color=red> quit </font><br>Information: You may need to update &#x2F;etc&#x2F;fstab.<br><img src="/images/2017/0613/06.png" alt="插入图片01"></p>
<h1 id="lvm-划分"><a href="#lvm-划分" class="headerlink" title="lvm 划分"></a>lvm 划分</h1><h2 id="创建pv"><a href="#创建pv" class="headerlink" title="创建pv"></a>创建pv</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sg020 ~]# pvcreate /dev/sdb1 /dev/sdc1 </span><br></pre></td></tr></table></figure>
<p>  dev_is_mpath: failed to get device for 8:17<br>  Physical volume “&#x2F;dev&#x2F;sdb1” successfully created<br>  dev_is_mpath: failed to get device for 8:33<br>  Physical volume “&#x2F;dev&#x2F;sdc1” successfully created</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sg020 ~]# pvdisplay </span><br></pre></td></tr></table></figure>
<p>— Physical volume —<br>  PV Name               &#x2F;dev&#x2F;sda2<br>  VG Name               vg_sg020<br>  PV Size               193.51 GiB &#x2F; not usable 3.00 MiB<br>  Allocatable           yes (but full)<br>  PE Size               4.00 MiB<br>  Total PE              49538<br>  Free PE               0<br>  Allocated PE          49538<br>  PV UUID               BF6Ikw-eYtl-HfNM-Nnmt-WLK4-xb8O-KAnZtB</p>
<p>  “&#x2F;dev&#x2F;sdb1” is a new physical volume of “9.00 TiB”<br>  — NEW Physical volume —<br>  PV Name               &#x2F;dev&#x2F;sdb1<br>  VG Name<br>  PV Size               9.00 TiB<br>  Allocatable           NO<br>  PE Size               0<br>  Total PE              0<br>  Free PE               0<br>  Allocated PE          0<br>  PV UUID               aPPVxz-oeWE-lP9l-AeZU-p699-pffd-O7T3dW</p>
<p>  “&#x2F;dev&#x2F;sdc1” is a new physical volume of “10.00 TiB”<br>  — NEW Physical volume —<br>  PV Name               &#x2F;dev&#x2F;sdc1<br>  VG Name<br>  PV Size               10.00 TiB<br>  Allocatable           NO<br>  PE Size               0<br>  Total PE              0<br>  Free PE               0<br>  Allocated PE          0<br>  PV UUID               MWbqIl-WI66-JCsc-x0Re-UqjL-HgXB-Vw1jge<br><img src="/images/2017/0613/07.png" alt="插入图片01"></p>
<h2 id="创建vg"><a href="#创建vg" class="headerlink" title="创建vg"></a>创建vg</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sg020 ~]# vgcreate vg_fuz /dev/sdb1 /dev/sdc1 </span><br></pre></td></tr></table></figure>
<p>  Volume group “vg_fuz” successfully created</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sg020 ~]# vgdisplay </span><br></pre></td></tr></table></figure>
<p>— Volume group —<br>  VG Name               vg_fuz<br>  System ID<br>  Format                lvm2<br>  Metadata Areas        2<br>  Metadata Sequence No  1<br>  VG Access             read&#x2F;write<br>  VG Status             resizable<br>  MAX LV                0<br>  Cur LV                0<br>  Open LV               0<br>  Max PV                0<br>  Cur PV                2<br>  Act PV                2<br>  VG Size               19.00 TiB<br>  PE Size               4.00 MiB<br>  Total PE              4980734<br>  Alloc PE &#x2F; Size       0 &#x2F; 0<br>  Free  PE &#x2F; Size       4980734 &#x2F; 19.00 TiB<br>  VG UUID               ruDcio-mmt5-z6YD-7HS0-fbst-GIlT-SwmvcF</p>
<p>  — Volume group —<br>  VG Name               vg_sg020<br>  System ID<br>  Format                lvm2<br>  Metadata Areas        1<br>  Metadata Sequence No  4<br>  VG Access             read&#x2F;write<br>  VG Status             resizable<br>  MAX LV                0<br>  Cur LV                3<br>  Open LV               3<br>  Max PV                0<br>  Cur PV                1<br>  Act PV                1<br>  VG Size               193.51 GiB<br>  PE Size               4.00 MiB<br>  Total PE              49538<br>  Alloc PE &#x2F; Size       49538 &#x2F; 193.51 GiB<br>  Free  PE &#x2F; Size       0 &#x2F; 0<br>  VG UUID               2E6Hdt-xWhi-DyLX-pDva-3WTw-fDNx-Qytoqg<br><img src="/images/2017/0613/08.png" alt="插入图片01"></p>
<h2 id="创建lv"><a href="#创建lv" class="headerlink" title="创建lv"></a>创建lv</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sg020 ~]# lvcreate -n lv_fuz -l 4980734 vg_fuz</span><br></pre></td></tr></table></figure>
<p>Logical volume “lv_fuz” created</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sg020 ~]# lvdisplay </span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">--- Logical volume ---</span><br><span class="line">  LV Path                /dev/vg_fuz/lv_fuz</span><br><span class="line">  LV Name                lv_fuz</span><br><span class="line">  VG Name                vg_fuz</span><br><span class="line">  LV UUID                JTUEVa-9JPb-0VaD-5JH8-fwov-MuUS-gp1Gdr</span><br><span class="line">  LV Write Access        read/write</span><br><span class="line">  LV Creation host, time sg020, 2017-06-14 09:27:14 +0800</span><br><span class="line">  LV Status              available</span><br><span class="line">  \# open                 0</span><br><span class="line">  LV Size                19.00 TiB</span><br><span class="line">  Current LE             4980734</span><br><span class="line">  Segments               2</span><br><span class="line">  Allocation             inherit</span><br><span class="line">  Read ahead sectors     auto</span><br><span class="line">  \- currently set to     256</span><br><span class="line">  Block device           253:3</span><br><span class="line"></span><br><span class="line">  --- Logical volume ---</span><br><span class="line">  LV Path                /dev/vg_sg020/lv_root</span><br><span class="line">  LV Name                lv_root</span><br><span class="line">  VG Name                vg_sg020</span><br><span class="line">  LV UUID                5yHVBf-Qt3u-fzb2-gwNL-opy3-0ewQ-0ypYsc</span><br><span class="line">  LV Write Access        read/write</span><br><span class="line">  LV Creation host, time livedvd.centos, 2017-06-09 15:49:11 +0800</span><br><span class="line">  LV Status              available</span><br><span class="line">  \# open                 1</span><br><span class="line">  LV Size                50.00 GiB</span><br><span class="line">  Current LE             12800</span><br><span class="line">  Segments               1</span><br><span class="line">  Allocation             inherit</span><br><span class="line">  Read ahead sectors     auto</span><br><span class="line">  \- currently set to     256</span><br><span class="line">  Block device           253:0</span><br><span class="line"></span><br><span class="line">  --- Logical volume ---</span><br><span class="line">  LV Path                /dev/vg_sg020/lv_home</span><br><span class="line">  LV Name                lv_home</span><br><span class="line">  VG Name                vg_sg020</span><br><span class="line">  LV UUID                d1bsIq-ZeVr-mxk1-Mu2U-7H1R-wXMX-rWZ9hj</span><br><span class="line">  LV Write Access        read/write</span><br><span class="line">  LV Creation host, time livedvd.centos, 2017-06-09 15:49:19 +0800</span><br><span class="line">  LV Status              available</span><br><span class="line">  \# open                 1</span><br><span class="line">  LV Size                124.11 GiB</span><br><span class="line">  Current LE             31772</span><br><span class="line">  Segments               1</span><br><span class="line">  Allocation             inherit</span><br><span class="line">  Read ahead sectors     auto</span><br><span class="line">  \- currently set to     256</span><br><span class="line">  Block device           253:2</span><br><span class="line"></span><br><span class="line">  --- Logical volume ---</span><br><span class="line">  LV Path                /dev/vg_sg020/lv_swap</span><br><span class="line">  LV Name                lv_swap</span><br><span class="line">  VG Name                vg_sg020</span><br><span class="line">  LV UUID                wGW4BB-KB5g-UUZ8-FwLQ-pTYy-Eoc2-ji102r</span><br><span class="line">  LV Write Access        read/write</span><br><span class="line">  LV Creation host, time livedvd.centos, 2017-06-09 15:49:37 +0800</span><br><span class="line">  LV Status              available</span><br><span class="line">  \# open                 1</span><br><span class="line">  LV Size                19.40 GiB</span><br><span class="line">  Current LE             4966</span><br><span class="line">  Segments               1</span><br><span class="line">  Allocation             inherit</span><br><span class="line">  Read ahead sectors     auto</span><br><span class="line">  \- currently set to     256</span><br><span class="line">  Block device           253:1</span><br></pre></td></tr></table></figure>

<p><img src="/images/2017/0613/09.png" alt="插入图片01"></p>
<h1 id="格式化分区"><a href="#格式化分区" class="headerlink" title="格式化分区"></a>格式化分区</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sg020 ~]# mkfs.ext4 /dev/vg_fuz/lv_fuz</span><br><span class="line">mke2fs 1.41.12 (17-May-2010)</span><br><span class="line">mkfs.ext4: Size of device /dev/vg_fuz/lv_fuz too big to be expressed in 32 bits</span><br><span class="line">	using a blocksize of 4096.</span><br></pre></td></tr></table></figure>
<p><strong><font color=red> ext4格式的分区，不支持大于16TB的硬盘分区，我们使用xfs格式</font></strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sg020 ~]# yum install xfsprogs</span><br><span class="line">[root@sg020 ~]# mkfs.xfs /dev/vg_fuz/lv_fuz</span><br></pre></td></tr></table></figure>
<p><img src="/images/2017/0613/02.png" alt="插入图片01"></p>
<h1 id="查找分区UUID"><a href="#查找分区UUID" class="headerlink" title="查找分区UUID"></a>查找分区UUID</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sg020 ~]# blkid /dev/vg_fuz/lv_fuz </span><br><span class="line">/dev/vg_fuz/lv_fuz: UUID=&quot;3c2731e9-eac4-4e05-b103-be061e4c009c&quot; TYPE=&quot;xfs&quot;</span><br></pre></td></tr></table></figure>
<h1 id="添加到fstab"><a href="#添加到fstab" class="headerlink" title="添加到fstab"></a>添加到fstab</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sg020 ~]# mkdir /data</span><br><span class="line">[root@sg020 ~]# echo &#x27;UUID=3c2731e9-eac4-4e05-b103-be061e4c009c /data xfs    defaults        0 0&#x27;  &gt;&gt; /etc/fstab</span><br></pre></td></tr></table></figure>
<h1 id="挂载分区"><a href="#挂载分区" class="headerlink" title="挂载分区"></a>挂载分区</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sg020 ~]# mount –a</span><br><span class="line">[root@sg020 ~]# mount |column –t</span><br></pre></td></tr></table></figure>
<p><img src="/images/2017/0613/03.png" alt="插入图片01"> </p>
<h1 id="查看安装nfs软件"><a href="#查看安装nfs软件" class="headerlink" title="查看安装nfs软件"></a>查看安装nfs软件</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sg020 ~]# yum -y install nfs-utils rpcbind</span><br><span class="line">[root@sg020 ~]# rpm -qa |grep nfs</span><br></pre></td></tr></table></figure>
<p>nfs-utils-1.2.3-39.el6.x86_64<br>nfs-utils-lib-1.1.5-6.el6.x86_64<br>nfs4-acl-tools-0.3.3-6.el6.x86_6</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sg020 ~]# rpm -qa |grep rpcbind</span><br></pre></td></tr></table></figure>
<p>rpcbind-0.2.0-11.el6.x86_64</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/etc/exports文件内容格式：</span><br><span class="line">&lt;输出目录&gt; [客户端1 选项（访问权限,用户映射,其他）] [客户端2 选项（访问权限,用户映射,其他）]</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sg020 ~]# cat /etc/exports </span><br><span class="line">/data	218.193.126.128/25(insecure,rw,async,no_root_squash)  59.77.252.0/26(insecure,rw,async,no_root_squash)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">NFS的常用目录</span><br><span class="line">/etc/exports                           NFS服务的主要配置文件</span><br><span class="line">/usr/sbin/exportfs                   NFS服务的管理命令</span><br><span class="line">/usr/sbin/showmount              客户端的查看命令</span><br><span class="line">/var/lib/nfs/etab                      记录NFS分享出来的目录的完整权限设定值</span><br><span class="line">/var/lib/nfs/xtab                      记录曾经登录过的客户端信息</span><br></pre></td></tr></table></figure>

<h1 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sg020 ~]# /etc/init.d/rpcbind start</span><br><span class="line">Starting rpcbind:                                          [  OK  ]</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sg020 ~]# /etc/init.d/nfs start</span><br><span class="line">Starting NFS services:                                     [  OK  ]</span><br><span class="line">Starting NFS quotas:                                       [  OK  ]</span><br><span class="line">Starting NFS mountd:                                       [  OK  ]</span><br><span class="line">Starting NFS daemon:                                       [  OK  ]</span><br><span class="line">Starting RPC idmapd:                                       [  OK  ] </span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sg020 ~]# chkconfig --level 35 rpcbind on</span><br><span class="line">[root@sg020 ~]# chkconfig --level 35 nfs on</span><br></pre></td></tr></table></figure>
<h2 id="重新共享所有目录并输出详细信息"><a href="#重新共享所有目录并输出详细信息" class="headerlink" title="重新共享所有目录并输出详细信息"></a>重新共享所有目录并输出详细信息</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sg020 ~]# exportfs -rv </span><br><span class="line">exporting 218.193.126.128/25:/data</span><br><span class="line">exporting 59.77.252.0/26:/data</span><br></pre></td></tr></table></figure>
<h2 id="卸载所有共享目"><a href="#卸载所有共享目" class="headerlink" title="卸载所有共享目"></a>卸载所有共享目</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sg020 ~]# exportfs -au</span><br></pre></td></tr></table></figure>
<h1 id="客户端挂载"><a href="#客户端挂载" class="headerlink" title="客户端挂载"></a>客户端挂载</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sg011 ~]#  mount -t nfs sg020:/data/ /data</span><br><span class="line">[root@sg011 ~]#  echo “sg020:/data             /data   nfs nolock 0 0” &gt;&gt; /etc/fstab</span><br><span class="line">[root@sg011~]# mount –a</span><br><span class="line">[root@sg011 ~]# mount |column –t</span><br></pre></td></tr></table></figure>
<p><img src="/images/2017/0613/04.png" alt="插入图片01"> </p>
<h2 id="user-amp-group-是nobody的问题"><a href="#user-amp-group-是nobody的问题" class="headerlink" title="user &amp; group 是nobody的问题"></a>user &amp; group 是nobody的问题</h2><p>由于centos6以后采用的是nfs v4，所以在挂载后，服务端和客户端看到的信息不一致，客户端看到文件的user和group都是nobody 或nfsnobody，以下是解决办法</p>
<h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><p>修改配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># vi /etc/idmapd.conf</span><br><span class="line">Domain = hpcnfs</span><br></pre></td></tr></table></figure>
<p>重启服务</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/etc/init.d/rpcidmapd restart </span><br><span class="line">chkconfig --level 35  rpcidmapd on</span><br></pre></td></tr></table></figure>
<h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><p>修改配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># vi /etc/idmapd.conf</span><br><span class="line">Domain = hpcnfs</span><br></pre></td></tr></table></figure>
<p>清除缓存</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nfsidmap -c</span><br></pre></td></tr></table></figure>
<p>重启服务</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/etc/init.d/rpcidmapd restart </span><br><span class="line">chkconfig --level 35  rpcidmapd on</span><br></pre></td></tr></table></figure>
<h1 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h1><h2 id="重启之后，如果客户端提示“Stale-file-handle”，三种解决方法："><a href="#重启之后，如果客户端提示“Stale-file-handle”，三种解决方法：" class="headerlink" title="重启之后，如果客户端提示“Stale file handle”，三种解决方法："></a>重启之后，如果客户端提示“Stale file handle”，三种解决方法：</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. umount /data;mount -a</span><br><span class="line">2. fuser -km /data; mount -a</span><br><span class="line">3. umount -lv /data; mount -a</span><br></pre></td></tr></table></figure>
<h2 id="lvm扩容，“resize2fs-Device-or-resource-busy-while-trying-to-open”，解决方法如下："><a href="#lvm扩容，“resize2fs-Device-or-resource-busy-while-trying-to-open”，解决方法如下：" class="headerlink" title="lvm扩容，“resize2fs: Device or resource busy while trying to open”，解决方法如下："></a>lvm扩容，“resize2fs: Device or resource busy while trying to open”，解决方法如下：</h2><p>其实做lvm不需要分区，直接将整个盘做成pv；扩容的vg时候，可以更懒一点，pv都不用做，直接vgextend；  </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vgextend vg_fuz /dev/sdc 	</span><br></pre></td></tr></table></figure>
<p>在扩容lv的时候，更加方便的做法是使用pe扩容，而不是容量（-L是容量，-l是PE，可以通过vgdisplay查看剩余）； </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">lvextend -l +3000 /dev/vg_fuz/lv_fuz 	</span><br></pre></td></tr></table></figure>
<p>fdisk可以看到到容量已经变化了，但是df还看不出来，我们可以使用resize2fs命令重设；</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">resize2fs /dev/vg_fuz/lv_fuz  </span><br></pre></td></tr></table></figure>
<p>xfs 文件系统 resize2fs已经不适用了，需要用到一个新的命令xfs_growfs；</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">xfs_growfs /dev/vg_fuz/lv_fuz </span><br></pre></td></tr></table></figure>
<p><img src="/images/2017/0613/10.png" alt="插入图片01"><br>因为整个环境是内网环境，需要拨vpn才能访问，我没有配置iptables，nfs的iptables配置也比较麻烦，回头研究一下；<br>另，今天遇到一个很有意思的情况（其实就是自己学艺不精），由于Nfs给两个网段提供服务，牵扯到一个跨网段的问题；我看了下服务器上的配置的网络情况，根据ip地址所在的网段（218.193.126.x和59.77.252.x）和子网掩码（25和26），配置了&#x2F;data 218.193.126.0&#x2F;25(insecure,rw,async,no_all_squash) 59.77.252.0&#x2F;26(insecure,rw,async,no_all_squash)，之后的情况就很诡异，59这个网络是可以正常访问的，218这个网络提示没有权限（mount.nfs: access denied by server while mounting sg020:&#x2F;data&#x2F;），搞得我很纳闷，配置到精确的ip地址就没有问题；后来经群里高手点播，网络和掩码的计算（218.193.126.0&#x2F;25意思应该是218.193.126.1~218.193.126.127），我的服务器ip是不在范围内的，回头需要补习一下网络基础。</p>
]]></content>
      <tags>
        <tag>Nfs</tag>
      </tags>
  </entry>
  <entry>
    <title>NIS 服务器搭建记录</title>
    <url>/arlo/3e02ce74/</url>
    <content><![CDATA[<h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>NIS是Network Information Services (NIS server)的缩写，是为了管理一个网络中的用户账号 ，以方便用户在不同的主机上登录时只需要一个账号即可，它将用户的账号保存在一个主机上，用户登录时只需向其发送请求确认账号是否正确。</p>
<span id="more"></span>
<h2 id="NIS-的主要功能：管理帐户信息"><a href="#NIS-的主要功能：管理帐户信息" class="headerlink" title="NIS 的主要功能：管理帐户信息"></a>NIS 的主要功能：管理帐户信息</h2><p><strong>服务器端文件名	档案内容</strong><br>&#x2F;etc&#x2F;passwd		提供用户账号、UID、GID、家目录所在、Shell 等等<br>&#x2F;etc&#x2F;group		提供群组数据以及 GID 的对应，还有该群组的加入人员<br>&#x2F;etc&#x2F;hosts		主机名与 IP 的对应，常用于 private IP 的主机名对应<br>&#x2F;etc&#x2F;services		每一种服务 (daemons) 所对应的埠口 (port number)<br>&#x2F;etc&#x2F;protocols		基础的 TCP&#x2F;IP 封包协定，如 TCP, UDP, ICMP 等<br>&#x2F;etc&#x2F;rpc		每种 RPC 服务器所对应的程序号码<br>&#x2F;var&#x2F;yp&#x2F;ypservers	NIS 服务器所提供的数据库</p>
<h1 id="NIS-Server端配置"><a href="#NIS-Server端配置" class="headerlink" title="NIS Server端配置"></a>NIS Server端配置</h1><p>yp-tools ：提供 NIS 相关的查寻指令功能。<br>ypbind ：提供 NIS Client 端的设定软件。<br>ypserv ：提供 NIS Server 端的设定软件。<br>rpcbind ：就是 RPC ，系统一般会安装上。</p>
<h2 id="安装NIS-Server-端软件"><a href="#安装NIS-Server-端软件" class="headerlink" title="安装NIS Server 端软件"></a>安装NIS Server 端软件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sg010 ~]# yum -y install yp-tools ypbind ypserv rpcbind</span><br><span class="line">[root@sg010 ~]#  rpm -qa | grep &#x27;^yp&#x27; </span><br></pre></td></tr></table></figure>
<p>ypbind-1.20.4-33.el6.x86_64<br>yp-tools-2.9-12.el6.x86_64<br>ypserv-2.19-31.el6.x86_64</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sg010 ~]#  rpm -qa | grep rpcbind</span><br></pre></td></tr></table></figure>
<p>rpcbind-0.2.0-13.el6_9.x86_64</p>
<h2 id="配置hosts文件"><a href="#配置hosts文件" class="headerlink" title="配置hosts文件"></a>配置hosts文件</h2><p>Hosts文件中之前的记录不要动，新增包含nis server 和 nis client 的主机与ip对应记录</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[[root@sg010 ~]# vim /etc/sysconfig/network</span><br><span class="line">\#增加以下两行</span><br><span class="line">NISDOMAIN=hpcnis</span><br><span class="line">YPSERV_ARGS=&quot;-p 1011&quot;</span><br></pre></td></tr></table></figure>
<h2 id="配置nis服务"><a href="#配置nis服务" class="headerlink" title="配置nis服务"></a>配置nis服务</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sg010 ~]# egrep -v &#x27;^$|#&#x27; /etc/ypserv.conf </span><br><span class="line">dns: no</span><br><span class="line">files: 30</span><br><span class="line">xfr_check_port: yes</span><br><span class="line">\*			   : *       : shadow.byname    : port</span><br><span class="line">\*			   : *       : passwd.adjunct.byname : port</span><br><span class="line">127.0.0.0/255.0.0.0		:*:*:none</span><br><span class="line">218.193.126.128/255.255.255.128	:*:*:none</span><br><span class="line">59.77.252.0/255.255.255.192	:*:*:none</span><br><span class="line">\*			:*:*:deny</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sg010 ~]# vim /etc/sysconfig/yppasswdd</span><br><span class="line">YPPASSWDD_ARGS=&quot;--port 1012&quot;</span><br></pre></td></tr></table></figure>
<h2 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h2><p>启动后查看一下三个服务状态</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sg010 ~]# /etc/init.d/rpcbind status</span><br></pre></td></tr></table></figure>
<p>rpcbind (pid  18813) is running…</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sg010 ~]# /etc/init.d/ypserv status</span><br></pre></td></tr></table></figure>
<p>ypserv (pid  21054) is running…</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sg010 ~]# /etc/init.d/yppasswdd status</span><br></pre></td></tr></table></figure>
<p>rpc.yppasswdd (pid  23087) is running…<br>并设置开机自启动</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sg010 ~]# chkconfig --level 35 ypserv on</span><br><span class="line">[root@sg010 ~]# chkconfig --level 35 yppasswdd on</span><br><span class="line">[root@sg010 ~]# chkconfig --level 35 rpcbind on</span><br></pre></td></tr></table></figure>
<h2 id="添加用户，设置密码"><a href="#添加用户，设置密码" class="headerlink" title="添加用户，设置密码"></a>添加用户，设置密码</h2><p>[root@sg010 ~]# useradd -u 1001 nisuser1<br>[root@sg010 ~]# echo ffffff|passwd –stdin nisuser1<br>[root@sg010 ~]# &#x2F;usr&#x2F;lib64&#x2F;yp&#x2F;ypinit -m<br><img src="/images/2017/0614/00.png" alt="图片"></p>
<h1 id="Client-端配置"><a href="#Client-端配置" class="headerlink" title="Client 端配置"></a>Client 端配置</h1><p>[root@sg011 ~]# yum -y install ypbind yp-tools<br>[root@sg011 ~]# rpm -qa |grep ‘^yp’<br>yp-tools-2.9-12.el6.x86_64<br>ypbind-1.20.4-30.el6.x86_64</p>
<h2 id="配置NIS"><a href="#配置NIS" class="headerlink" title="配置NIS"></a>配置NIS</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sg011 ~]# setup</span><br></pre></td></tr></table></figure>
<p>xshell 的配色方案修改过，所以这里看到的图片颜色也不是那种蓝底色的<br>勾选NIS，启用NIS验证<br><img src="/images/2017/0614/01.png" alt="图片"><br>填写NIS的服务器域名和服务器地址<br><img src="/images/2017/0614/02.png" alt="图片"><br>Starting rpcbind:                                          [  OK  ]<br>Starting NIS service:                                      [  OK  ]<br>Binding NIS service: .                                     [  OK  ]<br><strong>刚才的步骤其实就是做了以下操作</strong></p>
<ul>
<li>&#x2F;etc&#x2F;sysconfig&#x2F;network (加入 NISDOMAIN 项目)</li>
<li>&#x2F;etc&#x2F;yp.conf (亦即是 ypbind 的配置文件)</li>
<li>&#x2F;etc&#x2F;nsswitch.conf (修改许多主机验证功能的顺序)</li>
<li>&#x2F;etc&#x2F;sysconfig&#x2F;authconfig (CentOS 的认证机制)</li>
<li>&#x2F;etc&#x2F;pam.d&#x2F;system-auth (许多登入所需要的 PAM 认证过程)</li>
<li>启动了rpcbind 和 ypbind服务</li>
</ul>
<h3 id="x2F-etc-x2F-sysconfig-x2F-network"><a href="#x2F-etc-x2F-sysconfig-x2F-network" class="headerlink" title="&#x2F;etc&#x2F;sysconfig&#x2F;network"></a>&#x2F;etc&#x2F;sysconfig&#x2F;network</h3><p><img src="/images/2017/0614/03.png" alt="图片"></p>
<h3 id="x2F-etc-x2F-yp-conf"><a href="#x2F-etc-x2F-yp-conf" class="headerlink" title="&#x2F;etc&#x2F;yp.conf"></a>&#x2F;etc&#x2F;yp.conf</h3><p><img src="/images/2017/0614/04.png" alt="图片"> </p>
<h3 id="x2F-etc-x2F-nsswitch-conf"><a href="#x2F-etc-x2F-nsswitch-conf" class="headerlink" title="&#x2F;etc&#x2F;nsswitch.conf"></a>&#x2F;etc&#x2F;nsswitch.conf</h3><p>主机验证顺序</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">passwd:     files nis</span><br><span class="line">shadow:     files nis</span><br><span class="line">group:      files nis</span><br><span class="line">\#hosts:     db files nisplus nis dns</span><br><span class="line">hosts:      files nis dns</span><br></pre></td></tr></table></figure>
<h3 id="x2F-etc-x2F-sysconfig-x2F-authconfig"><a href="#x2F-etc-x2F-sysconfig-x2F-authconfig" class="headerlink" title="&#x2F;etc&#x2F;sysconfig&#x2F;authconfig"></a>&#x2F;etc&#x2F;sysconfig&#x2F;authconfig</h3><p>启用NIS</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">USENIS=yes</span><br></pre></td></tr></table></figure>
<h3 id="x2F-etc-x2F-pam-d-x2F-system-auth"><a href="#x2F-etc-x2F-pam-d-x2F-system-auth" class="headerlink" title="&#x2F;etc&#x2F;pam.d&#x2F;system-auth"></a>&#x2F;etc&#x2F;pam.d&#x2F;system-auth</h3><p>在pam验证过程中增加了nis</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">password    sufficient    pam_unix.so sha512 shadow nis nullok try_first_pass use_authtok</span><br></pre></td></tr></table></figure>
<h2 id="客户端简单粗暴的验证方法"><a href="#客户端简单粗暴的验证方法" class="headerlink" title="客户端简单粗暴的验证方法"></a>客户端简单粗暴的验证方法</h2><h3 id="切换用户验证"><a href="#切换用户验证" class="headerlink" title="切换用户验证"></a>切换用户验证</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sg011 ~]# grep nisuser1 /etc/passwd</span><br><span class="line">[root@sg011 ~]# su - nisuser1</span><br></pre></td></tr></table></figure>
<p>su: warning: cannot change directory to &#x2F;home&#x2F;nisuser1: No such file or directory<br>-bash-4.1$<br><img src="/images/2017/0614/05.png" alt="图片"></p>
<h3 id="没有用户主目录"><a href="#没有用户主目录" class="headerlink" title="没有用户主目录"></a>没有用户主目录</h3><p>两种解决方式</p>
<ol>
<li>新建一个&#x2F;home&#x2F;nisuser1目录,cp &#x2F;etc&#x2F;skel&#x2F;* &#x2F;home&#x2F;niuser1</li>
<li>使用nfs，挂载nis server的home目录，客户端和服务器使用的是同一个用户目录，保持一致性（推荐）</li>
</ol>
<h2 id="修改用户的默认shell"><a href="#修改用户的默认shell" class="headerlink" title="修改用户的默认shell"></a>修改用户的默认shell</h2><p>在客户端执行 ypchsh<br><img src="/images/2017/0614/06.png" alt="图片"> </p>
<p>参考：<a href="http://cn.linux.vbird.org/linux_server/0430nis.php">http://cn.linux.vbird.org/linux_server/0430nis.php</a></p>
]]></content>
      <tags>
        <tag>NIS</tag>
      </tags>
  </entry>
  <entry>
    <title>Oracle 多实例启动</title>
    <url>/arlo/6b9bbb19/</url>
    <content><![CDATA[<p>oracle 服务器上配置了两个实例，orcl和sx21，启动服务的时候需要手动修改一下环境变量ORACLE_SID,在此记录一下。</p>
<span id="more"></span>
<h1 id="手动启动"><a href="#手动启动" class="headerlink" title="手动启动"></a>手动启动</h1><h2 id="oracle-用户的环境变量-bash-profile"><a href="#oracle-用户的环境变量-bash-profile" class="headerlink" title="oracle 用户的环境变量.bash_profile"></a>oracle 用户的环境变量.bash_profile</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ORACLE_BASE=/u01/app/oracle</span><br><span class="line">ORACLE_HOME=$ORACLE_BASE/product/11.1.0/db_1</span><br><span class="line">ORACLE_SID=orcl</span><br><span class="line">PATH=$PATH:$ORACLE_HOME/bin:$HOME/bin</span><br><span class="line">LD_LIBRARY_PATH=$ORACLE_HOME/lib</span><br><span class="line">export PATH ORACLE_BASE ORACLE_HOME ORACLE_SID PATH LD_LIBRARY_PATH</span><br><span class="line">export LANG=zh_CN.UTF-8</span><br><span class="line">export NLS_LANG=AMERICAN_AMERICA.ZHS16GBK</span><br></pre></td></tr></table></figure>
<h2 id="查看环境变量"><a href="#查看环境变量" class="headerlink" title="查看环境变量"></a>查看环境变量</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[oracle@localhost ~]$ echo $ORACLE_HOME</span><br><span class="line">/u01/app/oracle/product/11.1.0/db_1</span><br><span class="line">[oracle@localhost ~]$ echo $ORACLE_SID</span><br><span class="line">orcl</span><br></pre></td></tr></table></figure>
<h2 id="启动oracle服务"><a href="#启动oracle服务" class="headerlink" title="启动oracle服务"></a>启动oracle服务</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">su - oracle</span><br><span class="line">sqlplus /nolog</span><br><span class="line">sql&gt; conn /as sysdba</span><br><span class="line">sql&gt; startup</span><br><span class="line">sql&gt; exit</span><br></pre></td></tr></table></figure>
<h2 id="修改ORACLE-SID环境变量，再次执行第3步的启动操作"><a href="#修改ORACLE-SID环境变量，再次执行第3步的启动操作" class="headerlink" title="修改ORACLE_SID环境变量，再次执行第3步的启动操作"></a>修改ORACLE_SID环境变量，再次执行第3步的启动操作</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">export ORACLE_SID=SX21</span><br></pre></td></tr></table></figure>
<h2 id="启动监听服务"><a href="#启动监听服务" class="headerlink" title="启动监听服务"></a>启动监听服务</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">lsnrctl start</span><br></pre></td></tr></table></figure>
<h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[oracle@localhost ~]$ sqlplus sys/password@SX21 as sysdba</span><br></pre></td></tr></table></figure>
<p><img src="/images/2017/0518/01.png" alt="oracle"></p>
<h1 id="自动启动"><a href="#自动启动" class="headerlink" title="自动启动"></a>自动启动</h1><h2 id="修改控制文件"><a href="#修改控制文件" class="headerlink" title="修改控制文件"></a>修改控制文件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/oratab</span><br><span class="line">orcl:/u01/app/oracle/product/11.1.0/db_1:Y</span><br><span class="line">sx21:/u01/app/oracle/product/11.1.0/db_1:Y</span><br><span class="line">CQ:/u01/app/oracle/product/11.1.0/db_1:Y</span><br></pre></td></tr></table></figure>
<h2 id="修改dbstart文件"><a href="#修改dbstart文件" class="headerlink" title="修改dbstart文件"></a>修改dbstart文件</h2><p><em>修改第80行: ORACLE_HOME_LISTNER&#x3D;$1为ORACLE_HOME_LISTNER&#x3D;$ORACLE_HOME</em></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /u01/app/oracle/product/11.1.0/db_1/bin/dbstart</span><br><span class="line">……</span><br><span class="line">ORACLE_HOME_LISTNER=$ORACLE_HOME	</span><br><span class="line">……</span><br></pre></td></tr></table></figure>
<h2 id="修改dbshut文件"><a href="#修改dbshut文件" class="headerlink" title="修改dbshut文件"></a>修改dbshut文件</h2><p><em>修改第50行: ORACLE_HOME_LISTNER&#x3D;$1为ORACLE_HOME_LISTNER&#x3D;$ORACLE_HOME</em></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /u01/app/oracle/product/11.1.0/db_1/bin/dbshut</span><br><span class="line">……</span><br><span class="line">ORACLE_HOME_LISTNER=$ORACLE_HOME</span><br><span class="line">……</span><br></pre></td></tr></table></figure>
<h2 id="修改开机启动文件"><a href="#修改开机启动文件" class="headerlink" title="修改开机启动文件"></a>修改开机启动文件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/rc.local</span><br><span class="line">su - oracle -lc &quot;/u01/app/oracle/product/11.1.0/db_1/bin/lsnrctl start&quot;</span><br><span class="line">su - oracle -lc &quot;/u01/app/oracle/product/11.1.0/db_1/bin/dbstart&quot;</span><br></pre></td></tr></table></figure>
<h1 id="常用的三个图形控制如下"><a href="#常用的三个图形控制如下" class="headerlink" title="常用的三个图形控制如下"></a>常用的三个图形控制如下</h1><h2 id="启动em控制台"><a href="#启动em控制台" class="headerlink" title="启动em控制台"></a>启动em控制台</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">emctl start dbconsole</span><br><span class="line">#添加到开机启动文件中</span><br><span class="line">su - oracle -lc &quot;$ORACLE_HOME/bin/emctl start dbconsole&quot;</span><br></pre></td></tr></table></figure>
<h2 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dbca</span><br></pre></td></tr></table></figure>
<h2 id="配置监听"><a href="#配置监听" class="headerlink" title="配置监听"></a>配置监听</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">netca</span><br><span class="line">netmgr</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>Oracle</tag>
        <tag>数据库</tag>
      </tags>
  </entry>
  <entry>
    <title>Oracle TNS-12541、TNS-00511 无监听程序</title>
    <url>/arlo/6e04db84/</url>
    <content><![CDATA[<p>一台Windows服务器上安装的oralce服务器很卡，于是同事就重启了一下，然后……，你想到了，起不来了。折腾了好久，服务器终于起来了，oracle起不来，记录一下故障原因</p>
<h1 id="提示错误信息"><a href="#提示错误信息" class="headerlink" title="提示错误信息"></a>提示错误信息</h1><p>如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Fatal NI connect error 12541, connecting to:</span><br><span class="line"> (DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=WIN-EPRQ7FK9EK2)(PORT=1521))(CONNECT_DATA=(SID=orcl)(CID=(PROGRAM=E:\app\Administrator\product\11.2.0\dbhome_4\bin\emagent.exe)(HOST=WIN-EPRQ7FK9EK2)(USER=SYSTEM))))</span><br><span class="line"></span><br><span class="line">  VERSION INFORMATION:</span><br><span class="line">	TNS for 64-bit Windows: Version 11.2.0.1.0 - Production</span><br><span class="line">	Windows NT TCP/IP NT Protocol Adapter for 64-bit Windows: Version 11.2.0.1.0 - Production</span><br><span class="line">  Time: 13-6月 -2017 10:58:58</span><br><span class="line">  Tracing not turned on.</span><br><span class="line">  Tns error struct:</span><br><span class="line">    ns main err code: 12541</span><br><span class="line">    TNS-12541: TNS: 无监听程序</span><br><span class="line">    ns secondary err code: 12560</span><br><span class="line">    nt main err code: 511</span><br><span class="line">    TNS-00511: 无监听程序</span><br><span class="line">    nt secondary err code: 61</span><br><span class="line">    nt OS err code: 0</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<h1 id="故障原因"><a href="#故障原因" class="headerlink" title="故障原因"></a>故障原因</h1><p>oracle运行时间过长，<strong>listener.log日志超过4G</strong>导致，此为oracle bug；BUG号为9879101 : THE CONNECT THROUGH LISTENER WAS SLOW WHEN LISTNER LOG GROWED 4GB</p>
<h1 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h1><ol>
<li>找到日志文件 E:\app\Administrator\diag\tnslsnr**WIN-EPRQ7FK9EK2**\listener\trace\listener.log</li>
<li>经查看，该日志大小为4.00 GB (4,294,967,340 字节)</li>
<li>删除该文件，启动监听、服务，恢复正常</li>
</ol>
<h1 id="顺手写个脚本放计划任务里"><a href="#顺手写个脚本放计划任务里" class="headerlink" title="顺手写个脚本放计划任务里"></a>顺手写个脚本放计划任务里</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@echo off   </span><br><span class="line">echo ================================================   </span><br><span class="line">echo  E:\app\Administrator\diag\tnslsnr\WIN-EPRQ7FK9EK2\listener\trace\listener.log 备份文件，用来解决日志问超过4G，数据库监听死掉问题   </span><br><span class="line">echo ================================================  </span><br><span class="line">::以“YYYYMMDD”格式取出当前时间。  </span><br><span class="line">set BACKUPDATE=%date:~0,4%%date:~5,2%%date:~8,2%  </span><br><span class="line">set DATADIR=E:\app\Administrator\diag\tnslsnr\WIN-EPRQ7FK9EK2\listener\trace\</span><br><span class="line"></span><br><span class="line">echo 备份日志文件</span><br><span class="line">e:</span><br><span class="line">cd %DATADIR%</span><br><span class="line">lsnrctl set log_status off</span><br><span class="line">rename listener.log listener.log_%BACKUPDATE%</span><br><span class="line">lsnrctl set log_status on</span><br><span class="line">echo 删除30天以前的日志文件</span><br><span class="line">forfiles -p %DATADIR% -s -m listener.log_* -d -30 -c &quot;cmd /c del @path&quot;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>Oracle</tag>
        <tag>数据库</tag>
      </tags>
  </entry>
  <entry>
    <title>Oracle RAC环境搭建(Oracle Linux 6.9+Oracle 11g R2+FreeNas)</title>
    <url>/arlo/e07eb088/</url>
    <content><![CDATA[<p>捣腾Oracle RAC环境已经半月有余，从对RAC一无所知到环境搭建成功，期间遇到很多坑，填了很多坑；特写此篇，记录一下搭建的过程，以备忘！话不多说，开干！<br><img src="/images/2017/1123/00.png" alt="rac"><br>网络环境：<br>网络分为三个部分，Public网络用于访问业务应用，Priv网络用于检测心跳，Storge网络用于连接存储；VIP，rac-scan网络应与Public网络在同一网段</p>
<span id="more"></span>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">主机名	Public网络	Priv网络	Storge网络	VIP</span><br><span class="line">rac1	192.168.100.11	172.16.10.11	172.16.20.11	92.168.100.21</span><br><span class="line">rac2	192.168.100.12	172.16.10.12	172.16.20.12	192.168.100.22</span><br><span class="line">rac-scan						192.168.100.23</span><br><span class="line">freenas					172.16.20.13</span><br></pre></td></tr></table></figure>
<p>软件环境：<br><a href="https://mirrors.dotsrc.org/oracle-linux/OL6/U9/x86_64/">Oracle Linux6.9</a><br><a href="http://www.oracle.com/technetwork/database/enterprise-edition/downloads/112010-linx8664soft-100572.html">Grid</a><br><a href="http://www.oracle.com/technetwork/database/enterprise-edition/downloads/112010-linx8664soft-100572.html">Oracle Database 11g</a><br><a href="http://www.oracle.com/technetwork/server-storage/linux/asmlib/ol6-1709075.html">ASMlib</a><br><a href="http://www.freenas.com.cn/">FreeNas</a></p>
<p>RAC搭建分为五个部分：</p>
<ul>
<li>基础环境准备</li>
<li>共享存储搭建</li>
<li>网络搭建</li>
<li>Grid 安装</li>
<li>Database 安装</li>
</ul>
<h1 id="基础环境准备"><a href="#基础环境准备" class="headerlink" title="基础环境准备"></a>基础环境准备</h1><p>基础环境如无特别指明，都是需要在两台机器上操作的。</p>
<h2 id="虚拟机环境搭建"><a href="#虚拟机环境搭建" class="headerlink" title="虚拟机环境搭建"></a>虚拟机环境搭建</h2><h3 id="虚拟机资源配置"><a href="#虚拟机资源配置" class="headerlink" title="虚拟机资源配置"></a>虚拟机资源配置</h3><p>rac1:4核&#x2F;8G&#x2F;200G<br>rac2:4核&#x2F;8G&#x2F;200G<br>freenas:2核&#x2F;2G&#x2F;100G+(200G+200G+20G+20G)</p>
<h3 id="网络环境配置"><a href="#网络环境配置" class="headerlink" title="网络环境配置"></a>网络环境配置</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">虚拟机名称	网卡1			网卡2			网卡3</span><br><span class="line">rac1		VMnet1(NAT模式)		VMnet2(仅主机模式)	VMnet3(仅主机模式)</span><br><span class="line">rac2		VMnet1(NAT模式)		VMnet2(仅主机模式)	VMnet3(仅主机模式)</span><br><span class="line">freenas		VMnet1(NAT模式)</span><br><span class="line">VMnet1:192.168.100.0/24</span><br><span class="line">VMnet2:172.16.10.0/24</span><br><span class="line">VMnet3:172.16.20.0/24</span><br></pre></td></tr></table></figure>
<h3 id="操作系统安装"><a href="#操作系统安装" class="headerlink" title="操作系统安装"></a>操作系统安装</h3><p>安装图形界面环境<br>(过程略……)</p>
<h2 id="操作系统配置"><a href="#操作系统配置" class="headerlink" title="操作系统配置"></a>操作系统配置</h2><h3 id="修改主机名"><a href="#修改主机名" class="headerlink" title="修改主机名"></a>修改主机名</h3><p>rac1</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/sysconfig/network</span><br><span class="line">HOSTNAME=rac1</span><br></pre></td></tr></table></figure>
<p>rac2</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/sysconfig/network</span><br><span class="line">HOSTNAME=rac2</span><br></pre></td></tr></table></figure>
<h3 id="配置hosts"><a href="#配置hosts" class="headerlink" title="配置hosts"></a>配置hosts</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">########public#######</span><br><span class="line">192.168.100.11	rac1</span><br><span class="line">192.168.100.12  rac2</span><br><span class="line"></span><br><span class="line">#######priv#########</span><br><span class="line">172.16.10.11	rac1-priv</span><br><span class="line">172.16.10.12	rac2-priv</span><br><span class="line"></span><br><span class="line">######vip###########</span><br><span class="line">192.168.100.21	rac1-vip</span><br><span class="line">192.168.100.22	rac2-vip</span><br><span class="line">192.168.100.23	rac-scan</span><br><span class="line"></span><br><span class="line">172.16.20.13	freenas</span><br></pre></td></tr></table></figure>
<h3 id="配置时间同步"><a href="#配置时间同步" class="headerlink" title="配置时间同步"></a>配置时间同步</h3><p>关闭ntpd服务，使用oracle自身的集群时间同步</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br><span class="line">ntpdate cn.ntp.org.cn</span><br><span class="line">vim /etc/sysconfig/ntpd</span><br><span class="line">SYNC_HWCLOCK=yes</span><br><span class="line">OPTIONS=&quot;-x -u ntp:ntp -p /var/run/ntpd.pid&quot;</span><br><span class="line">/etc/init.d/ntpd stop</span><br><span class="line">chkconfig ntpd off</span><br><span class="line">mv /etc/ntp.conf /etc/ntp.conf.bak</span><br></pre></td></tr></table></figure>
<h3 id="基础软件安装"><a href="#基础软件安装" class="headerlink" title="基础软件安装"></a>基础软件安装</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#默认是不安装32位软件包的，添加此选项</span><br><span class="line">echo &#x27;multilib_policy=all&#x27; &gt;&gt; /etc/yum.conf</span><br><span class="line">yum -y install  binutils-* compat-libstdc++-* elfutils-libelf-*  elfutils-libelf-devel-* gcc-* gcc-c++-* glibc-* glibc-common-* glibc-devel-*  glibc-headers-* libaio-*  libaio-devel-* libgcc-*  libstdc++* libstdc++-devel* make-*  sysstat-* unixODBC-* unixODBC-devel-* ksh-* mksh pdksh</span><br><span class="line">#监测一下软件是否安装全</span><br><span class="line">rpm -q \</span><br><span class="line">binutils \</span><br><span class="line">compat-libstdc++-33 \</span><br><span class="line">elfutils-libelf \</span><br><span class="line">elfutils-libelf-devel \</span><br><span class="line">expat \</span><br><span class="line">gcc \</span><br><span class="line">gcc-c++ \</span><br><span class="line">glibc \</span><br><span class="line">glibc-common \</span><br><span class="line">glibc-devel \</span><br><span class="line">glibc-headers \</span><br><span class="line">libaio \</span><br><span class="line">libaio-devel \</span><br><span class="line">libgcc \</span><br><span class="line">libstdc++ \</span><br><span class="line">libstdc++-devel \</span><br><span class="line">make \</span><br><span class="line">pdksh \</span><br><span class="line">sysstat \</span><br><span class="line">unixODBC \</span><br><span class="line">unixODBC-devel | grep &quot;not installed&quot;</span><br></pre></td></tr></table></figure>
<h3 id="修改PAM配置文件"><a href="#修改PAM配置文件" class="headerlink" title="修改PAM配置文件"></a>修改PAM配置文件</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vi /etc/pam.d/login</span><br><span class="line">session    required     /lib64/security/pam_limits.so</span><br></pre></td></tr></table></figure>
<h3 id="设置内核参数"><a href="#设置内核参数" class="headerlink" title="设置内核参数"></a>设置内核参数</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vi /etc/sysctl.conf</span><br><span class="line"></span><br><span class="line">fs.aio-max-nr = 1048576 </span><br><span class="line">fs.file-max = 6815744 </span><br><span class="line">kernel.shmmni = 4096 </span><br><span class="line">kernel.sem = 250 32000 100 128 </span><br><span class="line">net.ipv4.ip_local_port_range = 9000 65500 </span><br><span class="line">net.core.rmem_default = 262144 </span><br><span class="line">net.core.rmem_max = 4194304 </span><br><span class="line">net.core.wmem_default = 262144 </span><br><span class="line">net.core.wmem_max = 1048586</span><br><span class="line"></span><br><span class="line">重新加载生效</span><br><span class="line">sysctl –p</span><br></pre></td></tr></table></figure>
<h3 id="创建用户grid"><a href="#创建用户grid" class="headerlink" title="创建用户grid"></a>创建用户grid</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">groupadd -g 1000 oinstall </span><br><span class="line">groupadd -g 1001 asmadmin </span><br><span class="line">groupadd -g 1002 asmdba </span><br><span class="line">groupadd -g 1003 asmoper</span><br><span class="line">useradd -u 1100 -g oinstall -G asmadmin,asmdba,asmoper -d /home/grid -s /bin/bash grid</span><br><span class="line">#设置密码grid用户密码为oracle</span><br><span class="line">echo oracle|passwd --stdin grid   </span><br></pre></td></tr></table></figure>
<h4 id="配置grid用户环境变量"><a href="#配置grid用户环境变量" class="headerlink" title="配置grid用户环境变量"></a>配置grid用户环境变量</h4><p><strong>RAC1：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">su - grid</span><br><span class="line">#vi .bash_profile</span><br><span class="line"></span><br><span class="line">#export PS1=&quot;`/bin/hostname -s`-&gt;&quot;</span><br><span class="line">export TMP=/tmp</span><br><span class="line">export TMPDIR=$TMP</span><br><span class="line">export ORACLE_SID=+ASM1</span><br><span class="line">export ORACLE_BASE=/u01/app/grid</span><br><span class="line">export ORACLE_HOME=/u01/app/11.2.0/grid</span><br><span class="line">export TNS_ADMIN=$ORACLE_HOME/network/admin</span><br><span class="line">export PATH=/usr/sbin:$PATH</span><br><span class="line">export PATH=$PATH:$ORACLE_HOME/bin</span><br><span class="line">export LD_LIBRARY_PATH=$ORACLE_HOME/lib:/lib:/usr/lib</span><br><span class="line">export LANG=en_US.UTF-8</span><br><span class="line">export NLS_LANG=AMERICAN_AMERICA.ZHS16GBK</span><br><span class="line"></span><br><span class="line">#使配置文件生效</span><br><span class="line">source .bash_profile  </span><br></pre></td></tr></table></figure>
<p><strong>RAC2：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">su - grid</span><br><span class="line">#vi .bash_profile</span><br><span class="line"></span><br><span class="line">#export PS1=&quot;`/bin/hostname -s`-&gt;&quot;</span><br><span class="line">export TMP=/tmp</span><br><span class="line">export TMPDIR=$TMP</span><br><span class="line">export ORACLE_SID=+ASM2</span><br><span class="line">export ORACLE_BASE=/u01/app/grid</span><br><span class="line">export ORACLE_HOME=/u01/app/11.2.0/grid</span><br><span class="line">export TNS_ADMIN=$ORACLE_HOME/network/admin</span><br><span class="line">export PATH=/usr/sbin:$PATH</span><br><span class="line">export PATH=$PATH:$ORACLE_HOME/bin</span><br><span class="line">export LD_LIBRARY_PATH=$ORACLE_HOME/lib:/lib:/usr/lib</span><br><span class="line">export LANG=en_US.UTF-8</span><br><span class="line">export NLS_LANG=AMERICAN_AMERICA.ZHS16GBK</span><br><span class="line"></span><br><span class="line">#使配置文件生效</span><br><span class="line">source .bash_profile </span><br></pre></td></tr></table></figure>
<h3 id="创建用户oracle"><a href="#创建用户oracle" class="headerlink" title="创建用户oracle"></a>创建用户oracle</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">su - root</span><br><span class="line">groupadd -g 1200 dba</span><br><span class="line">groupadd -g 1201 oper</span><br><span class="line">useradd -u 1101 -g oinstall -G dba,oper,asmdba -d /home/oracle -s /bin/bash oracle</span><br><span class="line">#设置密码grid用户密码为oracle</span><br><span class="line">echo oracle|passwd --stdin oracle</span><br></pre></td></tr></table></figure>
<h4 id="配置oracle用户环境变量"><a href="#配置oracle用户环境变量" class="headerlink" title="配置oracle用户环境变量"></a>配置oracle用户环境变量</h4><p><strong>RAC1：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">su - oracle</span><br><span class="line">#vi .bash_profile</span><br><span class="line"></span><br><span class="line">#export PS1=&quot;`/bin/hostname -s`-&gt;&quot;</span><br><span class="line">export TMP=/tmp</span><br><span class="line">export TMPDIR=$TMP</span><br><span class="line">export ORACLE_HOSTNAME=rac1</span><br><span class="line">export ORACLE_SID=orcl1</span><br><span class="line">export ORACLE_UNQNAME=orcl</span><br><span class="line">export ORACLE_BASE=/u01/app/oracle</span><br><span class="line">export ORACLE_HOME=$ORACLE_BASE/11g</span><br><span class="line">export TNS_ADMIN=$ORACLE_HOME/network/admin</span><br><span class="line">export PATH=/usr/sbin:$PATH</span><br><span class="line">export PATH=$PATH:$ORACLE_HOME/bin</span><br><span class="line">export LD_LIBRARY_PATH=$ORACLE_HOME/lib:/lib:/usr/lib</span><br><span class="line">export LANG=en_US.UTF-8</span><br><span class="line">export NLS_LANG=AMERICAN_AMERICA.ZHS16GBK</span><br><span class="line"></span><br><span class="line">#使配置文件生效</span><br><span class="line">source .bash_profile  </span><br></pre></td></tr></table></figure>
<p><strong>RAC2：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">su - oracle</span><br><span class="line">#vi .bash_profile</span><br><span class="line"></span><br><span class="line">#export PS1=&quot;`/bin/hostname -s`-&gt;&quot;</span><br><span class="line">export TMP=/tmp</span><br><span class="line">export TMPDIR=$TMP</span><br><span class="line">export ORACLE_HOSTNAME=rac2</span><br><span class="line">export ORACLE_SID=orcl2</span><br><span class="line">export ORACLE_UNQNAME=orcl</span><br><span class="line">export ORACLE_BASE=/u01/app/oracle</span><br><span class="line">export ORACLE_HOME=$ORACLE_BASE/11g</span><br><span class="line">export TNS_ADMIN=$ORACLE_HOME/network/admin</span><br><span class="line">export PATH=/usr/sbin:$PATH</span><br><span class="line">export PATH=$PATH:$ORACLE_HOME/bin</span><br><span class="line">export LD_LIBRARY_PATH=$ORACLE_HOME/lib:/lib:/usr/lib</span><br><span class="line">export LANG=en_US.UTF-8</span><br><span class="line">export NLS_LANG=AMERICAN_AMERICA.ZHS16GBK</span><br><span class="line"></span><br><span class="line">#使配置文件生效</span><br><span class="line">source .bash_profile </span><br></pre></td></tr></table></figure>
<h3 id="创建目录，修改权限"><a href="#创建目录，修改权限" class="headerlink" title="创建目录，修改权限"></a>创建目录，修改权限</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">su - root</span><br><span class="line">mkdir -p /u01/app/grid </span><br><span class="line">mkdir -p /u01/app/11.2.0/grid</span><br><span class="line">chown -R grid:oinstall /u01</span><br><span class="line">chown -R grid:oinstall /u01/app/11.2.0/grid</span><br><span class="line">mkdir -p /u01/app/oracle</span><br><span class="line">chown -R oracle:oinstall /u01/app/oracle</span><br><span class="line">chmod -R 775 /u01</span><br><span class="line">export LANG=en_US.UTF-8</span><br><span class="line">export NLS_LANG=AMERICAN_AMERICA.ZHS16GBK</span><br></pre></td></tr></table></figure>
<h3 id="配置profile"><a href="#配置profile" class="headerlink" title="配置profile"></a>配置profile</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/profile</span><br><span class="line">if [ \$USER = &quot;oracle&quot; ] || [ \$USER = &quot;grid&quot; ];then </span><br><span class="line">    if [ \$SHELL = &quot;/bin/ksh&quot; ];then </span><br><span class="line">               ulimit -p 16384 </span><br><span class="line">               ulimit -n 65536 </span><br><span class="line">    else </span><br><span class="line">               ulimit -u 16384 -n 65536 </span><br><span class="line">    fi </span><br><span class="line">    umask 022 </span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<h3 id="修改Oracle用户限制"><a href="#修改Oracle用户限制" class="headerlink" title="修改Oracle用户限制"></a>修改Oracle用户限制</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vi /etc/security/limits.conf</span><br><span class="line">oracle soft nproc 2047</span><br><span class="line">oracle hard nproc 16384</span><br><span class="line">oracle soft nofile 1024</span><br><span class="line">oracle hard nofile 65536</span><br><span class="line">oracle soft stack 10240</span><br><span class="line">oracle hard stack 32768</span><br><span class="line"></span><br><span class="line">grid soft nproc 2047</span><br><span class="line">grid hard nproc 16384</span><br><span class="line">grid soft nofile 1024</span><br><span class="line">grid hard nofile 65536</span><br><span class="line">grid soft stack 10240</span><br><span class="line">grid hard stack 32768</span><br></pre></td></tr></table></figure>
<h3 id="ssh-互信"><a href="#ssh-互信" class="headerlink" title="ssh 互信"></a>ssh 互信</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">su - grid</span><br><span class="line">ssh-keygen (一路回车)</span><br><span class="line">ssh-copy-id -i rac2</span><br><span class="line">ssh-copy-id -i rac1</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">su - oracle</span><br><span class="line">ssh-keygen (一路回车)</span><br><span class="line">ssh-copy-id -i rac2</span><br><span class="line">ssh-copy-id -i rac1</span><br></pre></td></tr></table></figure>
<p>测试一下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ssh rac1 date</span><br><span class="line">Thu Nov 23 14:00:03 CST 2017</span><br><span class="line">ssh rac2 date</span><br><span class="line">Thu Nov 23 14:00:24 CST 2017</span><br></pre></td></tr></table></figure>
<h1 id="使用FreeNas搭建iscsi存储"><a href="#使用FreeNas搭建iscsi存储" class="headerlink" title="使用FreeNas搭建iscsi存储"></a>使用FreeNas搭建iscsi存储</h1><h2 id="安装操作系统"><a href="#安装操作系统" class="headerlink" title="安装操作系统"></a>安装操作系统</h2><p>使用FreeNAS-9.2.1.7-RELEASE-x64.iso镜像搭建NAS存储，一块系统磁盘，四块存储盘<br><img src="/images/2017/1123/01.png" alt="rac"><br>选择1 Install&#x2F;Upgrade 安装FreeNAS<br><img src="/images/2017/1123/02.png" alt="rac"><br>选择第一块系统磁盘<br><img src="/images/2017/1123/03.png" alt="rac"><br>全新安装(虚拟机环境之前安装过，新环境应该没有这一步)<br><img src="/images/2017/1123/04.png" alt="rac"><br>安装警告，例行问候，选择Yes<br><img src="/images/2017/1123/05.png" alt="rac"><br>安装完成<br><img src="/images/2017/1123/06.png" alt="rac"><br>重启系统<br><img src="/images/2017/1123/07.png" alt="rac"></p>
<h2 id="配置网络"><a href="#配置网络" class="headerlink" title="配置网络"></a>配置网络</h2><p>提示是否删除现有的配置，输入n<br><img src="/images/2017/1123/08.png" alt="rac"><br>是否配置DHCP，输入n；是否配置IPv4,输入y；输入ip地址、子网掩码；是否配置IPv6,输入n<br><img src="/images/2017/1123/09.png" alt="rac"><br>配置完成后，即可通过url来管理freenas，访问地址为<a href="http://172.16.20.13/">http://172.16.20.13</a><br><img src="/images/2017/1123/10.png" alt="rac"><br>新版本第一次登录会让修改密码<br>ps:如果密码忘记，可以在刚才的步骤里选择7）Reset WebGUI login credentials，在此步骤可以输入新密码<br><img src="/images/2017/1123/11.png" alt="rac"></p>
<h2 id="配置iscsi"><a href="#配置iscsi" class="headerlink" title="配置iscsi"></a>配置iscsi</h2><p>设置中文语言，上海时区<br><img src="/images/2017/1123/12.png" alt="rac"><br>开启iSCSI服务<br><img src="/images/2017/1123/13.png" alt="rac"><br>配置全局目标，设置iSCSI名称iqn.2017-11.cc.islocal.istgt<br><img src="/images/2017/1123/14.png" alt="rac"><br>配置Portals<br><img src="/images/2017/1123/15.png" alt="rac"><br>配置初始的授权<br><img src="/images/2017/1123/16.png" alt="rac"><br>配置授权用户grid<br><img src="/images/2017/1123/17.png" alt="rac"><br>添加iscsi目标设备<br><img src="/images/2017/1123/18.png" alt="rac"><br>依次添加4块存储磁盘<br><img src="/images/2017/1123/19.png" alt="rac"><br><img src="/images/2017/1123/20.png" alt="rac"><br>关联添加的存储设备为LUN<br><img src="/images/2017/1123/21.png" alt="rac"><br><img src="/images/2017/1123/22.png" alt="rac"></p>
<h1 id="安装Grid-Infrastructure"><a href="#安装Grid-Infrastructure" class="headerlink" title="安装Grid Infrastructure"></a>安装Grid Infrastructure</h1><blockquote>
<p>如果使用Centos6.x操作系统安装rac，建议使用UEK内核;uek内核是Oracle Linux、Oracle Database、中间件和硬件工程师团队合作的结果，是一个快速、现代、可靠的内核，专门针对Oracle软件和硬件进行了优化。随着硬件的快速发展，为了更好的兼容并支持快速发展的硬件，Linux系统版本及内核也在不断的更新，uek正是在这样的环境下应运而生的产物。<br>安装uek内核可以参考以下文档<br><a href="https://docs.oracle.com/cd/E37670_01/E37355/html/ol_obtain_uek.html">https://docs.oracle.com/cd/E37670_01/E37355/html/ol_obtain_uek.html</a><br><a href="https://docs.oracle.com/cd/E52668_01/E39381/html/ol_import_gpg.html">https://docs.oracle.com/cd/E52668_01/E39381/html/ol_import_gpg.html</a><br><a href="http://www.oracle.com/technetwork/server-storage/linux/asmlib/index-101839.html">http://www.oracle.com/technetwork/server-storage/linux/asmlib/index-101839.html</a></p>
</blockquote>
<h2 id="ASM-分区创建"><a href="#ASM-分区创建" class="headerlink" title="ASM 分区创建"></a>ASM 分区创建</h2><h3 id="方法一：使用ASMlib创建ASM分区"><a href="#方法一：使用ASMlib创建ASM分区" class="headerlink" title="方法一：使用ASMlib创建ASM分区"></a>方法一：使用ASMlib创建ASM分区</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum -y install oracleasm-support oracle-rdbms-server-11gR2-preinstall</span><br><span class="line">rpm -ivh http://download.oracle.com/otn_software/asmlib/oracleasmlib-2.0.12-1.el6.x86_64.rpm</span><br></pre></td></tr></table></figure>
<p>上传linux.x64_11gR2_grid.zip到&#x2F;usr&#x2F;local&#x2F;src目录下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cd /usr/local/src/</span><br><span class="line">unzip linux.x64_11gR2_grid.zip</span><br><span class="line">/usr/local/src/grid/rpm</span><br><span class="line">rpm -ivh cvuqdisk-1.0.7-1.rpm</span><br></pre></td></tr></table></figure>
<h4 id="初始化asm"><a href="#初始化asm" class="headerlink" title="初始化asm"></a>初始化asm</h4><p><strong>RAC1</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@rac1 rpm]# /etc/init.d/oracleasm configure -i</span><br><span class="line">Configuring the Oracle ASM library driver.</span><br><span class="line"></span><br><span class="line">This will configure the on-boot properties of the Oracle ASM library</span><br><span class="line">driver.  The following questions will determine whether the driver is</span><br><span class="line">loaded on boot and what permissions it will have.  The current values</span><br><span class="line">will be shown in brackets (&#x27;[]&#x27;).  Hitting &lt;ENTER&gt; without typing an</span><br><span class="line">answer will keep that current value.  Ctrl-C will abort.</span><br><span class="line"></span><br><span class="line">Default user to own the driver interface [grid]: grid</span><br><span class="line">Default group to own the driver interface [oinstall]: oinstall</span><br><span class="line">Start Oracle ASM library driver on boot (y/n) [y]: y</span><br><span class="line">Scan for Oracle ASM disks on boot (y/n) [y]: y</span><br><span class="line">Writing Oracle ASM library driver configuration: done</span><br><span class="line">Initializing the Oracle ASMLib driver:                     [  OK  ]</span><br><span class="line">Scanning the system for Oracle ASMLib disks:               [  OK  ]</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/usr/sbin/oracleasm init</span><br></pre></td></tr></table></figure>
<p><strong>RAC2</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@rac2 src]# /etc/init.d/oracleasm configure -i</span><br><span class="line">Configuring the Oracle ASM library driver.</span><br><span class="line"></span><br><span class="line">This will configure the on-boot properties of the Oracle ASM library</span><br><span class="line">driver.  The following questions will determine whether the driver is</span><br><span class="line">loaded on boot and what permissions it will have.  The current values</span><br><span class="line">will be shown in brackets (&#x27;[]&#x27;).  Hitting &lt;ENTER&gt; without typing an</span><br><span class="line">answer will keep that current value.  Ctrl-C will abort.</span><br><span class="line"></span><br><span class="line">Default user to own the driver interface [grid]: grid</span><br><span class="line">Default group to own the driver interface [oinstall]: oinstall</span><br><span class="line">Start Oracle ASM library driver on boot (y/n) [y]: y</span><br><span class="line">Scan for Oracle ASM disks on boot (y/n) [y]: y</span><br><span class="line">Writing Oracle ASM library driver configuration: done</span><br><span class="line">Initializing the Oracle ASMLib driver:                     [  OK  ]</span><br><span class="line">Scanning the system for Oracle ASMLib disks:               [  OK  ]</span><br></pre></td></tr></table></figure>
<h4 id="配置iscsi客户端"><a href="#配置iscsi客户端" class="headerlink" title="配置iscsi客户端"></a>配置iscsi客户端</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum -y install iscsi-initiator-utils</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@rac1 rpm]# iscsiadm -m discovery -t sendtargets -p 172.16.20.13</span><br><span class="line">172.16.20.13:3260,1 iqn.2017-11.cc.islocal.istgt:iscsi</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@rac1 rpm]# /etc/init.d/iscsi restart</span><br><span class="line">Stopping iscsi:                                            [  OK  ]</span><br><span class="line">Starting iscsi:                                            [  OK  ]</span><br></pre></td></tr></table></figure>
<blockquote>
<p>iscsi命令拓展<br>查看iscsi target信息</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">iscsiadm -m node -p ip_addr</span><br><span class="line">iscsiadm -m node session -p ip_addr</span><br><span class="line">iscsiadm -m node discovery -P ip_addr</span><br></pre></td></tr></table></figure>
<blockquote>
<p>登录target连接</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">iscsiadm -m node -T iqn.2017-11.cc.islocal.istgt:iscsi -p ip_addr -l</span><br></pre></td></tr></table></figure>
<blockquote>
<p>登出target连接</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">iscsiadm -m node -T iqn.2017-11.cc.islocal.istgt:iscsi -p ip_addr -u</span><br></pre></td></tr></table></figure>
<blockquote>
<p>删除target条目记录</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">iscsiadm -m node -o delete -T iqn.2017-11.cc.islocal.istgt:iscsi -p ip_addr</span><br></pre></td></tr></table></figure>

<h4 id="磁盘分区"><a href="#磁盘分区" class="headerlink" title="磁盘分区"></a>磁盘分区</h4><p>fdisk -l  可以发现已经识别到4个磁盘sdb,sdc,sdd,sde,对磁盘进行分区<br><strong>“n&#x2F;p&#x2F;1&#x2F;回车&#x2F;回车&#x2F;w”</strong><br><img src="/images/2017/1123/23.png" alt="rac"><br><img src="/images/2017/1123/24.png" alt="rac"></p>
<h4 id="创建ASM分区"><a href="#创建ASM分区" class="headerlink" title="创建ASM分区"></a>创建ASM分区</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/etc/init.d/oracleasm createdisk ASMDATA /dev/sdb1</span><br><span class="line">/etc/init.d/oracleasm createdisk BACKUP /dev/sdc1</span><br><span class="line">/etc/init.d/oracleasm createdisk OCR /dev/sdd1</span><br><span class="line">/etc/init.d/oracleasm createdisk VOTINGDISK /dev/sde1</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@rac1 rpm]# /etc/init.d/oracleasm scandisks</span><br><span class="line">Scanning the system for Oracle ASMLib disks:               [  OK  ]</span><br><span class="line">[root@rac1 rpm]# /etc/init.d/oracleasm listdisks</span><br><span class="line">ASMDATA</span><br><span class="line">BACKUP</span><br><span class="line">OCR</span><br><span class="line">VOTINGDISK</span><br></pre></td></tr></table></figure>
<h4 id="在rac2上发现asm磁盘"><a href="#在rac2上发现asm磁盘" class="headerlink" title="在rac2上发现asm磁盘"></a>在rac2上发现asm磁盘</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum -y install iscsi-initiator-utils</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@rac2 rpm]# iscsiadm -m discovery -t sendtargets -p 172.16.20.13</span><br><span class="line">172.16.20.13:3260,1 iqn.2017-11.cc.islocal.istgt:iscsi</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@rac2 rpm]# /etc/init.d/iscsi restart</span><br><span class="line">Stopping iscsi:                                            [  OK  ]</span><br><span class="line">Starting iscsi:                                            [  OK  ]</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@rac2 ~]# start_udev </span><br><span class="line">Starting udev:                                             [  OK  ]</span><br><span class="line">[root@rac2 src]# /etc/init.d/oracleasm scandisks</span><br><span class="line">Scanning the system for Oracle ASMLib disks:               [  OK  ]</span><br><span class="line">[root@rac2 src]# /etc/init.d/oracleasm listdisks</span><br><span class="line">ASMDATA</span><br><span class="line">BACKUP</span><br><span class="line">OCR</span><br><span class="line">VOTINGDISK</span><br></pre></td></tr></table></figure>
<h3 id="方法二：使用udev方式创建ASM分区"><a href="#方法二：使用udev方式创建ASM分区" class="headerlink" title="方法二：使用udev方式创建ASM分区"></a>方法二：使用udev方式创建ASM分区</h3><h4 id="配置iscsi客户端-1"><a href="#配置iscsi客户端-1" class="headerlink" title="配置iscsi客户端"></a>配置iscsi客户端</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum -y install iscsi-initiator-utils</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@rac1 rpm]# iscsiadm -m discovery -t sendtargets -p 172.16.20.13</span><br><span class="line">172.16.20.13:3260,1 iqn.2017-11.cc.islocal.istgt:iscsi</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@rac1 rpm]# /etc/init.d/iscsi restart</span><br><span class="line">Stopping iscsi:                                            [  OK  ]</span><br><span class="line">Starting iscsi:                                            [  OK  ]</span><br></pre></td></tr></table></figure>
<p>将ASM磁盘添加到udev，防止开始发现磁盘顺序不一致导致的异常问题</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@rac1 ~]# /sbin/scsi_id --whitelisted --replace-whitespace --device=/dev/sdb1</span><br><span class="line">3300000007a38757b</span><br><span class="line">[root@rac1 ~]# /sbin/scsi_id --whitelisted --replace-whitespace --device=/dev/sdc1</span><br><span class="line">3300000008853f678</span><br><span class="line">[root@rac1 ~]# /sbin/scsi_id --whitelisted --replace-whitespace --device=/dev/sdd1</span><br><span class="line">3300000009b03058c</span><br><span class="line">[root@rac1 ~]# /sbin/scsi_id --whitelisted --replace-whitespace --device=/dev/sde1</span><br><span class="line">3300000006968868f</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@rac1 rules.d]# vim 99-iscsi-asm.rules</span><br><span class="line">KERNEL==&quot;sd*&quot;, BUS==&quot;scsi&quot;, PROGRAM==&quot;/sbin/scsi_id --whitelisted --replace-whitespace --device=/dev/$name&quot;, RESULT==&quot;3300000007a38757b&quot;, NAME=&quot;asm-data&quot;, OWNER=&quot;grid&quot;, GROUP=&quot;oinstall&quot;, MODE=&quot;0660&quot;</span><br><span class="line">KERNEL==&quot;sd*&quot;, BUS==&quot;scsi&quot;, PROGRAM==&quot;/sbin/scsi_id --whitelisted --replace-whitespace --device=/dev/$name&quot;, RESULT==&quot;3300000008853f678&quot;, NAME=&quot;asm-backup&quot;, OWNER=&quot;grid&quot;, GROUP=&quot;oinstall&quot;, MODE=&quot;0660&quot;</span><br><span class="line">KERNEL==&quot;sd*&quot;, BUS==&quot;scsi&quot;, PROGRAM==&quot;/sbin/scsi_id --whitelisted --replace-whitespace --device=/dev/$name&quot;, RESULT==&quot;3300000009b03058c&quot;, NAME=&quot;asm-ocr&quot;, OWNER=&quot;grid&quot;, GROUP=&quot;oinstall&quot;, MODE=&quot;0660&quot;</span><br><span class="line">KERNEL==&quot;sd*&quot;, BUS==&quot;scsi&quot;, PROGRAM==&quot;/sbin/scsi_id --whitelisted --replace-whitespace --device=/dev/$name&quot;, RESULT==&quot;3300000006968868f&quot;, NAME=&quot;asm-vdisk&quot;, OWNER=&quot;grid&quot;, GROUP=&quot;oinstall&quot;, MODE=&quot;0660&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@rac1 rules.d]# scp 99-iscsi-asm.rules rac2:/etc/udev/rules.d/99-iscsi-asm.rules</span><br><span class="line">[root@rac1 rules.d]# start_udev </span><br><span class="line">Starting udev:                                             [  OK  ]</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@rac1 rules.d]# ll /dev/asm-*</span><br><span class="line">brw-rw---- 1 grid asmadmin 8, 33 Nov 23 17:48 /dev/asm-backup</span><br><span class="line">brw-rw---- 1 grid asmadmin 8, 17 Nov 23 17:48 /dev/asm-data</span><br><span class="line">brw-rw---- 1 grid asmadmin 8, 49 Nov 23 17:48 /dev/asm-ocr</span><br><span class="line">brw-rw---- 1 grid asmadmin 8, 65 Nov 23 17:48 /dev/asm-vdisk</span><br></pre></td></tr></table></figure>
<p>在rac2上发现asm磁盘</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum -y install iscsi-initiator-utils</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@rac2 rpm]# iscsiadm -m discovery -t sendtargets -p 172.16.20.13</span><br><span class="line">172.16.20.13:3260,1 iqn.2017-11.cc.islocal.istgt:iscsi</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@rac2 rpm]# /etc/init.d/iscsi restart</span><br><span class="line">Stopping iscsi:                                            [  OK  ]</span><br><span class="line">Starting iscsi:                                            [  OK  ]</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@rac2 ~]# start_udev </span><br><span class="line">Starting udev:                                             [  OK  ]</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@rac2 ~]# ll /dev/asm-*</span><br><span class="line">brw-rw---- 1 grid asmadmin 8, 33 Nov 23 17:54 /dev/asm-backup</span><br><span class="line">brw-rw---- 1 grid asmadmin 8, 17 Nov 23 17:54 /dev/asm-data</span><br><span class="line">brw-rw---- 1 grid asmadmin 8, 49 Nov 23 17:54 /dev/asm-ocr</span><br><span class="line">brw-rw---- 1 grid asmadmin 8, 65 Nov 23 17:54 /dev/asm-vdisk</span><br></pre></td></tr></table></figure>
<h2 id="安装Grid"><a href="#安装Grid" class="headerlink" title="安装Grid"></a>安装Grid</h2><p>建议直接用grid用户登录图形桌面，而不是root登录su - grid切换过去。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rac1-&gt;cd /usr/local/src/grid</span><br><span class="line">rac1-&gt;./runcluvfy.sh stage -pre crsinst -n rac1,rac2 -fixup -verbose</span><br></pre></td></tr></table></figure>
<p>安装前监测一下环境，如果有failed，按照要求去修复，我这里有几个软件包太新，不是太影响，我们就开始安装吧。<br>执行.&#x2F;runInstaller，开始安装<br><img src="/images/2017/1123/25.png" alt="rac"><br>安装和配置一个GI集群<br><img src="/images/2017/1123/26.png" alt="rac"><br>高级安装<br><img src="/images/2017/1123/27.png" alt="rac"><br>添加中文支持<br><img src="/images/2017/1123/28.png" alt="rac"><br>取消GNS选项，保持SCAN Name和hosts里配置的一样<br><img src="/images/2017/1123/29.png" alt="rac"><br>添加rac2<br><img src="/images/2017/1123/30.png" alt="rac"><br>根据之前配置的网络，配置网络类型<br><img src="/images/2017/1123/31.png" alt="rac"><br>选择ASM存储<br><img src="/images/2017/1123/32.png" alt="rac"><br><em>这里遇到几个几个坑，详细说一下吧；1.如果默认没有在候选磁盘(Candidate Disks)里,选择所有磁盘(All disks),看看是否可以显示出来；2.如果还是没有发现，点一下改变其他路径(Change Discovery Path),rhel系列系统默认路径是&#x2F;dev&#x2F;raw&#x2F;*, 我这里是&#x2F;dev&#x2F;asm-*;3.如果磁盘显示出来是灰色，不能选择，可能是练习的时候，之前已经使用过磁盘做过asm了，可以执行“dd if&#x3D;&#x2F;dev&#x2F;zero of&#x3D;&#x2F;dev&#x2F;rhdisk2 bs&#x3D;1024 count&#x3D;100”，然后重新开始安装试试，如果还不行，请从存储方面开始排查；4.我这里配置的udev方式发现保证磁盘的唯一性，现在发现一个问题，start_udev后可以发现磁盘，&#x2F;dev&#x2F;asm-*都生成了；执行oraclescandisk后发现不了ASM磁盘，&#x2F;dev&#x2F;oracleasm&#x2F;disks&#x2F;目录下是空的，但是安装时候找到了，是可用状态，有点小疑惑。</em><br>ASM提供三种冗余模式，我们使用External；ASM三种模式后期学习了，在单独写一篇吧。<br><img src="/images/2017/1123/33.png" alt="rac"><br>选择Yes<br><img src="/images/2017/1123/34.png" alt="rac"><br>默认<br><img src="/images/2017/1123/35.png" alt="rac"><br>默认的三个组<br><img src="/images/2017/1123/36.png" alt="rac"><br>默认安装路径<br><img src="/images/2017/1123/37.png" alt="rac"><br><img src="/images/2017/1123/38.png" alt="rac"><br><img src="/images/2017/1123/39.png" alt="rac"><br>忽略ALL<br><img src="/images/2017/1123/40.png" alt="rac"><br>所有的配置信息<br><img src="/images/2017/1123/41.png" alt="rac"><br>安装完成，使用root账号依次在rac1，rac2上执行脚本;<br><img src="/images/2017/1123/42.png" alt="rac"><br>如果你执行root.sh出现以下错误，恭喜你！这个问题折磨了我太久，后来在网上看到这是一个bug！</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CRS-4124: Oracle High Availability Services startup failed.</span><br><span class="line">CRS-4000: Command Start failed, or completed with errors.</span><br><span class="line">ohasd failed to start: Inappropriate ioctl for device</span><br><span class="line">ohasd failed to start at /opt/app/11.2.0/grid/crs/install/rootcrs.pl line 443.</span><br></pre></td></tr></table></figure>
<p>此错误<a href="http://blog.sina.com.cn/s/blog_563c17780102ux53.html">解决方法</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">删除之前的配置：/u01/app/11.2.0/grid/crs/install/roothas.pl -deconfig -force -verbose</span><br><span class="line">窗口1：/u01/app/11.2.0/grid/root.sh</span><br><span class="line">窗口2：/bin/dd if=/var/tmp/.oracle/npohasd of=/dev/null bs=1024 count=1  （刚开始执行root.sh时候，还没生成npohash文件，等日志出现“Adding daemon to inittab”的时候，在窗口2中使用root用户执行此命令，等root.sh执行成功后，ctrl+c结束此命令即可）</span><br></pre></td></tr></table></figure>
<p><img src="/images/2017/1123/43.png" alt="rac"><br>出现以下提示，方为脚本执行成功。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Configure Oracle Grid Infrastructure for a Cluster ... succeeded</span><br><span class="line">Updating inventory properties for clusterware</span><br><span class="line">Starting Oracle Universal Installer...</span><br><span class="line"></span><br><span class="line">Checking swap space: must be greater than 500 MB.   Actual 7999 MB    Passed</span><br><span class="line">The inventory pointer is located at /etc/oraInst.loc</span><br><span class="line">The inventory is located at /u01/app/oraInventory</span><br></pre></td></tr></table></figure>
<p>这个错误没事，直接点击Next<br><img src="/images/2017/1123/44.png" alt="rac"><br>完成安装<br><img src="/images/2017/1123/45.png" alt="rac"></p>
<h2 id="验证安装状态"><a href="#验证安装状态" class="headerlink" title="验证安装状态"></a>验证安装状态</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">su - grid</span><br><span class="line">crs_stat -t</span><br><span class="line">crsctl check cluster -all</span><br><span class="line">olsnodes -s -n -t</span><br><span class="line">crsctl check crs</span><br><span class="line">srvctl status asm</span><br><span class="line">srvctl status scan</span><br><span class="line">srvctl status vip -n rac1</span><br><span class="line">srvctl status scan_listener</span><br></pre></td></tr></table></figure>
<p><img src="/images/2017/1123/46.png" alt="rac"><br><img src="/images/2017/1123/47.png" alt="rac"></p>
<h2 id="创建ASM磁盘组"><a href="#创建ASM磁盘组" class="headerlink" title="创建ASM磁盘组"></a>创建ASM磁盘组</h2><p>在grid 用户下，执行 asmca，启动 asm 磁盘组创建向导<br>DATA组，存放数据文件，包括&#x2F;dev&#x2F;asm-data,&#x2F;dev&#x2F;asm-backup;VOTINGDISK组，存放闪回文件，包含&#x2F;dev&#x2F;asm-vdisk<br>Disk Groups，点击create 按钮，在弹出的创建界面中填写磁盘组名称，选择external(none)，并勾选成员，选择完毕后点击 ok；<br><img src="/images/2017/1123/48.png" alt="rac"><br><img src="/images/2017/1123/49.png" alt="rac"><br><img src="/images/2017/1123/50.png" alt="rac"><br>确认stat为2 of 2时,退出asmca<br><img src="/images/2017/1123/51.png" alt="rac"></p>
<h1 id="安装oracle11gr2-database-软件"><a href="#安装oracle11gr2-database-软件" class="headerlink" title="安装oracle11gr2 database 软件"></a>安装oracle11gr2 database 软件</h1><p>建议直接用oracle用户登录图形桌面，而不是root登录su - oracle切换过去。这个安装过程也很简单，基本上和单机版的一样；</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rac1-&gt;cd /usr/local/src/database</span><br><span class="line">rac1-&gt;./runInstaller</span><br></pre></td></tr></table></figure>
<p><img src="/images/2017/1123/52.png" alt="rac"><br>创建和配置一个数据库<br><img src="/images/2017/1123/53.png" alt="rac"><br>服务器模式<br><img src="/images/2017/1123/54.png" alt="rac"><br>选择rac集群中的节点<br><img src="/images/2017/1123/55.png" alt="rac"><br>高级安装<br><img src="/images/2017/1123/56.png" alt="rac"><br>添加中文支持<br><img src="/images/2017/1123/57.png" alt="rac"><br>服务器版本<br><img src="/images/2017/1123/58.png" alt="rac"><br>默认安装路径<br><img src="/images/2017/1123/59.png" alt="rac"><br>一般用途<br><img src="/images/2017/1123/60.png" alt="rac"><br>实例名称，SID名称<br><img src="/images/2017/1123/61.png" alt="rac"><br><code>(ps:这里的截图稍微有点问题，sid应该是orcl，不是orcl1)</code><br>自动分配内存<br><img src="/images/2017/1123/62.png" alt="rac"><br>选择中文字符集<br><img src="/images/2017/1123/63.png" alt="rac"><br><img src="/images/2017/1123/64.png" alt="rac"><br>连接asm存储的密码<br><img src="/images/2017/1123/65.png" alt="rac"><br>不备份<br><img src="/images/2017/1123/66.png" alt="rac"><br>选择DATA磁盘组<br><img src="/images/2017/1123/67.png" alt="rac"><br>设置sys&#x2F;system密码<br><img src="/images/2017/1123/68.png" alt="rac"><br>默认管理组<br><img src="/images/2017/1123/69.png" alt="rac"><br>监测依赖<br><img src="/images/2017/1123/70.png" alt="rac"><br>配置信息<br><img src="/images/2017/1123/71.png" alt="rac"><br><img src="/images/2017/1123/72.png" alt="rac"><br>安装完成<br><img src="/images/2017/1123/73.png" alt="rac"><br><img src="/images/2017/1123/74.png" alt="rac"><br>依次执行脚本<br><img src="/images/2017/1123/75.png" alt="rac"><br><img src="/images/2017/1123/76.png" alt="rac"><br><img src="/images/2017/1123/77.png" alt="rac"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Entries will be added to the /etc/oratab file as needed by</span><br><span class="line">Database Configuration Assistant when a database is created</span><br><span class="line">Finished running generic part of root.sh script.</span><br><span class="line">Now product-specific root actions will be performed.</span><br><span class="line">Finished product-specific root actions.</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sqlplus system/oracle@orcl</span><br><span class="line">select inst_id,instance_number,instance_name from gv$instance;</span><br></pre></td></tr></table></figure>
<p><img src="/images/2017/1123/78.png" alt="rac"></p>
<p>参考资料：<br><a href="http://v.qq.com/vplus/91c845f5c21fd8a6a25e9827b38c171e">http://v.qq.com/vplus/91c845f5c21fd8a6a25e9827b38c171e</a><br><a href="http://www.dba-oracle.com/t_reset_an_asm_diskgroup.htm">http://www.dba-oracle.com/t_reset_an_asm_diskgroup.htm</a><br><a href="http://www.oracle.com/technetwork/cn/articles/hunter-rac11gr2-iscsi-083834-zhs.html">http://www.oracle.com/technetwork/cn/articles/hunter-rac11gr2-iscsi-083834-zhs.html</a><br><a href="http://blog.csdn.net/u010098331/article/details/50767353">http://blog.csdn.net/u010098331/article/details/50767353</a><br><a href="https://docs.oracle.com/cd/E11882_01/doc.112/e28441/require.htm#CDMIG110">https://docs.oracle.com/cd/E11882_01/doc.112/e28441/require.htm#CDMIG110</a><br><a href="http://blog.sina.com.cn/s/blog_563c17780102ux53.html">http://blog.sina.com.cn/s/blog_563c17780102ux53.html</a><br><a href="https://blogs.oracle.com/database4cn/11gr2-crsgrid-scansingle-client-access-name">https://blogs.oracle.com/database4cn/11gr2-crsgrid-scansingle-client-access-name</a></p>
<hr>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>集群</tag>
        <tag>Oracle</tag>
        <tag>数据库</tag>
        <tag>RAC</tag>
      </tags>
  </entry>
  <entry>
    <title>Oracle入门</title>
    <url>/arlo/9f698189/</url>
    <content><![CDATA[<p>服务、监听<br>启动oracle服务</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">su - oracle</span><br><span class="line">sqlplus /nolog</span><br><span class="line">sql&gt; conn /as sysdba</span><br><span class="line">sql&gt; startup</span><br><span class="line">sql&gt; exit</span><br></pre></td></tr></table></figure>
<p>启动监听服务</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">lsnrctl start</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<p>配置监听</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">netca</span><br></pre></td></tr></table></figure>
<p>启动em控制台</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">emctl start dbconsole</span><br></pre></td></tr></table></figure>
<p>创建数据库</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dbca</span><br></pre></td></tr></table></figure>
<p>连接数据库</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sqlplus /nolog</span><br><span class="line">conn / as sysdba;</span><br></pre></td></tr></table></figure>
<p>连接数据库</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">conn system/password;</span><br></pre></td></tr></table></figure>
<p>断开数据库连接</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">disc[onnect]</span><br></pre></td></tr></table></figure>
<p>将屏幕上的内容输入到文件中</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">spool d:\a.txt</span><br><span class="line">……</span><br><span class="line">spool off;</span><br></pre></td></tr></table></figure>

<p>创建用户</p>
<p>密码必须以字母开头</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">create user xiaoming identified by m123;</span><br></pre></td></tr></table></figure>
<p>sys用户：超级管理员，权限最高，dba角色，默认密码：change_on_install<br>system用户：系统管理员，没有create database权限，默认密码：manager<br>普通用户：新建的用户无登录数据库权限<br>查看当前用户</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">show user；</span><br></pre></td></tr></table></figure>
<p>修改密码</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. passw[ord]</span><br><span class="line">2. alter user 用户名 identified by 新密码;</span><br></pre></td></tr></table></figure>
<p>删除用户<br>如果用户已经创建表，删除的时候加一个cascade参数</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">drop user 用户名 cascade</span><br></pre></td></tr></table></figure>
<p>如果一个用户正在被占用，报错<em>ORA-01940: cannot drop a user that is currently connected</em></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT &#x27;ALTER SYSTEM KILL SESSION &#x27;||&#x27;&#x27;&#x27;&#x27;||SID||&#x27;&#x27;&#x27;&#x27;||&#x27;,&#x27;||&#x27;&#x27;&#x27;&#x27;||SERIAL#||&#x27;&#x27;&#x27;&#x27;||&#x27;;&#x27; as KILLER FROM V$SESSION WHERE USERNAME=&#x27;USER&#x27;;</span><br></pre></td></tr></table></figure>
<p>授予权限</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">grant select on emp to xiaoming;</span><br><span class="line">grant all on emp to xiaoming;</span><br></pre></td></tr></table></figure>
<p>收回权限</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">revoke all on emp to xiaoming;</span><br></pre></td></tr></table></figure>
<p>收回上级权限，下级权限也相应取消<br>对象权限授权</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">grant select on emp to xiaoming with grant option;</span><br><span class="line">conn xiaoming/m1234;</span><br><span class="line">grant select on scott.emp to xiaohong;</span><br></pre></td></tr></table></figure>
<p>系统权限授权</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">grant connect to xiaoming with admin option;</span><br><span class="line">conn xiaoming/1234;</span><br><span class="line">grant connect to xiaohong;</span><br></pre></td></tr></table></figure>
<p>用户口令管理<br>建立数据库时候，oracle会建立默认的default的profile，当没有给用户指定profile的时候，oracle会将default的profile分配给用户<br>创建profile文件<br>用户输入3次错误密码后被锁定2天</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">create profile lock_account limit failed_login_attempts 3 password_lock_time 2;</span><br><span class="line">alter user xiaoming profile lock_account;</span><br></pre></td></tr></table></figure>
<p>用户解锁</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">alter user xiaoming account unlock;</span><br></pre></td></tr></table></figure>
<p>定期修改密码<br>要求用每隔30天修改登录密码，宽限期为2天，32天后没有修改将不能登录</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">create profile myprofile limit password_life_time 30 password_grace_time 2;</span><br><span class="line">alter user xiaoming profile myprofile;</span><br></pre></td></tr></table></figure>
<p>口令历史<br>希望用户修改密码的时候，不能使用之前的密码；使用口令历史，oracle会将之前的密码存在数据字典中，当用户修改密码时，oracle会将新输入的密码和旧密码进行比对，如果一样，会提示重新输入。<br>不能使用10内使用过的密码</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">create profile password_history limit password_life_time 10 password_grace_time 2 password_reuse_time 10</span><br><span class="line">alter user xiaoming profile password_history;</span><br></pre></td></tr></table></figure>
<p>删除profile文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">drop profile password_history [cascade]</span><br></pre></td></tr></table></figure>
<p>###############Day2############<br>创建表<br>必须以字母开头<br>长度不能超过30个字符<br>不能使用oracle保留字<br>只能使用a-zA-Z0-9$#</p>
<p>字符型<br>char 2000<br>varchar2 4000<br>clob 4000+<br>数字型<br>number 整数，小数 -(10^38) ~ 10^38<br>日期类型<br>date  包含年月日和时分秒<br>timestamp 时间戳，精度更高<br>图片<br>blob</p>
<p>创建student表</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">create table student(</span><br><span class="line">xh number(4),</span><br><span class="line">xm varchar2(20),</span><br><span class="line">sex char(2),</span><br><span class="line">birthday date,</span><br><span class="line">sal num(7,2)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>添加一个字段</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">alter table student add(classID number(2));</span><br></pre></td></tr></table></figure>
<p>修改字段长度</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">alter table student modify(xm varchar2(30));</span><br></pre></td></tr></table></figure>
<p>修改字段的类型&#x2F;或者名字（不能有数据）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">alter table student modify (xm char(30));</span><br></pre></td></tr></table></figure>
<p>删除一个字段</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">alter table student drop column sal;</span><br></pre></td></tr></table></figure>
<p>修改表名字</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rename student to stu;</span><br></pre></td></tr></table></figure>
<p>删除表</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">drop table student;</span><br></pre></td></tr></table></figure>
<p>修改日期默认格式</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">alter session set nls_date_format=&#x27;mm-dd-yyyy&#x27;</span><br></pre></td></tr></table></figure>
<p>插入数据<br>插入所有字段</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">insert into student values(1,&#x27;小明&#x27;,&#x27;男&#x27;,&#x27;03-14-2017&#x27;,3200.00)</span><br></pre></td></tr></table></figure>
<p>插入部分字段</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">insert into student(xh,xm,sex) values(&#x27;23&#x27;,小张&#x27;,&#x27;男&#x27;)</span><br></pre></td></tr></table></figure>
<p>插入空值<br>修改数据</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">update student set sex=&#x27;女&#x27; where xm=&#x27;小明&#x27;;</span><br></pre></td></tr></table></figure>
<p>修改多个字段，用逗号隔开</p>
<p>将一行数据复制多条</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">insert into users (userid,username,userpass) select * from users;</span><br></pre></td></tr></table></figure>

<p>查询字段为[非]空</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select * from student where brithday is [not] null;</span><br></pre></td></tr></table></figure>
<p>删除数据,不删除表结构，记录在日志中，删除之前建立一个回滚点savepoint aa;可恢复</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">delete from student;</span><br></pre></td></tr></table></figure>
<p>删除数据后回滚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rollback to aa;</span><br></pre></td></tr></table></figure>
<p>删除表的结构和数据</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">drop table student;</span><br></pre></td></tr></table></figure>
<p>删除表数据，不删除表结构，不记录在日志中，不可恢复，速度快；</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">truncate table student;</span><br></pre></td></tr></table></figure>
<p>查看表结构</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">desc table_name;</span><br></pre></td></tr></table></figure>
<p>查询所有列</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select * from dept;</span><br></pre></td></tr></table></figure>
<p>查询指定列</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select ename,sal,job,deption from dept;</span><br></pre></td></tr></table></figure>
<p>取消重复行</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select distinct deptno,job from emp;</span><br></pre></td></tr></table></figure>
<p>打开显示操作时间</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">set timing on;</span><br></pre></td></tr></table></figure>
<p>nvl处理null值，当字段为null，当0处理</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select sal*13+nvl(comm,0)*13 &quot;年工资&quot;,ename,comm from emp;</span><br></pre></td></tr></table></figure>
<p>like<br>%表示0到多个字符<br>_表示任意单个字符</p>
<p>多个值匹配</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select * from emp where empno in(123,234,500);</span><br></pre></td></tr></table></figure>
<p>or &amp; and</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select * from emp where (sal&gt;500 or job=&#x27;Manager&#x27;) and ename like &#x27;J%&#x27;;</span><br></pre></td></tr></table></figure>
<p>默认排序低到高</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">order by [asc/desc]</span><br><span class="line">select * from emp order by sal;</span><br><span class="line">````</span><br><span class="line">按部门编号升序，薪水降序列；</span><br></pre></td></tr></table></figure>
<p>select * from emp order by depto, sal desc;</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">列别名排序</span><br></pre></td></tr></table></figure>
<p>select ename,(sal+nvl(comm,0))*12 [as] “年薪” from emp order by “年薪”;</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">复杂查询</span><br><span class="line">max，min，avg，sum，count</span><br><span class="line">查询一个最高工资，最低工资</span><br></pre></td></tr></table></figure>
<p>select max(sal),min(sal) from emp;</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">查出最高工资员工</span><br></pre></td></tr></table></figure>
<p>select ename,sal from emp where sal&#x3D;(select max(sal) from emp);</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">显示工资高于平均工资的员工</span><br></pre></td></tr></table></figure>
<p>select * from emp where sal&gt;(select avg(sal) from emp);</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">group by</span><br><span class="line">按部门分组，查出部门平均工资和最高工资</span><br></pre></td></tr></table></figure>
<p>select avg(sal),max(sal),deptno from emp group by deptno;</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">显示每个部门的每种岗位的平均工资，最高工资</span><br></pre></td></tr></table></figure>
<p>select avg(sal),max(sal),deptno,job from emp group by deptno,job;</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">having</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>select avg(sal),max(sal),deptno  from emp group by deptno having avg(sal)&gt;2000;</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">同一条语句出现顺序，优先级group by &gt; having &gt; order by</span><br><span class="line">在选择列中，如果有列，表达式和分组函数，那么这些列和表达式中必须有一个出现在group by字句中，否则会报错</span><br><span class="line"></span><br><span class="line">多表查询</span><br><span class="line">多表查询的条件是至少不能少于表的个数-1</span><br><span class="line">笛卡尔集</span><br></pre></td></tr></table></figure>
<p>select a1.ename,a1.sal,a2.dname from emp a1, dept a2 where a1.deptno&#x3D;a2.deptno;</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">between 在两者之间</span><br></pre></td></tr></table></figure>
<p>select a1.ename,a1.sal,a2.grade from emp a1,salgrade a2 where a1.sal between  a2.losal and a2.hisal; </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">多表排序</span><br></pre></td></tr></table></figure>
<p>select a1.ename,a2.dname,a1.sal from emp a1,dept a2 where a1.deptno&#x3D;a2.deptno order by a1.deptno;</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">自连接</span><br><span class="line"></span><br><span class="line">子查询</span><br><span class="line">数据库执行sql语句从左到右</span><br><span class="line">单行子查询</span><br></pre></td></tr></table></figure>
<p>select * from emp where deptno&#x3D;(select deptno from emp where ename&#x3D;’SMITH’);</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">多行子查询</span><br></pre></td></tr></table></figure>
<p>select * from emp where job in(select distinct job from emp where deptno&#x3D;10);</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">all </span><br><span class="line">查出工资比部门30的所有员工的工资都高的员工的姓名，工资和部门号</span><br></pre></td></tr></table></figure>
<p>select ename,sal,deptno from emp where sal&gt;all(select all from emp where deptno&#x3D;30);<br>select * from emp where sal&gt;(select max(sal) from emp where deptno&#x3D;30)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">any</span><br><span class="line">查出工资比部门30的任意一个员工的工资高的员工的姓名，工资和部门号</span><br></pre></td></tr></table></figure>
<p>select ename,sal,dept from emp where sal&gt;any(select all from emp where deptno&#x3D;30);<br>select * from emp where sal&gt;(select min(sal) from emp where deptno&#x3D;30)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">多列子查询</span><br><span class="line">查出与SMITH部门和岗位完全相同的所有职员</span><br></pre></td></tr></table></figure>
<p>select * from emp where (deptno,job)&#x3D;(select deptno,job from emp where ename&#x3D;’SMITH’);</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">查询高于自己部门平均工资的员工的信息</span><br></pre></td></tr></table></figure>
<p>select a2.ename,a2.sal,a2.deptno,a1.mysal from emp a2,(select deptno,avg(sal) mysql from emp group by deptno) a1 where a2.deptno&#x3D;a1.deptno and a2.sal &gt; a1.mysal;</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">内嵌视图就是子查询当一个表使用，当在from子句中使用子查询时，必须给子查询指定别名；</span><br><span class="line">列加别名可以加as，表加别名不能加as</span><br><span class="line"></span><br><span class="line">分页查询</span><br><span class="line">一共有三种方式</span><br><span class="line">1. rownum 分页</span><br></pre></td></tr></table></figure>
<p>select * from (select a1.*,rownum rn from (select * from emp) a1 where rownum&lt;&#x3D;10) where rn&gt;6;</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">2. ROWID 分页 </span><br><span class="line">速度最快</span><br><span class="line"></span><br><span class="line">3. 按分析函数分页</span><br><span class="line">速度最慢</span><br><span class="line"></span><br><span class="line">查询结果创建新表</span><br></pre></td></tr></table></figure>
<p>create table mytable (id,name,sal,job,deptno) as select empno,ename,sal from emp;</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">合并查询</span><br><span class="line">为了合并多个select语句的结果，可以使用集合操作符号union，union all，intersect，minus.</span><br><span class="line">union</span><br><span class="line">去多个select查询结果的并集，取消重复行</span><br><span class="line">union all</span><br><span class="line">和union 类似，不取消重复行，or关系</span><br><span class="line">intersect</span><br><span class="line">取交集结果</span><br><span class="line">minus</span><br><span class="line">取差集（一个集合完全包含另一个集合，取没有的部分）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">数据库管理员职责：</span><br><span class="line">1. 安装和升级oracle数据库</span><br><span class="line">2. 建库，表空间，表，视图，索引……</span><br><span class="line">3. 指定并实施备份和恢复计划</span><br><span class="line">4. 数据库权限管理，调优，故障排除，</span><br><span class="line">5. 对于高级dba，要求能参与项目开发，会编写sql语句，存储过程，触发器，规则，约束，包</span><br><span class="line"></span><br><span class="line">sys用户：</span><br><span class="line">所有oracle的数据字典的基表和动态视图都存在sys用户中；</span><br><span class="line">sys拥有dba（数据库管理员角色），sysdba（系统管理员），sysoper（系统操作员） 角色和权限；</span><br><span class="line">是oracle最高权限用户，必须以as sysdba或as sysoper形式登录，不能以normal方式登录数据库</span><br><span class="line"></span><br><span class="line">system 用户：</span><br><span class="line">存放次级用户内部数据;</span><br><span class="line">拥有dba，sysdba角色及权限；</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">显示oracle 初始化参数</span><br><span class="line">show parameter;</span><br><span class="line"></span><br><span class="line">数据库的逻辑备份和恢复</span><br><span class="line"></span><br><span class="line">导出表</span><br></pre></td></tr></table></figure>
<p>exp userid&#x3D;username&#x2F;passwd@sid tables&#x3D;(table1,table2,table3) file&#x3D;&#x2F;path&#x2F;x.dmp</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">导入表</span><br></pre></td></tr></table></figure>
<p>imp userid&#x3D;username&#x2F;passwd@sid tables&#x3D;(table1,table2,table3) file&#x3D;&#x2F;path&#x2F;x.dmp</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">使用直接导出方式</span><br><span class="line">这种方式比默认常规的方式速度要快，当数据量大时，可以考虑这种方法，这时需要数据库的字符集要与客户端的字符集完全一致，否则报错</span><br></pre></td></tr></table></figure>
<p>exp userid&#x3D;username&#x2F;passwd@sid tables&#x3D;(table1,table2,table3) file&#x3D;&#x2F;path&#x2F;x.dmp direct&#x3D;y</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">导出表结构</span><br></pre></td></tr></table></figure>
<p>exp userid&#x3D;username&#x2F;passwd@sid tables&#x3D;(table1,table2,table3) file&#x3D;&#x2F;path&#x2F;x.dmp rows&#x3D;n</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">导出方案</span><br></pre></td></tr></table></figure>
<p>exp username&#x2F;passwd@sid owner&#x3D;username file&#x3D;&#x2F;path&#x2F;x.dmp</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">导出数据库</span><br></pre></td></tr></table></figure>
<p>exp userid&#x3D;system&#x2F;passwd@sid full&#x3D;y inctype&#x3D;complete file&#x3D;&#x2F;path&#x2F;xx.dmp<br>imp userid&#x3D;system&#x2F;manager full&#x3D;y file&#x3D;&#x2F;path&#x2F;xx.dmp</p>
<pre><code>
数据字典记录了数据库的系统信息，它是只读表和视图的集合，数据字典的所有者为sys用户，用户只能在数据字典上执行查询操作，而其维护和修改是由系统自动完成的
数据字典包括字典基表和数据字典动态视图，其中基表存储数据库的基本信息，普通用户不能直接访问数据字典的基表，数据字典视图是基于数据字典基表所建立的视图，普通用户可以通过查询数据字典的视图取得系统信息
数据字典视图主要包括user_xxx,all_xxx,dba_xxx三种类型

user_tables;
用于显示当前用户拥有的所有表，只返回用户所对应方案的所有表；
select table_name from user_tables;
all_tables;
用于显示当前用户可以访问的所有表;
select table_name from all_tables;
dba_tables;
用户显示所有方案拥有的数据库表。但是查询这种数据库字典视图，要求用户必须是dba角色或是有select any table系统权限。
select table_name from dba_tables;

用户名，权限，角色
dba_users  可以显示所有数据库用户的详细信息；
dba_sys_privs 可以显示用户所具有的系统权限；
dba_tab_privs 可以显示用户具有的对象权限;
dba_col_privs 可以显示用户具有的列权限；
dba_role_privs 可以显示用户所具有的角色。

查询oracle中所有的系统权限，一般是dba
select * from system_privilege_map order by name;
查询oracle中所有的角色，一般是dba
select * from dba_roles;
查询oracle中所有的对象权限，一般是dba
select distinct privilege from dba_tab_privs;
查询数据表的表空间
select tablespace_name from dba_tablespaces;


oracle 有多少种角色？
select * from dba_roles;
查询一种角色有多少种权限？
a. 一个角色包含的系统权限
select * from dba_sys_privs where grantee=&#39;CONNECT&#39;;
select * from role_sys_privs where role=&#39;CONNECT&#39;;
b. 一个角色包含的对象权限
select * from dba_tab_privs where grantee=&#39;CONNECT&#39;;
如何查看某个用户具有什么样的角色？
select * from dba_role_privs where grantee=&#39;SCOTT&#39;;

显示当前用户可以访问的所有数据字典视图
select * from dict where comments like &#39;%grant%&#39;
显示当前数据库的全称
select * from global_name;
</code></pre>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>Oracle</tag>
        <tag>数据库</tag>
      </tags>
  </entry>
  <entry>
    <title>Oracle删除用户报错ORA-01940: cannot drop a user that is currently connected</title>
    <url>/arlo/dd79d161/</url>
    <content><![CDATA[<p>oracle导入数据之前，删除用户时候报错“ORA-01940: cannot drop a user that is currently connected”，原因是因为用户正在连接使用。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SQL&gt; drop user air_forecast cascade;</span><br><span class="line">drop user air_forecast cascade</span><br><span class="line">*</span><br><span class="line">ERROR at line 1:</span><br><span class="line">ORA-01940: cannot drop a user that is currently connected</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<h1 id="查询一下当前用户连接"><a href="#查询一下当前用户连接" class="headerlink" title="查询一下当前用户连接"></a>查询一下当前用户连接</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SQL&gt; select sid,serial# from v$session where username=&#x27;AIR_FORECAST&#x27;;</span><br><span class="line">       SID    SERIAL#</span><br><span class="line">---------- ----------</span><br><span class="line">       237	 2083</span><br><span class="line">       252	 3564</span><br></pre></td></tr></table></figure>
<p><img src="/images/2017/1010/01.png" alt="oracle"></p>
<h1 id="杀掉占用进程"><a href="#杀掉占用进程" class="headerlink" title="杀掉占用进程"></a>杀掉占用进程</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SQL&gt; alter system kill session &#x27;237,2083&#x27;;</span><br><span class="line"></span><br><span class="line">System altered.</span><br><span class="line"></span><br><span class="line">SQL&gt; alter system kill session &#x27;252,3564&#x27;;</span><br><span class="line"></span><br><span class="line">System altered.</span><br></pre></td></tr></table></figure>
<h1 id="删除用户"><a href="#删除用户" class="headerlink" title="删除用户"></a>删除用户</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SQL&gt; drop user air_forecast cascade;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">User dropped.</span><br></pre></td></tr></table></figure>
<p><img src="/images/2017/1010/02.png" alt="oracle"></p>
<p>PS：上述语句中没有状态列，所以看到删除的进程还在，其实是已经标记为KILLED状态了(status 为要删除用户的session状态，如果还为inactive，说明没有被kill掉，如果状态为killed，说明已kill)，删除进程后使用如下语句查询.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select saddr,sid,serial#,paddr,username,status from v$session where username is not null;</span><br></pre></td></tr></table></figure>
<h1 id="导入用户数据"><a href="#导入用户数据" class="headerlink" title="导入用户数据"></a>导入用户数据</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SQL&gt; select * from dba_directories;	#查询存储文件目录，将备份文件拷贝到此目录下</span><br><span class="line">shell&gt; impdp userid=&quot;&#x27;sys/password@sx21 as sysdba&#x27;&quot; schemas=air_forecast directory=DATA_PUMP_DIR dumpfile=AIR_FORECAST.DMP</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>Oracle</tag>
        <tag>数据库</tag>
        <tag>Troubleshooting</tag>
      </tags>
  </entry>
  <entry>
    <title>Oracle数据库错误表SYS.AUD$无法通过8192(在表空间SYSTEM中)扩展</title>
    <url>/arlo/1998d04e/</url>
    <content><![CDATA[<p>数据库报错信息</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[Content]</span><br><span class="line">ORA-00604: 递归 SQL 级别 1 出现错误</span><br><span class="line">ORA-01653: 表 SYS.AUD$ 无法通过 8192 (在表空间 SYSTEM 中) 扩展</span><br><span class="line">ORA-02002: 写入审计线索时出错</span><br><span class="line">ORA-00604: 递归 SQL 级别 1 出现错误</span><br><span class="line">ORA-01653: 表 SYS.AUD$ 无法通过 8192 (在表空间 SYSTEM 中) 扩展</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<p>该错误原因为表空间无法扩展故障，查找后得知单个表空间文件最大32G，有两个方法扩大表空间<br>（1）创建多个数据文件，都不能超过32g<br>（2）创建大表空间。create bigfile tablespace  他的上限是8EB，不过，oracle10及以后版本才能用。<br>这里我们使用第一种方法处理一下此故障。</p>
<h1 id="Windows下切换SID"><a href="#Windows下切换SID" class="headerlink" title="Windows下切换SID"></a>Windows下切换SID</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">C:\Users\Administrator&gt;SET ORACLE_SID=sx21</span><br><span class="line">C:\Users\Administrator&gt;sqlplus /nolog</span><br><span class="line">SQL&gt; conn /as sysdba</span><br><span class="line"># 查询当前实例</span><br><span class="line">SQL&gt; select instance_name from v$instance；</span><br><span class="line">INSTANCE_NAME</span><br><span class="line">----------------</span><br><span class="line">sx21</span><br></pre></td></tr></table></figure>
<h1 id="增加一个表空间文件"><a href="#增加一个表空间文件" class="headerlink" title="增加一个表空间文件"></a>增加一个表空间文件</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 查询表空间路径</span><br><span class="line">SQL&gt; SELECT FILE_NAME,TABLESPACE_NAME,AUTOEXTENSIBLE FROM dba_data_files WHERE TABLESPACE_NAME=&#x27;SYSTEM&#x27;;</span><br><span class="line"># 在同路径目录下添加一个表空间文件</span><br><span class="line">SQL&gt; ALTER TABLESPACE &quot;SYSTEM&quot; ADD DATAFILE &#x27;E:\APP\ADMINISTRATOR\ORADATA\SX21\SYSTEM02.DBF&#x27; SIZE 1000M AUTOEXTEND ON NEXT 50M MAXSIZE UNLIMITED;</span><br></pre></td></tr></table></figure>
<h1 id="执行完成后重新查看表空间使用情况"><a href="#执行完成后重新查看表空间使用情况" class="headerlink" title="执行完成后重新查看表空间使用情况"></a>执行完成后重新查看表空间使用情况</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SQL&gt; SELECT UPPER(F.TABLESPACE_NAME) &quot;表空间名&quot;, D.TOT_GROOTTE_MB &quot;表空间大小(M)&quot;, D.TOT_GROOTTE_MB - F.TOTAL_BYTES &quot;已使用空间(M)&quot;, TO_CHAR(ROUND((D.TOT_GROOTTE_MB - F.TOTAL_BYTES) / D.TOT_GROOTTE_MB * 100,2),&#x27;990.99&#x27;) &quot;使用比&quot;, F.TOTAL_BYTES &quot;空闲空间(M)&quot;, F.MAX_BYTES &quot;最大块(M)&quot; FROM (SELECT TABLESPACE_NAME, ROUND(SUM(BYTES) / (1024 * 1024), 2) TOTAL_BYTES, ROUND(MAX(BYTES) / (1024 * 1024), 2) MAX_BYTES FROM SYS.DBA_FREE_SPACE GROUP BY TABLESPACE_NAME) F, (SELECT DD.TABLESPACE_NAME, ROUND(SUM(DD.BYTES) / (1024 * 1024), 2) TOT_GROOTTE_MB FROM SYS.DBA_DATA_FILES DD GROUP BY DD.TABLESPACE_NAME) D WHERE D.TABLESPACE_NAME = F.TABLESPACE_NAME ORDER BY 4 DESC;</span><br></pre></td></tr></table></figure>
<p><img src="/images/2017/1009/01.png" alt="oracle"></p>
<p>参考链接：<a href="http://www.jydba.net/oracle%E6%95%B0%E6%8D%AE%E6%96%87%E4%BB%B6%E5%A4%A7%E5%B0%8F%E7%9A%84%E9%99%90%E5%88%B6/">http://www.jydba.net/oracle数据文件大小的限制/</a></p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>Oracle</tag>
        <tag>数据库</tag>
        <tag>Troubleshooting</tag>
      </tags>
  </entry>
  <entry>
    <title>Oracle表空间扩容</title>
    <url>/arlo/989e9822/</url>
    <content><![CDATA[<p>在新装完的oracle数据库中导入数据，由于数据量比较大，报以下错误；</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ORA-39171: Job is experiencing a resumable wait.</span><br><span class="line">ORA-01653: unable to extend table AIR_FORECAST.T_WRF_DATA by 8192 in tablespace USERS</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<p>此故障是由于数据库的表空间满了，造成的数据无法正常导入，我们需要手动来扩容表空间</p>
<h1 id="查询当前实例名"><a href="#查询当前实例名" class="headerlink" title="查询当前实例名"></a>查询当前实例名</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select instance_name from v$instance;</span><br></pre></td></tr></table></figure>
<h1 id="查询表空间名"><a href="#查询表空间名" class="headerlink" title="查询表空间名"></a>查询表空间名</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select tablespace_name from sys.dba_tablespaces;</span><br></pre></td></tr></table></figure>
<h1 id="查询默认表空间"><a href="#查询默认表空间" class="headerlink" title="查询默认表空间"></a>查询默认表空间</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select a.property_name, a.property_value from database_properties a where a.property_name like &#x27;%DEFAULT%&#x27;;</span><br><span class="line">……</span><br><span class="line">DEFAULT_PERMANENT_TABLESPACE</span><br><span class="line">USERS</span><br><span class="line">……</span><br></pre></td></tr></table></figure>
<h1 id="查看表空间使用情况"><a href="#查看表空间使用情况" class="headerlink" title="查看表空间使用情况"></a>查看表空间使用情况</h1><h2 id="在PL-SQL-Developer-中执行一下SQL语句"><a href="#在PL-SQL-Developer-中执行一下SQL语句" class="headerlink" title="在PL SQL Developer 中执行一下SQL语句"></a>在PL SQL Developer 中执行一下SQL语句</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT a.tablespace_name &quot;表空间名&quot;,a.bytes / 1024 / 1024 &quot;表空间大小(M)&quot;,(a.bytes - b.bytes) / 1024 / 1024 &quot;已使用空间(M)&quot;,b.bytes / 1024 / 1024 &quot;空闲空间(M)&quot;,round(((a.bytes - b.bytes) / a.bytes) * 100, 2) &quot;使用比&quot;FROM (SELECT tablespace_name, sum(bytes) bytes FROM dba_data_files GROUP BY tablespace_name) a,(SELECT tablespace_name, sum(bytes) bytes, max(bytes) largest FROM dba_free_space GROUP BY tablespace_name) b WHERE a.tablespace_name = b.tablespace_name ORDER BY ((a.bytes - b.bytes) / a.bytes) DESC</span><br></pre></td></tr></table></figure>
<h2 id="查看USERS表空间文件及使用量"><a href="#查看USERS表空间文件及使用量" class="headerlink" title="查看USERS表空间文件及使用量"></a>查看USERS表空间文件及使用量</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT file_name,tablespace_name,bytes / 1024 / 1024 &quot;bytes MB&quot;,maxbytes / 1024 / 1024 &quot;maxbytes MB&quot; FROM dba_data_files WHERE tablespace_name = &#x27;USERS&#x27;;</span><br></pre></td></tr></table></figure>
<h2 id="查看USERS表空间文件是否自动扩展"><a href="#查看USERS表空间文件是否自动扩展" class="headerlink" title="查看USERS表空间文件是否自动扩展"></a>查看USERS表空间文件是否自动扩展</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT file_id, file_name, tablespace_name, autoextensible, increment_by FROM dba_data_files WHERE tablespace_name = &#x27;USERS&#x27; ORDER BY file_id desc;</span><br></pre></td></tr></table></figure>
<p>查看”autoextensible”对应的值是YES还是NO，若是NO，说明MSMS表空间的自动扩展功能没有开，改成YES就可以了。</p>
<h2 id="查询所有的schema所占空间大小"><a href="#查询所有的schema所占空间大小" class="headerlink" title="查询所有的schema所占空间大小"></a>查询所有的schema所占空间大小</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select owner, sum(bytes)/1024/1024/1024 schema_size_gig from sys.dba_segments group by owner;</span><br></pre></td></tr></table></figure>
<h1 id="增加表空间文件"><a href="#增加表空间文件" class="headerlink" title="增加表空间文件"></a>增加表空间文件</h1><h2 id="查看表空间文件"><a href="#查看表空间文件" class="headerlink" title="查看表空间文件"></a>查看表空间文件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT * FROM dba_data_files t WHERE t.tablespace_name=&#x27;USERS&#x27;;</span><br></pre></td></tr></table></figure>
<p>查看得知我们的表空间文件在&#x2F;u01&#x2F;app&#x2F;oracle&#x2F;oradata&#x2F;sx21&#x2F;目录下，新建的文件也放在此目录下,方便后期管理</p>
<h2 id="查看表空间文件自增长文件最大值"><a href="#查看表空间文件自增长文件最大值" class="headerlink" title="查看表空间文件自增长文件最大值"></a>查看表空间文件自增长文件最大值</h2><p>因为Oracle的物理文件最大只允许4194303个数据块(datablock).需要查看一下本地block块大小</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">数据块的大小        物理文件的最大值 M</span><br><span class="line">===============================================               </span><br><span class="line">2048                  8191 M</span><br><span class="line">4096                  16383 M</span><br><span class="line">8192                  32767 M</span><br><span class="line">16384                 65535 M</span><br></pre></td></tr></table></figure>
<h2 id="查看oracle数据库block大小"><a href="#查看oracle数据库block大小" class="headerlink" title="查看oracle数据库block大小"></a>查看oracle数据库block大小</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">在sqlplus窗口中执行</span><br><span class="line">SQL&gt; show parameter db_block_size;</span><br><span class="line"></span><br><span class="line">NAME				     TYPE	 VALUE</span><br><span class="line">------------------------------------ ----------- ------------------------------</span><br><span class="line">db_block_size			     integer	 8192</span><br><span class="line">在pl/SQL窗口中执行</span><br><span class="line">SQL&gt; select value from v$parameter where name=&#x27;db_block_size&#x27;;</span><br><span class="line"></span><br><span class="line">VALUE</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">8192</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="添加表空间文件"><a href="#添加表空间文件" class="headerlink" title="添加表空间文件"></a>添加表空间文件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SQL&gt; alter tablespace USERS add datafile &#x27;/u01/app/oracle/oradata/sx21/users02.dbf&#x27; size 5M autoextend on maxsize 32767M;</span><br></pre></td></tr></table></figure>
<h2 id="ASM添加表空间文件"><a href="#ASM添加表空间文件" class="headerlink" title="ASM添加表空间文件"></a>ASM添加表空间文件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SQL&gt; alter tablespace USERS add datafile &#x27;+DATA&#x27; size 5M autoextend on maxsize 32767M;</span><br><span class="line">SQL&gt; select name from v$datafile;</span><br></pre></td></tr></table></figure>
<p><em>注意：ASM增加数据文件或者创建表空间不需要指定数据文件名，只要指定 diskgroup即可,ASM会自动命名。</em></p>
<h1 id="验证添加的表空间文件"><a href="#验证添加的表空间文件" class="headerlink" title="验证添加的表空间文件"></a>验证添加的表空间文件</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SQL&gt; select file_name,file_id,tablespace_name FROM dba_data_files WHERE tablespace_name=&#x27;USERS&#x27;;</span><br><span class="line"></span><br><span class="line">FILE_NAME</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">   FILE_ID TABLESPACE_NAME</span><br><span class="line">---------- ------------------------------</span><br><span class="line">/u01/app/oracle/oradata/sx21/users01.dbf</span><br><span class="line">	 4 USERS</span><br><span class="line"></span><br><span class="line">/u01/app/oracle/oradata/sx21/users02.dbf</span><br><span class="line">	 5 USERS</span><br></pre></td></tr></table></figure>
<h1 id="扩展阅读"><a href="#扩展阅读" class="headerlink" title="扩展阅读"></a>扩展阅读</h1><p><a href="http://www.dba-oracle.com/t_bigfile_tablespace_tips.htm">http://www.dba-oracle.com/t_bigfile_tablespace_tips.htm</a></p>
<p>参考资料：<br><a href="http://blog.csdn.net/u013806814/article/details/48400861">http://blog.csdn.net/u013806814/article/details/48400861</a><br><a href="http://blog.itpub.net/27042095/viewspace-1100993/">http://blog.itpub.net/27042095/viewspace-1100993/</a><br><a href="http://blog.sina.com.cn/s/blog_9d4799c701017pw1.html">http://blog.sina.com.cn/s/blog_9d4799c701017pw1.html</a><br><a href="https://blog.csdn.net/qq_33547950/article/details/79257882">https://blog.csdn.net/qq_33547950/article/details/79257882</a></p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>Oracle</tag>
        <tag>数据库</tag>
      </tags>
  </entry>
  <entry>
    <title>Tomcat启动慢原因排查</title>
    <url>/arlo/d8e5626d/</url>
    <content><![CDATA[<h1 id="故障现象1"><a href="#故障现象1" class="headerlink" title="故障现象1"></a>故障现象1</h1><h2 id="Tomcat启动异常，卡在以下提示处"><a href="#Tomcat启动异常，卡在以下提示处" class="headerlink" title="Tomcat启动异常，卡在以下提示处"></a>Tomcat启动异常，卡在以下提示处</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">INFO: validateJarFile(/usr/local/apache-tomcat-7.0.79/webapps/thsbox/WEB-INF/lib/tomcat-servlet-api-8.5.15.jar) - jar not loaded. See Servlet Spec 3.0, section 10.7.2. Offending class: javax/servlet/Servlet.class</span><br><span class="line">Aug 17, 2017 2:36:19 PM org.apache.catalina.startup.TldConfig execute</span><br><span class="line">INFO: At least one JAR was scanned for TLDs yet contained no TLDs. Enable debug logging for this logger for a complete list of JARs that were scanned but no TLDs were found in them. Skipping unneeded JARs during scanning can improve startup time and JSP compilation time.</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<h2 id="关闭TLDs"><a href="#关闭TLDs" class="headerlink" title="关闭TLDs"></a>关闭TLDs</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim  /usr/local/apache-tomcat-7.0.79/conf/context.xml</span><br><span class="line"></span><br><span class="line">&lt;Context processTlds=&quot;false&quot;&gt;</span><br><span class="line">    &lt;!-- Default set of monitored resources --&gt;</span><br><span class="line">    &lt;WatchedResource&gt;WEB-INF/web.xml&lt;/WatchedResource&gt;</span><br><span class="line">    ……</span><br><span class="line">&lt;/Context&gt;</span><br></pre></td></tr></table></figure>
<h2 id="屏蔽jar包"><a href="#屏蔽jar包" class="headerlink" title="屏蔽jar包"></a>屏蔽jar包</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /usr/local/apache-tomcat-7.0.79/conf/catalina.properties</span><br><span class="line"></span><br><span class="line">tomcat.util.scan.StandardJarScanFilter.jarsToSkip=\</span><br><span class="line">tomcat-servlet-api-8.5.15.jar</span><br></pre></td></tr></table></figure>
<p>更改以上两个地方，日志还是会打印出来，启动还是卡主</p>
<h1 id="故障现象2"><a href="#故障现象2" class="headerlink" title="故障现象2"></a>故障现象2</h1><p>起初以为是启动不起来了，后来一直等着，发现只是很慢，可以启动起来的,在7分钟左右</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">INFO: Server startup in 432720 ms</span><br></pre></td></tr></table></figure>
<p>跟踪日志有重大发现</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">WARNING: Creation of SecureRandom instance for session ID generation using [SHA1PRNG] took [422,085] milliseconds</span><br></pre></td></tr></table></figure>
<h2 id="第一种修改方法"><a href="#第一种修改方法" class="headerlink" title="第一种修改方法"></a>第一种修改方法</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /usr/local/jdk1.8.0_112/jre/lib/security/java.security</span><br><span class="line"></span><br><span class="line">#securerandom.source=file:/dev/random</span><br><span class="line">securerandom.source=file:/dev/./random</span><br></pre></td></tr></table></figure>
<p>修改完成后<em>INFO: Server startup in 118722 ms</em>(还是慢)</p>
<h2 id="第二种修改方法"><a href="#第二种修改方法" class="headerlink" title="第二种修改方法"></a>第二种修改方法</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /usr/local/apache-tomcat-7.0.79/bin/catalina.sh</span><br><span class="line">修改第232行</span><br><span class="line">JAVA_OPTS=&quot;$JAVA_OPTS $JSSE_OPTS -Djava.security.egd=file:/dev/./urandom&quot;</span><br></pre></td></tr></table></figure>
<p>修改完成后<em>INFO: Server startup in 8985 ms</em></p>
<p>参考：<a href="http://www.cnblogs.com/raphael5200/p/6844510.html">http://www.cnblogs.com/raphael5200/p/6844510.html</a></p>
]]></content>
      <tags>
        <tag>tomcat</tag>
      </tags>
  </entry>
  <entry>
    <title>SSH 奇淫技巧之隧道模式</title>
    <url>/arlo/da9b9fcb/</url>
    <content><![CDATA[<p>用了ssh这么久，今天才知道ssh还有这么强大的功能，穿透内外网，来去自如；其实最重要的还是方便平时工作中的调试，在此简单的记录一下。</p>
<h1 id="使用条件"><a href="#使用条件" class="headerlink" title="使用条件"></a>使用条件</h1><p>一台拥有ssh端口连接的外网linux服务器</p>
<h1 id="本地转发"><a href="#本地转发" class="headerlink" title="本地转发"></a>本地转发</h1><p>场景：公网有一台服务器的公网ip，ssh端口(已修改为2012)没有对外开放，本地想直接连接此端口，可以通过公网一台开放ssh端口的服务器跳转过去<br><code>ssh -p 2012 -CNg -L 2222:namenode:2012 nsxq@1.2.3.4 </code><br>将namenode服务器的2012端口通过1.2.3.4服务器映射到本地2222端口 ssh -p 2222 localhost 即可连接<br>-p 指定跳转机端口<br>-L 本地转发</p>
<h1 id="远程转发"><a href="#远程转发" class="headerlink" title="远程转发"></a>远程转发</h1><p>场景：本地开发环境需要被外网访问，之前一直使用花生壳，ngrok之类的程序；现在只需要本地执行一条ssh命令，将本地的端口映射到一台外网的服务器上去<br>将本地内网192.168.1.5:80 映射到1.2.3.4服务器的8888端口，访问1.2.3.4:8888 即可访问192.168.1.5:80 内容<br><code>ssh -p 2012 -CNfg -R 0.0.0.0:8888:192.168.1.5:80 nsxq@1.2.3.4</code><br><font color="#FF0000"> <strong>打开1.2.3.4服务器需要sshd_config 配置中的GatewayPorts yes</strong></font><br>记得顺手打开防火墙端口<br>-p 指定跳转机端口<br>-R 远程转发<br><code>ssh -CNfg -R 0.0.0.0:3306:10.71.36.123:3306 dczf@10.71.36.121</code><br>在10.71.36.123上执行此命令，将10.71.36.123的3306映射到10.71.36.121的3306端口</p>
<h1 id="动态转发"><a href="#动态转发" class="headerlink" title="动态转发"></a>动态转发</h1><p>场景：相对于上边两种单一端口转发，此功能就是在本地启动一个端口，其他机器可以设置代理，通过此端口进行流量转发（俗称翻墙）。<br><code>ssh -D 5000 nsxq@1.2.3.4 </code><br>我这里没有能上google的服务器，没法测试，按道理来说，其他机器就可以将代理设置为1.2.3.4:5000 进行商上网了</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>[实战ssh端口转发]<a href="http://www.ibm.com/developerworks/cn/linux/l-cn-sshforward/">http://www.ibm.com/developerworks/cn/linux/l-cn-sshforward/</a><br>[SSH的三种端口转发（Port forwarding）&#x2F; 隧道协议概要]<a href="https://blog.twofei.com/528/">https://blog.twofei.com/528/</a></p>
]]></content>
      <categories>
        <category>常识</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>SSH</tag>
      </tags>
  </entry>
  <entry>
    <title>Tomcat多实例部署</title>
    <url>/arlo/42b916ee/</url>
    <content><![CDATA[<p>同一个tomcat下部署多个项目，重启会影响到其他项目的正常运行，为了使各项目独立，一般会使用安装多个tomcat，这样很耗费系统资源；创建tomcat多实例，有效的解决这一问题；</p>
<span id="more"></span>
<h1 id="常见部署方式"><a href="#常见部署方式" class="headerlink" title="常见部署方式"></a>常见部署方式</h1><p><strong>单实例单应用：</strong>比较常用的一种方式，只需要把你打好的 war 包丢在 webapps目录下，执行启动 Tomcat 的脚本就行了。<br><strong>单实例多应用：</strong>有两个不同的 Web 项目 war 包，还是只需要丢在webapps目录下，执行启动 Tomcat 的脚本，访问不同项目加上不同的虚拟目录。这种方式要慎用在生产环境，因为重启或挂掉 Tomcat 后会影响另外一个应用的访问。<br><strong>多实例单应用：</strong>多个 Tomcat 部署同一个项目，端口号不同，可以利用 Nginx 这么做负载均衡，当然意义不大。<br><strong>多实例多应用：</strong>多个 Tomcat 部署多个不同的项目。这种模式在服务器资源有限，或者对服务器要求并不是很高的情况下，可以实现多个不同项目部署在同一台服务器上的需求，来实现资源使用的最大化。</p>
<h1 id="目录作用"><a href="#目录作用" class="headerlink" title="目录作用"></a>目录作用</h1><p><strong>bin</strong>		主要存放脚本文件，例如比较常用的windows和linux系统中启动和关闭脚本<br><strong>conf</strong>	主要存放配置文件，其中最重要的两个配置文件是server.xml和web.xml<br><strong>lib</strong>		主要存放tomcat运行所依赖的包<br><strong>logs</strong>	主要存放运行时产生的日志文件，例如catalina.{date}.log等<br><strong>temp</strong>	存放tomcat运行时产生的临时文件，例如开启了hibernate缓存的应用程序，会在该目录下生成一些文件<br><strong>webapps</strong>	部署web应用程序的默认目录<br><strong>work</strong>	主要存放由JSP文件生成的servlet（java文件以及最终编译生成的class文件）</p>
<p>CATALINA_HOME：即指向Tomcat安装路径的系统变量<br>CATALINA_BASE：即指向活跃配置路径的系统变量<br>通过设置这两个变量，就可以将tomcat的安装目录和工作目录分离，从而实现tomcat多实例的部署。</p>
<p><img src="/images/2017/0502/01.png" alt="tomcat"><br>将tomcat复制为以下目录结构<br><img src="/images/2017/0502/00.png" alt="tomcat"></p>
<h1 id="修改-CATALINA-HOME-x2F-conf-x2F-server-xml"><a href="#修改-CATALINA-HOME-x2F-conf-x2F-server-xml" class="headerlink" title="修改$CATALINA_HOME&#x2F;conf&#x2F;server.xml"></a>修改$CATALINA_HOME&#x2F;conf&#x2F;server.xml</h1><p>在server.xml中配置了四个监听端口，分别是：<br><strong>Server Port：</strong>	该端口用于监听关闭tomcat的shutdown命令，默认为8005<br><strong>Connector Port：</strong>	该端口用于监听HTTP的请求，默认为8080<br><strong>AJP Port：</strong>		该端口用于监听AJP（ Apache JServ Protocol ）协议上的请求，通常用于整合Apache Server等其他HTTP服务器，默认为8009<br><strong>Redirect Port：</strong>	重定向端口，出现在Connector配置中，如果该Connector仅支持非SSL的普通http请求，那么该端口会把https的请求转发到这个Redirect Port指定的端口，默认为8443</p>
<p>修改第22行Server Port （三个tomcat依次修改为8005,8006,8007）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;Server port=&quot;8007&quot; shutdown=&quot;SHUTDOWN&quot;&gt;</span><br></pre></td></tr></table></figure>
<p>修改第71行Connector Port(三个tomcat依次修改为8080,8081,8082)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;Connector port=&quot;8082&quot; protocol=&quot;HTTP/1.1&quot;</span><br></pre></td></tr></table></figure>
<p>修改第93行AJP Port (三个tomcat依次修改为8009,8019,8029)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;Connector port=&quot;8029&quot; protocol=&quot;AJP/1.3&quot; redirectPort=&quot;8443&quot; /&gt;</span><br></pre></td></tr></table></figure>
<p>虚拟主机配置<br><strong>name：</strong>		虚拟主机的名称，一台主机表示了完全限定的域名或IP地址，默认为localhost，同时也是唯一的host，进入tomcat的所有http请求都会映射到该主机上<br><strong>appBase：</strong>		web应用程序目录的路径，可以是CATALINA_HOME的相对路径，也可以写成绝对路径，默认情况下为$CATALINA_HOME&#x2F;webapps<br><strong>unpackWARs：</strong>	表示是否自动解压war包<br><strong>autoDeploy：</strong>	所谓的热部署，即在tomcat正在运行的情况下，如果有新的war加入，则会立即执行部署操作<br><strong>deployOnStartup：</strong>	表示tomcat启动时是否自动部署appBase目录下所有的Web应用程序，默认为true。这个属性和autoDeploy会产生两次部署的“副作用”：一次是tomcat启动时就开始部署，第二次就是autoDeploy引起的热部署。因此最好将autoDeploy置为false</p>
<p>修改第125-127行虚拟主机配置 (三个tomcat参考以下内容依次修改)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;Host name=&quot;c.com&quot;  appBase=&quot;/data/tomcat/c.com/&quot;</span><br><span class="line">            unpackWARs=&quot;true&quot; autoDeploy=&quot;false&quot;&gt;</span><br><span class="line">&lt;Context path=&quot;/hello&quot; docBase=&quot;/data/tomcat/c.com/hello.war&quot; /&gt;</span><br></pre></td></tr></table></figure>

<h1 id="启动-amp-关闭脚本"><a href="#启动-amp-关闭脚本" class="headerlink" title="启动&amp;关闭脚本"></a>启动&amp;关闭脚本</h1><p>脚本放在CATALINA_BASE(如：&#x2F;opt&#x2F;tomcat1&#x2F;)下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line"># description: 启动tomcat多实例.</span><br><span class="line">. /etc/init.d/functions</span><br><span class="line">RETVAL=$?</span><br><span class="line"># tomcat实例目录</span><br><span class="line">export CATALINA_BASE=&quot;$PWD&quot;</span><br><span class="line"># tomcat安装目录</span><br><span class="line">export CATALINA_HOME=&quot;/opt/&quot;</span><br><span class="line">case &quot;$1&quot; in</span><br><span class="line">start)</span><br><span class="line">if [ -f $CATALINA_HOME/bin/startup.sh ];then</span><br><span class="line">echo $&quot;Start Tomcat&quot;</span><br><span class="line">$CATALINA_HOME/bin/startup.sh</span><br><span class="line">fi</span><br><span class="line">;;</span><br><span class="line">stop)</span><br><span class="line">if [ -f $CATALINA_HOME/bin/shutdown.sh ];then</span><br><span class="line">echo $&quot;Stop Tomcat&quot;</span><br><span class="line">$CATALINA_HOME/bin/shutdown.sh</span><br><span class="line">fi</span><br><span class="line">;;</span><br><span class="line">*)</span><br><span class="line">echo $&quot;Usage: $0 &#123;start|stop&#125;&quot;</span><br><span class="line">exit 1</span><br><span class="line">;;</span><br><span class="line">esac</span><br><span class="line">exit $RETVAL</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>因为启动脚本中有获取当前路径的操作，一定需要cd到tomcat.sh的当前目录下执行才可以</strong></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cd /opt/tomcat1</span><br><span class="line">./tomcat.sh start|stop</span><br><span class="line">cd /opt/tomcat2</span><br><span class="line">./tomcat.sh start|stop</span><br><span class="line">cd /opt/tomcat3</span><br><span class="line">./tomcat.sh start|stop</span><br></pre></td></tr></table></figure>

<p>访问8080,8081,8082端口验证</p>
<p>参考地址：<br><a href="http://www.jianshu.com/p/0b549d00ecc2">http://www.jianshu.com/p/0b549d00ecc2</a><br><a href="http://www.ttlsa.com/tomcat/config-multi-tomcat-instance/">http://www.ttlsa.com/tomcat/config-multi-tomcat-instance/</a></p>
]]></content>
      <categories>
        <category>服务器搭建</category>
      </categories>
      <tags>
        <tag>Tomcat</tag>
      </tags>
  </entry>
  <entry>
    <title>WRF模型学习（1）--安装篇</title>
    <url>/arlo/7943f5da/</url>
    <content><![CDATA[<h1 id="WRF简介"><a href="#WRF简介" class="headerlink" title="WRF简介"></a>WRF简介</h1><p>WRF全称Weather Research and Forecasting Model, 是一个先进的大气建模系统，专为气象研究和数值天气预报而设计。它为大气过程提供了许多选项，可以在各种计算平台上运行。WRF在数千米到数千公里范围内的应用范围广泛，包括以下内容。</p>
<ul>
<li>气象研究</li>
<li>实时NWP </li>
<li>理想模拟</li>
<li>数据同化</li>
<li>地球系统模型耦合</li>
<li>示范训练和教育支持</li>
</ul>
<p>官方网站：<br><a href="http://www.wrf-model.org/index.php">http://www.wrf-model.org/index.php</a><br><a href="https://www2.ucar.edu/">https://www2.ucar.edu/</a><br><a href="https://zh.wikipedia.org/wiki/NetCDF">https://zh.wikipedia.org/wiki/NetCDF</a></p>
<span id="more"></span>
<h1 id="系统环境"><a href="#系统环境" class="headerlink" title="系统环境"></a>系统环境</h1><p>VMware Wrokstation 12 pro<br>CentOS 6.4 x64</p>
<h1 id="软件环境"><a href="#软件环境" class="headerlink" title="软件环境"></a>软件环境</h1><p>zlib-1.2.11.tar.gz<br>hdf5-1.8.18.tar<br>netcdf-4.4.1.1.tar.gz<br>netcdf-fortran-4.4.4.tar.gz<br>pgilinux-2016-1610-x86_64.tar.gz<br>WRFV3.8.1.TAR.gz<br>WPSV3.8.1.TAR.gz</p>
<h1 id="WRF-模型安装"><a href="#WRF-模型安装" class="headerlink" title="WRF 模型安装"></a>WRF 模型安装</h1><p>安装WRF模型的的顺序为：WRF–&gt;WPS–&gt;WRF-chem等<br>WRF模拟系统主要包含WPS和WRF两部分模块： WPS模块全称为WRF Pre-processing System，即WRF预处理系统，用来为WRF模型准备输入数据；如果只是做理想实验(idealized modeling)，就不需要用WPS处理真实数据。<br>WRF模块就是数值求解的模块，它有两个版本：ARW(Advanced Research WRF) 和 NMM(Nonhydrostatic Mesoscale Model)。大多数研究者主要用的都是ARW版本。 除了WPS与WRF两大核心模块外，WRF系统还有很多附加模块：比如用于数据同化的WRF-DA，用于化学传输的WRF-chem，用于林火模拟的WRF-fire。</p>
<h1 id="安装依赖zlib"><a href="#安装依赖zlib" class="headerlink" title="安装依赖zlib"></a>安装依赖zlib</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># tar xf zlib-1.2.11.tar.gz</span><br><span class="line"># cd zlib-1.2.11</span><br><span class="line"># ./configure --prefix=/usr/local/zlib/</span><br><span class="line"># make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<h1 id="安装依赖hdf5"><a href="#安装依赖hdf5" class="headerlink" title="安装依赖hdf5"></a>安装依赖hdf5</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># tar xf hdf5-1.8.18.tar</span><br><span class="line"># cd hdf5-1.8.18</span><br><span class="line">#./configure --prefix=/usr/local/hdf5/ --with-zlib=/usr/local/zlib/</span><br><span class="line"># make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<h1 id="安装依赖netcdf"><a href="#安装依赖netcdf" class="headerlink" title="安装依赖netcdf"></a>安装依赖netcdf</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># tar xf netcdf-4.4.1.1.tar.gz</span><br><span class="line"># cd netcdf-4.4.1.1</span><br><span class="line"># ./configure --prefix=/usr/local/netcdf/ --enable-netcdf-4 LDFLAGS=&quot;-L/usr/local/hdf5/lib/&quot; CPPFLAGS=&quot;-I/usr/local/hdf5/include/&quot;</span><br><span class="line"># make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<h1 id="安装依赖netcdf-fortran"><a href="#安装依赖netcdf-fortran" class="headerlink" title="安装依赖netcdf-fortran"></a>安装依赖netcdf-fortran</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># tar xf netcdf-fortran-4.4.4.tar.gz </span><br><span class="line"># cd netcdf-fortran-4.4.4</span><br><span class="line"># ./configure --prefix=/usr/local/netcdf/ LDFLAGS=&quot;-L/usr/local/netcdf/lib&quot; CPPFLAGS=&quot;-I/usr/local/netcdf/include&quot; FC=gfortran</span><br><span class="line"># make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<p>此步骤中报错可以查看日志文件config.log 进行解决<br>我遇到的问题configure: error: cannot compute sizeof (off_t)，最终是设置了环境变量解决的</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">export LDFLAGS=&quot;-L/usr/local/netcdf/lib/&quot;</span><br><span class="line">export CPPFLAGS=&quot;-I/usr/local/netcdf/include/&quot;</span><br><span class="line">export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/netcdf/lib/</span><br></pre></td></tr></table></figure>
<h1 id="安装WRF模型"><a href="#安装WRF模型" class="headerlink" title="安装WRF模型"></a>安装WRF模型</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># tar xf WRFV3.8.1.TAR.gz </span><br><span class="line"># cd WRFV3</span><br><span class="line"># export NETCDF=/usr/local/netcdf/</span><br><span class="line"># ./configure</span><br></pre></td></tr></table></figure>
<p>这里我选择的32，使用gfortran&#x2F;gcc编译。<br><img src="/images/2017/0406/01.png" alt="插入图片01"><br><strong>serial</strong> 表示串行计算；<br><strong>smpar</strong> 表示内存共享并行计算(shared memory option)，即使用openMP，大部分多核电脑都支持这项功能；<br><strong>dmpar</strong> 表示分布式并行计算(distributed memory option)，即使用MPI 进行并行计算，主要用在计算集群，单个电脑就没必要用了；<br><strong>dm+sm</strong> 表示同时使用openMP与MPI两种并行方式.</p>
<p>如果使用pgi（选择1）编译的话，需要自行安装pgilinux包，否则会报错”pgf90: Command not found.”</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># ./compile em_real &gt;&amp; compile.log</span><br></pre></td></tr></table></figure>
<p>编译类型有以下几种<br>WRF-Chem（WRF大气化学模型）<br>em_real （3D真实情况）<br>em_quarter_ss （3D理想的情况下）<br>em_b_wave （3D理想的情况下）<br>em_les （3D理想的情况下）<br>em_heldsuarez （3D理想的情况下）<br>em_tropical_cyclone （3D理想的情况下）<br>em_hill2d_x （2D理想的情况下）<br>em_squall2d_x （2D理想的情况下）<br>em_squall2d_y （ 2d理想情况）<br>em_grav2d_x （2d理想情况）<br>em_seabreeze2d_x （2d理想情况）<br>em_scm_xy （1d理想情况）</p>
<p>真实情况编译完成后，在main目录下会出现ndown.exe,real.exe, tc.exe, wrf.exe这4个可执行程序；理想情况编译后会生成wrf.exe，ideal.exe 这2个可执行程序。</p>
<h1 id="安装WPS模型"><a href="#安装WPS模型" class="headerlink" title="安装WPS模型"></a>安装WPS模型</h1><p>要保证WPS和WRFV3在同级目录，configure.wps文件中有相对路径<br>安装依赖包 </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># yum -y install libpng libpng-devel jasper jasper-devel libjpeg libjpeg-devel</span><br><span class="line"># export COMPRESSION_LIBS=-L/usr/lib64/</span><br><span class="line"># export COMPRESSION_INC=-I/usr/lib64/</span><br><span class="line"># tar xf WPSV3.8.1.TAR.gz</span><br><span class="line"># cd WPS</span><br><span class="line"># ./configure</span><br></pre></td></tr></table></figure>
<p><img src="/images/2017/0406/02.png" alt="插入图片02"><br>这里选择1即可</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># ./compile</span><br></pre></td></tr></table></figure>
<p>编译完成后再当前目录下会出现geogrid.exe、metgrid.exe、ungrib.exe 三个可执行程序<br><img src="/images/2017/0406/03.png" alt="插入图片03"><br>到这里WRF模型的安装工作就已经完成了，第一次安装，记录一下!</p>
<p>参考链接：<br><a href="https://xg1990.com/blog/archives/190">https://xg1990.com/blog/archives/190</a><br><a href="http://www2.mmm.ucar.edu/wrf/OnLineTutorial/compilation_tutorial.php">http://www2.mmm.ucar.edu/wrf/OnLineTutorial/compilation_tutorial.php</a></p>
]]></content>
      <categories>
        <category>大气模型</category>
      </categories>
      <tags>
        <tag>WRF</tag>
      </tags>
  </entry>
  <entry>
    <title>Win10无法正常连接sslvpn</title>
    <url>/arlo/e72ff5d/</url>
    <content><![CDATA[<h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><p>Dell燃7000<br>Win 10 64bit<br>Hangzhou DPtech Co.,Ltd. SSL VPN</p>
<h1 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h1><p>1、无法创建虚拟网卡<br>2、使用vpn自带的修复工具后驱动不对，“Windows 无法验证此设备所需的驱动程序的数字签名。该值受安全引导策略保护，无法进行修改或删除”</p>
<h1 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h1><p>1、重新笔记本<br>2、进入BIOS-Secure Boot，取消Windows UEFI模式<br>3、删除Secure Key(可以备份一下，我没备份，删除后暂时未发现异常)<br>4、重启后秒拨<br>参考：<a href="http://www.cnblogs.com/easyc/p/6132581.html">http://www.cnblogs.com/easyc/p/6132581.html</a></p>
]]></content>
      <categories>
        <category>Troubleshooting</category>
      </categories>
      <tags>
        <tag>Windows</tag>
        <tag>vpn</tag>
      </tags>
  </entry>
  <entry>
    <title>Windows 下使用expdp自动备份多用户oracle脚本</title>
    <url>/arlo/85974653/</url>
    <content><![CDATA[<p>Windows下多Oracle实例，根据用户自动备份</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@echo off   </span><br><span class="line">echo ================================================   </span><br><span class="line">echo  Windows环境下Oracle数据库的自动备份脚本  </span><br><span class="line">echo  1. 使用当前日期命名备份文件。  </span><br><span class="line">echo  2. 自动删除30天前的备份。  </span><br><span class="line">echo ================================================  </span><br><span class="line">::以“YYYYMMDD”格式取出当前时间。  </span><br><span class="line">set BACKUPDATE=%date:~0,4%%date:~5,2%%date:~8,2%  </span><br><span class="line">set DATADIR=E:\database_backup\%BACKUPDATE%</span><br><span class="line">echo 本次备份目录是%DATADIR%</span><br><span class="line">echo ================================================ </span><br><span class="line">echo 开始备份数据库</span><br><span class="line">for %%u in (AIR_FORECAST,ALK,AIR_FZ,TSUBJECT,TMAIN,TCODE,AIR_YBYJ,AIR_FXPT,INVENTORY,TENV,NEWMBGL) do expdp userid=&#x27;sys/密码@实例 as sysdba&#x27; schemas=%%u directory=DATA_PUMP_DIR dumpfile=%%u.dmp</span><br><span class="line">echo 移动文件到数据库备份目录</span><br><span class="line">if not exist &quot;E:\database_backup\%BACKUPDATE%&quot; mkdir E:\database_backup\%BACKUPDATE%  </span><br><span class="line">MOVE /Y E:\app\Administrator\admin\SX21\dpdump\* E:\database_backup\%BACKUPDATE%</span><br><span class="line">::删除30天前的备份</span><br><span class="line">forfiles /p E:\database_backup\  /m 201* /d -30 /c &quot;cmd /c if @isdir==TRUE (rmdir /q /s @path) else (del /f @path)&quot;  </span><br><span class="line">exit</span><br></pre></td></tr></table></figure>


<p>参考：<br><a href="http://www.cnblogs.com/peterpanzsy/p/3442784.html">http://www.cnblogs.com/peterpanzsy/p/3442784.html</a><br><a href="http://blog.csdn.net/smasegain/article/details/46759267">http://blog.csdn.net/smasegain/article/details/46759267</a></p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>Windows</tag>
        <tag>Oracle</tag>
        <tag>数据库</tag>
      </tags>
  </entry>
  <entry>
    <title>WindowsUpdate不能更新，错误提示8024402F解决方法</title>
    <url>/arlo/e0a98909/</url>
    <content><![CDATA[<p>Windows系统下WindowsUpdate不能更新了，显示的是8024402F错误。<br>微软上看到了解决方法：使用以下DNS服务：<br>首选DNS服务器：<code>4.2.2.1</code><br>备用DNS服务器：<code>4.2.2.2</code><br>使用以后马上见效果。</p>
]]></content>
      <categories>
        <category>Troubleshooting</category>
      </categories>
      <tags>
        <tag>Windows</tag>
        <tag>更新</tag>
      </tags>
  </entry>
  <entry>
    <title>Windows组策略几个问题小计</title>
    <url>/arlo/9bdfcc8c/</url>
    <content><![CDATA[<h1 id="桌面没有“计算机”"><a href="#桌面没有“计算机”" class="headerlink" title="桌面没有“计算机”"></a>桌面没有“计算机”</h1><p>开始-运行-输入以下内容</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rundll32.exe shell32.dll,Control_RunDLL desk.cpl,,0</span><br></pre></td></tr></table></figure>
<h1 id="注册表编辑被管理员禁用"><a href="#注册表编辑被管理员禁用" class="headerlink" title="注册表编辑被管理员禁用"></a>注册表编辑被管理员禁用</h1><p><img src="/images/2017/1031/01.png" alt="windows"><br>第一步：打开组策略窗口，开始-运行-gptdit.msc<br>第二步：选择用户配置-管理模板-系统，双击系统选项找到【阻止访问注册表编辑工具】<br>第三步：双击【阻止访问注册表编辑工具】选择已禁用，点击确定。<br>第四步：在开始-运行输入regedit，打开注册表。 说明注册表已经可以访问了。</p>
<span id="more"></span>
<h1 id="服务灰色，无法正常使用"><a href="#服务灰色，无法正常使用" class="headerlink" title="服务灰色，无法正常使用"></a>服务灰色，无法正常使用</h1><p>MMC 在该文档中引用的管理单元受到策略限制<br><img src="/images/2017/1031/02.png" alt="windows"><br><img src="/images/2017/1031/03.png" alt="windows"><br>第一步：开始-运行-regedit，启动注册表编辑器<br>第二步：HKEY_CURRENT_USER\Software\Policies\Microsoft\MMC{58221C66-EA27-11CF-ADCF-00AA00A80033}\Restrict_Run，将值设为0<br><img src="/images/2017/1031/04.png" alt="windows"></p>
<h1 id="任务管理器无法正常使用"><a href="#任务管理器无法正常使用" class="headerlink" title="任务管理器无法正常使用"></a>任务管理器无法正常使用</h1><p><img src="/images/2017/1031/05.png" alt="windows"><br>第一步：打开组策略窗口，开始-运行-gptdit.msc<br>第二步：选择用户配置-管理模板-系统-Ctrl+Alt+Del选项<br>第三步：在该列表中打开 删除“任务管理器” 的属性，在 删除“任务管理器” 属性中的“设置”选项卡中点选“已禁用”，确定。<br><img src="/images/2017/1031/06.png" alt="windows"></p>
<h1 id="要远程登录，你需要具有通过远程桌面服务进行的登录权限"><a href="#要远程登录，你需要具有通过远程桌面服务进行的登录权限" class="headerlink" title="要远程登录，你需要具有通过远程桌面服务进行的登录权限"></a>要远程登录，你需要具有通过远程桌面服务进行的登录权限</h1><p><img src="/images/2017/1031/07.png" alt="windows"><br>要远程登录，你需要具有通过远程桌面服务进行的登录权限。默认情况下，远程桌面用户组的成员有这项权限。如果你所属的组没有这项权限，或者远程桌面用户组已经删除了这项权限，那么需要手动为你授予这一权限<br>第一步：gpedit进入策略组:计算机配置-&gt;Windows设置-&gt;安全设置-&gt;本地策略-&gt;用户权限分配<br>第二步：找到拒绝通过远程桌面服务登录,把里面的账号去了即可</p>
<h1 id="修改远程登录3389端口"><a href="#修改远程登录3389端口" class="headerlink" title="修改远程登录3389端口"></a>修改远程登录3389端口</h1><p>第一步: 打开“开始→运行”，输入“regedit”，打开注册表，<br>第二步: 进入[HKEY_LOCAL_MACHINE&#x2F;SYSTEM&#x2F;CurrentControlSet&#x2F;Control&#x2F;Terminal Server&#x2F;Wds&#x2F;rdpwd&#x2F;Tds&#x2F;tcp]，将PortNamber值(默认值是3389)，修改为新的端口，例如12389，注意使用十进制。<br>第三部：进入[HKEY_LOCAL_MACHINE&#x2F;SYSTEM&#x2F;CurrentControlSet&#x2F;Control&#x2F;Terminal Server&#x2F;WinStations&#x2F;RDP-Tcp]，将PortNumber值(默认是3389)修改为新的端口，如12389，注意使用十进制。</p>
<h1 id="修改远程桌面最大连接数"><a href="#修改远程桌面最大连接数" class="headerlink" title="修改远程桌面最大连接数"></a>修改远程桌面最大连接数</h1><p>第一步: 打开组策略设置gpedit.msc–&gt;计算机配置–&gt;管理模板–&gt;Windows 组件–&gt;远程桌面服务–&gt;远程桌面会话主机–&gt;连接–&gt;限制连接数量<br>第二步: 打开组策略设置gpedit.msc–&gt;计算机配置–&gt;管理模板–&gt;Windows 组件–&gt;远程桌面服务–&gt;远程桌面会话主机–&gt;连接–&gt;将远程桌面服务用户限制到单独的远程桌面服务会话(已禁用)</p>
<h1 id="Win10家庭版找不到gpedit-msc组策略"><a href="#Win10家庭版找不到gpedit-msc组策略" class="headerlink" title="Win10家庭版找不到gpedit.msc组策略"></a>Win10家庭版找不到gpedit.msc组策略</h1><p>复制一下内容，新建一个.bat文件，然后使用管理员身份运行</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@echo off</span><br><span class="line"></span><br><span class="line">pushd &quot;%~dp0&quot;</span><br><span class="line"></span><br><span class="line">dir /b C:\Windows\servicing\Packages\Microsoft-Windows-GroupPolicy-ClientExtensions-Package~3*.mum &gt;List.txt</span><br><span class="line"></span><br><span class="line">dir /b C:\Windows\servicing\Packages\Microsoft-Windows-GroupPolicy-ClientTools-Package~3*.mum &gt;&gt;List.txt</span><br><span class="line"></span><br><span class="line">for /f %%i in (&#x27;findstr /i . List.txt 2^&gt;nul&#x27;) do dism /online /norestart /add-package:&quot;C:\Windows\servicing\Packages\%%i&quot;</span><br><span class="line"></span><br><span class="line">pause</span><br></pre></td></tr></table></figure>
<h1 id="出现身份验证错误，要求的函数不受支持"><a href="#出现身份验证错误，要求的函数不受支持" class="headerlink" title="出现身份验证错误，要求的函数不受支持"></a>出现身份验证错误，要求的函数不受支持</h1><p>在本地计算机上操作，非远程计算机！！！</p>
<h2 id="修改组策略解决"><a href="#修改组策略解决" class="headerlink" title="修改组策略解决"></a>修改组策略解决</h2><p><img src="/images/2017/1031/08.png" alt="windows"><br>此错误原因是检查更新了KB4103718的补丁造成的。</p>
<p>使用微软官方建议修改本地组策略：</p>
<ol>
<li>开始运行输入gpedit.msc</li>
<li>计算机配置&gt;管理模板&gt;系统&gt;凭据分配&gt;加密Oracle修正 选择启用并选择易受攻击。</li>
<li>易受攻击– 使用 CredSSP 的客户端应用程序将通过支持回退到不安全的版本使远程服务器遭受攻击，但使用 CredSSP 的服务将接受未修补的客户端。</li>
</ol>
<p><img src="/images/2017/1031/09.png" alt="windows"><br>PS:该操作仅用于专业版，如果是家庭版请考虑升级(本人是家庭版，在X宝上买的key升级为专业版了);<br>或者卸载KB4103718补丁重启。</p>
<h2 id="修改注册表解决"><a href="#修改注册表解决" class="headerlink" title="修改注册表解决"></a>修改注册表解决</h2><p>Windows10家庭版的用户，因为系统中没有组策略编辑器，需要修改注册表来实现。<br>0. 开始-运行-输入 “regedit”</p>
<ol>
<li>找到注册表路径：HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System\CredSSP\Parameters  </li>
<li>一般系统下，大概到了System后面再没有后面的路径，需要自行手动新建\CredSSP\Parameters </li>
<li>先新建项“CredSSP”，然后在CredSSP下新建项“Parameters” </li>
<li>然后在“Parameters”下新建DWORD(32位)，名称为“AllowEncryptionOracle”，设置值为“2”。 </li>
<li>然后进行尝试，如果不行，请重启一下自己的计算机。</li>
</ol>
<h1 id="发生身份验证错误。给函数提供的标志无效"><a href="#发生身份验证错误。给函数提供的标志无效" class="headerlink" title="发生身份验证错误。给函数提供的标志无效"></a>发生身份验证错误。给函数提供的标志无效</h1><p>由于微软于2018年3月发布了一个安全更新，此更新通过更正凭据安全支持提供程序协议（CredSSP），以及在身份验证过程中验证请求的方式，修复 CredSSP 存在的远程执行代码漏洞。客户端和服务器都需要安装此更新，否则可能出现问题描述中的情况</p>
<p><strong>解决方法</strong></p>
<p>安装安全更新，可更新未修补的客户端&#x2F;服务器端。不同系统对应的更新情况可参见 <a href="https://portal.msrc.microsoft.com/zh-cn/security-guidance/advisory/CVE-2018-0886">CVE-2018-0886 |CredSSP 远程执行代码漏洞</a>。</p>
<p>如果服务器可以连接互联网，直接升级安装更新补丁即可，如不能连接互联网，以windows 2016为例，下载该补丁，安装后重启即可。（ps：ipmi真是个好东西~）</p>
<p><a href="http://download.windowsupdate.com/d/msdownload/update/software/secu/2018/05/windows10.0-kb4103723-x64_2adf2ea2d09b3052d241c40ba55e89741121e07e.msu">http://download.windowsupdate.com/d/msdownload/update/software/secu/2018/05/windows10.0-kb4103723-x64_2adf2ea2d09b3052d241c40ba55e89741121e07e.msu</a></p>
<h1 id="Windows远程桌面密码不能保存"><a href="#Windows远程桌面密码不能保存" class="headerlink" title="Windows远程桌面密码不能保存"></a>Windows远程桌面密码不能保存</h1><ol>
<li>打开组策略设置gpedit.msc </li>
<li>计算机配置 &gt;&gt; 管理模板 &gt;&gt; 系统 &gt;&gt; 凭据分配 下面的 “允许分配保存的凭据用于仅NTLM服务器身份验证”</li>
<li>选择已启用，点击显示将TERMSRV&#x2F;*添加到列表中</li>
</ol>
<h1 id="没有远程桌面授权服务器可以提供许可证，远程会话被中断"><a href="#没有远程桌面授权服务器可以提供许可证，远程会话被中断" class="headerlink" title="没有远程桌面授权服务器可以提供许可证，远程会话被中断"></a>没有远程桌面授权服务器可以提供许可证，远程会话被中断</h1><ol start="0">
<li>开始-运行-输入 “regedit”</li>
<li>找到注册表路径：HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\RCM\GracePeriod</li>
<li>删除右侧子项，如下图所示；如果删除报错，请修改GracePeriod权限，增加administrator的权限（可用120天）<br><img src="/images/2017/1031/10.png" alt="windows"></li>
</ol>
<h1 id="修复图片查看器"><a href="#修复图片查看器" class="headerlink" title="修复图片查看器"></a>修复图片查看器</h1><p>复制以下内容，新建.reg文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Windows Registry Editor Version 5.00</span><br><span class="line"></span><br><span class="line"> ; Change Extension&#x27;s File Type</span><br><span class="line"></span><br><span class="line"> [HKEY_CURRENT_USER\Software\Classes\.jpg]</span><br><span class="line"></span><br><span class="line"> @=&quot;PhotoViewer.FileAssoc.Tiff&quot;</span><br><span class="line"></span><br><span class="line"> ; Change Extension&#x27;s File Type</span><br><span class="line"></span><br><span class="line"> [HKEY_CURRENT_USER\Software\Classes\.jpeg]</span><br><span class="line"></span><br><span class="line"> @=&quot;PhotoViewer.FileAssoc.Tiff&quot;</span><br><span class="line"></span><br><span class="line"> ; Change Extension&#x27;s File Type</span><br><span class="line"></span><br><span class="line"> [HKEY_CURRENT_USER\Software\Classes\.gif]</span><br><span class="line"></span><br><span class="line"> @=&quot;PhotoViewer.FileAssoc.Tiff&quot;</span><br><span class="line"></span><br><span class="line"> ; Change Extension&#x27;s File Type</span><br><span class="line"></span><br><span class="line"> [HKEY_CURRENT_USER\Software\Classes\.png]</span><br><span class="line"></span><br><span class="line"> @=&quot;PhotoViewer.FileAssoc.Tiff&quot;</span><br><span class="line"></span><br><span class="line"> ; Change Extension&#x27;s File Type</span><br><span class="line"></span><br><span class="line"> [HKEY_CURRENT_USER\Software\Classes\.bmp]</span><br><span class="line"></span><br><span class="line"> @=&quot;PhotoViewer.FileAssoc.Tiff&quot;</span><br><span class="line"></span><br><span class="line"> ; Change Extension&#x27;s File Type</span><br><span class="line"></span><br><span class="line"> [HKEY_CURRENT_USER\Software\Classes\.tiff]</span><br><span class="line"></span><br><span class="line"> @=&quot;PhotoViewer.FileAssoc.Tiff&quot;</span><br><span class="line"></span><br><span class="line"> ; Change Extension&#x27;s File Type</span><br><span class="line"></span><br><span class="line"> [HKEY_CURRENT_USER\Software\Classes\.ico]</span><br><span class="line"></span><br><span class="line"> @=&quot;PhotoViewer.FileAssoc.Tiff&quot;</span><br></pre></td></tr></table></figure>
<h1 id="Win10新建文件不自动刷新"><a href="#Win10新建文件不自动刷新" class="headerlink" title="Win10新建文件不自动刷新"></a>Win10新建文件不自动刷新</h1><p>开始运行cmd窗口运行</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ie4uinit -show</span><br></pre></td></tr></table></figure>

<p>参考地址：<br><a href="http://ytweb.blog.51cto.com/5865824/1177266">http://ytweb.blog.51cto.com/5865824/1177266</a><br><a href="https://jingyan.baidu.com/article/3a2f7c2e6ab84626afd61114.html">https://jingyan.baidu.com/article/3a2f7c2e6ab84626afd61114.html</a><br><a href="http://blog.sina.com.cn/s/blog_4298a2c80102vii4.html">http://blog.sina.com.cn/s/blog_4298a2c80102vii4.html</a><br><a href="http://www.cnblogs.com/q149072205/p/6097433.html">http://www.cnblogs.com/q149072205/p/6097433.html</a><br><a href="http://blog.csdn.net/flyingdream123/article/details/50724107">http://blog.csdn.net/flyingdream123/article/details/50724107</a><br><a href="http://www.soncs.com/NewsShow/144.html">http://www.soncs.com/NewsShow/144.html</a></p>
]]></content>
      <categories>
        <category>Troubleshooting</category>
      </categories>
      <tags>
        <tag>Windows</tag>
        <tag>组策略</tag>
      </tags>
  </entry>
  <entry>
    <title>Zabbix(1)监控搭建</title>
    <url>/arlo/3b5e53af/</url>
    <content><![CDATA[<p>Zabbix是一款能够监控各种网络参数以及服务器健康性、完整性的分布式监控软件；</p>
<span id="more"></span>
<p><strong>系统环境</strong><br>Centos	7.3.1611<br>Selinux	off<br>Iptables	off<br>Firewalld	off<br><strong>软件环境</strong><br>Zabbix	3.4.2<br>Httpd	2.4.6<br>Php	5.4.16<br>MariaDB	10.2.7</p>
<h1 id="使用部署包安装zabbix"><a href="#使用部署包安装zabbix" class="headerlink" title="使用部署包安装zabbix"></a>使用部署包安装zabbix</h1><h2 id="安装zabbix-server"><a href="#安装zabbix-server" class="headerlink" title="安装zabbix server"></a>安装zabbix server</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rpm -ivh http://repo.zabbix.com/zabbix/3.4/rhel/7/x86_64/zabbix-release-3.4-2.el7.noarch.rpm</span><br><span class="line">yum install zabbix-server-mysql zabbix-web-mysql</span><br></pre></td></tr></table></figure>
<h2 id="配置数据库"><a href="#配置数据库" class="headerlink" title="配置数据库"></a>配置数据库</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/yum.repos.d/MariaDB.repo</span><br><span class="line">[mariadb]</span><br><span class="line">name = MariaDB</span><br><span class="line">baseurl = http://yum.mariadb.org/10.3/centos7-amd64</span><br><span class="line">gpgkey=https://yum.mariadb.org/RPM-GPG-KEY-MariaDB</span><br><span class="line">gpgcheck=1</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum install MariaDB-server MariaDB-client</span><br><span class="line">cp /usr/share/mysql/my-medium.cnf /etc/my.cnf</span><br><span class="line">systemctl start mariadb.service</span><br><span class="line">systemctl enable mariadb.service</span><br><span class="line">mysql_secure_installation</span><br><span class="line">#初始化数据库，设置root密码</span><br><span class="line">mysql -uroot -p&lt;password&gt;</span><br><span class="line">mysql&gt; create database zabbix character set utf8 collate utf8_bin;</span><br><span class="line">mysql&gt; grant all privileges on zabbix.* to zabbix@localhost identified by &#x27;&lt;password&gt;&#x27;;</span><br><span class="line">mysql&gt; quit;</span><br><span class="line">cd /usr/share/doc/zabbix-server-mysql-3.4.2</span><br><span class="line">zcat create.sql.gz | mysql -uroot zabbix -p</span><br></pre></td></tr></table></figure>
<h2 id="配置zabbix-server-conf参数"><a href="#配置zabbix-server-conf参数" class="headerlink" title="配置zabbix_server.conf参数"></a>配置zabbix_server.conf参数</h2><p>vim &#x2F;etc&#x2F;zabbix&#x2F;zabbix_server.conf</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">DBHost=localhost</span><br><span class="line">DBName=zabbix</span><br><span class="line">DBUser=zabbix</span><br><span class="line">DBPassword=zabbix</span><br></pre></td></tr></table></figure>
<h2 id="启动Zabbix-Server"><a href="#启动Zabbix-Server" class="headerlink" title="启动Zabbix Server"></a>启动Zabbix Server</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl start zabbix-server</span><br><span class="line">systemctl enable zabbix-server</span><br></pre></td></tr></table></figure>
<h2 id="编辑Zabbix前端的PHP配置"><a href="#编辑Zabbix前端的PHP配置" class="headerlink" title="编辑Zabbix前端的PHP配置"></a>编辑Zabbix前端的PHP配置</h2><p>Zabbix前端的Apache配置文件位于 &#x2F;etc&#x2F;httpd&#x2F;conf.d&#x2F;zabbix.conf 。一些PHP设置已经完成了配置。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">php_value max_execution_time 300</span><br><span class="line">php_value memory_limit 128M</span><br><span class="line">php_value post_max_size 16M</span><br><span class="line">php_value upload_max_filesize 2M</span><br><span class="line">php_value max_input_time 300</span><br><span class="line">php_value always_populate_raw_post_data -1</span><br><span class="line">php_value date.timezone Asia/Shanghai</span><br></pre></td></tr></table></figure>
<h2 id="启动httpd"><a href="#启动httpd" class="headerlink" title="启动httpd"></a>启动httpd</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl start httpd</span><br><span class="line">systemctl enable httpd</span><br></pre></td></tr></table></figure>
<h1 id="配置zabbix前端"><a href="#配置zabbix前端" class="headerlink" title="配置zabbix前端"></a>配置zabbix前端</h1><h2 id="在浏览器中配置zabbix"><a href="#在浏览器中配置zabbix" class="headerlink" title="在浏览器中配置zabbix"></a>在浏览器中配置zabbix</h2><p>Zabbix前端可以在浏览器中通过 <a href="http://zabbixserver/zabbix">http://zabbixserver/zabbix</a> 进行访问。<br><img src="/images/2017/0929/01.png" alt="zabbix_install"></p>
<h3 id="确认所有php参数都设置ok"><a href="#确认所有php参数都设置ok" class="headerlink" title="确认所有php参数都设置ok"></a>确认所有php参数都设置ok</h3><p><img src="/images/2017/0929/02.png" alt="zabbix_install"></p>
<h3 id="填写mysql数据库信息，用户名密码"><a href="#填写mysql数据库信息，用户名密码" class="headerlink" title="填写mysql数据库信息，用户名密码"></a>填写mysql数据库信息，用户名密码</h3><p><img src="/images/2017/0929/03.png" alt="zabbix_install"><br><img src="/images/2017/0929/04.png" alt="zabbix_install"></p>
<h3 id="确认所有配置信息正确"><a href="#确认所有配置信息正确" class="headerlink" title="确认所有配置信息正确"></a>确认所有配置信息正确</h3><p><img src="/images/2017/0929/05.png" alt="zabbix_install"><br><img src="/images/2017/0929/06.png" alt="zabbix_install"></p>
<h3 id="默认的用户名／密码为-Admin-x2F-zabbix"><a href="#默认的用户名／密码为-Admin-x2F-zabbix" class="headerlink" title="默认的用户名／密码为 Admin&#x2F;zabbix"></a>默认的用户名／密码为 Admin&#x2F;zabbix</h3><p><img src="/images/2017/0929/07.png" alt="zabbix_install"><br><img src="/images/2017/0929/08.png" alt="zabbix_install"></p>
<h1 id="系统配置"><a href="#系统配置" class="headerlink" title="系统配置"></a>系统配置</h1><h2 id="配置中文界面"><a href="#配置中文界面" class="headerlink" title="配置中文界面"></a>配置中文界面</h2><h3 id="替换中文字体"><a href="#替换中文字体" class="headerlink" title="替换中文字体"></a>替换中文字体</h3><p>在Windows系统里找一个中文字体（华文楷体）C:\Windows\Fonts\STKAITI.TTF上传到zabbix服务器替换掉默认的字体&#x2F;usr&#x2F;share&#x2F;fonts&#x2F;dejavu&#x2F;DejaVuSans.ttf</p>
<h3 id="开启中文支持"><a href="#开启中文支持" class="headerlink" title="开启中文支持"></a>开启中文支持</h3><p>如果默认中文(zh_CN)支持被关闭，可以将zh_CN后边的false选项修改为true；</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /usr/share/zabbix/include/locales.inc.php</span><br><span class="line">function getLocales() &#123;</span><br><span class="line">        return [</span><br><span class="line">                &#x27;en_GB&#x27; =&gt; [&#x27;name&#x27; =&gt; _(&#x27;English (en_GB)&#x27;),     &#x27;display&#x27; =&gt; true],</span><br><span class="line">                &#x27;en_US&#x27; =&gt; [&#x27;name&#x27; =&gt; _(&#x27;English (en_US)&#x27;),     &#x27;display&#x27; =&gt; true],</span><br><span class="line">                &#x27;bg_BG&#x27; =&gt; [&#x27;name&#x27; =&gt; _(&#x27;Bulgarian (bg_BG)&#x27;),   &#x27;display&#x27; =&gt; false],</span><br><span class="line">                &#x27;zh_CN&#x27; =&gt; [&#x27;name&#x27; =&gt; _(&#x27;Chinese (zh_CN)&#x27;),     &#x27;display&#x27; =&gt; true],</span><br><span class="line">……</span><br></pre></td></tr></table></figure>
<h3 id="在web界面修改用户资料、语言"><a href="#在web界面修改用户资料、语言" class="headerlink" title="在web界面修改用户资料、语言"></a>在web界面修改用户资料、语言</h3><p><img src="/images/2017/0929/09.png" alt="zabbix_install"></p>
<h2 id="启用zabbix-server监控"><a href="#启用zabbix-server监控" class="headerlink" title="启用zabbix server监控"></a>启用zabbix server监控</h2><h3 id="安装zabbix-agent"><a href="#安装zabbix-agent" class="headerlink" title="安装zabbix agent"></a>安装zabbix agent</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum install zabbix-agent</span><br><span class="line">systemctl start zabbix-agent</span><br></pre></td></tr></table></figure>
<h3 id="在配置-主机中启用zabbix-server"><a href="#在配置-主机中启用zabbix-server" class="headerlink" title="在配置-主机中启用zabbix server"></a>在配置-主机中启用zabbix server</h3><p><img src="/images/2017/0929/10.png" alt="zabbix_install"></p>
<h1 id="CentOS-6-x-安装Zabbix"><a href="#CentOS-6-x-安装Zabbix" class="headerlink" title="CentOS 6.x 安装Zabbix"></a>CentOS 6.x 安装Zabbix</h1><p>CentOS 6.x 默认的php版本太低，需借助第三方源升级php;<br>建议PHP≥5.4 MySql≥5.6</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rpm -Uvh http://rpms.famillecollet.com/enterprise/remi-release-6.rpm</span><br><span class="line">yum -y install --enablerepo=remi --enablerepo=remi-php56 php php-opcache php-devel php-mbstring php-mcrypt php-mysqlnd php-phpunit-PHPUnit php-pecl-xdebug php-pecl-xhprof  php-gd php-mysql php-bcmath php-ldap</span><br><span class="line">rpm -ql zabbix-web | grep example.conf</span><br><span class="line">cp /usr/share/doc/zabbix-web-3.4.8/httpd22-example.conf /etc/httpd/conf.d/zabbix.conf</span><br></pre></td></tr></table></figure>
<p><img src="/images/2017/0929/24.png" alt="zabbix_install"><br>参考资料:<br><a href="https://www.zabbix.com/documentation/3.4/zh/manual">https://www.zabbix.com/documentation/3.4/zh/manual</a><br><a href="http://www.rfyy.net/archives/1742.html">http://www.rfyy.net/archives/1742.html</a><br><a href="https://www.zabbix.com/documentation/3.4/manual/installation/install_from_packages/rhel_centos">https://www.zabbix.com/documentation/3.4/manual/installation/install_from_packages/rhel_centos</a></p>
]]></content>
      <categories>
        <category>监控</category>
      </categories>
      <tags>
        <tag>zabbix</tag>
        <tag>监控</tag>
      </tags>
  </entry>
  <entry>
    <title>Zabbix(2)监控客户端安装</title>
    <url>/arlo/b6f2d4bf/</url>
    <content><![CDATA[<h1 id="linux-客户端安装"><a href="#linux-客户端安装" class="headerlink" title="linux 客户端安装"></a>linux 客户端安装</h1><h2 id="安装客户端软件"><a href="#安装客户端软件" class="headerlink" title="安装客户端软件"></a>安装客户端软件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rpm -ivh http://repo.zabbix.com/zabbix/3.4/rhel/7/x86_64/zabbix-release-3.4-2.el7.noarch.rpm</span><br><span class="line">yum install zabbix-agent</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<h2 id="配置连接服务器信息"><a href="#配置连接服务器信息" class="headerlink" title="配置连接服务器信息"></a>配置连接服务器信息</h2><p>vim &#x2F;etc&#x2F;zabbix&#x2F;zabbix_agentd.conf</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Server=192.168.6.103</span><br><span class="line">ServerActive=192.168.6.103</span><br><span class="line">Hostname=silu1</span><br></pre></td></tr></table></figure>
<h2 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl start zabbix-agent</span><br><span class="line">systemctl enable zabbix-agent</span><br></pre></td></tr></table></figure>
<h2 id="添加主机"><a href="#添加主机" class="headerlink" title="添加主机"></a>添加主机</h2><p><em>主机名称一定要和配置文件中的Hostname一致</em><br><img src="/images/2017/0929/11.png" alt="zabbix_install"><br><em>如果使用主动模式，这里的ip地址填写0.0.0.0</em><br><img src="/images/2017/0929/12.png" alt="zabbix_install"><br><img src="/images/2017/0929/13.png" alt="zabbix_install"></p>
<h1 id="Windows-客户端安装"><a href="#Windows-客户端安装" class="headerlink" title="Windows 客户端安装"></a>Windows 客户端安装</h1><h2 id="安装windows-客户端"><a href="#安装windows-客户端" class="headerlink" title="安装windows 客户端"></a>安装windows 客户端</h2><p>下载客户端软件 <a href="https://www.zabbix.com/downloads/3.4.0/zabbix_agents_3.4.0.win.zip">https://www.zabbix.com/downloads/3.4.0/zabbix_agents_3.4.0.win.zip</a><br>解压到C盘根目录</p>
<h2 id="配置连接服务器信息-1"><a href="#配置连接服务器信息-1" class="headerlink" title="配置连接服务器信息"></a>配置连接服务器信息</h2><p>C:\zabbix_agents_3.4.0.win\conf\zabbix_agentd.win.conf</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Server=192.168.6.103</span><br><span class="line">ServerActive=192.168.6.103</span><br><span class="line">Hostname=silu2</span><br></pre></td></tr></table></figure>
<h2 id="注册服务"><a href="#注册服务" class="headerlink" title="注册服务"></a>注册服务</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">C:\&gt;c:\zabbix_agents_3.4.0.win\bin\win64\zabbix_agentd.exe -i -c c:\zabbix_agents_3.4.0.win\conf\zabbix_agentd.win.conf</span><br></pre></td></tr></table></figure>
<h2 id="启动服务-1"><a href="#启动服务-1" class="headerlink" title="启动服务"></a>启动服务</h2><p>使用以下命令启动</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">net start &quot;Zabbix Agent&quot;</span><br></pre></td></tr></table></figure>
<p>或者在本地服务中启动<br><img src="/images/2017/0929/14.png" alt="zabbix_install"></p>
<h2 id="添加主机-1"><a href="#添加主机-1" class="headerlink" title="添加主机"></a>添加主机</h2><p>和linux方法以下，选择Windows模板即可</p>
]]></content>
      <categories>
        <category>监控</category>
      </categories>
      <tags>
        <tag>zabbix</tag>
        <tag>监控</tag>
      </tags>
  </entry>
  <entry>
    <title>Zabbix(3)邮件报警配置</title>
    <url>/arlo/3efe0c83/</url>
    <content><![CDATA[<p>报警的方式有很多，邮件，短信，微信，钉钉，最简单的方式这种脚本去发邮件，在此记录一下配置过程。</p>
<h1 id="配置邮件发送"><a href="#配置邮件发送" class="headerlink" title="配置邮件发送"></a>配置邮件发送</h1><h2 id="安装mailx"><a href="#安装mailx" class="headerlink" title="安装mailx"></a>安装mailx</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum -y install mailx</span><br></pre></td></tr></table></figure>
<p>安装好，自己就有软链接了</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm03 ~]# ls -l /usr/bin/mail</span><br><span class="line">lrwxrwxrwx 1 root root 5 May  6 02:07 /usr/bin/mail -&gt; mailx</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<h2 id="配置mailx"><a href="#配置mailx" class="headerlink" title="配置mailx"></a>配置mailx</h2><p><code>vim /etc/mail.rc</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">set from=user@aliyun.com</span><br><span class="line">set smtp=smtp.aliyun.com</span><br><span class="line">set smtp-auth-user=user@aliyun.com</span><br><span class="line">set smtp-auth-password=&#x27;&lt;password&gt;&#x27;</span><br><span class="line">set smtp-auth=login</span><br></pre></td></tr></table></figure>
<h2 id="发送一封测试邮件"><a href="#发送一封测试邮件" class="headerlink" title="发送一封测试邮件"></a>发送一封测试邮件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">echo &#x27;test&#x27; |mailx -s &#x27;abc&#x27; abc@qq.com</span><br></pre></td></tr></table></figure>
<h2 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/zabbix/zabbix_server.conf</span><br><span class="line">AlertScriptsPath=/usr/lib/zabbix/alertscripts</span><br></pre></td></tr></table></figure>
<h2 id="发送邮件脚本"><a href="#发送邮件脚本" class="headerlink" title="发送邮件脚本"></a>发送邮件脚本</h2><p><code>vim z_sendmail.sh</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">messages=`echo $3 | tr &#x27;\r\n&#x27; &#x27;\n&#x27;`</span><br><span class="line">subject=`echo $2 | tr &#x27;\r\n&#x27; &#x27;\n&#x27;`</span><br><span class="line">echo &quot;$&#123;messages&#125;&quot; | mail -s &quot;$&#123;subject&#125;&quot; $1 &gt;&gt;/tmp/sendmail.log 2&gt;&amp;1</span><br></pre></td></tr></table></figure>
<h2 id="使用脚本发送一封测试邮件"><a href="#使用脚本发送一封测试邮件" class="headerlink" title="使用脚本发送一封测试邮件"></a>使用脚本发送一封测试邮件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">chmod +x z_sendmail.sh</span><br><span class="line">touch /tmp/sendmail.log</span><br><span class="line">chown zabbix.zabbix /tmp/sendmail.log</span><br><span class="line">./z_sendmail.sh user@qq.com &quot;hello&quot; &quot;abc&quot;</span><br></pre></td></tr></table></figure>
<h1 id="添加报警类型"><a href="#添加报警类型" class="headerlink" title="添加报警类型"></a>添加报警类型</h1><h2 id="创建报警类型z-sendmail"><a href="#创建报警类型z-sendmail" class="headerlink" title="创建报警类型z_sendmail"></a>创建报警类型z_sendmail</h2><p>管理-报警媒介类型-创建媒体类型<br><img src="/images/2017/0929/15.png" alt="zabbix_install"><br><img src="/images/2017/0929/16.png" alt="zabbix_install"><br>脚本参数</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">名称：z_sendmail</span><br><span class="line">类型：脚本</span><br><span class="line">脚本名称：z_sendmail.sh</span><br><span class="line">添加以下3个参数，分别对应z_sendmail.sh脚本需要的3个参数</span><br><span class="line">收件人地址:&#123;ALERT.SENDTO&#125;</span><br><span class="line">主题:&#123;ALERT.SUBJECT&#125;</span><br><span class="line">详细内容:&#123;ALERT.MESSAGE&#125;</span><br></pre></td></tr></table></figure>
<h2 id="设置用户报警媒介"><a href="#设置用户报警媒介" class="headerlink" title="设置用户报警媒介"></a>设置用户报警媒介</h2><p><img src="/images/2017/0929/17.png" alt="zabbix_install"><br><img src="/images/2017/0929/18.png" alt="zabbix_install"></p>
<h1 id="配置触发器告警"><a href="#配置触发器告警" class="headerlink" title="配置触发器告警"></a>配置触发器告警</h1><h2 id="修改默认的告警模板"><a href="#修改默认的告警模板" class="headerlink" title="修改默认的告警模板"></a>修改默认的告警模板</h2><p>设置为“‘非维护状态’且‘报警值&gt;&#x3D;警告’”时触发动作<br><img src="/images/2017/0929/20.png" alt="zabbix_install"></p>
<h2 id="故障操作"><a href="#故障操作" class="headerlink" title="故障操作"></a>故障操作</h2><p><em>ps:这个模板标题不会乱码，其他的标题需要做utf8转码gb2312</em></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">默认接收人：故障&#123;TRIGGER.STATUS&#125;:服务器 &#123;HOSTNAME1&#125;:&#123;TRIGGER.NAME&#125;</span><br><span class="line">默认信息:</span><br><span class="line">告警主机:&#123;HOSTNAME1&#125;</span><br><span class="line">告警时间:&#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125;</span><br><span class="line">告警等级:&#123;TRIGGER.SEVERITY&#125;</span><br><span class="line">告警信息: &#123;TRIGGER.NAME&#125;</span><br><span class="line">告警项目:&#123;TRIGGER.KEY1&#125;</span><br><span class="line">问题详情:&#123;ITEM.NAME&#125;:&#123;ITEM.VALUE&#125;</span><br><span class="line">当前状态:&#123;TRIGGER.STATUS&#125;:&#123;ITEM.VALUE1&#125;</span><br><span class="line">事件ID:&#123;EVENT.ID&#125;</span><br><span class="line">请至Montoring-Events中查看详细情况。</span><br></pre></td></tr></table></figure>
<p><img src="/images/2017/0929/21.png" alt="zabbix_install"></p>
<h2 id="恢复操作"><a href="#恢复操作" class="headerlink" title="恢复操作"></a>恢复操作</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">默认接收人：恢复&#123;TRIGGER.STATUS&#125;:服务器&#123;HOSTNAME1&#125;:&#123;TRIGGER.NAME&#125;</span><br><span class="line">默认信息：告警主机:&#123;HOSTNAME1&#125;</span><br><span class="line">告警时间:&#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125;</span><br><span class="line">告警等级:&#123;TRIGGER.SEVERITY&#125;</span><br><span class="line">告警信息: &#123;TRIGGER.NAME&#125;</span><br><span class="line">告警项目:&#123;TRIGGER.KEY1&#125;</span><br><span class="line">问题详情:&#123;ITEM.NAME&#125;:&#123;ITEM.VALUE&#125;</span><br><span class="line">当前状态:&#123;TRIGGER.STATUS&#125;:&#123;ITEM.VALUE1&#125;</span><br><span class="line">事件ID:&#123;EVENT.ID&#125;</span><br><span class="line">报警已恢复，请放松心情。</span><br></pre></td></tr></table></figure>
<p><img src="/images/2017/0929/22.png" alt="zabbix_install"></p>
<h1 id="测试告警"><a href="#测试告警" class="headerlink" title="测试告警"></a>测试告警</h1><p>关闭zabbix agent，测试邮件<br><img src="/images/2017/0929/23.png" alt="zabbix_install"></p>
<p><em>ps:我用qq邮箱+授权码方式测试邮件，手动发送可以，系统提示发送成功，就是收不到，浪费了一天时间，坑好深！使用阿里云邮箱测试顺利！</em></p>
]]></content>
      <categories>
        <category>监控</category>
      </categories>
      <tags>
        <tag>zabbix</tag>
        <tag>监控</tag>
      </tags>
  </entry>
  <entry>
    <title>Zabbix(4)通过orabbix插件监控Oracle数据库</title>
    <url>/arlo/780360a7/</url>
    <content><![CDATA[<p>DBforBIX可以支持市面上主流的数据库监控，包括Oracle，Mysql，PostgreSQL，MSSQL，DB2，这篇文章简单的记录一下我监控oracle的过程；<br>软件环境：<br>Jdk 1.8.0_112<br>zabbix 3.4.2<br>orabbix 1.2.3</p>
<span id="more"></span>
<h1 id="安装jdk"><a href="#安装jdk" class="headerlink" title="安装jdk"></a>安装jdk</h1><p>下载jdk：<a href="http://www.oracle.com/technetwork/java/archive-139210.html">http://www.oracle.com/technetwork/java/archive-139210.html</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tar xf jdk-8u112-linux-x64.tar.gz -C /usr/local/</span><br><span class="line">vim /etc/profile</span><br><span class="line">export JAVA_HOME=/usr/local/jdk1.8.0_112/</span><br><span class="line">export CLASSPATH=.:$JAVA_HOME/lib/:$JAVA_HOME/jre/lib/</span><br><span class="line">export PATH=$JAVA_HOME/bin:$PATH</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>
<h1 id="oracle中增加监控用户权限"><a href="#oracle中增加监控用户权限" class="headerlink" title="oracle中增加监控用户权限"></a>oracle中增加监控用户权限</h1><h2 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">su - oracle</span><br><span class="line">$ sqlplus /nolog</span><br><span class="line">SQL&gt; conn /as sysdba</span><br><span class="line">SQL&gt; CREATE USER ZABBIX  IDENTIFIED BY &#x27;&lt;PASSWORD&gt;&#x27; DEFAULT TABLESPACE SYSTEM TEMPORARY TABLESPACE TEMP PROFILE DEFAULT ACCOUNT UNLOCK;</span><br><span class="line">SQL&gt; CREATE USER ZABBIX  IDENTIFIED BY zabbix DEFAULT TABLESPACE SYSTEM TEMPORARY TABLESPACE TEMP PROFILE DEFAULT ACCOUNT UNLOCK;</span><br></pre></td></tr></table></figure>
<h2 id="赋予权限"><a href="#赋予权限" class="headerlink" title="赋予权限"></a>赋予权限</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GRANT CONNECT TO ZABBIX;</span><br><span class="line">GRANT RESOURCE TO ZABBIX;</span><br><span class="line">GRANT CREATE SESSION TO ZABBIX;	</span><br><span class="line">GRANT SELECT ANY DICTIONARY TO ZABBIX;</span><br><span class="line">GRANT UNLIMITED TABLESPACE TO ZABBIX;</span><br><span class="line">GRANT SELECT ANY DICTIONARY TO ZABBIX;</span><br></pre></td></tr></table></figure>
<p>如果是oracle11g的话，需执行以下语句<br><em>执行以下语句的时候，注意一下全角半角标点符号</em></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SQL&gt; exec dbms_network_acl_admin.create_acl(acl =&gt;&#x27;resolve.xml&#x27;,description =&gt; &#x27;resolve acl&#x27;, principal =&gt;&#x27;ZABBIX&#x27;,is_grant =&gt; true, privilege =&gt; &#x27;resolve&#x27;);</span><br><span class="line">SQL&gt; exec dbms_network_acl_admin.assign_acl(acl =&gt;&#x27;resolve.xml&#x27;, host =&gt;&#x27;*&#x27;);</span><br></pre></td></tr></table></figure>
<p>验证语句</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SQL&gt; select utl_inaddr.get_host_name(&#x27;127.0.0.1&#x27;) from dual;</span><br></pre></td></tr></table></figure>
<h1 id="安装orabbix"><a href="#安装orabbix" class="headerlink" title="安装orabbix"></a>安装orabbix</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wget https://nchc.dl.sourceforge.net/project/orabbix/orabbix-1.2.3.zip</span><br><span class="line">mkdir /usr/local/orabbix</span><br><span class="line">mv orabbix-1.2.3.zip /usr/local/orabbix/</span><br><span class="line">unzip orabbix-1.2.3.zip</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cp config.props.sample config.props</span><br><span class="line">vim config.props</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ZabbixServerList=ZabbixServer</span><br><span class="line">ZabbixServer.Address=192.168.6.103</span><br><span class="line">ZabbixServer.Port=10051</span><br><span class="line">OrabbixDaemon.Sleep=300</span><br><span class="line">OrabbixDaemon.MaxThreadNumber=100</span><br><span class="line">#DatabaseList这里配置的主机名一定要和Zabbix里添加的主机名称一致，否则获取不到数据</span><br><span class="line">DatabaseList=vm00</span><br><span class="line">DatabaseList.MaxActive=10</span><br><span class="line">DatabaseList.MaxWait=100</span><br><span class="line">DatabaseList.MaxIdle=1</span><br><span class="line">vm00.Url=jdbc:oracle:thin:@192.168.6.100:1521:ORCL</span><br><span class="line">vm00.User=ZABBIX</span><br><span class="line">vm00.Password=zabbix</span><br><span class="line">vm00.MaxActive=10</span><br><span class="line">vm00.MaxWait=100</span><br><span class="line">vm00.MaxIdle=1</span><br><span class="line">vm00.QueryListFile=./conf/query.props</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cd /usr/local/orabbix</span><br><span class="line">vim run.sh</span><br><span class="line">修改java为/usr/local/jdk1.8.0_112/bin/java</span><br><span class="line">chmod +x run.sh</span><br><span class="line">cp init.d/orabbix /etc/init.d/</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/init.d/orabbix</span><br><span class="line">修改orabbix=/opt/orabbix为orabbix=/usr/local/orabbix</span><br><span class="line">chmod +x /etc/init.d/orabbix</span><br><span class="line">chkconfig --level 35 --add orabbix </span><br><span class="line">/etc/init.d/orabbix start</span><br></pre></td></tr></table></figure>
<p>如果出现异常，可以查看日志排查 &#x2F;usr&#x2F;local&#x2F;orabbix&#x2F;logs&#x2F;orabbix.log</p>
<h1 id="导入模板"><a href="#导入模板" class="headerlink" title="导入模板"></a>导入模板</h1><p>将&#x2F;usr&#x2F;local&#x2F;orabbix&#x2F;template&#x2F;Orabbix_export_full.xml模板导入<br><img src="/images/2017/0930/01.png" alt="zabbix_install"><br><img src="/images/2017/0930/02.png" alt="zabbix_install"><br>添加主机，关联oracle数据库监控模板<br><img src="/images/2017/0930/03.png" alt="zabbix_install"><br>默认的配置文件无法正常获取到dbfilesize和dbsize，需要手动修改一下配置文件<br>&#x2F;usr&#x2F;local&#x2F;orabbix&#x2F;conf&#x2F;query.props<br>在配置文件最后添加</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dbfilesize.Query=select to_char(sum(bytes/1024/1024/10), &#x27;FM99999999999999990&#x27;) retvalue from dba_data_files</span><br><span class="line"> </span><br><span class="line">dbsize.Query=SELECT to_char(sum(  NVL(a.bytes/1024/1024/10 - NVL(f.bytes/1024/1024/10, 0), 0)), &#x27;FM99999999999999990&#x27;) retvalue \</span><br><span class="line">FROM sys.dba_tablespaces d, \</span><br><span class="line">(select tablespace_name, sum(bytes) bytes from dba_data_files group by tablespace_name) a, \</span><br><span class="line">(select tablespace_name, sum(bytes) bytes from dba_free_space group by tablespace_name) f \ </span><br><span class="line">WHERE d.tablespace_name = a.tablespace_name(+) AND d.tablespace_name = f.tablespace_name(+) \</span><br><span class="line">AND NOT (d.extent_management like &#x27;LOCAL&#x27; AND d.contents like &#x27;TEMPORARY&#x27;)</span><br></pre></td></tr></table></figure>
<p>在QueryList最后添加,dbfilesize,dbsize</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">QueryList=archive,audit,dbblockgets,dbconsistentgets,dbhitratio,dbphysicalread,dbversion,hitratio_body,hitratio_sqlarea,hitratio_table_proc, \</span><br><span class="line">lio_current_read,locks,maxprocs,maxsession,miss_latch,pga_aggregate_target, pga,phio_datafile_reads,phio_datafile_writes,phio_redo_writes,pinhitratio_body,pinhitratio_sqlarea,pinhitratio_table-proc,pinhitratio_</span><br><span class="line">trigger, \</span><br><span class="line">pool_dict_cache,pool_free_mem,pool_lib_cache,pool_misc,pool_sql_area,procnum,session_active,session_inactive,session,session_system,sga_buffer_cache, \</span><br><span class="line">sga_fixed,sga_java_pool,sga_large_pool,sga_log_buffer,sga_shared_pool,tbl_space,userconn,waits_controfileio,waits_directpath_read, \</span><br><span class="line">waits_file_io,waits_latch,waits_logwrite,waits_multiblock_read,waits_singleblock_read,hitratio_trigger,lio_block_changes,lio_consistent_read,waits_other,waits_sqlnet,users_locked,uptime,dbfilesize,dbsize</span><br></pre></td></tr></table></figure>
<p><img src="/images/2017/0930/04.png" alt="zabbix_install"><br>可以在最新数据里看到已经监控到的数据<br><img src="/images/2017/0930/05.png" alt="zabbix_install"></p>
<h1 id="orabbix-for-zabbix4-x"><a href="#orabbix-for-zabbix4-x" class="headerlink" title="orabbix for zabbix4.x"></a>orabbix for zabbix4.x</h1><p>如果使用的zabbix4.x版本，orabbix1.2.3默认是不能获取到监控项的，可以参考<a href="https://github.com/snickerjp/orabbix%EF%BC%8C%E9%87%8D%E6%96%B0%E7%BC%96%E8%AF%91orabbix-1.2.3.jar%EF%BC%8C%E6%9B%BF%E6%8D%A2%E7%9B%AE%E5%89%8D%E7%89%88%E6%9C%AC%E5%8D%B3%E5%8F%AF%EF%BC%9B%E5%A6%82%E6%9E%9C%E4%B8%8D%E6%83%B3%E7%BC%96%E8%AF%91%EF%BC%8C%E8%BF%99%E9%87%8C%E6%9C%89%E7%8E%B0%E6%88%90%E7%9A%84">https://github.com/snickerjp/orabbix，重新编译orabbix-1.2.3.jar，替换目前版本即可；如果不想编译，这里有现成的</a>: <a href="https://pan.baidu.com/s/1-QmNXEphOtJL6c-OZg9Q-A">https://pan.baidu.com/s/1-QmNXEphOtJL6c-OZg9Q-A</a> 提取码: 76zt 失效联系我。</p>
<p>参考链接：<br><a href="https://www.kancloud.cn/devops-centos/centos-linux-devops/361200">https://www.kancloud.cn/devops-centos/centos-linux-devops/361200</a><br><a href="http://fengwan.blog.51cto.com/508652/1722118">http://fengwan.blog.51cto.com/508652/1722118</a><br><a href="http://www.smartmarmot.com/wiki/index.php?title=DBforBIX#Install_steps_for_Oracle">http://www.smartmarmot.com/wiki/index.php?title=DBforBIX#Install_steps_for_Oracle</a></p>
]]></content>
      <categories>
        <category>监控</category>
      </categories>
      <tags>
        <tag>Oracle</tag>
        <tag>zabbix</tag>
        <tag>监控</tag>
      </tags>
  </entry>
  <entry>
    <title>Zabbix(5)通过JMX监控Tomcat</title>
    <url>/arlo/e35d6a2a/</url>
    <content><![CDATA[<p>Zabbix监控tomcat主要使用的是zabbix的zabbix-java-gateway。从Zabbix 2.0开始，内置了监控JMX的功能，叫做“Zabbix Java Gateway”，在Zabbix Server和Zabbix Proxy上启动名为“Zabbix Java Gateway”的进程，当需要获取JMX数据时，Zabbix Server会“问”JMX Gateway，然后JMX Gateway根据JMX管理API去查询需要的数据。在使用时，Java程序不需要在代码中新增任何东西，只需要在启动的时候加上一些JVM参数，使得它可以支持使用端口监控JMX。JMX的全称是Java Management Extensions，即Java管理扩展。Java程序会开放一些端口，用来获取运行状况。</p>
<span id="more"></span>
<h1 id="安装jmx服务器"><a href="#安装jmx服务器" class="headerlink" title="安装jmx服务器"></a>安装jmx服务器</h1><h2 id="安装jdk"><a href="#安装jdk" class="headerlink" title="安装jdk"></a>安装jdk</h2><p><a href="http://www.oracle.com/technetwork/java/archive-139210.html">下载JDK</a><br><a href="http://islocal.cc/2017/09/27/JDK%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E9%85%8D%E7%BD%AE/">配置环境变量</a></p>
<h2 id="安装jmx服务"><a href="#安装jmx服务" class="headerlink" title="安装jmx服务"></a>安装jmx服务</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum -y install zabbix-java-gateway</span><br></pre></td></tr></table></figure>
<h2 id="配置jmx服务"><a href="#配置jmx服务" class="headerlink" title="配置jmx服务"></a>配置jmx服务</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">egrep -v &#x27;#|^$&#x27; /etc/zabbix/zabbix_java_gateway.conf</span><br><span class="line">LISTEN_IP=&quot;0.0.0.0&quot;</span><br><span class="line">LISTEN_PORT=10052</span><br><span class="line">PID_FILE=&quot;/var/run/zabbix/zabbix_java.pid&quot;</span><br><span class="line">START_POLLERS=5</span><br><span class="line">TIMEOUT=3</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl start zabbix-java-gateway</span><br><span class="line">systemctl enable zabbix-java-gateway</span><br></pre></td></tr></table></figure>
<h2 id="修改zabbix-server配置"><a href="#修改zabbix-server配置" class="headerlink" title="修改zabbix server配置"></a>修改zabbix server配置</h2><p><em>添加以下三行，这里配置的StartJavaPollers值要小于之前java_gateway中的START_POLLERS</em></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tail -n 3 /etc/zabbix/zabbix_server.conf </span><br><span class="line">JavaGateway=127.0.0.1</span><br><span class="line">JavaGatewayPort=10052     </span><br><span class="line">StartJavaPollers=3</span><br></pre></td></tr></table></figure>
<p>修改zabbix_server.conf后重启服务</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl restart zabbix-server</span><br></pre></td></tr></table></figure>
<h1 id="Tomcat配置修改"><a href="#Tomcat配置修改" class="headerlink" title="Tomcat配置修改"></a>Tomcat配置修改</h1><h2 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h2><p>Windows下tomcat在F:\apache-tomcat-7.0.70(zabbix)\bin\catalina.bat中set “CURRENT_DIR&#x3D;%cd%”下添加以下内容</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">set CATALINA_OPTS=-Dcom.sun.management.jmxremote.port=12345 -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false</span><br><span class="line"># 如果zabbix添加JMX后报错“java.net.SocketTimeoutException: connection timed out: service:jmx:rmi:///jndi/rmi:/”  添加此参数 -Djava.rmi.server.hostname=192.168.6.124 </span><br></pre></td></tr></table></figure>
<h2 id="测试JMX"><a href="#测试JMX" class="headerlink" title="测试JMX"></a>测试JMX</h2><p>下载以下两个jar包放在tomcat lib目录下。<br>下载<a href="http://crawler.archive.org/cmdline-jmxclient/cmdline-jmxclient-0.10.3.jar">cmdline-jmxclient-0.10.3.jar</a><br>下载<a href="https://archive.apache.org/dist/tomcat/tomcat-7/v7.0.77/bin/extras/catalina-jmx-remote.jar">catalina-jmx-remote.jar</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">F:\apache-tomcat-7.0.70(zabbix)\lib&gt;java -jar cmdline-jmxclient-0.10.3.jar - 192.168.6.124:12345 java.lang:type=Memory NonHeapMemoryUsage</span><br><span class="line">10/10/2017 16:31:57 +0800 org.archive.jmx.Client NonHeapMemoryUsage:</span><br><span class="line">committed: 24838144</span><br><span class="line">init: 12746752</span><br><span class="line">max: 100663296</span><br><span class="line">used: 24806392</span><br></pre></td></tr></table></figure>
<h1 id="在zabbix-web页面中添加JMX端口"><a href="#在zabbix-web页面中添加JMX端口" class="headerlink" title="在zabbix web页面中添加JMX端口"></a>在zabbix web页面中添加JMX端口</h1><h2 id="导入模板"><a href="#导入模板" class="headerlink" title="导入模板"></a>导入模板</h2><p>zabbix自带的”Template App Generic Java JMX”和”Template App Apache Tomcat JMX”模板很多都获取不到数据，从网上找了个模板，监控项不多，但是都是很实用的。<br><img src="/images/2017/1010/06.png" alt="zabbix"><br><img src="/images/2017/1010/07.png" alt="zabbix"></p>
<h2 id="添加JMX端口"><a href="#添加JMX端口" class="headerlink" title="添加JMX端口"></a>添加JMX端口</h2><p>jmx的端口一定要与在catalina.bat下配置的jmxremote.port一样<br><img src="/images/2017/1010/04.png" alt="zabbix"></p>
<h2 id="关联模板"><a href="#关联模板" class="headerlink" title="关联模板"></a>关联模板</h2><p><img src="/images/2017/1010/05.png" alt="zabbix"></p>
<h2 id="查看图形"><a href="#查看图形" class="headerlink" title="查看图形"></a>查看图形</h2><p><img src="/images/2017/1010/08.png" alt="zabbix"></p>
<p>参考链接：<br><a href="http://wzlinux.blog.51cto.com/8021085/1692444">http://wzlinux.blog.51cto.com/8021085/1692444</a><br><a href="http://blog.csdn.net/jhfsdfs/article/details/65629174">http://blog.csdn.net/jhfsdfs/article/details/65629174</a><br><a href="http://www.fblinux.com/?p=616">http://www.fblinux.com/?p=616</a></p>
<hr>
]]></content>
      <categories>
        <category>监控</category>
      </categories>
      <tags>
        <tag>zabbix</tag>
        <tag>监控</tag>
        <tag>tomcat</tag>
      </tags>
  </entry>
  <entry>
    <title>Zabbix(6)监控SQL Server数据库</title>
    <url>/arlo/35d80780/</url>
    <content><![CDATA[<p>监控SQL Server相对来说比较简单，首先我们下载一个MS SQL的模板文件<br>下载地址：<a href="https://share.zabbix.com/databases/microsoft-sql-server/template-ms-sql-2012">https://share.zabbix.com/databases/microsoft-sql-server/template-ms-sql-2012</a></p>
<span id="more"></span>
<h1 id="修改zabbix-agent-conf文件"><a href="#修改zabbix-agent-conf文件" class="headerlink" title="修改zabbix_agent.conf文件"></a>修改zabbix_agent.conf文件</h1><p>添加下边这行到配置文件最后</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">UserParameter=sqldatabasename.discovery,powershell -NoProfile -ExecutionPolicy Bypass -File C:\zabbix\scripts\SQLBaseName_To_Zabbix.ps1</span><br></pre></td></tr></table></figure>
<h1 id="将powershell脚本放在目录下"><a href="#将powershell脚本放在目录下" class="headerlink" title="将powershell脚本放在目录下"></a>将powershell脚本放在目录下</h1><p>将SQLBaseName_To_Zabbix.ps1脚本放在C:\zabbix\scripts\目录下</p>
<h1 id="重启zabbix-agent"><a href="#重启zabbix-agent" class="headerlink" title="重启zabbix agent"></a>重启zabbix agent</h1><p>重启客户端zabbix agent服务</p>
<h1 id="导入模板文件"><a href="#导入模板文件" class="headerlink" title="导入模板文件"></a>导入模板文件</h1><p>导入模板MS SQL 2012.xml</p>
<h1 id="关联模板"><a href="#关联模板" class="headerlink" title="关联模板"></a>关联模板</h1><p><img src="/images/2017/1019/00.png" alt="zabbix_mssql"></p>
<h1 id="查看最新数据"><a href="#查看最新数据" class="headerlink" title="查看最新数据"></a>查看最新数据</h1><p><img src="/images/2017/1019/01.png" alt="zabbix_mssql"></p>
]]></content>
      <categories>
        <category>监控</category>
      </categories>
      <tags>
        <tag>zabbix</tag>
        <tag>监控</tag>
        <tag>MSSQL</tag>
      </tags>
  </entry>
  <entry>
    <title>ecFlow安装小记</title>
    <url>/arlo/8af01e65/</url>
    <content><![CDATA[<p>在数值天气预报系统中有大量的计算机任务，这些任务之间又存在错综复杂的关系，如何管理和维护大量的复杂的任务成为一个难题，ecFlow正是为解决这一问题而诞生的。ecFlow是为欧洲中期天气预报中心（ECMWF）制作的产品，作为气象应用软件项目的一部分，用于工作流的管理和监控。<br>它具有如下功能：</p>
<ul>
<li>提供基于文本的任务定义语言以及python接口对计算机任务进行定义 </li>
<li>可以设定任务间的依赖关系，并在依赖关系满足时触发任务 </li>
<li>提供任务出错时的容错机制  </li>
<li>提供图形化的界面实时查看任务运行状况以及报错信息，用不同颜色来表示任务的运行状态，还可以根据需要自定义显示任务运行的进度。</li>
</ul>
<p>ecFlow是基于客户端&#x2F;服务端的模式工作的，即先启动一个ecFlow的服务端，计算机任务作为客户端，客户端任务在运行过程中将自己的状态发送到服务端，服务端根据收到的信息更新作业状态。 </p>
<span id="more"></span>

<blockquote>
<p>本来是就Centos 6.9来安装ecflow的，由于ecflow要求Python版本必须大于2.7，而默认的是2.6.6，自行升级了python，编译后是各种报错，qt也装不上，实在是折腾累了，于是更换为centos7.2操作系统，默认python版本2.7.5，编译一切正常；</p>
</blockquote>
<h1 id="依赖关系"><a href="#依赖关系" class="headerlink" title="依赖关系"></a>依赖关系</h1><ul>
<li>cmake</li>
<li>g++</li>
<li>Python 2.7 or Python3</li>
<li>Xlib, X11, XMotif for <a href="https://software.ecmwf.int/wiki/display/ECFLOW/Glossary#term-ecflowview">ecflowview</a> </li>
<li>Qt for <a href="https://software.ecmwf.int/wiki/display/ECFLOW/ecFlowUI+Documentation">ecFlowUI</a></li>
</ul>
<h2 id="下载地址"><a href="#下载地址" class="headerlink" title="下载地址"></a>下载地址</h2><p>ecFlow：<a href="https://software.ecmwf.int/wiki/display/SUP/Releases">https://software.ecmwf.int/wiki/display/SUP/Releases</a><br>boost：	<a href="http://www.boost.org/users/download/">http://www.boost.org/users/download/</a><br>Motif：	<a href="http://www.ist.co.uk/motif/download/index.html">http://www.ist.co.uk/motif/download/index.html</a><br>Qt：	<a href="http://mirrors.ustc.edu.cn/qtproject/archive/qt/">http://mirrors.ustc.edu.cn/qtproject/archive/qt/</a></p>
<h2 id="安装cmake、g"><a href="#安装cmake、g" class="headerlink" title="安装cmake、g++"></a>安装cmake、g++</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm01 ~]# yum -y install cmake g++ glibc  gcc gcc-c++ python-devel openssl-devel zlib-devel ncurses-devel</span><br></pre></td></tr></table></figure>
<h2 id="安装python3"><a href="#安装python3" class="headerlink" title="安装python3"></a>安装python3</h2><blockquote>
<p>Centos 7默认的python版本是2.7.5，满足要求；不需要安装python3</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm01 ~]# wget https://www.python.org/ftp/python/3.5.0/Python-3.5.0.tar.xz</span><br><span class="line">[root@vm01 ~]# tar xvf Python-3.5.0.tar.xz</span><br><span class="line">[root@vm01 ~]# cd Python-3.5.0</span><br><span class="line">[root@vm01 ~]# ./configure --prefix=/usr/local/python3</span><br><span class="line">[root@vm01 ~]# make &amp;&amp; make install</span><br><span class="line">[root@vm01 ~]# mv /usr/bin/python /usr/bin/python_old</span><br><span class="line">[root@vm01 ~]# ln -s /usr/local/python3/bin/python3 /usr/bin/python</span><br><span class="line">[root@vm01 ~]# cp -R /usr/local/python3/lib/* /usr/lib64/</span><br></pre></td></tr></table></figure>
<p>修改yum中的python版本</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm01 ~]# vim /usr/bin/yum</span><br><span class="line">#!/usr/bin/python </span><br><span class="line">更改为 </span><br><span class="line">#!/usr/bin/python_old</span><br></pre></td></tr></table></figure>
<h2 id="安装Xlib-X11-XMotif"><a href="#安装Xlib-X11-XMotif" class="headerlink" title="安装Xlib, X11, XMotif"></a>安装Xlib, X11, XMotif</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm01 ecFlow]# yum localinstall openmotif-2.1.32-2_IST.x86_64.rpm</span><br></pre></td></tr></table></figure>
<h2 id="ecFlowUI-需要图形界面QT支持"><a href="#ecFlowUI-需要图形界面QT支持" class="headerlink" title="ecFlowUI 需要图形界面QT支持"></a>ecFlowUI 需要图形界面QT支持</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm01 ecFlow]# yum -y install mesa-libGL-devel mesa-libGLU-devel freeglut-devel git gflags gflags-devel</span><br><span class="line">[root@vm01 ecFlow]# yum groupinstall &quot;GNOME Desktop&quot;</span><br><span class="line">[root@vm01 ecFlow]# chmod +x qt-opensource-linux-x64-5.8.0.run</span><br><span class="line">[root@vm01 ecFlow]# ./qt-opensource-linux-x64-5.8.0.run</span><br></pre></td></tr></table></figure>
<h1 id="安装ecFlow环境"><a href="#安装ecFlow环境" class="headerlink" title="安装ecFlow环境"></a>安装ecFlow环境</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm01 ~]# cd /usr/local/src/ecFlow/</span><br><span class="line">[root@vm01 ecFlow]# tar xf boost_1_64_0.tar.gz</span><br><span class="line">[root@vm01 ecFlow]# tar xf ecFlow-4.5.0-Source.tar.gz</span><br><span class="line">[root@vm01 ecFlow]# export WK=/usr/local/src/ecFlow/ecFlow-4.5.0-Source</span><br><span class="line">[root@vm01 ecFlow]# export BOOST_ROOT=/usr/local/src/ecFlow/boost_1_64_0</span><br></pre></td></tr></table></figure>

<h2 id="安装boost"><a href="#安装boost" class="headerlink" title="安装boost"></a>安装boost</h2><h3 id="基于bjam安装boost"><a href="#基于bjam安装boost" class="headerlink" title="基于bjam安装boost"></a>基于bjam安装boost</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm01 boost_1_64_0]# cd $BOOST_ROOT</span><br><span class="line">[root@vm01 boost_1_64_0]# ./bootstrap.sh</span><br><span class="line">[root@vm01 boost_1_64_0]# ./b2</span><br><span class="line">[root@vm01 boost_1_64_0]# ./b2 install --prefix=/usr/local</span><br></pre></td></tr></table></figure>
<h3 id="基于python安装boost"><a href="#基于python安装boost" class="headerlink" title="基于python安装boost"></a>基于python安装boost</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm01 boost_1_64_0]# ./bootstrap.sh --with-python=/usr/bin/python3</span><br><span class="line">[root@vm01 boost_1_64_0]# ./b2</span><br><span class="line">[root@vm01 boost_1_64_0]# ./b2 install --prefix=/usr/local</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果不需要ecflow的python接口，可以通过下面的设置避免编译boost的python库，在调用$WK&#x2F;build_scripts&#x2F;boost_build.sh前设置<br>export ECF_NO_PYTHON&#x3D;1</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm01 boost_1_64_0]# cd $BOOST_ROOT</span><br><span class="line">[root@vm01 boost_1_64_0]# $WK/build_scripts/boost_1_53_fix.sh</span><br><span class="line">[root@vm01 boost_1_64_0]# $WK/build_scripts/boost_build.sh</span><br></pre></td></tr></table></figure>
<h2 id="编译安装ecflow"><a href="#编译安装ecflow" class="headerlink" title="编译安装ecflow"></a>编译安装ecflow</h2><p>推荐使用cmake 编译ecflow</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm01 boost_1_64_0]# cd $WK</span><br><span class="line">[root@vm01 build]# mkdir build; cd build;</span><br></pre></td></tr></table></figure>
<p><img src="/images/2017/0505/01.png" alt="ecFlow"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm01 build]# export CMAKE_PREFIX_PATH=/opt/Qt5.8.0/5.8/gcc_64/lib/cmake/Qt5Network</span><br></pre></td></tr></table></figure>
<p><img src="/images/2017/0505/02.png" alt="ecFlow"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@vm01 build]# vim ../CMakeLists.txt   #在最底下添加这行代码</span><br><span class="line">set(CMAKE_CXX_FLAGS &quot;$&#123;CMAKE_CXX_FLAGS&#125; -fPIC&quot;) </span><br><span class="line">[root@vm01 build]# cmake ..  -DCMAKE_INSTALL_PREFIX=/usr/local/ecflow -DCMAKE_BUILD_TYPE=Release -DENABLE_GUI=OFF</span><br><span class="line">[root@vm01 build]# CPUS=$(lscpu -p | grep -v &#x27;#&#x27; | wc -l)</span><br><span class="line">[root@vm01 build]# make -j$&#123;CPUS&#125;</span><br><span class="line">[root@vm01 build]# make check</span><br><span class="line">[root@vm01 build]# make install</span><br></pre></td></tr></table></figure>



<p>参考链接：<br><a href="https://software.ecmwf.int/wiki/display/ECFLOW/Installation">https://software.ecmwf.int/wiki/display/ECFLOW/Installation</a><br><a href="http://windrocblog.sinaapp.com/?p=1602">http://windrocblog.sinaapp.com/?p=1602</a><br><a href="https://wenku.baidu.com/view/fda9af29bfd5b9f3f90f76c66137ee06eff94e8d.html?re=view">https://wenku.baidu.com/view/fda9af29bfd5b9f3f90f76c66137ee06eff94e8d.html?re=view</a><br><a href="http://blog.csdn.net/u013121305/article/details/49853713">http://blog.csdn.net/u013121305/article/details/49853713</a></p>
<hr>
]]></content>
      <categories>
        <category>大气模型</category>
      </categories>
      <tags>
        <tag>ecFlow</tag>
      </tags>
  </entry>
  <entry>
    <title>yum 安装epel扩展后报错</title>
    <url>/arlo/ef6f2f28/</url>
    <content><![CDATA[<p>安装epel扩展后出现的几个问题</p>
<span id="more"></span>
<h1 id="A1："><a href="#A1：" class="headerlink" title="A1："></a>A1：</h1><p>Error: Cannot retrieve metalink for repository: epel. Please verify its path and try again<br>编辑&#x2F;etc&#x2F;yum.repo&#x2F;epel.repo文件,</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#baseurl</span><br><span class="line">mirrorlist</span><br><span class="line">改成</span><br><span class="line">baseurl</span><br><span class="line">#mirrorlist</span><br></pre></td></tr></table></figure>
<h1 id="A2"><a href="#A2" class="headerlink" title="A2:"></a>A2:</h1><p>PYCURL ERROR 7 - “Failed to connect to 2001:4178:5:200::10: Network is unreachable”</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/yum.conf</span><br><span class="line">[main]</span><br><span class="line">ip_resolve=4</span><br></pre></td></tr></table></figure>
<h1 id="A3"><a href="#A3" class="headerlink" title="A3:"></a>A3:</h1><p>[Errno 14] problem making ssl connection<br>[Errno 14] PYCURL ERROR 7 - Failed to connect to 2605:bc80:3010:600:dead:beef:cafe:fed9: Network is unreachable</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum install ca-certificates -y</span><br><span class="line">yum clean all</span><br><span class="line">yum list</span><br></pre></td></tr></table></figure>
<p>A4：<br>There are unfinished transactions remaining. You might consider running yum-complete-transaction, or “yum-complete-transaction –cleanup-only” and “yum history redo last”, first to finish them. If those don’t work you’ll have to try removing&#x2F;installing packages by hand (maybe package-cleanup can help).<br>The program yum-complete-transaction is found in the yum-utils package.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum install yum-utils</span><br><span class="line">yum-complete-transaction --cleanup-only</span><br><span class="line">package-cleanup --dupes</span><br><span class="line">package-cleanup --problems</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Troubleshooting</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>常识</tag>
        <tag>epel</tag>
      </tags>
  </entry>
  <entry>
    <title>mailx 发送邮件小计</title>
    <url>/arlo/670d97dc/</url>
    <content><![CDATA[<h1 id="安装postfix服务"><a href="#安装postfix服务" class="headerlink" title="安装postfix服务"></a>安装postfix服务</h1><p>yum install postfix<br>&#x2F;etc&#x2F;init.d&#x2F;postfix start<br>chkconfig postfix on</p>
<h1 id="发送格式"><a href="#发送格式" class="headerlink" title="发送格式"></a>发送格式</h1><p>mailx -s subject <a href="mailto:&#117;&#x73;&#101;&#x72;&#x40;&#x78;&#120;&#120;&#46;&#x63;&#x6f;&#109;">&#117;&#x73;&#101;&#x72;&#x40;&#x78;&#120;&#120;&#46;&#x63;&#x6f;&#109;</a> &lt; message_file<br>echo “内容” | mailx -s “邮件标题” <a href="mailto:&#x75;&#115;&#101;&#x72;&#x40;&#x78;&#x78;&#x78;&#46;&#x63;&#x6f;&#109;">&#x75;&#115;&#101;&#x72;&#x40;&#x78;&#x78;&#x78;&#46;&#x63;&#x6f;&#109;</a></p>
<h1 id="其他选项"><a href="#其他选项" class="headerlink" title="其他选项"></a>其他选项</h1><p>-r 指定发件人<br>-c 指定抄送人<br>-b 指定密送人<br>多个收件人使用逗号分隔<br>有些邮箱（如qq邮箱）会当成垃圾邮件拦截，日志中可以看到500错误</p>
<span id="more"></span>

<h1 id="监控服务脚本是否运行正常"><a href="#监控服务脚本是否运行正常" class="headerlink" title="监控服务脚本是否运行正常"></a>监控服务脚本是否运行正常</h1><h2 id="监控脚本内容"><a href="#监控脚本内容" class="headerlink" title="监控脚本内容"></a>监控脚本内容</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">count=`ssh m1 ps -ef|grep real_wrf.csh |grep -v &quot;grep&quot; |wc -l`</span><br><span class="line">#echo $count</span><br><span class="line">if [ 0 == $count ];then</span><br><span class="line">        mailx -s &quot;the real_wrf.csh is not running &quot; a1@xxx.com.cn,a2@xxx.com.cn &lt; t.txt     </span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<h2 id="监测目录下是否有文件"><a href="#监测目录下是否有文件" class="headerlink" title="监测目录下是否有文件"></a>监测目录下是否有文件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">#每天6:00~7:00检查前一天00时的数据，每天16:00~18:00检查前一天12时的数据</span><br><span class="line"></span><br><span class="line">Date1=`date -d &quot;1 day ago&quot; +&quot;%Y%m%d00&quot;`</span><br><span class="line">Date2=`date -d &quot;1 day ago&quot; +&quot;%Y%m%d_06&quot;`</span><br><span class="line">file=&quot;\</span><br><span class="line">/data/Model3/WRF/data/output/wrf/$Date1/wrfout_d03 \</span><br><span class="line">/data/Model3/CMAQ4.7/data/cctm-wrf/$Date1/CCTM_CONC.cn03.*.ncf \</span><br><span class="line">/data/Model3/CAMx6/data/post_save/$Date1/camxsave_d03* \</span><br><span class="line">/data/em/result/predictions/SHAANXI/$Date2/POST/naqpms_d03.* \</span><br><span class="line">/data/Model3/WRF/data/output/wrfchem/$Date1/wrfout_d03* \</span><br><span class="line">&quot;</span><br><span class="line">for i in $file</span><br><span class="line">do</span><br><span class="line">    if [ ! -f &quot;$i&quot; ]; then</span><br><span class="line">        echo &quot;$i 文件不存在&quot; &gt;&gt;  check_00mx_$Date1.txt</span><br><span class="line">        mailx -s &quot;00时文件数据模型数据不存在&quot; b@xx.com.cn &lt; check_00mx_$Date1.txt                           </span><br><span class="line">    fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h2 id="监测目录是否存在，目录是否为空"><a href="#监测目录是否存在，目录是否为空" class="headerlink" title="监测目录是否存在，目录是否为空"></a>监测目录是否存在，目录是否为空</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">#每天6:00~7:00检查前一天00时的数据，每天16:00~18:00检查前一天12时的数据</span><br><span class="line"></span><br><span class="line">Date1=`date +&quot;%Y&quot;`</span><br><span class="line">Date2=`date +&quot;%m&quot;`</span><br><span class="line">Date3=`date -d &#x27;-1 day&#x27;  +&quot;%d&quot;`</span><br><span class="line">Date4=`date +&quot;%Y%m%d00&quot;`</span><br><span class="line">Dir=/data/Model3/WeatherForecast</span><br><span class="line">WRF_Dir=&quot;$Dir/WRF/$Date1/$Date2/$Date3/d3/500/ \</span><br><span class="line">$Dir/WRF/$Date1/$Date2/$Date3/d3/700/ \</span><br><span class="line">$Dir/WRF/$Date1/$Date2/$Date3/d3/850/ \</span><br><span class="line">$Dir/WRF/$Date1/$Date2/$Date3/d3/srf/&quot;</span><br><span class="line"></span><br><span class="line">WRFCHEM_Dir=&quot;$Dir/WRFCHEM/$Date1/$Date2/$Date3/00/d3/aqi \</span><br><span class="line">$Dir/WRFCHEM/$Date1/$Date2/$Date3/00/d3/co \</span><br><span class="line">$Dir/WRFCHEM/$Date1/$Date2/$Date3/00/d3/no2 \</span><br><span class="line">$Dir/WRFCHEM/$Date1/$Date2/$Date3/00/d3/o3 \</span><br><span class="line">$Dir/WRFCHEM/$Date1/$Date2/$Date3/00/d3/pm10 \</span><br><span class="line">$Dir/WRFCHEM/$Date1/$Date2/$Date3/00/d3/pm25 \</span><br><span class="line">$Dir/WRFCHEM/$Date1/$Date2/$Date3/00/d3/so2&quot;</span><br><span class="line"></span><br><span class="line">WRFCHEMDAY_Dir=&quot;$Dir/WRFCHEMDAY/$Date1/$Date2/$Date3/00/d3/aqi \</span><br><span class="line">$Dir/WRFCHEMDAY/$Date1/$Date2/$Date3/00/d3/co \</span><br><span class="line">$Dir/WRFCHEMDAY/$Date1/$Date2/$Date3/00/d3/no2 \</span><br><span class="line">$Dir/WRFCHEMDAY/$Date1/$Date2/$Date3/00/d3/o3 \</span><br><span class="line">$Dir/WRFCHEMDAY/$Date1/$Date2/$Date3/00/d3/pm10 \</span><br><span class="line">$Dir/WRFCHEMDAY/$Date1/$Date2/$Date3/00/d3/pm25 \</span><br><span class="line">$Dir/WRFCHEMDAY/$Date1/$Date2/$Date3/00/d3/so2&quot;</span><br><span class="line"></span><br><span class="line">CAMX_Dir=&quot;$Dir/CAMX/$Date1/$Date2/$Date3/00/d3/aqi \</span><br><span class="line">$Dir/CAMX/$Date1/$Date2/$Date3/00/d3/co \</span><br><span class="line">$Dir/CAMX/$Date1/$Date2/$Date3/00/d3/no2 \</span><br><span class="line">$Dir/CAMX/$Date1/$Date2/$Date3/00/d3/o3 \</span><br><span class="line">$Dir/CAMX/$Date1/$Date2/$Date3/00/d3/pm10 \</span><br><span class="line">$Dir/CAMX/$Date1/$Date2/$Date3/00/d3/pm25 \</span><br><span class="line">$Dir/CAMX/$Date1/$Date2/$Date3/00/d3/so2 &quot;</span><br><span class="line"></span><br><span class="line">CAMxDAY_Dir=&quot;$Dir/CAMxDAY/$Date1/$Date2/$Date3/00/d3/aqi \</span><br><span class="line">$Dir/CAMxDAY/$Date1/$Date2/$Date3/00/d3/co \</span><br><span class="line">$Dir/CAMxDAY/$Date1/$Date2/$Date3/00/d3/no2 \</span><br><span class="line">$Dir/CAMxDAY/$Date1/$Date2/$Date3/00/d3/o3 \</span><br><span class="line">$Dir/CAMxDAY/$Date1/$Date2/$Date3/00/d3/pm10 \</span><br><span class="line">$Dir/CAMxDAY/$Date1/$Date2/$Date3/00/d3/pm25 \</span><br><span class="line">$Dir/CAMxDAY/$Date1/$Date2/$Date3/00/d3/so2 &quot;</span><br><span class="line"></span><br><span class="line">CMAQ_WRF_Dir=&quot;$Dir/CMAQ.WRF/$Date1/$Date2/$Date3/00/d3/aqi \</span><br><span class="line">$Dir/CMAQ.WRF/$Date1/$Date2/$Date3/00/d3/co \</span><br><span class="line">$Dir/CMAQ.WRF/$Date1/$Date2/$Date3/00/d3/no2 \</span><br><span class="line">$Dir/CMAQ.WRF/$Date1/$Date2/$Date3/00/d3/o3 \</span><br><span class="line">$Dir/CMAQ.WRF/$Date1/$Date2/$Date3/00/d3/pm10 \</span><br><span class="line">$Dir/CMAQ.WRF/$Date1/$Date2/$Date3/00/d3/pm25 \</span><br><span class="line">$Dir/CMAQ.WRF/$Date1/$Date2/$Date3/00/d3/so2 &quot;</span><br><span class="line"></span><br><span class="line">CMAQDAY_Dir=&quot;$Dir/CMAQDAY/$Date1/$Date2/$Date3/00/d3/aqi \</span><br><span class="line">$Dir/CMAQDAY/$Date1/$Date2/$Date3/00/d3/co \</span><br><span class="line">$Dir/CMAQDAY/$Date1/$Date2/$Date3/00/d3/no2 \</span><br><span class="line">$Dir/CMAQDAY/$Date1/$Date2/$Date3/00/d3/o3 \</span><br><span class="line">$Dir/CMAQDAY/$Date1/$Date2/$Date3/00/d3/pm10 \</span><br><span class="line">$Dir/CMAQDAY/$Date1/$Date2/$Date3/00/d3/pm25 \</span><br><span class="line">$Dir/CMAQDAY/$Date1/$Date2/$Date3/00/d3/so2 &quot;</span><br><span class="line"></span><br><span class="line">NAQMPS_Dir=&quot;$Dir/NAQMPS/$Date1/$Date2/$Date3/00/d3/aqi \</span><br><span class="line">$Dir/NAQMPS/$Date1/$Date2/$Date3/00/d3/co \</span><br><span class="line">$Dir/NAQMPS/$Date1/$Date2/$Date3/00/d3/no2 \</span><br><span class="line">$Dir/NAQMPS/$Date1/$Date2/$Date3/00/d3/o3 \</span><br><span class="line">$Dir/NAQMPS/$Date1/$Date2/$Date3/00/d3/pm10 \</span><br><span class="line">$Dir/NAQMPS/$Date1/$Date2/$Date3/00/d3/pm25 \</span><br><span class="line">$Dir/NAQMPS/$Date1/$Date2/$Date3/00/d3/so2 &quot;</span><br><span class="line"></span><br><span class="line">NAQMPSDAY_Dir=&quot;$Dir/NAQMPSDAY/$Date1/$Date2/$Date3/00/d3/aqi \</span><br><span class="line">$Dir/NAQMPSDAY/$Date1/$Date2/$Date3/00/d3/co \</span><br><span class="line">$Dir/NAQMPSDAY/$Date1/$Date2/$Date3/00/d3/no2 \</span><br><span class="line">$Dir/NAQMPSDAY/$Date1/$Date2/$Date3/00/d3/o3 \</span><br><span class="line">$Dir/NAQMPSDAY/$Date1/$Date2/$Date3/00/d3/pm10 \</span><br><span class="line">$Dir/NAQMPSDAY/$Date1/$Date2/$Date3/00/d3/pm25 \</span><br><span class="line">$Dir/NAQMPSDAY/$Date1/$Date2/$Date3/00/d3/so2 &quot;</span><br><span class="line"></span><br><span class="line">Dir2=&quot;$WRF_Dir $WRFCHEM_Dir $WRFCHEMDAY_Dir $CAMX_Dir $CAMxDAY_Dir $CMAQ_WRF_Dir $CMAQDAY_Dir $NAQMPS_Dir $NAQMPSDAY_Dir&quot;</span><br><span class="line">for d in $Dir2</span><br><span class="line">do</span><br><span class="line">    if [ ! -d $d ]; then</span><br><span class="line">        echo &quot;$d 目录不存在&quot; &gt;&gt; /tmp/check_00tp_$Date4.txt</span><br><span class="line">    elif [ `ls $d |wc -l` -eq 0  ]; then</span><br><span class="line">        echo &quot;$d 目录下文件不存在&quot; &gt;&gt; /tmp/check_00tp_$Date4.txt</span><br><span class="line">    fi</span><br><span class="line">done</span><br><span class="line">mailx -s &quot;$Date4 00时 模型出图情况&quot; c@xx.com.cn &lt; /tmp/check_00tp_$Date4.txt</span><br></pre></td></tr></table></figure>

<h2 id="设置crontab"><a href="#设置crontab" class="headerlink" title="设置crontab"></a>设置crontab</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">01 13,17,01,04 * * * /data/tool/DRAW/shell/check_status/check_wrf.sh</span><br><span class="line">01 07 * * * /data/tool/DRAW/shell/check_status/check_00mx.sh</span><br><span class="line">01 08 * * * /data/tool/DRAW/shell/check_status/check_00tp.sh</span><br></pre></td></tr></table></figure>


<h1 id="另附短信发送脚本"><a href="#另附短信发送脚本" class="headerlink" title="另附短信发送脚本"></a>另附短信发送脚本</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">datedir1=`date +%Y%d`</span><br><span class="line">datedir2=`date +%Y%d%y`</span><br><span class="line">un=&quot;xxxxxxxx&quot;</span><br><span class="line">pw=&quot;xxxxxxxxxx&quot;</span><br><span class="line">phone=&quot;xxxxxxxxxxx&quot;</span><br><span class="line">msg=&quot;this is a test mes,please ignore&quot;</span><br><span class="line"></span><br><span class="line">if [ ! -d &quot;/data/em/data/GFS/$datedir1/$datedir2&quot; ];then</span><br><span class="line">    curl --data &quot;un=$un&amp;pw=$pw&amp;phone=$phone&amp;msg=$msg&amp;rd=1&quot; &quot;http://sms.253.com/msg/send&quot;</span><br><span class="line">    echo  -e &quot;\n query balance:&quot;</span><br><span class="line">    curl --data &quot;un=$un&amp;pw=$pw&quot; &quot;http://sms.253.com/msg/balance&quot;</span><br><span class="line">fi</span><br><span class="line">echo &quot;send sms:&quot;</span><br></pre></td></tr></table></figure>

<p>短信参考：<a href="https://www.253.com/api-docs-13.html">https://www.253.com/api-docs-13.html</a></p>
]]></content>
      <categories>
        <category>监控</category>
      </categories>
      <tags>
        <tag>监控</tag>
        <tag>mail</tag>
      </tags>
  </entry>
  <entry>
    <title>在已存在的目录中增加一层路径</title>
    <url>/arlo/ffa6a879/</url>
    <content><![CDATA[<p>由于之前项目上考虑不周，路径配置的有问题，现在需要在已有的目录中某一级增加一层目录，需要解决几个问题；</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/data/Model3/WeatherForecast/CAMX/2017/05/01/&#123;d1,d2,d3&#125;</span><br><span class="line">/data/Model3/WeatherForecast/CAMX/2017/05/01/00/&#123;d1,d2,d3&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>多级目录，多个参数，CAMX&#x2F;2017&#x2F;05&#x2F;01 这四个参数是变化的</li>
<li>判断父级目录是否存在，存在后增加一层目录</li>
<li>移动之前的数据到当前目录<span id="more"></span>
以下是我写的脚本，能满足使用，稍显繁琐，求优化！<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">dir=&#x27;/data/Model3/WeatherForecast&#x27;</span><br><span class="line">#dir1=&quot;NAQMPSDAY&quot;</span><br><span class="line">dir1=&quot;CAMX CAMxDAY CMAQDAY CMAQ.WRF NAQMPS NAQMPSDAY WRF WRFCHEM WRFCHEMDAY&quot;</span><br><span class="line">dir2=&quot;2016 2017&quot;</span><br><span class="line">for i1 in $dir1;</span><br><span class="line">do</span><br><span class="line">    for i2 in $dir2;</span><br><span class="line">    do</span><br><span class="line">        for i3 in &#123;01..12&#125;;</span><br><span class="line">        do</span><br><span class="line">            for i4 in &#123;01..31&#125;;</span><br><span class="line">            do</span><br><span class="line">                dir4=&quot;$dir/$i1/$i2/$i3/$i4&quot;</span><br><span class="line">#                echo $dir4</span><br><span class="line">                if [ -d $dir4 ];then</span><br><span class="line">                    cd $dir4</span><br><span class="line">                    mkdir $dir4/00</span><br><span class="line">                    mv d* $dir4/00</span><br><span class="line">                fi</span><br><span class="line">            done</span><br><span class="line">        done</span><br><span class="line">    done</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
以下是执行前后的效果对比图（使用tree -L 5 &gt; 2.txt生成）<br><img src="/images/2017/0525/01.png" alt="s"></li>
</ol>
]]></content>
      <categories>
        <category>常识</category>
      </categories>
      <tags>
        <tag>shell</tag>
        <tag>脚本</tag>
        <tag>linux常识</tag>
      </tags>
  </entry>
  <entry>
    <title>使用 Cobbler 自动化和管理系统安装</title>
    <url>/arlo/bb0f7c70/</url>
    <content><![CDATA[<p>Cobbler是一套快速搭建网络自动化安装操作系统的软件，个人感觉是PXE的升级版;提供cli和web两种管理方式，还提供API接口</p>
<span id="more"></span>
<p>系统环境：<br>Centos7_x64<br>Iptables off<br>Selinux  disabled</p>
<h1 id="Cobbler对象类型"><a href="#Cobbler对象类型" class="headerlink" title="Cobbler对象类型"></a>Cobbler对象类型</h1><p><strong>发行版（distro）</strong>：表示一个操作系统。它承载了内核和 initrd 的信息，以及内核参数等其他数据。<br><strong>配置文件（profile）</strong>：包含一个发行版、一个 kickstart 文件以及可能的存储库，还包含更多特定的内核参数等其他数据。<br><strong>系统（system）</strong>：表示要配给的机器。它包含一个配置文件或一个镜像，还包含 IP 和 MAC 地址、电源管理（地址、凭据、类型）以及更为专业的数据等信息。<br><strong>存储库（repository）</strong>：保存一个 yum 或 rsync 存储库的镜像信息。<br><strong>镜像（image）</strong>：可替换一个包含不属于此类别的文件的发行版对象（例如，无法分为内核和 initrd 的对象）。<br>基于注册的对象以及各个对象之间的关联，Cobbler 知道如何更改文件系统以反映具体配置。因为系统配置的内部是抽象的，所以您可以仅关注想要执行的操作。<br><img src="/images/2017/0420/00.png" alt="cobbler"></p>
<h1 id="Cobbler安装"><a href="#Cobbler安装" class="headerlink" title="Cobbler安装"></a>Cobbler安装</h1><h2 id="安装系统扩展包"><a href="#安装系统扩展包" class="headerlink" title="安装系统扩展包"></a>安装系统扩展包</h2><p>安装后报错可以参考<br><a href="http://islocal.cc/2017/04/06/yum-%E5%AE%89%E8%A3%85epel%E6%89%A9%E5%B1%95%E5%90%8E%E6%8A%A5%E9%94%99/">http://islocal.cc/2017/04/06/yum-安装epel扩展后报错/</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum -y install epel-release</span><br></pre></td></tr></table></figure>
<h2 id="安装需要的其他组件"><a href="#安装需要的其他组件" class="headerlink" title="安装需要的其他组件"></a>安装需要的其他组件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum -y install rsync tftp httpd pykickstart xinetd</span><br></pre></td></tr></table></figure>
<h2 id="安装cobbler程序包和fence代理包"><a href="#安装cobbler程序包和fence代理包" class="headerlink" title="安装cobbler程序包和fence代理包"></a>安装cobbler程序包和fence代理包</h2><p>fence代理包是执行电源管理活动的</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum -y install cobbler fence-agents</span><br></pre></td></tr></table></figure>
<h2 id="启动cobbler-服务"><a href="#启动cobbler-服务" class="headerlink" title="启动cobbler 服务"></a>启动cobbler 服务</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl start cobblerd httpd</span><br></pre></td></tr></table></figure>
<h2 id="检查配置文件"><a href="#检查配置文件" class="headerlink" title="检查配置文件"></a>检查配置文件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cobbler check</span><br></pre></td></tr></table></figure>
<p><img src="/images/2017/0420/01.png" alt="cobbler"></p>
<h3 id="Q1：修改cobbler服务器地址"><a href="#Q1：修改cobbler服务器地址" class="headerlink" title="Q1：修改cobbler服务器地址"></a>Q1：修改cobbler服务器地址</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">server: 192.168.6.103</span><br></pre></td></tr></table></figure>
<h3 id="Q2：修改dhcp服务器地址"><a href="#Q2：修改dhcp服务器地址" class="headerlink" title="Q2：修改dhcp服务器地址"></a>Q2：修改dhcp服务器地址</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">next_server: 192.168.6.103</span><br></pre></td></tr></table></figure>
<h3 id="Q3：修改-x2F-etc-x2F-selinux-x2F-config配置"><a href="#Q3：修改-x2F-etc-x2F-selinux-x2F-config配置" class="headerlink" title="Q3：修改&#x2F;etc&#x2F;selinux&#x2F;config配置"></a>Q3：修改&#x2F;etc&#x2F;selinux&#x2F;config配置</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELINUX=disabled</span><br></pre></td></tr></table></figure>
<h3 id="Q4：修改-x2F-etc-x2F-xinetd-d-x2F-tftp-配置"><a href="#Q4：修改-x2F-etc-x2F-xinetd-d-x2F-tftp-配置" class="headerlink" title="Q4：修改&#x2F;etc&#x2F;xinetd.d&#x2F;tftp 配置"></a>Q4：修改&#x2F;etc&#x2F;xinetd.d&#x2F;tftp 配置</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">disable	= no</span><br></pre></td></tr></table></figure>
<h3 id="Q5：下载需要的网络引导文件"><a href="#Q5：下载需要的网络引导文件" class="headerlink" title="Q5：下载需要的网络引导文件"></a>Q5：下载需要的网络引导文件</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cobbler get-loaders</span><br></pre></td></tr></table></figure>
<h3 id="Q6：启动并设置开机启动rsyncd服务"><a href="#Q6：启动并设置开机启动rsyncd服务" class="headerlink" title="Q6：启动并设置开机启动rsyncd服务"></a>Q6：启动并设置开机启动rsyncd服务</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl start rsyncd.service</span><br><span class="line">systemctl enable rsyncd.service</span><br></pre></td></tr></table></figure>
<h3 id="Q7：这个是基于debian操作系统的错误"><a href="#Q7：这个是基于debian操作系统的错误" class="headerlink" title="Q7：这个是基于debian操作系统的错误"></a>Q7：这个是基于debian操作系统的错误</h3><p>centos系统下忽略，不予处理</p>
<h3 id="Q8：修改安装系统后默认的root密码为’ffffff’"><a href="#Q8：修改安装系统后默认的root密码为’ffffff’" class="headerlink" title="Q8：修改安装系统后默认的root密码为’ffffff’"></a>Q8：修改安装系统后默认的root密码为’ffffff’</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">openssl passwd -1 -salt &#x27;random123&#x27; &#x27;ffffff&#x27;</span><br><span class="line">vim /etc/cobbler/settings</span><br><span class="line">default_password_crypted: &quot;$1$random12$KuDtGsOHnRfzasr7D4qI40&quot;</span><br></pre></td></tr></table></figure>
<h1 id="配置Cobbler"><a href="#配置Cobbler" class="headerlink" title="配置Cobbler"></a>配置Cobbler</h1><h2 id="编辑主配置文件"><a href="#编辑主配置文件" class="headerlink" title="编辑主配置文件"></a>编辑主配置文件</h2><p>vim &#x2F;etc&#x2F;cobbler&#x2F;settings</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">manage_dhcp: 1   </span><br><span class="line">manage_dns: 1</span><br><span class="line">manage_tftpd: 1</span><br><span class="line">restart_dns: 1</span><br><span class="line">restart_dhcp: 1</span><br><span class="line">pxe_just_once: 1</span><br><span class="line">next_server: &lt;dhcp服务器地址，即本机&gt;</span><br><span class="line">server:&lt;cobbler 服务器地址&gt;	</span><br></pre></td></tr></table></figure>
<p>以上部分选项之前已经配置或者默认选项已符合要求<br><strong>manage cobbler</strong>可以管理服务<br><strong>restart cobbler</strong> 可以重启服务<br><strong>pxe_just_once</strong> 预防将机器中的安装循环配置为始终从网络引导。激活此选项时，机器告诉 Cobbler 安装已完成</p>
<h2 id="指定cobbler管理服务使用的程序"><a href="#指定cobbler管理服务使用的程序" class="headerlink" title="指定cobbler管理服务使用的程序"></a>指定cobbler管理服务使用的程序</h2><p>vim &#x2F;etc&#x2F;cobbler&#x2F;modules.conf</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[dns]</span><br><span class="line">module = manage_dnsmasq</span><br><span class="line">[dhcp]</span><br><span class="line">module = manage_dnsmasq</span><br><span class="line">[tftpd]</span><br><span class="line">module = manage_in_tftpd</span><br></pre></td></tr></table></figure>
<h2 id="配置dhcp服务"><a href="#配置dhcp服务" class="headerlink" title="配置dhcp服务"></a>配置dhcp服务</h2><p>使用dnsmasq提供dns和dhcp服务<br>这里要保证dhcp设置的ip网段要和本机在同一网段，否则client找不到dhcp服务器</p>
<blockquote>
<p>通常，您希望阻止未注册的客户端从服务器引导。为此，添加参数 dhcp-ignore&#x3D;tag:!known。（在以前的版本中，语法可能有所不同：dhcp-ignore&#x3D;#known。如果有疑问，您可以同时插入两个版本。）</p>
</blockquote>
<p><code>vim /etc/cobbler/dnsmasq.template </code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dhcp-range=192.168.6.200,192.168.6.210,255.255.255.0</span><br></pre></td></tr></table></figure>
<h2 id="同步cobbler数据"><a href="#同步cobbler数据" class="headerlink" title="同步cobbler数据"></a>同步cobbler数据</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cobbler sync</span><br></pre></td></tr></table></figure>
<h2 id="重启服务"><a href="#重启服务" class="headerlink" title="重启服务"></a>重启服务</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl restart httpd cobblerd xinetd rsyncd dnsmasq</span><br></pre></td></tr></table></figure>
<p>客户机从网络启动，可以看到已经可以获取到ip地址了<br><img src="/images/2017/0420/02.png" alt="cobbler"></p>
<h1 id="创建操作系统"><a href="#创建操作系统" class="headerlink" title="创建操作系统"></a>创建操作系统</h1><h2 id="创建一个发行版本"><a href="#创建一个发行版本" class="headerlink" title="创建一个发行版本"></a>创建一个发行版本</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir /opt/centos6.9/</span><br><span class="line">mount -o loop /opt/CentOS-6.9-x86_64-bin-DVD1.iso /opt/centos6.9/</span><br><span class="line">cobbler import --path=/opt/centos6.9/ --name=&quot;Centos6.9&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/images/2017/0420/03.png" alt="cobbler"></p>
<h2 id="查看发行版本"><a href="#查看发行版本" class="headerlink" title="查看发行版本"></a>查看发行版本</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cobbler distro list</span><br><span class="line">cobbler distro report</span><br></pre></td></tr></table></figure>
<p><img src="/images/2017/0420/04.png" alt="cobbler"></p>
<h2 id="查看配置文件"><a href="#查看配置文件" class="headerlink" title="查看配置文件"></a>查看配置文件</h2><p>可以看到这里默认的ks文件是sample_end.ks</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cobbler profile list</span><br><span class="line">cobbler profile report</span><br></pre></td></tr></table></figure>
<p><img src="/images/2017/0420/05.png" alt="cobbler"></p>
<h2 id="使用自定义ks文件"><a href="#使用自定义ks文件" class="headerlink" title="使用自定义ks文件"></a>使用自定义ks文件</h2><ul>
<li>使用图形化system-config-kickstart工具创建ks文件</li>
<li>使用系统生成的ks文件模板修改<br>kiskstart 文件内容<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># kickstart template for Fedora 8 and later.</span><br><span class="line"># (includes %end blocks)</span><br><span class="line"># do not use with earlier distros</span><br><span class="line"></span><br><span class="line">#platform=x86, AMD64, or Intel EM64T</span><br><span class="line"># System authorization information</span><br><span class="line">auth  --useshadow  --enablemd5</span><br><span class="line"># System bootloader configuration</span><br><span class="line">bootloader --location=mbr</span><br><span class="line"># Partition clearing information</span><br><span class="line">clearpart --all --initlabel</span><br><span class="line"># Use text mode install</span><br><span class="line">text</span><br><span class="line"># Firewall configuration</span><br><span class="line">firewall --disable</span><br><span class="line"># Run the Setup Agent on first boot</span><br><span class="line">firstboot --disable</span><br><span class="line"># System keyboard</span><br><span class="line">keyboard us</span><br><span class="line"># System language</span><br><span class="line">lang en_US</span><br><span class="line"># Use network installation</span><br><span class="line">url --url=$tree</span><br><span class="line"># If any cobbler repo definitions were referenced in the kickstart profile, include them here.</span><br><span class="line">$yum_repo_stanza</span><br><span class="line"># Network information</span><br><span class="line">$SNIPPET(&#x27;network_config&#x27;)</span><br><span class="line"># Reboot after installation</span><br><span class="line">reboot</span><br><span class="line"></span><br><span class="line">#Root password</span><br><span class="line">rootpw --iscrypted $default_password_crypted</span><br><span class="line"># SELinux configuration</span><br><span class="line">selinux --disabled</span><br><span class="line"># Do not configure the X Window System</span><br><span class="line">skipx</span><br><span class="line"># System timezone</span><br><span class="line">timezone  Asia/Shanghai</span><br><span class="line"># Install OS instead of upgrade</span><br><span class="line">install</span><br><span class="line"># Clear the Master Boot Record</span><br><span class="line">zerombr</span><br><span class="line"># Allow anaconda to partition the system as needed</span><br><span class="line">autopart</span><br><span class="line"></span><br><span class="line">%pre</span><br><span class="line">$SNIPPET(&#x27;log_ks_pre&#x27;)</span><br><span class="line">$SNIPPET(&#x27;kickstart_start&#x27;)</span><br><span class="line">$SNIPPET(&#x27;pre_install_network_config&#x27;)</span><br><span class="line"># Enable installation monitoring</span><br><span class="line">$SNIPPET(&#x27;pre_anamon&#x27;)</span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%packages</span><br><span class="line">$SNIPPET(&#x27;func_install_if_enabled&#x27;)</span><br><span class="line">@base</span><br><span class="line">@development</span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%post --nochroot</span><br><span class="line">$SNIPPET(&#x27;log_ks_post_nochroot&#x27;)</span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%post</span><br><span class="line">$SNIPPET(&#x27;log_ks_post&#x27;)</span><br><span class="line"># Start yum configuration</span><br><span class="line">$yum_config_stanza</span><br><span class="line"># End yum configuration</span><br><span class="line">$SNIPPET(&#x27;post_install_kernel_options&#x27;)</span><br><span class="line">$SNIPPET(&#x27;post_install_network_config&#x27;)</span><br><span class="line">$SNIPPET(&#x27;func_register_if_enabled&#x27;)</span><br><span class="line">$SNIPPET(&#x27;download_config_files&#x27;)</span><br><span class="line">$SNIPPET(&#x27;koan_environment&#x27;)</span><br><span class="line">$SNIPPET(&#x27;redhat_register&#x27;)</span><br><span class="line">$SNIPPET(&#x27;cobbler_register&#x27;)</span><br><span class="line"># Enable post-install boot notification</span><br><span class="line">$SNIPPET(&#x27;post_anamon&#x27;)</span><br><span class="line"># Start final steps</span><br><span class="line">$SNIPPET(&#x27;kickstart_done&#x27;)</span><br><span class="line"># End final steps</span><br><span class="line">%end</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="添加一个profile"><a href="#添加一个profile" class="headerlink" title="添加一个profile"></a>添加一个profile</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cobbler profile add --distro=&quot;Centos6.9-x86_64&quot; --name=centos6.9_customized \</span><br><span class="line">--kickstart=/var/lib/cobbler/kickstarts/CentOS6.9_cust.cfg</span><br></pre></td></tr></table></figure>
<h3 id="修改已有的profile"><a href="#修改已有的profile" class="headerlink" title="修改已有的profile"></a>修改已有的profile</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cobbler profile edit --name=centos6.9_customized --kickstart=/var/lib/cobbler/kickstarts/CentOS6.9_cust.cfg</span><br></pre></td></tr></table></figure>
<h2 id="添加第三方yum仓库"><a href="#添加第三方yum仓库" class="headerlink" title="添加第三方yum仓库"></a>添加第三方yum仓库</h2><p>这一步好像有点问题会报错，网上资料说这是一个bug</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cobbler repo add --name=163mirrors --mirror=http://mirrors.163.com/centos/6.9/os/x86_64/</span><br><span class="line">cobbler reposync</span><br><span class="line">cobbler repo report</span><br></pre></td></tr></table></figure>
<p>将仓库文件与配置文件（profile）关联起来</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cobbler profile edit --name=Centos6.9-x86_64 --repos=163mirros</span><br></pre></td></tr></table></figure>
<h1 id="安装web管理界面"><a href="#安装web管理界面" class="headerlink" title="安装web管理界面"></a>安装web管理界面</h1><h2 id="安装cobbler-web包"><a href="#安装cobbler-web包" class="headerlink" title="安装cobbler-web包"></a>安装cobbler-web包</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum -y install cobbler-web</span><br></pre></td></tr></table></figure>
<h2 id="Cobbler-Web-界面的身份验证和授权配置"><a href="#Cobbler-Web-界面的身份验证和授权配置" class="headerlink" title="Cobbler Web 界面的身份验证和授权配置"></a>Cobbler Web 界面的身份验证和授权配置</h2><p>&#x2F;etc&#x2F;cobbler&#x2F;modules.conf </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[authentication]</span><br><span class="line">module = authn_pam</span><br><span class="line">[authorization] = authz_ownership</span><br></pre></td></tr></table></figure>
<h2 id="新建系统账号并设置密码"><a href="#新建系统账号并设置密码" class="headerlink" title="新建系统账号并设置密码"></a>新建系统账号并设置密码</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">useradd cobbler </span><br><span class="line">echo &quot;cobbler&quot; | passwd --stdin cobbler</span><br></pre></td></tr></table></figure>
<h2 id="添加用户到管理组"><a href="#添加用户到管理组" class="headerlink" title="添加用户到管理组"></a>添加用户到管理组</h2><p>vim &#x2F;etc&#x2F;cobbler&#x2F;users.conf</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[admins]</span><br><span class="line">admin = &quot;cobbler&quot;</span><br></pre></td></tr></table></figure>
<h2 id="重启服务-1"><a href="#重启服务-1" class="headerlink" title="重启服务"></a>重启服务</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl restart cobblerd httpd</span><br></pre></td></tr></table></figure>
<h2 id="使用https-url访问"><a href="#使用https-url访问" class="headerlink" title="使用https url访问"></a>使用https url访问</h2><p><a href="https://192.168.6.103/cobbler_web">https://192.168.6.103/cobbler_web</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">user：cobbler</span><br><span class="line">passwd：cobbler</span><br></pre></td></tr></table></figure>
<p><img src="/images/2017/0420/06.png" alt="cobbler"></p>
<h1 id="安装操作系统"><a href="#安装操作系统" class="headerlink" title="安装操作系统"></a>安装操作系统</h1><ol>
<li>开机</li>
<li>选择从网络引导，dhcp获取ip地址</li>
<li>选择profile，通过tftp获取引导内核文件</li>
<li>调用ks文件进行无人值守安装操作系统<br><img src="/images/2017/0420/07.png" alt="cobbler"></li>
</ol>
<h1 id="重装操作系统"><a href="#重装操作系统" class="headerlink" title="重装操作系统"></a>重装操作系统</h1><p>这个是针对已经安装操作系统的服务器进行重新安装，个人感觉这种方式除了不用调整从网络启动之外，没看出来比较实用的特性</p>
<h2 id="在客户端机器安装koan软件"><a href="#在客户端机器安装koan软件" class="headerlink" title="在客户端机器安装koan软件"></a>在客户端机器安装koan软件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum -y install epel</span><br><span class="line">yum -y install koan</span><br></pre></td></tr></table></figure>
<h2 id="Koan-用法"><a href="#Koan-用法" class="headerlink" title="Koan 用法"></a>Koan 用法</h2><p>查看cobbler server 上的profile文件列表</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">koan --server=192.168.6.250 --list=profiles</span><br></pre></td></tr></table></figure>
<p>查看profile详细信息</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">koan --server=192.168.6.250 --display --profile=Centos6.9-x86_64</span><br></pre></td></tr></table></figure>
<p>下次重启时重装操作系统</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">koan --server=192.168.6.250 -replace-self --profile=Centos6.9-x86_64</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>
<h1 id="安装windows操作系统"><a href="#安装windows操作系统" class="headerlink" title="安装windows操作系统"></a>安装windows操作系统</h1><h2 id="制作PE-iso镜像"><a href="#制作PE-iso镜像" class="headerlink" title="制作PE iso镜像"></a>制作PE iso镜像</h2><p>下载一个**<a href="http://www.wepe.com.cn/">PE系统</a>**<br>上传至cobbler服务器&#x2F;data目录</p>
<h2 id="创建一个distro"><a href="#创建一个distro" class="headerlink" title="创建一个distro"></a>创建一个distro</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cobbler distro add --name=&quot;WePe_x64&quot; --kernel=/var/lib/tftpboot/memdisk --initrd=/data/WePE_64_V2.0.iso --kopts=&quot;raw iso&quot;</span><br></pre></td></tr></table></figure>
<h2 id="创建空白kickstart文件，并对winPE发行版添加profile"><a href="#创建空白kickstart文件，并对winPE发行版添加profile" class="headerlink" title="创建空白kickstart文件，并对winPE发行版添加profile"></a>创建空白kickstart文件，并对winPE发行版添加profile</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">touch /var/lib/cobbler/kickstarts/WePe_x64.xml</span><br><span class="line">cobbler profile add --name=WePe_x64 --distro=WePe_x64 --kickstart=/var/lib/cobbler/kickstarts/WePe_x64.xml</span><br></pre></td></tr></table></figure>
<h2 id="同步cobbler"><a href="#同步cobbler" class="headerlink" title="同步cobbler"></a>同步cobbler</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cobbler sync</span><br></pre></td></tr></table></figure>
<p>windows 操作系统安装这个，目前只是做了一个网络版的PE，网上有教程说使用samba共享镜像，我这里没有成功，可以参考**<a href="http://www.zhouweiping.cn/index.php/archives/30/#windows%E7%B3%BB%E7%BB%9F%E5%AE%89%E8%A3%85">这篇文章</a>**;到这里一个最基本的cobbler自动化安装操作系统的环境就搭建完成了，只是完成了distro和profile部分，后期在学习system部分。</p>
<p>参考资料：<br><a href="https://www.ibm.com/developerworks/cn/linux/l-cobbler/">https://www.ibm.com/developerworks/cn/linux/l-cobbler/</a><br><a href="http://blog.codecp.org/2016/11/02/Centos7%E9%83%A8%E7%BD%B2cobbler/">http://blog.codecp.org/2016/11/02/Centos7部署cobbler/</a></p>
<hr>
]]></content>
      <categories>
        <category>自动化运维</category>
      </categories>
      <tags>
        <tag>运维</tag>
        <tag>自动化</tag>
        <tag>Cobbler</tag>
      </tags>
  </entry>
  <entry>
    <title>搭建ftp服务器并配置虚拟用户登录</title>
    <url>/arlo/5cd2f164/</url>
    <content><![CDATA[<p>vsftpd 是“very secure FTP daemon”的缩写，安全性是它的一个最大的特点。<br>本次搭建ftp服务器，采用虚拟用户登录；所谓虚拟用户就是没有使用真实的系统用户，只是通过映射到真实的账户和设置权限的目的。虚拟用户不能登录操作系统。</p>
<span id="more"></span>
<h1 id="系统环境"><a href="#系统环境" class="headerlink" title="系统环境"></a>系统环境</h1><p>CentOS 6.9<br>SELinux disabled</p>
<h1 id="软件安装"><a href="#软件安装" class="headerlink" title="软件安装"></a>软件安装</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum -y install db4 db4-utils vsftpd </span><br></pre></td></tr></table></figure>
<h1 id="创建虚拟用户的宿主用户"><a href="#创建虚拟用户的宿主用户" class="headerlink" title="创建虚拟用户的宿主用户"></a>创建虚拟用户的宿主用户</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">useradd -u 600 -d /data/ftproot -s /sbin/nologin slvftp</span><br></pre></td></tr></table></figure>
<h1 id="创建用户名密码文件"><a href="#创建用户名密码文件" class="headerlink" title="创建用户名密码文件"></a>创建用户名密码文件</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim account.txt</span><br><span class="line">slftp1</span><br><span class="line">xxxxxx</span><br><span class="line">slftp2</span><br><span class="line">yyyyyy</span><br></pre></td></tr></table></figure>
<h1 id="生成虚拟用户认证文件"><a href="#生成虚拟用户认证文件" class="headerlink" title="生成虚拟用户认证文件"></a>生成虚拟用户认证文件</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">db_load -T -t hash -f ./account.txt /etc/vsftpd/account.db</span><br><span class="line">#安全原因，修改认证文件权限</span><br><span class="line">chmod 600 /etc/vsftpd/account.db</span><br><span class="line">#执行完此操作，建议删除account.txt</span><br></pre></td></tr></table></figure>
<h1 id="配置认证文件"><a href="#配置认证文件" class="headerlink" title="配置认证文件"></a>配置认证文件</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/pam.d/vsftpd.sl</span><br><span class="line">auth required /lib64/security/pam_userdb.so db=/etc/vsftpd/account</span><br><span class="line">account required /lib64/security/pam_userdb.so db=/etc/vsftpd/account</span><br><span class="line">#我这里是64位的操作系统，写的是/lib64,如果是32位的操作系统，写成/lib即可</span><br></pre></td></tr></table></figure>
<h1 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/vsftpd/vsftpd.conf</span><br><span class="line">#虚拟用户权限与匿名用户权限相同，虚拟用户权限单独设定</span><br><span class="line">virtual_use_local_privs=NO</span><br><span class="line">#服务器独立运行</span><br><span class="line">listen=YES</span><br><span class="line">#设定不允许匿名访问</span><br><span class="line">anonymous_enable=NO</span><br><span class="line">#设定本地用户可以访问。注：如使用虚拟宿主用户，在该项目设定为NO的情况下所有虚拟用户将无法访问</span><br><span class="line">local_enable=YES</span><br><span class="line">#使用户不能离开主目录</span><br><span class="line">chroot_list_enable=YES</span><br><span class="line">chroot_list_enable=YES</span><br><span class="line">chroot_list_file=/etc/vsftpd/chroot_list</span><br><span class="line">#设定支持ASCII模式的上传和下载功能</span><br><span class="line">ascii_upload_enable=YES</span><br><span class="line">ascii_download_enable=YES</span><br><span class="line">#PAM认证文件名。PAM将根据/etc/pam.d/vsftpd.sl进行认证</span><br><span class="line">pam_service_name=vsftpd.sl</span><br><span class="line">#设定启用虚拟用户功能</span><br><span class="line">guest_enable=YES</span><br><span class="line">#指定虚拟用户的宿主用户，CentOS中已经有内置的ftp用户了</span><br><span class="line">guest_username=slvftp</span><br><span class="line">#设定虚拟用户个人vsftp的CentOS FTP服务文件存放路径。存放虚拟用户个性的CentOS FTP服务文件(配置文件名=虚拟用户名)</span><br><span class="line">user_config_dir=/etc/vsftpd/user_config/</span><br><span class="line">#配置vsftpd日志（可选）</span><br><span class="line">xferlog_enable=YES</span><br><span class="line">xferlog_std_format=YES</span><br><span class="line">xferlog_file=/var/log/xferlog</span><br><span class="line">dual_log_enable=YES</span><br><span class="line">vsftpd_log_file=/var/log/vsftpd.log</span><br><span class="line">#开启被动(PASV)模式</span><br><span class="line">pasv_enable=yes</span><br><span class="line">pasv_min_port=10240</span><br><span class="line">pasv_max_port=10250</span><br></pre></td></tr></table></figure>
<h1 id="新建chroot-list空文件"><a href="#新建chroot-list空文件" class="headerlink" title="新建chroot_list空文件"></a>新建chroot_list空文件</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">touch /etc/vsftpd/chroot_list</span><br></pre></td></tr></table></figure>
<h1 id="创建虚拟用户的配置目录文件"><a href="#创建虚拟用户的配置目录文件" class="headerlink" title="创建虚拟用户的配置目录文件"></a>创建虚拟用户的配置目录文件</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir /etc/vsftpd/user_config/</span><br><span class="line">#虚拟用户配置文件名必须与用户名一致</span><br><span class="line">vim /etc/vsftpd/user_config/slftp1</span><br><span class="line">guest_username=slvftp #虚拟用户的宿主用户</span><br><span class="line">local_root=/data/ftproot/slftp1  #虚拟用户根目录</span><br><span class="line">local_enable=YES</span><br><span class="line">write_enable=YES  #写权限</span><br><span class="line">anon_umask=022</span><br><span class="line">anon_world_readable_only=NO</span><br><span class="line">anon_upload_enable=YES #上传权限</span><br><span class="line">anon_mkdir_write_enable=YES  #创建文件夹权限</span><br><span class="line">anon_other_write_enable=YES  #其他权限</span><br><span class="line">##############</span><br><span class="line">vim /etc/vsftpd/user_config/slftp2</span><br><span class="line">guest_username=slvftp</span><br><span class="line">local_root=/data/ftproot/slftp2</span><br><span class="line">local_enable=YES</span><br><span class="line">write_enable=YES</span><br><span class="line">anon_umask=022</span><br><span class="line">anon_world_readable_only=NO</span><br><span class="line">anon_upload_enable=YES</span><br><span class="line">anon_mkdir_write_enable=YES</span><br><span class="line">anon_other_write_enable=YES</span><br></pre></td></tr></table></figure>
<h1 id="创建ftp根目录"><a href="#创建ftp根目录" class="headerlink" title="创建ftp根目录"></a>创建ftp根目录</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir -pv /data/ftproot/slftp&#123;1,2&#125;</span><br><span class="line">chmod 700 -R /data/ftproot</span><br><span class="line">chown slvftp.slvftp -R /data/ftproot</span><br></pre></td></tr></table></figure>
<h1 id="重启vsftp服务"><a href="#重启vsftp服务" class="headerlink" title="重启vsftp服务"></a>重启vsftp服务</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/etc/init.d/vsftpd restart</span><br></pre></td></tr></table></figure>
<h1 id="防火墙开放端口"><a href="#防火墙开放端口" class="headerlink" title="防火墙开放端口"></a>防火墙开放端口</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT </span><br><span class="line">iptables -A INPUT -p icmp -j ACCEPT </span><br><span class="line">iptables -A INPUT -i lo -j ACCEPT </span><br><span class="line">iptables -A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT</span><br><span class="line">#主要是下边这两条</span><br><span class="line">iptables -A INPUT -m state --state NEW -m tcp -p tcp --dport 21 -j ACCEPT</span><br><span class="line">iptables -A INPUT -m state --state NEW -m tcp -p tcp --dport 10240:10250 -j ACCEPT</span><br><span class="line">#所有允许规则应该在这条之前</span><br><span class="line">iptables -A INPUT -j REJECT --reject-with icmp-host-prohibited</span><br></pre></td></tr></table></figure>
<h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum -y install lftp</span><br><span class="line">lftp user:passwd@127.0.0.1</span><br></pre></td></tr></table></figure>
<p><img src="/images/2017/1206/01.png" alt="ftp"><br>参考文档：<a href="https://dumplings.cc/bu-shu-vsftpyu-pei-zhi-xu-ni-yong-hu-deng-lu/">https://dumplings.cc/bu-shu-vsftpyu-pei-zhi-xu-ni-yong-hu-deng-lu/</a></p>
]]></content>
      <categories>
        <category>服务器搭建</category>
      </categories>
      <tags>
        <tag>ftp</tag>
        <tag>vsftp</tag>
        <tag>服务器</tag>
      </tags>
  </entry>
  <entry>
    <title>CentOS7 Firewall防火墙的简单使用</title>
    <url>/arlo/f5791b33/</url>
    <content><![CDATA[<p>FirewallD 是 CentOS 7 服务器上默认可用的防火墙管理工具。基本上，它是 iptables 的封装，有图形配置工具 firewall-config 和命令行工具 <code>firewall-cmd</code>。使用 iptables 服务，每次改动都要求刷新旧规则，并且从 <code>/etc/sysconfig/iptables</code> 读取新规则，然而 firewalld 只应用改动了的不同部分。</p>
<span id="more"></span>

<h1 id="防火墙基本操作"><a href="#防火墙基本操作" class="headerlink" title="防火墙基本操作"></a>防火墙基本操作</h1><h2 id="查询防火墙状态"><a href="#查询防火墙状态" class="headerlink" title="查询防火墙状态"></a>查询防火墙状态</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">firewall-cmd --state   # 显示firewalld的状态；</span><br><span class="line">systemctl status firewalld # 显示firewalld的状态；</span><br><span class="line">firewall-cmd --zone=public --list-all	#查询public区域的所有信息</span><br><span class="line">firewall-cmd --zone=public --list-ports	#查询public区域放行的端口信息</span><br><span class="line">firewall-cmd --zone=public --list-services	#查询public区域放行的服务信息</span><br></pre></td></tr></table></figure>

<h2 id="应急模式"><a href="#应急模式" class="headerlink" title="应急模式"></a>应急模式</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">firewall-cmd --query-panic  # 查看是否为应急模式</span><br><span class="line">firewall-cmd --panic-on  # 拒绝所有包，远程连接会立即断开，只有本地能登陆</span><br><span class="line">firewall-cmd --panic-off  # 取消拒绝状态，但需要重启firewalld后才可以远程ssh</span><br></pre></td></tr></table></figure>

<h2 id="启动、关闭防火墙"><a href="#启动、关闭防火墙" class="headerlink" title="启动、关闭防火墙"></a>启动、关闭防火墙</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl start firewalld	#启动防火墙</span><br><span class="line">systemctl enable firewalld	#开机自启动</span><br><span class="line">systemctl stop firewalld	#关闭防火墙</span><br><span class="line">systemctl disable firewalld	#关闭开机自启动</span><br></pre></td></tr></table></figure>

<h2 id="重新加载防火墙设置"><a href="#重新加载防火墙设置" class="headerlink" title="重新加载防火墙设置"></a>重新加载防火墙设置</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">firewall-cmd --reload	#不中断用户连接</span><br><span class="line">firewall-cmd --complete-reload	#中断用户连接</span><br><span class="line">firewall-cmd --runtime-to-permanent	#将当前防火墙的规则永久保存</span><br><span class="line">firewall-cmd --check-config	# 检查配置正确性</span><br></pre></td></tr></table></figure>

<h1 id="区域"><a href="#区域" class="headerlink" title="区域"></a>区域</h1><p>FirewallD 使用服务(service )和区域(zone)来代替 iptables 的规则(rule)和链(chain)。</p>
<p>默认情况下，有以下的区域(zone)可用:</p>
<table>
<thead>
<tr>
<th><strong>drop</strong></th>
<th>丢弃所有传入的网络数据包并且无回应，只有传出网络连接可用</th>
</tr>
</thead>
<tbody><tr>
<td><strong>block</strong></td>
<td>拒绝所有传入网络数据包并回应一条主机禁止的 ICMP 消息，只有传出网络连接可用。</td>
</tr>
<tr>
<td><strong>public</strong></td>
<td>只接受被选择的传入网络连接，用于公共区域。</td>
</tr>
<tr>
<td><strong>external</strong></td>
<td>用于启用了地址伪装的外部网络，只接受选定的传入网络连接</td>
</tr>
<tr>
<td><strong>dmz</strong></td>
<td>DMZ 隔离区，外部受限地访问内部网络，只接受选定的传入网络连接</td>
</tr>
<tr>
<td><strong>work</strong></td>
<td>对于处在你工作区域内的计算机，只接受被选择的传入网络连接</td>
</tr>
<tr>
<td><strong>home</strong></td>
<td>对于处在你家庭区域内的计算机，只接受被选择的传入网络连接</td>
</tr>
<tr>
<td><strong>internal</strong></td>
<td>对于处在你内部网络的计算机，只接受被选择的传入网络连接</td>
</tr>
<tr>
<td><strong>trusted</strong></td>
<td>所有网络连接都接受</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">firewall-cmd --get-zones	#列出所有可用的区域</span><br><span class="line">firewall-cmd --get-default-zone	#列出默认的区域</span><br><span class="line">firewall-cmd --set-default-zone=dmz	#设置默认的区域</span><br><span class="line">firewall-cmd --get-zone-of-interface=ens33	#查看指定接口所属区域</span><br><span class="line">firewall-cmd --zone=dmz --change-interface=ens33	#永久修改网络接口ens33为dmz区域</span><br><span class="line">firewall-cmd --zone=dmz --remove-interface=ens33	#删除绑定在ens33接口上的Zone网络区</span><br></pre></td></tr></table></figure>

<h1 id="端口管理"><a href="#端口管理" class="headerlink" title="端口管理"></a>端口管理</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 查询打开的端口</span><br><span class="line">firewall-cmd --list-ports</span><br><span class="line"></span><br><span class="line">#放行</span><br><span class="line">firewall-cmd --add-port=portid[-portid]/protocol [--permanent] [--zone=zone]</span><br><span class="line">firewall-cmd --add-port=80/tcp  --zone=public --permanent</span><br><span class="line">参数(portid[-portid]):要开放的端口号，如果是一个范围则使用10000-12000表达一个范围。</span><br><span class="line">参数(protocol):TCP/UDP协议</span><br><span class="line">可选参数(zone):将规则添加到哪个Zone网络区中，如果缺省该参数则添加到默认Zone网络区中。</span><br><span class="line">可选选项(–permanent):规则永久保存，重新加载防火墙后生效。如果缺省该参数则修改的规则立即生效，但是重新加载防火墙后规则会失效。</span><br><span class="line"></span><br><span class="line">#移除</span><br><span class="line">firewall-cmd --remove-service=https [--permanent] [--zone=zone]</span><br><span class="line">firewall-cmd  --zone=public --remove-port=80/tcp --permanent </span><br><span class="line"></span><br><span class="line"># 加载配置文件、使规则生效</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<h1 id="服务管理"><a href="#服务管理" class="headerlink" title="服务管理"></a>服务管理</h1><p>FirewallD 服务使用 XML 配置文件，记录了 firewalld 服务信息，XML 配置文件存储在 <code>/usr/lib/firewalld/services/</code> 和 <code>/etc/firewalld/services/</code> 目录下。</p>
<h2 id="查询服务"><a href="#查询服务" class="headerlink" title="查询服务"></a>查询服务</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">firewall-cmd --get-services	#查询所有支持的服务</span><br><span class="line">firewall-cmd --add-service=telnet	#添加服务</span><br><span class="line">firewall-cmd --list-services	#查询放行的服务</span><br><span class="line">firewall-cmd --permanent --service=telnet --get-port	#查看服务对应的端口号</span><br></pre></td></tr></table></figure>

<h2 id="禁ping"><a href="#禁ping" class="headerlink" title="禁ping"></a>禁ping</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># tcp/ip实现方式</span><br><span class="line">echo &quot;1&quot; &gt;  /proc/sys/net/ipv4/icmp_echo_ignore_all 或</span><br><span class="line">sysctl -w net.ipv4.icmp_echo_ignore_all=1</span><br><span class="line"></span><br><span class="line"># firewalld实现方式</span><br><span class="line">firewall-cmd --permanent --add-icmp-block=echo-request #开启禁ping</span><br><span class="line">firewall-cmd --permanent --remove-icmp-block=echo-request	#关闭禁ping</span><br><span class="line">firewall-cmd --reload</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="放行-x2F-关闭服务"><a href="#放行-x2F-关闭服务" class="headerlink" title="放行&#x2F;关闭服务"></a>放行&#x2F;关闭服务</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#放行</span><br><span class="line">firewall-cmd --add-service=service [--permanent] [--zone=zone] [--timeout=timeval]</span><br><span class="line">例：firewall-cmd --add-service=zabbix-agent --zone=public --permanent</span><br><span class="line"></span><br><span class="line">参数(–-add-service):要放行的服务名，如ssh、http、https。</span><br><span class="line">可选参数(–-zone=zone)：将此规则添加到网络区，如果缺省该参数，添加到默认网络区内。</span><br><span class="line">可选参数(–-timeout=timeval)：临时生效时间，不可与--permanent连用。表达方式可以是--timeout=[100s | 100m | 100h]。(timeval is either a number (of seconds) or number followed by one of characters s(seconds), m(minutes), h(hours))</span><br><span class="line">可选选项(–permanent)：规则永久保存，重新加载防火墙后生效。如果缺省该参数则修改的规则立即生效，但是重新加载防火墙后规则会失效。</span><br><span class="line">#移除</span><br><span class="line">firewall-cmd --remove-service=service [--permanent] [--zone=zone]</span><br><span class="line">firewall-cmd --remove-service=zabbix-agent --zone=public --permanent</span><br><span class="line"></span><br><span class="line"># 加载配置文件、使规则生效</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<h1 id="端口转发"><a href="#端口转发" class="headerlink" title="端口转发"></a>端口转发</h1><p>端口转发可以将指定地址访问指定的端口时，将流量转发至指定地址的指定端口。转发的目的如果不指定 ip 的话就默认为本机，如果指定了 ip 却没指定端口，则默认使用来源端口。 如果配置好端口转发之后不能用，可以检查下面两个问题：</p>
<ul>
<li>比如我将 80 端口转发至 8080 端口，首先检查本地的 80 端口和目标的 8080 端口是否开放监听了</li>
<li>其次检查是否允许伪装 IP，没允许的话要开启伪装 IP</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">firewall-cmd --query-masquerade	# 检查是否允许伪装IP</span><br><span class="line">firewall-cmd --add-masquerade   # 允许防火墙伪装IP(转发到其他IP上时必须开启，仅转发本地端口则非必须开启)</span><br><span class="line">firewall-cmd --remove-masquerade # 禁止防火墙伪装IP</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">firewall-cmd --add-forward-port=port=[访问端口]:协议=[tcp/udp]:toaddr=[需要转发的主机地址]:toport=[需要转发的端口]</span><br><span class="line"></span><br><span class="line">firewall-cmd --add-forward-port=port=80:proto=tcp:toport=8080   # 将80端口的流量转发至8080</span><br><span class="line">firewall-cmd --add-forward-port=port=80:proto=tcp:toaddr=192.168.0.1 # 将80端口的流量转发至192.168.0.1</span><br><span class="line">firewall-cmd --add-forward-port=port=80:proto=tcp:toaddr=192.168.0.1:toport=8080 # 将80端口的流量转发至192.168.0.1的8080端口</span><br></pre></td></tr></table></figure>

<ul>
<li>当我们想把某个端口隐藏起来的时候，就可以在防火墙上阻止那个端口访问，然后再开一个不规则的端口，之后配置防火墙的端口转发，将流量转发过去。</li>
<li>端口转发还可以做流量分发，一个防火墙拖着好多台运行着不同服务的机器，然后用防火墙将不同端口的流量转发至不同机器。</li>
</ul>
<hr>
<p>参考链接：</p>
<p><a href="https://wangchujiang.com/linux-command/c/firewall-cmd.html">https://wangchujiang.com/linux-command/c/firewall-cmd.html</a></p>
<p><a href="https://blog.yeefire.com/2020_02/Linux_Firewalld.html">https://blog.yeefire.com/2020_02/Linux_Firewalld.html</a></p>
]]></content>
      <categories>
        <category>安全</category>
      </categories>
      <tags>
        <tag>firewall</tag>
        <tag>防火墙</tag>
      </tags>
  </entry>
  <entry>
    <title>Ansible批量升级ssh版本至OpenSSH8.6p1</title>
    <url>/arlo/e5610d8d/</url>
    <content><![CDATA[<h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><ul>
<li>本文<del>参考</del>（抄）自：<a href="https://blog.csdn.net/rookie23rook/article/details/111691267">https://blog.csdn.net/rookie23rook/article/details/111691267</a></li>
<li>需要准备好yum源，最好是服务器可以直接连接互联网</li>
<li>本次是基于openssl 1.0.2k，OpenSSH_7.4.1p1的升级，其他版本可能会有问题</li>
<li>配置ansible免密或者在&#x2F;etc&#x2F;ansible&#x2F;hosts配置文件中写入密码，关于ansible的基础配置，可以看参考<a href="http://islocal.cc/arlo/40fad05f/">http://islocal.cc/arlo/40fad05f/</a></li>
</ul>
<p>我这里测试使用了一台机器</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># egrep -v &quot;^#|^$&quot; /etc/ansible/hosts </span><br><span class="line">[server]</span><br><span class="line">192.168.100.133 ansible_ssh_pass=f ansible_ssh_user=root</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<h1 id="Playbook文件结构"><a href="#Playbook文件结构" class="headerlink" title="Playbook文件结构"></a>Playbook文件结构</h1><p>这里是升级openssh的目录结构及所需文件。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@c71 roles]# pwd</span><br><span class="line">/etc/ansible/roles</span><br><span class="line">[root@c71 roles]# tree update_openssh/</span><br><span class="line">update_openssh/</span><br><span class="line">├── files</span><br><span class="line">│   ├── openssh-8.6p1.tar.gz</span><br><span class="line">│   └── openssl-1.1.1k.tar.gz</span><br><span class="line">├── handlers</span><br><span class="line">│   └── main.yaml</span><br><span class="line">├── tasks</span><br><span class="line">│   ├── install.yaml</span><br><span class="line">│   └── main.yaml</span><br><span class="line">├── update_openssh.yaml</span><br><span class="line">└── vars</span><br><span class="line">    └── main.yaml</span><br><span class="line"></span><br><span class="line">4 directories, 8 files</span><br></pre></td></tr></table></figure>

<p>下载openssl-1.1.1k.tar.gz，openssh-8.6p1.tar.gz两个文件到files目录下</p>
<p>Openssl 下载地址：<code>https://ftp.openssl.org/source/</code></p>
<p>Openssh 下载地址：<code>https://ftp.openbsd.org/pub/OpenBSD/OpenSSH/portable/</code></p>
<h2 id="update-openssh-yaml"><a href="#update-openssh-yaml" class="headerlink" title="update_openssh.yaml"></a>update_openssh.yaml</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@c71 update_openssh]# cat update_openssh.yaml </span><br><span class="line">---</span><br><span class="line">- name: 升级openssh版本到openssh8.6p1</span><br><span class="line">  hosts: server</span><br><span class="line">  user: root</span><br><span class="line">  gather_facts: false</span><br><span class="line">  roles:</span><br><span class="line">  - update_openssh</span><br></pre></td></tr></table></figure>

<h2 id="vars-x2F-main-yaml"><a href="#vars-x2F-main-yaml" class="headerlink" title="vars&#x2F;main.yaml"></a>vars&#x2F;main.yaml</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@c71 update_openssh]# cat vars/main.yaml </span><br><span class="line">open_ssh_package: openssh-8.6p1.tar.gz</span><br><span class="line">open_ssl_package: openssl-1.1.1k.tar.gz</span><br></pre></td></tr></table></figure>

<h2 id="tasks-x2F-main-yaml"><a href="#tasks-x2F-main-yaml" class="headerlink" title="tasks&#x2F;main.yaml"></a>tasks&#x2F;main.yaml</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@c71 update_openssh]# cat tasks/main.yaml </span><br><span class="line">---</span><br><span class="line">- import_tasks: install.yaml</span><br></pre></td></tr></table></figure>

<h2 id="tasks-x2F-install-yaml"><a href="#tasks-x2F-install-yaml" class="headerlink" title="tasks&#x2F;install.yaml"></a>tasks&#x2F;install.yaml</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@c71 update_openssh]# cat tasks/install.yaml</span><br><span class="line">---</span><br><span class="line">- name: 安装telnet、xinetd</span><br><span class="line">  yum:</span><br><span class="line">    name: [&#x27;telnet&#x27;,&#x27;telnet-server&#x27;,&#x27;xinetd&#x27;]</span><br><span class="line">    state: present</span><br><span class="line">- name: 启动telnet、xinetd,并设置开机启动</span><br><span class="line">  service:</span><br><span class="line">    name: &quot;&#123;&#123; item &#125;&#125;&quot;</span><br><span class="line">    state: started</span><br><span class="line">    enabled: yes</span><br><span class="line">  loop:</span><br><span class="line">  - xinetd</span><br><span class="line">  - telnet.socket</span><br><span class="line">- name: 备份/etc/securetty文件</span><br><span class="line">  shell:</span><br><span class="line">    cmd: cp -rf /etc/securetty /etc/securetty.bak$(date +%Y%m%d)</span><br><span class="line">- name: 在/etc/securetty文件添加其他终端设备</span><br><span class="line">  blockinfile:</span><br><span class="line">    dest: /etc/securetty</span><br><span class="line">    block: &quot;pts/0\npts/1\npts/2\npts/3\npts/4&quot;</span><br><span class="line">- name: 重启xinetd服务</span><br><span class="line">  service:</span><br><span class="line">    name: xinetd</span><br><span class="line">    state: restarted</span><br><span class="line">  notify:   #要确保telnet成功启动后才能进行升级，否则如果升级失败，telnet又没启动，就无法远程连接服务器了</span><br><span class="line">  - telnet已经启动成功，可以进行升级</span><br></pre></td></tr></table></figure>

<h2 id="handlers-x2F-main-yaml"><a href="#handlers-x2F-main-yaml" class="headerlink" title="handlers&#x2F;main.yaml"></a>handlers&#x2F;main.yaml</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@c71 update_openssh]# cat handlers/main.yaml </span><br><span class="line">---</span><br><span class="line">- name: 安装编译环境及基础依赖包</span><br><span class="line">  yum:</span><br><span class="line">    name: [&#x27;ntpdate&#x27;,&#x27;gcc&#x27;,&#x27;gcc-c++&#x27;,&#x27;glibc&#x27;,&#x27;make&#x27;,&#x27;krb5-libs&#x27;,&#x27;krb5-devel&#x27;,&#x27;autoconf&#x27;,&#x27;openssl&#x27;,&#x27;openssl-devel&#x27;,&#x27;pcre-devel&#x27;,&#x27;zlib-devel&#x27;,&#x27;pam-devel&#x27;,&#x27;perl&#x27;]</span><br><span class="line">    state: present</span><br><span class="line">  listen: telnet已经启动成功，可以进行升级</span><br><span class="line">- name: 将openssh、openssl的压缩包解压到//usr/local/src/目录</span><br><span class="line">  unarchive:</span><br><span class="line">    src: &quot;&#123;&#123; item &#125;&#125;&quot;</span><br><span class="line">    dest: /usr/local/src/</span><br><span class="line">  loop:</span><br><span class="line">  - &quot;&#123;&#123; open_ssh_package &#125;&#125;&quot;</span><br><span class="line">  - &quot;&#123;&#123; open_ssl_package &#125;&#125;&quot;</span><br><span class="line">  listen: telnet已经启动成功，可以进行升级</span><br><span class="line">- name: 备份openssl文件</span><br><span class="line">  shell:</span><br><span class="line">    cmd: mv /usr/bin/openssl&#123;,.bak&#125;;mv /usr/include/openssl&#123;,.bak&#125;</span><br><span class="line">  listen: telnet已经启动成功，可以进行升级</span><br><span class="line">- name: 编译安装openssl</span><br><span class="line">  shell:</span><br><span class="line">    cmd: ./config shared --prefix=/usr/local/openssl &amp;&amp; make &amp;&amp; make install</span><br><span class="line">    chdir: /usr/local/src/openssl-1.1.1k</span><br><span class="line">  listen: telnet已经启动成功，可以进行升级</span><br><span class="line">- name: 设置openssl指令的软链接</span><br><span class="line">  shell:</span><br><span class="line">    cmd: &#x27;ln -s /usr/local/openssl/lib/libssl.so.1.1 /usr/lib64/; ln -s /usr/local/openssl/lib/libcrypto.so.1.1 /usr/lib64/; ln -s /usr/local/openssl/bin/openssl /usr/bin/openssl; ln -s /usr/local/openssl/include/openssl /usr/include/openssl&#x27;</span><br><span class="line">  listen: telnet已经启动成功，可以进行升级</span><br><span class="line">- name: 加载openssl模块</span><br><span class="line">  shell:</span><br><span class="line">    cmd: echo &quot;/usr/local/openssl/lib&quot; &gt;&gt; /etc/ld.so.conf;/sbin/ldconfig</span><br><span class="line">  listen: telnet已经启动成功，可以进行升级</span><br><span class="line">- name: 备份/etc/ssh、/etc/pam.d/sshd.pam</span><br><span class="line">  shell:</span><br><span class="line">    cmd: mv /etc/ssh /etc/ssh.$(date +%Y%m%d);cp -rf /etc/pam.d/sshd.pam /etc/pam.d/sshd.pam.$(date +%Y%m%d) || echo &quot;ansible_ens33[&#x27;ipv4&#x27;][&#x27;address&#x27;]上暂无这个文件。&quot;</span><br><span class="line">  listen: telnet已经启动成功，可以进行升级</span><br><span class="line">- name: 编译安装openssh</span><br><span class="line">  shell:</span><br><span class="line">    cmd: ./configure --prefix=/usr --sysconfdir=/etc/ssh  --with-ssl-dir=/usr/local/openssl   --with-zlib  --with-md5-passwords  --with-pam  --with-kerberos5 &amp;&amp; make &amp;&amp; make install</span><br><span class="line">    chdir: /usr/local/src/openssh-8.6p1</span><br><span class="line">  listen: telnet已经启动成功，可以进行升级</span><br><span class="line">- name: 替换新的sshd_config</span><br><span class="line">  shell:</span><br><span class="line">    cmd: cp -rf /usr/local/src/openssh-8.6p1/sshd_config /etc/ssh/sshd_config</span><br><span class="line">  listen: telnet已经启动成功，可以进行升级</span><br><span class="line">- name: override default of no subsystems</span><br><span class="line">  lineinfile:</span><br><span class="line">    dest: /etc/ssh/sshd_config</span><br><span class="line">    regexp: .*Subsystem.*sftp-server</span><br><span class="line">    line: Subsystem       sftp    /usr/libexec/openssh/sftp-server</span><br><span class="line">  listen: telnet已经启动成功，可以进行升级</span><br><span class="line">- name: 关闭DNS解析</span><br><span class="line">  lineinfile:</span><br><span class="line">    dest: /etc/ssh/sshd_config</span><br><span class="line">    regexp: .*UseDNS</span><br><span class="line">    line: UseDNS no</span><br><span class="line">  listen: telnet已经启动成功，可以进行升级</span><br><span class="line">- name: 允许root远程登录</span><br><span class="line">  lineinfile:</span><br><span class="line">    dest: /etc/ssh/sshd_config</span><br><span class="line">    regexp: .*PermitRootLogin</span><br><span class="line">    line: PermitRootLogin yes</span><br><span class="line">  listen: telnet已经启动成功，可以进行升级</span><br><span class="line">- name: 添加banner路径</span><br><span class="line">  lineinfile:</span><br><span class="line">    dest: /etc/ssh/sshd_config</span><br><span class="line">    insertafter: ^#Banner none</span><br><span class="line">    line: Banner /etc/sshbanner</span><br><span class="line">  listen: telnet已经启动成功，可以进行升级</span><br><span class="line">- name: 拷贝sshd.init和sshd.pam</span><br><span class="line">  shell:</span><br><span class="line">    cmd: cp -a contrib/redhat/sshd.init /etc/init.d/sshd;cp -a contrib/redhat/sshd.pam /etc/pam.d/sshd.pam</span><br><span class="line">    chdir: /usr/local/src/openssh-8.6p1</span><br><span class="line">  listen: telnet已经启动成功，可以进行升级</span><br><span class="line">- name: 将sshd交给chkconfig管理</span><br><span class="line">  shell:</span><br><span class="line">    cmd: chmod +x /etc/init.d/sshd;chkconfig --add sshd;chkconfig sshd on;systemctl enable sshd</span><br><span class="line">  listen: telnet已经启动成功，可以进行升级</span><br><span class="line">- name: 备份sshd.service并重启sshd服务</span><br><span class="line">  shell:</span><br><span class="line">    cmd: mv  /usr/lib/systemd/system/sshd.service  /usr/local/src/;mv  /usr/lib/systemd/system/sshd.socket  /usr/local/src/;systemctl daemon-reload;service sshd restart</span><br><span class="line">  listen: telnet已经启动成功，可以进行升级</span><br><span class="line">- name: 检查版本，确认是否升级成功</span><br><span class="line">  shell:</span><br><span class="line">    cmd: ssh -V;openssl version</span><br><span class="line">  register: check</span><br><span class="line">  listen: telnet已经启动成功，可以进行升级</span><br><span class="line">- name: 更新后版本信息</span><br><span class="line">  debug:</span><br><span class="line">    var: check</span><br><span class="line">    verbosity: 0</span><br><span class="line">  listen: telnet已经启动成功，可以进行升级</span><br></pre></td></tr></table></figure>

<h1 id="语法检查"><a href="#语法检查" class="headerlink" title="语法检查"></a>语法检查</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@c71 update_openssh]# ansible-playbook --syntax-check update_openssh.yaml</span><br><span class="line"></span><br><span class="line">playbook: update_openssh.yaml</span><br></pre></td></tr></table></figure>

<h1 id="开始升级openssh"><a href="#开始升级openssh" class="headerlink" title="开始升级openssh"></a>开始升级openssh</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@c71 update_openssh]# pwd</span><br><span class="line">/etc/ansible/roles/update_openssh</span><br><span class="line">[root@c71 update_openssh]# ansible-playbook update_openssh.yaml </span><br><span class="line"></span><br><span class="line">PLAY [升级openssh版本到openssh8.6p1] *****************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [update_openssh : 安装telnet、xinetd] *********************************************************************************************************</span><br><span class="line">changed: [192.168.100.133]</span><br><span class="line"></span><br><span class="line">TASK [update_openssh : 启动telnet、xinetd,并设置开机启动] *************************************************************************************************</span><br><span class="line">changed: [192.168.100.133] =&gt; (item=xinetd)</span><br><span class="line">changed: [192.168.100.133] =&gt; (item=telnet.socket)</span><br><span class="line"></span><br><span class="line">TASK [update_openssh : 备份/etc/securetty文件] ******************************************************************************************************</span><br><span class="line">changed: [192.168.100.133]</span><br><span class="line"></span><br><span class="line">TASK [update_openssh : 在/etc/securetty文件添加其他终端设备] ***********************************************************************************************</span><br><span class="line">changed: [192.168.100.133]</span><br><span class="line"></span><br><span class="line">TASK [update_openssh : 重启xinetd服务] **************************************************************************************************************</span><br><span class="line">changed: [192.168.100.133]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [update_openssh : 安装编译环境] *******************************************************************************************************</span><br><span class="line">changed: [192.168.100.133]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [update_openssh : 将openssh、openssl的压缩包解压到//usr/local/src/目录] ********************************************************************</span><br><span class="line">changed: [192.168.100.133] =&gt; (item=openssh-8.6p1.tar.gz)</span><br><span class="line">changed: [192.168.100.133] =&gt; (item=openssl-1.1.1k.tar.gz)</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [update_openssh : 备份openssl文件] **************************************************************************************************</span><br><span class="line">changed: [192.168.100.133]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [update_openssh : 编译安装openssl] **************************************************************************************************</span><br><span class="line">changed: [192.168.100.133]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [update_openssh : 设置openssl指令的软链接] **********************************************************************************************</span><br><span class="line">[WARNING]: Consider using the file module with state=link rather than running &#x27;ln&#x27;.  If you need to use command because file is insufficient you</span><br><span class="line">can add &#x27;warn: false&#x27; to this command task or set &#x27;command_warnings=False&#x27; in ansible.cfg to get rid of this message.</span><br><span class="line">changed: [192.168.100.133]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [update_openssh : 加载openssl模块] **************************************************************************************************</span><br><span class="line">changed: [192.168.100.133]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [update_openssh : 备份/etc/ssh、/etc/pam.d/sshd.pam] *******************************************************************************</span><br><span class="line">changed: [192.168.100.133]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [update_openssh : 编译安装openssh] **************************************************************************************************</span><br><span class="line">changed: [192.168.100.133]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [update_openssh : 替换新的sshd_config] **********************************************************************************************</span><br><span class="line">changed: [192.168.100.133]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [update_openssh : override default of no subsystems] ****************************************************************************</span><br><span class="line">changed: [192.168.100.133]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [update_openssh : 关闭DNS解析] ******************************************************************************************************</span><br><span class="line">changed: [192.168.100.133]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [update_openssh : 允许root远程登录] ***************************************************************************************************</span><br><span class="line">changed: [192.168.100.133]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [update_openssh : 添加banner路径] ***************************************************************************************************</span><br><span class="line">changed: [192.168.100.133]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [update_openssh : 拷贝sshd.init和sshd.pam] *****************************************************************************************</span><br><span class="line">changed: [192.168.100.133]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [update_openssh : 将sshd交给chkconfig管理] *******************************************************************************************</span><br><span class="line">[WARNING]: Consider using the file module with mode rather than running &#x27;chmod&#x27;.  If you need to use command because file is insufficient you</span><br><span class="line">can add &#x27;warn: false&#x27; to this command task or set &#x27;command_warnings=False&#x27; in ansible.cfg to get rid of this message.</span><br><span class="line">changed: [192.168.100.133]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [update_openssh : 备份sshd.service并重启sshd服务] **************************************************************************************</span><br><span class="line">changed: [192.168.100.133]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [update_openssh : 检查版本，确认是否升级成功] ************************************************************************************************</span><br><span class="line">changed: [192.168.100.133]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [update_openssh : 更新后版本信息] ******************************************************************************************************</span><br><span class="line">ok: [192.168.100.133] =&gt; &#123;</span><br><span class="line">    &quot;check&quot;: &#123;</span><br><span class="line">        &quot;changed&quot;: true, </span><br><span class="line">        &quot;cmd&quot;: &quot;ssh -V;openssl version&quot;, </span><br><span class="line">        &quot;delta&quot;: &quot;0:00:00.014358&quot;, </span><br><span class="line">        &quot;end&quot;: &quot;2021-07-13 21:57:42.407139&quot;, </span><br><span class="line">        &quot;failed&quot;: false, </span><br><span class="line">        &quot;rc&quot;: 0, </span><br><span class="line">        &quot;start&quot;: &quot;2021-07-13 21:57:42.392781&quot;, </span><br><span class="line">        &quot;stderr&quot;: &quot;OpenSSH_8.6p1, OpenSSL 1.1.1k  25 Mar 2021&quot;, </span><br><span class="line">        &quot;stderr_lines&quot;: [</span><br><span class="line">            &quot;OpenSSH_8.6p1, OpenSSL 1.1.1k  25 Mar 2021&quot;</span><br><span class="line">        ], </span><br><span class="line">        &quot;stdout&quot;: &quot;OpenSSL 1.1.1k  25 Mar 2021&quot;, </span><br><span class="line">        &quot;stdout_lines&quot;: [</span><br><span class="line">            &quot;OpenSSL 1.1.1k  25 Mar 2021&quot;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP **************************************************************************************************************************************</span><br><span class="line">192.168.100.133            : ok=23   changed=22   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br></pre></td></tr></table></figure>

<p><img src="/images/2021/0713/00.png" alt="01"></p>
<p>可以看到，已经成功升级，原来配置的免密登录如果无法正常登录，把&#x2F;root&#x2F;.ssh&#x2F;konwn_hosts文件里面的记录删掉就能连接了。</p>
<p>参考：<a href="https://blog.csdn.net/rookie23rook/article/details/111691267">https://blog.csdn.net/rookie23rook/article/details/111691267</a></p>
]]></content>
      <categories>
        <category>自动化运维</category>
      </categories>
      <tags>
        <tag>SSH</tag>
        <tag>Ansible</tag>
      </tags>
  </entry>
  <entry>
    <title>枚举卷期间出错: 客户端无法连接到请求中指定的目标……</title>
    <url>/arlo/143cd09f/</url>
    <content><![CDATA[<p>存储：华为&#x2F;OceanStor 2600 V3<br>网络：FC<br>服务器：Windows Server 2012 R2<br>更新系统补丁重启后连接存储提示以下错误：</p>
<blockquote>
<p>枚举存储期间出错。枚举卷期间出错: 客户端无法连接到请求中指定的目标。 请验证该目标上的服务是否正在运行以及是否正在接受请求。 有关目标(通常是 IIS 或 WinRM)上运行的 WS 管理服务，请查阅日志和文档。 如果目标是 WinRM 服务，则在目标上运行以下命令来分析和配置 WinRM 服务: “winrm quickconfig”。</p>
</blockquote>
<span id="more"></span>
<p><img src="/images/2017/1206/02.png" alt="stor"><br>这个错误应该跟 WinRM 服务有关，找到服务启用“ Windows Remote Management（WinRM）”服务后恢复正常;顺便设置服务为开机自启动。<br><img src="/images/2017/1206/03.png" alt="stor"></p>
]]></content>
      <categories>
        <category>Troubleshooting</category>
      </categories>
      <tags>
        <tag>Windows</tag>
        <tag>华为</tag>
        <tag>存储</tag>
      </tags>
  </entry>
  <entry>
    <title>CentOS7.x 升级OpenSSH_8.6p1</title>
    <url>/arlo/cd9ac657/</url>
    <content><![CDATA[<p>CentOS7.x操作系统自带的OpenSSH版本默认为7.4p1,使用yum update最高也只能升级到7.4p1的补丁版本，漏扫会发现很多OpenSSH相关的漏洞，根据等保安全测评的要求，需要将OpenSSH升级到更新的版本，本篇文档记录了我本次升级的过程以及遇到的问题，供大家参考。</p>
<h1 id="安装包下载地址"><a href="#安装包下载地址" class="headerlink" title="安装包下载地址"></a>安装包下载地址</h1><p>Openssl 下载地址：<a href="https://ftp.openssl.org/source/">https://ftp.openssl.org/source/</a></p>
<p>Openssh 下载地址：<a href="https://ftp.openbsd.org/pub/OpenBSD/OpenSSH/portable/">https://ftp.openbsd.org/pub/OpenBSD/OpenSSH/portable/</a></p>
<h1 id="安装基础环境包"><a href="#安装基础环境包" class="headerlink" title="安装基础环境包"></a>安装基础环境包</h1><p><em>注：受perl版本限制，最新版的openssl1.1.1需要perl5.10+版本，</em></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum -y install ntpdate wget gcc gcc-c++ glibc make krb5-libs krb5-devel zlib-devel pam-devel perl</span><br></pre></td></tr></table></figure>

<h1 id="同步服务器时间"><a href="#同步服务器时间" class="headerlink" title="同步服务器时间"></a>同步服务器时间</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ntpdate ntp.aliyun.com</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h1 id="升级openssl"><a href="#升级openssl" class="headerlink" title="升级openssl"></a>升级openssl</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">openssl version</span><br><span class="line">ssh -V</span><br></pre></td></tr></table></figure>

<p><img src="/images/2021/0707/01.png" alt="01"></p>
<h2 id="下载编译安装openssl"><a href="#下载编译安装openssl" class="headerlink" title="下载编译安装openssl"></a>下载编译安装openssl</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wget https://www.openssl.org/source/openssl-1.1.1k.tar.gz --no-check-certificate</span><br><span class="line">tar xf openssl-1.1.1k.tar.gz </span><br><span class="line">cd openssl-1.1.1k</span><br><span class="line">./config --prefix=/usr/local/openssl</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<h2 id="备份openssl"><a href="#备份openssl" class="headerlink" title="备份openssl"></a>备份openssl</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mv /usr/bin/openssl&#123;,.bak&#125;</span><br><span class="line">mv /usr/include/openssl&#123;,.bak&#125;</span><br></pre></td></tr></table></figure>

<h2 id="创建软连接"><a href="#创建软连接" class="headerlink" title="创建软连接"></a>创建软连接</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ln -s /usr/local/openssl/lib/libssl.so.1.1 /usr/lib64/</span><br><span class="line">ln -s /usr/local/openssl/lib/libcrypto.so.1.1 /usr/lib64/</span><br><span class="line"></span><br><span class="line">ln -s /usr/local/openssl/bin/openssl /usr/bin/openssl </span><br><span class="line">ln -s /usr/local/openssl/include/openssl /usr/include/openssl</span><br></pre></td></tr></table></figure>

<p><img src="/images/2021/0707/02.png" alt="01"></p>
<h1 id="升级openssh"><a href="#升级openssh" class="headerlink" title="升级openssh"></a>升级openssh</h1><h2 id="安装、配置telnet服务"><a href="#安装、配置telnet服务" class="headerlink" title="安装、配置telnet服务"></a>安装、配置telnet服务</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum install xinetd telnet-server -y</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cat &gt; /etc/xinetd.d/telnet &lt;&lt;EOF </span><br><span class="line">service telnet</span><br><span class="line">&#123;</span><br><span class="line">        flags           = REUSE</span><br><span class="line">        socket_type     = stream</span><br><span class="line">        wait            = no</span><br><span class="line">        user            = root</span><br><span class="line">        server          = /usr/sbin/in.telnetd</span><br><span class="line">        log_on_failure  += USERID</span><br><span class="line">        disable         = no    #修改yes为no</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>允许root远程telnet登录主机</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/securetty</span><br><span class="line"></span><br><span class="line">#在最后添加如下内容</span><br><span class="line">pts/0</span><br><span class="line">pts/1</span><br><span class="line">pts/2</span><br><span class="line">pts/3</span><br></pre></td></tr></table></figure>

<p>配置开机自启动</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl enable telnet.socket</span><br><span class="line">systemctl start telnet.socket</span><br><span class="line">systemctl enable xinetd</span><br><span class="line">systemctl start xinetd</span><br></pre></td></tr></table></figure>

<p>放行防火墙</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">firewall-cmd --add-service=telnet --zone=public --permanent</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<p> 以下操作使用telnet远程登录主机进行操作</p>
<p> <img src="/images/2021/0707/03.png" alt="01"></p>
<h2 id="备份openssh配置"><a href="#备份openssh配置" class="headerlink" title="备份openssh配置"></a>备份openssh配置</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mv /etc/ssh&#123;,.bak&#125;</span><br><span class="line">cp /etc/pam.d/sshd&#123;,.bak&#125;</span><br></pre></td></tr></table></figure>

<h2 id="卸载旧版本openssh"><a href="#卸载旧版本openssh" class="headerlink" title="卸载旧版本openssh"></a>卸载旧版本openssh</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rpm -e --nodeps `rpm -qa | grep openssh`</span><br></pre></td></tr></table></figure>

<h2 id="编译安装openssh"><a href="#编译安装openssh" class="headerlink" title="编译安装openssh"></a>编译安装openssh</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wget https://ftp.openbsd.org/pub/OpenBSD/OpenSSH/portable/openssh-8.6p1.tar.gz</span><br><span class="line">tar xf openssh-8.6p1.tar.gz</span><br><span class="line">cd openssh-8.6p1</span><br><span class="line">./configure --prefix=/usr -sysconfdir=/etc/ssh -with-ssl-dir=/usr/local/openssl -with-zlib -with-pam -with-md5-passwords -with-kerberos5 --without-zlib-version-check</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<h2 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cp contrib/redhat/sshd.init /etc/init.d/sshd</span><br><span class="line">sed -i &#x27;s/^#\(PermitRootLogin \).*/\1yes/&#x27; /etc/ssh/sshd_config</span><br><span class="line">sed -i &#x27;/UseDNS/c\UseDNS no&#x27; /etc/ssh/sshd_config </span><br></pre></td></tr></table></figure>

<h2 id="配置开机自启动"><a href="#配置开机自启动" class="headerlink" title="配置开机自启动"></a>配置开机自启动</h2><p>升级后不能使用systemctl 方式启动，感觉有点怪……</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/etc/init.d/sshd start</span><br><span class="line">chkconfig --level 35 sshd on</span><br></pre></td></tr></table></figure>

<h1 id="测试通过后，关闭telnet（telnet是明文传输，不安全）"><a href="#测试通过后，关闭telnet（telnet是明文传输，不安全）" class="headerlink" title="测试通过后，关闭telnet（telnet是明文传输，不安全）"></a>测试通过后，关闭telnet（telnet是明文传输，不安全）</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl disable xinetd</span><br><span class="line">systemctl stop xinetd</span><br><span class="line">systemctl disable telnet.socket</span><br><span class="line">systemctl stop telnet.socket</span><br></pre></td></tr></table></figure>



<h1 id="您可能遇到的问题？"><a href="#您可能遇到的问题？" class="headerlink" title="您可能遇到的问题？"></a>您可能遇到的问题？</h1><h2 id="问题1：make-configdata-pm-Error-1"><a href="#问题1：make-configdata-pm-Error-1" class="headerlink" title="问题1：make: *** [configdata.pm] Error 1"></a>问题1：make: *** [configdata.pm] Error 1</h2><p> <img src="/images/2021/0707/04.png" alt="01"></p>
<p>解决方案：服务器时间不对，手动调整服务器时间即可</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ntpdate ntp.aliyun.com</span><br></pre></td></tr></table></figure>

<h2 id="问题2：Failed-to-listen-on-Telnet-Server-Activation-Socket"><a href="#问题2：Failed-to-listen-on-Telnet-Server-Activation-Socket" class="headerlink" title="问题2：Failed to listen on Telnet Server Activation Socket."></a>问题2：Failed to listen on Telnet Server Activation Socket.</h2><p><img src="/images/2021/0707/05.png" alt="01"></p>
<p>解决方案：由于已经启动了一个xinetd进程，杀掉，重新启动telnet即可</p>
<p><img src="/images/2021/0707/06.png" alt="01"></p>
<h2 id="问题3：configure-error-PAM-headers-not-found"><a href="#问题3：configure-error-PAM-headers-not-found" class="headerlink" title="问题3：configure: error: PAM headers not found"></a>问题3：configure: error: PAM headers not found</h2><p>解决方案： <code>yum -y install pam-devel</code></p>
<h2 id="问题4：error-Could-not-get-shadow-information-for-root"><a href="#问题4：error-Could-not-get-shadow-information-for-root" class="headerlink" title="问题4：error: Could not get shadow information for root"></a>问题4：error: Could not get shadow information for root</h2><p><img src="/images/2021/0707/07.png" alt="01"></p>
<p>解决方案：由于开启了selinux导致，关闭即可</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#临时解决方案：</span><br><span class="line">setenforce 0</span><br><span class="line">#永久解决方案</span><br><span class="line">sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/&#x27; /etc/selinux/config</span><br><span class="line">grep SELINUX=disabled /etc/selinux/config</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>

<h2 id="问题5：sshd-service-start-operation-timed-out-Terminating"><a href="#问题5：sshd-service-start-operation-timed-out-Terminating" class="headerlink" title="问题5：sshd.service start operation timed out. Terminating"></a>问题5：sshd.service start operation timed out. Terminating</h2><p><img src="/images/2021/0707/08.png" alt="01"></p>
<p>解决方案：sshd不兼容systemd造成的，sshd启动方式修改为sysv即可。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mv /usr/lib/systemd/system/sshd.service&#123;,.bak&#125;</span><br><span class="line">systemctl stop ssh.service </span><br><span class="line">rm /lib/systemd/system/ssh.service </span><br><span class="line">systemctl daemon-reload</span><br><span class="line">cd /usr/local/src/openssh-8.6p1/</span><br><span class="line">cp contrib/redhat/sshd.init /etc/init.d  </span><br><span class="line">systemctl start ssh.service </span><br></pre></td></tr></table></figure>

<h2 id="问题6：服务器发送了一个意外的数据包。received-3-expected-20"><a href="#问题6：服务器发送了一个意外的数据包。received-3-expected-20" class="headerlink" title="问题6：服务器发送了一个意外的数据包。received:3,expected:20"></a>问题6：服务器发送了一个意外的数据包。received:3,expected:20</h2><p>在&#x2F;etc&#x2F;ssh&#x2F;sshd_config最后添加以下内容，重启sshd服务</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">KexAlgorithms curve25519-sha256@libssh.org,ecdh-sha2-nistp256,ecdh-sha2-nistp384,ecdh-sha2-nistp521,diffie-hellman-group-exchange-sha256,diffie-hellman-group14-sha1,diffie-hellman-group-exchange-sha1,diffie-hellman-group1-sha1</span><br></pre></td></tr></table></figure>

<h2 id="问题7：no-matching-key-exchange-algorithm-found"><a href="#问题7：no-matching-key-exchange-algorithm-found" class="headerlink" title="问题7：no matching key exchange algorithm found"></a>问题7：no matching key exchange algorithm found</h2><p>openssh升级完成后，xshell 4 无法连接服务器，升级xhell版本或者更好其他连接工具。</p>
]]></content>
      <categories>
        <category>安全</category>
      </categories>
      <tags>
        <tag>SSH</tag>
      </tags>
  </entry>
  <entry>
    <title>HCIA DHCP实验</title>
    <url>/arlo/4c33ee56/</url>
    <content><![CDATA[<h1 id="DHCP：Dynamic-Host-Configure-Protocol-动态主机配置协议"><a href="#DHCP：Dynamic-Host-Configure-Protocol-动态主机配置协议" class="headerlink" title="DHCP：Dynamic Host Configure Protocol 动态主机配置协议"></a>DHCP：Dynamic Host Configure Protocol 动态主机配置协议</h1><ul>
<li>从BOOTP（Bootstrap Protocol）协议发展而来 （wireshark抓包搜索关键字bootp）</li>
<li>UDP封装，服务器使用端口67，客户端使用端口68</li>
<li>动态分配网络信息（IP地址、子网掩码、网关、DNS服务器等）</li>
<li>分配给客户端的网络信息是有租约的</li>
</ul>
<span id="more"></span>

<h2 id="DHCP角色"><a href="#DHCP角色" class="headerlink" title="DHCP角色"></a>DHCP角色</h2><table>
<thead>
<tr>
<th>角色</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>DHCP Cilent 客户端</td>
<td>请求网络信息的用户</td>
</tr>
<tr>
<td>DHCP Server 服务器</td>
<td>能够提供DHCP功能的设备</td>
</tr>
<tr>
<td>DHCP Relay 中继</td>
<td>一般为路由器或三层交换机等设备</td>
</tr>
</tbody></table>
<h2 id="dhcp报文类型"><a href="#dhcp报文类型" class="headerlink" title="dhcp报文类型"></a>dhcp报文类型</h2><table>
<thead>
<tr>
<th>报文类型</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>DHCP Discover 发现</td>
<td>客户端寻找DHCP服务器</td>
</tr>
<tr>
<td>DHCP Office 提供</td>
<td>服务器响应DHCP Discover报文，该报文也携带了网络信息</td>
</tr>
<tr>
<td>DHCP Request 请求</td>
<td>客户端请求服务器对网络信息确认，或者续约租期</td>
</tr>
<tr>
<td>DHCP ACK 确认</td>
<td>服务器对DHCP Request报文确认响应</td>
</tr>
<tr>
<td>DHCP NAK 不确认</td>
<td>服务器对DHCP Request报文的拒接响应</td>
</tr>
<tr>
<td>DHCP Release 释放</td>
<td>客户端释放网络信息通知服务器</td>
</tr>
</tbody></table>
<p><img src="/images/2021/0804/01.png" alt="01"></p>
<p><img src="/images/2021/0804/02.png" alt="01"></p>
<p>ps: Offer和ACK报文也可以说是广播包，因为服务器只是根据MAC地址回应，没有看三层（在ack确认之后才是真正的使用地址）</p>
<h2 id="NAK报文的出现"><a href="#NAK报文的出现" class="headerlink" title="NAK报文的出现"></a>NAK报文的出现</h2><ul>
<li>IP地址可能已经被使用</li>
<li>租期未到期，网络信息还存在，换了DHCP服务器（如：切换网络环境，请求续约，但是服务器不存在该网络信息）</li>
</ul>
<p>在租期时间过50%后，主机会自动发送DHCP Request报文请求DHCP服务器重新续租</p>
<p>在租期时间过50%一直请求服务器，但服务器未响应，客户端在87.5%会发送DHCP Request报文请求所有DHCP服务器分配网络信息 （注：是以广播的形式发送）</p>
<p>无法获取DHCP服务器分配的网络信息，Windows客户端会自动使用169.254.0.0&#x2F;16地址，供临时通信</p>
<h1 id="DHCP配置"><a href="#DHCP配置" class="headerlink" title="DHCP配置"></a>DHCP配置</h1><table>
<thead>
<tr>
<th>命令</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>dhcp enable</td>
<td>开启DHCP功能</td>
</tr>
<tr>
<td>dhcp selcet interface</td>
<td>关联接口和接口地址池</td>
</tr>
<tr>
<td>dhcp server dns-list [dns服务器地址]</td>
<td>配置接口地址池的DNS服务器</td>
</tr>
<tr>
<td>dhcp server lease [day x hour x minute z]</td>
<td>配置接口地址池的租期，默认1天</td>
</tr>
<tr>
<td>dhcp server excluded-ip-address [ipaddr1 ipaddr2]</td>
<td>配置接口地址池排除的地址范围</td>
</tr>
<tr>
<td>dhcp server static-bind-ip-address [x.x.x.x] mac-address [xxxx-xxxx-xxxx]</td>
<td>配置静态绑定</td>
</tr>
<tr>
<td>dhcp select global</td>
<td>关联接口和全局地址池绑定</td>
</tr>
<tr>
<td>ip pool [名称]</td>
<td>创建全局地址池</td>
</tr>
<tr>
<td>network [地址]</td>
<td>配置全局地址池的可分配的网段地址</td>
</tr>
<tr>
<td>gateway-list [地址]</td>
<td>配置全局地址池的网关地址</td>
</tr>
<tr>
<td>dns-list [地址]</td>
<td>配置全局地址池的DNS服务器地址</td>
</tr>
<tr>
<td>lease [数字]</td>
<td>配置全局地址池下的租期，默认1天</td>
</tr>
<tr>
<td>excluded-ip-address [地址]</td>
<td>查看地址池的属性</td>
</tr>
<tr>
<td>dhcp select relay</td>
<td>关联接口开启中继代理</td>
</tr>
<tr>
<td>dhcp relay server-ip 192.168.10.254</td>
<td>指定DHCP服务器的地址</td>
</tr>
<tr>
<td>display ip pool interface [interface 接口名 all]</td>
<td>验证接口地址池的信息</td>
</tr>
<tr>
<td>display ip pool name [地址池名称] used</td>
<td>验证全局地址池的信息</td>
</tr>
<tr>
<td>ipconfig &#x2F;release</td>
<td>释放租期</td>
</tr>
<tr>
<td>ipconfig &#x2F;renew</td>
<td>重新获取</td>
</tr>
</tbody></table>
<h1 id="DHCP实验"><a href="#DHCP实验" class="headerlink" title="DHCP实验"></a>DHCP实验</h1><h2 id="接口地址池"><a href="#接口地址池" class="headerlink" title="接口地址池"></a>接口地址池</h2><p><img src="/images/2021/0804/03.png" alt="01"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#SW1</span><br><span class="line">sys</span><br><span class="line">sys SW1</span><br><span class="line">vlan batch 10 20</span><br><span class="line">int g0/0/1</span><br><span class="line">p l t</span><br><span class="line">port trunk allow-pass vlan 10 20</span><br><span class="line"></span><br><span class="line">dhcp enable</span><br><span class="line"></span><br><span class="line">int vlanif10</span><br><span class="line">ip a 10.0.0.254 24</span><br><span class="line">dhcp select interface</span><br><span class="line">dhcp server lease day 0 hour 1</span><br><span class="line">dhcp server dns-list 223.5.5.5 114.114.114.114</span><br><span class="line">dhcp server excluded-ip-address 10.0.0.200 10.0.0.253</span><br><span class="line">dhcp server static-bind ip-address 10.0.0.88 mac-address 5489-98db-4190</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">int vlanif20</span><br><span class="line">ip a 20.0.0.254 24</span><br><span class="line">dhcp select interface</span><br><span class="line"></span><br><span class="line">#######################################################</span><br><span class="line">#SW2</span><br><span class="line">sys</span><br><span class="line">sys SW2</span><br><span class="line">vlan batch 10 20</span><br><span class="line"></span><br><span class="line">int g0/0/1</span><br><span class="line">p l t</span><br><span class="line">port trunk allow-pass vlan 10 20</span><br><span class="line"></span><br><span class="line">int g0/0/2</span><br><span class="line">p l a</span><br><span class="line">p d vlan 10</span><br><span class="line"></span><br><span class="line">int g0/0/3</span><br><span class="line">p l a </span><br><span class="line">p d vlan 20</span><br></pre></td></tr></table></figure>

<h2 id="全局地址池"><a href="#全局地址池" class="headerlink" title="全局地址池"></a>全局地址池</h2><p><img src="/images/2021/0804/04.png" alt="01"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#SW1</span><br><span class="line">sys</span><br><span class="line">sys SW1</span><br><span class="line">vlan batch 10 20</span><br><span class="line">int g0/0/1</span><br><span class="line">p l t</span><br><span class="line">port trunk allow-pass vlan 10 20</span><br><span class="line"></span><br><span class="line">dhcp enable</span><br><span class="line"></span><br><span class="line">ip pool dev</span><br><span class="line"> gateway-list 10.0.0.254</span><br><span class="line"> network 10.0.0.0 mask 255.255.255.0</span><br><span class="line"> lease day 0 hour 2 minute 0</span><br><span class="line"> dns-list 223.5.5.5 119.29.29.29</span><br><span class="line"> static-bind ip-address 10.0.0.100 mac-address 5489-98db-4190</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ip pool ops</span><br><span class="line"> gateway-list 20.0.0.254</span><br><span class="line"> network 20.0.0.0 mask 255.255.255.0</span><br><span class="line"> lease day 0 hour 2 minute 0</span><br><span class="line"> dns-list 223.5.5.5 119.29.29.29</span><br><span class="line"></span><br><span class="line">int vlanif10</span><br><span class="line">ip a 10.0.0.254 24</span><br><span class="line">dhcp select global</span><br><span class="line"></span><br><span class="line">int vlanif20</span><br><span class="line">ip a 20.0.0.254 24</span><br><span class="line">dhcp select global</span><br><span class="line"></span><br><span class="line">##################################</span><br><span class="line">#SW2</span><br><span class="line">sys</span><br><span class="line">sys SW2</span><br><span class="line">vlan batch 10 20</span><br><span class="line"></span><br><span class="line">int g0/0/1</span><br><span class="line">p l t</span><br><span class="line">port trunk allow-pass vlan 10 20</span><br><span class="line"></span><br><span class="line">int g0/0/2</span><br><span class="line">p l a</span><br><span class="line">p d vlan 10</span><br><span class="line"></span><br><span class="line">int g0/0/3</span><br><span class="line">p l a </span><br><span class="line">p d vlan 20</span><br></pre></td></tr></table></figure>

<p><img src="/images/2021/0804/05.png" alt="01"></p>
<p><img src="/images/2021/0804/06.png" alt="01"></p>
<p><img src="/images/2021/0804/07.png" alt="01"></p>
]]></content>
      <categories>
        <category>网络</category>
      </categories>
      <tags>
        <tag>网络</tag>
        <tag>HCIA</tag>
      </tags>
  </entry>
  <entry>
    <title>HCIA NAT实验</title>
    <url>/arlo/b064bfaf/</url>
    <content><![CDATA[<h1 id="公网地址的由来"><a href="#公网地址的由来" class="headerlink" title="公网地址的由来"></a>公网地址的由来</h1><p>个人&#x2F;企业–&gt;ISP运营商–&gt;CNNIC中国互联网络信息中心–&gt;APNIC（Asia Pacific Network Information Centre）亚太地址网络信息中心–&gt;IANA互联网数字分配机构 （早在2012年IP地址就已经分配完了）</p>
<h1 id="NAT好处"><a href="#NAT好处" class="headerlink" title="NAT好处"></a>NAT好处</h1><ul>
<li>有效避免了来自外网的攻击，大大提高了网络安全性</li>
<li>控制内网访问外网，同时也控制了外网访问内网，解决了内网和外网通信的问题</li>
</ul>
<span id="more"></span>

<p><img src="/images/2021/0806/01.png" alt="01"></p>
<h1 id="静态NAT配置（一对一）"><a href="#静态NAT配置（一对一）" class="headerlink" title="静态NAT配置（一对一）"></a>静态NAT配置（一对一）</h1><ul>
<li><p>如果希望一台主机专用某个公网地址，或者想要外网访问内网服务器时，可以使用静态NAT</p>
</li>
<li><p>静态NAT不能有效缓解公网地址短缺的问题</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>命令</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>nat static enable</td>
<td>开启NAT静态功能</td>
</tr>
<tr>
<td>nat static global 公网地址 inside 私网地址</td>
<td>创建静态NAT</td>
</tr>
<tr>
<td>display nat static</td>
<td>查看静态NAT的配置</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#OFFICE</span><br><span class="line">sys</span><br><span class="line">sys OFFICE</span><br><span class="line">dhcp enable</span><br><span class="line">int g0/0/1</span><br><span class="line">ip a 192.168.100.254 24</span><br><span class="line">dhcp select interface</span><br><span class="line"></span><br><span class="line">int g0/0/0</span><br><span class="line">ip a 12.0.0.1 24</span><br><span class="line"> nat static enable</span><br><span class="line"> nat static global 12.0.0.10 inside 192.168.100.253 netmask 255.255.255.255</span><br><span class="line"> nat static global 12.0.0.20 inside 192.168.100.252 netmask 255.255.255.255</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ip route-s 0.0.0.0 0.0.0.0 12.0.0.2</span><br><span class="line"></span><br><span class="line">################################################</span><br><span class="line">#ISP</span><br><span class="line">sys</span><br><span class="line">sys ISP</span><br><span class="line">int g0/0/0</span><br><span class="line">ip a 12.0.0.2 24</span><br><span class="line"></span><br><span class="line">int g0/0/1</span><br><span class="line">ip a 2.0.0.254 24</span><br></pre></td></tr></table></figure>

<p>查看静态NAT配置</p>
<p><img src="/images/2021/0806/02.png" alt="01"></p>
<p>使用pc1 ping pc4</p>
<p><img src="/images/2021/0806/03.png" alt="01"></p>
<p>在OFFICE路由g0&#x2F;0&#x2F;0口抓包，可以看到从192.168.100.253发过来的包已经转换为12.0.0.10 发送给2.0.0.1</p>
<p><img src="/images/2021/0806/04.png" alt="01"></p>
<h1 id="动态NAT和PAT配置"><a href="#动态NAT和PAT配置" class="headerlink" title="动态NAT和PAT配置"></a>动态NAT和PAT配置</h1><h2 id="动态NAT（多对多）"><a href="#动态NAT（多对多）" class="headerlink" title="动态NAT（多对多）"></a>动态NAT（多对多）</h2><p><strong>动态NAT基于地址池来实现私有地址和公有地址的转换</strong></p>
<ul>
<li>动态NAT定义了地址池，规定一个范围的地址可以供主机转换</li>
<li>动态NAT地址池中的地址用尽后，只能等待被占用的地址被释放，其他主机才能使用它来访问公网</li>
<li>动态NAT也不能有效缓解公网地址短缺的问题</li>
</ul>
<table>
<thead>
<tr>
<th>命令</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>acl 2000</td>
<td>创建一个基本ACL</td>
</tr>
<tr>
<td>rule 5 deny&#x2F;permit source 192.168.1.0 0.0.0.255</td>
<td>配置ACL的规则：拒绝或允许源地址为192.168.1.0&#x2F;24网段内的所有流量</td>
</tr>
<tr>
<td>acl 3000</td>
<td>创建一个高级ACL</td>
</tr>
<tr>
<td>rule 5 deny&#x2F;permit tcp source 192.168.1.0 0.0.0.255 destination 8.8.8.8 0 destination-port eq 80</td>
<td>配置ACL的规则：拒绝或允许源地址为192.168.1.0&#x2F;24网段内到8.8.8.8 的http流量</td>
</tr>
<tr>
<td>traffic-fifter inbound&#x2F;outbound acl 2000</td>
<td>在接口调用ACL过滤流量</td>
</tr>
<tr>
<td>display acl 2000</td>
<td>验证ACL</td>
</tr>
<tr>
<td>display traffic-filter applied-record</td>
<td>查看设备上所有基于ACL调用情况</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>命令</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>nat address-group 编号 公网地址范围</td>
<td>配置NAT地址池</td>
</tr>
<tr>
<td>nat outbound acl 编号<br />address-group 编号 [no-pat]</td>
<td>关联一个ACL和一个NAT地址池<br />ACL用来匹配能够转换的源地址</td>
</tr>
<tr>
<td>no-pat</td>
<td>只转换地址而不转换端口</td>
</tr>
<tr>
<td>display nat address-group</td>
<td>查看NAT地址池配置信息</td>
</tr>
<tr>
<td>display nat outbound</td>
<td>查看动态NAT配置信息</td>
</tr>
<tr>
<td>dis nat session all</td>
<td>查看NAT转换表</td>
</tr>
</tbody></table>
<h2 id="动态NAT配置"><a href="#动态NAT配置" class="headerlink" title="动态NAT配置"></a>动态NAT配置</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#OFFICE</span><br><span class="line">sys</span><br><span class="line">sys OFFICE</span><br><span class="line">dhcp enable</span><br><span class="line">nat address-group 1 12.0.0.11 12.0.0.15</span><br><span class="line">acl 2000</span><br><span class="line">  rule 1 permit source 192.168.100.0 0.0.0.255</span><br><span class="line"></span><br><span class="line">int g0/0/1</span><br><span class="line">ip a 192.168.100.254 24</span><br><span class="line">dhcp select interface</span><br><span class="line"></span><br><span class="line">int g0/0/0</span><br><span class="line">ip a 12.0.0.1 24</span><br><span class="line">nat outbound 2000 address-group 1 no-pat</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ip route-s 0.0.0.0 0.0.0.0 12.0.0.2</span><br><span class="line"></span><br><span class="line">#ISP</span><br><span class="line">sys</span><br><span class="line">sys ISP</span><br><span class="line">int g0/0/0</span><br><span class="line">ip a 12.0.0.2 24</span><br><span class="line"></span><br><span class="line">int g0/0/1</span><br><span class="line">ip a 2.0.0.254 24</span><br></pre></td></tr></table></figure>

<p><img src="/images/2021/0806/05.png" alt="01"></p>
<p><img src="/images/2021/0806/07.png" alt="01"></p>
<p>由于动态NAT地址池中的地址用尽后，只能等待被占用的地址被释放，其他主机才能使用它来访问公网，所以我们地址池里5个地址用完了后就会看到有丢包的现象，有地址被释放后才能用于用于转换</p>
<p>PS:使用ICMP时地址会变换，是没有端口的，但是有标识，可以根据标识来分辨，如下图</p>
<p><img src="/images/2021/0806/08.png" alt="01"></p>
<h2 id="NAPT（多对一）"><a href="#NAPT（多对一）" class="headerlink" title="NAPT（多对一）"></a>NAPT（多对一）</h2><p><strong>NAPT允许多个内部地址映射到统一个公有地址的不同端口</strong></p>
<ul>
<li><p>NPAT(Network Address Port Translation)，也称为NAT-PT或PAT，网络地址端口转换，允许多个私网地址映射到同一个公网地址的不同端口。</p>
</li>
<li><p>通常适用于大型企业网络（申请多个固定的公网地址）</p>
</li>
<li><p>NAPT需要定义地址池，不能直接使用出接口的地址</p>
</li>
<li><p>有效的缓解了公网地址短缺的问题</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>命令</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>nat address-group 编号 公网地址范围</td>
<td>配置NAT地址池</td>
</tr>
<tr>
<td>nat outbound acl 编号 address-group 编号 no-pat</td>
<td>配置调用ACL关联地址池</td>
</tr>
<tr>
<td>nat outbound acl 编号 address-group 编号</td>
<td>配置NAPT</td>
</tr>
<tr>
<td>display nat address-group</td>
<td>验证NAT地址池配置信息</td>
</tr>
<tr>
<td>display nat outbound</td>
<td>验证动态NAT配置信息</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#OFFICE</span><br><span class="line">sys</span><br><span class="line">sys OFFICE</span><br><span class="line">dhcp enable</span><br><span class="line">nat address-group 2 12.0.0.100 12.0.0.100</span><br><span class="line">acl 2000</span><br><span class="line">  rule 1 permit source 192.168.100.0 0.0.0.255</span><br><span class="line"></span><br><span class="line">int g0/0/1</span><br><span class="line">ip a 192.168.100.254 24</span><br><span class="line">dhcp select interface</span><br><span class="line"></span><br><span class="line">int g0/0/0</span><br><span class="line">ip a 12.0.0.1 24</span><br><span class="line">nat outbound 2000 address-group 2   #主要说就是这里后边不加no-pat</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ip route-s 0.0.0.0 0.0.0.0 12.0.0.2</span><br><span class="line"></span><br><span class="line">#ISP</span><br><span class="line">sys</span><br><span class="line">sys ISP</span><br><span class="line">int g0/0/0</span><br><span class="line">ip a 12.0.0.2 24</span><br><span class="line"></span><br><span class="line">int g0/0/1</span><br><span class="line">ip a 2.0.0.254 24</span><br></pre></td></tr></table></figure>

<p><img src="/images/2021/0806/09.png" alt="01"></p>
<p>可以看到我们用于NAT转换的只有12.0.0.100这一个地址，多台主机同时上网也不会丢包</p>
<p><img src="/images/2021/0806/10.png" alt="01"></p>
<h1 id="Easy-IP"><a href="#Easy-IP" class="headerlink" title="Easy IP"></a>Easy IP</h1><h1 id="Easy-IP允许将多个内部地址映射到网关出接口地址上的不同端口"><a href="#Easy-IP允许将多个内部地址映射到网关出接口地址上的不同端口" class="headerlink" title="Easy IP允许将多个内部地址映射到网关出接口地址上的不同端口"></a><strong>Easy IP允许将多个内部地址映射到网关出接口地址上的不同端口</strong></h1><ul>
<li>直接使用出接口的地址做转换</li>
<li>Easy IP适用于小规模居于网中的主机访问Internet的场景</li>
<li>如：家庭、小型网吧、小型办公室中，这些地方内部主机不多，出接口可以通过拨号方式获取一个临时公网IP地址</li>
<li>有效的缓解了公网地址紧缺和不固定的公网地址转换问题</li>
</ul>
<table>
<thead>
<tr>
<th>命令</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>nat outbound [acl 编号]</td>
<td>配置Easy IP 关联出站接口和ACL</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># OFFICE</span><br><span class="line">sys</span><br><span class="line">sys OFFICE</span><br><span class="line">dhcp enable</span><br><span class="line">acl 2000</span><br><span class="line">  rule 1 permit source 192.168.100.0 0.0.0.255</span><br><span class="line"></span><br><span class="line">int g0/0/1</span><br><span class="line">ip a 192.168.100.254 24</span><br><span class="line">dhcp select interface</span><br><span class="line"></span><br><span class="line">int g0/0/0</span><br><span class="line">ip a 12.0.0.1 24</span><br><span class="line">nat outbound 2000 </span><br><span class="line"></span><br><span class="line">ip route-s 0.0.0.0 0.0.0.0 12.0.0.2</span><br><span class="line"></span><br><span class="line">###########################################</span><br><span class="line"></span><br><span class="line"># ISP</span><br><span class="line">sys</span><br><span class="line">sys ISP</span><br><span class="line">int g0/0/0</span><br><span class="line">ip a 12.0.0.2 24</span><br><span class="line"></span><br><span class="line">int g0/0/1</span><br><span class="line">ip a 2.0.0.254 24</span><br></pre></td></tr></table></figure>

<h1 id="NAT服务器（端口映射）"><a href="#NAT服务器（端口映射）" class="headerlink" title="NAT服务器（端口映射）"></a>NAT服务器（端口映射）</h1><ul>
<li>NAT具有“屏蔽”内部主机的作用，但有时内网需要向外网提供服务</li>
<li>当外网用户访问内网服务器时，出口设备通过事先配置好的“公网IP地址+端口号”与“私网IP地址+端口号”间的映射关系，将服务器的“公网IP地址和端口号”根据映射关系替换成对应的“私网IP地址+端口号”</li>
<li>NAT服务器的公网IP地址和端口中，端口可以更改，提供安全性</li>
</ul>
<table>
<thead>
<tr>
<th>命令</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>nat server protocol tcp&#x2F;udp global current-interface&#x2F;公网地址 端口 inside 私网地址 端口</td>
<td>配置NAT服务器</td>
</tr>
<tr>
<td>display nat server</td>
<td>验证NAT服务器</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># OFFICE</span><br><span class="line">sys</span><br><span class="line">sys OFFICE</span><br><span class="line">dhcp enable</span><br><span class="line">acl 2000</span><br><span class="line">  rule 1 permit source 192.168.100.0 0.0.0.255</span><br><span class="line"></span><br><span class="line">int g0/0/1</span><br><span class="line">ip a 192.168.100.254 24</span><br><span class="line">dhcp select interface</span><br><span class="line"></span><br><span class="line">int g0/0/0</span><br><span class="line">ip a 12.0.0.1 24</span><br><span class="line">nat outbound 2000 </span><br><span class="line">nat server protocol tcp global current-interface 8888 inside 192.168.100.2 80 </span><br><span class="line"></span><br><span class="line">ip route-s 0.0.0.0 0.0.0.0 12.0.0.2</span><br><span class="line"></span><br><span class="line">###########################################</span><br><span class="line"></span><br><span class="line"># ISP</span><br><span class="line">sys</span><br><span class="line">sys ISP</span><br><span class="line">int g0/0/0</span><br><span class="line">ip a 12.0.0.2 24</span><br><span class="line"></span><br><span class="line">int g0/0/1</span><br><span class="line">ip a 2.0.0.254 24</span><br></pre></td></tr></table></figure>

<ol>
<li>配置拓扑图中的内网Server1，开启HttpServer服务</li>
<li>在OFFICE路由器出口将192.168.100.2:80 映射为出接口（12.0.0.1:8888）</li>
<li>在外网Client1中使用HttpClient访问<a href="http://12.0.0.1:8888/">http://12.0.0.1:8888</a></li>
</ol>
<p><img src="/images/2021/0806/12.png" alt="01"></p>
<p><img src="/images/2021/0806/11.png" alt="01"></p>
]]></content>
      <categories>
        <category>网络</category>
      </categories>
      <tags>
        <tag>网络</tag>
        <tag>HCIA</tag>
      </tags>
  </entry>
  <entry>
    <title>HCIA OSPF动态路由实验</title>
    <url>/arlo/10949436/</url>
    <content><![CDATA[<p>开放式最短路径优先OSPF(Open Shortest Path First)协议是IETF定义的一种基于链路状态的内部网关路由协议。</p>
<p>RIP是一种基于距离矢量算法的路由协议，存在着收敛慢、易产生路由环路、可扩展性差等问题，目前已逐渐被OSPF取代。</p>
<span id="more"></span>

<h1 id="OSPF概述"><a href="#OSPF概述" class="headerlink" title="OSPF概述"></a>OSPF概述</h1><ul>
<li>大中型网络使用最广泛的IGP协议</li>
<li>链路状态路由协议</li>
<li>无类别路由</li>
<li>使用组播（224.0.0.5和224.0.0.6）</li>
<li>收敛快</li>
<li>已开销（cost）作为度量值</li>
<li>采用SPF算法可以有效的避免环路</li>
<li>触发式更新（以较低频率（每30分钟）定期发送更新，被称为链路状态泛洪）</li>
<li>设置区域更新概率使得OSPF能够支持更大规模的网络（划分骨干区域、非骨干区域和特殊区域）</li>
<li>通过LSA（链路状态信息）的形式发布路由</li>
<li>支持手动汇总（在ABR和ASBR上配置）</li>
</ul>
<h1 id="OSPF区域"><a href="#OSPF区域" class="headerlink" title="OSPF区域"></a>OSPF区域</h1><h2 id="区域概述"><a href="#区域概述" class="headerlink" title="区域概述"></a>区域概述</h2><table>
<thead>
<tr>
<th>术语</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>区域（Area）</td>
<td>为了适应大型网络，OSPF在AS内划分多个区域。区域是以接口划分。每个OSP路由器只维护所在区域的完整链路状态信息</td>
</tr>
<tr>
<td>区域ID（Area-ID）</td>
<td>可以表示成一个十进制的数字，如：1，也可以表示为一个IP，如：1.1.1.1</td>
</tr>
<tr>
<td>区域优点</td>
<td>尽量减少LSDB大小，拓扑变化仅影响本区域内部</td>
</tr>
</tbody></table>
<h2 id="区域类型"><a href="#区域类型" class="headerlink" title="区域类型"></a>区域类型</h2><p>划分多区域的作用，是为了减轻运行OSPF路由器的压力。</p>
<p>防环机制：划分了骨干区域和非骨干区域，所有非骨干区域通讯必须经过骨干区域中转，骨干区域传来的LSA不会再传回骨干区域。非骨干区域之间通信需要骨干区域转发。</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>骨干区域</td>
<td>area-0，骨干区域，也称为传输区域</td>
</tr>
<tr>
<td>非骨干区域</td>
<td>非area-0，非骨干区域，称为末端区域</td>
</tr>
</tbody></table>
<h2 id="OSPF路由器角色"><a href="#OSPF路由器角色" class="headerlink" title="OSPF路由器角色"></a>OSPF路由器角色</h2><table>
<thead>
<tr>
<th>角色</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>IR</td>
<td>internal router （内部路由器）：所有接口都属于同一个区域</td>
</tr>
<tr>
<td>BR</td>
<td>backbone router（骨干路由器）：至少有一个接口属于骨干区域</td>
</tr>
<tr>
<td>ABR</td>
<td>Area border router（区域边界路由）：连接多个不同的区域，至少有一个接口属于骨干区域</td>
</tr>
<tr>
<td>ASBR</td>
<td>Autonomous System Border（自制系统边界路由器）：将其他路由协议学习到的路由以引入的方式到OSPF进程中</td>
</tr>
</tbody></table>
<h1 id="OSPF核心工作流程"><a href="#OSPF核心工作流程" class="headerlink" title="OSPF核心工作流程"></a>OSPF核心工作流程</h1><ol>
<li>发现并建立邻居</li>
<li>传播LSA(区别基于DV算法的路由更新)【LSA内容：链路状态宣告，路由器接口，描述接口信息】</li>
<li>将LSA泛洪到区域中的所有OSPF路由器</li>
<li>收集LSA创建LSDB(链路状态数据库)</li>
<li>使用SPF算法计算到达每个目标网络的最短路径，存放于路由表</li>
</ol>
<h2 id="OSPF三张表"><a href="#OSPF三张表" class="headerlink" title="OSPF三张表"></a>OSPF三张表</h2><table>
<thead>
<tr>
<th>类型</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>邻居表</td>
<td>记录所有邻居关系</td>
</tr>
<tr>
<td>链路状态数据库</td>
<td>记录所有链路状态信息</td>
</tr>
<tr>
<td>路由表</td>
<td>记录最佳路由</td>
</tr>
</tbody></table>
<h2 id="Router-ID"><a href="#Router-ID" class="headerlink" title="Router ID"></a>Router ID</h2><ul>
<li><u>运行OSPF协议前，必须选取的一个RID</u></li>
<li><u>用来唯一标识一台OSPF路由器</u></li>
<li><u>RID可以手动配置，也可以自动生成</u></li>
<li><u>RID选取规则顺序：1. 优先手动配置（推荐）；2. 活动回环接口中IP地址最高的；3. 活动物理接口中IP地址最高的</u></li>
<li><u>任何选举值都未配置是运行不了OSPF的（router id为0.0.0.0）</u></li>
<li><u>RID选举具有<strong>非抢占性</strong>，修改除非重启OSPF进程（R1&gt; reset ospf process）</u></li>
</ul>
<h2 id="OSPF数据包类型"><a href="#OSPF数据包类型" class="headerlink" title="OSPF数据包类型"></a>OSPF数据包类型</h2><p>OSPF数据包封装在IP协议之上，IP协议号89（ICMP 1, TCP 6, UDP 17）</p>
<table>
<thead>
<tr>
<th>OSPF数据包</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>Hello</td>
<td>建立并维护邻居关系</td>
</tr>
<tr>
<td>Database Description（DD）</td>
<td>LSDB的摘要信息（仅包含LSA头部信息）</td>
</tr>
<tr>
<td>Links State Request（LSR）</td>
<td>请求LSA</td>
</tr>
<tr>
<td>Links State Update（LSU）</td>
<td>发送LSA（完整的LSA信息）</td>
</tr>
<tr>
<td>Link State Acknowledge （LSA）</td>
<td>对LSU的确认</td>
</tr>
</tbody></table>
<h2 id="OSPF状态机制"><a href="#OSPF状态机制" class="headerlink" title="OSPF状态机制"></a>OSPF状态机制</h2><p>只有2-Way和Full是稳定状态</p>
<table>
<thead>
<tr>
<th>状态</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>失效状态（Down）</td>
<td>没有收到Hello 包</td>
</tr>
<tr>
<td>初始状态（Init）</td>
<td>收到了Hello 包，但是邻居列表不存在自己</td>
</tr>
<tr>
<td>双向通信状态 （2-Way）</td>
<td>收到了Hello包，且在邻居列表里看到了自己，形成邻居关系</td>
</tr>
<tr>
<td>交换初始状态 （Exstart）</td>
<td>决定交换信息时的路由器主从关系</td>
</tr>
<tr>
<td>交互状态 （Exchange）</td>
<td>向邻居发送DD数据包</td>
</tr>
<tr>
<td>加载状态（Loading）</td>
<td>LSR和LSU交换</td>
</tr>
<tr>
<td>完全邻接状态 （Full）</td>
<td>LSDB同步完成，形成邻接关系</td>
</tr>
</tbody></table>
<h2 id="OSPF工作流程（数据包和状态切换过程）"><a href="#OSPF工作流程（数据包和状态切换过程）" class="headerlink" title="OSPF工作流程（数据包和状态切换过程）"></a>OSPF工作流程（数据包和状态切换过程）</h2><p><img src="/images/2021/0718/00.png" alt="01"></p>
<p><img src="/images/2021/0718/01.png" alt="01"></p>
<p>OSPF第一阶段是使用Hello包建立双向通信的过程，称为邻居关系</p>
<p><img src="/images/2021/0718/02.png" alt="01"></p>
<p>Exstart：序列号x，I&#x3D;1表示是第一个发送的DD包，M&#x3D;1表示后面还有DD包，MS&#x3D;1表示我是主（初始都是主），通过比较Router ID值大的一方为主，向主发送的DD报文中序列号会变成主的序列号，同时这才是真正的DD报文</p>
<p><img src="/images/2021/0718/03.png" alt="01"></p>
<p>OSPF第二阶段是通过交换LSA达到LSDB同步，建立邻接关系</p>
<h2 id="OSPF邻居建立条件（必须三层直连）"><a href="#OSPF邻居建立条件（必须三层直连）" class="headerlink" title="OSPF邻居建立条件（必须三层直连）"></a>OSPF邻居建立条件（必须三层直连）</h2><p>Hello报文用来发现和维持OSPF邻居关系</p>
<ul>
<li>RID唯一 </li>
<li>Hello&#x2F;Dead时间间隔一致（默认Dead时间是Hello时间的4倍） 【 [R1-GigabitEthernet0&#x2F;0&#x2F;0] ospf timer hello 5】</li>
<li>区域ID一致</li>
<li>认证（如果启用了认证）一致</li>
<li>链路MTU大小一致（华为默认不开启检查，思科默认开启）</li>
<li>子网掩码一致（以太网环境）</li>
<li>网络地址一致</li>
<li>末梢区域设置一致（Option）</li>
</ul>
<h2 id="OSPF网路类型：基于接口"><a href="#OSPF网路类型：基于接口" class="headerlink" title="OSPF网路类型：基于接口"></a>OSPF网路类型：基于接口</h2><p>缺省情况下，OSPF认为以太网的网络类型是广播类型，PPP、HDLC的网络类型是点对点类型。</p>
<h2 id="DR和BDR"><a href="#DR和BDR" class="headerlink" title="DR和BDR"></a>DR和BDR</h2><p>只要是多路访问BMA和NBMA网络中，为了减少邻接关系的数量，从而减少数据包交换次数，最终节省带宽，降低对路由器处理能力的压力，选举DR和BDR</p>
<table>
<thead>
<tr>
<th>术语</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>DR</td>
<td>Designed Router，指定路由器，类似班长、总经理</td>
</tr>
<tr>
<td>BDR</td>
<td>Backup DR，备用DR，类似副班长、副总经理</td>
</tr>
<tr>
<td>DRothers</td>
<td>类似普通学生、普通员工</td>
</tr>
<tr>
<td>关系</td>
<td>DR、BDR、DRothers之间都保持邻接关系（Full），DRothers之间保持邻居关系（2-Way）</td>
</tr>
<tr>
<td>地址</td>
<td>224.0.0.6向DR和BDR发送链路状态更新 <br />224.0.0.5向所有OSPF路由器发送</td>
</tr>
<tr>
<td>选举规则</td>
<td>首先比较Hello报文中鞋带的优先级 <br />1. 优先级范围0-255，默认&#x3D;1 <br />2. 优先级最高的被选举为DR，优先级次高的被选举为BDR<br />3. 优先级为0的不参与选举<br />优先级一致的情况下，比较RID，越大越优先。选举具有非抢占性，除非当DR和BDR都失效或重启OSPF进程</td>
</tr>
</tbody></table>
<h2 id="OSPF度量值：Cost，开销"><a href="#OSPF度量值：Cost，开销" class="headerlink" title="OSPF度量值：Cost，开销"></a>OSPF度量值：Cost，开销</h2><ul>
<li><p>在每一个运行OSPF的接口上，都维护这一个接口Cost</p>
</li>
<li><p>Cost&#x3D;10^8&#x2F;BW(bps)&#x3D;100Mbps&#x2F;BW&#x3D;接口带宽参考值&#x2F;接口带宽</p>
</li>
<li><p>到一个目标网络的度量值&#x3D;</p>
<ul>
<li><p>从源到目标所有出站接口的Cost值累加（数据方向）</p>
</li>
<li><p>从源到本路由器沿途所有入站接口的Cost值累加（路由方向）</p>
</li>
</ul>
</li>
</ul>
<h1 id="OSPF-配置"><a href="#OSPF-配置" class="headerlink" title="OSPF 配置"></a>OSPF 配置</h1><table>
<thead>
<tr>
<th>命令</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>ospf 1 router-id 1.1.1.1</td>
<td>开启OSPF,进程号缺省值为1，手动配置Router ID</td>
</tr>
<tr>
<td>area 0&#x2F;0.0.0.0</td>
<td>配置区域</td>
</tr>
<tr>
<td>network 192.168.0.0 0.0.0.255</td>
<td>宣告网络，即指定运行OSPF的接口；使用反掩码来匹配（255.255.255.255-掩码）</td>
</tr>
<tr>
<td>display ospf peer brief</td>
<td>显示OSPF邻居信息</td>
</tr>
<tr>
<td>ospf timer hello 10</td>
<td>修改Hello包发送间隔</td>
</tr>
<tr>
<td>ospf timer dead 40</td>
<td>修改Hello包超时时间</td>
</tr>
<tr>
<td>display ospf interface g0&#x2F;0&#x2F;0</td>
<td>显示OSPF接口信息</td>
</tr>
<tr>
<td>ospf dr-priority 100</td>
<td>修改OSPF接口优先级</td>
</tr>
<tr>
<td>ospf cost 10</td>
<td>修改开销，范围1-65535，缺省为1</td>
</tr>
<tr>
<td>bandwidth-reference 100</td>
<td>调整带宽参考值，默认为100Mbps，需要在整个OSPF网络中统一进行调整</td>
</tr>
<tr>
<td>reset ospf process</td>
<td>重启OSPF进程</td>
</tr>
<tr>
<td>default-route-advertise always</td>
<td>OSPF发布缺省路由（没有缺省路由，必须要有always参数）</td>
</tr>
<tr>
<td>display ospf lsdb</td>
<td>查看ospf链路状态数据库信息</td>
</tr>
</tbody></table>
<p>OSPF认证命令</p>
<p>如果同时配置认证，接口认证优先生效。</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>int g0&#x2F;0&#x2F;0<br />    ospf authentication-mode md5 1 cipher 111.com</td>
<td>配置接口认证</td>
</tr>
<tr>
<td>ospf 1<br />  area 0<br />  authentication-mode md5 1 cipher 111.com</td>
<td>配置区域认证</td>
</tr>
</tbody></table>
<p><img src="/images/2021/0718/04.png" alt="01"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># AR1</span><br><span class="line">sys </span><br><span class="line">sys R1</span><br><span class="line">int g0/0/0</span><br><span class="line">ip add 192.168.0.1 24</span><br><span class="line"></span><br><span class="line">ospf dr-pri 200</span><br><span class="line">ospf 1 router-id 1.1.1.1</span><br><span class="line">area 0</span><br><span class="line">network 192.168.0.0 0.0.0.255</span><br><span class="line"></span><br><span class="line">#################################</span><br><span class="line"></span><br><span class="line">#AR2</span><br><span class="line">sys </span><br><span class="line">sys R2</span><br><span class="line">int g0/0/0</span><br><span class="line">ip add 192.168.0.2 24</span><br><span class="line"></span><br><span class="line">ospf dr-pri 100</span><br><span class="line">ospf 1 router-id 2.2.2.2</span><br><span class="line">area 0</span><br><span class="line">network 192.168.0.0 0.0.0.255</span><br><span class="line"></span><br><span class="line">#################################</span><br><span class="line"></span><br><span class="line"># AR3</span><br><span class="line">sys </span><br><span class="line">sys R3</span><br><span class="line">int g0/0/0</span><br><span class="line">ip add 192.168.0.3 24</span><br><span class="line">int s4/0/0</span><br><span class="line">ip add 34.0.0.3 8</span><br><span class="line"></span><br><span class="line">ospf authentication-mode md5 1 cipher 111.com</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ospf 1 router-id 3.3.3.3</span><br><span class="line">area 0</span><br><span class="line">network 192.168.0.0 0.0.0.255</span><br><span class="line">network 34.0.0.0 0.255.255.255</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#################################</span><br><span class="line">#AR6</span><br><span class="line">sys </span><br><span class="line">sys R6</span><br><span class="line">int g0/0/0</span><br><span class="line">ip add 192.168.0.6 24</span><br><span class="line"></span><br><span class="line">ospf 1 router-id 6.6.6.6</span><br><span class="line">area 0</span><br><span class="line">network 192.168.0.0 0.0.0.255</span><br><span class="line"></span><br><span class="line">#################################</span><br><span class="line"># AR4</span><br><span class="line"></span><br><span class="line">sys </span><br><span class="line">sys R4</span><br><span class="line">int s4/0/0</span><br><span class="line">ip add 34.0.0.4 8</span><br><span class="line">int g0/0/1</span><br><span class="line">ip add 48.0.0.4 8</span><br><span class="line">int lo 1</span><br><span class="line">ip add 4.4.4.4 32</span><br><span class="line"></span><br><span class="line">ospf 1 router-id 4.4.4.4</span><br><span class="line">area 0</span><br><span class="line">network 34.0.0.0 0.255.255.255</span><br><span class="line">network 4.4.4.4 0.0.0.0</span><br><span class="line">import-route direct</span><br><span class="line"></span><br><span class="line">int s4/0/0</span><br><span class="line">ospf authentication-mode md5 1 cipher 111.com</span><br><span class="line"></span><br><span class="line">#################################</span><br><span class="line">#AR8</span><br><span class="line"></span><br><span class="line">sys</span><br><span class="line">sys R8</span><br><span class="line">int g0/0/0</span><br><span class="line">ip add 48.0.0.8 8</span><br><span class="line"></span><br><span class="line">ip route-static 0.0.0.0 0.0.0.0 48.0.0.4</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/images/2021/0718/05.png" alt="01"></p>
<p><img src="/images/2021/0718/06.png" alt="01"></p>
<p><img src="/images/2021/0718/07.png" alt="01"></p>
]]></content>
      <categories>
        <category>网络</category>
      </categories>
      <tags>
        <tag>网络</tag>
        <tag>HCIA</tag>
      </tags>
  </entry>
  <entry>
    <title>HCIA RIP动态路由实验</title>
    <url>/arlo/714ef56/</url>
    <content><![CDATA[<h1 id="RIP：-Routing-Information-Protocol-（路由信息协议）"><a href="#RIP：-Routing-Information-Protocol-（路由信息协议）" class="headerlink" title="RIP： Routing Information Protocol （路由信息协议）"></a>RIP： Routing Information Protocol （路由信息协议）</h1><ul>
<li>距离矢量路由协议，属于IGP协议</li>
<li>适用于中小型网络，有RIPv1和RIPv2两个版本</li>
<li>基于UDP，目标端口号520</li>
<li>周期性更新（25.5s-30s）</li>
<li>支持水平分割、毒性逆转和触发更新等防环特性</li>
</ul>
<span id="more"></span>

<h1 id="RIP工作原理"><a href="#RIP工作原理" class="headerlink" title="RIP工作原理"></a>RIP工作原理</h1><ul>
<li>路由器运行RIP后，首先会发送路由更新请求，收到请求的路由器会发送自己的RIP路由进行响应</li>
<li>网络稳定后，路由器会周期性（30s）发送路由更新信息</li>
</ul>
<h1 id="RIP度量"><a href="#RIP度量" class="headerlink" title="RIP度量"></a>RIP度量</h1><ul>
<li>RIP使用跳数（hop）做为度量值来衡量到达目的的网络的距离</li>
<li>缺省情况下，直连网络的路由跳数为0，当路哟器发送路由更新时，会把度量值加1</li>
<li>RIP规定超过15跳为网络不可达</li>
</ul>
<h1 id="RIPv1-vs-RIPv2-区别"><a href="#RIPv1-vs-RIPv2-区别" class="headerlink" title="RIPv1 vs RIPv2 区别"></a>RIPv1 vs RIPv2 区别</h1><table>
<thead>
<tr>
<th></th>
<th>RIPv1</th>
<th>RIPv2</th>
</tr>
</thead>
<tbody><tr>
<td>路由协议类别</td>
<td>有类别路由协议，不支持VLSM和CIDR</td>
<td>无类别路由协议，支持VLSM，支持路由聚合与CIDR</td>
</tr>
<tr>
<td>发送报文方式</td>
<td>广播的形式发送报文</td>
<td>以广播或组播（224.0.0.9）方式发送报文</td>
</tr>
<tr>
<td>认证</td>
<td>不支持认证</td>
<td>明文认证和MD5密文认证</td>
</tr>
</tbody></table>
<h1 id="RIP-环路"><a href="#RIP-环路" class="headerlink" title="RIP-环路"></a>RIP-环路</h1><p>当网络发生故障时，RIP网络有可能产生路由环路</p>
<h2 id="环路避免-水平分割"><a href="#环路避免-水平分割" class="headerlink" title="环路避免-水平分割"></a>环路避免-水平分割</h2><p>路由器从某个接口学到的路由，不会从该接口再发回给邻居路由器</p>
<h2 id="环路避免-触发更新"><a href="#环路避免-触发更新" class="headerlink" title="环路避免-触发更新"></a>环路避免-触发更新</h2><p>触发更新是指当路由信息发生变化时，立即向邻居设备发送触发更新报文</p>
<h2 id="环路避免-毒性逆转"><a href="#环路避免-毒性逆转" class="headerlink" title="环路避免-毒性逆转"></a>环路避免-毒性逆转</h2><p>毒性逆转是指路由器从某个接口学到路由后，将该路由的跳数设置为16，并从原接收接口发回给邻居路由器</p>
<h1 id="配置命令"><a href="#配置命令" class="headerlink" title="配置命令"></a>配置命令</h1><table>
<thead>
<tr>
<th>命令</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>rip 1</td>
<td>开启RIP进程，进程缺省为1</td>
</tr>
<tr>
<td>version 2</td>
<td>开启RIPv2（更安全）</td>
</tr>
<tr>
<td>network 10.0.0.0</td>
<td>宣告网络，即指定运行RIP的接口，只需要输入接口的主类网络地址即可，只有处于此网络中的接口，才能进行RIP报文的接收与发送</td>
</tr>
<tr>
<td>rip mertricin 5</td>
<td>在接收路由时增加度量值</td>
</tr>
<tr>
<td>rip metricout 5</td>
<td>在发送路由时修改度量值</td>
</tr>
<tr>
<td>rip split-horizon</td>
<td>开启水平分割，默认开启</td>
</tr>
<tr>
<td>rip poison-reverse</td>
<td>开启毒性逆转，默认关闭</td>
</tr>
<tr>
<td>undo rip input</td>
<td>禁止接收RIP数据包</td>
</tr>
<tr>
<td>undo rip output</td>
<td>禁止发送RIP数据包</td>
</tr>
<tr>
<td>silent-interface g0&#x2F;0&#x2F;0</td>
<td>配置被动接口，只收不发（优先级大于 rip input和rip output）</td>
</tr>
<tr>
<td>display rip</td>
<td>验证RIP信息</td>
</tr>
<tr>
<td>display rip int g0&#x2F;0&#x2F;0 verbose</td>
<td>验证RIP接口相关信息</td>
</tr>
</tbody></table>
<h1 id="实验1"><a href="#实验1" class="headerlink" title="实验1"></a>实验1</h1><p>实验要求：</p>
<ol>
<li>配置AR1，AR2网络，使用12.0.0.0&#x2F;24</li>
<li>配置本地回环网络loopback网络为 1.1.1.1 和2.2.2.2</li>
<li>使用rip宣告网络达到1.1.1.1 和2.2.2.2互通</li>
</ol>
<p><img src="/images/2021/0715/01.png" alt="01"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#AR1</span><br><span class="line">sys</span><br><span class="line">sys R1</span><br><span class="line">int g0/0/0</span><br><span class="line">ip add 12.0.0.1 24</span><br><span class="line">int lo 1</span><br><span class="line">ip add 1.1.1.1 24</span><br><span class="line"></span><br><span class="line">rip 1</span><br><span class="line">ver 2</span><br><span class="line">network 12.0.0.0</span><br><span class="line">network 1.0.0.0</span><br><span class="line">#######################################################</span><br><span class="line">#AR2</span><br><span class="line">sys</span><br><span class="line">sys R2</span><br><span class="line">int g0/0/0</span><br><span class="line">ip add 12.0.0.2 24</span><br><span class="line">int lo 1</span><br><span class="line">ip add 2.2.2.2 24</span><br><span class="line"></span><br><span class="line">rip 1</span><br><span class="line">ver 2</span><br><span class="line">network 12.0.0.0</span><br><span class="line">network 2.0.0.0</span><br></pre></td></tr></table></figure>

<h1 id="实验2"><a href="#实验2" class="headerlink" title="实验2"></a>实验2</h1><p>实验要求：</p>
<ol>
<li>配置AR1，AR2网络，分别使用192.168.12.0&#x2F;24和192.168.34.0&#x2F;24网络</li>
<li>配置本地回环网络loopback网络为 1.1.1.1 ，2.2.2.2 和3.3.3.3</li>
<li>使用rip宣告网络达到1.1.1.1 ，2.2.2.2和3.3.3.3互通</li>
<li>网络192.168.12.0&#x2F;24使用rip明文验证，网络192.168.34.0&#x2F;24使用rip md5验证</li>
</ol>
<p><img src="/images/2021/0715/02.png" alt="02"></p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#AR1</span><br><span class="line">sys </span><br><span class="line">sys R1</span><br><span class="line">int g0/0/0</span><br><span class="line">ip add 192.168.12.1 24</span><br><span class="line">int lo 1</span><br><span class="line">ip add 1.1.1.1 32</span><br><span class="line"></span><br><span class="line">#配置rip，宣告网络</span><br><span class="line">rip 1</span><br><span class="line">ver 2</span><br><span class="line">network 192.168.12.0</span><br><span class="line">network 1.0.0.0</span><br><span class="line">#配置验证</span><br><span class="line">int g0/0/0</span><br><span class="line">rip authentication-mode simple cipher 111.com</span><br><span class="line"></span><br><span class="line">#######################################################</span><br><span class="line"></span><br><span class="line">#AR2</span><br><span class="line">sys </span><br><span class="line">sys R2</span><br><span class="line">int g0/0/0</span><br><span class="line">ip add 192.168.12.2 24</span><br><span class="line">int g0/0/1</span><br><span class="line">ip add 192.168.34.2 24</span><br><span class="line">int lo 1</span><br><span class="line">ip add 2.2.2.2 32</span><br><span class="line"></span><br><span class="line">#配置rip，宣告网络</span><br><span class="line">rip 1</span><br><span class="line">ver 2</span><br><span class="line">network 192.168.12.0</span><br><span class="line">network 192.168.34.0</span><br><span class="line">network 2.0.0.0</span><br><span class="line"></span><br><span class="line">#配置验证</span><br><span class="line">int g0/0/0</span><br><span class="line">rip authentication-mode simple cipher 111.com</span><br><span class="line"></span><br><span class="line">int g0/0/1</span><br><span class="line">rip authentication-mode md5 usual 222.com</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#######################################################</span><br><span class="line"></span><br><span class="line">#AR3</span><br><span class="line">sys </span><br><span class="line">sys R3</span><br><span class="line">int g0/0/0</span><br><span class="line">ip add 192.168.34.3 24</span><br><span class="line">int lo 1</span><br><span class="line">ip add 3.3.3.3 32</span><br><span class="line"></span><br><span class="line">#配置rip，宣告网络</span><br><span class="line">rip 1</span><br><span class="line">ver 2</span><br><span class="line">network 192.168.34.0</span><br><span class="line">network 3.0.0.0</span><br><span class="line"></span><br><span class="line">#配置验证</span><br><span class="line">int g0/0/0</span><br><span class="line">rip authentication-mode md5 usual 222.com</span><br></pre></td></tr></table></figure>

<h2 id="查看路由表"><a href="#查看路由表" class="headerlink" title="查看路由表"></a>查看路由表</h2><p><code>dis ip routing-table protocol rip</code></p>
<p><img src="/images/2021/0715/03.png" alt="02"></p>
<p><img src="/images/2021/0715/04.png" alt="02"></p>
<p><img src="/images/2021/0715/05.png" alt="02"></p>
<h2 id="清除rip路由信息"><a href="#清除rip路由信息" class="headerlink" title="清除rip路由信息"></a>清除rip路由信息</h2><p>清除之前学习到的rip路由，看看是否还能重新学习到rip路由，验证认证是否配置正确</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;R1&gt;reset ip routing-table statistics protocol rip</span><br><span class="line">&lt;R2&gt;reset ip routing-table statistics protocol rip</span><br><span class="line">&lt;R3&gt;reset ip routing-table statistics protocol rip</span><br></pre></td></tr></table></figure>

<h2 id="抓包信息"><a href="#抓包信息" class="headerlink" title="抓包信息"></a>抓包信息</h2><p><img src="/images/2021/0715/07.png" alt="02"></p>
<p><img src="/images/2021/0715/08.png" alt="02"></p>
<p><img src="/images/2021/0715/09.png" alt="02"></p>
<p>使用md5验证的时候，路由都没有问题，但是抓包有这个报错，不太清楚是什么问题。</p>
<p><img src="/images/2021/0715/06.png" alt="02"></p>
]]></content>
      <categories>
        <category>网络</category>
      </categories>
      <tags>
        <tag>网络</tag>
        <tag>HCIA</tag>
      </tags>
  </entry>
  <entry>
    <title>HCIA-VLAN综合路由实验</title>
    <url>/arlo/7ea3a151/</url>
    <content><![CDATA[<h1 id="交换基础"><a href="#交换基础" class="headerlink" title="交换基础"></a>交换基础</h1><h2 id="网络分层"><a href="#网络分层" class="headerlink" title="网络分层"></a>网络分层</h2><table>
<thead>
<tr>
<th>层次</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>接入层（Access Layer）</td>
<td>用户接入层，接入安全 访问控制</td>
</tr>
<tr>
<td>汇聚层（Distribution Layer）</td>
<td>流量汇聚 链路冗余 设备冗余 路由选择</td>
</tr>
<tr>
<td>核心层（Core Layer）</td>
<td>高速转发 服务器接入 路由选择</td>
</tr>
<tr>
<td>出口层（Speak Layer）</td>
<td>广域网接入 出口策略 带宽控制</td>
</tr>
</tbody></table>
<span id="more"></span>

<h2 id="交换机的主要功能"><a href="#交换机的主要功能" class="headerlink" title="交换机的主要功能"></a>交换机的主要功能</h2><ul>
<li>终端设备的接入</li>
<li>以太网数据帧的交换，根据目的MAC地址转发数据帧</li>
<li>学习MAC地址，并维护MAC地址表</li>
<li>防止二层环路</li>
</ul>
<h2 id="交换机原理"><a href="#交换机原理" class="headerlink" title="交换机原理"></a>交换机原理</h2><table>
<thead>
<tr>
<th>原理</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>学习 learn</td>
<td>从一个接口收到数据帧时，把数据帧的源MAC地址和该接口进行绑定，存放MAC地址表</td>
</tr>
<tr>
<td>泛洪flood</td>
<td>从一个接口收到广播帧、组播帧、未知单播帧，把该帧从其他所有接口转发出去（除接收口）</td>
</tr>
<tr>
<td>转发forward</td>
<td>从一个接口收到已知单播帧，立即从相应的接口转发出去（除目标地址是自己）</td>
</tr>
<tr>
<td>更新Update</td>
<td>交换机地址表中的表项默认的保存300秒交换机重启会清楚所有接口学习到的记录接口关闭后会清空该接口学习到的记录一个源MAC地址出现在别的接口上，会删除老的记录，添加新的记录</td>
</tr>
<tr>
<td>注：</td>
<td>对应一台交换机来说：一个MAC地址只能关联一个接口上一个接口可以存在多个MAC地址</td>
</tr>
</tbody></table>
<h2 id="以太网接口工作模式"><a href="#以太网接口工作模式" class="headerlink" title="以太网接口工作模式"></a>以太网接口工作模式</h2><table>
<thead>
<tr>
<th>术语</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>半双工</td>
<td>half-duplex通信双方不能同时发送接收数据</td>
</tr>
<tr>
<td>全双工</td>
<td>full-duplex通信双方可以同时发送接收数据</td>
</tr>
<tr>
<td>速率</td>
<td>Speed接口两端连接时进行协商，协商失败无法正常通信</td>
</tr>
</tbody></table>
<h2 id="交换机设置通信模式"><a href="#交换机设置通信模式" class="headerlink" title="交换机设置通信模式"></a>交换机设置通信模式</h2><table>
<thead>
<tr>
<th>术语</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>undo negotiation auto</td>
<td>取消自动协商</td>
</tr>
<tr>
<td>speed 100</td>
<td>设置速率</td>
</tr>
<tr>
<td>duplex full</td>
<td>设置通信模式为全双工</td>
</tr>
</tbody></table>
<h1 id="VLAN"><a href="#VLAN" class="headerlink" title="VLAN"></a>VLAN</h1><h2 id="VLAN优点"><a href="#VLAN优点" class="headerlink" title="VLAN优点"></a>VLAN优点</h2><ul>
<li>有效控制广播域范围</li>
<li>增强局域网的安全性</li>
<li>灵活构建虚拟工作组</li>
<li>简化网络管理</li>
</ul>
<h2 id="VLAN概述：Virtual-LAN-虚拟局域网"><a href="#VLAN概述：Virtual-LAN-虚拟局域网" class="headerlink" title="VLAN概述：Virtual LAN 虚拟局域网"></a>VLAN概述：Virtual LAN 虚拟局域网</h2><ul>
<li>将一个物理局域网在逻辑上划分成多个广播域</li>
<li>1 VLAN &#x3D; 1 广播域 &#x3D; 1 子网 （划分最好一个子网一个VLAN）</li>
<li>广播不会在不同VLAN间转发，而是限制在相同的VLAN中</li>
<li>不同VLAN间的设备默认无法通信</li>
</ul>
<p>VLAN范围：0~4095 （0和4095保留，1为默认）</p>
<ul>
<li>IEEE 802.1q：又称dot1q，是VLAN的正式标准，对Ethernet帧格式进行修改，在源地址和类型字段中插入了4字节的802.1q tag</li>
</ul>
<p>每台支持802.1q协议的交换机发送的数据帧都会包含VLAN ID，以指明数据帧属于哪一个VLAN。因此，在一个VLAN交换网络中，以太网帧有以下两种格式</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>无标记帧 untagged frame</td>
<td>原始的数据帧，未加入4字节802.1q tag的字段</td>
</tr>
<tr>
<td>有标记帧 tagged frame</td>
<td>插入了4字节802.1q tag的字段</td>
</tr>
</tbody></table>
<p> 路由器和终端设备发送的数据帧默认是untagged frame，默认也识别不了tagged frame</p>
<p> PVID：Port Vlan identification 端口VLAN标志</p>
<p>指明该接口属于的VLAN</p>
<h2 id="VLAN链路类型"><a href="#VLAN链路类型" class="headerlink" title="VLAN链路类型"></a>VLAN链路类型</h2><table>
<thead>
<tr>
<th>类型</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>Access Link（接入链路）</td>
<td>一般用于连接主机或路由器之间的链路</td>
</tr>
<tr>
<td>Trunk Link（干道&#x2F;中继链路）</td>
<td>一般用于连接交换机之间的链路</td>
</tr>
<tr>
<td>Hybrid 混杂接口（华为私有接口类型）</td>
<td>可以任意指定数据帧发送或接收是否携带tagged</td>
</tr>
</tbody></table>
<h2 id="Access的工作原理"><a href="#Access的工作原理" class="headerlink" title="Access的工作原理"></a>Access的工作原理</h2><table>
<thead>
<tr>
<th>类型</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>Access接入链路接收数据帧的工作过程</td>
<td>接收数据帧：接收一个untagged的数据帧会打上接口的PVID接收一个tagged的数据帧会比较与接口的PVID是否一致（一致接收，不一致丢弃）</td>
</tr>
<tr>
<td>Access接入链路发送数据帧的工作过程</td>
<td>发送数据帧：发送一个数据帧会剥离VLAN （也就是丢弃dot1q字段）</td>
</tr>
</tbody></table>
<h2 id="Trunk的工作原理"><a href="#Trunk的工作原理" class="headerlink" title="Trunk的工作原理"></a>Trunk的工作原理</h2><table>
<thead>
<tr>
<th>类型</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>Trunk干道&#x2F;中继链路接收数据帧的工作过程</td>
<td>接收数据帧：接收一个untagged的数据帧会打上接口的PVID接收一个tagged的数据帧会查看tagged List是否存在（存在接收，不存在丢弃）</td>
</tr>
<tr>
<td>Trunk干道&#x2F;中继链路发送数据帧的工作过程（最多一个数据帧是untagged形式发送）</td>
<td>发送数据帧：发送一个数据帧会查看tagged list和PVID（tagged list表中存在则直接发送，如果PVID一致会剥离VLAN ID</td>
</tr>
</tbody></table>
<h2 id="VLAN配置"><a href="#VLAN配置" class="headerlink" title="VLAN配置"></a>VLAN配置</h2><table>
<thead>
<tr>
<th>命令</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>vlan 10</td>
<td>创建单个VLAN</td>
</tr>
<tr>
<td>vlan batch 10 20</td>
<td>创建多个VLAN</td>
</tr>
<tr>
<td>port link-type access&#x2F;trunk&#x2F;hybrid</td>
<td>配置接口类型</td>
</tr>
<tr>
<td>port default vlan 10</td>
<td>配置access关联VLAN&#x2F;PVID</td>
</tr>
<tr>
<td>port trunk allow-pass vlan 10</td>
<td>配置trunk允许VLAN通过（默认只允许VLAN1通过）</td>
</tr>
<tr>
<td>port trunk pvid vlan 10</td>
<td>配置trunk的PVID</td>
</tr>
<tr>
<td>prt hybrid tagged&#x2F;untagged vlan 10</td>
<td>配置hybrid标记VLAN</td>
</tr>
<tr>
<td>port hybrid pvid vlan 10</td>
<td>配置hybrid的PVID</td>
</tr>
<tr>
<td>display vlan</td>
<td>验证VLAN</td>
</tr>
<tr>
<td>display port vlan</td>
<td>验证VLAN</td>
</tr>
<tr>
<td>dot1q termination vid 10</td>
<td>子接口和VLAN关联</td>
</tr>
<tr>
<td>arp broadcast enable</td>
<td>开启子接口的ARP广播功能</td>
</tr>
<tr>
<td>portswitch</td>
<td>配置接口工作为2层</td>
</tr>
<tr>
<td>undo portswitch</td>
<td>配置接口工作为3层</td>
</tr>
</tbody></table>
<h1 id="VLAN综合实验"><a href="#VLAN综合实验" class="headerlink" title="VLAN综合实验"></a>VLAN综合实验</h1><p><img src="/images/2021/0801/00.png" alt="01"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#SW1</span><br><span class="line">sys</span><br><span class="line">sys SW1</span><br><span class="line">vlan batch 10 20</span><br><span class="line">int g0/0/1</span><br><span class="line">p l a</span><br><span class="line">p d vlan 10</span><br><span class="line"></span><br><span class="line">int g0/0/2</span><br><span class="line">p l a</span><br><span class="line">p d vlan 20</span><br><span class="line"></span><br><span class="line">int g0/0/3</span><br><span class="line">p l t</span><br><span class="line">port trunk allow-pass vlan 10 20</span><br><span class="line"></span><br><span class="line">###########################################</span><br><span class="line">#SW2</span><br><span class="line">sys</span><br><span class="line">sys SW2</span><br><span class="line">vlan batch 10 20 23</span><br><span class="line">int g0/0/1</span><br><span class="line">p l t</span><br><span class="line">p t allow-pass vlan 10 20</span><br><span class="line">int vlanif10</span><br><span class="line">ip a 192.168.10.254 24</span><br><span class="line">int vlanif20</span><br><span class="line">ip a 192.168.20.254 24</span><br><span class="line"></span><br><span class="line">int g0/0/2</span><br><span class="line">p l a</span><br><span class="line">p d vlan 23</span><br><span class="line">int vlanif23</span><br><span class="line">ip a 23.0.0.2 24</span><br><span class="line"></span><br><span class="line">ospf 1 router-id 23.23.23.23</span><br><span class="line">area 0</span><br><span class="line">network 23.0.0.2 0.0.0.0</span><br><span class="line">network 192.168.10.0 0.0.0.255</span><br><span class="line">network 192.168.20.0 0.0.0.255</span><br><span class="line"></span><br><span class="line">###########################################</span><br><span class="line">#SW3</span><br><span class="line">sys</span><br><span class="line">sys SW3</span><br><span class="line">vlan batch 13 23</span><br><span class="line">int g0/0/1</span><br><span class="line">p l a</span><br><span class="line">p d vlan 23</span><br><span class="line">int vlanif23</span><br><span class="line">ip a 23.0.0.3 24</span><br><span class="line"></span><br><span class="line">int g0/0/2</span><br><span class="line">p l a</span><br><span class="line">p d vlan 13</span><br><span class="line">int vlanif13</span><br><span class="line">ip a 13.0.0.3 24</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ospf 1 router-id 13.13.13.13</span><br><span class="line">area 0</span><br><span class="line">network 13.0.0.3 0.0.0.0</span><br><span class="line">network 23.0.0.3 0.0.0.0</span><br><span class="line"></span><br><span class="line">###########################################</span><br><span class="line">#R1</span><br><span class="line">sys</span><br><span class="line">sys R1</span><br><span class="line">int g0/0/0</span><br><span class="line">ip a 13.0.0.1 24</span><br><span class="line">int lo 1</span><br><span class="line">ip a 1.1.1.1 32 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ospf 1 router-id 1.1.1.1</span><br><span class="line">area 0 </span><br><span class="line">network 13.0.0.1 0.0.0.0</span><br><span class="line">network 1.1.1.1 0.0.0.0</span><br></pre></td></tr></table></figure>

<p><img src="/images/2021/0801/01.png" alt="01"></p>
<h1 id="补充一下STP配置"><a href="#补充一下STP配置" class="headerlink" title="补充一下STP配置"></a>补充一下STP配置</h1><table>
<thead>
<tr>
<th>命令</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>stp mode {mstp &amp;#124; stp &amp;#124;rstp}</td>
<td>配置STP模式，缺省为MSTP</td>
</tr>
<tr>
<td>stp priority 4096</td>
<td>配置BID优先级值，0~61440，步长为4096</td>
</tr>
<tr>
<td>stp root primary&#x2F;secondard</td>
<td>自动修改优先级，指定主&#x2F;备根桥</td>
</tr>
<tr>
<td>stp pathcost-standard {dot1d-1988 &amp;#124; dot1t &amp;#124; legacy}</td>
<td>配置路径开销值的标准</td>
</tr>
<tr>
<td>开销标准</td>
<td>legacy : cost&#x3D;1<del>200000，华为私有<br />802.1d标准：cost&#x3D;1</del>65535<br />802.1t标准：cost&#x3D;1~200000000，默认</td>
</tr>
<tr>
<td>stp cost 10</td>
<td>修改STP开销</td>
</tr>
<tr>
<td>stp port priority 144</td>
<td>修改PID优先级，步长为16</td>
</tr>
<tr>
<td>display stp [brief]</td>
<td>显示STP配置信息和参数</td>
</tr>
</tbody></table>
]]></content>
      <categories>
        <category>网络</category>
      </categories>
      <tags>
        <tag>网络</tag>
        <tag>HCIA</tag>
      </tags>
  </entry>
  <entry>
    <title>HCIA VRRP远程管理试验</title>
    <url>/arlo/62028275/</url>
    <content><![CDATA[<h1 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h1><p>eNSP 1.3.00.100</p>
<p>VirtualBox 5.2.38 r136252</p>
<p>AR2220 x2 </p>
<p>S5700 </p>
<p>Cloud</p>
<h1 id="实验需求"><a href="#实验需求" class="headerlink" title="实验需求"></a>实验需求</h1><p><img src="/images/2021/0623/00.png" alt="01"></p>
<ol>
<li><p>通过本地环回地址模拟远程管理</p>
</li>
<li><p>配置password认证，实现telnet远程连接</p>
</li>
<li><p>配置三个用户，分别分配监控、配置和管理级别权限，实现telnet远程连接</p>
<span id="more"></span></li>
</ol>
<h1 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h1><table>
<thead>
<tr>
<th>用户界面</th>
<th>编号</th>
</tr>
</thead>
<tbody><tr>
<td>Console</td>
<td>0</td>
</tr>
<tr>
<td>VTY</td>
<td>0-4 (最大可配置为0-14)</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>认证模式</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>Password</td>
<td>登录时只需要输入密码</td>
</tr>
<tr>
<td>AAA</td>
<td>登录时需要输入用户和密码，更加安全（推荐）</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>用户等级</th>
<th>命令级别</th>
<th align="left">权限</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>0</td>
<td align="left">访问级</td>
<td>网络诊断工具命令（ping，tracert），从本设备出发访问外部设备的命令（telnet客户端）、部分display命令等</td>
</tr>
<tr>
<td>1</td>
<td>0,1</td>
<td align="left">监控级</td>
<td>用于系统维护，包含display等命令。并不是所有的display命令都是监控机的，比如display current-configuration和display saved-configuration命令是3级管理级</td>
</tr>
<tr>
<td>2</td>
<td>0,1,2</td>
<td align="left">配置级</td>
<td>业务配置命令，包括路由、各个网络层级的命令，向用户提供直接网络服务</td>
</tr>
<tr>
<td>3-15</td>
<td>0,1,2,3（高级别的包含低级别的命令）</td>
<td align="left">管理级</td>
<td>用于系统基本运行的命令，对业务提供支撑作用，包括文件系统，FTP,TFTP下载，命令级别设置命令以及用于业务故障诊断的debugging命令等。</td>
</tr>
</tbody></table>
<h1 id="实验过程"><a href="#实验过程" class="headerlink" title="实验过程"></a>实验过程</h1><h2 id="建立本地环回网卡"><a href="#建立本地环回网卡" class="headerlink" title="建立本地环回网卡"></a>建立本地环回网卡</h2><ol>
<li>打开设备管理器，操作，添加过时硬件</li>
</ol>
<p><img src="/images/2021/0623/01.png" alt="01"></p>
<ol start="2">
<li>手动从列表中选择硬件</li>
</ol>
<p><img src="/images/2021/0623/02.png" alt="01"></p>
<ol start="3">
<li>添加网络使配置</li>
</ol>
<p><img src="/images/2021/0623/03.png" alt="01"></p>
<ol start="4">
<li>选择Microsoft-环回适配器（win10之前的系统可能显示为loopback）</li>
</ol>
<p><img src="/images/2021/0623/04.png" alt="01"></p>
<p><img src="/images/2021/0623/05.png" alt="01"></p>
<p><img src="/images/2021/0623/06.png" alt="01"></p>
<ol start="5">
<li>按规划配置换回网卡ip地址</li>
</ol>
<p><img src="/images/2021/0623/07.png" alt="01"></p>
<h2 id="配置Cloud"><a href="#配置Cloud" class="headerlink" title="配置Cloud"></a>配置Cloud</h2><ol>
<li>绑定信息选择UDP,点击增加</li>
</ol>
<p><img src="/images/2021/0623/08.png" alt="01"></p>
<ol start="2">
<li>绑定信息选择环回网卡，点击增加（不建议绑定本地物理网卡， 可能会出现不通的情况；如果没有发现环回网卡，需要重启电脑）</li>
</ol>
<p><img src="/images/2021/0623/09.png" alt="01"></p>
<ol start="3">
<li>端口映射设置，出入口分别为1,2，勾选“双向通道”，点击增加</li>
</ol>
<p><img src="/images/2021/0623/10.png" alt="01"></p>
<p><img src="/images/2021/0623/11.png" alt="01"></p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>telnet server enable</td>
<td>开启telnet server服务</td>
</tr>
<tr>
<td>display telnet server status</td>
<td>查看telnet server 服务状态</td>
</tr>
<tr>
<td>user-interface vty 0 4<br/>  authentication-mode password<br/>  set authentication password cipher 111.com<br/>  user privilege level 15<br/>user-interface maximum-vty 15</td>
<td>进入VTY配置模式<br/>  配置认证模式<br/>  配置认证密码<br/>  配置用户级别<br/>配置最大vty会话数量</td>
</tr>
<tr>
<td>user-interface vty 0 4<br/>  authentication-mode aaa<br/>  aaa<br/>  local-user jack password cipher 111.com<br/>  local-user jack privilege level 1<br/>  local-user jack service-type telnet</td>
<td>进入VTY配置模式<br/>  配置认证模式<br/>进入AAA配置模式<br/>  创建用户名和密码<br/>  配置用户级别<br/>  配置用户可用服务</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#R1配置</span><br><span class="line">sys</span><br><span class="line">sys R1</span><br><span class="line">int g0/0/0</span><br><span class="line">ip addr 1.1.1.1 24</span><br><span class="line"></span><br><span class="line">telnet server enable</span><br><span class="line"></span><br><span class="line">user-interface vty 0 4</span><br><span class="line">authentication-mode password </span><br><span class="line"># 这里要手动输入一下密码</span><br><span class="line">set authentication password cipher 111.com</span><br><span class="line">user privilege level 15</span><br><span class="line">q</span><br><span class="line">user-interface maximum-vty 15</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#R2配置</span><br><span class="line">sys</span><br><span class="line">sys R2</span><br><span class="line">int g0/0/0</span><br><span class="line">ip addr 1.1.1.2 24</span><br><span class="line"></span><br><span class="line">telnet server enable</span><br><span class="line"></span><br><span class="line">user-interface vty 0 4</span><br><span class="line">authentication-mode aaa</span><br><span class="line">aaa</span><br><span class="line">  local-user jack password cipher 111.com</span><br><span class="line">  local-user jack privilege level 1</span><br><span class="line">  local-user jack service-type telnet</span><br><span class="line">  local-user rose password cipher 222.com</span><br><span class="line">  local-user rose privilege level 2</span><br><span class="line">  local-user rose service-type telnet</span><br><span class="line">  local-user james password cipher 333.com</span><br><span class="line">  local-user james privilege level 15</span><br><span class="line">  local-user james service-type telnet</span><br></pre></td></tr></table></figure>

<h1 id="远程连接测试"><a href="#远程连接测试" class="headerlink" title="远程连接测试"></a>远程连接测试</h1><p><img src="/images/2021/0623/12.png" alt="01"></p>
<p>学习视频：<a href="https://www.bilibili.com/video/BV1Dg4y187bZ?p=25">https://www.bilibili.com/video/BV1Dg4y187bZ?p=25</a></p>
]]></content>
      <categories>
        <category>网络</category>
      </categories>
      <tags>
        <tag>网络</tag>
        <tag>HCIA</tag>
      </tags>
  </entry>
  <entry>
    <title>HCIA 综合实验（终）</title>
    <url>/arlo/a36e3eba/</url>
    <content><![CDATA[<h1 id="实验要求"><a href="#实验要求" class="headerlink" title="实验要求"></a>实验要求</h1><p>【配置说明】<br>配置所需的IP地址，都已在拓扑图上标注。</p>
<p><img src="/images/2021/0807/01.png" alt="01"></p>
<span id="more"></span>

<p>【配置要求】</p>
<ol>
<li>配置telnet，要求所有网络设备均支持远程管理，密码为000.com</li>
<li>配置Trunk，交换机之间的链路均为Trunk模式</li>
<li>配置VLAN,在SW2和SW3上创建相关VLAN，关联4台PC到对应的VLAN接口</li>
<li>配置MLS,通过SW1实现VLAN间路由</li>
<li>配置DHCP,使SW1成为所有的VLAN的根桥，要求手动修改优先级为4096</li>
<li>配置OSPF,企业内网运行ospf1</li>
<li>配置缺省和NAT，在R1上配置静态缺省路由，SW1通过OSPF学习缺省路由</li>
<li>配置NAT,在R1上配置PAT(只需要转换四个VLAN网段)</li>
<li>配置ppp，R1和R2之间封装协议为ppp,使用CHAP双向认证，密码为111.com</li>
<li>配置OSPF，R2和R3和R4之间运行ospf2</li>
<li>配置DNS，可以通过<a href="http://www.abc.com/">www.abc.com</a> 访问HTTP服务器，通过<a href="http://www.123.com访问ftp服务器/">www.123.com访问FTP服务器</a></li>
<li>配置ACL，在R1上配置ACL，拒绝VLAN10的主机通过浏览器访问http服务器，其他流量不受影响</li>
</ol>
<h1 id="配置过程"><a href="#配置过程" class="headerlink" title="配置过程"></a>配置过程</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#SW2</span><br><span class="line">sys</span><br><span class="line">sys SW2</span><br><span class="line"></span><br><span class="line">user-interface vty 0 4</span><br><span class="line">authentication-mode aaa</span><br><span class="line">aaa</span><br><span class="line"> local-user pengxb password cipher 000.com</span><br><span class="line"> local-user pengxb privilege level 15</span><br><span class="line"> local-user pengxb service-type telnet</span><br><span class="line"></span><br><span class="line">vlan batch 10 20 30 40</span><br><span class="line">int eth0/0/1</span><br><span class="line">p l t</span><br><span class="line">port trunk allow-pass vlan 10 20 30 40</span><br><span class="line">int eth0/0/2</span><br><span class="line">p l t</span><br><span class="line">port trunk allow-pass vlan 10 20 30 40</span><br><span class="line">int eth0/0/3</span><br><span class="line">p l a</span><br><span class="line">p d vlan 10</span><br><span class="line">int eth0/0/4</span><br><span class="line">p l a</span><br><span class="line">p d vlan 20</span><br><span class="line"></span><br><span class="line">#####################################################</span><br><span class="line">#SW3</span><br><span class="line">sys</span><br><span class="line">sys SW3</span><br><span class="line"></span><br><span class="line">user-interface vty 0 4</span><br><span class="line">authentication-mode aaa</span><br><span class="line">aaa</span><br><span class="line"> local-user pengxb password cipher 000.com</span><br><span class="line"> local-user pengxb privilege level 15</span><br><span class="line"> local-user pengxb service-type telnet</span><br><span class="line"></span><br><span class="line">vlan batch 10 20 30 40</span><br><span class="line">int eth0/0/1</span><br><span class="line">p l t</span><br><span class="line">port trunk allow-pass vlan 10 20 30 40</span><br><span class="line">int eth0/0/2</span><br><span class="line">p l t</span><br><span class="line">port trunk allow-pass vlan 10 20 30 40</span><br><span class="line">int eth0/0/3</span><br><span class="line">p l a</span><br><span class="line">p d vlan 30</span><br><span class="line">int eth0/0/4</span><br><span class="line">p l a</span><br><span class="line">p d vlan 40</span><br><span class="line">#####################################################</span><br><span class="line">sys</span><br><span class="line">sys SW1</span><br><span class="line"></span><br><span class="line">stp priority 4096</span><br><span class="line">dhcp enable</span><br><span class="line">user-interface vty 0 4</span><br><span class="line">authentication-mode aaa</span><br><span class="line">aaa</span><br><span class="line"> local-user pengxb password cipher 000.com</span><br><span class="line"> local-user pengxb privilege level 15</span><br><span class="line"> local-user pengxb service-type telnet</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vlan batch 10 20 30 40 12</span><br><span class="line">int g0/0/1</span><br><span class="line">p l a</span><br><span class="line">p d vlan 12 </span><br><span class="line">int vlanif12</span><br><span class="line">ip a 192.168.12.1 24</span><br><span class="line"></span><br><span class="line">int g0/0/2</span><br><span class="line">p l t</span><br><span class="line">port trunk allow-pass vlan 10 20 30 40</span><br><span class="line">int g0/0/3</span><br><span class="line">p l t</span><br><span class="line">port trunk allow-pass vlan 10 20 30 40</span><br><span class="line"></span><br><span class="line">int vlanif10</span><br><span class="line">ip a 192.168.10.254 24</span><br><span class="line">dhcp select interface</span><br><span class="line">dhcp server dns-list 3.0.0.1</span><br><span class="line"></span><br><span class="line">int vlanif20</span><br><span class="line">ip a 192.168.20.254 24</span><br><span class="line">dhcp select interface</span><br><span class="line">dhcp server dns-list 3.0.0.1</span><br><span class="line"></span><br><span class="line">int vlanif30</span><br><span class="line">ip a 192.168.30.254 24</span><br><span class="line">dhcp select interface</span><br><span class="line">dhcp server dns-list 3.0.0.1</span><br><span class="line"></span><br><span class="line">int vlanif40</span><br><span class="line">ip a 192.168.40.254 24</span><br><span class="line">dhcp select interface</span><br><span class="line">dhcp server dns-list 3.0.0.1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ospf 1 router-id 192.168.12.1</span><br><span class="line">area 0 </span><br><span class="line">network 192.168.10.0 0.0.0.255</span><br><span class="line">network 192.168.20.0 0.0.0.255</span><br><span class="line">network 192.168.30.0 0.0.0.255</span><br><span class="line">network 192.168.40.0 0.0.0.255</span><br><span class="line">network 192.168.12.1 0.0.0.0</span><br><span class="line"></span><br><span class="line">#####################################################</span><br><span class="line">sys</span><br><span class="line">sys R1</span><br><span class="line"></span><br><span class="line">user-interface vty 0 4</span><br><span class="line">authentication-mode aaa</span><br><span class="line">aaa</span><br><span class="line"> local-user pengxb password cipher 000.com</span><br><span class="line"> local-user pengxb privilege level 15</span><br><span class="line"> local-user pengxb service-type telnet</span><br><span class="line"></span><br><span class="line">acl 2000</span><br><span class="line">rule 1 permit </span><br><span class="line">acl 3000</span><br><span class="line">rule 1 deny tcp source 192.168.10.0 0.0.0.255 destination 4.0.0.1 0</span><br><span class="line"></span><br><span class="line">int g0/0/0</span><br><span class="line">ip a 192.168.12.2 24</span><br><span class="line">traffic-filter inbound acl 3000</span><br><span class="line"></span><br><span class="line">int s4/0/0</span><br><span class="line">ip a 12.0.0.1 24</span><br><span class="line">ppp chap user ppp</span><br><span class="line">ppp chap password cipher 111.com</span><br><span class="line"></span><br><span class="line">nat outbound 2000</span><br><span class="line">ppp authentication-mode chap</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ospf 1 router-id 192.168.12.2</span><br><span class="line">area 0</span><br><span class="line">network 192.168.12.2 0.0.0.0</span><br><span class="line">default-route-advertise</span><br><span class="line">q</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ip route-static 0.0.0.0 0 12.0.0.2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#####################################################</span><br><span class="line">sys</span><br><span class="line">sys R2</span><br><span class="line"></span><br><span class="line">user-interface vty 0 4</span><br><span class="line">authentication-mode aaa</span><br><span class="line">aaa</span><br><span class="line"> local-user pengxb password cipher 000.com</span><br><span class="line"> local-user pengxb privilege level 15</span><br><span class="line"> local-user pengxb service-type telnet</span><br><span class="line"> local-user ppp password cipher 111.com</span><br><span class="line"> local-user ppp service-type ppp</span><br><span class="line"></span><br><span class="line">int s4/0/0</span><br><span class="line">ip a 12.0.0.2 24</span><br><span class="line"></span><br><span class="line">int g0/0/0</span><br><span class="line">ip a 23.0.0.1 24</span><br><span class="line">int g0/0/1</span><br><span class="line">ip a 24.0.0.1 24</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ospf 2 router-id 23.0.0.1</span><br><span class="line">area 0</span><br><span class="line">network 23.0.0.0 0.0.0.255</span><br><span class="line">network 24.0.0.0 0.0.0.255</span><br><span class="line">network 12.0.0.2 0.0.0.0</span><br><span class="line"></span><br><span class="line">#####################################################</span><br><span class="line">sys</span><br><span class="line">sys R3</span><br><span class="line"></span><br><span class="line">user-interface vty 0 4</span><br><span class="line">authentication-mode aaa</span><br><span class="line">aaa</span><br><span class="line"> local-user pengxb password cipher 000.com</span><br><span class="line"> local-user pengxb privilege level 15</span><br><span class="line"> local-user pengxb service-type telnet</span><br><span class="line"> </span><br><span class="line">int g0/0/0</span><br><span class="line">ip a 23.0.0.2 24</span><br><span class="line">int g0/0/1</span><br><span class="line">ip a 34.0.0.1 24</span><br><span class="line">int g0/0/2</span><br><span class="line">ip a 3.0.0.254 24</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ospf 2 router-id 23.0.0.2</span><br><span class="line">area 0</span><br><span class="line">network 23.0.0.0 0.0.0.255</span><br><span class="line">network 34.0.0.0 0.0.0.255</span><br><span class="line">network 3.0.0.0 0.0.0.255</span><br><span class="line">#####################################################</span><br><span class="line">sys</span><br><span class="line">sys R4</span><br><span class="line"></span><br><span class="line">user-interface vty 0 4</span><br><span class="line">authentication-mode aaa</span><br><span class="line">aaa</span><br><span class="line"> local-user pengxb password cipher 000.com</span><br><span class="line"> local-user pengxb privilege level 15</span><br><span class="line"> local-user pengxb service-type telnet</span><br><span class="line"> </span><br><span class="line">int g0/0/0</span><br><span class="line">ip a 24.0.0.2 24</span><br><span class="line">int g0/0/1</span><br><span class="line">ip a 34.0.0.2 24</span><br><span class="line">int g0/0/2</span><br><span class="line">ip a 4.0.0.254 24</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ospf 2 router-id 24.0.0.2</span><br><span class="line">area 0</span><br><span class="line">network 24.0.0.0 0.0.0.255</span><br><span class="line">network 34.0.0.0 0.0.0.255</span><br><span class="line">network 4.0.0.0 0.0.0.255</span><br></pre></td></tr></table></figure>

<h1 id="验证配置结果"><a href="#验证配置结果" class="headerlink" title="验证配置结果"></a>验证配置结果</h1><p>从pc2 ping 服务器</p>
<p><img src="/images/2021/0807/02.png" alt="01"></p>
<p>开启dns服务，配置域名解析</p>
<p><img src="/images/2021/0807/00.png" alt="01"></p>
<p>在服务器上开启ftp和http服务</p>
<p><img src="/images/2021/0807/03.png" alt="01"></p>
<p><img src="/images/2021/0807/04.png" alt="01"></p>
<p>在client1上测试ftp访问</p>
<p><img src="/images/2021/0807/05.png" alt="01"></p>
<p>关闭&amp;开启acl过滤，测试</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#AR1</span><br><span class="line">int g0/0/0</span><br><span class="line">#关闭acl过滤</span><br><span class="line">undo traffic-filter inbound</span><br><span class="line">#开启acl过滤</span><br><span class="line">traffic-filter inbound acl 3000</span><br></pre></td></tr></table></figure>

<p><img src="/images/2021/0807/06.png" alt="01"></p>
<p><img src="/images/2021/0807/07.png" alt="01"></p>
]]></content>
      <categories>
        <category>网络</category>
      </categories>
      <tags>
        <tag>网络</tag>
        <tag>HCIA</tag>
      </tags>
  </entry>
  <entry>
    <title>HCIA 路由综合实验</title>
    <url>/arlo/6733a169/</url>
    <content><![CDATA[<p>学完静态、rip、ospf路由后，做一下综合路由实验。</p>
<p>这老师讲的真不错，<a href="https://www.bilibili.com/video/BV1Dg4y187bZ?p=41">https://www.bilibili.com/video/BV1Dg4y187bZ?p=41</a></p>
<p><img src="/images/2021/0726/01.png" alt="01"></p>
<span id="more"></span>

<p>配置命令</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#AR1</span><br><span class="line">sys</span><br><span class="line">sys R1</span><br><span class="line">int g0/0/0</span><br><span class="line">ip add 192.168.255.2 30</span><br><span class="line">int g0/0/1</span><br><span class="line">ip add 10.1.1.1 30</span><br><span class="line"></span><br><span class="line">rip 1</span><br><span class="line">ver 2</span><br><span class="line">network 10.0.0.0</span><br><span class="line"></span><br><span class="line">ip route-static 0.0.0.0 0 192.168.255.1</span><br><span class="line">##################################################################################################</span><br><span class="line">#AR2</span><br><span class="line">sys</span><br><span class="line">sys R2</span><br><span class="line">int g0/0/0</span><br><span class="line">ip a 10.1.1.2 30</span><br><span class="line">int lo 1</span><br><span class="line">ip a 2.2.2.2 32</span><br><span class="line"></span><br><span class="line">rip 1</span><br><span class="line">ver 2</span><br><span class="line">network 10.0.0.0</span><br><span class="line">network 2.0.0.0</span><br><span class="line"></span><br><span class="line">ip route-static 0.0.0.0 0 10.1.1.1</span><br><span class="line">##################################################################################################</span><br><span class="line">#AR3</span><br><span class="line">sys </span><br><span class="line">sys R3</span><br><span class="line">int g0/0/0</span><br><span class="line">ip a 192.168.255.1 30</span><br><span class="line">int g0/0/1</span><br><span class="line">ip a 151.151.1.2 30</span><br><span class="line"></span><br><span class="line">ip route-static 10.1.1.0 30 192.168.255.2</span><br><span class="line">ip route-static 2.2.2.2 32 192.168.255.2</span><br><span class="line">ip route-static 131.131.255.0 28 151.151.1.1</span><br><span class="line">ip route-static 7.7.7.7 32 151.151.1.1</span><br><span class="line">##################################################################################################</span><br><span class="line">#AR4</span><br><span class="line">sys</span><br><span class="line">sys R4</span><br><span class="line">int g0/0/0</span><br><span class="line">ip a 151.151.1.1 30</span><br><span class="line">int g0/0/1</span><br><span class="line">ip a 131.131.255.13 30</span><br><span class="line">int s4/0/0</span><br><span class="line">ip a 131.131.255.6 30</span><br><span class="line"></span><br><span class="line">ospf 1 router-id 4.4.4.4</span><br><span class="line">area 0</span><br><span class="line">network 131.131.255.12 0.0.0.3</span><br><span class="line">network 131.131.255.4 0.0.0.3</span><br><span class="line"></span><br><span class="line">ip route-static 0.0.0.0 0 151.151.1.2</span><br><span class="line"></span><br><span class="line">ospf 1</span><br><span class="line">default-route-advertise</span><br><span class="line">##################################################################################################</span><br><span class="line">#AR5</span><br><span class="line">sys</span><br><span class="line">sys R5</span><br><span class="line">int g0/0/0</span><br><span class="line">ip a 131.131.255.14 30</span><br><span class="line">int g0/0/1</span><br><span class="line">ip a 131.131.255.10 30</span><br><span class="line"></span><br><span class="line">ospf 1 router-id 5.5.5.5</span><br><span class="line">area 0</span><br><span class="line">network 131.131.255.12 0.0.0.3</span><br><span class="line">network 131.131.255.8 0.0.0.3</span><br><span class="line">##################################################################################################</span><br><span class="line">#AR6</span><br><span class="line">sys</span><br><span class="line">sys R6</span><br><span class="line">int g0/0/0</span><br><span class="line">ip a 131.131.255.9 30</span><br><span class="line">int g0/0/1</span><br><span class="line">ip ad 131.131.255.1 30</span><br><span class="line">int s4/0/0</span><br><span class="line">ip a 131.131.255.5 30</span><br><span class="line"></span><br><span class="line">ospf 1 router-id 6.6.6.6</span><br><span class="line">area 0</span><br><span class="line">network 131.131.255.8 0.0.0.3</span><br><span class="line">network 131.131.255.4 0.0.0.3</span><br><span class="line">network 131.131.255.0 0.0.0.3</span><br><span class="line">##################################################################################################</span><br><span class="line">#AR7</span><br><span class="line">sys</span><br><span class="line">sys R7</span><br><span class="line">int g0/0/0</span><br><span class="line">ip a 131.131.255.2 30</span><br><span class="line">int lo 1</span><br><span class="line">ip a 7.7.7.7 32</span><br><span class="line"></span><br><span class="line">ospf 1 router-id 7.7.7.7</span><br><span class="line">area 0</span><br><span class="line">network 131.131.255.0 0.0.0.3</span><br><span class="line">network 7.7.7.7 0.0.0.0</span><br></pre></td></tr></table></figure>

<p><img src="/images/2021/0726/02.png" alt="01"></p>
<p><img src="/images/2021/0726/03.png" alt="01"></p>
<p><img src="/images/2021/0726/04.png" alt="01"></p>
<p><img src="/images/2021/0726/05.png" alt="01"></p>
]]></content>
      <categories>
        <category>网络</category>
      </categories>
      <tags>
        <tag>网络</tag>
        <tag>HCIA</tag>
      </tags>
  </entry>
  <entry>
    <title>HCIA 静态路由实验</title>
    <url>/arlo/d4aba23c/</url>
    <content><![CDATA[<p>静态路由配置原则：</p>
<ul>
<li>分析目标网络，除了直连路由，缺少几个网络配置几条路由即可。</li>
<li>路由是双向的，有去有回网络才通</li>
</ul>
<span id="more"></span>

<table>
<thead>
<tr>
<th>路由表字段</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Destination</td>
<td>目标，用来标识IP包的目标地址或目标网络</td>
</tr>
<tr>
<td>Mask</td>
<td>掩码，选择最佳路由的重要判断依据（最长匹配原则）</td>
</tr>
<tr>
<td>NextHop</td>
<td>下一跳，指明IP包所经由的下一个路由器的接口地址</td>
</tr>
<tr>
<td>Interface</td>
<td>出接口，指明IP包将从该路由的哪个接口转发出去</td>
</tr>
<tr>
<td>Protocol</td>
<td>协议，路由的来源、学习方式</td>
</tr>
<tr>
<td>Preference</td>
<td>优先级，比较不同路由来源到达相同目标网络的优先级，越低越优先</td>
</tr>
<tr>
<td>Cost</td>
<td>度量值，比较相同路由来源到达相同目标网络的不同路径的优先级，越低越优先</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>路由类型</th>
<th>Direct</th>
<th>OSPF</th>
<th>STATIC</th>
<th>RIP</th>
</tr>
</thead>
<tbody><tr>
<td>管理距离</td>
<td>0</td>
<td>10</td>
<td>60</td>
<td>100</td>
</tr>
</tbody></table>
<h1 id="静态路由配置"><a href="#静态路由配置" class="headerlink" title="静态路由配置"></a>静态路由配置</h1><p>实验要求：</p>
<p>PC1：1.0.0.0&#x2F;24 PC2：2.0.0.0&#x2F;24 PC3：3.0.0.0&#x2F;4 配置静态路由，3台PC相互连通。 </p>
<p><img src="/images/2021/0701/01.png" alt="01"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#AR1</span><br><span class="line">sys</span><br><span class="line">sys R1</span><br><span class="line">int g0/0/0</span><br><span class="line">ip add 1.0.0.1 24</span><br><span class="line"></span><br><span class="line">int g0/0/1</span><br><span class="line">ip add 2.0.0.1 24</span><br><span class="line"></span><br><span class="line">int g0/0/2</span><br><span class="line">ip add 12.0.0.2 24</span><br><span class="line">ip route-s 3.0.0.0 24 12.0.0.1</span><br><span class="line"></span><br><span class="line">#AR2</span><br><span class="line">sys</span><br><span class="line">sys R2</span><br><span class="line">int g0/0/0</span><br><span class="line">ip add 12.0.0.1 24</span><br><span class="line"></span><br><span class="line">int g0/0/1</span><br><span class="line">ip add 3.0.0.1 24</span><br><span class="line"></span><br><span class="line">ip route-s 1.0.0.0 24 12.0.0.2</span><br><span class="line">ip route-s 2.0.0.0 24 12.0.0.2</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="负载分担"><a href="#负载分担" class="headerlink" title="负载分担"></a>负载分担</h1><p>静态路由支持到达统一目标网络的等价负载分担</p>
<p><img src="/images/2021/0701/02.png" alt="01"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#AR1</span><br><span class="line">sys</span><br><span class="line">sys R1</span><br><span class="line">int g0/0/0</span><br><span class="line">ip add 1.0.0.1 24</span><br><span class="line"></span><br><span class="line">int g0/0/1</span><br><span class="line">ip add 34.0.0.2 24</span><br><span class="line"></span><br><span class="line">int g0/0/2</span><br><span class="line">ip add 12.0.0.2 24</span><br><span class="line"></span><br><span class="line">ip route-s 3.0.0.0 24 12.0.0.1</span><br><span class="line">ip route-s 3.0.0.0 24 34.0.0.1</span><br><span class="line"></span><br><span class="line">#AR2</span><br><span class="line">sys</span><br><span class="line">sys R2</span><br><span class="line"></span><br><span class="line">int g0/0/1</span><br><span class="line">ip add 3.0.0.1 24</span><br><span class="line"></span><br><span class="line">int g0/0/0</span><br><span class="line">ip add 12.0.0.1 24</span><br><span class="line">int g0/0/2</span><br><span class="line">ip addr 34.0.0.1 24</span><br><span class="line"></span><br><span class="line">ip route-s 1.0.0.0 24 12.0.0.2</span><br><span class="line">ip route-s 1.0.0.0 24 34.0.0.2</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/images/2021/0701/06.png" alt="01"></p>
<p>负载路由ping测试</p>
<p><img src="/images/2021/0701/03.png" alt="01"></p>
<p>负载路由tracert测试</p>
<p><img src="/images/2021/0701/04.png" alt="01"></p>
<h1 id="路由备份-浮动静态路由"><a href="#路由备份-浮动静态路由" class="headerlink" title="路由备份-浮动静态路由"></a>路由备份-浮动静态路由</h1><ul>
<li>利用优先级的特性，配置浮动路由</li>
<li>在主路由失效的情况下，浮动路由会加入到路由表并承担数据转发业务</li>
</ul>
<p><img src="/images/2021/0701/07.png" alt="01"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">- #AR1</span><br><span class="line">sys</span><br><span class="line">sys R1</span><br><span class="line">int g0/0/0</span><br><span class="line">ip add 1.0.0.1 24</span><br><span class="line"></span><br><span class="line">int g0/0/1</span><br><span class="line">ip add 34.0.0.2 24</span><br><span class="line"></span><br><span class="line">int g0/0/2</span><br><span class="line">ip add 12.0.0.2 24</span><br><span class="line">ip route-s 3.0.0.0 24 12.0.0.1</span><br><span class="line">ip route-s 3.0.0.0 24 34.0.0.1 preference 100</span><br><span class="line"></span><br><span class="line">#AR2</span><br><span class="line">sys</span><br><span class="line">sys R2</span><br><span class="line"></span><br><span class="line">int g0/0/1</span><br><span class="line">ip add 3.0.0.1 24</span><br><span class="line"></span><br><span class="line">int g0/0/0</span><br><span class="line">ip add 12.0.0.1 24</span><br><span class="line">int g0/0/2</span><br><span class="line">ip addr 34.0.0.1 24</span><br><span class="line">ip route-s 1.0.0.0 24 12.0.0.2 </span><br><span class="line">ip route-s 1.0.0.0 24 34.0.0.2 preference 100</span><br></pre></td></tr></table></figure>

<p><img src="/images/2021/0701/05.png" alt="01"></p>
<h1 id="回环口Loopback"><a href="#回环口Loopback" class="headerlink" title="回环口Loopback"></a>回环口Loopback</h1><p>回环口作用</p>
<ul>
<li>模拟直连网段，可用于测试</li>
<li>设备管理（稳定）</li>
<li>供其他协议使用（OSPF、BGP、MPLS等）</li>
<li>SNMP Traps消息的源地址</li>
<li>其他用途（用途十分广泛）</li>
</ul>
<p><img src="/images/2021/0701/08.png" alt="01"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#AR1</span><br><span class="line">sys</span><br><span class="line">sys R1</span><br><span class="line">int g0/0/0</span><br><span class="line">ip add 1.0.0.1 24</span><br><span class="line">int lo 1</span><br><span class="line">ip add 3.0.0.1 24</span><br><span class="line"></span><br><span class="line">ip route-static 4.0.0.0 24 1.0.0.2</span><br><span class="line"></span><br><span class="line">#AR2</span><br><span class="line">sys</span><br><span class="line">sys R2</span><br><span class="line">int g0/0/0</span><br><span class="line">ip add 1.0.0.2 24</span><br><span class="line">int lo 1</span><br><span class="line">ip add 4.0.0.1 24</span><br><span class="line"></span><br><span class="line">ip route-s 3.0.0.0 24 1.0.0.1</span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#使用-a参数，可以指定源地址（Src），默认源地址为出接口地址</span><br><span class="line">ping -a 4.0.0.1 3.0.0.1</span><br></pre></td></tr></table></figure>
<p>实现4.0.0.1 和3.0.0.1可以互相ping通。</p>
]]></content>
      <categories>
        <category>网络</category>
      </categories>
      <tags>
        <tag>网络</tag>
        <tag>HCIA</tag>
      </tags>
  </entry>
  <entry>
    <title>NFS服务搭建及常用操作命令记录</title>
    <url>/arlo/f828840b/</url>
    <content><![CDATA[<p>NFS 是Network File System的缩写，即网络文件系统。NFS在文件传送或信息传送过程中依赖于RPC协议。(nfs服务器是搭建过程最简单的服务，鲁迅说的……）</p>
<h1 id="服务端安装"><a href="#服务端安装" class="headerlink" title="服务端安装"></a>服务端安装</h1><p>安装NFS服务端</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum install nfs-utils rpcbind </span><br></pre></td></tr></table></figure>

<p>设置 NFS 服务开机启动</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl enable rpcbind</span><br><span class="line">systemctl enable nfs</span><br><span class="line">systemctl start rpcbind</span><br><span class="line">systemctl start nfs</span><br></pre></td></tr></table></figure>

<p>开放防火墙策略</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">firewall-cmd --zone=public --permanent --add-service=&#123;rpc-bind,mountd,nfs&#125;</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h1 id="配置共享目录"><a href="#配置共享目录" class="headerlink" title="配置共享目录"></a>配置共享目录</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir /data/nfs_share</span><br><span class="line">chmod 755 /data/nfs_share</span><br><span class="line"></span><br><span class="line">vim /etc/exports</span><br><span class="line">格式： 共享目录  客户端IP访问(权限)</span><br><span class="line"></span><br><span class="line">/data/nfs_share 192.168.100.0/24(rw,sync,no_root_squash)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">客户端IP范围常见写法：</span><br><span class="line">指定ip地址的主机：192.168.100.100</span><br><span class="line">指定子网中的所有主机：192.168.100.0/24 192.168.200.0/255.255.255.0</span><br><span class="line">指定域名的主机：david.bsmart.cn</span><br><span class="line">指定域中的所有主机：*.bsmart.cn</span><br><span class="line">所有主机：*</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NFS权限主要有3类选项：</span><br><span class="line"></span><br><span class="line">访问权限选项：</span><br><span class="line"></span><br><span class="line">设置输出目录只读：ro</span><br><span class="line">设置输出目录读写：rw</span><br><span class="line"></span><br><span class="line">用户映射选项：</span><br><span class="line"></span><br><span class="line">all_squash：将远程访问的所有普通用户及所属组都映射为匿名用户或用户组（nfsnobody）；</span><br><span class="line">no_all_squash：与all_squash取反（默认设置）；</span><br><span class="line">root_squash：将root用户及所属组都映射为匿名用户或用户组（默认设置）；</span><br><span class="line">no_root_squash：与rootsquash取反；</span><br><span class="line">anonuid=xxx：将远程访问的所有用户都映射为匿名用户，并指定该用户为本地用户（UID=xxx）；</span><br><span class="line">anongid=xxx：将远程访问的所有用户组都映射为匿名用户组账户，并指定该匿名用户组账户为本地用户组账户（GID=xxx）；</span><br><span class="line"></span><br><span class="line">其它选项：</span><br><span class="line"></span><br><span class="line">secure：限制客户端只能从小于1024的tcp/ip端口连接nfs服务器（默认设置）；</span><br><span class="line">insecure：允许客户端从大于1024的tcp/ip端口连接服务器；</span><br><span class="line">sync：将数据同步写入内存缓冲区与磁盘中，效率低，但可以保证数据的一致性；</span><br><span class="line">async：将数据先保存在内存缓冲区中，必要时才写入磁盘；</span><br><span class="line">wdelay：检查是否有相关的写操作，如果有则将这些写操作一起执行，这样可以提高效率（默认设置）；</span><br><span class="line">no_wdelay：若有写操作则立即执行，应与sync配合使用；</span><br><span class="line">subtree：若输出目录是一个子目录，则nfs服务器将检查其父目录的权限(默认设置)；</span><br><span class="line">no_subtree：即使输出目录是一个子目录，nfs服务器也不检查其父目录的权限，这样可以提高效率；</span><br></pre></td></tr></table></figure>

<h2 id="exportfs-命令"><a href="#exportfs-命令" class="headerlink" title="exportfs 命令"></a>exportfs 命令</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-a 全部挂载或卸载 /etc/exports中的内容</span><br><span class="line">-r 重新读取/etc/exports 中的信息 ，并同步更新/etc/exports、/var/lib/nfs/xtab</span><br><span class="line">-u 卸载单一目录（和-a一起使用为卸载所有/etc/exports文件中的目录）</span><br><span class="line">-v 在export的时候，将详细的信息输出到屏幕上。</span><br><span class="line"></span><br><span class="line">例：</span><br><span class="line"># exportfs -au 卸载所有共享目录</span><br><span class="line"># exportfs -rv 重新共享所有目录并输出详细信息（不用重启nfs服务即可加载配置文件生效）</span><br></pre></td></tr></table></figure>

<h2 id="showmount"><a href="#showmount" class="headerlink" title="showmount"></a>showmount</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-a 显示已经于客户端连接上的目录信息(查看谁连了我的NFS目录，nfsv3可以显示，v4显示为空，不清楚是什么原因？)</span><br><span class="line">-e IP或者hostname 显示此IP地址分享出来的目录</span><br><span class="line">–d 显示被client挂载的目录</span><br></pre></td></tr></table></figure>
<h2 id="nfsstat"><a href="#nfsstat" class="headerlink" title="nfsstat"></a>nfsstat</h2><p>查看nfs版本</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#服务端</span><br><span class="line">nfsstat -s</span><br><span class="line">#客户端</span><br><span class="line">nfsstat -c</span><br></pre></td></tr></table></figure>

<h1 id="客户端挂载"><a href="#客户端挂载" class="headerlink" title="客户端挂载"></a>客户端挂载</h1><h2 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">安装客户端工具</span><br><span class="line">yum -y install nfs-utils</span><br><span class="line">查看nfs服务共享资源</span><br><span class="line">showmount -e 192.168.100.132</span><br><span class="line">挂载nfs共享目录到本地</span><br><span class="line">格式： mount NFS服务器IP:共享目录 本地挂载点目录</span><br><span class="line">mount.nfs 192.168.100.132:/data/nfs_share /mnt</span><br><span class="line">卸载nfs挂载</span><br><span class="line">umount /mnt</span><br><span class="line"></span><br><span class="line">添加开机自动挂载，可以按以下格式写入/etc/fstab 文件</span><br><span class="line">192.168.100.132:/data/nfs_share 			/mnt	   nfs defaults 0 0 </span><br></pre></td></tr></table></figure>

<h2 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h2><p> 以Windows Server 2012为例，添加功能角色 - 添加文件打印服务 - NFS 客户端</p>
<p>参考链接：</p>
<p><a href="https://www.cnblogs.com/mchina/archive/2013/01/03/2840040.html">https://www.cnblogs.com/mchina/archive/2013/01/03/2840040.html</a></p>
<p><a href="https://bean-li.github.io/nfs-showmount/">https://bean-li.github.io/nfs-showmount/</a></p>
]]></content>
      <categories>
        <category>服务器搭建</category>
      </categories>
      <tags>
        <tag>nfs</tag>
      </tags>
  </entry>
  <entry>
    <title>Oracle DBLink简单使用</title>
    <url>/arlo/497f11e1/</url>
    <content><![CDATA[<p>Oracle跨数据库查询可以使用DBLink，建立一个DBLink指向另一个远程的Oracle数据库表。通过一个虚拟连接实现对远程数据库的增删改查。</p>
<h1 id="Oracle-Database-Link-分类"><a href="#Oracle-Database-Link-分类" class="headerlink" title="Oracle Database Link 分类"></a>Oracle Database Link 分类</h1><ul>
<li><p>private：创建的是用户级别的dblink，只有创建该dblink的用户才可以使用这个dblink来访问远程的数据库，同时也只有该用户可以删除这个dblink。(默认)</p>
</li>
<li><p>public：创建的是数据库级别的dblink，本地数据库中所有的用户数据库访问权限的用户或者pl&#x2F;sql程序都能使用这个dblink。</p>
</li>
<li><p>global：创建的是网络级别的dblink，这是对于oracle network而言的。</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE [链接类型] DATABASE LINK [DBLink链接名称] CONNECT TO [远程数据库用户] IDENTIFIED BY &quot;[远程数据库密码]&quot; </span><br><span class="line">USING &#x27;(DESCRIPTION =</span><br><span class="line">    (ADDRESS_LIST =</span><br><span class="line">      (ADDRESS = (PROTOCOL = TCP)(HOST = [远程数据库IP地址])(PORT = [远程数据库端口]))</span><br><span class="line">    )</span><br><span class="line">    (CONNECT_DATA =</span><br><span class="line">      (SERVER = DEDICATED)</span><br><span class="line">      (SERVICE_NAME = [远程数据库SERVICE_NAME])</span><br><span class="line">    )</span><br><span class="line">  )&#x27;;</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h1 id="创建public类型DBLink"><a href="#创建public类型DBLink" class="headerlink" title="创建public类型DBLink"></a>创建public类型DBLink</h1><ol>
<li>创建DBLink时候使用双引号将密码括起来，Oracle11g会将小写变成大写。</li>
<li>如果后期修改了远程数据库的密码，需要在DBLink中修改密码</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE PUBLIC DATABASE LINK &quot;DB_REMOTE&quot; CONNECT TO test IDENTIFIED BY &quot;AAbb111&quot; </span><br><span class="line">USING &#x27;(DESCRIPTION =</span><br><span class="line">  (ADDRESS_LIST =</span><br><span class="line">  (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.100.111)(PORT = 1521))</span><br><span class="line">  )</span><br><span class="line">  (CONNECT_DATA =</span><br><span class="line">    (SERVER = DEDICATED)</span><br><span class="line"> 	(SERVICE_NAME = ORCL)</span><br><span class="line">  )</span><br><span class="line">)&#x27;;</span><br></pre></td></tr></table></figure>

<h1 id="查看DBLink"><a href="#查看DBLink" class="headerlink" title="查看DBLink"></a>查看DBLink</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT OWNER, OBJECT_NAME  FROM DBA_OBJECTS WHERE OBJECT_TYPE = &#x27;DATABASE LINK&#x27;;</span><br><span class="line">--OR</span><br><span class="line">SELECT * FROM DBA_DB_LINKS;</span><br></pre></td></tr></table></figure>

<h1 id="使用DBLink"><a href="#使用DBLink" class="headerlink" title="使用DBLink"></a>使用DBLink</h1><h2 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h2><p>在表名后加上“[@DBLink链接名称]”即可，如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT SYSDATE FROM DUAL@DB_REMOTE;</span><br></pre></td></tr></table></figure>

<h2 id="创建同义词"><a href="#创建同义词" class="headerlink" title="创建同义词"></a>创建同义词</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE SYNONYM TEST_REMOTE FOR TEST@DB_REMOTE;</span><br><span class="line">-- 那么上面的查询、插入、修改、删除中可直接用TEST_REMOTE代替TEST@DB_REMOTE即可，例如查询语句可改成如下方式（插入，修改，删除类似）</span><br><span class="line">SELECT * FROM TEST_REMOTE ORDER BY ID;</span><br></pre></td></tr></table></figure>

<h1 id="修改DBLink"><a href="#修改DBLink" class="headerlink" title="修改DBLink"></a>修改DBLink</h1><p>如修改密码，也可以删除重建</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">alter database link [DBLink链接名称] connect to [远程数据库用户]  identified by &quot;[远程数据库密码]&quot; ;</span><br><span class="line">alter database link link_102 connect to test identified by &quot;abcABC&quot;;</span><br></pre></td></tr></table></figure>

<h1 id="删除DBLink"><a href="#删除DBLink" class="headerlink" title="删除DBLink"></a>删除DBLink</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">--删除private模式DBLink</span><br><span class="line">DROP DATABASE LINK [DBLink链接名称];</span><br><span class="line">--删除public模式DBLink</span><br><span class="line">DROP PUBLIC DATABASE LINK [DBLink链接名称]</span><br><span class="line">DROP PUBLIC DATABASE LINK DB_REMOTE;</span><br></pre></td></tr></table></figure>



<p>参考链接：<a href="https://www.cnblogs.com/kerrycode/p/10583216.html">https://www.cnblogs.com/kerrycode/p/10583216.html</a></p>
<p>​					<a href="https://www.cnblogs.com/samuelhu/p/12400543.html">https://www.cnblogs.com/samuelhu/p/12400543.html</a></p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>Oracle</tag>
      </tags>
  </entry>
  <entry>
    <title>Oracle报错_无法从套接字获取更多的数据</title>
    <url>/arlo/b9880cb2/</url>
    <content><![CDATA[<p>使用数据库连接工具查询数据报错“无法从套接字获取更多的数据，供应商错误17410”，alter_orcl.log中没有报错，oracle服务和监听正常，排查了数据库监听日志也没有报错，表空间容量也正常。在数据库本机查询正常，但是其他机器报错，重启了数据库也不行；经过查询，此错误为oracle的bug。</p>
<h1 id="查看日志"><a href="#查看日志" class="headerlink" title="查看日志"></a>查看日志</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Alert log XML文件位置：</span><br><span class="line">SQL&gt; select value from v$diag_info where name =&#x27;Diag Alert&#x27;;</span><br><span class="line">Alert log文本文件位置：</span><br><span class="line">SQL&gt; select value from v$diag_info where name =&#x27;Diag Trace&#x27;;</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h1 id="处理方式"><a href="#处理方式" class="headerlink" title="处理方式"></a>处理方式</h1><p>查看MOS和<strong>BUG 9050716</strong>比较匹配，禁用**_optimizer_join_elimination_enabled**参数问题解决；</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-- 查询语句</span><br><span class="line">select a.ksppinm name, b.ksppstvl value, a.ksppdesc description from x$ksppi a, x$ksppcv b where a.indx = b.indx and a.ksppinm = &#x27;_optimizer_join_elimination_enabled&#x27;;</span><br><span class="line">-- 关闭命令</span><br><span class="line">alter system set &quot;_optimizer_join_elimination_enabled&quot;=false scope=both;</span><br><span class="line">-- 设置完后不用重启服务</span><br></pre></td></tr></table></figure>

<p><img src="/images/2021/0511/01.jpg" alt="01"></p>
<p>参考链接：<a href="https://blog.csdn.net/hncu1306602liuqiang/article/details/104868578">https://blog.csdn.net/hncu1306602liuqiang/article/details/104868578</a></p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>Oracle</tag>
        <tag>Troubleshooting</tag>
      </tags>
  </entry>
  <entry>
    <title>zabbix(14) 使用Zabbix Agent2 监控Oracle 19c</title>
    <url>/arlo/94dfcf27/</url>
    <content><![CDATA[<p>监控oracle 12c2之前的版本，可以使用orabbix来实现，可参考：<a href="http://islocal.cc/arlo/780360a7/">http://islocal.cc/arlo/780360a7/</a></p>
<p>Zabbix 5.4，支持使用Zabbix agent2 来监控12c2,18c,19c，官网文档：<a href="https://www.zabbix.com/cn/integrations/oracle">https://www.zabbix.com/cn/integrations/oracle</a></p>
<table>
<thead>
<tr>
<th>角色</th>
<th>操作系统</th>
<th>主机名</th>
<th>IP地址</th>
</tr>
</thead>
<tbody><tr>
<td>Zabbix Server</td>
<td>CentOS Linux release 8.4.2105</td>
<td>s1</td>
<td>192.168.111.128</td>
</tr>
<tr>
<td>Zabbix agent2+Oracle服务器+Oracle Client</td>
<td>CentOS Linux release 7.9.2009 (Core)</td>
<td>db132</td>
<td>192.168.111.132</td>
</tr>
</tbody></table>
<span id="more"></span>

<h1 id="1-安装Zabbix-Agent2"><a href="#1-安装Zabbix-Agent2" class="headerlink" title="1. 安装Zabbix Agent2"></a>1. 安装Zabbix Agent2</h1><h2 id="1-1-安装Zabbix-Agent2"><a href="#1-1-安装Zabbix-Agent2" class="headerlink" title="1.1 安装Zabbix Agent2"></a>1.1 安装Zabbix Agent2</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rpm -ivh http://pub.mirrors.aliyun.com/zabbix/zabbix/5.4/rhel/7/x86_64/zabbix-agent2-5.4.7-1.el7.x86_64.rpm</span><br></pre></td></tr></table></figure>

<h2 id="1-2-修改zabbix-agent2-conf-配置文件"><a href="#1-2-修改zabbix-agent2-conf-配置文件" class="headerlink" title="1.2 修改zabbix_agent2.conf 配置文件"></a>1.2 修改zabbix_agent2.conf 配置文件</h2><p>修改Server和Hostname即可</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@db132 ~]# egrep -v &quot;^$|#&quot; /etc/zabbix/zabbix_agent2.conf </span><br><span class="line">PidFile=/var/run/zabbix/zabbix_agent2.pid</span><br><span class="line">LogFile=/var/log/zabbix/zabbix_agent2.log</span><br><span class="line">LogFileSize=0</span><br><span class="line">Server=192.168.111.128  #zabbix server 服务器地址</span><br><span class="line">ServerActive=127.0.0.1</span><br><span class="line">Hostname=db132    #本机主机名</span><br><span class="line">Include=/etc/zabbix/zabbix_agent2.d/*.conf</span><br><span class="line">ControlSocket=/tmp/agent.sock</span><br></pre></td></tr></table></figure>

<h2 id="1-3-启动zabbix-agent2"><a href="#1-3-启动zabbix-agent2" class="headerlink" title="1.3 启动zabbix-agent2"></a>1.3 启动zabbix-agent2</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl start zabbix-agent2</span><br><span class="line">systemctl enable zabbix-agent2</span><br><span class="line">systemctl status zabbix-agent2</span><br></pre></td></tr></table></figure>

<h1 id="2-配置Oracle数据库"><a href="#2-配置Oracle数据库" class="headerlink" title="2. 配置Oracle数据库"></a>2. 配置Oracle数据库</h1><p>Oracle 12c开始，数据库分为CDB和PDB，CDB为容器数据库，默认启动数据库启动就是CDB；PDB是和我们11g中使用的那种数据库，默认是MOUNTED状态， 需要手动启动，以下为启动过程。</p>
<h2 id="2-1-启动PDB"><a href="#2-1-启动PDB" class="headerlink" title="2.1 启动PDB"></a>2.1 启动PDB</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@db132 ~]# su - oracle</span><br><span class="line">Last login: Tue Nov 16 10:39:15 CST 2021 on pts/0</span><br><span class="line">[oracle@db132 ~]$ sqlplus / as sysdba</span><br><span class="line"></span><br><span class="line">SQL*Plus: Release 19.0.0.0.0 - Production on Tue Nov 16 10:42:19 2021</span><br><span class="line">Version 19.3.0.0.0</span><br><span class="line"></span><br><span class="line">Copyright (c) 1982, 2019, Oracle.  All rights reserved.</span><br><span class="line"></span><br><span class="line">Connected to an idle instance.</span><br><span class="line"></span><br><span class="line">SQL&gt; startup</span><br><span class="line">ORACLE instance started.</span><br><span class="line"></span><br><span class="line">Total System Global Area 1660941720 bytes</span><br><span class="line">Fixed Size		    9135512 bytes</span><br><span class="line">Variable Size		  989855744 bytes</span><br><span class="line">Database Buffers	  654311424 bytes</span><br><span class="line">Redo Buffers		    7639040 bytes</span><br><span class="line">Database mounted.</span><br><span class="line">Database opened.</span><br><span class="line">SQL&gt; show pdbs;</span><br><span class="line"></span><br><span class="line">    CON_ID CON_NAME			  OPEN MODE  RESTRICTED</span><br><span class="line">---------- ------------------------------ ---------- ----------</span><br><span class="line">	 2 PDB$SEED			  READ ONLY  NO</span><br><span class="line">	 3 ORCLPDB			  MOUNTED</span><br><span class="line">-- 这里可以看到有两个pdb数据库，PDB$SEED是创建pdb的模板数据库，是只读状态，看到ORCLPDB是MOUNTED状态，</span><br><span class="line">SQL&gt; select name,open_mode from v$pdbs;  </span><br><span class="line"></span><br><span class="line">NAME</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">OPEN_MODE</span><br><span class="line">--------------------</span><br><span class="line">PDB$SEED</span><br><span class="line">READ ONLY</span><br><span class="line"></span><br><span class="line">ORCLPDB</span><br><span class="line">MOUNTED</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SQL&gt; select name,open_mode from v$pdbs;  </span><br><span class="line"></span><br><span class="line">NAME</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">OPEN_MODE</span><br><span class="line">--------------------</span><br><span class="line">PDB$SEED</span><br><span class="line">READ ONLY</span><br><span class="line"></span><br><span class="line">ORCLPDB</span><br><span class="line">MOUNTED</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SQL&gt;  alter session set container=ORCLPDB; </span><br><span class="line"></span><br><span class="line">Session altered.</span><br><span class="line"></span><br><span class="line">SQL&gt; alter pluggable database open;</span><br><span class="line"></span><br><span class="line">Pluggable database altered.</span><br><span class="line"></span><br><span class="line">SQL&gt; select name,open_mode from v$pdbs;</span><br><span class="line"></span><br><span class="line">NAME</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">OPEN_MODE</span><br><span class="line">--------------------</span><br><span class="line">ORCLPDB</span><br><span class="line">READ WRITE</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SQL&gt; show pdbs;</span><br><span class="line"></span><br><span class="line">    CON_ID CON_NAME			  OPEN MODE  RESTRICTED</span><br><span class="line">---------- ------------------------------ ---------- ----------</span><br><span class="line">	 3 ORCLPDB			  READ WRITE NO</span><br><span class="line">-- 启动完成后只能看到一个ORCLPDB,状态为READ WRITE	 </span><br><span class="line">SQL&gt; </span><br></pre></td></tr></table></figure>

<h2 id="2-1-新建Oracle-监控账号"><a href="#2-1-新建Oracle-监控账号" class="headerlink" title="2.1 新建Oracle 监控账号"></a>2.1 新建Oracle 监控账号</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE USER zabbix_mon IDENTIFIED BY &lt;PASSWORD&gt;;  #创建一个用户/密码都为zabbix_mon的用户</span><br><span class="line">-- Grant access to the zabbix_mon user.</span><br><span class="line">#这里有个细节，官网给的视图授权语句里V后边是没有下划线_的执行报错，需要手动修改一下，以下为修改过的语句</span><br><span class="line">GRANT CONNECT, CREATE SESSION TO zabbix_mon;</span><br><span class="line">GRANT SELECT ON DBA_TABLESPACE_USAGE_METRICS TO zabbix_mon;</span><br><span class="line">GRANT SELECT ON DBA_TABLESPACES TO zabbix_mon;</span><br><span class="line">GRANT SELECT ON DBA_USERS TO zabbix_mon;</span><br><span class="line">GRANT SELECT ON SYS.DBA_DATA_FILES TO zabbix_mon;</span><br><span class="line">GRANT SELECT ON V_$ACTIVE_SESSION_HISTORY TO zabbix_mon;</span><br><span class="line">GRANT SELECT ON V_$ARCHIVE_DEST TO zabbix_mon;</span><br><span class="line">GRANT SELECT ON V_$ASM_DISKGROUP TO zabbix_mon;</span><br><span class="line">GRANT SELECT ON V_$DATABASE TO zabbix_mon;</span><br><span class="line">GRANT SELECT ON V_$DATAFILE TO zabbix_mon;</span><br><span class="line">GRANT SELECT ON V_$INSTANCE TO zabbix_mon;</span><br><span class="line">GRANT SELECT ON V_$LOG TO zabbix_mon;</span><br><span class="line">GRANT SELECT ON V_$OSSTAT TO zabbix_mon;</span><br><span class="line">GRANT SELECT ON V_$PGASTAT TO zabbix_mon;</span><br><span class="line">GRANT SELECT ON V_$PROCESS TO zabbix_mon;</span><br><span class="line">GRANT SELECT ON V_$RECOVERY_FILE_DEST TO zabbix_mon;</span><br><span class="line">GRANT SELECT ON V_$RESTORE_POINT TO zabbix_mon;</span><br><span class="line">GRANT SELECT ON V_$SESSION TO zabbix_mon;</span><br><span class="line">GRANT SELECT ON V_$SGASTAT TO zabbix_mon;</span><br><span class="line">GRANT SELECT ON V_$SYSMETRIC TO zabbix_mon;</span><br><span class="line">GRANT SELECT ON V_$SYSTEM_PARAMETER TO zabbix_mon;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="2-3-查看监听状态"><a href="#2-3-查看监听状态" class="headerlink" title="2.3 查看监听状态"></a>2.3 查看监听状态</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[oracle@db132 ~]$ lsnrctl status</span><br><span class="line"></span><br><span class="line">LSNRCTL for Linux: Version 19.0.0.0.0 - Production on 16-NOV-2021 10:42:43</span><br><span class="line"></span><br><span class="line">Copyright (c) 1991, 2019, Oracle.  All rights reserved.</span><br><span class="line"></span><br><span class="line">Connecting to (DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=db132)(PORT=1521)))</span><br><span class="line"></span><br><span class="line">STATUS of the LISTENER</span><br><span class="line"></span><br><span class="line">Alias                     LISTENER</span><br><span class="line">Version                   TNSLSNR for Linux: Version 19.0.0.0.0 - Production</span><br><span class="line">Start Date                16-NOV-2021 09:34:04</span><br><span class="line">Uptime                    0 days 1 hr. 8 min. 40 sec</span><br><span class="line">Trace Level               off</span><br><span class="line">Security                  ON: Local OS Authentication</span><br><span class="line">SNMP                      OFF</span><br><span class="line">Listener Parameter File   /u01/app/oracle/product/19.3.0/db_1/network/admin/listener.ora</span><br><span class="line">Listener Log File         /u01/app/oracle/diag/tnslsnr/db132/listener/alert/log.xml</span><br><span class="line">Listening Endpoints Summary...</span><br><span class="line">  (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=db132)(PORT=1521)))</span><br><span class="line">  (DESCRIPTION=(ADDRESS=(PROTOCOL=ipc)(KEY=EXTPROC1521)))</span><br><span class="line">  (DESCRIPTION=(ADDRESS=(PROTOCOL=tcps)(HOST=db132)(PORT=5500))(Security=(my_wallet_directory=/u01/app/oracle/admin/orcl/xdb_wallet))(Presentation=HTTP)(Session=RAW))</span><br><span class="line">Services Summary...</span><br><span class="line">Service &quot;86b637b62fdf7a65e053f706e80a27ca&quot; has 1 instance(s).</span><br><span class="line">  Instance &quot;orcl&quot;, status READY, has 1 handler(s) for this service...</span><br><span class="line">Service &quot;d083de58225c7d4fe0530100007f0ce6&quot; has 1 instance(s).</span><br><span class="line">  Instance &quot;orcl&quot;, status READY, has 1 handler(s) for this service...</span><br><span class="line">Service &quot;orcl&quot; has 1 instance(s).</span><br><span class="line">  Instance &quot;orcl&quot;, status READY, has 1 handler(s) for this service...</span><br><span class="line">Service &quot;orclXDB&quot; has 1 instance(s).</span><br><span class="line">  Instance &quot;orcl&quot;, status READY, has 1 handler(s) for this service...</span><br><span class="line">Service &quot;orclpdb&quot; has 1 instance(s).</span><br><span class="line">  Instance &quot;orcl&quot;, status READY, has 1 handler(s) for this service...</span><br><span class="line">The command completed successfully</span><br></pre></td></tr></table></figure>

<h1 id="3-安装Oracle-Client"><a href="#3-安装Oracle-Client" class="headerlink" title="3. 安装Oracle Client"></a>3. 安装Oracle Client</h1><h2 id="3-1-下载Oracle-Client"><a href="#3-1-下载Oracle-Client" class="headerlink" title="3.1 下载Oracle Client"></a>3.1 下载Oracle Client</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wget https://download.oracle.com/otn_software/linux/instantclient/199000/oracle-instantclient19.9-basic-19.9.0.0.0-1.x86_64.rpm</span><br><span class="line">wget https://download.oracle.com/otn_software/linux/instantclient/199000/oracle-instantclient19.9-sqlplus-19.9.0.0.0-1.x86_64.rpm</span><br><span class="line">wget https://download.oracle.com/otn_software/linux/instantclient/199000/oracle-instantclient19.9-devel-19.9.0.0.0-1.x86_64.rpm</span><br><span class="line">wget https://download.oracle.com/otn_software/linux/instantclient/199000/oracle-instantclient19.9-odbc-19.9.0.0.0-1.x86_64.rpm</span><br></pre></td></tr></table></figure>

<h2 id="3-2-安装Oracle-Client"><a href="#3-2-安装Oracle-Client" class="headerlink" title="3.2 安装Oracle Client"></a>3.2 安装Oracle Client</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum -y install unixODBC unixODBC-devel</span><br><span class="line">yum localinstall oracle-instantclient19.9-*</span><br><span class="line"></span><br><span class="line">[root@db132 ~]# find / -name client64</span><br><span class="line">/usr/lib/oracle/19.9/client64</span><br><span class="line">/usr/share/oracle/19.9/client64</span><br><span class="line">/usr/include/oracle/19.9/client64</span><br></pre></td></tr></table></figure>

<h2 id="3-3-配置SqlPlus连接扩展"><a href="#3-3-配置SqlPlus连接扩展" class="headerlink" title="3.3 配置SqlPlus连接扩展"></a>3.3 配置SqlPlus连接扩展</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#使用root账号操作</span><br><span class="line"></span><br><span class="line">mkdir -p /usr/lib/oracle/19.9/client64/network/admin</span><br><span class="line">vim /usr/lib/oracle/19.9/client64/network/admin/tnsnames.ora</span><br><span class="line"></span><br><span class="line">#添加如下内容</span><br><span class="line">db132_oracle=</span><br><span class="line">   (DESCRIPTION =</span><br><span class="line">     (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.111.132)(PORT = 1521))</span><br><span class="line">     (CONNECT_DATA =</span><br><span class="line">        (SERVER = DEDICATED)</span><br><span class="line">        (SERVICE_NAME = ORCL)</span><br><span class="line">     )</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<h2 id="3-4-配置环境变量"><a href="#3-4-配置环境变量" class="headerlink" title="3.4 配置环境变量"></a>3.4 配置环境变量</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#添加以下内容到/etc/profile文件末尾</span><br><span class="line">vim /etc/profile</span><br><span class="line">export ORACLE_HOME=/usr/lib/oracle/19.9/client64</span><br><span class="line">export LD_LIBRARY_PATH=$ORACLE_HOME/lib:/usr/lib64:$LD_LIBRARY_PATH</span><br><span class="line">export TNS_ADMIN=$ORACLE_HOME/network/admin</span><br><span class="line">export PATH=$PATH:$ORACLE_HOME/bin:$HOME/binsource </span><br></pre></td></tr></table></figure>

<h2 id="3-5-配置lib库软连接"><a href="#3-5-配置lib库软连接" class="headerlink" title="3.5 配置lib库软连接"></a>3.5 配置lib库软连接</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">chmod +x /usr/lib/oracle/19.9/client64/lib/libsqora.so.19.1</span><br><span class="line">cd /usr/lib64/</span><br><span class="line">ln -s libodbcinst.so.2.0.0  libodbcinst.so.1	</span><br></pre></td></tr></table></figure>

<h2 id="3-6-添加Oracle驱动"><a href="#3-6-添加Oracle驱动" class="headerlink" title="3.6 添加Oracle驱动"></a>3.6 添加Oracle驱动</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/odbcinst.ini</span><br><span class="line"># 添加以下内容到文件末尾</span><br><span class="line">[oracle]</span><br><span class="line">Description     = Oracle ODBC driver for Oracle 19c</span><br><span class="line">Driver          = /usr/lib/oracle/19.9/client64/lib/libsqora.so.19.1</span><br></pre></td></tr></table></figure>

<h2 id="3-7-添加odbc连接"><a href="#3-7-添加odbc连接" class="headerlink" title="3.7 添加odbc连接"></a>3.7 添加odbc连接</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/odbc.ini</span><br><span class="line"># 添加以下内容</span><br><span class="line">[db132]</span><br><span class="line">Driver = Oracle</span><br><span class="line">ServerName = 192.168.111.132:1521/ORCLPDB</span><br><span class="line">UserID = zabbix_mon</span><br><span class="line">Password = zabbix_mon</span><br></pre></td></tr></table></figure>

<h2 id="3-8-进行ISQL测试"><a href="#3-8-进行ISQL测试" class="headerlink" title="3.8 进行ISQL测试"></a>3.8 进行ISQL测试</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#验证是否配置成功</span><br><span class="line">sql -v db132  #名称为odbc.ini中定义的连接名称 </span><br><span class="line">sqlplus 用户名/密码@IP/oracle数据库服务名 #如sqlplus system/xxxx@IP:1521/cdb1</span><br></pre></td></tr></table></figure>

<p><img src="/images/2021/1116/01.png" alt="01"></p>
<h1 id="4-Zabbix-WEB操作"><a href="#4-Zabbix-WEB操作" class="headerlink" title="4. Zabbix WEB操作"></a>4. Zabbix WEB操作</h1><p><img src="/images/2021/1116/02.png" alt="01"></p>
<p><img src="/images/2021/1116/03.png" alt="01"></p>
<p><img src="/images/2021/1116/04.png" alt="01"><br>在最新数据里查看相关信息<br><img src="/images/2021/1116/05.png" alt="01"></p>
<p>参考链接：<a href="https://bbs.huaweicloud.com/blogs/249319">https://bbs.huaweicloud.com/blogs/249319</a></p>
]]></content>
      <categories>
        <category>监控</category>
      </categories>
      <tags>
        <tag>zabbix</tag>
        <tag>监控</tag>
      </tags>
  </entry>
  <entry>
    <title>二进制安装Mysql5.7.31</title>
    <url>/arlo/3449ffc7/</url>
    <content><![CDATA[<p><em>Mysql下载地址：<a href="https://downloads.mysql.com/archives/community/">https://downloads.mysql.com/archives/community/</a> ，我们今天安装的是5.7.31，Linux-Generic ，64-bit 版本。</em></p>
<h1 id="基础环境"><a href="#基础环境" class="headerlink" title="基础环境"></a>基础环境</h1><ul>
<li><p>关闭防火墙和selinux</p>
</li>
<li><p>安装基础依赖包</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum -y install make gcc-c++ cmake bison-devel ncurses-devel  readline-devel  libaio-devel perl libaio wget lrzsz vim libnuma* bzip2 xz</span><br></pre></td></tr></table></figure>

<ul>
<li>新建mysql用户</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">groupadd mysql </span><br><span class="line">useradd -r -g mysql -s /bin/false mysql</span><br></pre></td></tr></table></figure>

<ul>
<li>规划mysql数据目录</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir /opt/mysql</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h1 id="安装Mysql"><a href="#安装Mysql" class="headerlink" title="安装Mysql"></a>安装Mysql</h1><h2 id="下载Mysql"><a href="#下载Mysql" class="headerlink" title="下载Mysql"></a>下载Mysql</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wget https://cdn.mysql.com/archives/mysql-5.7/mysql-5.7.31-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line">tar xf mysql-5.7.31-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line">mv mysql-5.7.31-linux-glibc2.12-x86_64 /usr/local/mysql</span><br></pre></td></tr></table></figure>

<h2 id="初始化mysql"><a href="#初始化mysql" class="headerlink" title="初始化mysql"></a>初始化mysql</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cd /usr/local/mysql/bin/</span><br><span class="line">./mysqld --initialize --user=mysql --datadir=/opt/mysql</span><br><span class="line">2021-12-31T03:06:17.837238Z 0 [Warning] TIMESTAMP with implicit DEFAULT value is deprecated. Please use --explicit_defaults_for_timestamp server option (see documentation for more details).</span><br><span class="line">2021-12-31T03:06:17.837469Z 0 [ERROR] Can&#x27;t find error-message file &#x27;/usr/local/mysql/share/errmsg.sys&#x27;. Check error-message file location and &#x27;lc-messages-dir&#x27; configuration directive.</span><br><span class="line">2021-12-31T03:06:26.994083Z 0 [Warning] InnoDB: New log files created, LSN=45790</span><br><span class="line">2021-12-31T03:06:28.532406Z 0 [Warning] InnoDB: Creating foreign key constraint system tables.</span><br><span class="line">2021-12-31T03:06:28.745765Z 0 [Warning] No existing UUID has been found, so we assume that this is the first time that this server has been started. Generating a new UUID: a5d85ca0-69e6-11ec-8e9c-525400ef6113.</span><br><span class="line">2021-12-31T03:06:28.768840Z 0 [Warning] Gtid table is not ready to be used. Table &#x27;mysql.gtid_executed&#x27; cannot be opened.</span><br><span class="line">2021-12-31T03:06:29.738532Z 0 [Warning] CA certificate ca.pem is self signed.</span><br><span class="line">2021-12-31T03:06:29.867148Z 1 [Note] A temporary password is generated for root@localhost: rkYWw1.(vp_q  #注意这里是root密码</span><br></pre></td></tr></table></figure>

<h2 id="编辑Mysql配置文件-x2F-etc-x2F-my-cnf"><a href="#编辑Mysql配置文件-x2F-etc-x2F-my-cnf" class="headerlink" title="编辑Mysql配置文件&#x2F;etc&#x2F;my.cnf"></a>编辑Mysql配置文件&#x2F;etc&#x2F;my.cnf</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">datadir=/opt/mysql  #修改mysql数据目录</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line"></span><br><span class="line"># Disabling symbolic-links is recommended to prevent assorted security risks</span><br><span class="line"></span><br><span class="line">symbolic-links=0</span><br><span class="line"></span><br><span class="line"># Settings user and group are ignored when systemd is used.</span><br><span class="line"></span><br><span class="line"># If you need to run mysqld under a different user or group,</span><br><span class="line"></span><br><span class="line"># customize your systemd unit file for mariadb according to the</span><br><span class="line"></span><br><span class="line"># instructions in http://fedoraproject.org/wiki/Systemd</span><br><span class="line"></span><br><span class="line">max_connections=1000</span><br><span class="line">max_connect_errors=100</span><br><span class="line">character-set-server=utf8mb4</span><br><span class="line">default-storage-engine=INNODB</span><br><span class="line">tmp_table_size = 64M</span><br><span class="line">max_heap_table_size = 64M</span><br><span class="line">max_allowed_packet = 256M</span><br><span class="line">sql_mode=STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">default-character-set=utf8mb4</span><br><span class="line">auto-rehash</span><br><span class="line"></span><br><span class="line">[client]</span><br><span class="line">port=3306</span><br><span class="line">default-character-set=utf8mb4</span><br><span class="line"></span><br><span class="line">[mysqld_safe]</span><br><span class="line">log-error=/var/log/mysql/mysql.log  #修改日志路径</span><br><span class="line">pid-file=/var/run/mysql/mysql.pid   #修改pid路径</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"># include all files from the config directory</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line">!includedir /etc/my.cnf.d</span><br></pre></td></tr></table></figure>

<h2 id="新建Mysql所需目录"><a href="#新建Mysql所需目录" class="headerlink" title="新建Mysql所需目录"></a>新建Mysql所需目录</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 新建日志目录</span><br><span class="line">mkdir /var/log/mysql</span><br><span class="line">touch /var/log/mysql/mysql.log</span><br><span class="line">chown -R mysql.mysql /var/log/mysql/</span><br><span class="line">#新建sock目录</span><br><span class="line">mkdir /var/lib/mysql</span><br><span class="line">chmod 777 /var/lib/mysql/ </span><br><span class="line">ln -s /var/lib/mysql/mysql.sock /tmp/mysql.sock</span><br></pre></td></tr></table></figure>

<h2 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">echo &#x27;PATH=.:$PATH:/usr/local/mysql/bin&#x27; &gt;&gt; /etc/profile</span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>

<h1 id="配置Mysql启动文件"><a href="#配置Mysql启动文件" class="headerlink" title="配置Mysql启动文件"></a>配置Mysql启动文件</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cp /usr/local/mysql/support-files/mysql.server  /etc/init.d/mysqld</span><br><span class="line">修改/etc/init.d/mysqld 文件中数据目录</span><br><span class="line">datadir=/opt/mysql</span><br></pre></td></tr></table></figure>

<p><code>chkconfig --add mysqld</code> </p>
<p><code>chkconfig --list</code></p>
<p><code>systemctl start mysqld</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@mysqldb-144 mysql]# ss -tnl |grep 3306</span><br><span class="line">LISTEN     0      128       [::]:3306                  [::]:*     </span><br><span class="line"></span><br><span class="line">[root@mysqldb-144 mysql]# systemctl status mysqld</span><br><span class="line">● mysqld.service - LSB: start and stop MySQL</span><br><span class="line">   Loaded: loaded (/etc/rc.d/init.d/mysqld; bad; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Fri 2021-12-31 11:21:51 CST; 27min ago</span><br><span class="line">     Docs: man:systemd-sysv-generator(8)</span><br><span class="line">  Process: 8155 ExecStop=/etc/rc.d/init.d/mysqld stop (code=exited, status=0/SUCCESS)</span><br><span class="line">  Process: 8165 ExecStart=/etc/rc.d/init.d/mysqld start (code=exited, status=0/SUCCESS)</span><br><span class="line">   CGroup: /system.slice/mysqld.service</span><br><span class="line">           ├─8173 /bin/sh /usr/local/mysql/bin/mysqld_safe --datadir=/opt/mysql --pid-file=/opt/mysql/mysqldb-144.pid</span><br><span class="line">           └─8409 /usr/local/mysql/bin/mysqld --basedir=/usr/local/mysql --datadir=/opt/mysql --plugin-dir=/usr/local/mysql/lib/plug...</span><br><span class="line"></span><br><span class="line">Dec 31 11:21:50 mysqldb-144 systemd[1]: Starting LSB: start and stop MySQL...</span><br><span class="line">Dec 31 11:21:51 mysqldb-144 mysqld[8165]: Starting MySQL. SUCCESS!</span><br><span class="line">Dec 31 11:21:51 mysqldb-144 systemd[1]: Started LSB: start and stop MySQL.</span><br></pre></td></tr></table></figure>

<h1 id="修改密码"><a href="#修改密码" class="headerlink" title="修改密码"></a>修改密码</h1><h2 id="方法1"><a href="#方法1" class="headerlink" title="方法1"></a>方法1</h2><p>登录mysql，进行修改</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql&gt; alter user &#x27;root&#x27;@&#x27;localhost&#x27; identified by &#x27;passwd&#x27;;</span><br></pre></td></tr></table></figure>

<h2 id="方法2"><a href="#方法2" class="headerlink" title="方法2"></a>方法2</h2><p>使用mysqladmin工具修改</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysqladmin -u root -p password new_pass #newpass是要设置的新密码</span><br><span class="line">Enter password:    #这里是输入之前的密码（初始化生成的）</span><br></pre></td></tr></table></figure>

<h2 id="方法3"><a href="#方法3" class="headerlink" title="方法3"></a>方法3</h2><p>mysql8.0以上版本使用mysql_native_password进行密码验证</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql&gt; ALTER USER &#x27;root&#x27;@&#x27;localhost&#x27;IDENTIFIED WITH mysql_native_password BY &#x27;new_pass&#x27;;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>Mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>数据量统计</title>
    <url>/arlo/9d49b2c0/</url>
    <content><![CDATA[<p>为体现系统运营情况，了解数据库中数据增长量，公司需每月统计一次数据总量和数据增长量。以下是简单的语句记录</p>
<h1 id="Oracle数据量统计"><a href="#Oracle数据量统计" class="headerlink" title="Oracle数据量统计"></a>Oracle数据量统计</h1><h2 id="查看表空间及表空间大小"><a href="#查看表空间及表空间大小" class="headerlink" title="查看表空间及表空间大小"></a>查看表空间及表空间大小</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT TABLESPACE_NAME,SUM(BYTES) / 1024 / 1024 AS MB　FROM DBA_DATA_FILES GROUP BY TABLESPACE_NAME ORDER BY MB DESC;</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h2 id="查看表空间及对应的表空间文件"><a href="#查看表空间及对应的表空间文件" class="headerlink" title="查看表空间及对应的表空间文件"></a>查看表空间及对应的表空间文件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT TABLESPACE_NAME, FILE_NAME FROM DBA_DATA_FILES;</span><br></pre></td></tr></table></figure>

<h2 id="统计占用空间"><a href="#统计占用空间" class="headerlink" title="统计占用空间"></a>统计占用空间</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT SUM(BYTES) / 1024 / 1024 AS MB FROM DBA_SEGMENTS;</span><br></pre></td></tr></table></figure>

<h2 id="统计数据总行数"><a href="#统计数据总行数" class="headerlink" title="统计数据总行数"></a>统计数据总行数</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT SUM(SAMPLE_SIZE) FROM USER_TABLES;</span><br></pre></td></tr></table></figure>

<h1 id="SQL-Server-数据量统计"><a href="#SQL-Server-数据量统计" class="headerlink" title="SQL Server 数据量统计"></a>SQL Server 数据量统计</h1><h2 id="查询数据库所有表的数据的行数"><a href="#查询数据库所有表的数据的行数" class="headerlink" title="查询数据库所有表的数据的行数"></a>查询数据库所有表的数据的行数</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">--方法1：</span><br><span class="line">SELECT A.NAME, B.ROWS</span><br><span class="line">  FROM SYSOBJECTS AS A</span><br><span class="line"> INNER JOIN SYSINDEXES AS B</span><br><span class="line">    ON A.ID = B.ID</span><br><span class="line"> WHERE (A.TYPE = &#x27;u&#x27;)</span><br><span class="line">   AND (B.INDID IN (0, 1))</span><br><span class="line"> ORDER BY B.ROWS DESC</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--方法2：</span><br><span class="line">SELECT SCHEMA_NAME(T.SCHEMA_ID) AS [ SCHEMA ],</span><br><span class="line">       T.NAME AS TABLENAME,</span><br><span class="line">       I.ROWS AS [ ROWCOUNT ]</span><br><span class="line">  FROM SYS.TABLES AS T, SYSINDEXES AS I</span><br><span class="line"> WHERE T.OBJECT_ID = I.ID</span><br><span class="line">   AND I.INDID &lt;= 1</span><br><span class="line">--如果只看总量，使用以下语句</span><br><span class="line">SELECT SUM(ROWS)</span><br><span class="line">  FROM SYS.TABLES AS T, SYSINDEXES AS I</span><br><span class="line"> WHERE T.OBJECT_ID = I.ID</span><br><span class="line">   AND I.INDID &lt;= 1</span><br></pre></td></tr></table></figure>

<h2 id="统计数据库占用空间大小"><a href="#统计数据库占用空间大小" class="headerlink" title="统计数据库占用空间大小"></a>统计数据库占用空间大小</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">EXEC sp_spaceused</span><br></pre></td></tr></table></figure>

<h1 id="MySql-数据量统计"><a href="#MySql-数据量统计" class="headerlink" title="MySql 数据量统计"></a>MySql 数据量统计</h1><h2 id="简单快捷，直接查询数据库中所有行数"><a href="#简单快捷，直接查询数据库中所有行数" class="headerlink" title="简单快捷，直接查询数据库中所有行数"></a>简单快捷，直接查询数据库中所有行数</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select sum(table_rows) as &#x27;记录数&#x27; from information_schema.tables </span><br><span class="line">-- where table_schema = &#x27;esp&#x27;</span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<h2 id="查询所有数据库容量大小"><a href="#查询所有数据库容量大小" class="headerlink" title="查询所有数据库容量大小"></a>查询所有数据库容量大小</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select</span><br><span class="line">table_schema as &#x27;数据库&#x27;,</span><br><span class="line">sum(table_rows) as &#x27;记录数&#x27;,</span><br><span class="line">sum(truncate(data_length/1024/1024, 2)) as &#x27;数据容量(MB)&#x27;,</span><br><span class="line">sum(truncate(index_length/1024/1024, 2)) as &#x27;索引容量(MB)&#x27;</span><br><span class="line">from information_schema.tables</span><br><span class="line">-- where table_schema = &#x27;your_database_name&#x27;</span><br><span class="line">group by table_schema</span><br><span class="line">order by sum(data_length) desc, sum(index_length) desc;</span><br></pre></td></tr></table></figure>
<h1 id="查询所有数据库各表容量大小"><a href="#查询所有数据库各表容量大小" class="headerlink" title="查询所有数据库各表容量大小"></a>查询所有数据库各表容量大小</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select</span><br><span class="line">table_schema as &#x27;数据库&#x27;,</span><br><span class="line">table_name as &#x27;表名&#x27;,</span><br><span class="line">table_rows as &#x27;记录数&#x27;,</span><br><span class="line">truncate(data_length/1024/1024, 2) as &#x27;数据容量(MB)&#x27;,</span><br><span class="line">truncate(index_length/1024/1024, 2) as &#x27;索引容量(MB)&#x27;</span><br><span class="line">from information_schema.tables</span><br><span class="line">-- where table_schema = &#x27;your_database_name&#x27;</span><br><span class="line">where table_schema = &#x27;esp&#x27;</span><br><span class="line">order by table_schema asc, data_length desc, index_length desc;</span><br></pre></td></tr></table></figure>
<h1 id="查询单表每个索引大小"><a href="#查询单表每个索引大小" class="headerlink" title="查询单表每个索引大小"></a>查询单表每个索引大小</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select</span><br><span class="line">sum(stat_value) pages,</span><br><span class="line">table_name,</span><br><span class="line">index_name,</span><br><span class="line">concat(round(sum(stat_value)/1000000 * @@innodb_page_size, 2), &#x27;M&#x27;) size</span><br><span class="line">from mysql.innodb_index_stats</span><br><span class="line">where</span><br><span class="line">table_name = &#x27;user_info_index&#x27;</span><br><span class="line">and database_name = &#x27;db_my_test&#x27;</span><br><span class="line">and stat_description LIKE &#x27;Number of pages in the index&#x27;</span><br><span class="line">group by table_name, index_name;</span><br></pre></td></tr></table></figure>

<p><em>PS: 以上语句均来自网络，暂未找到可以直接统计一个月的数据增量，因每个月统计一次，可以使用本月的数据量减去上月统计的数据量来获取数据增量。</em></p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>Oracle</tag>
        <tag>数据库</tag>
        <tag>MSSQL</tag>
      </tags>
  </entry>
  <entry>
    <title>使用journalctl查看日志</title>
    <url>/arlo/b1bdc66a/</url>
    <content><![CDATA[<p>systemd-journald 是 systemd 自带的日志系统,是一个收集并存储各类日志数据的系统服务。 它创建并维护一个带有索引的、结构化的日志数据库， 并可以收集来自各种不同渠道的日志：</p>
<ol>
<li>通过 kmsg 收集内核日志</li>
<li>通过 libc 的 syslog(3) 接口收集系统日志</li>
<li>通过 本地日志接口 sd_journal_print(3) 收集结构化的系统日志</li>
<li>捕获服务单元的标准输出(STDOUT)与标准错误(STDERR)。 </li>
<li>通过内核审计子系统收集审计记录</li>
</ol>
<p>日志守护进程会以安全且不可伪造的方式自动收集每条日志的元数据。</p>
<span id="more"></span>

<h1 id="journalctl基本操作"><a href="#journalctl基本操作" class="headerlink" title="journalctl基本操作"></a>journalctl基本操作</h1><p>查看主机本次启动后的所有日志</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">journalctl</span><br></pre></td></tr></table></figure>

<p>只查看本机内核日志</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">journalctl -k</span><br></pre></td></tr></table></figure>

<p>查看本机启动日志</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">journalctl -b -0 #本次启动</span><br><span class="line">journalctl -b -1 #上一次启动</span><br></pre></td></tr></table></figure>

<p>查看最新指定行数（20行）日志</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">journalctl -n 20</span><br></pre></td></tr></table></figure>

<p>跟踪实时日志</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">journalctl -f</span><br></pre></td></tr></table></figure>

<p>指定日志倒序输出:最新的在上面，从新到旧</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">journalctl -r</span><br></pre></td></tr></table></figure>

<p>查看某个unit的日志(sshd.service)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">journalctl -u sshd.service</span><br><span class="line">journalctl -u nginx.service -u mysqld.service</span><br></pre></td></tr></table></figure>

<p>查看指定时间之后的日志</p>
<p>–since 指定开始时间</p>
<p>–until  指定结束时间</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">journalctl -u mysqld.service --since today</span><br><span class="line">journalctl -u sshd.service --since &quot;2021-09-30 09:00&quot; --until now</span><br><span class="line">journalctl -u sshd.service --since &quot;2021-09-30 09:00&quot; --until &quot;2021-09-30 10:00&quot;</span><br><span class="line"></span><br><span class="line">[root@s1 ~]# journalctl -u sshd.service --since &quot;2021-09-30 09:00&quot; --until &quot;2021-09-30 10:00&quot;</span><br><span class="line">-- Logs begin at Thu 2021-09-30 09:49:15 CST, end at Thu 2021-09-30 10:39:52 CST. --</span><br><span class="line">9月 30 09:49:35 s1.ths.com.cn systemd[1]: Starting OpenSSH server daemon...</span><br><span class="line">9月 30 09:49:36 s1.ths.com.cn sshd[1091]: Server listening on 0.0.0.0 port 22.</span><br><span class="line">9月 30 09:49:36 s1.ths.com.cn sshd[1091]: Server listening on :: port 22.</span><br><span class="line">9月 30 09:49:36 s1.ths.com.cn systemd[1]: Started OpenSSH server daemon.</span><br><span class="line">9月 30 09:49:41 s1.ths.com.cn sshd[1314]: Accepted password for root from 192.168.111.1 port 12424 ssh2</span><br><span class="line">9月 30 09:49:41 s1.ths.com.cn sshd[1314]: pam_unix(sshd:session): session opened for user root by (uid=0)</span><br></pre></td></tr></table></figure>

<p>查看指定级别的日志</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">说明：日志的八个级别:</span><br><span class="line"># 0: emerg</span><br><span class="line"># 1: alert</span><br><span class="line"># 2: crit</span><br><span class="line"># 3: err</span><br><span class="line"># 4: warning</span><br><span class="line"># 5: notice</span><br><span class="line"># 6: info</span><br><span class="line"># 7: debug</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@s1 ~]# journalctl -p err -k</span><br><span class="line">-- Logs begin at Thu 2021-09-30 09:49:15 CST, end at Thu 2021-09-30 10:39:07 CST. --</span><br><span class="line">9月 30 09:49:27 s1.ths.com.cn kernel: piix4_smbus 0000:00:07.3: SMBus Host Controller not enabled!</span><br></pre></td></tr></table></figure>

<p>查看指定用户id的日志（oracle用户UID&#x3D;600）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">journalctl _UID=600</span><br></pre></td></tr></table></figure>

<h1 id="日志清理"><a href="#日志清理" class="headerlink" title="日志清理"></a>日志清理</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 清理现有的日志文件</span><br><span class="line">rm -rf /var/log/journal/*</span><br><span class="line">#重启systemd-journald服务</span><br><span class="line">systemctl restart systemd-journald.service</span><br><span class="line">#显示日志占据的硬盘空间</span><br><span class="line">journalctl  --disk-usage</span><br><span class="line">#清理现有的日志到500M以下</span><br><span class="line">journalctl --vacuum-size=500M </span><br><span class="line">#清理现有的日志到12个月以下</span><br><span class="line">journalctl --vacuum-time=12month</span><br></pre></td></tr></table></figure>



<p>参考：<a href="https://www.cnblogs.com/architectforest/p/12665080.html">https://www.cnblogs.com/architectforest/p/12665080.html</a></p>
]]></content>
      <categories>
        <category>常识</category>
      </categories>
      <tags>
        <tag>日志</tag>
      </tags>
  </entry>
  <entry>
    <title>源码安装PostgreSQL数据库</title>
    <url>/arlo/65cdd712/</url>
    <content><![CDATA[<h1 id="安装PG数据库"><a href="#安装PG数据库" class="headerlink" title="安装PG数据库"></a>安装PG数据库</h1><h2 id="配置基础环境"><a href="#配置基础环境" class="headerlink" title="配置基础环境"></a>配置基础环境</h2><h3 id="安装依赖包"><a href="#安装依赖包" class="headerlink" title="安装依赖包"></a>安装依赖包</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum install -y bison flex readline readline-devel  zlib-devel gcc gcc-c++ make wget</span><br></pre></td></tr></table></figure>
<h3 id="新建postgres用户，并设置密码"><a href="#新建postgres用户，并设置密码" class="headerlink" title="新建postgres用户，并设置密码"></a>新建postgres用户，并设置密码</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">useradd postgres</span><br><span class="line">passwd postgres</span><br></pre></td></tr></table></figure>
<h3 id="新建目录"><a href="#新建目录" class="headerlink" title="新建目录"></a>新建目录</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir -p /usr/local/pg12</span><br><span class="line">mkdir -p /pgdata/12/data</span><br><span class="line">chown -R postgres. /pgdata</span><br><span class="line">chown -R postgres. /usr/local/pg12/</span><br><span class="line">chmod 700 /pgdata/12/data/ -R</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<h3 id="修改系统参数"><a href="#修改系统参数" class="headerlink" title="修改系统参数"></a>修改系统参数</h3><p><code>vim  /etc/sysctl.conf</code> </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kernel.shmmax = 68719476736</span><br><span class="line">kernel.shmall = 4294967296</span><br><span class="line">kernel.shmmni = 4096</span><br><span class="line">kernel.sem = 50100 64128000 50100 1280</span><br><span class="line">fs.file-max = 7672460</span><br><span class="line">net.ipv4.ip_local_port_range = 9000 65000</span><br><span class="line">net.core.rmem_default = 1048576</span><br><span class="line">net.core.rmem_max = 4194304</span><br><span class="line">net.core.wmem_default = 262144</span><br><span class="line">net.core.wmem_max = 1048576</span><br></pre></td></tr></table></figure>

<p><code>vim /etc/security/limits.conf</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">* soft   nofile    131072</span><br><span class="line">* hard   nofile    131072</span><br><span class="line">* soft   nproc    131072</span><br><span class="line">* hard   nproc    131072</span><br><span class="line">* soft   core    unlimited</span><br><span class="line">* hard   core    unlimited</span><br><span class="line">* hard   memlock    50000000</span><br><span class="line">* soft   memlock    50000000</span><br></pre></td></tr></table></figure>

<p><code>sysctl -p</code></p>
<h2 id="安装PG数据库-1"><a href="#安装PG数据库-1" class="headerlink" title="安装PG数据库"></a>安装PG数据库</h2><h3 id="下载源码包，编译安装数据库"><a href="#下载源码包，编译安装数据库" class="headerlink" title="下载源码包，编译安装数据库"></a>下载源码包，编译安装数据库</h3><p><code>wget https://ftp.postgresql.org/pub/source/v12.6/postgresql-12.6.tar.gz</code></p>
<p><code>tar xf postgresql-12.6.tar.gz</code><br><code>cd /usr/local/src/postgresql-12.6</code><br><code>./configure --prefix=/usr/local/pg12/</code><br><code>gmake world</code><br><code>gmake install -world</code></p>
<h3 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h3><p>切换到postgres用户</p>
<p><code>su - postgres</code><br><code>vim ~/.bash_profile</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">export PGDATA=/pgdata/12/data</span><br><span class="line">export LANG=en_US.utf8</span><br><span class="line">export PGHOME=/usr/local/pg12</span><br><span class="line">LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib:$LD_LIBRARY_PATH</span><br><span class="line">export DATE=`date +&quot;%Y%m%d%H%M&quot;`</span><br><span class="line">export MANPATH=$PGHOME/share/man:$MANPATH</span><br><span class="line">export PGUSER=postgres</span><br><span class="line">export PATH=$PGHOME/bin:$PATH:.</span><br></pre></td></tr></table></figure>

<p>使配置的环境变量生效</p>
<p><code>source ~/.bash_profile</code></p>
<h2 id="初始化数据库"><a href="#初始化数据库" class="headerlink" title="初始化数据库"></a>初始化数据库</h2><h3 id="简易初始化"><a href="#简易初始化" class="headerlink" title="简易初始化"></a>简易初始化</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">initdb -D /pgdata/12/data/ -W</span><br></pre></td></tr></table></figure>

<h3 id="建议生产环境初始化命令"><a href="#建议生产环境初始化命令" class="headerlink" title="建议生产环境初始化命令"></a>建议生产环境初始化命令</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">initdb -A md5 -D $PGDATA -E utf8 --locale=C -W</span><br></pre></td></tr></table></figure>

<p><img src="/images/2021/1022/01.png" alt="01"></p>
<h2 id="启动、关闭"><a href="#启动、关闭" class="headerlink" title="启动、关闭"></a>启动、关闭</h2><h3 id="手动方式"><a href="#手动方式" class="headerlink" title="手动方式"></a>手动方式</h3><p>启动：<code>pg_ctl start</code><br>重启：<code>pg_ctl restart  -mf</code><br>关闭：<code>pg_ctl stop -mf</code>  </p>
<p>查询数据库版本，检验环境变量是否正确</p>
<p><code>psql --version</code></p>
<h3 id="脚本方式"><a href="#脚本方式" class="headerlink" title="脚本方式"></a>脚本方式</h3><p><code>/usr/local/src/postgresql-12.6/contrib/start-scripts/linux</code></p>
<h1 id="登录连接数据库"><a href="#登录连接数据库" class="headerlink" title="登录连接数据库"></a>登录连接数据库</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ psql --help</span><br><span class="line"></span><br><span class="line">-d  数据库</span><br><span class="line">-h  主机名/ip地址</span><br><span class="line">-p  端口号</span><br><span class="line">-U  用户</span><br><span class="line">-W  密码</span><br></pre></td></tr></table></figure>

<h2 id="连接命令"><a href="#连接命令" class="headerlink" title="连接命令"></a>连接命令</h2><p><code>psql -d postgres -h 192.168.111.128  -p 5432 -U postgres</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">新装的pg数据库，默认只允许使用本地socket方式登录，不允许远程登录</span><br><span class="line">psql: error: could not connect to server: Connection refused</span><br><span class="line">	Is the server running on host &quot;192.168.111.128&quot; and accepting</span><br><span class="line">	TCP/IP connections on port 5432?</span><br></pre></td></tr></table></figure>

<h2 id="修改配置文件，实现远程登录"><a href="#修改配置文件，实现远程登录" class="headerlink" title="修改配置文件，实现远程登录"></a>修改配置文件，实现远程登录</h2><p><code>vim $PGDATA/pg_hba.conf</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># IPv4 local connections:</span><br><span class="line">host    all             all             192.168.111.0/24        md5</span><br></pre></td></tr></table></figure>

<p><code>vim $PGDATA/postgresql.conf</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#listen_addresses = &#x27;localhost&#x27;         # what IP address(es) to listen on;</span><br><span class="line">listen_addresses = &#x27;*&#x27; </span><br></pre></td></tr></table></figure>

<p><img src="/images/2021/1022/02.png" alt="01"></p>
<h1 id="用户管理"><a href="#用户管理" class="headerlink" title="用户管理"></a>用户管理</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">--获取帮助</span><br><span class="line">postgres=# \help create user</span><br><span class="line">Command:     CREATE USER</span><br><span class="line">Description: define a new database role</span><br><span class="line">Syntax:</span><br><span class="line">CREATE USER name [ [ WITH ] option [ ... ] ]</span><br><span class="line"></span><br><span class="line">where option can be:</span><br><span class="line"></span><br><span class="line">      SUPERUSER | NOSUPERUSER</span><br><span class="line">    | CREATEDB | NOCREATEDB</span><br><span class="line">    | CREATEROLE | NOCREATEROLE</span><br><span class="line">    | INHERIT | NOINHERIT</span><br><span class="line">    | LOGIN | NOLOGIN</span><br><span class="line">    | REPLICATION | NOREPLICATION</span><br><span class="line">    | BYPASSRLS | NOBYPASSRLS</span><br><span class="line">    | CONNECTION LIMIT connlimit</span><br><span class="line">    | [ ENCRYPTED ] PASSWORD &#x27;password&#x27; | PASSWORD NULL</span><br><span class="line">    | VALID UNTIL &#x27;timestamp&#x27;</span><br><span class="line">    | IN ROLE role_name [, ...]</span><br><span class="line">    | IN GROUP role_name [, ...]</span><br><span class="line">    | ROLE role_name [, ...]</span><br><span class="line">    | ADMIN role_name [, ...]</span><br><span class="line">    | USER role_name [, ...]</span><br><span class="line">    | SYSID uid</span><br><span class="line"></span><br><span class="line">URL: https://www.postgresql.org/docs/12/sql-createuser.html</span><br><span class="line"></span><br><span class="line">postgres=# create user user1 with PASSWORD &#x27;1&#x27;; --有login权限</span><br><span class="line">CREATE ROLE</span><br><span class="line">postgres=# create role user2 with PASSWORD &#x27;1&#x27;; --无login权限</span><br><span class="line">CREATE ROLE</span><br><span class="line">--查看用户信息</span><br><span class="line">postgres=# \du</span><br><span class="line">                                   List of roles</span><br><span class="line"> Role name |                         Attributes                         | Member of </span><br><span class="line">-----------+------------------------------------------------------------+-----------</span><br><span class="line"> postgres  | Superuser, Create role, Create DB, Replication, Bypass RLS | &#123;&#125;</span><br><span class="line"> user1     |                                                            | &#123;&#125;</span><br><span class="line"> user2     | Cannot login                                               | &#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--创建一个超级用户user1</span><br><span class="line">postgres=# create user user1 with SUPERUSER PASSWORD &#x27;111111&#x27;;</span><br><span class="line">CREATE ROLE</span><br><span class="line">--创建一个用户user2，允许登录，设置过期时间</span><br><span class="line">postgres=# create user user2 with LOGIN PASSWORD &#x27;user#123&#x27; VALID UNTIL &#x27;2022-09-30&#x27;;</span><br><span class="line">CREATE ROLE</span><br><span class="line">--删除用户</span><br><span class="line">postgres=# drop user user1;</span><br><span class="line">DROP ROLE</span><br><span class="line">--修改用户密码</span><br><span class="line">postgres=# alter user user2 with password &#x27;1&#x27;;</span><br><span class="line">ALTER ROLE</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="权限管理"><a href="#权限管理" class="headerlink" title="权限管理"></a>权限管理</h1><h2 id="权限级别"><a href="#权限级别" class="headerlink" title="权限级别"></a>权限级别</h2><ul>
<li>cluster权限：实例权限通过pg_hba.conf配置。</li>
<li>database权限: 数据库权限通过grant和revoke操作schema配置。</li>
<li>TBS权限：表空间权限通过grant和revoke操作表、物化视图、索引、临时表配置。</li>
<li>schema权限：模式权限通过grant和revoke操作模式下的对象配置。</li>
<li>object权限：对象权限通过grant和revoke配置</li>
</ul>
<h2 id="权限的定义"><a href="#权限的定义" class="headerlink" title="权限的定义"></a>权限的定义</h2><ul>
<li>database权限设置</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GRANT create ON DATABASE db1 to user1;</span><br></pre></td></tr></table></figure>

<ul>
<li>schema权限配置</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ALTER SCHEMA abc OWNER to user1;</span><br><span class="line">GRANT select,insert,update,delete ON ALL TABLES IN SCHEMA abc to user1;</span><br></pre></td></tr></table></figure>

<ul>
<li>object权限设置</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GRANT select,insert,update,delete ON abc.tb1 TO USER1;</span><br></pre></td></tr></table></figure>

<p>案例：创建一个业务用户</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">postgres=# create database db1;</span><br><span class="line">CREATE DATABASE</span><br><span class="line">postgres=# \c db1;</span><br><span class="line">You are now connected to database &quot;db1&quot; as user &quot;postgres&quot;.</span><br><span class="line">db1=# create schema abc;</span><br><span class="line">CREATE SCHEMA</span><br><span class="line">db1=# create user u1 with login password &#x27;111&#x27;;</span><br><span class="line">CREATE ROLE</span><br><span class="line">db1=# alter schema abc owner to u1;</span><br><span class="line">ALTER SCHEMA</span><br><span class="line">db1=# GRANT select,insert,delete,update ON ALL TABLES IN SCHEMA abc to u1;</span><br><span class="line">GRANT</span><br><span class="line"></span><br><span class="line"># 设置一个用户A可以使用用户B的数据</span><br><span class="line">GRANT USAGE ON SCHEMA USERB to USERA;</span><br><span class="line"></span><br><span class="line">#切换schema</span><br><span class="line">set search_path to [new_schema]  </span><br></pre></td></tr></table></figure>

<p>文档根据视频整理：<a href="https://www.bilibili.com/video/BV1WQ4y1f76h">https://www.bilibili.com/video/BV1WQ4y1f76h</a></p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>postgresql</tag>
      </tags>
  </entry>
  <entry>
    <title>记录一次意外断电导致的Oracle数据库故障</title>
    <url>/arlo/c158283/</url>
    <content><![CDATA[<h1 id="故障背景"><a href="#故障背景" class="headerlink" title="故障背景"></a>故障背景</h1><p>年前机房供电系统故障，意外断电导致数据库服务器连不上，由于不是核心业务数据库（两个礼拜连不上也没人找我）；上班后就慢慢折腾。接上机ipmi，接显示器看了下，服务器硬件正常，系统卡在了经典的Ctrl+D的启动界面，于是我们就从这里开始填坑……</p>
<span id="more"></span>

<h1 id="修复xfs文件系统"><a href="#修复xfs文件系统" class="headerlink" title="修复xfs文件系统"></a>修复xfs文件系统</h1><p>当时没截图，大概长这个样子</p>
<p><img src="/images/2021/0224/01.png" alt="01"></p>
<p>输入root密码进入系统后，查看了&#x2F;etc&#x2F;fstab</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@xbqy-02 ~]# cat /etc/fstab </span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># /etc/fstab</span><br><span class="line"># Created by anaconda on Mon Aug  5 20:47:30 2019</span><br><span class="line">#</span><br><span class="line"># Accessible filesystems, by reference, are maintained under &#x27;/dev/disk&#x27;</span><br><span class="line"># See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info</span><br><span class="line">#</span><br><span class="line">/dev/mapper/centos-root /                       xfs     defaults        0 0</span><br><span class="line">UUID=c79e1466-7fc4-4434-863f-d1f6b1c2f3e1 /boot                   xfs     defaults        0 0</span><br><span class="line">/dev/mapper/centos-swap swap                    swap    defaults        0 0</span><br><span class="line">UUID=1ce3f41e-cd87-4e86-b069-fd1bb6d744d5 /data xfs     defaults        0 0</span><br></pre></td></tr></table></figure>

<p>使用df -h看到&#x2F;data目录没有被挂载，由于&#x2F;data 是挂载了另外一个raid组（sdb），使用fdisk -l命令查看，看不到sdb，由此判定应该是xfs文件系统损坏导致的。</p>
<p>使用<code>xfs_repair /dev/sdb1</code> 修复报错，于是大胆的使用了 <code>xfs_repair -L /dev/sdb1</code> 修复了文件系统，可以正常进入系统。（这里不重要，简单提一下就好）</p>
<h1 id="多看日志"><a href="#多看日志" class="headerlink" title="多看日志"></a>多看日志</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SYS@orcl&gt; select value from v$diag_info where name =&#x27;Diag Trace&#x27;;</span><br><span class="line"></span><br><span class="line">VALUE</span><br><span class="line">------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">/u01/app/oracle/diag/rdbms/orcl/orcl/trace</span><br></pre></td></tr></table></figure>

<p>默认orcl实例的日志文件为：<code>/u01/app/oracle/diag/rdbms/orcl/orcl/trace/alert_orcl.log</code></p>
<h1 id="处理ORA-01110故障"><a href="#处理ORA-01110故障" class="headerlink" title="处理ORA-01110故障"></a>处理ORA-01110故障</h1><p>修改好xfs文件系统后，启动oracle，报错如下</p>
<p><img src="/images/2021/0224/02.jpg" alt="01"></p>
<p>由此可见，是启动控制文件control01.ctl和control02.ctl记录的版本号不一致造成的,control01.ctl的记录更新，所有我决定备份02后，复制一份01位02，操作如下。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cd /u01/app/oracle/fast_recovery_area/orcl</span><br><span class="line">mv control02.ctl control02.ctl.bak</span><br><span class="line">cp /u01/app/oracle/oradata/orcl/control01.ctl /u01/app/oracle/fast_recovery_area/orcl/control02.ctl</span><br></pre></td></tr></table></figure>

<p>再次启动，出现如下错误，如图所示，可以启动的mount阶段，数据库无法open。</p>
<p><img src="/images/2021/0224/03.jpg" alt="01"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SYS@orcl&gt; alter database open;</span><br><span class="line">alter database open</span><br><span class="line">*</span><br><span class="line">ERROR at line 1:</span><br><span class="line">ORA-01589: must use RESETLOGS or NORESETLOGS option for database open</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SYS@orcl&gt; alter database open resetlogs;</span><br><span class="line">alter database open resetlogs</span><br><span class="line">*</span><br><span class="line">ERROR at line 1:</span><br><span class="line">ORA-01194: file 1 needs more recovery to be consistent</span><br><span class="line">ORA-01110: data file 1: &#x27;/u01/app/oracle/oradata/orcl/system01.dbf&#x27;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SYS@orcl&gt; select v1.group#, member, sequence#, first_change# from v$log v1, v$logfile v2 where v1.group# = v2.group#;</span><br><span class="line"></span><br><span class="line">    GROUP#</span><br><span class="line">----------</span><br><span class="line">MEMBER</span><br><span class="line">------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> SEQUENCE# FIRST_CHANGE#</span><br><span class="line">---------- -------------</span><br><span class="line">	 1</span><br><span class="line">/u01/app/oracle/oradata/orcl/redo01.log</span><br><span class="line">    769420     395590662</span><br><span class="line"></span><br><span class="line">	 3</span><br><span class="line">/u01/app/oracle/oradata/orcl/redo03.log</span><br><span class="line">    769419     395590635</span><br><span class="line"></span><br><span class="line">	 2</span><br><span class="line">/u01/app/oracle/oradata/orcl/redo02.log</span><br><span class="line">    769421     395590691</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SYS@orcl&gt; recover database using backup controlfile until cancel;</span><br><span class="line">ORA-00279: change 395590635 generated at 02/06/2021 16:09:01 needed for thread 1</span><br><span class="line">ORA-00289: suggestion : /u01/app/oracle/oradata/orcl/archivelog/arch_5c1051e2_1_1016792676_769419.log</span><br><span class="line">ORA-00280: change 395590635 for thread 1 is in sequence #769419</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Specify log: &#123;&lt;RET&gt;=suggested | filename | AUTO | CANCEL&#125;</span><br><span class="line">CANCEL</span><br></pre></td></tr></table></figure>

<p>可以看到#769419对应的redo文件是redo03.log</p>
<p>我们尝试恢复一下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SYS@orcl&gt; recover database using backup controlfile until cancel;</span><br><span class="line">ORA-00279: change 395590635 generated at 02/06/2021 16:09:01 needed for thread 1</span><br><span class="line">ORA-00289: suggestion : /u01/app/oracle/oradata/orcl/archivelog/arch_5c1051e2_1_1016792676_769419.log</span><br><span class="line">ORA-00280: change 395590635 for thread 1 is in sequence #769419</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Specify log: &#123;&lt;RET&gt;=suggested | filename | AUTO | CANCEL&#125;</span><br><span class="line">/u01/app/oracle/oradata/orcl/redo03.log</span><br><span class="line">ORA-00279: change 395590635 generated at 02/06/2021 16:09:01 needed for thread 1</span><br><span class="line">ORA-00289: suggestion : /u01/app/oracle/oradata/orcl/archivelog/arch_5c1051e2_1_1016792676_769419.log</span><br><span class="line">ORA-00280: change 395590635 for thread 1 is in sequence #769419</span><br><span class="line">ORA-00278: log file &#x27;/u01/app/oracle/oradata/orcl/redo03.log&#x27; no longer needed for this recovery</span><br></pre></td></tr></table></figure>

<p>尝试后，这种方法无法完成恢复。</p>
<p>我们尝试创建一个pfile文件，先把库拉起来，然后手动切换redo日志</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SYS@orcl&gt; create pfile from spfile;</span><br><span class="line"></span><br><span class="line">File created.</span><br><span class="line"></span><br><span class="line">SYS@orcl&gt; shutdown immediate;</span><br><span class="line">ORA-01109: database not open</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Database dismounted.</span><br><span class="line">ORACLE instance shut down.</span><br></pre></td></tr></table></figure>

<p>编辑pfile文件，添加下边两个隐含参数</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#修改隐含参数</span><br><span class="line"></span><br><span class="line">*._allow_resetlogs_corruption=true</span><br><span class="line">*._allow_error_simulation=true</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SYS@orcl&gt; startup pfile=&#x27;/u01/app/oracle/product/11.2.0/db_1/dbs/initorcl.ora&#x27; mount;</span><br><span class="line">ORACLE instance started.</span><br><span class="line"></span><br><span class="line">Total System Global Area 5.0107E+10 bytes</span><br><span class="line">Fixed Size		    2264856 bytes</span><br><span class="line">Variable Size		 3.2212E+10 bytes</span><br><span class="line">Database Buffers	 1.7851E+10 bytes</span><br><span class="line">Redo Buffers		   41463808 bytes</span><br><span class="line">Database mounted.</span><br><span class="line">SYS@orcl&gt; select * from v$log;</span><br><span class="line">SYS@orcl&gt; select * from v$log;</span><br><span class="line"></span><br><span class="line">    GROUP#    THREAD#  SEQUENCE#      BYTES  BLOCKSIZE	  MEMBERS ARC STATUS	       FIRST_CHANGE# FIRST_TIME</span><br><span class="line">---------- ---------- ---------- ---------- ---------- ---------- --- ---------------- ------------- ------------</span><br><span class="line">NEXT_CHANGE# NEXT_TIME</span><br><span class="line">------------ ------------</span><br><span class="line">	 1	    1	  769420   52428800	   512		1 YES ACTIVE		   395590662 06-FEB-21</span><br><span class="line">   395590691 06-FEB-21</span><br><span class="line"></span><br><span class="line">	 3	    1	  769419   52428800	   512		1 YES ACTIVE		   395590635 06-FEB-21</span><br><span class="line">   395590662 06-FEB-21</span><br><span class="line"></span><br><span class="line">	 2	    1	  769421   52428800	   512		1 NO  CURRENT		   395590691 06-FEB-21</span><br><span class="line">  2.8147E+14</span><br><span class="line">  </span><br><span class="line">SYS@orcl&gt; alter system switch logfile;</span><br><span class="line"></span><br><span class="line">System altered.</span><br></pre></td></tr></table></figure>

<h1 id="处理ORA-01012故障"><a href="#处理ORA-01012故障" class="headerlink" title="处理ORA-01012故障"></a>处理ORA-01012故障</h1><p>数据库启动正常后，过了一会儿发现自己又停掉了</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SYS@orcl&gt; select status from v$instance;</span><br><span class="line">select status from v$instance</span><br><span class="line">*</span><br><span class="line">ERROR at line 1:</span><br><span class="line">ORA-01012: not logged on</span><br><span class="line">Process ID: 0</span><br><span class="line">Session ID: 0 Serial number: 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SYS@orcl&gt; conn / as sysdba</span><br><span class="line">Connected to an idle instance.</span><br></pre></td></tr></table></figure>

<p>停掉监听</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">lsnrctl stop</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ps -ef|grep ora_dbw0_$Oracle_SID</span><br><span class="line"></span><br><span class="line">kill -9 pid ；</span><br><span class="line"></span><br><span class="line">SYS@orcl&gt;  startup </span><br></pre></td></tr></table></figure>



<p>ps：至此，本地oracle数据库故障算是基本处理结束了，本文只是记录了这一过程，很多操作都是网上找的，不是很清楚原理，写的也不是很清楚，勿喷。</p>
]]></content>
      <categories>
        <category>Troubleshooting</category>
      </categories>
      <tags>
        <tag>Oracle</tag>
      </tags>
  </entry>
  <entry>
    <title>Centos 7.x离线安装ClamAV</title>
    <url>/arlo/99a35a98/</url>
    <content><![CDATA[<p>项目上有等保需要，又没有预算，查了一圈，linux下的免费杀毒软件大概有ClamAV、Chkrootkit、Comodo、Sophos、Rootkit Hunter、F-PROT。其中以ClamAV（<a href="https://www.clamav.net/%EF%BC%89">https://www.clamav.net/）</a> 名气最大，使用最广泛，在服务上进行离线安装该软件试试。</p>
<h1 id="安装ClamAV"><a href="#安装ClamAV" class="headerlink" title="安装ClamAV"></a>安装ClamAV</h1><p>下载对应的rpm安装包，上传到服务器&#x2F;usr&#x2F;local&#x2F;src目录下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">https://www.clamav.net/downloads/production/clamav-0.104.2.linux.x86_64.rpm</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<p>安装软件并修改配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cd /usr/local/src/</span><br><span class="line">#安装clamav</span><br><span class="line">rpm -ivh clamav-0.104.2.linux.x86_64.rpm</span><br><span class="line">cd /usr/local/etc/</span><br><span class="line">#复制配置文件</span><br><span class="line">cp clamd.conf.sample clamd.conf</span><br><span class="line">cp freshclam.conf.sample freshclam.conf</span><br><span class="line">#配置文件中需注释掉Example，其他的大多是一些路径相关的设置，我们使用默认的就好，不需要做过多的修改</span><br></pre></td></tr></table></figure>

<h1 id="下载病毒库"><a href="#下载病毒库" class="headerlink" title="下载病毒库"></a>下载病毒库</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">freshclam</span><br><span class="line">#由于未联网无法下载，但我们可以看到病毒库地址，找一台有网络机器下载后上传到/usr/local/share/clamav/目录即可</span><br><span class="line">http://database.clamav.net/main.cvd</span><br><span class="line">http://database.clamav.net/daily.cvd</span><br><span class="line">http://database.clamav.net/bytecode.cvd</span><br></pre></td></tr></table></figure>

<h1 id="使用ClamAV"><a href="#使用ClamAV" class="headerlink" title="使用ClamAV"></a>使用ClamAV</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">clamscan</span><br><span class="line">参数：</span><br><span class="line">-r 递归扫描子目录</span><br><span class="line">-i 只显示发现的病毒文件</span><br><span class="line">–no-summary 不显示统计信息</span><br><span class="line">--bell 发现病毒报警声提醒</span><br><span class="line">-h 显示帮助信息</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">--默认扫描当前目录下的文件，并显示扫描结果统计信息            </span><br><span class="line">/usr/local/bin/clamscan</span><br><span class="line"></span><br><span class="line">--扫描data目录下的所有目录和文件，并显示结果统计信息　                 </span><br><span class="line">/usr/local/bin/clamscan -r /data　 </span><br><span class="line"></span><br><span class="line">--扫描data目录下的所有目录和文件，只显示有问题的扫描结果            </span><br><span class="line">/usr/local/bin/clamscan -r --bell -i /data  </span><br><span class="line"></span><br><span class="line">--扫描data目录下的所有目录和文件，不显示统计信息  </span><br><span class="line">/usr/local/bin/clamscan --no-summary -ri /data </span><br><span class="line"></span><br><span class="line">--扫描/data，删除扫描过程中的发现的病毒文件</span><br><span class="line">/usr/local/bin/clamscan -r /data --remove </span><br><span class="line"></span><br><span class="line">--扫描/data并将发现的病毒文件移动至对应的路径下(/tmp/clamav_tmp)</span><br><span class="line">/usr/local/bin/clamscan -r /data --move /tmp/clamav_tmp</span><br><span class="line"></span><br><span class="line">--扫描显示发现的病毒文件，一般文件后面会显示FOUND</span><br><span class="line">/usr/local/bin/clamscan -r --infected -i </span><br></pre></td></tr></table></figure>

<h1 id="设置计划任务"><a href="#设置计划任务" class="headerlink" title="设置计划任务"></a>设置计划任务</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#每天凌晨2点更新病毒库（无网络可以忽略）</span><br><span class="line">0  2  * * *   /usr/local/clamav/bin/freshclam --quiet</span><br><span class="line">#每天凌晨2:30分执行扫描杀毒，将有问题程序移动到/tmp/clamav_tmp目录下 </span><br><span class="line">30 2  * * *   /usr/local/bin/clamscan  -r /  --remove -l /tmp/clamav_tmp</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>安全</category>
      </categories>
      <tags>
        <tag>安全</tag>
        <tag>杀毒</tag>
      </tags>
  </entry>
  <entry>
    <title>Ceph分布式存储系统搭建</title>
    <url>/arlo/a0556a43/</url>
    <content><![CDATA[<h1 id="Ceph介绍"><a href="#Ceph介绍" class="headerlink" title="Ceph介绍"></a>Ceph介绍</h1><h2 id="Ceph基础"><a href="#Ceph基础" class="headerlink" title="Ceph基础"></a>Ceph基础</h2><p>Ceph是一个可靠地、自动重均衡、自动恢复的分布式存储系统，根据场景划分可以将Ceph分为三大块，分别是对象存储（rgw）、块设备存储（ rbd）和文件系统服务（cephfs）。Ceph相比其它存储的优势点在于它不单单是存储，同时还充分利用了存储节点上的计算能力，在存储每一个数据时，都会通过计算得出该数据存储的位置，尽量将数据分布均衡，同时由于Ceph的良好设计，采用了CRUSH算法、HASH环等方法，使得它不存在传统的单点故障的问题，且随着规模的扩大性能并不会受到影响。</p>
<span id="more"></span>

<h2 id="Ceph核心组件"><a href="#Ceph核心组件" class="headerlink" title="Ceph核心组件"></a>Ceph核心组件</h2><p>Ceph的核心组件包括Ceph OSD、Ceph Monitor和Ceph MDS。</p>
<p><strong>Ceph OSD</strong>：OSD的英文全称是Object Storage Device，它的主要功能是存储数据、复制数据、平衡数据、恢复数据等，与其它OSD间进行心跳检查等，并将一些变化情况上报给Ceph Monitor。一般情况下一块硬盘对应一个OSD，由OSD来对硬盘存储进行管理，当然一个分区也可以成为一个OSD。</p>
<p>Ceph OSD的架构实现由物理磁盘驱动器、Linux文件系统和Ceph OSD服务组成，对于Ceph OSD Deamon而言，Linux文件系统显性的支持了其拓展性，一般Linux文件系统有好几种，比如有BTRFS、XFS、Ext4等，BTRFS虽然有很多优点特性，但现在还没达到生产环境所需的稳定性，一般比较推荐使用XFS。</p>
<p>伴随OSD的还有一个概念叫做Journal盘，一般写数据到Ceph集群时，都是先将数据写入到Journal盘中，然后每隔一段时间比如5秒再将Journal盘中的数据刷新到文件系统中。一般为了使读写时延更小，Journal盘都是采用SSD，一般分配10G以上，当然分配多点那是更好，Ceph中引入Journal盘的概念是因为Journal允许Ceph OSD功能很快做小的写操作；一个随机写入首先写入在上一个连续类型的journal，然后刷新到文件系统，这给了文件系统足够的时间来合并写入磁盘，一般情况下使用SSD作为OSD的journal可以有效缓冲突发负载。</p>
<p><strong>Ceph Monitor</strong>：由该英文名字我们可以知道它是一个监视器，负责监视Ceph集群，维护Ceph集群的健康状态，同时维护着Ceph集群中的各种Map图，比如OSD Map、Monitor Map、PG Map和CRUSH Map，这些Map统称为Cluster Map，Cluster Map是RADOS的关键数据结构，管理集群中的所有成员、关系、属性等信息以及数据的分发，比如当用户需要存储数据到Ceph集群时，OSD需要先通过Monitor获取最新的Map图，然后根据Map图和object id等计算出数据最终存储的位置。</p>
<p><strong>Ceph MDS</strong>：全称是Ceph MetaData Server，主要保存的文件系统服务的元数据，但对象存储和块存储设备是不需要使用该服务的。</p>
<p>查看各种Map的信息可以通过如下命令：ceph osd(mon、pg) dump</p>
<h1 id="规划"><a href="#规划" class="headerlink" title="规划"></a>规划</h1><table>
<thead>
<tr>
<th>主机名</th>
<th>IP地址</th>
<th>角色</th>
<th>配置</th>
</tr>
</thead>
<tbody><tr>
<td>ceph_node1</td>
<td>192.168.111.11&#x2F;24</td>
<td>控制节点、mon，mgr，osd</td>
<td>3块10GB硬盘</td>
</tr>
<tr>
<td>ceph_node2</td>
<td>192.168.111.12&#x2F;24</td>
<td>mon, mgr, osd</td>
<td>3块10GB硬盘</td>
</tr>
<tr>
<td>ceph_node3</td>
<td>192.168.111.13&#x2F;24</td>
<td>mon, mgr, osd</td>
<td>3块10GB硬盘</td>
</tr>
</tbody></table>
<h1 id="系统初始化"><a href="#系统初始化" class="headerlink" title="系统初始化"></a>系统初始化</h1><h2 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h2><p><code>systemctl stop firewalld &amp;&amp; systemctl disable firewalld</code></p>
<h2 id="关闭SELinux"><a href="#关闭SELinux" class="headerlink" title="关闭SELinux"></a>关闭SELinux</h2><p>在三台主机上分别执行以下命令，管理SELinux</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/&#x27; /etc/selinux/config</span><br><span class="line">grep SELINUX=disabled /etc/selinux/config</span><br><span class="line">setenforce 0</span><br><span class="line">getenforce </span><br></pre></td></tr></table></figure>

<h2 id="配置网络"><a href="#配置网络" class="headerlink" title="配置网络"></a>配置网络</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#ceph_node1 </span><br><span class="line">nmcli connection delete ens33</span><br><span class="line">nmcli connection add con-name ens33 ifname ens33 autoconnect yes type ethernet ip4 192.168.111.11/24 gw4 192.168.111.254 ipv4.dns 223.5.5.5</span><br><span class="line">nmcli conn up ens33</span><br><span class="line"></span><br><span class="line">#ceph_node2</span><br><span class="line">nmcli connection delete ens33</span><br><span class="line">nmcli connection add con-name ens33 ifname ens33 autoconnect yes type ethernet ip4 192.168.111.12/24 gw4 192.168.111.254 ipv4.dns 223.5.5.5</span><br><span class="line">nmcli conn up ens33</span><br><span class="line"></span><br><span class="line">#ceph_node3</span><br><span class="line">nmcli connection delete ens33</span><br><span class="line">nmcli connection add con-name ens33 ifname ens33 autoconnect yes type ethernet ip4 192.168.111.13/24 gw4 192.168.111.254 ipv4.dns 223.5.5.5</span><br><span class="line">nmcli conn up ens33</span><br></pre></td></tr></table></figure>

<h2 id="配置主机名"><a href="#配置主机名" class="headerlink" title="配置主机名"></a>配置主机名</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#ceph_node1 </span><br><span class="line">hostnamectl set-hostname ceph_node1</span><br><span class="line"></span><br><span class="line">#ceph_node2</span><br><span class="line">hostnamectl set-hostname ceph_node2</span><br><span class="line"></span><br><span class="line">#ceph_node3</span><br><span class="line">hostnamectl set-hostname ceph_node3</span><br></pre></td></tr></table></figure>

<h2 id="配置hosts"><a href="#配置hosts" class="headerlink" title="配置hosts"></a>配置hosts</h2><p>配置hosts，并复制到其他两台主机</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#ceph_node1</span><br><span class="line"></span><br><span class="line">vi /etc/hosts</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.111.11 ceph_node1</span><br><span class="line">192.168.111.12 ceph_node2</span><br><span class="line">192.168.111.13 ceph_node3</span><br></pre></td></tr></table></figure>

<p><code>scp /etc/hosts ceph_node2:/etc/</code></p>
<p><code>scp /etc/hosts ceph_node3:/etc/</code></p>
<h2 id="配置互信"><a href="#配置互信" class="headerlink" title="配置互信"></a>配置互信</h2><p>在ceph_node1上生成秘钥，不设置密码</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# ssh-keygen </span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/root/.ssh/id_rsa): </span><br><span class="line">Enter passphrase (empty for no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved in /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:pU9BBVdNpHdTAXToafsymcxRpbLdCTpX/ivZZ5U18lQ root@ceph_node1</span><br><span class="line">The key&#x27;s randomart image is:</span><br><span class="line">+---[RSA 2048]----+</span><br><span class="line">|          oo+++*=|</span><br><span class="line">|         . . ...E|</span><br><span class="line">|          o . oo=|</span><br><span class="line">|         o ..*.*+|</span><br><span class="line">|        S . o+X.=|</span><br><span class="line">|         o o.+.=o|</span><br><span class="line">|          . = B o|</span><br><span class="line">|             X o+|</span><br><span class="line">|              +oo|</span><br><span class="line">+----[SHA256]-----+</span><br></pre></td></tr></table></figure>

<p>将秘钥分别复制到ceph_node1, ceph_node2, ceph_node3上</p>
<p><code>ssh-copy-id -i /root/.ssh/id_rsa.pub ceph_node1</code><br><code>ssh-copy-id -i /root/.ssh/id_rsa.pub ceph_node2</code><br><code>ssh-copy-id -i /root/.ssh/id_rsa.pub ceph_node3</code></p>
<p>验证一下免密效果</p>
<p><code>ssh ceph_node1</code></p>
<p><code>ssh ceph_node2</code></p>
<p><code>ssh ceph_node3</code></p>
<h2 id="配置时间服务器"><a href="#配置时间服务器" class="headerlink" title="配置时间服务器"></a>配置时间服务器</h2><p>在ceph_node1上配置时间服务器</p>
<p>安装chrony时间服务器软件</p>
<p><code>yum -y install chrony</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vi /etc/chrony.conf</span><br><span class="line"></span><br><span class="line">server ntp1.aliyun.com iburst</span><br><span class="line">server ntp2.aliyun.com iburst</span><br><span class="line">server ntp3.aliyun.com iburst</span><br><span class="line"></span><br><span class="line">allow 192.168.111.0/24</span><br><span class="line">local stratum 10</span><br></pre></td></tr></table></figure>

<p><code>systemctl start chronyd &amp;&amp; systemctl enable chronyd</code></p>
<p>在ceph_node2 &amp; ceph_node3上配置</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vi /etc/chrony.conf</span><br><span class="line"></span><br><span class="line">server ceph_node1 iburst</span><br></pre></td></tr></table></figure>

<p>查看时间同步源</p>
<p><code>chronyc sources -v</code></p>
<p>手动同步系统时钟 </p>
<p><code>chronyc -a makestep</code> </p>
<h2 id="配置yum源"><a href="#配置yum源" class="headerlink" title="配置yum源"></a>配置yum源</h2><p><code>cd /etc/yum.repos.d/</code></p>
<p><code>mkdir bak</code></p>
<p><code>mv *.repo bak</code></p>
<h3 id="基础yum源"><a href="#基础yum源" class="headerlink" title="基础yum源"></a>基础yum源</h3><p><code>curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo</code></p>
<h3 id="epel源"><a href="#epel源" class="headerlink" title="epel源"></a>epel源</h3><p><code>curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</code></p>
<h3 id="ceph源"><a href="#ceph源" class="headerlink" title="ceph源"></a>ceph源</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cat &lt;&lt; EOF |tee /etc/yum.repos.d/ceph.repo</span><br><span class="line"></span><br><span class="line">[Ceph]</span><br><span class="line">name=Ceph packages for $basearch</span><br><span class="line">baseurl=https://mirrors.aliyun.com/ceph/rpm-nautilus/el7/\$basearch</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">type=rpm-md</span><br><span class="line">gpgkey=https://download.ceph.com/keys/release.asc</span><br><span class="line">priority=1</span><br><span class="line"></span><br><span class="line">[Ceph-noarch]</span><br><span class="line">name=Ceph noarch packages </span><br><span class="line">baseurl=https://mirrors.aliyun.com/ceph/rpm-nautilus/el7/noarch</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">type=rpm-md</span><br><span class="line">gpgkey=https://download.ceph.com/keys/release.asc</span><br><span class="line">priority=1</span><br><span class="line"></span><br><span class="line">[Ceph-source]</span><br><span class="line">name=Ceph source packages </span><br><span class="line">baseurl=https://mirrors.aliyun.com/ceph/rpm-nautilus/el7/SRPMS</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">type=rpm-md</span><br><span class="line">gpgkey=https://download.ceph.com/keys/release.asc</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>生成yum源缓存</p>
<p><code>yum clean all</code></p>
<p><code>yum makecache fast</code></p>
<p>yum list |grep ceph</p>
<h1 id="部署Ceph"><a href="#部署Ceph" class="headerlink" title="部署Ceph"></a>部署Ceph</h1><h2 id="部署控制节点"><a href="#部署控制节点" class="headerlink" title="部署控制节点"></a>部署控制节点</h2><p>在ceph_node1节点上安装ceph-deploy</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum -y install ceph-deploy ceph </span><br></pre></td></tr></table></figure>

<p>在ceph_node1上创建一个cluster目录，<strong>所有命令再此目录下进行操作</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@ceph_node1 ~]# mkdir /cluster</span><br><span class="line">[root@ceph_node1 ~]# cd /cluster</span><br></pre></td></tr></table></figure>

<p> 将ceph_node1,ceph_node2,ceph_node3加入集群</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@ceph_node1 cluster]# ceph-deploy new ceph_node1 ceph_node2 ceph_node3</span><br><span class="line"></span><br><span class="line">[ceph_deploy.conf][DEBUG ] found configuration file at: /root/.cephdeploy.conf</span><br><span class="line">[ceph_deploy.cli][INFO  ] Invoked (2.0.1): /usr/bin/ceph-deploy new ceph_node1 ceph_node2 ceph_node3</span><br><span class="line">[ceph_deploy.cli][INFO  ] ceph-deploy options:</span><br><span class="line">[ceph_deploy.cli][INFO  ]  username                      : None</span><br><span class="line">[ceph_deploy.cli][INFO  ]  func                          : &lt;function new at 0x7ffbbbc21de8&gt;</span><br><span class="line">[ceph_deploy.cli][INFO  ]  verbose                       : False</span><br><span class="line">[ceph_deploy.cli][INFO  ]  overwrite_conf                : False</span><br><span class="line">[ceph_deploy.cli][INFO  ]  quiet                         : False</span><br><span class="line">[ceph_deploy.cli][INFO  ]  cd_conf                       : &lt;ceph_deploy.conf.cephdeploy.Conf instance at 0x7ffbbb39c4d0&gt;</span><br><span class="line">[ceph_deploy.cli][INFO  ]  cluster                       : ceph</span><br><span class="line">[ceph_deploy.cli][INFO  ]  ssh_copykey                   : True</span><br><span class="line">[ceph_deploy.cli][INFO  ]  mon                           : [&#x27;ceph_node1&#x27;, &#x27;ceph_node2&#x27;, &#x27;ceph_node3&#x27;]</span><br><span class="line">[ceph_deploy.cli][INFO  ]  public_network                : None</span><br><span class="line">[ceph_deploy.cli][INFO  ]  ceph_conf                     : None</span><br><span class="line">[ceph_deploy.cli][INFO  ]  cluster_network               : None</span><br><span class="line">[ceph_deploy.cli][INFO  ]  default_release               : False</span><br><span class="line">[ceph_deploy.cli][INFO  ]  fsid                          : None</span><br><span class="line">[ceph_deploy.new][DEBUG ] Creating new cluster named ceph</span><br><span class="line">[ceph_deploy.new][INFO  ] making sure passwordless SSH succeeds</span><br><span class="line">[ceph_node1][DEBUG ] connected to host: ceph_node1 </span><br><span class="line">[ceph_node1][DEBUG ] detect platform information from remote host</span><br><span class="line">[ceph_node1][DEBUG ] detect machine type</span><br><span class="line">[ceph_node1][DEBUG ] find the location of an executable</span><br><span class="line">[ceph_node1][INFO  ] Running command: /usr/sbin/ip link show</span><br><span class="line">[ceph_node1][INFO  ] Running command: /usr/sbin/ip addr show</span><br><span class="line">[ceph_node1][DEBUG ] IP addresses found: [u&#x27;192.168.111.11&#x27;]</span><br><span class="line">[ceph_deploy.new][DEBUG ] Resolving host ceph_node1</span><br><span class="line">[ceph_deploy.new][DEBUG ] Monitor ceph_node1 at 192.168.111.11</span><br><span class="line">[ceph_deploy.new][INFO  ] making sure passwordless SSH succeeds</span><br><span class="line">[ceph_node2][DEBUG ] connected to host: ceph_node1 </span><br><span class="line">[ceph_node2][INFO  ] Running command: ssh -CT -o BatchMode=yes ceph_node2</span><br><span class="line">[ceph_node2][DEBUG ] connected to host: ceph_node2 </span><br><span class="line">[ceph_node2][DEBUG ] detect platform information from remote host</span><br><span class="line">[ceph_node2][DEBUG ] detect machine type</span><br><span class="line">[ceph_node2][DEBUG ] find the location of an executable</span><br><span class="line">[ceph_node2][INFO  ] Running command: /usr/sbin/ip link show</span><br><span class="line">[ceph_node2][INFO  ] Running command: /usr/sbin/ip addr show</span><br><span class="line">[ceph_node2][DEBUG ] IP addresses found: [u&#x27;192.168.111.12&#x27;]</span><br><span class="line">[ceph_deploy.new][DEBUG ] Resolving host ceph_node2</span><br><span class="line">[ceph_deploy.new][DEBUG ] Monitor ceph_node2 at 192.168.111.12</span><br><span class="line">[ceph_deploy.new][INFO  ] making sure passwordless SSH succeeds</span><br><span class="line">[ceph_node3][DEBUG ] connected to host: ceph_node1 </span><br><span class="line">[ceph_node3][INFO  ] Running command: ssh -CT -o BatchMode=yes ceph_node3</span><br><span class="line">[ceph_node3][DEBUG ] connected to host: ceph_node3 </span><br><span class="line">[ceph_node3][DEBUG ] detect platform information from remote host</span><br><span class="line">[ceph_node3][DEBUG ] detect machine type</span><br><span class="line">[ceph_node3][DEBUG ] find the location of an executable</span><br><span class="line">[ceph_node3][INFO  ] Running command: /usr/sbin/ip link show</span><br><span class="line">[ceph_node3][INFO  ] Running command: /usr/sbin/ip addr show</span><br><span class="line">[ceph_node3][DEBUG ] IP addresses found: [u&#x27;192.168.111.13&#x27;]</span><br><span class="line">[ceph_deploy.new][DEBUG ] Resolving host ceph_node3</span><br><span class="line">[ceph_deploy.new][DEBUG ] Monitor ceph_node3 at 192.168.111.13</span><br><span class="line">[ceph_deploy.new][DEBUG ] Monitor initial members are [&#x27;ceph_node1&#x27;, &#x27;ceph_node2&#x27;, &#x27;ceph_node3&#x27;]</span><br><span class="line">[ceph_deploy.new][DEBUG ] Monitor addrs are [&#x27;192.168.111.11&#x27;, &#x27;192.168.111.12&#x27;, &#x27;192.168.111.13&#x27;]</span><br><span class="line">[ceph_deploy.new][DEBUG ] Creating a random mon key...</span><br><span class="line">[ceph_deploy.new][DEBUG ] Writing monitor keyring to ceph.mon.keyring...</span><br><span class="line">[ceph_deploy.new][DEBUG ] Writing initial config to ceph.conf...</span><br></pre></td></tr></table></figure>

<p>输出没有报错，表示部署成功。</p>
<p>查看ceph版本</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@ceph_node1 cluster]# ceph -v</span><br><span class="line">ceph version 14.2.22 (ca74598065096e6fcbd8433c8779a2be0c889351) nautilus (stable)</span><br></pre></td></tr></table></figure>

<h2 id="生成mon角色"><a href="#生成mon角色" class="headerlink" title="生成mon角色"></a>生成mon角色</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@ceph_node1 cluster]# ceph-deploy mon create-initial</span><br><span class="line"></span><br><span class="line">[ceph_deploy.conf][DEBUG ] found configuration file at: /root/.cephdeploy.conf</span><br><span class="line">[ceph_deploy.cli][INFO  ] Invoked (2.0.1): /usr/bin/ceph-deploy mon create-initial</span><br><span class="line">[ceph_deploy.cli][INFO  ] ceph-deploy options:</span><br><span class="line">[ceph_deploy.cli][INFO  ]  username                      : None</span><br><span class="line">[ceph_deploy.cli][INFO  ]  verbose                       : False</span><br><span class="line">[ceph_deploy.cli][INFO  ]  overwrite_conf                : False</span><br><span class="line">[ceph_deploy.cli][INFO  ]  subcommand                    : create-initial</span><br><span class="line">[ceph_deploy.cli][INFO  ]  quiet                         : False</span><br><span class="line">[ceph_deploy.cli][INFO  ]  cd_conf                       : &lt;ceph_deploy.conf.cephdeploy.Conf instance at 0x7f8c09aa2e60&gt;</span><br><span class="line">[ceph_deploy.cli][INFO  ]  cluster                       : ceph</span><br><span class="line">[ceph_deploy.cli][INFO  ]  func                          : &lt;function mon at 0x7f8c09af7410&gt;</span><br><span class="line">[ceph_deploy.cli][INFO  ]  ceph_conf                     : None</span><br><span class="line">[ceph_deploy.cli][INFO  ]  default_release               : False</span><br><span class="line">[ceph_deploy.cli][INFO  ]  keyrings                      : None</span><br><span class="line">[ceph_deploy.mon][DEBUG ] Deploying mon, cluster ceph hosts ceph_node1 ceph_node2 ceph_node3</span><br><span class="line">[ceph_deploy.mon][DEBUG ] detecting platform for host ceph_node1 ...</span><br><span class="line">[ceph_node1][DEBUG ] connected to host: ceph_node1 </span><br><span class="line">[ceph_node1][DEBUG ] detect platform information from remote host</span><br><span class="line">[ceph_node1][DEBUG ] detect machine type</span><br><span class="line">[ceph_node1][DEBUG ] find the location of an executable</span><br><span class="line">[ceph_deploy.mon][INFO  ] distro info: CentOS Linux 7.9.2009 Core</span><br><span class="line">[ceph_node1][DEBUG ] determining if provided host has same hostname in remote</span><br><span class="line">[ceph_node1][DEBUG ] get remote short hostname</span><br><span class="line">[ceph_node1][DEBUG ] deploying mon to ceph_node1</span><br><span class="line">[ceph_node1][DEBUG ] get remote short hostname</span><br><span class="line">[ceph_node1][DEBUG ] remote hostname: ceph_node1</span><br><span class="line">[ceph_node1][DEBUG ] write cluster configuration to /etc/ceph/&#123;cluster&#125;.conf</span><br><span class="line">[ceph_node1][DEBUG ] create the mon path if it does not exist</span><br><span class="line">[ceph_node1][DEBUG ] checking for done path: /var/lib/ceph/mon/ceph-ceph_node1/done</span><br><span class="line">[ceph_node1][DEBUG ] create a done file to avoid re-doing the mon deployment</span><br><span class="line">[ceph_node1][DEBUG ] create the init path if it does not exist</span><br><span class="line">[ceph_node1][INFO  ] Running command: systemctl enable ceph.target</span><br><span class="line">[ceph_node1][INFO  ] Running command: systemctl enable ceph-mon@ceph_node1</span><br><span class="line">[ceph_node1][INFO  ] Running command: systemctl start ceph-mon@ceph_node1</span><br><span class="line">[ceph_node1][INFO  ] Running command: ceph --cluster=ceph --admin-daemon /var/run/ceph/ceph-mon.ceph_node1.asok mon_status</span><br><span class="line">[ceph_node1][DEBUG ] ********************************************************************************</span><br><span class="line">[ceph_node1][DEBUG ] status for monitor: mon.ceph_node1</span><br><span class="line">[ceph_node1][DEBUG ] &#123;</span><br><span class="line">[ceph_node1][DEBUG ]   &quot;election_epoch&quot;: 6, </span><br><span class="line">[ceph_node1][DEBUG ]   &quot;extra_probe_peers&quot;: [</span><br><span class="line">[ceph_node1][DEBUG ]     &#123;</span><br><span class="line">[ceph_node1][DEBUG ]       &quot;addrvec&quot;: [</span><br><span class="line">[ceph_node1][DEBUG ]         &#123;</span><br><span class="line">[ceph_node1][DEBUG ]           &quot;addr&quot;: &quot;192.168.111.12:3300&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]           &quot;nonce&quot;: 0, </span><br><span class="line">[ceph_node1][DEBUG ]           &quot;type&quot;: &quot;v2&quot;</span><br><span class="line">[ceph_node1][DEBUG ]         &#125;, </span><br><span class="line">[ceph_node1][DEBUG ]         &#123;</span><br><span class="line">[ceph_node1][DEBUG ]           &quot;addr&quot;: &quot;192.168.111.12:6789&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]           &quot;nonce&quot;: 0, </span><br><span class="line">[ceph_node1][DEBUG ]           &quot;type&quot;: &quot;v1&quot;</span><br><span class="line">[ceph_node1][DEBUG ]         &#125;</span><br><span class="line">[ceph_node1][DEBUG ]       ]</span><br><span class="line">[ceph_node1][DEBUG ]     &#125;, </span><br><span class="line">[ceph_node1][DEBUG ]     &#123;</span><br><span class="line">[ceph_node1][DEBUG ]       &quot;addrvec&quot;: [</span><br><span class="line">[ceph_node1][DEBUG ]         &#123;</span><br><span class="line">[ceph_node1][DEBUG ]           &quot;addr&quot;: &quot;192.168.111.13:3300&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]           &quot;nonce&quot;: 0, </span><br><span class="line">[ceph_node1][DEBUG ]           &quot;type&quot;: &quot;v2&quot;</span><br><span class="line">[ceph_node1][DEBUG ]         &#125;, </span><br><span class="line">[ceph_node1][DEBUG ]         &#123;</span><br><span class="line">[ceph_node1][DEBUG ]           &quot;addr&quot;: &quot;192.168.111.13:6789&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]           &quot;nonce&quot;: 0, </span><br><span class="line">[ceph_node1][DEBUG ]           &quot;type&quot;: &quot;v1&quot;</span><br><span class="line">[ceph_node1][DEBUG ]         &#125;</span><br><span class="line">[ceph_node1][DEBUG ]       ]</span><br><span class="line">[ceph_node1][DEBUG ]     &#125;</span><br><span class="line">[ceph_node1][DEBUG ]   ], </span><br><span class="line">[ceph_node1][DEBUG ]   &quot;feature_map&quot;: &#123;</span><br><span class="line">[ceph_node1][DEBUG ]     &quot;mon&quot;: [</span><br><span class="line">[ceph_node1][DEBUG ]       &#123;</span><br><span class="line">[ceph_node1][DEBUG ]         &quot;features&quot;: &quot;0x3ffddff8ffecffff&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]         &quot;num&quot;: 1, </span><br><span class="line">[ceph_node1][DEBUG ]         &quot;release&quot;: &quot;luminous&quot;</span><br><span class="line">[ceph_node1][DEBUG ]       &#125;</span><br><span class="line">[ceph_node1][DEBUG ]     ]</span><br><span class="line">[ceph_node1][DEBUG ]   &#125;, </span><br><span class="line">[ceph_node1][DEBUG ]   &quot;features&quot;: &#123;</span><br><span class="line">[ceph_node1][DEBUG ]     &quot;quorum_con&quot;: &quot;4611087854035861503&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]     &quot;quorum_mon&quot;: [</span><br><span class="line">[ceph_node1][DEBUG ]       &quot;kraken&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]       &quot;luminous&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]       &quot;mimic&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]       &quot;osdmap-prune&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]       &quot;nautilus&quot;</span><br><span class="line">[ceph_node1][DEBUG ]     ], </span><br><span class="line">[ceph_node1][DEBUG ]     &quot;required_con&quot;: &quot;2449958747315912708&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]     &quot;required_mon&quot;: [</span><br><span class="line">[ceph_node1][DEBUG ]       &quot;kraken&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]       &quot;luminous&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]       &quot;mimic&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]       &quot;osdmap-prune&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]       &quot;nautilus&quot;</span><br><span class="line">[ceph_node1][DEBUG ]     ]</span><br><span class="line">[ceph_node1][DEBUG ]   &#125;, </span><br><span class="line">[ceph_node1][DEBUG ]   &quot;monmap&quot;: &#123;</span><br><span class="line">[ceph_node1][DEBUG ]     &quot;created&quot;: &quot;2022-02-18 13:54:10.100119&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]     &quot;epoch&quot;: 1, </span><br><span class="line">[ceph_node1][DEBUG ]     &quot;features&quot;: &#123;</span><br><span class="line">[ceph_node1][DEBUG ]       &quot;optional&quot;: [], </span><br><span class="line">[ceph_node1][DEBUG ]       &quot;persistent&quot;: [</span><br><span class="line">[ceph_node1][DEBUG ]         &quot;kraken&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]         &quot;luminous&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]         &quot;mimic&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]         &quot;osdmap-prune&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]         &quot;nautilus&quot;</span><br><span class="line">[ceph_node1][DEBUG ]       ]</span><br><span class="line">[ceph_node1][DEBUG ]     &#125;, </span><br><span class="line">[ceph_node1][DEBUG ]     &quot;fsid&quot;: &quot;f7be9981-1e57-4165-989e-3c7206331a20&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]     &quot;min_mon_release&quot;: 14, </span><br><span class="line">[ceph_node1][DEBUG ]     &quot;min_mon_release_name&quot;: &quot;nautilus&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]     &quot;modified&quot;: &quot;2022-02-18 13:54:10.100119&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]     &quot;mons&quot;: [</span><br><span class="line">[ceph_node1][DEBUG ]       &#123;</span><br><span class="line">[ceph_node1][DEBUG ]         &quot;addr&quot;: &quot;192.168.111.11:6789/0&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]         &quot;name&quot;: &quot;ceph_node1&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]         &quot;public_addr&quot;: &quot;192.168.111.11:6789/0&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]         &quot;public_addrs&quot;: &#123;</span><br><span class="line">[ceph_node1][DEBUG ]           &quot;addrvec&quot;: [</span><br><span class="line">[ceph_node1][DEBUG ]             &#123;</span><br><span class="line">[ceph_node1][DEBUG ]               &quot;addr&quot;: &quot;192.168.111.11:3300&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]               &quot;nonce&quot;: 0, </span><br><span class="line">[ceph_node1][DEBUG ]               &quot;type&quot;: &quot;v2&quot;</span><br><span class="line">[ceph_node1][DEBUG ]             &#125;, </span><br><span class="line">[ceph_node1][DEBUG ]             &#123;</span><br><span class="line">[ceph_node1][DEBUG ]               &quot;addr&quot;: &quot;192.168.111.11:6789&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]               &quot;nonce&quot;: 0, </span><br><span class="line">[ceph_node1][DEBUG ]               &quot;type&quot;: &quot;v1&quot;</span><br><span class="line">[ceph_node1][DEBUG ]             &#125;</span><br><span class="line">[ceph_node1][DEBUG ]           ]</span><br><span class="line">[ceph_node1][DEBUG ]         &#125;, </span><br><span class="line">[ceph_node1][DEBUG ]         &quot;rank&quot;: 0</span><br><span class="line">[ceph_node1][DEBUG ]       &#125;, </span><br><span class="line">[ceph_node1][DEBUG ]       &#123;</span><br><span class="line">[ceph_node1][DEBUG ]         &quot;addr&quot;: &quot;192.168.111.12:6789/0&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]         &quot;name&quot;: &quot;ceph_node2&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]         &quot;public_addr&quot;: &quot;192.168.111.12:6789/0&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]         &quot;public_addrs&quot;: &#123;</span><br><span class="line">[ceph_node1][DEBUG ]           &quot;addrvec&quot;: [</span><br><span class="line">[ceph_node1][DEBUG ]             &#123;</span><br><span class="line">[ceph_node1][DEBUG ]               &quot;addr&quot;: &quot;192.168.111.12:3300&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]               &quot;nonce&quot;: 0, </span><br><span class="line">[ceph_node1][DEBUG ]               &quot;type&quot;: &quot;v2&quot;</span><br><span class="line">[ceph_node1][DEBUG ]             &#125;, </span><br><span class="line">[ceph_node1][DEBUG ]             &#123;</span><br><span class="line">[ceph_node1][DEBUG ]               &quot;addr&quot;: &quot;192.168.111.12:6789&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]               &quot;nonce&quot;: 0, </span><br><span class="line">[ceph_node1][DEBUG ]               &quot;type&quot;: &quot;v1&quot;</span><br><span class="line">[ceph_node1][DEBUG ]             &#125;</span><br><span class="line">[ceph_node1][DEBUG ]           ]</span><br><span class="line">[ceph_node1][DEBUG ]         &#125;, </span><br><span class="line">[ceph_node1][DEBUG ]         &quot;rank&quot;: 1</span><br><span class="line">[ceph_node1][DEBUG ]       &#125;, </span><br><span class="line">[ceph_node1][DEBUG ]       &#123;</span><br><span class="line">[ceph_node1][DEBUG ]         &quot;addr&quot;: &quot;192.168.111.13:6789/0&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]         &quot;name&quot;: &quot;ceph_node3&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]         &quot;public_addr&quot;: &quot;192.168.111.13:6789/0&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]         &quot;public_addrs&quot;: &#123;</span><br><span class="line">[ceph_node1][DEBUG ]           &quot;addrvec&quot;: [</span><br><span class="line">[ceph_node1][DEBUG ]             &#123;</span><br><span class="line">[ceph_node1][DEBUG ]               &quot;addr&quot;: &quot;192.168.111.13:3300&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]               &quot;nonce&quot;: 0, </span><br><span class="line">[ceph_node1][DEBUG ]               &quot;type&quot;: &quot;v2&quot;</span><br><span class="line">[ceph_node1][DEBUG ]             &#125;, </span><br><span class="line">[ceph_node1][DEBUG ]             &#123;</span><br><span class="line">[ceph_node1][DEBUG ]               &quot;addr&quot;: &quot;192.168.111.13:6789&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]               &quot;nonce&quot;: 0, </span><br><span class="line">[ceph_node1][DEBUG ]               &quot;type&quot;: &quot;v1&quot;</span><br><span class="line">[ceph_node1][DEBUG ]             &#125;</span><br><span class="line">[ceph_node1][DEBUG ]           ]</span><br><span class="line">[ceph_node1][DEBUG ]         &#125;, </span><br><span class="line">[ceph_node1][DEBUG ]         &quot;rank&quot;: 2</span><br><span class="line">[ceph_node1][DEBUG ]       &#125;</span><br><span class="line">[ceph_node1][DEBUG ]     ]</span><br><span class="line">[ceph_node1][DEBUG ]   &#125;, </span><br><span class="line">[ceph_node1][DEBUG ]   &quot;name&quot;: &quot;ceph_node1&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]   &quot;outside_quorum&quot;: [], </span><br><span class="line">[ceph_node1][DEBUG ]   &quot;quorum&quot;: [</span><br><span class="line">[ceph_node1][DEBUG ]     0, </span><br><span class="line">[ceph_node1][DEBUG ]     1, </span><br><span class="line">[ceph_node1][DEBUG ]     2</span><br><span class="line">[ceph_node1][DEBUG ]   ], </span><br><span class="line">[ceph_node1][DEBUG ]   &quot;quorum_age&quot;: 34, </span><br><span class="line">[ceph_node1][DEBUG ]   &quot;rank&quot;: 0, </span><br><span class="line">[ceph_node1][DEBUG ]   &quot;state&quot;: &quot;leader&quot;, </span><br><span class="line">[ceph_node1][DEBUG ]   &quot;sync_provider&quot;: []</span><br><span class="line">[ceph_node1][DEBUG ] &#125;</span><br><span class="line">[ceph_node1][DEBUG ] ********************************************************************************</span><br><span class="line">[ceph_node1][INFO  ] monitor: mon.ceph_node1 is running</span><br><span class="line">[ceph_node1][INFO  ] Running command: ceph --cluster=ceph --admin-daemon /var/run/ceph/ceph-mon.ceph_node1.asok mon_status</span><br><span class="line">[ceph_deploy.mon][DEBUG ] detecting platform for host ceph_node2 ...</span><br><span class="line">[ceph_node2][DEBUG ] connected to host: ceph_node2 </span><br><span class="line">[ceph_node2][DEBUG ] detect platform information from remote host</span><br><span class="line">[ceph_node2][DEBUG ] detect machine type</span><br><span class="line">[ceph_node2][DEBUG ] find the location of an executable</span><br><span class="line">[ceph_deploy.mon][INFO  ] distro info: CentOS Linux 7.9.2009 Core</span><br><span class="line">[ceph_node2][DEBUG ] determining if provided host has same hostname in remote</span><br><span class="line">[ceph_node2][DEBUG ] get remote short hostname</span><br><span class="line">[ceph_node2][DEBUG ] deploying mon to ceph_node2</span><br><span class="line">[ceph_node2][DEBUG ] get remote short hostname</span><br><span class="line">[ceph_node2][DEBUG ] remote hostname: ceph_node2</span><br><span class="line">[ceph_node2][DEBUG ] write cluster configuration to /etc/ceph/&#123;cluster&#125;.conf</span><br><span class="line">[ceph_node2][DEBUG ] create the mon path if it does not exist</span><br><span class="line">[ceph_node2][DEBUG ] checking for done path: /var/lib/ceph/mon/ceph-ceph_node2/done</span><br><span class="line">[ceph_node2][DEBUG ] create a done file to avoid re-doing the mon deployment</span><br><span class="line">[ceph_node2][DEBUG ] create the init path if it does not exist</span><br><span class="line">[ceph_node2][INFO  ] Running command: systemctl enable ceph.target</span><br><span class="line">[ceph_node2][INFO  ] Running command: systemctl enable ceph-mon@ceph_node2</span><br><span class="line">[ceph_node2][INFO  ] Running command: systemctl start ceph-mon@ceph_node2</span><br><span class="line">[ceph_node2][INFO  ] Running command: ceph --cluster=ceph --admin-daemon /var/run/ceph/ceph-mon.ceph_node2.asok mon_status</span><br><span class="line">[ceph_node2][DEBUG ] ********************************************************************************</span><br><span class="line">[ceph_node2][DEBUG ] status for monitor: mon.ceph_node2</span><br><span class="line">[ceph_node2][DEBUG ] &#123;</span><br><span class="line">[ceph_node2][DEBUG ]   &quot;election_epoch&quot;: 6, </span><br><span class="line">[ceph_node2][DEBUG ]   &quot;extra_probe_peers&quot;: [</span><br><span class="line">[ceph_node2][DEBUG ]     &#123;</span><br><span class="line">[ceph_node2][DEBUG ]       &quot;addrvec&quot;: [</span><br><span class="line">[ceph_node2][DEBUG ]         &#123;</span><br><span class="line">[ceph_node2][DEBUG ]           &quot;addr&quot;: &quot;192.168.111.11:3300&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]           &quot;nonce&quot;: 0, </span><br><span class="line">[ceph_node2][DEBUG ]           &quot;type&quot;: &quot;v2&quot;</span><br><span class="line">[ceph_node2][DEBUG ]         &#125;, </span><br><span class="line">[ceph_node2][DEBUG ]         &#123;</span><br><span class="line">[ceph_node2][DEBUG ]           &quot;addr&quot;: &quot;192.168.111.11:6789&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]           &quot;nonce&quot;: 0, </span><br><span class="line">[ceph_node2][DEBUG ]           &quot;type&quot;: &quot;v1&quot;</span><br><span class="line">[ceph_node2][DEBUG ]         &#125;</span><br><span class="line">[ceph_node2][DEBUG ]       ]</span><br><span class="line">[ceph_node2][DEBUG ]     &#125;, </span><br><span class="line">[ceph_node2][DEBUG ]     &#123;</span><br><span class="line">[ceph_node2][DEBUG ]       &quot;addrvec&quot;: [</span><br><span class="line">[ceph_node2][DEBUG ]         &#123;</span><br><span class="line">[ceph_node2][DEBUG ]           &quot;addr&quot;: &quot;192.168.111.13:3300&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]           &quot;nonce&quot;: 0, </span><br><span class="line">[ceph_node2][DEBUG ]           &quot;type&quot;: &quot;v2&quot;</span><br><span class="line">[ceph_node2][DEBUG ]         &#125;, </span><br><span class="line">[ceph_node2][DEBUG ]         &#123;</span><br><span class="line">[ceph_node2][DEBUG ]           &quot;addr&quot;: &quot;192.168.111.13:6789&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]           &quot;nonce&quot;: 0, </span><br><span class="line">[ceph_node2][DEBUG ]           &quot;type&quot;: &quot;v1&quot;</span><br><span class="line">[ceph_node2][DEBUG ]         &#125;</span><br><span class="line">[ceph_node2][DEBUG ]       ]</span><br><span class="line">[ceph_node2][DEBUG ]     &#125;</span><br><span class="line">[ceph_node2][DEBUG ]   ], </span><br><span class="line">[ceph_node2][DEBUG ]   &quot;feature_map&quot;: &#123;</span><br><span class="line">[ceph_node2][DEBUG ]     &quot;mon&quot;: [</span><br><span class="line">[ceph_node2][DEBUG ]       &#123;</span><br><span class="line">[ceph_node2][DEBUG ]         &quot;features&quot;: &quot;0x3ffddff8ffecffff&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]         &quot;num&quot;: 1, </span><br><span class="line">[ceph_node2][DEBUG ]         &quot;release&quot;: &quot;luminous&quot;</span><br><span class="line">[ceph_node2][DEBUG ]       &#125;</span><br><span class="line">[ceph_node2][DEBUG ]     ]</span><br><span class="line">[ceph_node2][DEBUG ]   &#125;, </span><br><span class="line">[ceph_node2][DEBUG ]   &quot;features&quot;: &#123;</span><br><span class="line">[ceph_node2][DEBUG ]     &quot;quorum_con&quot;: &quot;4611087854035861503&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]     &quot;quorum_mon&quot;: [</span><br><span class="line">[ceph_node2][DEBUG ]       &quot;kraken&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]       &quot;luminous&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]       &quot;mimic&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]       &quot;osdmap-prune&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]       &quot;nautilus&quot;</span><br><span class="line">[ceph_node2][DEBUG ]     ], </span><br><span class="line">[ceph_node2][DEBUG ]     &quot;required_con&quot;: &quot;2449958747315912708&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]     &quot;required_mon&quot;: [</span><br><span class="line">[ceph_node2][DEBUG ]       &quot;kraken&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]       &quot;luminous&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]       &quot;mimic&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]       &quot;osdmap-prune&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]       &quot;nautilus&quot;</span><br><span class="line">[ceph_node2][DEBUG ]     ]</span><br><span class="line">[ceph_node2][DEBUG ]   &#125;, </span><br><span class="line">[ceph_node2][DEBUG ]   &quot;monmap&quot;: &#123;</span><br><span class="line">[ceph_node2][DEBUG ]     &quot;created&quot;: &quot;2022-02-18 13:54:10.100119&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]     &quot;epoch&quot;: 1, </span><br><span class="line">[ceph_node2][DEBUG ]     &quot;features&quot;: &#123;</span><br><span class="line">[ceph_node2][DEBUG ]       &quot;optional&quot;: [], </span><br><span class="line">[ceph_node2][DEBUG ]       &quot;persistent&quot;: [</span><br><span class="line">[ceph_node2][DEBUG ]         &quot;kraken&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]         &quot;luminous&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]         &quot;mimic&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]         &quot;osdmap-prune&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]         &quot;nautilus&quot;</span><br><span class="line">[ceph_node2][DEBUG ]       ]</span><br><span class="line">[ceph_node2][DEBUG ]     &#125;, </span><br><span class="line">[ceph_node2][DEBUG ]     &quot;fsid&quot;: &quot;f7be9981-1e57-4165-989e-3c7206331a20&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]     &quot;min_mon_release&quot;: 14, </span><br><span class="line">[ceph_node2][DEBUG ]     &quot;min_mon_release_name&quot;: &quot;nautilus&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]     &quot;modified&quot;: &quot;2022-02-18 13:54:10.100119&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]     &quot;mons&quot;: [</span><br><span class="line">[ceph_node2][DEBUG ]       &#123;</span><br><span class="line">[ceph_node2][DEBUG ]         &quot;addr&quot;: &quot;192.168.111.11:6789/0&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]         &quot;name&quot;: &quot;ceph_node1&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]         &quot;public_addr&quot;: &quot;192.168.111.11:6789/0&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]         &quot;public_addrs&quot;: &#123;</span><br><span class="line">[ceph_node2][DEBUG ]           &quot;addrvec&quot;: [</span><br><span class="line">[ceph_node2][DEBUG ]             &#123;</span><br><span class="line">[ceph_node2][DEBUG ]               &quot;addr&quot;: &quot;192.168.111.11:3300&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]               &quot;nonce&quot;: 0, </span><br><span class="line">[ceph_node2][DEBUG ]               &quot;type&quot;: &quot;v2&quot;</span><br><span class="line">[ceph_node2][DEBUG ]             &#125;, </span><br><span class="line">[ceph_node2][DEBUG ]             &#123;</span><br><span class="line">[ceph_node2][DEBUG ]               &quot;addr&quot;: &quot;192.168.111.11:6789&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]               &quot;nonce&quot;: 0, </span><br><span class="line">[ceph_node2][DEBUG ]               &quot;type&quot;: &quot;v1&quot;</span><br><span class="line">[ceph_node2][DEBUG ]             &#125;</span><br><span class="line">[ceph_node2][DEBUG ]           ]</span><br><span class="line">[ceph_node2][DEBUG ]         &#125;, </span><br><span class="line">[ceph_node2][DEBUG ]         &quot;rank&quot;: 0</span><br><span class="line">[ceph_node2][DEBUG ]       &#125;, </span><br><span class="line">[ceph_node2][DEBUG ]       &#123;</span><br><span class="line">[ceph_node2][DEBUG ]         &quot;addr&quot;: &quot;192.168.111.12:6789/0&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]         &quot;name&quot;: &quot;ceph_node2&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]         &quot;public_addr&quot;: &quot;192.168.111.12:6789/0&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]         &quot;public_addrs&quot;: &#123;</span><br><span class="line">[ceph_node2][DEBUG ]           &quot;addrvec&quot;: [</span><br><span class="line">[ceph_node2][DEBUG ]             &#123;</span><br><span class="line">[ceph_node2][DEBUG ]               &quot;addr&quot;: &quot;192.168.111.12:3300&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]               &quot;nonce&quot;: 0, </span><br><span class="line">[ceph_node2][DEBUG ]               &quot;type&quot;: &quot;v2&quot;</span><br><span class="line">[ceph_node2][DEBUG ]             &#125;, </span><br><span class="line">[ceph_node2][DEBUG ]             &#123;</span><br><span class="line">[ceph_node2][DEBUG ]               &quot;addr&quot;: &quot;192.168.111.12:6789&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]               &quot;nonce&quot;: 0, </span><br><span class="line">[ceph_node2][DEBUG ]               &quot;type&quot;: &quot;v1&quot;</span><br><span class="line">[ceph_node2][DEBUG ]             &#125;</span><br><span class="line">[ceph_node2][DEBUG ]           ]</span><br><span class="line">[ceph_node2][DEBUG ]         &#125;, </span><br><span class="line">[ceph_node2][DEBUG ]         &quot;rank&quot;: 1</span><br><span class="line">[ceph_node2][DEBUG ]       &#125;, </span><br><span class="line">[ceph_node2][DEBUG ]       &#123;</span><br><span class="line">[ceph_node2][DEBUG ]         &quot;addr&quot;: &quot;192.168.111.13:6789/0&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]         &quot;name&quot;: &quot;ceph_node3&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]         &quot;public_addr&quot;: &quot;192.168.111.13:6789/0&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]         &quot;public_addrs&quot;: &#123;</span><br><span class="line">[ceph_node2][DEBUG ]           &quot;addrvec&quot;: [</span><br><span class="line">[ceph_node2][DEBUG ]             &#123;</span><br><span class="line">[ceph_node2][DEBUG ]               &quot;addr&quot;: &quot;192.168.111.13:3300&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]               &quot;nonce&quot;: 0, </span><br><span class="line">[ceph_node2][DEBUG ]               &quot;type&quot;: &quot;v2&quot;</span><br><span class="line">[ceph_node2][DEBUG ]             &#125;, </span><br><span class="line">[ceph_node2][DEBUG ]             &#123;</span><br><span class="line">[ceph_node2][DEBUG ]               &quot;addr&quot;: &quot;192.168.111.13:6789&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]               &quot;nonce&quot;: 0, </span><br><span class="line">[ceph_node2][DEBUG ]               &quot;type&quot;: &quot;v1&quot;</span><br><span class="line">[ceph_node2][DEBUG ]             &#125;</span><br><span class="line">[ceph_node2][DEBUG ]           ]</span><br><span class="line">[ceph_node2][DEBUG ]         &#125;, </span><br><span class="line">[ceph_node2][DEBUG ]         &quot;rank&quot;: 2</span><br><span class="line">[ceph_node2][DEBUG ]       &#125;</span><br><span class="line">[ceph_node2][DEBUG ]     ]</span><br><span class="line">[ceph_node2][DEBUG ]   &#125;, </span><br><span class="line">[ceph_node2][DEBUG ]   &quot;name&quot;: &quot;ceph_node2&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]   &quot;outside_quorum&quot;: [], </span><br><span class="line">[ceph_node2][DEBUG ]   &quot;quorum&quot;: [</span><br><span class="line">[ceph_node2][DEBUG ]     0, </span><br><span class="line">[ceph_node2][DEBUG ]     1, </span><br><span class="line">[ceph_node2][DEBUG ]     2</span><br><span class="line">[ceph_node2][DEBUG ]   ], </span><br><span class="line">[ceph_node2][DEBUG ]   &quot;quorum_age&quot;: 37, </span><br><span class="line">[ceph_node2][DEBUG ]   &quot;rank&quot;: 1, </span><br><span class="line">[ceph_node2][DEBUG ]   &quot;state&quot;: &quot;peon&quot;, </span><br><span class="line">[ceph_node2][DEBUG ]   &quot;sync_provider&quot;: []</span><br><span class="line">[ceph_node2][DEBUG ] &#125;</span><br><span class="line">[ceph_node2][DEBUG ] ********************************************************************************</span><br><span class="line">[ceph_node2][INFO  ] monitor: mon.ceph_node2 is running</span><br><span class="line">[ceph_node2][INFO  ] Running command: ceph --cluster=ceph --admin-daemon /var/run/ceph/ceph-mon.ceph_node2.asok mon_status</span><br><span class="line">[ceph_deploy.mon][DEBUG ] detecting platform for host ceph_node3 ...</span><br><span class="line">[ceph_node3][DEBUG ] connected to host: ceph_node3 </span><br><span class="line">[ceph_node3][DEBUG ] detect platform information from remote host</span><br><span class="line">[ceph_node3][DEBUG ] detect machine type</span><br><span class="line">[ceph_node3][DEBUG ] find the location of an executable</span><br><span class="line">[ceph_deploy.mon][INFO  ] distro info: CentOS Linux 7.9.2009 Core</span><br><span class="line">[ceph_node3][DEBUG ] determining if provided host has same hostname in remote</span><br><span class="line">[ceph_node3][DEBUG ] get remote short hostname</span><br><span class="line">[ceph_node3][DEBUG ] deploying mon to ceph_node3</span><br><span class="line">[ceph_node3][DEBUG ] get remote short hostname</span><br><span class="line">[ceph_node3][DEBUG ] remote hostname: ceph_node3</span><br><span class="line">[ceph_node3][DEBUG ] write cluster configuration to /etc/ceph/&#123;cluster&#125;.conf</span><br><span class="line">[ceph_node3][DEBUG ] create the mon path if it does not exist</span><br><span class="line">[ceph_node3][DEBUG ] checking for done path: /var/lib/ceph/mon/ceph-ceph_node3/done</span><br><span class="line">[ceph_node3][DEBUG ] create a done file to avoid re-doing the mon deployment</span><br><span class="line">[ceph_node3][DEBUG ] create the init path if it does not exist</span><br><span class="line">[ceph_node3][INFO  ] Running command: systemctl enable ceph.target</span><br><span class="line">[ceph_node3][INFO  ] Running command: systemctl enable ceph-mon@ceph_node3</span><br><span class="line">[ceph_node3][INFO  ] Running command: systemctl start ceph-mon@ceph_node3</span><br><span class="line">[ceph_node3][INFO  ] Running command: ceph --cluster=ceph --admin-daemon /var/run/ceph/ceph-mon.ceph_node3.asok mon_status</span><br><span class="line">[ceph_node3][DEBUG ] ********************************************************************************</span><br><span class="line">[ceph_node3][DEBUG ] status for monitor: mon.ceph_node3</span><br><span class="line">[ceph_node3][DEBUG ] &#123;</span><br><span class="line">[ceph_node3][DEBUG ]   &quot;election_epoch&quot;: 6, </span><br><span class="line">[ceph_node3][DEBUG ]   &quot;extra_probe_peers&quot;: [</span><br><span class="line">[ceph_node3][DEBUG ]     &#123;</span><br><span class="line">[ceph_node3][DEBUG ]       &quot;addrvec&quot;: [</span><br><span class="line">[ceph_node3][DEBUG ]         &#123;</span><br><span class="line">[ceph_node3][DEBUG ]           &quot;addr&quot;: &quot;192.168.111.11:3300&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]           &quot;nonce&quot;: 0, </span><br><span class="line">[ceph_node3][DEBUG ]           &quot;type&quot;: &quot;v2&quot;</span><br><span class="line">[ceph_node3][DEBUG ]         &#125;, </span><br><span class="line">[ceph_node3][DEBUG ]         &#123;</span><br><span class="line">[ceph_node3][DEBUG ]           &quot;addr&quot;: &quot;192.168.111.11:6789&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]           &quot;nonce&quot;: 0, </span><br><span class="line">[ceph_node3][DEBUG ]           &quot;type&quot;: &quot;v1&quot;</span><br><span class="line">[ceph_node3][DEBUG ]         &#125;</span><br><span class="line">[ceph_node3][DEBUG ]       ]</span><br><span class="line">[ceph_node3][DEBUG ]     &#125;, </span><br><span class="line">[ceph_node3][DEBUG ]     &#123;</span><br><span class="line">[ceph_node3][DEBUG ]       &quot;addrvec&quot;: [</span><br><span class="line">[ceph_node3][DEBUG ]         &#123;</span><br><span class="line">[ceph_node3][DEBUG ]           &quot;addr&quot;: &quot;192.168.111.12:3300&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]           &quot;nonce&quot;: 0, </span><br><span class="line">[ceph_node3][DEBUG ]           &quot;type&quot;: &quot;v2&quot;</span><br><span class="line">[ceph_node3][DEBUG ]         &#125;, </span><br><span class="line">[ceph_node3][DEBUG ]         &#123;</span><br><span class="line">[ceph_node3][DEBUG ]           &quot;addr&quot;: &quot;192.168.111.12:6789&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]           &quot;nonce&quot;: 0, </span><br><span class="line">[ceph_node3][DEBUG ]           &quot;type&quot;: &quot;v1&quot;</span><br><span class="line">[ceph_node3][DEBUG ]         &#125;</span><br><span class="line">[ceph_node3][DEBUG ]       ]</span><br><span class="line">[ceph_node3][DEBUG ]     &#125;</span><br><span class="line">[ceph_node3][DEBUG ]   ], </span><br><span class="line">[ceph_node3][DEBUG ]   &quot;feature_map&quot;: &#123;</span><br><span class="line">[ceph_node3][DEBUG ]     &quot;mon&quot;: [</span><br><span class="line">[ceph_node3][DEBUG ]       &#123;</span><br><span class="line">[ceph_node3][DEBUG ]         &quot;features&quot;: &quot;0x3ffddff8ffecffff&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]         &quot;num&quot;: 1, </span><br><span class="line">[ceph_node3][DEBUG ]         &quot;release&quot;: &quot;luminous&quot;</span><br><span class="line">[ceph_node3][DEBUG ]       &#125;</span><br><span class="line">[ceph_node3][DEBUG ]     ]</span><br><span class="line">[ceph_node3][DEBUG ]   &#125;, </span><br><span class="line">[ceph_node3][DEBUG ]   &quot;features&quot;: &#123;</span><br><span class="line">[ceph_node3][DEBUG ]     &quot;quorum_con&quot;: &quot;4611087854035861503&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]     &quot;quorum_mon&quot;: [</span><br><span class="line">[ceph_node3][DEBUG ]       &quot;kraken&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]       &quot;luminous&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]       &quot;mimic&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]       &quot;osdmap-prune&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]       &quot;nautilus&quot;</span><br><span class="line">[ceph_node3][DEBUG ]     ], </span><br><span class="line">[ceph_node3][DEBUG ]     &quot;required_con&quot;: &quot;2449958747315912708&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]     &quot;required_mon&quot;: [</span><br><span class="line">[ceph_node3][DEBUG ]       &quot;kraken&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]       &quot;luminous&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]       &quot;mimic&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]       &quot;osdmap-prune&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]       &quot;nautilus&quot;</span><br><span class="line">[ceph_node3][DEBUG ]     ]</span><br><span class="line">[ceph_node3][DEBUG ]   &#125;, </span><br><span class="line">[ceph_node3][DEBUG ]   &quot;monmap&quot;: &#123;</span><br><span class="line">[ceph_node3][DEBUG ]     &quot;created&quot;: &quot;2022-02-18 13:54:10.100119&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]     &quot;epoch&quot;: 1, </span><br><span class="line">[ceph_node3][DEBUG ]     &quot;features&quot;: &#123;</span><br><span class="line">[ceph_node3][DEBUG ]       &quot;optional&quot;: [], </span><br><span class="line">[ceph_node3][DEBUG ]       &quot;persistent&quot;: [</span><br><span class="line">[ceph_node3][DEBUG ]         &quot;kraken&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]         &quot;luminous&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]         &quot;mimic&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]         &quot;osdmap-prune&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]         &quot;nautilus&quot;</span><br><span class="line">[ceph_node3][DEBUG ]       ]</span><br><span class="line">[ceph_node3][DEBUG ]     &#125;, </span><br><span class="line">[ceph_node3][DEBUG ]     &quot;fsid&quot;: &quot;f7be9981-1e57-4165-989e-3c7206331a20&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]     &quot;min_mon_release&quot;: 14, </span><br><span class="line">[ceph_node3][DEBUG ]     &quot;min_mon_release_name&quot;: &quot;nautilus&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]     &quot;modified&quot;: &quot;2022-02-18 13:54:10.100119&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]     &quot;mons&quot;: [</span><br><span class="line">[ceph_node3][DEBUG ]       &#123;</span><br><span class="line">[ceph_node3][DEBUG ]         &quot;addr&quot;: &quot;192.168.111.11:6789/0&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]         &quot;name&quot;: &quot;ceph_node1&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]         &quot;public_addr&quot;: &quot;192.168.111.11:6789/0&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]         &quot;public_addrs&quot;: &#123;</span><br><span class="line">[ceph_node3][DEBUG ]           &quot;addrvec&quot;: [</span><br><span class="line">[ceph_node3][DEBUG ]             &#123;</span><br><span class="line">[ceph_node3][DEBUG ]               &quot;addr&quot;: &quot;192.168.111.11:3300&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]               &quot;nonce&quot;: 0, </span><br><span class="line">[ceph_node3][DEBUG ]               &quot;type&quot;: &quot;v2&quot;</span><br><span class="line">[ceph_node3][DEBUG ]             &#125;, </span><br><span class="line">[ceph_node3][DEBUG ]             &#123;</span><br><span class="line">[ceph_node3][DEBUG ]               &quot;addr&quot;: &quot;192.168.111.11:6789&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]               &quot;nonce&quot;: 0, </span><br><span class="line">[ceph_node3][DEBUG ]               &quot;type&quot;: &quot;v1&quot;</span><br><span class="line">[ceph_node3][DEBUG ]             &#125;</span><br><span class="line">[ceph_node3][DEBUG ]           ]</span><br><span class="line">[ceph_node3][DEBUG ]         &#125;, </span><br><span class="line">[ceph_node3][DEBUG ]         &quot;rank&quot;: 0</span><br><span class="line">[ceph_node3][DEBUG ]       &#125;, </span><br><span class="line">[ceph_node3][DEBUG ]       &#123;</span><br><span class="line">[ceph_node3][DEBUG ]         &quot;addr&quot;: &quot;192.168.111.12:6789/0&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]         &quot;name&quot;: &quot;ceph_node2&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]         &quot;public_addr&quot;: &quot;192.168.111.12:6789/0&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]         &quot;public_addrs&quot;: &#123;</span><br><span class="line">[ceph_node3][DEBUG ]           &quot;addrvec&quot;: [</span><br><span class="line">[ceph_node3][DEBUG ]             &#123;</span><br><span class="line">[ceph_node3][DEBUG ]               &quot;addr&quot;: &quot;192.168.111.12:3300&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]               &quot;nonce&quot;: 0, </span><br><span class="line">[ceph_node3][DEBUG ]               &quot;type&quot;: &quot;v2&quot;</span><br><span class="line">[ceph_node3][DEBUG ]             &#125;, </span><br><span class="line">[ceph_node3][DEBUG ]             &#123;</span><br><span class="line">[ceph_node3][DEBUG ]               &quot;addr&quot;: &quot;192.168.111.12:6789&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]               &quot;nonce&quot;: 0, </span><br><span class="line">[ceph_node3][DEBUG ]               &quot;type&quot;: &quot;v1&quot;</span><br><span class="line">[ceph_node3][DEBUG ]             &#125;</span><br><span class="line">[ceph_node3][DEBUG ]           ]</span><br><span class="line">[ceph_node3][DEBUG ]         &#125;, </span><br><span class="line">[ceph_node3][DEBUG ]         &quot;rank&quot;: 1</span><br><span class="line">[ceph_node3][DEBUG ]       &#125;, </span><br><span class="line">[ceph_node3][DEBUG ]       &#123;</span><br><span class="line">[ceph_node3][DEBUG ]         &quot;addr&quot;: &quot;192.168.111.13:6789/0&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]         &quot;name&quot;: &quot;ceph_node3&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]         &quot;public_addr&quot;: &quot;192.168.111.13:6789/0&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]         &quot;public_addrs&quot;: &#123;</span><br><span class="line">[ceph_node3][DEBUG ]           &quot;addrvec&quot;: [</span><br><span class="line">[ceph_node3][DEBUG ]             &#123;</span><br><span class="line">[ceph_node3][DEBUG ]               &quot;addr&quot;: &quot;192.168.111.13:3300&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]               &quot;nonce&quot;: 0, </span><br><span class="line">[ceph_node3][DEBUG ]               &quot;type&quot;: &quot;v2&quot;</span><br><span class="line">[ceph_node3][DEBUG ]             &#125;, </span><br><span class="line">[ceph_node3][DEBUG ]             &#123;</span><br><span class="line">[ceph_node3][DEBUG ]               &quot;addr&quot;: &quot;192.168.111.13:6789&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]               &quot;nonce&quot;: 0, </span><br><span class="line">[ceph_node3][DEBUG ]               &quot;type&quot;: &quot;v1&quot;</span><br><span class="line">[ceph_node3][DEBUG ]             &#125;</span><br><span class="line">[ceph_node3][DEBUG ]           ]</span><br><span class="line">[ceph_node3][DEBUG ]         &#125;, </span><br><span class="line">[ceph_node3][DEBUG ]         &quot;rank&quot;: 2</span><br><span class="line">[ceph_node3][DEBUG ]       &#125;</span><br><span class="line">[ceph_node3][DEBUG ]     ]</span><br><span class="line">[ceph_node3][DEBUG ]   &#125;, </span><br><span class="line">[ceph_node3][DEBUG ]   &quot;name&quot;: &quot;ceph_node3&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]   &quot;outside_quorum&quot;: [], </span><br><span class="line">[ceph_node3][DEBUG ]   &quot;quorum&quot;: [</span><br><span class="line">[ceph_node3][DEBUG ]     0, </span><br><span class="line">[ceph_node3][DEBUG ]     1, </span><br><span class="line">[ceph_node3][DEBUG ]     2</span><br><span class="line">[ceph_node3][DEBUG ]   ], </span><br><span class="line">[ceph_node3][DEBUG ]   &quot;quorum_age&quot;: 41, </span><br><span class="line">[ceph_node3][DEBUG ]   &quot;rank&quot;: 2, </span><br><span class="line">[ceph_node3][DEBUG ]   &quot;state&quot;: &quot;peon&quot;, </span><br><span class="line">[ceph_node3][DEBUG ]   &quot;sync_provider&quot;: []</span><br><span class="line">[ceph_node3][DEBUG ] &#125;</span><br><span class="line">[ceph_node3][DEBUG ] ********************************************************************************</span><br><span class="line">[ceph_node3][INFO  ] monitor: mon.ceph_node3 is running</span><br><span class="line">[ceph_node3][INFO  ] Running command: ceph --cluster=ceph --admin-daemon /var/run/ceph/ceph-mon.ceph_node3.asok mon_status</span><br><span class="line">[ceph_deploy.mon][INFO  ] processing monitor mon.ceph_node1</span><br><span class="line">[ceph_node1][DEBUG ] connected to host: ceph_node1 </span><br><span class="line">[ceph_node1][DEBUG ] detect platform information from remote host</span><br><span class="line">[ceph_node1][DEBUG ] detect machine type</span><br><span class="line">[ceph_node1][DEBUG ] find the location of an executable</span><br><span class="line">[ceph_node1][INFO  ] Running command: ceph --cluster=ceph --admin-daemon /var/run/ceph/ceph-mon.ceph_node1.asok mon_status</span><br><span class="line">[ceph_deploy.mon][INFO  ] mon.ceph_node1 monitor has reached quorum!</span><br><span class="line">[ceph_deploy.mon][INFO  ] processing monitor mon.ceph_node2</span><br><span class="line">[ceph_node2][DEBUG ] connected to host: ceph_node2 </span><br><span class="line">[ceph_node2][DEBUG ] detect platform information from remote host</span><br><span class="line">[ceph_node2][DEBUG ] detect machine type</span><br><span class="line">[ceph_node2][DEBUG ] find the location of an executable</span><br><span class="line">[ceph_node2][INFO  ] Running command: ceph --cluster=ceph --admin-daemon /var/run/ceph/ceph-mon.ceph_node2.asok mon_status</span><br><span class="line">[ceph_deploy.mon][INFO  ] mon.ceph_node2 monitor has reached quorum!</span><br><span class="line">[ceph_deploy.mon][INFO  ] processing monitor mon.ceph_node3</span><br><span class="line">[ceph_node3][DEBUG ] connected to host: ceph_node3 </span><br><span class="line">[ceph_node3][DEBUG ] detect platform information from remote host</span><br><span class="line">[ceph_node3][DEBUG ] detect machine type</span><br><span class="line">[ceph_node3][DEBUG ] find the location of an executable</span><br><span class="line">[ceph_node3][INFO  ] Running command: ceph --cluster=ceph --admin-daemon /var/run/ceph/ceph-mon.ceph_node3.asok mon_status</span><br><span class="line">[ceph_deploy.mon][INFO  ] mon.ceph_node3 monitor has reached quorum!</span><br><span class="line">[ceph_deploy.mon][INFO  ] all initial monitors are running and have formed quorum</span><br><span class="line">[ceph_deploy.mon][INFO  ] Running gatherkeys...</span><br><span class="line">[ceph_deploy.gatherkeys][INFO  ] Storing keys in temp directory /tmp/tmpRev3cc</span><br><span class="line">[ceph_node1][DEBUG ] connected to host: ceph_node1 </span><br><span class="line">[ceph_node1][DEBUG ] detect platform information from remote host</span><br><span class="line">[ceph_node1][DEBUG ] detect machine type</span><br><span class="line">[ceph_node1][DEBUG ] get remote short hostname</span><br><span class="line">[ceph_node1][DEBUG ] fetch remote file</span><br><span class="line">[ceph_node1][INFO  ] Running command: /usr/bin/ceph --connect-timeout=25 --cluster=ceph --admin-daemon=/var/run/ceph/ceph-mon.ceph_node1.asok mon_status</span><br><span class="line">[ceph_node1][INFO  ] Running command: /usr/bin/ceph --connect-timeout=25 --cluster=ceph --name mon. --keyring=/var/lib/ceph/mon/ceph-ceph_node1/keyring auth get client.admin</span><br><span class="line">[ceph_node1][INFO  ] Running command: /usr/bin/ceph --connect-timeout=25 --cluster=ceph --name mon. --keyring=/var/lib/ceph/mon/ceph-ceph_node1/keyring auth get client.bootstrap-mds</span><br><span class="line">[ceph_node1][INFO  ] Running command: /usr/bin/ceph --connect-timeout=25 --cluster=ceph --name mon. --keyring=/var/lib/ceph/mon/ceph-ceph_node1/keyring auth get client.bootstrap-mgr</span><br><span class="line">[ceph_node1][INFO  ] Running command: /usr/bin/ceph --connect-timeout=25 --cluster=ceph --name mon. --keyring=/var/lib/ceph/mon/ceph-ceph_node1/keyring auth get client.bootstrap-osd</span><br><span class="line">[ceph_node1][INFO  ] Running command: /usr/bin/ceph --connect-timeout=25 --cluster=ceph --name mon. --keyring=/var/lib/ceph/mon/ceph-ceph_node1/keyring auth get client.bootstrap-rgw</span><br><span class="line">[ceph_deploy.gatherkeys][INFO  ] Storing ceph.client.admin.keyring</span><br><span class="line">[ceph_deploy.gatherkeys][INFO  ] Storing ceph.bootstrap-mds.keyring</span><br><span class="line">[ceph_deploy.gatherkeys][INFO  ] Storing ceph.bootstrap-mgr.keyring</span><br><span class="line">[ceph_deploy.gatherkeys][INFO  ] keyring &#x27;ceph.mon.keyring&#x27; already exists</span><br><span class="line">[ceph_deploy.gatherkeys][INFO  ] Storing ceph.bootstrap-osd.keyring</span><br><span class="line">[ceph_deploy.gatherkeys][INFO  ] Storing ceph.bootstrap-rgw.keyring</span><br><span class="line">[ceph_deploy.gatherkeys][INFO  ] Destroy temp directory /tmp/tmpRev3cc</span><br></pre></td></tr></table></figure>

<h2 id="生成ceph-admin秘钥"><a href="#生成ceph-admin秘钥" class="headerlink" title="生成ceph admin秘钥"></a>生成ceph admin秘钥</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@ceph_node1 cluster]# ceph-deploy admin ceph_node1 ceph_node2 ceph_node3 </span><br><span class="line"></span><br><span class="line">[ceph_deploy.conf][DEBUG ] found configuration file at: /root/.cephdeploy.conf</span><br><span class="line">[ceph_deploy.cli][INFO  ] Invoked (2.0.1): /usr/bin/ceph-deploy admin ceph_node1 ceph_node2 ceph_node3</span><br><span class="line">[ceph_deploy.cli][INFO  ] ceph-deploy options:</span><br><span class="line">[ceph_deploy.cli][INFO  ]  username                      : None</span><br><span class="line">[ceph_deploy.cli][INFO  ]  verbose                       : False</span><br><span class="line">[ceph_deploy.cli][INFO  ]  overwrite_conf                : False</span><br><span class="line">[ceph_deploy.cli][INFO  ]  quiet                         : False</span><br><span class="line">[ceph_deploy.cli][INFO  ]  cd_conf                       : &lt;ceph_deploy.conf.cephdeploy.Conf instance at 0x7f8101aeb368&gt;</span><br><span class="line">[ceph_deploy.cli][INFO  ]  cluster                       : ceph</span><br><span class="line">[ceph_deploy.cli][INFO  ]  client                        : [&#x27;ceph_node1&#x27;, &#x27;ceph_node2&#x27;, &#x27;ceph_node3&#x27;]</span><br><span class="line">[ceph_deploy.cli][INFO  ]  func                          : &lt;function admin at 0x7f81025fc230&gt;</span><br><span class="line">[ceph_deploy.cli][INFO  ]  ceph_conf                     : None</span><br><span class="line">[ceph_deploy.cli][INFO  ]  default_release               : False</span><br><span class="line">[ceph_deploy.admin][DEBUG ] Pushing admin keys and conf to ceph_node1</span><br><span class="line">[ceph_node1][DEBUG ] connected to host: ceph_node1 </span><br><span class="line">[ceph_node1][DEBUG ] detect platform information from remote host</span><br><span class="line">[ceph_node1][DEBUG ] detect machine type</span><br><span class="line">[ceph_node1][DEBUG ] write cluster configuration to /etc/ceph/&#123;cluster&#125;.conf</span><br><span class="line">[ceph_deploy.admin][DEBUG ] Pushing admin keys and conf to ceph_node2</span><br><span class="line">[ceph_node2][DEBUG ] connected to host: ceph_node2 </span><br><span class="line">[ceph_node2][DEBUG ] detect platform information from remote host</span><br><span class="line">[ceph_node2][DEBUG ] detect machine type</span><br><span class="line">[ceph_node2][DEBUG ] write cluster configuration to /etc/ceph/&#123;cluster&#125;.conf</span><br><span class="line">[ceph_deploy.admin][DEBUG ] Pushing admin keys and conf to ceph_node3</span><br><span class="line">[ceph_node3][DEBUG ] connected to host: ceph_node3 </span><br><span class="line">[ceph_node3][DEBUG ] detect platform information from remote host</span><br><span class="line">[ceph_node3][DEBUG ] detect machine type</span><br><span class="line">[ceph_node3][DEBUG ] write cluster configuration to /etc/ceph/&#123;cluster&#125;.conf</span><br></pre></td></tr></table></figure>

<h2 id="部署MGR，提供web界面管理ceph（可选安装）"><a href="#部署MGR，提供web界面管理ceph（可选安装）" class="headerlink" title="部署MGR，提供web界面管理ceph（可选安装）"></a>部署MGR，提供web界面管理ceph（可选安装）</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@ceph_node1 cluster]# ceph-deploy mgr create ceph_node1 ceph_node2 ceph_node3 </span><br><span class="line"></span><br><span class="line">[ceph_deploy.conf][DEBUG ] found configuration file at: /root/.cephdeploy.conf</span><br><span class="line">[ceph_deploy.cli][INFO  ] Invoked (2.0.1): /usr/bin/ceph-deploy mgr create ceph_node1 ceph_node2 ceph_node3</span><br><span class="line">[ceph_deploy.cli][INFO  ] ceph-deploy options:</span><br><span class="line">[ceph_deploy.cli][INFO  ]  username                      : None</span><br><span class="line">[ceph_deploy.cli][INFO  ]  verbose                       : False</span><br><span class="line">[ceph_deploy.cli][INFO  ]  mgr                           : [(&#x27;ceph_node1&#x27;, &#x27;ceph_node1&#x27;), (&#x27;ceph_node2&#x27;, &#x27;ceph_node2&#x27;), (&#x27;ceph_node3&#x27;, &#x27;ceph_node3&#x27;)]</span><br><span class="line">[ceph_deploy.cli][INFO  ]  overwrite_conf                : False</span><br><span class="line">[ceph_deploy.cli][INFO  ]  subcommand                    : create</span><br><span class="line">[ceph_deploy.cli][INFO  ]  quiet                         : False</span><br><span class="line">[ceph_deploy.cli][INFO  ]  cd_conf                       : &lt;ceph_deploy.conf.cephdeploy.Conf instance at 0x7fb3ff746710&gt;</span><br><span class="line">[ceph_deploy.cli][INFO  ]  cluster                       : ceph</span><br><span class="line">[ceph_deploy.cli][INFO  ]  func                          : &lt;function mgr at 0x7fb3fffac140&gt;</span><br><span class="line">[ceph_deploy.cli][INFO  ]  ceph_conf                     : None</span><br><span class="line">[ceph_deploy.cli][INFO  ]  default_release               : False</span><br><span class="line">[ceph_deploy.mgr][DEBUG ] Deploying mgr, cluster ceph hosts ceph_node1:ceph_node1 ceph_node2:ceph_node2 ceph_node3:ceph_node3</span><br><span class="line">[ceph_node1][DEBUG ] connected to host: ceph_node1 </span><br><span class="line">[ceph_node1][DEBUG ] detect platform information from remote host</span><br><span class="line">[ceph_node1][DEBUG ] detect machine type</span><br><span class="line">[ceph_deploy.mgr][INFO  ] Distro info: CentOS Linux 7.9.2009 Core</span><br><span class="line">[ceph_deploy.mgr][DEBUG ] remote host will use systemd</span><br><span class="line">[ceph_deploy.mgr][DEBUG ] deploying mgr bootstrap to ceph_node1</span><br><span class="line">[ceph_node1][DEBUG ] write cluster configuration to /etc/ceph/&#123;cluster&#125;.conf</span><br><span class="line">[ceph_node1][WARNIN] mgr keyring does not exist yet, creating one</span><br><span class="line">[ceph_node1][DEBUG ] create a keyring file</span><br><span class="line">[ceph_node1][DEBUG ] create path recursively if it doesn&#x27;t exist</span><br><span class="line">[ceph_node1][INFO  ] Running command: ceph --cluster ceph --name client.bootstrap-mgr --keyring /var/lib/ceph/bootstrap-mgr/ceph.keyring auth get-or-create mgr.ceph_node1 mon allow profile mgr osd allow * mds allow * -o /var/lib/ceph/mgr/ceph-ceph_node1/keyring</span><br><span class="line">[ceph_node1][INFO  ] Running command: systemctl enable ceph-mgr@ceph_node1</span><br><span class="line">[ceph_node1][WARNIN] Created symlink from /etc/systemd/system/ceph-mgr.target.wants/ceph-mgr@ceph_node1.service to /usr/lib/systemd/system/ceph-mgr@.service.</span><br><span class="line">[ceph_node1][INFO  ] Running command: systemctl start ceph-mgr@ceph_node1</span><br><span class="line">[ceph_node1][INFO  ] Running command: systemctl enable ceph.target</span><br><span class="line">[ceph_node2][DEBUG ] connected to host: ceph_node2 </span><br><span class="line">[ceph_node2][DEBUG ] detect platform information from remote host</span><br><span class="line">[ceph_node2][DEBUG ] detect machine type</span><br><span class="line">[ceph_deploy.mgr][INFO  ] Distro info: CentOS Linux 7.9.2009 Core</span><br><span class="line">[ceph_deploy.mgr][DEBUG ] remote host will use systemd</span><br><span class="line">[ceph_deploy.mgr][DEBUG ] deploying mgr bootstrap to ceph_node2</span><br><span class="line">[ceph_node2][DEBUG ] write cluster configuration to /etc/ceph/&#123;cluster&#125;.conf</span><br><span class="line">[ceph_node2][WARNIN] mgr keyring does not exist yet, creating one</span><br><span class="line">[ceph_node2][DEBUG ] create a keyring file</span><br><span class="line">[ceph_node2][DEBUG ] create path recursively if it doesn&#x27;t exist</span><br><span class="line">[ceph_node2][INFO  ] Running command: ceph --cluster ceph --name client.bootstrap-mgr --keyring /var/lib/ceph/bootstrap-mgr/ceph.keyring auth get-or-create mgr.ceph_node2 mon allow profile mgr osd allow * mds allow * -o /var/lib/ceph/mgr/ceph-ceph_node2/keyring</span><br><span class="line">[ceph_node2][INFO  ] Running command: systemctl enable ceph-mgr@ceph_node2</span><br><span class="line">[ceph_node2][WARNIN] Created symlink from /etc/systemd/system/ceph-mgr.target.wants/ceph-mgr@ceph_node2.service to /usr/lib/systemd/system/ceph-mgr@.service.</span><br><span class="line">[ceph_node2][INFO  ] Running command: systemctl start ceph-mgr@ceph_node2</span><br><span class="line">[ceph_node2][INFO  ] Running command: systemctl enable ceph.target</span><br><span class="line">[ceph_node3][DEBUG ] connected to host: ceph_node3 </span><br><span class="line">[ceph_node3][DEBUG ] detect platform information from remote host</span><br><span class="line">[ceph_node3][DEBUG ] detect machine type</span><br><span class="line">[ceph_deploy.mgr][INFO  ] Distro info: CentOS Linux 7.9.2009 Core</span><br><span class="line">[ceph_deploy.mgr][DEBUG ] remote host will use systemd</span><br><span class="line">[ceph_deploy.mgr][DEBUG ] deploying mgr bootstrap to ceph_node3</span><br><span class="line">[ceph_node3][DEBUG ] write cluster configuration to /etc/ceph/&#123;cluster&#125;.conf</span><br><span class="line">[ceph_node3][WARNIN] mgr keyring does not exist yet, creating one</span><br><span class="line">[ceph_node3][DEBUG ] create a keyring file</span><br><span class="line">[ceph_node3][DEBUG ] create path recursively if it doesn&#x27;t exist</span><br><span class="line">[ceph_node3][INFO  ] Running command: ceph --cluster ceph --name client.bootstrap-mgr --keyring /var/lib/ceph/bootstrap-mgr/ceph.keyring auth get-or-create mgr.ceph_node3 mon allow profile mgr osd allow * mds allow * -o /var/lib/ceph/mgr/ceph-ceph_node3/keyring</span><br><span class="line">[ceph_node3][INFO  ] Running command: systemctl enable ceph-mgr@ceph_node3</span><br><span class="line">[ceph_node3][WARNIN] Created symlink from /etc/systemd/system/ceph-mgr.target.wants/ceph-mgr@ceph_node3.service to /usr/lib/systemd/system/ceph-mgr@.service.</span><br><span class="line">[ceph_node3][INFO  ] Running command: systemctl start ceph-mgr@ceph_node3</span><br><span class="line">[ceph_node3][INFO  ] Running command: systemctl enable ceph.target</span><br></pre></td></tr></table></figure>

<h2 id="部署rgw"><a href="#部署rgw" class="headerlink" title="部署rgw"></a>部署rgw</h2><p><code>yum -y install ceph-radosgw</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@ceph_node1 cluster]# ceph-deploy rgw create ceph_node1</span><br><span class="line"></span><br><span class="line">[ceph_deploy.conf][DEBUG ] found configuration file at: /root/.cephdeploy.conf</span><br><span class="line">[ceph_deploy.cli][INFO  ] Invoked (2.0.1): /usr/bin/ceph-deploy rgw create ceph_node1</span><br><span class="line">[ceph_deploy.cli][INFO  ] ceph-deploy options:</span><br><span class="line">[ceph_deploy.cli][INFO  ]  username                      : None</span><br><span class="line">[ceph_deploy.cli][INFO  ]  verbose                       : False</span><br><span class="line">[ceph_deploy.cli][INFO  ]  rgw                           : [(&#x27;ceph_node1&#x27;, &#x27;rgw.ceph_node1&#x27;)]</span><br><span class="line">[ceph_deploy.cli][INFO  ]  overwrite_conf                : False</span><br><span class="line">[ceph_deploy.cli][INFO  ]  subcommand                    : create</span><br><span class="line">[ceph_deploy.cli][INFO  ]  quiet                         : False</span><br><span class="line">[ceph_deploy.cli][INFO  ]  cd_conf                       : &lt;ceph_deploy.conf.cephdeploy.Conf instance at 0x7f4fe2168b00&gt;</span><br><span class="line">[ceph_deploy.cli][INFO  ]  cluster                       : ceph</span><br><span class="line">[ceph_deploy.cli][INFO  ]  func                          : &lt;function rgw at 0x7f4fe2c35050&gt;</span><br><span class="line">[ceph_deploy.cli][INFO  ]  ceph_conf                     : None</span><br><span class="line">[ceph_deploy.cli][INFO  ]  default_release               : False</span><br><span class="line">[ceph_deploy.rgw][DEBUG ] Deploying rgw, cluster ceph hosts ceph_node1:rgw.ceph_node1</span><br><span class="line">[ceph_node1][DEBUG ] connected to host: ceph_node1 </span><br><span class="line">[ceph_node1][DEBUG ] detect platform information from remote host</span><br><span class="line">[ceph_node1][DEBUG ] detect machine type</span><br><span class="line">[ceph_deploy.rgw][INFO  ] Distro info: CentOS Linux 7.9.2009 Core</span><br><span class="line">[ceph_deploy.rgw][DEBUG ] remote host will use systemd</span><br><span class="line">[ceph_deploy.rgw][DEBUG ] deploying rgw bootstrap to ceph_node1</span><br><span class="line">[ceph_node1][DEBUG ] write cluster configuration to /etc/ceph/&#123;cluster&#125;.conf</span><br><span class="line">[ceph_node1][WARNIN] rgw keyring does not exist yet, creating one</span><br><span class="line">[ceph_node1][DEBUG ] create a keyring file</span><br><span class="line">[ceph_node1][DEBUG ] create path recursively if it doesn&#x27;t exist</span><br><span class="line">[ceph_node1][INFO  ] Running command: ceph --cluster ceph --name client.bootstrap-rgw --keyring /var/lib/ceph/bootstrap-rgw/ceph.keyring auth get-or-create client.rgw.ceph_node1 osd allow rwx mon allow rw -o /var/lib/ceph/radosgw/ceph-rgw.ceph_node1/keyring</span><br><span class="line">[ceph_node1][INFO  ] Running command: systemctl enable ceph-radosgw@rgw.ceph_node1</span><br><span class="line">[ceph_node1][WARNIN] Created symlink from /etc/systemd/system/ceph-radosgw.target.wants/ceph-radosgw@rgw.ceph_node1.service to /usr/lib/systemd/system/ceph-radosgw@.service.</span><br><span class="line">[ceph_node1][INFO  ] Running command: systemctl start ceph-radosgw@rgw.ceph_node1</span><br><span class="line">[ceph_node1][INFO  ] Running command: systemctl enable ceph.target</span><br><span class="line">[ceph_deploy.rgw][INFO  ] The Ceph Object Gateway (RGW) is now running on host ceph_node1 and default port 7480</span><br></pre></td></tr></table></figure>

<h2 id="部署cephfs（可选）"><a href="#部署cephfs（可选）" class="headerlink" title="部署cephfs（可选）"></a>部署cephfs（可选）</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@ceph_node1 cluster]# ceph-deploy mds create ceph_node1 ceph_node2 ceph_node3</span><br><span class="line"></span><br><span class="line">[ceph_deploy.conf][DEBUG ] found configuration file at: /root/.cephdeploy.conf</span><br><span class="line">[ceph_deploy.cli][INFO  ] Invoked (2.0.1): /usr/bin/ceph-deploy mds create ceph_node1 ceph_node2 ceph_node3</span><br><span class="line">[ceph_deploy.cli][INFO  ] ceph-deploy options:</span><br><span class="line">[ceph_deploy.cli][INFO  ]  username                      : None</span><br><span class="line">[ceph_deploy.cli][INFO  ]  verbose                       : False</span><br><span class="line">[ceph_deploy.cli][INFO  ]  overwrite_conf                : False</span><br><span class="line">[ceph_deploy.cli][INFO  ]  subcommand                    : create</span><br><span class="line">[ceph_deploy.cli][INFO  ]  quiet                         : False</span><br><span class="line">[ceph_deploy.cli][INFO  ]  cd_conf                       : &lt;ceph_deploy.conf.cephdeploy.Conf instance at 0x7fb889afe2d8&gt;</span><br><span class="line">[ceph_deploy.cli][INFO  ]  cluster                       : ceph</span><br><span class="line">[ceph_deploy.cli][INFO  ]  func                          : &lt;function mds at 0x7fb889b3ced8&gt;</span><br><span class="line">[ceph_deploy.cli][INFO  ]  ceph_conf                     : None</span><br><span class="line">[ceph_deploy.cli][INFO  ]  mds                           : [(&#x27;ceph_node1&#x27;, &#x27;ceph_node1&#x27;), (&#x27;ceph_node2&#x27;, &#x27;ceph_node2&#x27;), (&#x27;ceph_node3&#x27;, &#x27;ceph_node3&#x27;)]</span><br><span class="line">[ceph_deploy.cli][INFO  ]  default_release               : False</span><br><span class="line">[ceph_deploy.mds][DEBUG ] Deploying mds, cluster ceph hosts ceph_node1:ceph_node1 ceph_node2:ceph_node2 ceph_node3:ceph_node3</span><br><span class="line">[ceph_node1][DEBUG ] connected to host: ceph_node1 </span><br><span class="line">[ceph_node1][DEBUG ] detect platform information from remote host</span><br><span class="line">[ceph_node1][DEBUG ] detect machine type</span><br><span class="line">[ceph_deploy.mds][INFO  ] Distro info: CentOS Linux 7.9.2009 Core</span><br><span class="line">[ceph_deploy.mds][DEBUG ] remote host will use systemd</span><br><span class="line">[ceph_deploy.mds][DEBUG ] deploying mds bootstrap to ceph_node1</span><br><span class="line">[ceph_node1][DEBUG ] write cluster configuration to /etc/ceph/&#123;cluster&#125;.conf</span><br><span class="line">[ceph_node1][WARNIN] mds keyring does not exist yet, creating one</span><br><span class="line">[ceph_node1][DEBUG ] create a keyring file</span><br><span class="line">[ceph_node1][DEBUG ] create path if it doesn&#x27;t exist</span><br><span class="line">[ceph_node1][INFO  ] Running command: ceph --cluster ceph --name client.bootstrap-mds --keyring /var/lib/ceph/bootstrap-mds/ceph.keyring auth get-or-create mds.ceph_node1 osd allow rwx mds allow mon allow profile mds -o /var/lib/ceph/mds/ceph-ceph_node1/keyring</span><br><span class="line">[ceph_node1][INFO  ] Running command: systemctl enable ceph-mds@ceph_node1</span><br><span class="line">[ceph_node1][WARNIN] Created symlink from /etc/systemd/system/ceph-mds.target.wants/ceph-mds@ceph_node1.service to /usr/lib/systemd/system/ceph-mds@.service.</span><br><span class="line">[ceph_node1][INFO  ] Running command: systemctl start ceph-mds@ceph_node1</span><br><span class="line">[ceph_node1][INFO  ] Running command: systemctl enable ceph.target</span><br><span class="line">[ceph_node2][DEBUG ] connected to host: ceph_node2 </span><br><span class="line">[ceph_node2][DEBUG ] detect platform information from remote host</span><br><span class="line">[ceph_node2][DEBUG ] detect machine type</span><br><span class="line">[ceph_deploy.mds][INFO  ] Distro info: CentOS Linux 7.9.2009 Core</span><br><span class="line">[ceph_deploy.mds][DEBUG ] remote host will use systemd</span><br><span class="line">[ceph_deploy.mds][DEBUG ] deploying mds bootstrap to ceph_node2</span><br><span class="line">[ceph_node2][DEBUG ] write cluster configuration to /etc/ceph/&#123;cluster&#125;.conf</span><br><span class="line">[ceph_node2][WARNIN] mds keyring does not exist yet, creating one</span><br><span class="line">[ceph_node2][DEBUG ] create a keyring file</span><br><span class="line">[ceph_node2][DEBUG ] create path if it doesn&#x27;t exist</span><br><span class="line">[ceph_node2][INFO  ] Running command: ceph --cluster ceph --name client.bootstrap-mds --keyring /var/lib/ceph/bootstrap-mds/ceph.keyring auth get-or-create mds.ceph_node2 osd allow rwx mds allow mon allow profile mds -o /var/lib/ceph/mds/ceph-ceph_node2/keyring</span><br><span class="line">[ceph_node2][INFO  ] Running command: systemctl enable ceph-mds@ceph_node2</span><br><span class="line">[ceph_node2][WARNIN] Created symlink from /etc/systemd/system/ceph-mds.target.wants/ceph-mds@ceph_node2.service to /usr/lib/systemd/system/ceph-mds@.service.</span><br><span class="line">[ceph_node2][INFO  ] Running command: systemctl start ceph-mds@ceph_node2</span><br><span class="line">[ceph_node2][INFO  ] Running command: systemctl enable ceph.target</span><br><span class="line">[ceph_node3][DEBUG ] connected to host: ceph_node3 </span><br><span class="line">[ceph_node3][DEBUG ] detect platform information from remote host</span><br><span class="line">[ceph_node3][DEBUG ] detect machine type</span><br><span class="line">[ceph_deploy.mds][INFO  ] Distro info: CentOS Linux 7.9.2009 Core</span><br><span class="line">[ceph_deploy.mds][DEBUG ] remote host will use systemd</span><br><span class="line">[ceph_deploy.mds][DEBUG ] deploying mds bootstrap to ceph_node3</span><br><span class="line">[ceph_node3][DEBUG ] write cluster configuration to /etc/ceph/&#123;cluster&#125;.conf</span><br><span class="line">[ceph_node3][WARNIN] mds keyring does not exist yet, creating one</span><br><span class="line">[ceph_node3][DEBUG ] create a keyring file</span><br><span class="line">[ceph_node3][DEBUG ] create path if it doesn&#x27;t exist</span><br><span class="line">[ceph_node3][INFO  ] Running command: ceph --cluster ceph --name client.bootstrap-mds --keyring /var/lib/ceph/bootstrap-mds/ceph.keyring auth get-or-create mds.ceph_node3 osd allow rwx mds allow mon allow profile mds -o /var/lib/ceph/mds/ceph-ceph_node3/keyring</span><br><span class="line">[ceph_node3][INFO  ] Running command: systemctl enable ceph-mds@ceph_node3</span><br><span class="line">[ceph_node3][WARNIN] Created symlink from /etc/systemd/system/ceph-mds.target.wants/ceph-mds@ceph_node3.service to /usr/lib/systemd/system/ceph-mds@.service.</span><br><span class="line">[ceph_node3][INFO  ] Running command: systemctl start ceph-mds@ceph_node3</span><br><span class="line">[ceph_node3][INFO  ] Running command: systemctl enable ceph.target</span><br></pre></td></tr></table></figure>

<h2 id="初始化OSD"><a href="#初始化OSD" class="headerlink" title="初始化OSD"></a>初始化OSD</h2><p>在ceph_node1上一次初始化所有磁盘</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ceph-deploy osd create --data /dev/sdb ceph_node1</span><br><span class="line">ceph-deploy osd create --data /dev/sdc ceph_node1</span><br><span class="line">ceph-deploy osd create --data /dev/sdd ceph_node1</span><br><span class="line">ceph-deploy osd create --data /dev/sdb ceph_node2</span><br><span class="line">ceph-deploy osd create --data /dev/sdc ceph_node2</span><br><span class="line">ceph-deploy osd create --data /dev/sdd ceph_node2</span><br><span class="line">ceph-deploy osd create --data /dev/sdb ceph_node3</span><br><span class="line">ceph-deploy osd create --data /dev/sdc ceph_node3</span><br><span class="line">ceph-deploy osd create --data /dev/sdd ceph_node3</span><br></pre></td></tr></table></figure>

<h2 id="查看OSD状态"><a href="#查看OSD状态" class="headerlink" title="查看OSD状态"></a>查看OSD状态</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@ceph_node1 cluster]# ceph osd status</span><br><span class="line">+----+------------+-------+-------+--------+---------+--------+---------+-----------+</span><br><span class="line">| id |    host    |  used | avail | wr ops | wr data | rd ops | rd data |   state   |</span><br><span class="line">+----+------------+-------+-------+--------+---------+--------+---------+-----------+</span><br><span class="line">| 0  | ceph_node1 | 1031M | 9204M |    0   |     0   |    0   |     0   | exists,up |</span><br><span class="line">| 1  | ceph_node1 | 1031M | 9204M |    0   |     0   |    0   |     0   | exists,up |</span><br><span class="line">| 2  | ceph_node1 | 1031M | 9204M |    0   |     0   |    0   |     0   | exists,up |</span><br><span class="line">| 3  | ceph_node2 | 1031M | 9204M |    0   |     0   |    0   |     0   | exists,up |</span><br><span class="line">| 4  | ceph_node2 | 1031M | 9204M |    0   |     0   |    0   |     0   | exists,up |</span><br><span class="line">| 5  | ceph_node2 | 1031M | 9204M |    0   |     0   |    0   |     0   | exists,up |</span><br><span class="line">| 6  | ceph_node3 | 1031M | 9204M |    0   |     0   |    0   |     0   | exists,up |</span><br><span class="line">| 7  | ceph_node3 | 1031M | 9204M |    0   |     0   |    0   |     0   | exists,up |</span><br><span class="line">| 8  | ceph_node3 | 1031M | 9204M |    0   |     0   |    0   |     0   | exists,up |</span><br><span class="line">+----+------------+-------+-------+--------+---------+--------+---------+-----------+</span><br></pre></td></tr></table></figure>

<h2 id="查看ceph状态"><a href="#查看ceph状态" class="headerlink" title="查看ceph状态"></a>查看ceph状态</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@ceph_node1 cluster]# ceph -s</span><br><span class="line">  cluster:</span><br><span class="line">    id:     f7be9981-1e57-4165-989e-3c7206331a20</span><br><span class="line">    health: HEALTH_OK</span><br><span class="line"> </span><br><span class="line">  services:</span><br><span class="line">    mon: 3 daemons, quorum ceph_node1,ceph_node2,ceph_node3 (age 21m)</span><br><span class="line">    mgr: ceph_node1(active, since 16m), standbys: ceph_node2, ceph_node3</span><br><span class="line">    mds:  3 up:standby</span><br><span class="line">    osd: 9 osds: 9 up (since 4m), 9 in (since 4m)</span><br><span class="line">    rgw: 1 daemon active (ceph_node1)</span><br><span class="line"> </span><br><span class="line">  task status:</span><br><span class="line"> </span><br><span class="line">  data:</span><br><span class="line">    pools:   4 pools, 128 pgs</span><br><span class="line">    objects: 187 objects, 1.2 KiB</span><br><span class="line">    usage:   9.1 GiB used, 81 GiB / 90 GiB avail</span><br><span class="line">    pgs:     128 active+clean</span><br></pre></td></tr></table></figure>

<p>至此，整个ceph的部署就完成了，健康状态也是ok的。</p>
<h1 id="Ceph操作使用"><a href="#Ceph操作使用" class="headerlink" title="Ceph操作使用"></a>Ceph操作使用</h1><h2 id="创建存储池"><a href="#创建存储池" class="headerlink" title="创建存储池"></a>创建存储池</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@ceph_node1 cluster]# ceph osd pool create mypool1 128</span><br><span class="line">pool &#x27;mypool1&#x27; created</span><br><span class="line"></span><br><span class="line">#查看已创建的存储池信息</span><br><span class="line">[root@ceph_node1 cluster]# ceph osd pool ls </span><br><span class="line">.rgw.root</span><br><span class="line">default.rgw.control</span><br><span class="line">default.rgw.meta</span><br><span class="line">default.rgw.log</span><br><span class="line">mypool1</span><br></pre></td></tr></table></figure>

<h2 id="查看存储池详细参数"><a href="#查看存储池详细参数" class="headerlink" title="查看存储池详细参数"></a>查看存储池详细参数</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@ceph_node1 cluster]# ceph osd pool ls detail </span><br><span class="line">pool 1 &#x27;.rgw.root&#x27; replicated size 3 min_size 2 crush_rule 0 object_hash rjenkins pg_num 32 pgp_num 32 autoscale_mode warn last_change 9 flags hashpspool stripe_width 0 application rgw</span><br><span class="line">pool 2 &#x27;default.rgw.control&#x27; replicated size 3 min_size 2 crush_rule 0 object_hash rjenkins pg_num 32 pgp_num 32 autoscale_mode warn last_change 34 flags hashpspool stripe_width 0 application rgw</span><br><span class="line">pool 3 &#x27;default.rgw.meta&#x27; replicated size 3 min_size 2 crush_rule 0 object_hash rjenkins pg_num 32 pgp_num 32 autoscale_mode warn last_change 36 flags hashpspool stripe_width 0 application rgw</span><br><span class="line">pool 4 &#x27;default.rgw.log&#x27; replicated size 3 min_size 2 crush_rule 0 object_hash rjenkins pg_num 32 pgp_num 32 autoscale_mode warn last_change 38 flags hashpspool stripe_width 0 application rgw</span><br><span class="line">pool 5 &#x27;mypool1&#x27; replicated size 3 min_size 2 crush_rule 0 object_hash rjenkins pg_num 128 pgp_num 128 autoscale_mode warn last_change 63 flags hashpspool stripe_width 0</span><br></pre></td></tr></table></figure>

<h2 id="查看存储池单个参数配置"><a href="#查看存储池单个参数配置" class="headerlink" title="查看存储池单个参数配置"></a>查看存储池单个参数配置</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 查看副本数</span><br><span class="line">[root@ceph_node1 cluster]# ceph osd pool get mypool1 size</span><br><span class="line">size: 3</span><br><span class="line"># 查看pg_num</span><br><span class="line">[root@ceph_node1 cluster]# ceph osd pool get mypool1 pg_num</span><br><span class="line">pg_num: 128</span><br></pre></td></tr></table></figure>

<h2 id="修改存储池参数"><a href="#修改存储池参数" class="headerlink" title="修改存储池参数"></a>修改存储池参数</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@ceph_node1 cluster]# ceph osd pool set mypool1 pg_num 64</span><br><span class="line">set pool 5 pg_num to 64</span><br></pre></td></tr></table></figure>

<h2 id="创建EC池，创建EC策略"><a href="#创建EC池，创建EC策略" class="headerlink" title="创建EC池，创建EC策略"></a>创建EC池，创建EC策略</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@ceph_node1 cluster]# ceph osd erasure-code-profile set ec001 k=3 m=2 crush-failure-domain=osd</span><br><span class="line">[root@ceph_node1 cluster]# ceph osd pool create mypool2 100 erasure ec001</span><br><span class="line">pool &#x27;mypool2&#x27; created</span><br><span class="line">[root@ceph_node1 cluster]# ceph osd pool ls detail</span><br><span class="line">pool 1 &#x27;.rgw.root&#x27; replicated size 3 min_size 2 crush_rule 0 object_hash rjenkins pg_num 32 pgp_num 32 autoscale_mode warn last_change 9 flags hashpspool stripe_width 0 application rgw</span><br><span class="line">pool 2 &#x27;default.rgw.control&#x27; replicated size 3 min_size 2 crush_rule 0 object_hash rjenkins pg_num 32 pgp_num 32 autoscale_mode warn last_change 34 flags hashpspool stripe_width 0 application rgw</span><br><span class="line">pool 3 &#x27;default.rgw.meta&#x27; replicated size 3 min_size 2 crush_rule 0 object_hash rjenkins pg_num 32 pgp_num 32 autoscale_mode warn last_change 36 flags hashpspool stripe_width 0 application rgw</span><br><span class="line">pool 4 &#x27;default.rgw.log&#x27; replicated size 3 min_size 2 crush_rule 0 object_hash rjenkins pg_num 32 pgp_num 32 autoscale_mode warn last_change 38 flags hashpspool stripe_width 0 application rgw</span><br><span class="line">pool 5 &#x27;mypool1&#x27; replicated size 3 min_size 2 crush_rule 0 object_hash rjenkins pg_num 64 pgp_num 64 autoscale_mode warn last_change 302 lfor 0/302/300 flags hashpspool stripe_width 0</span><br><span class="line">pool 6 &#x27;mypool2&#x27; erasure size 5 min_size 4 crush_rule 1 object_hash rjenkins pg_num 100 pgp_num 100 autoscale_mode warn last_change 306 flags hashpspool,creating stripe_width 12288</span><br></pre></td></tr></table></figure>

<h2 id="rgw使用"><a href="#rgw使用" class="headerlink" title="rgw使用"></a>rgw使用</h2><p>设置mypool2为rgw，使用rados客户端工具测试上传下载</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@ceph_node1 cluster]# ceph osd pool application enable mypool2 rgw</span><br><span class="line">enabled application &#x27;rgw&#x27; on pool &#x27;mypool2&#x27;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 将/etc/passwd 上到mypool2中，命名为t_pass</span><br><span class="line">[root@ceph_node1 cluster]# rados -p mypool2 put t_pass /etc/passwd</span><br><span class="line"># 查看mypool2 中的文件</span><br><span class="line">[root@ceph_node1 cluster]# rados -p mypool2 ls</span><br><span class="line">t_pass</span><br><span class="line"># 将mypool2中的文件t_pass下载到/tmp/passwd</span><br><span class="line">[root@ceph_node1 cluster]# rados -p mypool2 get t_pass /tmp/passwd</span><br><span class="line"># 查看下载的文件内容</span><br><span class="line">[root@ceph_node1 cluster]# cat /tmp/passwd </span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">bin:x:1:1:bin:/bin:/sbin/nologin</span><br></pre></td></tr></table></figure>

<h2 id="rbd使用"><a href="#rbd使用" class="headerlink" title="rbd使用"></a>rbd使用</h2><p>设置mypool3为rbd，并创建卷，挂载到&#x2F;mnt, 映射给业务服务器使用。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 创建存储池mypool3</span><br><span class="line">[root@ceph_node1 cluster]# ceph osd pool create mypool3 64</span><br><span class="line">pool &#x27;mypool3&#x27; created</span><br><span class="line"># 设置存储池类型为rbd</span><br><span class="line">[root@ceph_node1 cluster]# ceph osd pool application enable mypool3 rbd</span><br><span class="line">enabled application &#x27;rbd&#x27; on pool &#x27;mypool3&#x27;</span><br><span class="line"># 在存储池里划分一块名为disk1的磁盘，大小为1G</span><br><span class="line">[root@ceph_node1 cluster]# rbd create mypool3/disk1 --size 1G</span><br><span class="line"># 将创建的磁盘map成一个块设备</span><br><span class="line">[root@ceph_node1 cluster]# rbd map mypool3/disk1</span><br><span class="line">rbd: sysfs write failed</span><br><span class="line">RBD image feature set mismatch. You can disable features unsupported by the kernel with &quot;rbd feature disable mypool3/disk1 object-map fast-diff deep-flatten&quot;.</span><br><span class="line">In some cases useful info is found in syslog - try &quot;dmesg | tail&quot;.</span><br><span class="line">rbd: map failed: (6) No such device or address</span><br><span class="line">[root@ceph_node1 cluster]# rbd feature disable mypool3/disk1 object-map fast-diff deep-flatten</span><br><span class="line">[root@ceph_node1 cluster]# rbd map mypool3/disk1</span><br><span class="line">/dev/rbd0</span><br><span class="line">[root@ceph_node1 cluster]# ll /dev/rbd</span><br><span class="line">rbd/  rbd0  </span><br><span class="line">[root@ceph_node1 cluster]# ll /dev/rbd0</span><br><span class="line">brw-rw----. 1 root disk 252, 0 Feb 18 14:46 /dev/rbd0</span><br><span class="line"># 格式化块设备</span><br><span class="line">[root@ceph_node1 cluster]# mkfs.ext4 /dev/rbd0</span><br><span class="line">mke2fs 1.42.9 (28-Dec-2013)</span><br><span class="line">Discarding device blocks: done                            </span><br><span class="line">Filesystem label=</span><br><span class="line">OS type: Linux</span><br><span class="line">Block size=4096 (log=2)</span><br><span class="line">Fragment size=4096 (log=2)</span><br><span class="line">Stride=1024 blocks, Stripe width=1024 blocks</span><br><span class="line">65536 inodes, 262144 blocks</span><br><span class="line">13107 blocks (5.00%) reserved for the super user</span><br><span class="line">First data block=0</span><br><span class="line">Maximum filesystem blocks=268435456</span><br><span class="line">8 block groups</span><br><span class="line">32768 blocks per group, 32768 fragments per group</span><br><span class="line">8192 inodes per group</span><br><span class="line">Superblock backups stored on blocks: </span><br><span class="line">	32768, 98304, 163840, 229376</span><br><span class="line"></span><br><span class="line">Allocating group tables: done                            </span><br><span class="line">Writing inode tables: done                            </span><br><span class="line">Creating journal (8192 blocks): done</span><br><span class="line">Writing superblocks and filesystem accounting information: done</span><br><span class="line"></span><br><span class="line"># 挂载使用</span><br><span class="line">[root@ceph_node1 cluster]# mount /dev/rbd0 /mnt</span><br><span class="line">[root@ceph_node1 cluster]# df -h</span><br><span class="line">Filesystem               Size  Used Avail Use% Mounted on</span><br><span class="line">devtmpfs                 979M     0  979M   0% /dev</span><br><span class="line">tmpfs                    991M     0  991M   0% /dev/shm</span><br><span class="line">tmpfs                    991M   18M  973M   2% /run</span><br><span class="line">tmpfs                    991M     0  991M   0% /sys/fs/cgroup</span><br><span class="line">/dev/mapper/centos-root   17G  1.9G   16G  11% /</span><br><span class="line">/dev/sda1               1014M  138M  877M  14% /boot</span><br><span class="line">tmpfs                    199M     0  199M   0% /run/user/0</span><br><span class="line">tmpfs                    991M   52K  991M   1% /var/lib/ceph/osd/ceph-0</span><br><span class="line">tmpfs                    991M   52K  991M   1% /var/lib/ceph/osd/ceph-1</span><br><span class="line">tmpfs                    991M   52K  991M   1% /var/lib/ceph/osd/ceph-2</span><br><span class="line">/dev/rbd0                976M  2.6M  907M   1% /mnt</span><br></pre></td></tr></table></figure>



<h1 id="避坑指南"><a href="#避坑指南" class="headerlink" title="避坑指南"></a>避坑指南</h1><h2 id="Q1"><a href="#Q1" class="headerlink" title="Q1:"></a>Q1:</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">root@ceph_node1 cluster]# ceph-deploy new ceph_node1 ceph_node2 ceph_node3</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;/usr/bin/ceph-deploy&quot;, line 18, in &lt;module&gt;</span><br><span class="line">    from ceph_deploy.cli import main</span><br><span class="line">  File &quot;/usr/lib/python2.7/site-packages/ceph_deploy/cli.py&quot;, line 1, in &lt;module&gt;</span><br><span class="line">    import pkg_resources</span><br><span class="line">ImportError: No module named pkg_resources</span><br></pre></td></tr></table></figure>

<p>解决方法：<code>yum install python2-pip</code></p>
<h2 id="Q2："><a href="#Q2：" class="headerlink" title="Q2："></a>Q2：</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">health: HEALTH_WARN</span><br><span class="line">        mons are allowing insecure global_id reclaim</span><br></pre></td></tr></table></figure>

<p>解决方法：<code>ceph config set mon auth_allow_insecure_global_id_reclaim false</code></p>
<p>参考地址：<a href="https://www.bilibili.com/video/BV15K41137nJ/">https://www.bilibili.com/video/BV15K41137nJ/</a></p>
]]></content>
      <categories>
        <category>服务器搭建</category>
      </categories>
      <tags>
        <tag>Ceph</tag>
      </tags>
  </entry>
  <entry>
    <title>K8S概念及组件说明</title>
    <url>/arlo/2116e146/</url>
    <content><![CDATA[<blockquote>
<p>K8S学习知识图谱：<a href="https://www.processon.com/view/link/637d798d6376897f2b8d9f30">https://www.processon.com/view/link/637d798d6376897f2b8d9f30</a></p>
</blockquote>
<h1 id="K8S是什么？"><a href="#K8S是什么？" class="headerlink" title="K8S是什么？"></a>K8S是什么？</h1><p>Kubernetes是容器集群管理系统，是一个开源的平台，可以实现容器集群的自动化部署、自动扩缩容、维护等功能。Kubernetes是Google 2014年创建管理的，是Google 10多年大规模容器管理技术Borg的开源版本。</p>
<h1 id="K8S特点"><a href="#K8S特点" class="headerlink" title="K8S特点"></a>K8S特点</h1><ul>
<li><strong>可移植</strong>: 支持公有云，私有云，混合云，多重云（multi-cloud）</li>
<li><strong>可扩展</strong>: 模块化, 插件化, 可挂载, 可组合</li>
<li><strong>自动化</strong>: 自动部署，自动重启，自动复制，自动伸缩&#x2F;扩展</li>
</ul>
<span id="more"></span>

<h1 id="K8S组件"><a href="#K8S组件" class="headerlink" title="K8S组件"></a>K8S组件</h1><ul>
<li><strong>APISERVER：</strong>所有服务访问统一入口，并提供认证、授权、访问控制、API注册和发现等机制；</li>
<li><strong>CrontrolerManager:</strong>  负责维护集群的状态，比如故障检测、自动扩展、滚动更新、维持副本期望数目等；</li>
<li><strong>Scheduler：</strong>负责资源的调度，选择合适的节点进行分配任务</li>
<li><strong>ETCD：</strong>键值对数据库 储存K8S集群所有重要信息 (持久化)</li>
<li><strong>Kubelet：</strong>直接跟容器引擎交互实现容器的生命周期管理</li>
<li><strong>Kube-proxy：</strong>负责写入规则至 IPTABLES、IPVS 实现服务映射访问的</li>
<li><strong>COREDNS：</strong>可以为集群中的SVC创建一个域名IP的对应关系解析</li>
<li><strong>DASHBOARD：</strong>给K8S 集群提供一个B&#x2F;S结构访问体系</li>
<li><strong>INGRESS CONTROLLER:</strong> 官方只能实现四层代理，INGRESS 可以实现七层代理</li>
<li><strong>FEDETATION：</strong>提供一个可以跨集群中心多K8S统一管理功能</li>
<li><strong>PROMETHEUS：</strong>提供一个K8S集群的监控能力</li>
<li><strong>EFK：</strong>提供K8S集群日志统一分析接入平台</li>
</ul>
<p><img src="/images/2022/1123/01.png" alt="K8S架构"></p>
<h1 id="POD概念"><a href="#POD概念" class="headerlink" title="POD概念"></a>POD概念</h1><p>Pod是Kubernetes创建或部署的最小&#x2F;最简单的基本单位，一个Pod代表集群上正在运行的一个进程。</p>
<p>一个Pod封装一个应用容器（也可以有多个容器），存储资源、一个独立的网络IP以及管理控制容器运行方式的策略选项。Pod代表部署的一个单位：Kubernetes中单个应用的实例，它可能由单个容器或多个容器共享组成的资源。</p>
<h2 id="控制器类型"><a href="#控制器类型" class="headerlink" title="控制器类型"></a>控制器类型</h2><h3 id="ReplicationController-amp-ReplicaSet-amp-Deployment"><a href="#ReplicationController-amp-ReplicaSet-amp-Deployment" class="headerlink" title="ReplicationController &amp; ReplicaSet &amp; Deployment"></a>ReplicationController &amp; ReplicaSet &amp; Deployment</h3><p><strong>ReplicationController</strong> 用来确保容器应用的副本数始终保持在用户定义的副本数，如果有容器异常退出，会自动创建新的 Pod 来替代；而如果异常多出来的容器也会自动回收。有新版本的 Kubernetes 中建议使用 ReplicaSet 来取代 ReplicationControlle</p>
<p><strong>ReplicaSet</strong> 跟 ReplicationController 没有本质的不同，只是名字不一样，并且 ReplicaSet 支持集合式的 selector</p>
<p>虽然 ReplicaSet 可以独立使用，单一般还是建议使用 Deployment 来自动管理 ReplicaSet， 这样就无需担心跟其他机制的不兼容问题（比如 ReplicaSet 不支持 rolling-update 但 Deployment 支持）</p>
<h3 id="HPA-HorizontalPodAutoscale"><a href="#HPA-HorizontalPodAutoscale" class="headerlink" title="HPA(HorizontalPodAutoscale)"></a>HPA(HorizontalPodAutoscale)</h3><p>Horizontal Pod Autoscaling 仅适用于 Deployment 和 ReplicaSet ，在 V1 版本中仅支持根据 Pod 的 CPU 利用率扩缩容，在 v1alpha 版本中，支持根据内存和用户自定义的 metric 扩缩容</p>
<h3 id="StatefulSet"><a href="#StatefulSet" class="headerlink" title="StatefulSet"></a>StatefulSet</h3><p>StatefulSet 是为了解决有状态服务的问题（对应 Deployment 和 ReplicaSets 是为无状态服务而设计），其应用场景包括：</p>
<ul>
<li>稳定的持久化存储，即 Pod 重新调度后还是能访问到相同的持久化数据，基于 PVC 来实现</li>
<li>稳定的网络标志，即 Pod 重新调度后其 PodName 和 HostName 不变，基于 Headless Service（即没有 Cluster IP 的 Service ）来实现</li>
<li>有序部署，有序扩展，即 Pod是有顺序的，在部署或扩展的时候要依据定义的顺序依次进行（即从 0 到 N-1，在下一个Pod 运行之前所有之前的 Pod 必须都是 Running 和 Ready 状态），基于 init containers 来实现</li>
<li>有序收缩，有序删除（即从 N-1 到 0 ）</li>
</ul>
<h3 id="DaemonSet"><a href="#DaemonSet" class="headerlink" title="DaemonSet"></a>DaemonSet</h3><p>DaemonSet 确保全部（或者一些）Node 上运行一个 Pod 的副本。当有 Node 加入集群时，也会为他们新增一个Pod。当有 Node 从集群移除时，这些 Pod 也会被回收。 删除 DaemonSet 将会删除它创建的所有 Pod</p>
<p>使用 DaemonSet 的一些典型用法：</p>
<ul>
<li>运行集群存储 daemon，例如在每个Node 上运行 glusterd，ceph。</li>
<li>在每个 Node 上运行日志收集 daemon，例如 fluentd，logstash。</li>
<li>在每个 Node 上运行监控 daemon，例如 Prometheus Node Exporter</li>
</ul>
<h3 id="Job，Cronjob"><a href="#Job，Cronjob" class="headerlink" title="Job，Cronjob"></a>Job，Cronjob</h3><p>Job 负责批处理任务，即仅执行一次的任务，它保证批处理任务的一个或多个 Pod 成功结束</p>
<p>Cron Job管理基于时间的 Job，即：</p>
<ul>
<li>在给定的时间点只运行一次</li>
<li>周期性地在给定时间点运行</li>
</ul>
<h2 id="网络通讯"><a href="#网络通讯" class="headerlink" title="网络通讯"></a>网络通讯</h2><p>Kubernetes 的网络模型假定了所有的 Pod 都在一个可以直接连通的扁平的网络空间中，这在GCE （Google Compute Engine） 里面是现成的网络模型，Kubernetes 假定这个网络已经存在。而在私有云里搭建 Kubernetes 集群，就不能假定这个网络已经存在了。我们需要自己实现这个网络架设，将不不同节点上的 Docker 容器之间的互相访问先打通，然后运行 Kubernetes。</p>
<p><strong>Flannel</strong> 是 CoreOS 团队针对 Kubernetes 设计的一个网络规划访问，简单来说， 它的功能是让集群中的不同节点主机创建的 Docker容器都具有全集群唯一的虚拟IP地址。而且它还能在这些 IP 地址之间建立一个覆盖网络（Overlay Network），通过这个覆盖网络，将数据包原封不动地传递到目标容器内。</p>
<p><img src="/images/2022/1123/02.png" alt="网络解决方案Flannel"></p>
<p>ETCD 之 Flannel 提供说明：</p>
<blockquote>
<p>存储管理 Flannel 可分配的 IP 地址段资源</p>
<p>监控 ETCD 中每个 Pod 的实际地址，并在内存中建立维护 Pod 节点路由表</p>
</blockquote>
<ul>
<li><p><strong>同一个 Pod 内的多个容器之间：lo</strong> </p>
<p>同一个 Pod 共享同一个网络命名空间，共享同一个 Linux 协议栈）</p>
</li>
<li><p><strong>各 Pod 之间的通讯：Overlay Network</strong></p>
</li>
</ul>
<p>​       Pod1 与 Pod2 不在同一台主机，Pod 的地址是与 docker0 在同一个网段的，但 docker0 网段与宿主机网卡是两个完全不同的 IP 网段，并且不同的 Node 之间的通信只能通过宿主机的物理网卡进行。将 Pod 的 IP 和所在的 Pod 的 IP 关联起来，通过这个关联让 Pod 可以互相访问</p>
<p>​     Pod1 与 Pod2 在同一台机器，由 Docker0 网桥直接转发请求至 Pod2，不需要经过 Flannel</p>
<ul>
<li>Pod 与 Service 之间的通讯：目前基于性能考虑，全部为 Iptables 维护和转发，新版本已支持lvs转发</li>
</ul>
<p>​    Pod 到外网：Pod 向外网发送请求，查找路由表，转发数据包到宿主机的网卡，宿主机网卡完成路由选择后，iptables执行 Masquerade，将源 IP 更改为宿主机网卡的 IP, 然后向外网服务器发送请求</p>
<p>  <strong>外网访问 Pod：Service</strong></p>
<p>​     </p>
]]></content>
      <categories>
        <category>DevOps</category>
      </categories>
      <tags>
        <tag>Kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title>Epson 爱普生 L3150系列固件升级失败 变ET-2710</title>
    <url>/arlo/bc8a509a/</url>
    <content><![CDATA[<h1 id="故障背景"><a href="#故障背景" class="headerlink" title="故障背景"></a>故障背景</h1><blockquote>
<p>爱普生的L3150全系包含L3151&#x2F;L3153&#x2F;L3156&#x2F;L3158。<br>手上有一台L3158，用着用着，突然有一天不能联网了。WIFI灯和网络灯不亮，除了开关机键以外，其它键无响应。无法使用网络共享打印机，无法使用手机小白&#x2F;爱普生小程序打印，无法用Epson Finder查找设备，无法配网。用USB接上电脑以后，显示型号变成了ET-2710。总的来说，除了使用USB连电脑打印以外，其它功能都变砖了。机器还在保，给官方客服打电话，客服回应只能送修。网上搜索了很久都没找到答案。<br>直到在知乎上看到这篇文章(<a href="https://zhuanlan.zhihu.com/p/411809870)%EF%BC%8C%E6%8A%B1%E7%9D%80%E8%AF%95%E4%B8%80%E8%AF%95%E7%9A%84%E6%80%81%E5%BA%A6%EF%BC%8C%E5%B1%85%E7%84%B6%E4%BF%AE%E5%A4%8D%E5%A5%BD%E4%BA%86%EF%BC%8C%E9%9D%9E%E5%B8%B8%E6%84%9F%E8%B0%A2%EF%BC%81">https://zhuanlan.zhihu.com/p/411809870)，抱着试一试的态度，居然修复好了，非常感谢！</a></p>
</blockquote>
<span id="more"></span>
<p>在此记录一下修复过程，以防原链接失效，后期方便自己查看。（这已经是这台打印机第二次出现这个问题了！）</p>
<p><strong>链接: <a href="https://pan.baidu.com/s/1BZGOHhTer6ei1SMnEUpl8A">https://pan.baidu.com/s/1BZGOHhTer6ei1SMnEUpl8A</a> 提取码: xn8j</strong> </p>
<p>win10会提示该文件有风险。我也不能保证这玩意儿有没有病毒，所以请自行决定是否要使用。</p>
<h1 id="具体使用方法"><a href="#具体使用方法" class="headerlink" title="具体使用方法"></a>具体使用方法</h1><p>使用USB线连接电脑后，到官网下载好L3150的驱动软件并安装</p>
<h2 id="然后使用我分享的压缩包，打开crack-exe可执行文件"><a href="#然后使用我分享的压缩包，打开crack-exe可执行文件" class="headerlink" title="然后使用我分享的压缩包，打开crack.exe可执行文件"></a>然后使用我分享的压缩包，打开crack.exe可执行文件</h2><p>接受(Accept) Software License Agreement<br><img src="/images/2022/0908/1.png" alt="01"></p>
<h2 id="点击Select按钮，在弹出的Adjust-Program里面把Model-Name选上L3158，Port选上你认为正确的USB接口，不确定的话可以选择Auto-selection（自动选择）"><a href="#点击Select按钮，在弹出的Adjust-Program里面把Model-Name选上L3158，Port选上你认为正确的USB接口，不确定的话可以选择Auto-selection（自动选择）" class="headerlink" title="点击Select按钮，在弹出的Adjust Program里面把Model Name选上L3158，Port选上你认为正确的USB接口，不确定的话可以选择Auto selection（自动选择）"></a>点击Select按钮，在弹出的Adjust Program里面把Model Name选上L3158，Port选上你认为正确的USB接口，不确定的话可以选择Auto selection（自动选择）</h2><p><img src="/images/2022/0908/2.png" alt="01"><br><img src="/images/2022/0908/3.png" alt="01"></p>
<h2 id="点击Particular-adjustment-mode，在KelvenCrack这个弹窗里，选择Initial-setting，再点OK"><a href="#点击Particular-adjustment-mode，在KelvenCrack这个弹窗里，选择Initial-setting，再点OK" class="headerlink" title="点击Particular adjustment mode，在KelvenCrack这个弹窗里，选择Initial setting，再点OK"></a>点击Particular adjustment mode，在KelvenCrack这个弹窗里，选择Initial setting，再点OK</h2><p><img src="/images/2022/0908/4.png" alt="01"></p>
<h2 id="在Initial-Setting的窗口里，取消选中Product-Serial-No-10-digits-和MAC-Address的选项，然后点击Perform。"><a href="#在Initial-Setting的窗口里，取消选中Product-Serial-No-10-digits-和MAC-Address的选项，然后点击Perform。" class="headerlink" title="在Initial Setting的窗口里，取消选中Product Serial No.(10 digits)和MAC Address的选项，然后点击Perform。"></a>在Initial Setting的窗口里，取消选中Product Serial No.(10 digits)和MAC Address的选项，然后点击Perform。</h2><p><img src="/images/2022/0908/5.png" alt="01"><br><img src="/images/2022/0908/6.png" alt="01"><br>等进度条结束以后，打印机的灯会一通闪，跟平时闪得不一样，具体啥样我也忘了。(PS:应评论区网友罗伊的反馈，我原文写的取消选中这两个选项，有可能导致机器序列号消失，所以建议勾选这两个选项，并填入已知的机器序列号。如果不知道怎么找机器序列号和MAC，建议还是按照我的操作，即不够远这两项。)<br>关机，重新开机。运气好的话，它现在复活了。<br>机器在保并且有动手能力的可以尝试下，没动手能力的朋友建议直接送修。</p>
]]></content>
  </entry>
  <entry>
    <title>K8S|3.Harbor 私有仓库搭建</title>
    <url>/arlo/b5845dc6/</url>
    <content><![CDATA[<p>本子资源紧张，虚拟机harbor和master共用了一台主机</p>
<h1 id="准备一个docker-compose"><a href="#准备一个docker-compose" class="headerlink" title="准备一个docker-compose"></a>准备一个docker-compose</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mv docker-compose /usr/local/bin/</span><br><span class="line">chmod +x /usr/local/bin/docker-compose </span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h1 id="准备安装包harbor"><a href="#准备安装包harbor" class="headerlink" title="准备安装包harbor"></a>准备安装包harbor</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tar -xvf harbor-offline-installer-v1.2.0.tgz</span><br><span class="line">mv harbor /usr/local/</span><br><span class="line"></span><br><span class="line">#编辑配置文件</span><br><span class="line">[root@k8s-master harbor]# egrep -v &quot;^$|^#&quot; harbor.cfg </span><br><span class="line">hostname = hub.islocal.cc  #harbor域名</span><br><span class="line">ui_url_protocol = https		#采用https协议</span><br><span class="line">db_password = root123		#数据库密码</span><br><span class="line">max_job_workers = 3 </span><br><span class="line">customize_crt = on</span><br><span class="line">ssl_cert = /data/cert/server.crt	#证书</span><br><span class="line">ssl_cert_key = /data/cert/server.key</span><br><span class="line">secretkey_path = /data</span><br><span class="line">admiral_url = NA</span><br><span class="line">clair_db_password = password</span><br><span class="line">email_identity = </span><br><span class="line">email_server = smtp.mydomain.com</span><br><span class="line">email_server_port = 25</span><br><span class="line">email_username = sample_admin@mydomain.com</span><br><span class="line">email_password = abc</span><br><span class="line">email_from = admin &lt;sample_admin@mydomain.com&gt;</span><br><span class="line">email_ssl = false</span><br><span class="line">harbor_admin_password = Harbor12345		#harbor 访问密码</span><br><span class="line">auth_mode = db_auth</span><br><span class="line">ldap_url = ldaps://ldap.mydomain.com</span><br><span class="line">ldap_basedn = ou=people,dc=mydomain,dc=com</span><br><span class="line">ldap_uid = uid </span><br><span class="line">ldap_scope = 3 </span><br><span class="line">ldap_timeout = 5</span><br><span class="line">self_registration = on</span><br><span class="line">token_expiration = 30</span><br><span class="line">project_creation_restriction = everyone</span><br><span class="line">verify_remote_cert = on</span><br></pre></td></tr></table></figure>

<h1 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir -p /data/cert/</span><br><span class="line">cd /data/cert/</span><br><span class="line">#生成私钥</span><br><span class="line">[root@k8s-master cert]# openssl genrsa -des3 -out server.key 2048</span><br><span class="line">Generating RSA private key, 2048 bit long modulus</span><br><span class="line">...+++</span><br><span class="line">......................+++</span><br><span class="line">e is 65537 (0x10001)</span><br><span class="line">Enter pass phrase for server.key:	#输入密码</span><br><span class="line">Verifying - Enter pass phrase for server.key: #再次输入密码</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#生成证书</span><br><span class="line">[root@k8s-master cert]# openssl req -new -key server.key -out server.csr</span><br><span class="line">Enter pass phrase for server.key:		#输入生成秘钥时候设置的密码</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter &#x27;.&#x27;, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:CN	#输入国家名</span><br><span class="line">State or Province Name (full name) []:SHAANXI		#输入省份</span><br><span class="line">Locality Name (eg, city) [Default City]:XI&#x27;AN		#输入城市名</span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:islocal	#输入组织名</span><br><span class="line">Organizational Unit Name (eg, section) []:islocal				#输入组织名</span><br><span class="line">Common Name (eg, your name or your server&#x27;s hostname) []:hub.islocal.cc		#输入域名</span><br><span class="line">Email Address []:10887272@qq.com		#输入电子邮箱地址</span><br><span class="line"></span><br><span class="line">Please enter the following &#x27;extra&#x27; attributes</span><br><span class="line">to be sent with your certificate request</span><br><span class="line">A challenge password []:		#不修改密码</span><br><span class="line">An optional company name []:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#备份一下证书</span><br><span class="line">cp server.key server.key.org</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#转换证书，退掉密码</span><br><span class="line">[root@k8s-master cert]# openssl rsa -in server.key.org -out server.key </span><br><span class="line">Enter pass phrase for server.key.org:</span><br><span class="line">writing RSA key</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#签名证书</span><br><span class="line">[root@k8s-master cert]# openssl x509 -req -days 365 -in server.csr -signkey server.key -out server.crt </span><br><span class="line">Signature ok</span><br><span class="line">subject=/C=CN/ST=SHAANXI/L=XI&#x27;AN/O=islocal/OU=islocal/CN=hub.islocal.cc/emailAddress=10887272@qq.com</span><br><span class="line">Getting Private key</span><br><span class="line"></span><br><span class="line">#添加权限</span><br><span class="line">chmod +x /data/cert/*</span><br></pre></td></tr></table></figure>

<h1 id="安装Harbor"><a href="#安装Harbor" class="headerlink" title="安装Harbor"></a>安装Harbor</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@k8s-master harbor]# pwd</span><br><span class="line">/usr/local/harbor</span><br><span class="line"></span><br><span class="line">[root@k8s-master harbor]# ./install.sh </span><br><span class="line"></span><br><span class="line">[Step 0]: checking installation environment ...</span><br><span class="line"></span><br><span class="line">Note: docker version: 20.10.21</span><br><span class="line"></span><br><span class="line">Note: docker-compose version: 1.23.1</span><br><span class="line"></span><br><span class="line">[Step 1]: loading Harbor images ...</span><br><span class="line">dd60b611baaa: Loading layer [==================================================&gt;]  133.2MB/133.2MB</span><br><span class="line">2e814f7ef645: Loading layer [==================================================&gt;]  2.048kB/2.048kB</span><br><span class="line">bc5742b580db: Loading layer [==================================================&gt;]  2.048kB/2.048kB</span><br><span class="line">5413bcdb81b0: Loading layer [==================================================&gt;]   2.56kB/2.56kB</span><br><span class="line">c4e2be066795: Loading layer [==================================================&gt;]  3.584kB/3.584kB</span><br><span class="line">a4ea62be60b0: Loading layer [==================================================&gt;]   22.8MB/22.8MB</span><br><span class="line">800a351ae5da: Loading layer [==================================================&gt;]   22.8MB/22.8MB</span><br><span class="line">Loaded image: vmware/registry:2.6.2-photon</span><br><span class="line">Loaded image: photon:1.0</span><br><span class="line">a39bd6a7f897: Loading layer [==================================================&gt;]  10.95MB/10.95MB</span><br><span class="line">6f79b8337a1f: Loading layer [==================================================&gt;]   17.3MB/17.3MB</span><br><span class="line">74bbd0e81dd0: Loading layer [==================================================&gt;]  15.87kB/15.87kB</span><br><span class="line">Loaded image: vmware/notary-photon:signer-0.5.0</span><br><span class="line">c192a34d4ff4: Loading layer [==================================================&gt;]  155.2MB/155.2MB</span><br><span class="line">d012a9276a83: Loading layer [==================================================&gt;]  10.75MB/10.75MB</span><br><span class="line">b8befd881cb5: Loading layer [==================================================&gt;]  10.75MB/10.75MB</span><br><span class="line">Loaded image: vmware/clair:v2.0.1-photon</span><br><span class="line">e0b3d6a2361d: Loading layer [==================================================&gt;]  1.536kB/1.536kB</span><br><span class="line">3a527b0785bc: Loading layer [==================================================&gt;]  22.48MB/22.48MB</span><br><span class="line">1efe51df48d0: Loading layer [==================================================&gt;]  7.168kB/7.168kB</span><br><span class="line">c20026b42fab: Loading layer [==================================================&gt;]  5.338MB/5.338MB</span><br><span class="line">615c076c8d0a: Loading layer [==================================================&gt;]  9.728kB/9.728kB</span><br><span class="line">133d7170cbc1: Loading layer [==================================================&gt;]   2.56kB/2.56kB</span><br><span class="line">8e5b68c51d96: Loading layer [==================================================&gt;]  22.48MB/22.48MB</span><br><span class="line">Loaded image: vmware/harbor-ui:v1.2.0</span><br><span class="line">9463fb852970: Loading layer [==================================================&gt;]  75.37MB/75.37MB</span><br><span class="line">e6020d0bad7b: Loading layer [==================================================&gt;]  3.584kB/3.584kB</span><br><span class="line">3fbf59525988: Loading layer [==================================================&gt;]  3.072kB/3.072kB</span><br><span class="line">37bccef91571: Loading layer [==================================================&gt;]  3.072kB/3.072kB</span><br><span class="line">Loaded image: vmware/harbor-log:v1.2.0</span><br><span class="line">5d6cbe0dbcf9: Loading layer [==================================================&gt;]  129.2MB/129.2MB</span><br><span class="line">435f2dfbd884: Loading layer [==================================================&gt;]  344.6kB/344.6kB</span><br><span class="line">814d7b59f0cc: Loading layer [==================================================&gt;]  4.657MB/4.657MB</span><br><span class="line">aae399245bd0: Loading layer [==================================================&gt;]  1.536kB/1.536kB</span><br><span class="line">21e2ae955f72: Loading layer [==================================================&gt;]  33.84MB/33.84MB</span><br><span class="line">a2d0f7b84059: Loading layer [==================================================&gt;]  25.09kB/25.09kB</span><br><span class="line">819fa6af55b8: Loading layer [==================================================&gt;]  3.584kB/3.584kB</span><br><span class="line">78914c99a468: Loading layer [==================================================&gt;]  167.7MB/167.7MB</span><br><span class="line">36e79c658afb: Loading layer [==================================================&gt;]  6.144kB/6.144kB</span><br><span class="line">f73503aca003: Loading layer [==================================================&gt;]  9.216kB/9.216kB</span><br><span class="line">a21b39f6da59: Loading layer [==================================================&gt;]  1.536kB/1.536kB</span><br><span class="line">d7141699e1d4: Loading layer [==================================================&gt;]  8.704kB/8.704kB</span><br><span class="line">af296516d219: Loading layer [==================================================&gt;]  4.608kB/4.608kB</span><br><span class="line">b1ea8c380e6d: Loading layer [==================================================&gt;]  4.608kB/4.608kB</span><br><span class="line">Loaded image: vmware/harbor-db:v1.2.0</span><br><span class="line">7ebf4b23a7e8: Loading layer [==================================================&gt;]   19.6MB/19.6MB</span><br><span class="line">Loaded image: vmware/nginx-photon:1.11.13</span><br><span class="line">bbda1562018e: Loading layer [==================================================&gt;]  101.6MB/101.6MB</span><br><span class="line">1171ab08cc04: Loading layer [==================================================&gt;]  6.656kB/6.656kB</span><br><span class="line">6df81d3a0683: Loading layer [==================================================&gt;]  6.656kB/6.656kB</span><br><span class="line">Loaded image: vmware/postgresql:9.6.4-photon</span><br><span class="line">1576c9b2b2cd: Loading layer [==================================================&gt;]   7.07MB/7.07MB</span><br><span class="line">1812ceac4c95: Loading layer [==================================================&gt;]   7.07MB/7.07MB</span><br><span class="line">Loaded image: vmware/harbor-adminserver:v1.2.0</span><br><span class="line">0050db551e77: Loading layer [==================================================&gt;]  18.31MB/18.31MB</span><br><span class="line">af9394226ea3: Loading layer [==================================================&gt;]  18.31MB/18.31MB</span><br><span class="line">Loaded image: vmware/harbor-jobservice:v1.2.0</span><br><span class="line">4a050fccec52: Loading layer [==================================================&gt;]  12.16MB/12.16MB</span><br><span class="line">d918d73369ec: Loading layer [==================================================&gt;]   17.3MB/17.3MB</span><br><span class="line">22898836924e: Loading layer [==================================================&gt;]  15.87kB/15.87kB</span><br><span class="line">Loaded image: vmware/notary-photon:server-0.5.0</span><br><span class="line">78dbfa5b7cbc: Loading layer [==================================================&gt;]  130.9MB/130.9MB</span><br><span class="line">5f70bf18a086: Loading layer [==================================================&gt;]  1.024kB/1.024kB</span><br><span class="line">8deec01122be: Loading layer [==================================================&gt;]  344.6kB/344.6kB</span><br><span class="line">574ab36807f2: Loading layer [==================================================&gt;]  1.536kB/1.536kB</span><br><span class="line">d8f2cde2eef8: Loading layer [==================================================&gt;]  20.48kB/20.48kB</span><br><span class="line">eaa3924b054e: Loading layer [==================================================&gt;]   5.12kB/5.12kB</span><br><span class="line">8aa2c772121c: Loading layer [==================================================&gt;]  184.3MB/184.3MB</span><br><span class="line">c3014bbccb0b: Loading layer [==================================================&gt;]  8.704kB/8.704kB</span><br><span class="line">978a35efaa8c: Loading layer [==================================================&gt;]  4.608kB/4.608kB</span><br><span class="line">c2385ae7d6e5: Loading layer [==================================================&gt;]   16.6MB/16.6MB</span><br><span class="line">Loaded image: vmware/harbor-notary-db:mariadb-10.1.10</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Step 2]: preparing environment ...</span><br><span class="line">Generated and saved secret to file: /data/secretkey</span><br><span class="line">Generated configuration file: ./common/config/nginx/nginx.conf</span><br><span class="line">Generated configuration file: ./common/config/adminserver/env</span><br><span class="line">Generated configuration file: ./common/config/ui/env</span><br><span class="line">Generated configuration file: ./common/config/registry/config.yml</span><br><span class="line">Generated configuration file: ./common/config/db/env</span><br><span class="line">Generated configuration file: ./common/config/jobservice/env</span><br><span class="line">Generated configuration file: ./common/config/jobservice/app.conf</span><br><span class="line">Generated configuration file: ./common/config/ui/app.conf</span><br><span class="line">Generated certificate, key file: ./common/config/ui/private_key.pem, cert file: ./common/config/registry/root.crt</span><br><span class="line">The configuration files are ready, please use docker-compose to start the service.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Step 3]: checking existing instance of Harbor ...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Step 4]: starting Harbor ...</span><br><span class="line">Creating network &quot;harbor_harbor&quot; with the default driver</span><br><span class="line">Creating harbor-log ... done</span><br><span class="line">Creating harbor-adminserver ... done</span><br><span class="line">Creating harbor-db          ... done</span><br><span class="line">Creating registry           ... done</span><br><span class="line">Creating harbor-ui          ... done</span><br><span class="line">Creating harbor-jobservice  ... done</span><br><span class="line">Creating nginx              ... done</span><br><span class="line"></span><br><span class="line">✔ ----Harbor has been installed and started successfully.----</span><br><span class="line"></span><br><span class="line">Now you should be able to visit the admin portal at https://hub.islocal.cc. </span><br><span class="line">For more details, please visit https://github.com/vmware/harbor .</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="添加hosts记录"><a href="#添加hosts记录" class="headerlink" title="添加hosts记录"></a>添加hosts记录</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">echo &quot;192.168.111.201 hub.islocal.cc&quot;  &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>

<p><img src="/images/2022/1128/harbor.png" alt="K8S架构"></p>
<h1 id="配置docker登录"><a href="#配置docker登录" class="headerlink" title="配置docker登录"></a>配置docker登录</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@k8s-master harbor]# docker login https://hub.islocal.cc</span><br><span class="line">Username: admin</span><br><span class="line">Password: </span><br><span class="line">WARNING! Your password will be stored unencrypted in /root/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/login/#credentials-store</span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br><span class="line"></span><br><span class="line">[root@k8s-master harbor]# cat /etc/docker/daemon.json </span><br><span class="line">&#123;</span><br><span class="line">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class="line">  &quot;log-driver&quot;: &quot;json-file&quot;,</span><br><span class="line">  &quot;log-opts&quot;: &#123;</span><br><span class="line">    &quot;max-size&quot;: &quot;100m&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;insecure-registries&quot;: [&quot;https://hub.islocal.cc&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="测试镜像上传-x2F-下载"><a href="#测试镜像上传-x2F-下载" class="headerlink" title="测试镜像上传&#x2F;下载"></a>测试镜像上传&#x2F;下载</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#上传</span><br><span class="line">[root@k8s-master harbor]# docker image ls |grep nginx</span><br><span class="line">nginx                                                          latest            88736fe82739   12 days ago   142MB</span><br><span class="line">vmware/nginx-photon                                            1.11.13           285492ff20d6   5 years ago   147MB</span><br><span class="line"></span><br><span class="line">[root@k8s-master harbor]# docker tag nginx:latest hub.islocal.cc/library/nginx:latest</span><br><span class="line"></span><br><span class="line">[root@k8s-master harbor]# docker push hub.islocal.cc/library/nginx:latest</span><br><span class="line">The push refers to repository [hub.islocal.cc/library/nginx]</span><br><span class="line">6cffb086835a: Pushed </span><br><span class="line">e2d75d87993c: Pushed </span><br><span class="line">5a5bafd53f76: Pushed </span><br><span class="line">f86e88a471f4: Pushed </span><br><span class="line">f7ed3797e296: Pushed </span><br><span class="line">ec4a38999118: Pushed </span><br><span class="line">latest: digest: sha256:6ad8394ad31b269b563566998fd80a8f259e8decf16e807f8310ecc10c687385 size: 1570</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#下载</span><br><span class="line">[root@k8s-master harbor]# docker rmi 88736fe82739 -f</span><br><span class="line">Untagged: nginx:latest</span><br><span class="line">Untagged: nginx@sha256:e209ac2f37c70c1e0e9873a5f7231e91dcd83fdf1178d8ed36c2ec09974210ba</span><br><span class="line">Untagged: hub.islocal.cc/library/nginx:latest</span><br><span class="line">Untagged: hub.islocal.cc/library/nginx@sha256:6ad8394ad31b269b563566998fd80a8f259e8decf16e807f8310ecc10c687385</span><br><span class="line">Deleted: sha256:88736fe827391462a4db99252117f136b2b25d1d31719006326a437bb40cb12d</span><br><span class="line">Deleted: sha256:2f7529ffbbe947eb797a3610d36b66cc2c5448e3ed8488a3ca7106469022a75b</span><br><span class="line">Deleted: sha256:c238310d555716ef00849e741c8bdf5847e0b88170a9e2fa2fc6d3bb1ec1d416</span><br><span class="line">Deleted: sha256:ff134a07bc6f8802b26ba81ddb9c4f1c2d2c2fd32a79589b6a49667cec84d2b9</span><br><span class="line">Deleted: sha256:4a99c0c60c4efd8c1ddfc759d7d01c47168a68d2368bfe33f191c0874930cad2</span><br><span class="line">Deleted: sha256:760987b83c508d5e44ab34ad2cdaa9590ae527957a8fdb3c789592d798486730</span><br><span class="line">Deleted: sha256:ec4a38999118b78eab6899b913a548cb0b2c9b68fd05aff846a56b628b597f38</span><br><span class="line"></span><br><span class="line">[root@k8s-master harbor]# docker pull hub.islocal.cc/library/nginx:latest</span><br><span class="line">latest: Pulling from library/nginx</span><br><span class="line">a603fa5e3b41: Pull complete </span><br><span class="line">c39e1cda007e: Pull complete </span><br><span class="line">90cfefba34d7: Pull complete </span><br><span class="line">a38226fb7aba: Pull complete </span><br><span class="line">62583498bae6: Pull complete </span><br><span class="line">9802a2cfdb8d: Pull complete </span><br><span class="line">Digest: sha256:6ad8394ad31b269b563566998fd80a8f259e8decf16e807f8310ecc10c687385</span><br><span class="line">Status: Downloaded newer image for hub.islocal.cc/library/nginx:latest</span><br><span class="line">hub.islocal.cc/library/nginx:latest</span><br></pre></td></tr></table></figure>

<p><img src="/images/2022/1128/harbor2.png" alt="K8S架构"></p>
<h1 id="启动关闭Harbor"><a href="#启动关闭Harbor" class="headerlink" title="启动关闭Harbor"></a>启动关闭Harbor</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">启动harbor</span><br><span class="line">docker-compose start</span><br><span class="line">关闭harbor</span><br><span class="line">docker-compose start</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>DevOps</category>
      </categories>
      <tags>
        <tag>Kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title>K8S|2.集群(v.1.15.1)安装</title>
    <url>/arlo/3f3cfcf8/</url>
    <content><![CDATA[<h1 id="系统基础配置"><a href="#系统基础配置" class="headerlink" title="系统基础配置"></a>系统基础配置</h1><h2 id="主机及IP地址规划"><a href="#主机及IP地址规划" class="headerlink" title="主机及IP地址规划"></a>主机及IP地址规划</h2><table>
<thead>
<tr>
<th>角色</th>
<th>主机名</th>
<th>IP地址</th>
</tr>
</thead>
<tbody><tr>
<td>master</td>
<td>k8s-master</td>
<td>192.168.111.201&#x2F;24</td>
</tr>
<tr>
<td>node</td>
<td>k8s-node1</td>
<td>192.168.111.202&#x2F;24</td>
</tr>
<tr>
<td>node</td>
<td>k8s-node2</td>
<td>192.168.111.203&#x2F;24</td>
</tr>
</tbody></table>
<h2 id="设置系统主机名和Host文件"><a href="#设置系统主机名和Host文件" class="headerlink" title="设置系统主机名和Host文件"></a>设置系统主机名和Host文件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hostnamectl set-hostname k8s-master</span><br><span class="line">hostnamectl set-hostname k8s-node1</span><br><span class="line">hostnamectl set-hostname k8s-node2</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/hosts</span><br><span class="line"></span><br><span class="line">192.168.111.201 k8s-master</span><br><span class="line">192.168.111.202 k8s-node1</span><br><span class="line">192.168.111.203 k8s-node2</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">scp /etc/hosts root@k8s-node1:/etc/</span><br><span class="line">scp /etc/hosts root@k8s-node2:/etc/</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h2 id="安装依赖包"><a href="#安装依赖包" class="headerlink" title="安装依赖包"></a>安装依赖包</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum -y install conntrack ntpdate ntp ipvsadm ipset jq iptables curl sysstat libseccomp wget vim net-tools git bash-completion</span><br></pre></td></tr></table></figure>

<h2 id="设置防火墙-amp-SeLinux"><a href="#设置防火墙-amp-SeLinux" class="headerlink" title="设置防火墙&amp;SeLinux"></a>设置防火墙&amp;SeLinux</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl stop firewalld &amp;&amp; systemctl disable firewalld</span><br><span class="line">yum -y install iptables-services &amp;&amp; systemctl start iptables &amp;&amp; systemctl enable iptables &amp;&amp; iptables -F &amp;&amp; service iptables save</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">swapoff -a &amp;&amp; sed -i  &#x27;/ swap / s/^\(.*\)$/#\1/g&#x27; /etc/fstab</span><br><span class="line">setenforce 0 &amp;&amp;  sed -i &#x27;s/^SELINUX=.*/SELINUX=disabled/&#x27; /etc/selinux/config</span><br></pre></td></tr></table></figure>

<h2 id="调整内核参数"><a href="#调整内核参数" class="headerlink" title="调整内核参数"></a>调整内核参数</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/kubernetes.conf &lt;&lt;EOF</span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">net.ipv4.tcp_tw_recycle=0</span><br><span class="line">vm.swappiness=0  #禁止使用 swap 空间，只有当系统OOM时才允许使用它</span><br><span class="line">vm.overcommit_memory=1 #不检查物理内存是否够用</span><br><span class="line">vm.panic_on_oom=0  #开启 OOM</span><br><span class="line">fs.inotify.max_user_instances=8192</span><br><span class="line">fs.inotify.max_user_watches=1048576</span><br><span class="line">fs.file-max=52706963</span><br><span class="line">fs.nr_open=52706963</span><br><span class="line">net.ipv6.conf.all.disable_ipv6=1</span><br><span class="line">net.netfilter.nf_conntrack_max=2310720</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sysctl -p /etc/sysctl.d/kubernetes.conf</span><br></pre></td></tr></table></figure>

<h2 id="调整系统时区"><a href="#调整系统时区" class="headerlink" title="调整系统时区"></a>调整系统时区</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 设置系统时区为 中国/上海</span><br><span class="line">timedatectl set-timezone Asia/Shanghai</span><br><span class="line"># 将当前的 UTC 时间写入硬件时钟</span><br><span class="line">timedatectl set-local-rtc 0</span><br><span class="line"># 重启依赖于系统的时间服务</span><br><span class="line">systemctl restart rsyslog</span><br><span class="line">systemctl restart crond</span><br></pre></td></tr></table></figure>

<h2 id="关闭系统不需要的服务"><a href="#关闭系统不需要的服务" class="headerlink" title="关闭系统不需要的服务"></a>关闭系统不需要的服务</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl stop postfix &amp;&amp; systemctl disable postfix</span><br></pre></td></tr></table></figure>

<h2 id="设置-rsyslogd-和-systemd-journald"><a href="#设置-rsyslogd-和-systemd-journald" class="headerlink" title="设置 rsyslogd 和 systemd journald"></a>设置 rsyslogd 和 systemd journald</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir /var/log/journal # 持久化保存日志的目录</span><br><span class="line">mkdir /etc/systemd/journald.conf.d</span><br><span class="line">cat &gt; /etc/systemd/journald.conf.d/99-prophet.conf &lt;&lt; EOF</span><br><span class="line">[Journal]</span><br><span class="line">#持久化保存到磁盘</span><br><span class="line">Storage=persistent</span><br><span class="line"></span><br><span class="line">#压缩历史日志</span><br><span class="line">Compress=yes</span><br><span class="line"></span><br><span class="line">SyncIntervalSec=5m</span><br><span class="line">RateLimitInterval=30s</span><br><span class="line">RateLimitBurst=1000</span><br><span class="line"></span><br><span class="line">#最大占用空间10G</span><br><span class="line">SystemMaxUse=10G</span><br><span class="line"></span><br><span class="line">#单日志文件最大 200M</span><br><span class="line">SystemMaxFileSize=200M</span><br><span class="line"></span><br><span class="line">#日志保存时间 2周</span><br><span class="line">MaxRetentionSec=2week</span><br><span class="line"></span><br><span class="line">#不将日志转发到 syslog</span><br><span class="line">ForwardToSyslog=no</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">#重启日志服务</span><br><span class="line">systemctl restart systemd-journald</span><br></pre></td></tr></table></figure>

<h2 id="升级系统内核到5-4"><a href="#升级系统内核到5-4" class="headerlink" title="升级系统内核到5.4"></a>升级系统内核到5.4</h2><p>CentOS7.x 系统自带的3.10.x内核存在一些 Bug，导致运行的 Docker，Kubernetes 不稳定，我们需要升级一下内核</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm</span><br><span class="line">#安装完成后检查 /boot/grub2/grub.cfg 中对应内核 menuentry 中是否包含 initrd16 配置，如果没有，再安装一次</span><br><span class="line">yum --enablerepo=elrepo-kernel install -y kernel-lt</span><br><span class="line">#设置开机从新内核启动</span><br><span class="line">grub2-set-default &quot;CentOS Linux (5.4.225-1.el7.elrepo.x86_64) 7 (Core)&quot;</span><br></pre></td></tr></table></figure>

<h1 id="安装K8S集群"><a href="#安装K8S集群" class="headerlink" title="安装K8S集群"></a>安装K8S集群</h1><h2 id="kube-proxy-开启ipvs的前置条件"><a href="#kube-proxy-开启ipvs的前置条件" class="headerlink" title="kube-proxy 开启ipvs的前置条件"></a>kube-proxy 开启ipvs的前置条件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">modprobe br_netfilter</span><br><span class="line"></span><br><span class="line">cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt; EOF</span><br><span class="line">#!/bin/bash</span><br><span class="line">modprobe -- ip_vs</span><br><span class="line">modprobe -- ip_vs_rr</span><br><span class="line">modprobe -- ip_vs_wrr</span><br><span class="line">modprobe -- ip_vs_sh</span><br><span class="line">modprobe -- nf_conntrack</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep -e ip_vs -e nf_conntrack_ipv4</span><br></pre></td></tr></table></figure>

<h2 id="安装-Docker-软件"><a href="#安装-Docker-软件" class="headerlink" title="安装 Docker 软件"></a>安装 Docker 软件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum -y install yum-utils device-mapper-persistent-data lvm2</span><br><span class="line"></span><br><span class="line">yum-config-manager \</span><br><span class="line"> --add-repo \</span><br><span class="line"> http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"> </span><br><span class="line">yum update -y &amp;&amp; yum install -y docker-ce</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#设置开机从新内核启动,重启服务器（update后，系统会变回3.10了）</span><br><span class="line">grub2-set-default &quot;CentOS Linux (5.4.225-1.el7.elrepo.x86_64) 7 (Core)&quot;</span><br><span class="line">reboot</span><br><span class="line"></span><br><span class="line">#确认内核版本</span><br><span class="line">uname -r</span><br><span class="line">5.4.225-1.el7.elrepo.x86_64</span><br><span class="line"></span><br><span class="line"># 创建 /etc/docker 目录</span><br><span class="line">mkdir /etc/docker</span><br><span class="line"></span><br><span class="line">#配置daemon</span><br><span class="line"></span><br><span class="line">cat &gt; /etc/docker/daemon.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;], </span><br><span class="line">  &quot;log-driver&quot;: [&quot;json-file&quot;],</span><br><span class="line">  &quot;log-opts&quot;: &#123;</span><br><span class="line">    &quot;max-size&quot;: &quot;100m&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">mkdir -p /etc/systemd/system/docker.service.d</span><br><span class="line"></span><br><span class="line"># 重启docker服务</span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl restart docker &amp;&amp; systemctl enable docker</span><br></pre></td></tr></table></figure>

<h2 id="安装-kubeadm-（主从配置）"><a href="#安装-kubeadm-（主从配置）" class="headerlink" title="安装 kubeadm （主从配置）"></a>安装 kubeadm （主从配置）</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo </span><br><span class="line">[Kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">yum -y install kubeadm-1.15.1 kubectl-1.15.1 kubelet-1.15.1</span><br><span class="line">systemctl enable kubelet.service</span><br></pre></td></tr></table></figure>

<h2 id="下载镜像"><a href="#下载镜像" class="headerlink" title="下载镜像"></a>下载镜像</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">K8S安装包</span><br><span class="line">https://www.aliyundrive.com/s/ukkPSaMDeG8</span><br><span class="line">提取码: 7n6j</span><br><span class="line"></span><br><span class="line">将下载的压缩包上传至/usr/local/src目录下并解压。</span><br><span class="line"></span><br><span class="line">[root@k8s-master src]# pwd</span><br><span class="line">/usr/local/src</span><br><span class="line">[root@k8s-master src]# tree -L 2</span><br><span class="line">.</span><br><span class="line">├── docker-compose</span><br><span class="line">├── harbor-offline-installer-v1.2.0.tgz</span><br><span class="line">├── kubeadm-basic.images</span><br><span class="line">│   ├── apiserver.tar</span><br><span class="line">│   ├── coredns.tar</span><br><span class="line">│   ├── etcd.tar</span><br><span class="line">│   ├── kubec-con-man.tar</span><br><span class="line">│   ├── pause.tar</span><br><span class="line">│   ├── proxy.tar</span><br><span class="line">│   └── scheduler.tar</span><br><span class="line">├── kubeadm-basic.images.tar.gz</span><br><span class="line">└── \350\275\257\350\267\257\347\224\261.7z</span><br><span class="line"></span><br><span class="line">1 directory, 11 files</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="生成初始化配置文件"><a href="#生成初始化配置文件" class="headerlink" title="生成初始化配置文件"></a>生成初始化配置文件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 生成初始化配置文件</span><br><span class="line">kubeadm config print init-defaults &gt; kubeadm-config.yaml</span><br><span class="line">#修改不部分配置文件</span><br><span class="line">	localAPIEndpoint：</span><br><span class="line">		advertiseAddress:192.168.111.201 #主节点ip</span><br><span class="line">	kubernetesVersion: v1.15.0 #版本号</span><br><span class="line">	networking:</span><br><span class="line">	  podSubnet: &quot;10.244.0.0/16&quot;  #添加一个pod网段</span><br><span class="line">	  serviceSubnet: 10.96.0.0/12</span><br><span class="line">	---</span><br><span class="line">	apiVersion: kubeporxy.config.k8s.io/v1alpha1  #修改为ipvs管理</span><br><span class="line">	kind: KubeProxyConfiguration</span><br><span class="line">	featureGates:</span><br><span class="line">	  SupportIPVSProxyMode: true</span><br><span class="line">	mode: ipvs</span><br></pre></td></tr></table></figure>

<p>配置文件内容如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">apiVersion: kubeadm.k8s.io/v1beta3</span><br><span class="line">bootstrapTokens:</span><br><span class="line">- groups:</span><br><span class="line">  - system:bootstrappers:kubeadm:default-node-token</span><br><span class="line">  token: abcdef.0123456789abcdef</span><br><span class="line">  ttl: 24h0m0s</span><br><span class="line">  usages:</span><br><span class="line">  - signing</span><br><span class="line">  - authentication</span><br><span class="line">kind: InitConfiguration</span><br><span class="line">localAPIEndpoint:</span><br><span class="line">  advertiseAddress: 192.168.111.201</span><br><span class="line">  bindPort: 6443</span><br><span class="line">nodeRegistration:</span><br><span class="line">  criSocket: unix:///var/run/containerd/containerd.sock</span><br><span class="line">  imagePullPolicy: IfNotPresent</span><br><span class="line">  name: k8s-master</span><br><span class="line">  taints: null</span><br><span class="line">---</span><br><span class="line">apiServer:</span><br><span class="line">  timeoutForControlPlane: 4m0s</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta3</span><br><span class="line">certificatesDir: /etc/kubernetes/pki</span><br><span class="line">clusterName: kubernetes</span><br><span class="line">controllerManager: &#123;&#125;</span><br><span class="line">dns: &#123;&#125;</span><br><span class="line">etcd:</span><br><span class="line">  local:</span><br><span class="line">    dataDir: /var/lib/etcd</span><br><span class="line">imageRepository: registry.k8s.io</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: 1.25.0</span><br><span class="line">networking:</span><br><span class="line">  dnsDomain: cluster.local</span><br><span class="line">  podSubnet: &quot;10.244.0.0/16&quot;</span><br><span class="line">  serviceSubnet: 10.96.0.0/12</span><br><span class="line">scheduler: &#123;&#125;</span><br><span class="line">---</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">featureGates:</span><br><span class="line">  SupportIPVSProxyMode: true</span><br><span class="line">mode: ipvs</span><br></pre></td></tr></table></figure>

<h2 id="进行初始化安装"><a href="#进行初始化安装" class="headerlink" title="进行初始化安装"></a>进行初始化安装</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubeadm init --config=kubeadm-config.yaml --upload-certs |tee kubeadm-init.log</span><br><span class="line"></span><br><span class="line">[init] Using Kubernetes version: v1.15.1</span><br><span class="line">[preflight] Running pre-flight checks</span><br><span class="line">	[WARNING SystemVerification]: this Docker version is not on the list of validated versions: 20.10.21. Latest validated version: 18.09</span><br><span class="line">[preflight] Pulling images required for setting up a Kubernetes cluster</span><br><span class="line">[preflight] This might take a minute or two, depending on the speed of your internet connection</span><br><span class="line">[preflight] You can also perform this action in beforehand using &#x27;kubeadm config images pull&#x27;</span><br><span class="line">[kubelet-start] Writing kubelet environment file with flags to file &quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span><br><span class="line">[kubelet-start] Writing kubelet configuration to file &quot;/var/lib/kubelet/config.yaml&quot;</span><br><span class="line">[kubelet-start] Activating the kubelet service</span><br><span class="line">[certs] Using certificateDir folder &quot;/etc/kubernetes/pki&quot;</span><br><span class="line">[certs] Generating &quot;ca&quot; certificate and key</span><br><span class="line">[certs] Generating &quot;apiserver&quot; certificate and key</span><br><span class="line">[certs] apiserver serving cert is signed for DNS names [k8s-master kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.96.0.1 192.168.111.201]</span><br><span class="line">[certs] Generating &quot;apiserver-kubelet-client&quot; certificate and key</span><br><span class="line">[certs] Generating &quot;etcd/ca&quot; certificate and key</span><br><span class="line">[certs] Generating &quot;etcd/server&quot; certificate and key</span><br><span class="line">[certs] etcd/server serving cert is signed for DNS names [k8s-master localhost] and IPs [192.168.111.201 127.0.0.1 ::1]</span><br><span class="line">[certs] Generating &quot;etcd/healthcheck-client&quot; certificate and key</span><br><span class="line">[certs] Generating &quot;apiserver-etcd-client&quot; certificate and key</span><br><span class="line">[certs] Generating &quot;etcd/peer&quot; certificate and key</span><br><span class="line">[certs] etcd/peer serving cert is signed for DNS names [k8s-master localhost] and IPs [192.168.111.201 127.0.0.1 ::1]</span><br><span class="line">[certs] Generating &quot;front-proxy-ca&quot; certificate and key</span><br><span class="line">[certs] Generating &quot;front-proxy-client&quot; certificate and key</span><br><span class="line">[certs] Generating &quot;sa&quot; key and public key</span><br><span class="line">[kubeconfig] Using kubeconfig folder &quot;/etc/kubernetes&quot;</span><br><span class="line">[kubeconfig] Writing &quot;admin.conf&quot; kubeconfig file</span><br><span class="line">[kubeconfig] Writing &quot;kubelet.conf&quot; kubeconfig file</span><br><span class="line">[kubeconfig] Writing &quot;controller-manager.conf&quot; kubeconfig file</span><br><span class="line">[kubeconfig] Writing &quot;scheduler.conf&quot; kubeconfig file</span><br><span class="line">[control-plane] Using manifest folder &quot;/etc/kubernetes/manifests&quot;</span><br><span class="line">[control-plane] Creating static Pod manifest for &quot;kube-apiserver&quot;</span><br><span class="line">[control-plane] Creating static Pod manifest for &quot;kube-controller-manager&quot;</span><br><span class="line">[control-plane] Creating static Pod manifest for &quot;kube-scheduler&quot;</span><br><span class="line">[etcd] Creating static Pod manifest for local etcd in &quot;/etc/kubernetes/manifests&quot;</span><br><span class="line">[wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory &quot;/etc/kubernetes/manifests&quot;. This can take up to 4m0s</span><br><span class="line">[apiclient] All control plane components are healthy after 38.004014 seconds</span><br><span class="line">[upload-config] Storing the configuration used in ConfigMap &quot;kubeadm-config&quot; in the &quot;kube-system&quot; Namespace</span><br><span class="line">[kubelet] Creating a ConfigMap &quot;kubelet-config-1.15&quot; in namespace kube-system with the configuration for the kubelets in the cluster</span><br><span class="line">[upload-certs] Storing the certificates in Secret &quot;kubeadm-certs&quot; in the &quot;kube-system&quot; Namespace</span><br><span class="line">[upload-certs] Using certificate key:</span><br><span class="line">c7d4324264d6989efe538e2a699a415b7024a020e07a7925b37decc4cb16b92d</span><br><span class="line">[mark-control-plane] Marking the node k8s-master as control-plane by adding the label &quot;node-role.kubernetes.io/master=&#x27;&#x27;&quot;</span><br><span class="line">[mark-control-plane] Marking the node k8s-master as control-plane by adding the taints [node-role.kubernetes.io/master:NoSchedule]</span><br><span class="line">[bootstrap-token] Using token: abcdef.0123456789abcdef</span><br><span class="line">[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles</span><br><span class="line">[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials</span><br><span class="line">[bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token</span><br><span class="line">[bootstrap-token] configured RBAC rules to allow certificate rotation for all node client certificates in the cluster</span><br><span class="line">[bootstrap-token] Creating the &quot;cluster-info&quot; ConfigMap in the &quot;kube-public&quot; namespace</span><br><span class="line">[addons] Applied essential addon: CoreDNS</span><br><span class="line">[kubelet-check] Initial timeout of 40s passed.</span><br><span class="line">[addons] Applied essential addon: kube-proxy</span><br><span class="line"></span><br><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  mkdir -p $HOME/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">Then you can join any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm join 192.168.111.201:6443 --token abcdef.0123456789abcdef \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:9c0b031b3653733b7acadbaed38cc3c5faa8e582a48c92eb387ff416c2850d7c </span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@k8s-master flannel]# kubectl get node</span><br><span class="line">NAME         STATUS     ROLES    AGE   VERSION</span><br><span class="line">k8s-master   NotReady   master   38m   v1.15.1</span><br></pre></td></tr></table></figure>

<p>如果init失败的话，可以根据报错日志修改相关配置，并使用以下命令重置节点</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubeadm reset</span><br></pre></td></tr></table></figure>

<h2 id="部署网络"><a href="#部署网络" class="headerlink" title="部署网络"></a>部署网络</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@k8s-master flannel]# kubectl apply -f kube-flannel.yml</span><br><span class="line"></span><br><span class="line">namespace/kube-flannel created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/flannel created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/flannel created</span><br><span class="line">serviceaccount/flannel created</span><br><span class="line">configmap/kube-flannel-cfg created</span><br><span class="line">daemonset.apps/kube-flannel-ds created</span><br><span class="line"></span><br><span class="line">[root@k8s-master flannel]# kubectl get po -n kube-system</span><br><span class="line">NAME                                 READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-5c98db65d4-7ndgf             0/1     Pending   0          39m</span><br><span class="line">coredns-5c98db65d4-jmgkk             0/1     Pending   0          39m</span><br><span class="line">etcd-k8s-master                      1/1     Running   0          38m</span><br><span class="line">kube-apiserver-k8s-master            1/1     Running   0          38m</span><br><span class="line">kube-controller-manager-k8s-master   1/1     Running   0          38m</span><br><span class="line">kube-proxy-fqjgn                     1/1     Running   0          39m</span><br><span class="line">kube-scheduler-k8s-master            1/1     Running   0          38m</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>kube-flannel.yml 文件内容如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">kind: Namespace</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-flannel</span><br><span class="line">  labels:</span><br><span class="line">    pod-security.kubernetes.io/enforce: privileged</span><br><span class="line">---</span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: flannel</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - pods</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - nodes</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - nodes/status</span><br><span class="line">  verbs:</span><br><span class="line">  - patch</span><br><span class="line">---</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: flannel</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: flannel</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: flannel</span><br><span class="line">  namespace: kube-flannel</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: flannel</span><br><span class="line">  namespace: kube-flannel</span><br><span class="line">---</span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-flannel-cfg</span><br><span class="line">  namespace: kube-flannel</span><br><span class="line">  labels:</span><br><span class="line">    tier: node</span><br><span class="line">    app: flannel</span><br><span class="line">data:</span><br><span class="line">  cni-conf.json: |</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;name&quot;: &quot;cbr0&quot;,</span><br><span class="line">      &quot;cniVersion&quot;: &quot;0.3.1&quot;,</span><br><span class="line">      &quot;plugins&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;type&quot;: &quot;flannel&quot;,</span><br><span class="line">          &quot;delegate&quot;: &#123;</span><br><span class="line">            &quot;hairpinMode&quot;: true,</span><br><span class="line">            &quot;isDefaultGateway&quot;: true</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;type&quot;: &quot;portmap&quot;,</span><br><span class="line">          &quot;capabilities&quot;: &#123;</span><br><span class="line">            &quot;portMappings&quot;: true</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  net-conf.json: |</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;Network&quot;: &quot;10.244.0.0/16&quot;,</span><br><span class="line">      &quot;Backend&quot;: &#123;</span><br><span class="line">        &quot;Type&quot;: &quot;vxlan&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-flannel-ds</span><br><span class="line">  namespace: kube-flannel</span><br><span class="line">  labels:</span><br><span class="line">    tier: node</span><br><span class="line">    app: flannel</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: flannel</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        tier: node</span><br><span class="line">        app: flannel</span><br><span class="line">    spec:</span><br><span class="line">      affinity:</span><br><span class="line">        nodeAffinity:</span><br><span class="line">          requiredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">            nodeSelectorTerms:</span><br><span class="line">            - matchExpressions:</span><br><span class="line">              - key: kubernetes.io/os</span><br><span class="line">                operator: In</span><br><span class="line">                values:</span><br><span class="line">                - linux</span><br><span class="line">      hostNetwork: true</span><br><span class="line">      priorityClassName: system-node-critical</span><br><span class="line">      tolerations:</span><br><span class="line">      - operator: Exists</span><br><span class="line">        effect: NoSchedule</span><br><span class="line">      serviceAccountName: flannel</span><br><span class="line">      initContainers:</span><br><span class="line">      - name: install-cni-plugin</span><br><span class="line">       #image: flannelcni/flannel-cni-plugin:v1.1.0 for ppc64le and mips64le (dockerhub limitations may apply)</span><br><span class="line">        image: docker.io/rancher/mirrored-flannelcni-flannel-cni-plugin:v1.1.0</span><br><span class="line">        command:</span><br><span class="line">        - cp</span><br><span class="line">        args:</span><br><span class="line">        - -f</span><br><span class="line">        - /flannel</span><br><span class="line">        - /opt/cni/bin/flannel</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: cni-plugin</span><br><span class="line">          mountPath: /opt/cni/bin</span><br><span class="line">      - name: install-cni</span><br><span class="line">       #image: flannelcni/flannel:v0.20.1 for ppc64le and mips64le (dockerhub limitations may apply)</span><br><span class="line">        image: docker.io/rancher/mirrored-flannelcni-flannel:v0.20.1</span><br><span class="line">        command:</span><br><span class="line">        - cp</span><br><span class="line">        args:</span><br><span class="line">        - -f</span><br><span class="line">        - /etc/kube-flannel/cni-conf.json</span><br><span class="line">        - /etc/cni/net.d/10-flannel.conflist</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: cni</span><br><span class="line">          mountPath: /etc/cni/net.d</span><br><span class="line">        - name: flannel-cfg</span><br><span class="line">          mountPath: /etc/kube-flannel/</span><br><span class="line">      containers:</span><br><span class="line">      - name: kube-flannel</span><br><span class="line">       #image: flannelcni/flannel:v0.20.1 for ppc64le and mips64le (dockerhub limitations may apply)</span><br><span class="line">        image: docker.io/rancher/mirrored-flannelcni-flannel:v0.20.1</span><br><span class="line">        command:</span><br><span class="line">        - /opt/bin/flanneld</span><br><span class="line">        args:</span><br><span class="line">        - --ip-masq</span><br><span class="line">        - --kube-subnet-mgr</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            cpu: &quot;100m&quot;</span><br><span class="line">            memory: &quot;50Mi&quot;</span><br><span class="line">          limits:</span><br><span class="line">            cpu: &quot;100m&quot;</span><br><span class="line">            memory: &quot;50Mi&quot;</span><br><span class="line">        securityContext:</span><br><span class="line">          privileged: false</span><br><span class="line">          capabilities:</span><br><span class="line">            add: [&quot;NET_ADMIN&quot;, &quot;NET_RAW&quot;]</span><br><span class="line">        env:</span><br><span class="line">        - name: POD_NAME</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.name</span><br><span class="line">        - name: POD_NAMESPACE</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.namespace</span><br><span class="line">        - name: EVENT_QUEUE_DEPTH</span><br><span class="line">          value: &quot;5000&quot;</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: run</span><br><span class="line">          mountPath: /run/flannel</span><br><span class="line">        - name: flannel-cfg</span><br><span class="line">          mountPath: /etc/kube-flannel/</span><br><span class="line">        - name: xtables-lock</span><br><span class="line">          mountPath: /run/xtables.lock</span><br><span class="line">      volumes:</span><br><span class="line">      - name: run</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /run/flannel</span><br><span class="line">      - name: cni-plugin</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /opt/cni/bin</span><br><span class="line">      - name: cni</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /etc/cni/net.d</span><br><span class="line">      - name: flannel-cfg</span><br><span class="line">        configMap:</span><br><span class="line">          name: kube-flannel-cfg</span><br><span class="line">      - name: xtables-lock</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /run/xtables.lock</span><br><span class="line">          type: FileOrCreate</span><br></pre></td></tr></table></figure>

<h2 id="将node节点加入到集群中"><a href="#将node节点加入到集群中" class="headerlink" title="将node节点加入到集群中"></a>将node节点加入到集群中</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#可以使用这条命令获取加入集群的命令</span><br><span class="line">kubeadm token create --print-join-command</span><br><span class="line"></span><br><span class="line">kubeadm join 192.168.111.201:6443 --token abcdef.0123456789abcdef \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:9c0b031b3653733b7acadbaed38cc3c5faa8e582a48c92eb387ff416c2850d7c </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">[root@k8s-master ~]# kubectl get node</span><br><span class="line">NAME         STATUS   ROLES    AGE   VERSION</span><br><span class="line">k8s-master   Ready    master   49m   v1.15.1</span><br><span class="line">k8s-node1    Ready    &lt;none&gt;   42m   v1.15.1</span><br><span class="line">k8s-node2    Ready    &lt;none&gt;   42m   v1.15.1</span><br><span class="line"></span><br><span class="line">[root@k8s-master flannel]# kubectl get pods -n kube-system</span><br><span class="line">NAME                                 READY   STATUS              RESTARTS   AGE</span><br><span class="line">coredns-5c98db65d4-fslj5             0/1     ContainerCreating   0          50m</span><br><span class="line">coredns-5c98db65d4-vrgnq             0/1     ContainerCreating   0          50m</span><br><span class="line">etcd-k8s-master                      1/1     Running             0          49m</span><br><span class="line">kube-apiserver-k8s-master            1/1     Running             0          49m</span><br><span class="line">kube-controller-manager-k8s-master   1/1     Running             0          49m</span><br><span class="line">kube-flannel-ds-amd64-scwhp          1/1     Running             0          7m41s</span><br><span class="line">kube-flannel-ds-amd64-vxzsr          1/1     Running             0          7m41s</span><br><span class="line">kube-flannel-ds-amd64-xvps6          1/1     Running             0          7m41s</span><br><span class="line">kube-proxy-7g7z7                     1/1     Running             0          44m</span><br><span class="line">kube-proxy-gchtw                     1/1     Running             0          44m</span><br><span class="line">kube-proxy-mdxbr                     1/1     Running             0          50m</span><br><span class="line">kube-scheduler-k8s-master            1/1     Running             0          49m</span><br></pre></td></tr></table></figure>

<h1 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Q1:</span><br><span class="line">[root@k8s-master src]# kubeadm init --config=kubeadm-config.yaml --upload-certs |tee kubeadm-init.log</span><br><span class="line">W1127 22:06:01.251107    2430 initconfiguration.go:305] unknown configuration schema.GroupVersionKind&#123;Group:&quot;kubeporxy.config.k8s.io&quot;, Version:&quot;v1alpha1&quot;, Kind:&quot;KubeProxyConfiguration&quot;&#125;</span><br><span class="line">W1127 22:06:01.251311    2430 initconfiguration.go:331] [config] WARNING: Ignored YAML document with GroupVersionKind kubeporxy.config.k8s.io/v1alpha1, Kind=KubeProxyConfiguration</span><br><span class="line">[init] Using Kubernetes version: v1.25.0</span><br><span class="line">[preflight] Running pre-flight checks</span><br><span class="line">error execution phase preflight: [preflight] Some fatal errors occurred:</span><br><span class="line">	[ERROR CRI]: container runtime is not running: output: E1127 22:06:01.290159    2440 remote_runtime.go:948] &quot;Status from runtime service failed&quot; err=&quot;rpc error: code = Unimplemented desc = unknown service runtime.v1alpha2.RuntimeService&quot;</span><br><span class="line">time=&quot;2022-11-27T22:06:01+08:00&quot; level=fatal msg=&quot;getting status of runtime: rpc error: code = Unimplemented desc = unknown service runtime.v1alpha2.RuntimeService&quot;</span><br><span class="line">, error: exit status 1</span><br><span class="line">[preflight] If you know what you are doing, you can make a check non-fatal with `--ignore-preflight-errors=...`</span><br><span class="line">To see the stack trace of this error execute with --v=5 or higher</span><br><span class="line">A1:</span><br><span class="line">rm -rf /etc/containerd/config.toml</span><br><span class="line">systemctl restart containerd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Q2：</span><br><span class="line">Nov 27 22:03:14 k8s-master kubelet: F1127 22:03:14.712519   41018 server.go:273] failed to run Kubelet: failed to create kubelet: misconfiguration: kubelet cgroup driver: &quot;systemd&quot; is different from docker cgroup driver: &quot;cgroupfs&quot;</span><br><span class="line">A2：</span><br><span class="line">kubernetes官方推荐docker等使用systemd作为cgroupdriver，保持两个文件里的配置相同</span><br><span class="line">修改docker配置文件/etc/docker/daemon.json </span><br><span class="line">&#123;</span><br><span class="line">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class="line">  &quot;log-driver&quot;: &quot;json-file&quot;,</span><br><span class="line">  &quot;log-opts&quot;: &#123;</span><br><span class="line">    &quot;max-size&quot;: &quot;100m&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">修改kubnetes 配置文件/var/lib/kubelet/config.yaml </span><br><span class="line">cgroupDriver: systemd</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br><span class="line">systemctl restart kubelet</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Q3：</span><br><span class="line">Nov 27 23:32:37 k8s-master kubelet[107375]: E1127 23:32:37.687073  107375 pod_workers.go:190] Error syncing pod ecae9d12d3610192347be3d1aa5aa552 (&quot;kube-scheduler-k8s-master_kube-system(ecae9d12d3610192347be3d1aa5aa552)&quot;), skipping: failed to &quot;CreatePodSandbox&quot; for &quot;kube-scheduler-k8s-master_kube-system(ecae9d12d3610192347be3d1aa5aa552)&quot; with CreatePodSandboxError: &quot;CreatePodSandbox for pod \&quot;kube-scheduler-k8s-master_kube-system(ecae9d12d3610192347be3d1aa5aa552)\&quot; failed: rpc error: code = Unknown desc = failed to create a sandbox for pod \&quot;kube-scheduler-k8s-master\&quot;: Error response from daemon: Conflict. The container name \&quot;/k8s_POD_kube-scheduler-k8s-master_kube-system_ecae9d12d3610192347be3d1aa5aa552_3\&quot; is already in use by container \&quot;7dcb605b10a59a09aa084a73dcf1d5ab68cc9a27ad6a89aa616ac0e6e42c540e\&quot;. You have to remove (or rename) that container to be able to reuse that name.&quot;</span><br><span class="line">Nov 27 23:32:37 k8s-master kubelet[107375]: E1127 23:32:37.741283  107375 kubelet.go:2248] node &quot;k8s-master&quot; not found</span><br><span class="line">Nov 27 23:32:37 k8s-master kubelet[107375]: E1127 23:32:37.841936  107375 kubelet.go:2248] node &quot;k8s-master&quot; not found</span><br><span class="line"></span><br><span class="line">A3:</span><br><span class="line">[root@k8s-master ~]# cat /var/lib/kubelet/cpu_manager_state</span><br><span class="line">&#123;&quot;policyName&quot;:&quot;none&quot;,&quot;defaultCpuSet&quot;:&quot;&quot;,&quot;checksum&quot;:3242152201&#125;</span><br><span class="line">[root@k8s-master ~]# rm -f /var/lib/kubelet/cpu_manager_state</span><br><span class="line"></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>DevOps</category>
      </categories>
      <tags>
        <tag>Kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title>K8S|4.资源清单</title>
    <url>/arlo/534c8f35/</url>
    <content><![CDATA[<h1 id="K8S中的资源"><a href="#K8S中的资源" class="headerlink" title="K8S中的资源"></a>K8S中的资源</h1><h1 id="集群资源分类"><a href="#集群资源分类" class="headerlink" title="集群资源分类"></a>集群资源分类</h1><p><strong>工作负载型资源（workload）：</strong>Pod、ReplicaSet、Deployment、StatefulSet、DaemonSet、Job、CronJob（ReplicationController 在 v1.11 版本被废弃）</p>
<p><strong>服务发现及负载均衡型资源（ServiceDiscovery LoadBalance）:</strong> Service、Ingress、……</p>
<p><strong>配置与存储型资源：</strong>Volume（存储卷）、CSI（容器存储接口、可以扩展各种各样的第三方存储卷）</p>
<p><strong>特殊类型的存储卷：</strong>ConfigMap（当配置中心来使用的资源类型）、Secret（保存敏感数据）、DownwardAPI（把外部资源中的信息输出给容器）</p>
<p><strong>集群级资源：</strong>Namespace、Node、Role、ClusterRole、RoleBinding、ClusterRoleBinding</p>
<p><strong>云数据型资源：</strong>HPA、PodTemplate、LimitRange</p>
<span id="more"></span>

<h1 id="资源清单-YAML格式"><a href="#资源清单-YAML格式" class="headerlink" title="资源清单-YAML格式"></a>资源清单-YAML格式</h1><p>在k8s中，一般使用 yaml 格式的文件来创建符合我们预期期望的 pod，这样的 yaml 文件我们一般成为资源清单</p>
<h2 id="简单说明"><a href="#简单说明" class="headerlink" title="简单说明"></a>简单说明</h2><p>是一个可读性高，用来表达数据序列的格式。YAML 的意思其实是：仍是一种标记语言，但为了强调这种语言以数据为中心，而不是已标记语言为重点。</p>
<h2 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h2><ul>
<li>缩进时不允许使用Tab键，只允许使用空格</li>
<li>缩进的空格数目不重要，只要相同层级的元素左侧对齐即可</li>
<li>#标识注释，从这个字符一直到行尾，都会被解释器忽略</li>
</ul>
<h2 id="YAML-支持的数据结构"><a href="#YAML-支持的数据结构" class="headerlink" title="YAML 支持的数据结构"></a>YAML 支持的数据结构</h2><ul>
<li>对象：键值对的集合，又称为映射（mapping）&#x2F;哈希（hashes）&#x2F;字典（dictionary）</li>
<li>数组：一组按次序排列的值，又称为序列（sequence）&#x2F;列表（list）</li>
<li>纯量（scalars）：单个的、不可再分的值</li>
</ul>
<h2 id="对象类型：对象的一组键值对，使用冒号结构表示"><a href="#对象类型：对象的一组键值对，使用冒号结构表示" class="headerlink" title="对象类型：对象的一组键值对，使用冒号结构表示"></a>对象类型：对象的一组键值对，使用冒号结构表示</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">name: steve</span><br><span class="line">age: 18</span><br></pre></td></tr></table></figure>

<p><strong>Yaml 也允许另一种写法，将所有键值对写成一个行内对象</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hash: &#123; name: steve, age: 18 &#125;</span><br></pre></td></tr></table></figure>

<h2 id="数组类型：一组连词线开头的行，构成一个数组"><a href="#数组类型：一组连词线开头的行，构成一个数组" class="headerlink" title="数组类型：一组连词线开头的行，构成一个数组"></a>数组类型：一组连词线开头的行，构成一个数组</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">animal</span><br><span class="line">- Cat</span><br><span class="line">- Dog</span><br></pre></td></tr></table></figure>

<p>数组也可以采用行内表示法</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">animal: [Cat, Dog]</span><br></pre></td></tr></table></figure>

<p>符合结构：对象和数组可以结合使用，形成符合结构</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">languages:</span><br><span class="line">- Ruby</span><br><span class="line">- Perl</span><br><span class="line">- Python</span><br><span class="line">websites:</span><br><span class="line">YAML: yaml.org</span><br><span class="line">Ruby: ruby-lang.org</span><br><span class="line">Python: python.org</span><br><span class="line">Perl: use.perl.org</span><br></pre></td></tr></table></figure>

<h2 id="纯量：纯量是最基本的、不可再分的值。以下数据类型都属于纯量"><a href="#纯量：纯量是最基本的、不可再分的值。以下数据类型都属于纯量" class="headerlink" title="纯量：纯量是最基本的、不可再分的值。以下数据类型都属于纯量"></a>纯量：纯量是最基本的、不可再分的值。以下数据类型都属于纯量</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1 字符串 布尔值 整数 浮点数 Null</span><br><span class="line">2 时间 日期</span><br><span class="line"></span><br><span class="line">数值直接以变量的形式表示</span><br><span class="line">number: 12.30</span><br><span class="line"></span><br><span class="line">布尔值使用true和false表示</span><br><span class="line">isSet: true</span><br><span class="line"></span><br><span class="line">null用 ~ 表示</span><br><span class="line">parent: ~</span><br><span class="line"></span><br><span class="line">时间采用 ISO8601 格式</span><br><span class="line">iso8601: 2022-11-30t09:27:34.10-05:00</span><br><span class="line"></span><br><span class="line">日期采用复合 iso8601 格式的年、月、日表示</span><br><span class="line">date: 2022-11-30</span><br><span class="line"></span><br><span class="line">YAML 允许使用两个感叹号，强制转换数据类型</span><br><span class="line">e: !!str 123</span><br><span class="line">f: !!str true</span><br></pre></td></tr></table></figure>

<h2 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h2><p><strong>字符串默认不使用引号表示</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">str: 这是一行字符串</span><br></pre></td></tr></table></figure>

<p><strong>如果字符串之中包含空格或特殊字符，需要放在引号之中</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">str: &#x27;内容\n字符串&#x27;</span><br></pre></td></tr></table></figure>

<p><strong>单引号和双引号都可以使用，双引号不会对特殊字符转义</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">s1: &#x27;内容\n字符串&#x27;</span><br><span class="line">s2: &#x27;内容\n字符串&#x27;</span><br></pre></td></tr></table></figure>

<p><strong>单引号之中如果还有单引号，必须连续使用两个单引号转义</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">str: &#x27;labor&#x27;&#x27;s day&#x27;</span><br></pre></td></tr></table></figure>

<p><strong>字符串可以写成多行，从第二行开始，必须有一个单空格缩进。换行符会被转为空格</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">str: 这是一段</span><br><span class="line">  多行</span><br><span class="line">  字符串</span><br></pre></td></tr></table></figure>

<p><strong>多行字符串可以使用|保留换行符，也可以使用&gt;折叠换行</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">this: |</span><br><span class="line">Foo</span><br><span class="line">Bar</span><br><span class="line">that: &gt;</span><br><span class="line">Foo</span><br><span class="line">Bar</span><br></pre></td></tr></table></figure>

<p><strong>+ 表示保留文字块末尾的换行，- 表示删除字符串末尾的换行</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">s1: |</span><br><span class="line">  Foo</span><br><span class="line">s2: |+</span><br><span class="line">  Foo</span><br><span class="line">s3: |-</span><br><span class="line">  Foo</span><br></pre></td></tr></table></figure>

<h1 id="常用字段解释说明"><a href="#常用字段解释说明" class="headerlink" title="常用字段解释说明"></a>常用字段解释说明</h1><table>
<thead>
<tr>
<th>参数名</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>version</td>
<td>String</td>
<td>这里指的是K8S API的版本，目前基本上是v1，可以使用kubectl  api-version 命令查询</td>
</tr>
<tr>
<td>kind</td>
<td>String</td>
<td>这里指的是yaml文件定义的资源类型和角色，比如：Pod</td>
</tr>
<tr>
<td>metadata</td>
<td>Object</td>
<td>元数据类型，固定值就写metadata</td>
</tr>
<tr>
<td>metadata.name</td>
<td>String</td>
<td>元数据对象的名字，这里由我们编写，比如命名Pod的名字</td>
</tr>
<tr>
<td>metadata.name</td>
<td>String</td>
<td>元数据对象的命名空间，由我们自身定义</td>
</tr>
<tr>
<td>Spec</td>
<td>Object</td>
<td>详细定义对象，固定值就写Spec</td>
</tr>
<tr>
<td>spec.containers[]</td>
<td>list</td>
<td>这里是Spec对象的容器列表定义，是个列表</td>
</tr>
<tr>
<td>spec.containers[].name</td>
<td>String</td>
<td>这里定义容器的名字</td>
</tr>
<tr>
<td>spec.containers[].image</td>
<td>String</td>
<td>这里定义要用到的镜像名称</td>
</tr>
<tr>
<td>spec.containers[].imagePullPolicy</td>
<td>String</td>
<td>定义镜像拉取策略，有Always、Never、IfNotPresent三个值可选（1）Always：意思是每次尝试重新拉取镜像（2）Never：表示仅适用本地镜像（3）IfNotPresent：如果本地有镜像就使用本地镜像，没有就拉取在线镜像。上面三个值都没设置的话，默认是Always。</td>
</tr>
<tr>
<td>spec.containers[].command[]</td>
<td>List</td>
<td>指定容器启动的命令，因为是数组可以指定多个，不指定则使用镜像打包时使用的启动命令。</td>
</tr>
<tr>
<td>spec.containers[].args[]</td>
<td>List</td>
<td>指定容器启动命令参数，因为是数组可以指定多个。</td>
</tr>
<tr>
<td>spec.containers[].workingDir</td>
<td>String</td>
<td>指定容器的工作目录</td>
</tr>
<tr>
<td>spec.containers[].volumeMounts[]</td>
<td>List</td>
<td>指定容器内部的存储卷配置</td>
</tr>
<tr>
<td>spec.containers[].volumeMounts[].name</td>
<td>String</td>
<td>指定可以被容器挂载的存储卷的名称</td>
</tr>
<tr>
<td>spec.containers[].volumeMounts[].mountPath</td>
<td>String</td>
<td>指定可以被容器挂载的存储卷的路径</td>
</tr>
<tr>
<td>spec.containers[].volumeMounts[].readOnly</td>
<td>String</td>
<td>设置存储卷路径的读写模式，true或者false，默认为读写模式</td>
</tr>
<tr>
<td>spec.containers[].ports[]</td>
<td>List</td>
<td>指定容器需要用到的端口列表</td>
</tr>
<tr>
<td>spec.containers[].ports[].name</td>
<td>String</td>
<td>指定端口名称</td>
</tr>
<tr>
<td>spec.containers[].ports[].containerPort</td>
<td>String</td>
<td>指定容器需要监听的端口号</td>
</tr>
<tr>
<td>spec.containers[].ports[].hostPort</td>
<td>String</td>
<td>指定容器所在主机需要监听的端口号，默认跟上面containerPort相同，注意设置了hostPort同一台主机无法启动该容器的相同副本（因为主机的端口号不能相同，这样会冲突）</td>
</tr>
<tr>
<td>spec.containers[].ports[].protocol</td>
<td>String</td>
<td>指定端口协议，支持TCP和UDP，默认值为TCP</td>
</tr>
<tr>
<td>spec.containers[].env[]</td>
<td>List</td>
<td>指定容器运行前需设置的环境变量列表</td>
</tr>
<tr>
<td>spec.containers[].env[].name</td>
<td>String</td>
<td>指定环境变量名称</td>
</tr>
<tr>
<td>spec.containers[].env[].value</td>
<td>String</td>
<td>指定环境变量值</td>
</tr>
<tr>
<td>spec.containers[].resources</td>
<td>Object</td>
<td>指定资源限制和资源请求的值（这里开始就是设置容器的资源上限）</td>
</tr>
<tr>
<td>spec.containers[].resources.limits</td>
<td>Object</td>
<td>指定设置容器运行时资源的上限</td>
</tr>
<tr>
<td>spec.containers[].resources.limits.cpu</td>
<td>String</td>
<td>指定CPU的限制，单位为core数，将用于docker run  –cpu-shares参数（这里前面文章Pod资源限制有讲过）</td>
</tr>
<tr>
<td>spec.containers[].resources.limits.memory</td>
<td>String</td>
<td>指定MEM内存的限制，单位为MiB，GiB</td>
</tr>
<tr>
<td>spec.containers[].resources.requests</td>
<td>Object</td>
<td>指定容器启动和调度时的限制设置</td>
</tr>
<tr>
<td>spec.containers[].resources.requests.cpu</td>
<td>String</td>
<td>CPU请求，单位为core数，容器启动时初始化可用数量</td>
</tr>
<tr>
<td>spec.containers[].resources.requests.memory</td>
<td>String</td>
<td>内存请求，单位为MiB、GiB，容器启动的初始化可用数量</td>
</tr>
<tr>
<td>spec.restartPolicy</td>
<td>String</td>
<td>定义Pod的重启策略，可选值为Always、OnFailure，默认值为Always。 1.Always：Pod一旦终止运行，则无论容器是如何终止的，kubelet服务都将重启它。  2.OnFailure：只有Pod以非零退出码终止时，kubelet才会重启该容器。如果容器正常退结束（退出码为0），则kubelet将不会重启它。  3.Never：Pod终止后，kubelet将退出码报告给Master，不会重启该Pod。</td>
</tr>
<tr>
<td>spec.nodeSelector</td>
<td>Object</td>
<td>定义Node的Label的过滤标签，以key:value格式指定</td>
</tr>
<tr>
<td>spec.imagePullSecrets</td>
<td>Object</td>
<td>定义pull镜像时使用secret名称，以name:secretkey格式指定</td>
</tr>
<tr>
<td>spec.hostNetwork</td>
<td>Boolean</td>
<td>定义是否使用主机网络模式，默认值为false。设置true表示使用宿主机网络，不使用docker网桥，同时设置了true将无法在同一台宿主机上启动第二个副本。</td>
</tr>
</tbody></table>
<p>查看相关参数</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubectl explain pod</span><br><span class="line">kubectl explain pod.spec</span><br><span class="line">kubectl explain pod.spec.containers</span><br></pre></td></tr></table></figure>

<p>示例</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@k8s-master ~]# cat mypod.yml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: myapp-pod</span><br><span class="line">  labels:</span><br><span class="line">    app: myapp</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: app</span><br><span class="line">    image: nginx:latest</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl create -f mypod.yml </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>常用命令</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#查看pod启动情况</span><br><span class="line">kubectl get pod -owide</span><br><span class="line">#查看pod描述信息</span><br><span class="line">kubectl describe po myapp-pod</span><br><span class="line">#查看pod日志</span><br><span class="line">kubectl logs myapp-pod</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>DevOps</category>
      </categories>
      <tags>
        <tag>Kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title>Redis安装</title>
    <url>/arlo/c9f6f059/</url>
    <content><![CDATA[<h1 id="安装redis"><a href="#安装redis" class="headerlink" title="安装redis"></a>安装redis</h1><p>官网下载链接：<a href="https://download.redis.io/releases/">https://download.redis.io/releases/</a></p>
<h2 id="安装基础环境"><a href="#安装基础环境" class="headerlink" title="安装基础环境"></a>安装基础环境</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 安装基础环境</span><br><span class="line">yum -y install gcc wget</span><br><span class="line">cd /usr/local/src/</span><br><span class="line"># 下载redis</span><br><span class="line">wget https://download.redis.io/releases/redis-6.2.6.tar.gz</span><br><span class="line">tar xf redis-6.2.6.tar.gz -C /usr/local/</span><br><span class="line">cd /usr/local/redis-6.2.6/</span><br><span class="line"># 编译安装redis</span><br><span class="line">make</span><br><span class="line">make PREFIX=/usr/local/redis-6.2.6 install</span><br><span class="line"># 修改内核参数</span><br><span class="line">echo &quot;vm.overcommit_memory=1&quot; &gt;&gt; /etc/sysctl.conf</span><br><span class="line">echo &quot;net.core.somaxconn = 1024&quot; &gt;&gt; /etc/sysctl.conf </span><br><span class="line">sysctl -p</span><br><span class="line">echo &quot;* soft nofile 10240&quot; &gt;&gt; /etc/security/limits.conf</span><br><span class="line">echo &quot;* hard nofile 10240&quot; &gt;&gt; /etc/security/limits.conf</span><br></pre></td></tr></table></figure>

<h1 id="常用配置项"><a href="#常用配置项" class="headerlink" title="常用配置项"></a>常用配置项</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /usr/local/redis-6.2.6/redis.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 监听地址，默认是127.0.0.1，不允许其他机器访问</span><br><span class="line">bind 192.168.6.143</span><br><span class="line"># 监听端口</span><br><span class="line">port 6379</span><br><span class="line"># 后台启动</span><br><span class="line">daemonize yes</span><br><span class="line"># 设置redis密码</span><br><span class="line">requirepass  n9zxcCynQy#j4du</span><br></pre></td></tr></table></figure>

<h1 id="启动redis"><a href="#启动redis" class="headerlink" title="启动redis"></a>启动redis</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/usr/local/redis-6.2.6/bin/redis-server /usr/local/redis-6.2.6/redis.conf</span><br><span class="line"># 配置开机自启动</span><br><span class="line">echo &quot;/usr/local/redis-6.2.6/bin/redis-server /usr/local/redis-6.2.6/redis.conf&quot; &gt;&gt; /etc/rc.d/rc.local</span><br><span class="line">chmod +x /etc/rc.d/rc.local</span><br></pre></td></tr></table></figure>

<h1 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#当前数据库的 key 的数量</span><br><span class="line">dbsize</span><br><span class="line">#查看所有key值</span><br><span class="line">keys *</span><br><span class="line">#切换数据库（默认有16个库，0-15）</span><br><span class="line">select 1</span><br><span class="line">---</span><br><span class="line"># 新建key</span><br><span class="line">set  keyname  “要设置的key的value”</span><br><span class="line"># 查看key的value</span><br><span class="line">get  keyname </span><br><span class="line"># 删除key</span><br><span class="line">del  keyname   </span><br></pre></td></tr></table></figure>

<h1 id="清理缓存"><a href="#清理缓存" class="headerlink" title="清理缓存"></a>清理缓存</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 清空当前数据库的所有key</span><br><span class="line">flushdb</span><br><span class="line">#清空整个Redis服务器的所有数据</span><br><span class="line">flushall</span><br></pre></td></tr></table></figure>

<p>参考：<a href="https://mp.weixin.qq.com/s/fm2DgRgQsTlAfOuBbOz31g">https://mp.weixin.qq.com/s/fm2DgRgQsTlAfOuBbOz31g</a></p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>redis</tag>
      </tags>
  </entry>
  <entry>
    <title>Win10无法访问Samba服务器匿名共享</title>
    <url>/arlo/80f4a5c/</url>
    <content><![CDATA[<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>办公室搬家后，samba服务器配置的匿名共享无法访问，提示要输入用户名密码，配置如下：</p>
<span id="more"></span>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@siluxa2 ~]# egrep -v &quot;^$|#&quot; /etc/samba/smb.conf</span><br><span class="line">[global]</span><br><span class="line">	workgroup = WORKGROUP</span><br><span class="line">	security = user</span><br><span class="line">    map to guest = Bad User</span><br><span class="line">	passdb backend = tdbsam</span><br><span class="line">	printing = cups</span><br><span class="line">	printcap name = cups</span><br><span class="line">	load printers = yes</span><br><span class="line">	cups options = raw</span><br><span class="line">[Tools]</span><br><span class="line">        comment = share all</span><br><span class="line">        path = /data/Tools</span><br><span class="line">        browseable = yes</span><br><span class="line">        public = yes</span><br><span class="line">        writable = yes</span><br><span class="line">	    guest ok = yes</span><br></pre></td></tr></table></figure>

<h1 id="网上方法"><a href="#网上方法" class="headerlink" title="网上方法"></a>网上方法</h1><p>查看服务器配置也没有什么问题，在电脑上试了就是不行，在其他电脑（win7&#x2F;win11&#x2F;win2012server）上是没有问题的，在网上查找的解决方案如下：</p>
<ol>
<li>控制面板-启用或关闭Windows功能-勾选安装“SMB 1.0&#x2F;CIFS 文件共享支持”和“SMB”直通</li>
<li>开始-运行-输入gpedit.msc，打开本地策略，计算机配置-管理模板-网络-Lanman工作站-启用不安全的来宾登录“(已启用)”</li>
</ol>
<p>上述两个方式都不能解决我的问题，大家有问题可以试试。</p>
<h1 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h1><ol>
<li>打开注册表编辑器，找到 <code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters</code></li>
<li>右边新建一个<code>AllowInsecureGuestAuth</code>项，类型为DWORD，双击打开将数值改为<code>1</code>即可</li>
<li>无需重启电脑，再次尝试访问SMB服务器，已经可以正常使用</li>
</ol>
]]></content>
      <categories>
        <category>Troubleshooting</category>
      </categories>
      <tags>
        <tag>samba</tag>
      </tags>
  </entry>
  <entry>
    <title>curl: (56) Recv failure: Connection reset by peer</title>
    <url>/arlo/f27e05ab/</url>
    <content><![CDATA[<p>项目之前跑着一直都很正常，突然获取不到数据了，换了几个不同的网络进行测试，现象为：浏览器可以正常访问获取数据，curl命令行测试报错“curl: (56) Recv failure: Connection reset by peer”，程序无法正常获取数据。</p>
<span id="more"></span>

<p>程序后台报错日志</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">2022-05-10 00:16:00.064 [ RenrenScheduler_Worker-4 ] - [ ERROR ] [ io.renren.utils.ScheduleJob : 64 ] - 任务执行失败，任务ID：1487708039686402049</span><br><span class="line">java.lang.reflect.InvocationTargetException: null</span><br><span class="line">        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</span><br><span class="line">        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">        at java.lang.reflect.Method.invoke(Method.java:498)</span><br><span class="line">        at io.renren.utils.ScheduleJob.executeInternal(ScheduleJob.java:54)</span><br><span class="line">        at org.springframework.scheduling.quartz.QuartzJobBean.execute(QuartzJobBean.java:75)</span><br><span class="line">        at org.quartz.core.JobRunShell.run(JobRunShell.java:202)</span><br><span class="line">        at org.quartz.simpl.SimpleThreadPool$WorkerThread.run(SimpleThreadPool.java:573)</span><br><span class="line">Caused by: feign.FeignException$InternalServerError: [500 ] during [GET] to [http://renren-biz-server/biz/syn/weather/hour] [BizFeignClient#getWeatherRegionHourList(Map)]: [&#123;&quot;timestamp&quot;:1652112960062,&quot;status&quot;:500,&quot;error&quot;:&quot;Internal Server Error&quot;,&quot;message&quot;:&quot;&quot;,&quot;path&quot;:&quot;/biz/syn/weather/hour&quot;&#125;]</span><br><span class="line">        at feign.FeignException.serverErrorStatus(FeignException.java:231)</span><br><span class="line">        at feign.FeignException.errorStatus(FeignException.java:180)</span><br><span class="line">        at feign.FeignException.errorStatus(FeignException.java:169)</span><br><span class="line">        at feign.codec.ErrorDecoder$Default.decode(ErrorDecoder.java:92)</span><br><span class="line">        at feign.AsyncResponseHandler.handleResponse(AsyncResponseHandler.java:96)</span><br><span class="line">        at feign.SynchronousMethodHandler.executeAndDecode(SynchronousMethodHandler.java:138)</span><br><span class="line">        at feign.SynchronousMethodHandler.invoke(SynchronousMethodHandler.java:89)</span><br><span class="line">        at com.alibaba.cloud.sentinel.feign.SentinelInvocationHandler.invoke(SentinelInvocationHandler.java:109)</span><br><span class="line">        at com.sun.proxy.$Proxy142.getWeatherRegionHourList(Unknown Source)</span><br><span class="line">        at io.renren.task.WeatherHourTask.run(WeatherHourTask.java:26)</span><br><span class="line">        ... 8 common frames omitted</span><br><span class="line">2022-05-10 00:16:00.064 [ RenrenScheduler_Worker-4 ] - [ ERROR ] [ io.renren.utils.Sched</span><br></pre></td></tr></table></figure>

<p>curl 测试报错</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">--GET</span><br><span class="line">[root@siluxa2 ~]# curl “http://x.x.x.x/china/monitor/city-hour?pollute=AQI&amp;monitorTime=2022-05-09+14”</span><br><span class="line">curl: (56) Recv failure: Connection reset by peer</span><br><span class="line">--POST</span><br><span class="line">[root@siluxa2 ~]# curl -d &quot;pollute=AQI&amp;monitorTime=2022-05-09+14&quot; http://x.x.x.x/china/monitor/city-hour</span><br><span class="line">curl: (56) Recv failure: Connection reset by peer</span><br></pre></td></tr></table></figure>

<p>调整过系统最大链接数，调整过系统最大打开文件数，优化过请求响应时间都未能解决这个问题。</p>
<p>经过多次不同的网络环境，不同的服务器进行测试，可能是因为数据获取太频繁，被网络完全设备判断为爬虫行为进行控制了，尝试添加一个useragent</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">curl  -A &quot;User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.103 Safari/537.36&quot; &quot;http://x.x.x.x/china/monitor/city-hour?pollute=AQI&amp;monitorTime=2022-05-09+14&quot;</span><br><span class="line"></span><br><span class="line">&#123;&quot;code&quot;:0,&quot;msg&quot;:&quot;success&quot;,&quot;data&quot;:[&#123;&quot;regionCode&quot;:&quot;110000&quot;,&quot;regionName&quot;:&quot;北京市&quot;,&quot;monitorTime&quot;:&quot;2022-05-09 14&quot;,&quot;lon&quot;:&quot;116.346777&quot;,&quot;lat&quot;:&quot;40.064715&quot;,&quot;primePollute&quot;:&quot;—&quot;,&quot;aqi&quot;:33,&quot;pm10&quot;:19,&quot;no2&quot;:8,&quot;o3&quot;:104,&quot;so2&quot;:2,&quot;co&quot;:0.3,&quot;aqiLevelName&quot;:&quot;优&quot;,&quot;aqiLevel&quot;:1,&quot;pm10Level&quot;:1,&quot;pm25Level&quot;:1,&quot;o3Level&quot;:1,&quot;no2Level&quot;:1,&quot;so2Level&quot;:1,&quot;coLevel&quot;:1,&quot;pcpn&quot;:0.0,&quot;hum&quot;:47,&quot;tmp&quot;:17,&quot;tmpLevel&quot;:3,&quot;pres&quot;:1016,&quot;windDir&quot;:&quot;西南风&quot;,&quot;windDeg&quot;:225,&quot;windSpd&quot;:18.0,&quot;windLevel&quot;:3,&quot;pm2_5&quot;:10&#125;</span><br><span class="line">……</span><br></pre></td></tr></table></figure>

<p>至此，总算是找到原因了，在程序中添加一个useragent应该就可以解决掉这个问题了。</p>
<p>ps：顺便推荐几个工具tcping，pathping，httping，psping</p>
]]></content>
      <categories>
        <category>Troubleshooting</category>
      </categories>
      <tags>
        <tag>Troubleshooting</tag>
      </tags>
  </entry>
  <entry>
    <title>shell学习笔记-I</title>
    <url>/arlo/80ba4bc2/</url>
    <content><![CDATA[<h1 id="设置shell打印内容颜色"><a href="#设置shell打印内容颜色" class="headerlink" title="设置shell打印内容颜色"></a>设置shell打印内容颜色</h1><p>设置颜色 前景色31-36，后景色41-46</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">echo -e &quot;\e[1;31mThis is a red text.\e[0m&quot;</span><br></pre></td></tr></table></figure>

<p>恢复颜色</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">echo -e &quot;\e[0m&quot;</span><br></pre></td></tr></table></figure>

<p><strong>使用调试模式运行脚本 bash -vx test.sh</strong></p>
<span id="more"></span>

<h1 id="Ping-测试"><a href="#Ping-测试" class="headerlink" title="Ping 测试"></a>Ping 测试</h1><p><code>ping -c1 192.168.6.131 &amp;&amp; echo &quot;192.168.6.131 is up&quot; || echo &quot;192.168.6.131 is down&quot;</code><br><code>ping -c1 192.168.6.131 &amp;&gt; /dev/null &amp;&amp; echo &quot;192.168.6.131 is up&quot; || echo &quot;192.168.6.131 is down&quot;</code></p>
<h2 id="示例1"><a href="#示例1" class="headerlink" title="示例1"></a>示例1</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">ip=192.168.6.151</span><br><span class="line">ping -c1 $ip &amp;&gt; /dev/null &amp;&amp; echo -e &quot;\e[1;32m$ip is up\e[0m&quot; || echo -e &quot;\e[1;31m$ip is down\e[0m&quot;</span><br></pre></td></tr></table></figure>

<h2 id="示例2"><a href="#示例2" class="headerlink" title="示例2"></a>示例2</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/usr/bin/bash</span><br><span class="line">ip=192.168.6.144</span><br><span class="line">ping -c1 $ip &amp;&gt; /dev/null</span><br><span class="line">if [ $? -eq 0 ];then</span><br><span class="line">	echo &quot;$ip is up&quot;</span><br><span class="line">else</span><br><span class="line">	echo &quot;$ip is down&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<h2 id="示例3"><a href="#示例3" class="headerlink" title="示例3"></a>示例3</h2><p>交互式输入</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/usr/bin/bash</span><br><span class="line">read -p &quot;Please input ip address: &quot; ip</span><br><span class="line">ping -c1 $ip &amp;&gt; /dev/null</span><br><span class="line">if [ $? -eq 0 ];then</span><br><span class="line">        echo &quot;$ip is up&quot;</span><br><span class="line">else</span><br><span class="line">        echo &quot;$ip is down&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<h2 id="示例4"><a href="#示例4" class="headerlink" title="示例4"></a>示例4</h2><p>使用位置变量</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/usr/bin/bash</span><br><span class="line">ping -c1 $1 &amp;&gt; /dev/null</span><br><span class="line">if [ $? -eq 0 ];then</span><br><span class="line">	echo &quot;$1 is up&quot;</span><br><span class="line">else</span><br><span class="line">	echo &quot;$1 is down&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<h2 id="示例5"><a href="#示例5" class="headerlink" title="示例5"></a>示例5</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">#如果用户没加参数，提示并退出</span><br><span class="line">if [ $# -eq 0 ];then</span><br><span class="line">    echo &quot;usage: `basename $0` file&quot;</span><br><span class="line">    exit</span><br><span class="line">fi</span><br><span class="line">#判断第一个参数是否为文件</span><br><span class="line">if [ ! -f $1 ];then</span><br><span class="line">  echo &quot;error file!&quot;</span><br><span class="line">  exit</span><br><span class="line">fi</span><br><span class="line">#判断ip地址是否能ping通并提示</span><br><span class="line">for ip in `cat $1`</span><br><span class="line">do</span><br><span class="line">    ping -c1 $ip &amp;&gt;/dev/null</span><br><span class="line">    if [ $? -eq 0 ];then</span><br><span class="line">        echo &quot;$ip is up.&quot;</span><br><span class="line">    else</span><br><span class="line">        echo &quot;$ip is down.&quot;</span><br><span class="line">    fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h2 id="示例6"><a href="#示例6" class="headerlink" title="示例6"></a>示例6</h2><p>使用i++</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">ip=192.168.6.131</span><br><span class="line"></span><br><span class="line">i=1</span><br><span class="line">while [ $i -le 5 ]</span><br><span class="line">do</span><br><span class="line">    ping -c1 $ip &amp;&gt;/dev/null</span><br><span class="line">    if [ $? -eq 0 ];then</span><br><span class="line">        echo &quot;$ip is up...&quot;</span><br><span class="line">    fi</span><br><span class="line">    let i++</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h1 id="变量的赋值方式"><a href="#变量的赋值方式" class="headerlink" title="变量的赋值方式"></a>变量的赋值方式</h1><h2 id="显式赋值"><a href="#显式赋值" class="headerlink" title="显式赋值"></a>显式赋值</h2><p>示例</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ip1=192.168.1.251</span><br><span class="line">school=&quot;BeiJing 1000phone&quot;</span><br><span class="line">today1=`date +%F`</span><br><span class="line">today2=$(date +%F)</span><br></pre></td></tr></table></figure>

<h2 id="read-从键盘读入变量值"><a href="#read-从键盘读入变量值" class="headerlink" title="read 从键盘读入变量值"></a>read 从键盘读入变量值</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-p 提示信息</span><br><span class="line">-t 等待时间</span><br><span class="line">-n 字符个数</span><br><span class="line"></span><br><span class="line">read 变量名</span><br><span class="line">read -p &quot;提示信息：&quot;变量名</span><br><span class="line">read -t 5 -p &quot;提示信息:&quot; 变量名</span><br><span class="line">read -n 2 变量名</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">read -p &quot;请输入姓名,性别,年龄[e.g. zhangsan m 34]: &quot; name sex age</span><br><span class="line">echo &quot;您输入的姓名: $name,性别: $sex,年龄: $age&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&quot; &quot; 弱引用</span><br><span class="line">&#x27; &#x27; 强引用</span><br><span class="line">` ` 命令替换 等价于$() 反引号中的shell命令会被优先执行</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">name=&quot;james&quot;</span><br><span class="line">boy=&quot;$name is good.&quot;;echo $boy</span><br><span class="line">boy=&#x27;$name is good.&#x27;;echo $boy</span><br></pre></td></tr></table></figure>

<h1 id="变量的运算"><a href="#变量的运算" class="headerlink" title="变量的运算"></a>变量的运算</h1><h2 id="整数运算"><a href="#整数运算" class="headerlink" title="整数运算"></a>整数运算</h2><h3 id="方法一：expr"><a href="#方法一：expr" class="headerlink" title="方法一：expr"></a>方法一：expr</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">expr $num1 + $num2	+ - \* / %</span><br><span class="line">expr 1 + 2</span><br></pre></td></tr></table></figure>

<h3 id="方法二："><a href="#方法二：" class="headerlink" title="方法二：$(())"></a>方法二：$(())</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">echo $(($num1+$num2))  + - \* / %</span><br><span class="line">echo $((1+2))</span><br></pre></td></tr></table></figure>

<h4 id="方法三："><a href="#方法三：" class="headerlink" title="方法三：$[]"></a>方法三：$[]</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">echo $[$num1+$num2]	+ - \* / %</span><br><span class="line">echo $[5*2]</span><br></pre></td></tr></table></figure>

<h4 id="方法四：let"><a href="#方法四：let" class="headerlink" title="方法四：let"></a>方法四：let</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">let sum=2+3;echo $sum</span><br><span class="line">let i++;echo $i</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">i=1</span><br><span class="line">j=1</span><br><span class="line">let x=i++ 先赋值，再运算</span><br><span class="line">let y=++j 先运算，再赋值</span><br></pre></td></tr></table></figure>

<p>示例：查看当前内存使用率</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">mem_used=`free -m |grep &#x27;^Mem&#x27;|awk &#x27;&#123; print $3&#125;&#x27;`</span><br><span class="line">mem_total=`free -m |grep &#x27;^Mem&#x27;|awk &#x27;&#123; print $2&#125;&#x27;`</span><br><span class="line">mem_percent=$((mem_used*100/mem_total))</span><br><span class="line">echo &quot;当前内存使用率为：&quot; $mem_percent</span><br></pre></td></tr></table></figure>

<p><strong>使用调试模式运行脚本 bash -vx mem_usage.sh</strong></p>
<h2 id="小数运算"><a href="#小数运算" class="headerlink" title="小数运算"></a>小数运算</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">echo &quot;scale=2;6/4&quot; |bc</span><br><span class="line"></span><br><span class="line">awk &#x27;BEGIN&#123;print 1/3&#125;&#x27;</span><br></pre></td></tr></table></figure>

<h1 id="变量“内容”的删除和替换"><a href="#变量“内容”的删除和替换" class="headerlink" title="变量“内容”的删除和替换"></a>变量“内容”的删除和替换</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@sx3_app2 script]# url=www.islocal.cc</span><br><span class="line">打印变量</span><br><span class="line">[root@sx3_app2 script]# echo $&#123;url&#125;</span><br><span class="line">www.islocal.cc</span><br><span class="line">打印变量长度</span><br><span class="line">[root@sx3_app2 script]# echo $&#123;#url&#125;</span><br><span class="line">14</span><br><span class="line">从前往后删除，删到第一个.</span><br><span class="line">[root@sx3_app2 script]# echo $&#123;url#*.&#125;</span><br><span class="line">islocal.cc</span><br><span class="line">从前往后删除，删到最后一个.</span><br><span class="line">[root@sx3_app2 script]# echo $&#123;url##*.&#125;</span><br><span class="line">cc</span><br><span class="line">从后往前删除，删到第一个.</span><br><span class="line">[root@sx3_app2 script]# echo $&#123;url%.*&#125;</span><br><span class="line">www.islocal</span><br><span class="line">从后往前删除，删到最后一个.</span><br><span class="line">[root@sx3_app2 script]# echo $&#123;url%%.*&#125;</span><br><span class="line">www</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">索引及切片</span><br><span class="line">索引切片从0开始</span><br><span class="line">[root@sx3_app2 script]# echo $&#123;url:4&#125;</span><br><span class="line">islocal.cc</span><br><span class="line">[root@sx3_app2 script]# echo $&#123;url:4:7&#125;</span><br><span class="line">islocal</span><br><span class="line"></span><br><span class="line">替换</span><br><span class="line">[root@sx3_app2 script]# echo $&#123;url/cc/com&#125;</span><br><span class="line">www.islocal.com</span><br><span class="line"></span><br><span class="line">$&#123;变量名-新的变量值&#125;</span><br><span class="line">变量没有被赋值：会使用“新的变量值”替代</span><br><span class="line">变量有被赋值（包括空值）：不会被替代</span><br><span class="line">[root@sx3_app2 script]# var1=111</span><br><span class="line">[root@sx3_app2 script]# var2=</span><br><span class="line">[root@sx3_app2 script]# echo $&#123;var1&#125;</span><br><span class="line">111</span><br><span class="line">[root@sx3_app2 script]# echo $&#123;var2&#125;</span><br><span class="line"></span><br><span class="line">[root@sx3_app2 script]# echo $&#123;var3&#125;</span><br><span class="line"></span><br><span class="line">[root@sx3_app2 script]# echo $&#123;var1-222&#125;</span><br><span class="line">111</span><br><span class="line">[root@sx3_app2 script]# echo $&#123;var2-222&#125;</span><br><span class="line"></span><br><span class="line">[root@sx3_app2 script]# echo $&#123;var3-222&#125;</span><br><span class="line">222</span><br><span class="line"></span><br><span class="line">$&#123;变量名:-新的变量值&#125;  </span><br><span class="line">变量没有被赋值（包括空值）：会使用“新的变量值”替代</span><br><span class="line">变量有被赋值：不会被替代</span><br><span class="line">[root@sx3_app2 script]# unset var1</span><br><span class="line">[root@sx3_app2 script]# unset var2</span><br><span class="line">[root@sx3_app2 script]# unset var3</span><br><span class="line">[root@sx3_app2 script]# var1=aaa</span><br><span class="line">[root@sx3_app2 script]# var2=</span><br><span class="line">[root@sx3_app2 script]# echo $&#123;var1&#125;</span><br><span class="line">aaa</span><br><span class="line">[root@sx3_app2 script]# echo $&#123;var2&#125;</span><br><span class="line"></span><br><span class="line">[root@sx3_app2 script]# echo $&#123;var3&#125;</span><br><span class="line"></span><br><span class="line">[root@sx3_app2 script]# echo $&#123;var1:-bbb&#125;</span><br><span class="line">aaa</span><br><span class="line">[root@sx3_app2 script]# echo $&#123;var2:-bbb&#125;</span><br><span class="line">bbb</span><br><span class="line">[root@sx3_app2 script]# echo $&#123;var3:-bbb&#125;</span><br><span class="line">bbb</span><br></pre></td></tr></table></figure>

<h1 id="shell条件测试"><a href="#shell条件测试" class="headerlink" title="shell条件测试"></a>shell条件测试</h1><p>man test<br>格式1：test 条件表达式<br><code>test -d /home</code><br>格式2：[ 条件表达式 ]<br><code>[ -d /home ]</code><br>格式3：[[ 条件表达式 ]]</p>
<h2 id="文件比较"><a href="#文件比较" class="headerlink" title="文件比较"></a>文件比较</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[ -e file|dir ] 是否为文件/目录</span><br><span class="line">[ -f file ] 是否存在，而且是文件</span><br><span class="line">[ -d dir ] 是否为目录</span><br><span class="line">[ -r file ] 当前用户是否有读取权限</span><br><span class="line">[ -w file ] 当前用户是否有写入权限</span><br><span class="line">[ -x file ] 当前用户是否有执行权限</span><br><span class="line">[ -L file ] 是否为链接文件</span><br><span class="line">[ -b file ] 是否为块设备</span><br><span class="line">[ -c file ] 是否为字符</span><br></pre></td></tr></table></figure>

<h2 id="数值比较"><a href="#数值比较" class="headerlink" title="数值比较"></a>数值比较</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-eq 等于（equal） </span><br><span class="line">-ne 不等于（not equal）</span><br><span class="line">-lt 小于（less than） </span><br><span class="line">-le 小于等于（less equal）</span><br><span class="line">-gt 大于（greater than） </span><br><span class="line">-ge 大于等于（greater equal）</span><br></pre></td></tr></table></figure>

<h2 id="字符串比较"><a href="#字符串比较" class="headerlink" title="字符串比较"></a>字符串比较</h2><p>两个字符串之间的比较，用等号“&#x3D;”判断相等，用“!&#x3D;”判断不等</p>
<h2 id="NF-表示倒数"><a href="#NF-表示倒数" class="headerlink" title="NF 表示倒数"></a>NF 表示倒数</h2><p><code>df -Th |grep &#39;/$&#39; |awk &#39;&#123;print $(NF-1)&#125;&#39;</code></p>
<h1 id="特殊符号运用"><a href="#特殊符号运用" class="headerlink" title="特殊符号运用"></a>特殊符号运用</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">()		子shell中执行</span><br><span class="line">(())	数值比较，运算C语言</span><br><span class="line">$()		命令替换 和``一样</span><br><span class="line">$(())	整数运算</span><br><span class="line"></span><br><span class="line">&#123;&#125;		集合</span><br><span class="line">$&#123;&#125;		变量的引用、替换</span><br><span class="line"></span><br><span class="line">[]		条件测试</span><br><span class="line">[[]]	条件测试，支持正则=~</span><br><span class="line">$[]		整数运算</span><br></pre></td></tr></table></figure>



<h2 id="创建用户脚本"><a href="#创建用户脚本" class="headerlink" title="创建用户脚本"></a>创建用户脚本</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">######################################</span><br><span class="line"># Name: useradd01.sh                 # </span><br><span class="line"># Date: 2022/7/20                    #</span><br><span class="line"># Author: Arlo                       #</span><br><span class="line">######################################</span><br><span class="line"></span><br><span class="line">read -p &quot;Please input number: &quot; num</span><br><span class="line"></span><br><span class="line">while true</span><br><span class="line">do</span><br><span class="line">#判断用户输入的是否为数字</span><br><span class="line">        if  [[ $num =~ ^[0-9]+$ ]];then</span><br><span class="line">            break</span><br><span class="line">        else</span><br><span class="line">            read -p &quot;Please input number again: &quot; num</span><br><span class="line">        fi</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">read -p &quot;please input prefix: &quot; prefix</span><br><span class="line">while true</span><br><span class="line">do</span><br><span class="line">        if [ -n &quot;$prefix&quot; ];then</span><br><span class="line">            break</span><br><span class="line">        else</span><br><span class="line">            read -p &quot;please input prefix again: &quot; prefix</span><br><span class="line">        fi</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">for i in `seq $num`</span><br><span class="line">do</span><br><span class="line">    user=$prefix$i</span><br><span class="line">    useradd $user</span><br><span class="line">    echo &quot;123&quot; | passwd --stdin $user &amp;&gt;/dev/null</span><br><span class="line">    if [ $? -eq 0 ];then</span><br><span class="line">        echo &quot;$user is created.&quot;</span><br><span class="line">    fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure>



<p>学习链接：<a href="https://www.bilibili.com/video/BV19t411s7Jx">https://www.bilibili.com/video/BV19t411s7Jx</a></p>
]]></content>
  </entry>
  <entry>
    <title>shell学习笔记-II</title>
    <url>/arlo/4b7d8f2b/</url>
    <content><![CDATA[<h1 id="流程控制：if-x2F-case"><a href="#流程控制：if-x2F-case" class="headerlink" title="流程控制：if&#x2F;case"></a>流程控制：if&#x2F;case</h1><h2 id="单分支结构"><a href="#单分支结构" class="headerlink" title="单分支结构"></a>单分支结构</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">if 条件测试</span><br><span class="line">then 命令序列</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<h2 id="双分支结构"><a href="#双分支结构" class="headerlink" title="双分支结构"></a>双分支结构</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">if 条件测试</span><br><span class="line">then 命令序列</span><br><span class="line">else 命令序列</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<h2 id="多分支结构"><a href="#多分支结构" class="headerlink" title="多分支结构"></a>多分支结构</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">if 条件测试1</span><br><span class="line">then 命令序列</span><br><span class="line"></span><br><span class="line">[elif 条件测试2</span><br><span class="line">then 命令序列</span><br><span class="line"></span><br><span class="line">elif 条件测试3</span><br><span class="line">then 命令序列]...</span><br></pre></td></tr></table></figure>

<h2 id="case语法结构"><a href="#case语法结构" class="headerlink" title="case语法结构"></a>case语法结构</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">case 变量 in</span><br><span class="line">模式1)</span><br><span class="line">	命令序列1</span><br><span class="line">	;;</span><br><span class="line">模式2)</span><br><span class="line">	命令序列2</span><br><span class="line">	;;</span><br><span class="line">模式3)</span><br><span class="line">	命令序列3</span><br><span class="line">	;;</span><br><span class="line">*)</span><br><span class="line">    无匹配后命令序列</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>

<h1 id="脚本实例"><a href="#脚本实例" class="headerlink" title="脚本实例"></a>脚本实例</h1><h2 id="给用户一个提示模板"><a href="#给用户一个提示模板" class="headerlink" title="给用户一个提示模板"></a>给用户一个提示模板</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">red_col=&quot;\e[1;31m&quot;</span><br><span class="line">reset_col=&quot;\e[0m&quot;</span><br><span class="line"></span><br><span class="line">read -p &quot;请确认安装kvm[y]: &quot; kvm_install</span><br><span class="line"></span><br><span class="line">if [ ! $&#123;kvm_install&#125; = &quot;y&quot; ];then</span><br><span class="line">        echo -e &quot;$red_col 输入不正确! $reset_col&quot;</span><br><span class="line">        exit</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<h2 id="判断一个用户是否存在"><a href="#判断一个用户是否存在" class="headerlink" title="判断一个用户是否存在"></a>判断一个用户是否存在</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">read -p &quot;please input username: &quot; username</span><br><span class="line">id $username &amp;&gt;/dev/null</span><br><span class="line">if [ $? -eq 0 ];then</span><br><span class="line">        echo &quot;$username already exists&quot;</span><br><span class="line">else</span><br><span class="line">        useradd $username</span><br><span class="line">        if [ $? -eq 0 ];then</span><br><span class="line">                echo &quot;$username is created.&quot;</span><br><span class="line">        fi</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<h2 id="判断当前系统版本，下载对应yum配置文件"><a href="#判断当前系统版本，下载对应yum配置文件" class="headerlink" title="判断当前系统版本，下载对应yum配置文件"></a>判断当前系统版本，下载对应yum配置文件</h2><h3 id="if…else方式"><a href="#if…else方式" class="headerlink" title="if…else方式"></a>if…else方式</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">os_version=`cat /etc/redhat-release |awk &#x27;&#123;print $4&#125;&#x27;|awk -F &quot;.&quot; &#x27;&#123;print $1&#125;&#x27;`</span><br><span class="line">repo_bk=/etc/yum.repos.d/bk/</span><br><span class="line">[ -d $repo_bk ] || mkdir -p $repo_bk</span><br><span class="line">mv /etc/yum.repos.d/*.repo $repo_bk</span><br><span class="line"></span><br><span class="line">if [ &quot;$os_version&quot; = &quot;7&quot; ];then</span><br><span class="line">	curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo &amp;&gt; /dev/null</span><br><span class="line">	echo &quot;CentOS$os_version yum configure is already.&quot;</span><br><span class="line">elif [ &quot;$os_version&quot; = &quot;6&quot; ];then</span><br><span class="line">	curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-vault-6.10.repo &amp;&gt; /dev/null</span><br><span class="line">	echo &quot;CentOS$os_version yum configure is already.&quot;</span><br><span class="line">elif [ &quot;$os_version&quot; = &quot;8&quot; ];then</span><br><span class="line">	curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-vault-8.5.2111.repo &amp;&gt; /dev/null</span><br><span class="line">	echo &quot;CentOS$os_version yum configure is already.&quot;</span><br><span class="line">else </span><br><span class="line">	echo &quot;The system version is not supported.&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<h3 id="case-方式"><a href="#case-方式" class="headerlink" title="case 方式"></a>case 方式</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">os_version=`cat /etc/redhat-release |awk &#x27;&#123;print $4&#125;&#x27;|awk -F &quot;.&quot; &#x27;&#123;print $1&#125;&#x27;`</span><br><span class="line">repo_bk=/etc/yum.repos.d/bk/</span><br><span class="line">[ -d $repo_bk ] || mkdir -p $repo_bk</span><br><span class="line">mv /etc/yum.repos.d/*.repo $repo_bk</span><br><span class="line"></span><br><span class="line">case $os_version in </span><br><span class="line">7)</span><br><span class="line">	curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo &amp;&gt; /dev/null</span><br><span class="line">	echo &quot;CentOS$os_version yum configure is already.&quot;</span><br><span class="line">	;;</span><br><span class="line">6)</span><br><span class="line">	curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-vault-6.10.repo &amp;&gt; /dev/null</span><br><span class="line">	echo &quot;CentOS$os_version yum configure is already.&quot;</span><br><span class="line">	;;</span><br><span class="line">8)</span><br><span class="line">	curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-vault-8.5.2111.repo &amp;&gt; /dev/null</span><br><span class="line">	echo &quot;CentOS$os_version yum configure is already.&quot;</span><br><span class="line">	;;</span><br><span class="line">*) </span><br><span class="line">	echo &quot;The system version is not supported.&quot;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>

<h1 id="yum安装apache"><a href="#yum安装apache" class="headerlink" title="yum安装apache"></a>yum安装apache</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">#install apache</span><br><span class="line">#v1.0 by arlo 2022/7/20</span><br><span class="line">gateway=192.168.6.254</span><br><span class="line"></span><br><span class="line">ping -c1 t.cn &amp;&gt;/dev/null</span><br><span class="line">if [ $? -eq 0 ];then</span><br><span class="line">        yum -y install httpd</span><br><span class="line">        systemctl start httpd</span><br><span class="line">        systemctl enable httpd</span><br><span class="line">        firewall-cmd --permanent --add-port=80/tcp --zone=public</span><br><span class="line">        firewall-cmd --reload</span><br><span class="line">        sed -ri s/SELINUX=enforcing/SELINUX=disabled/g /etc/selinux/config</span><br><span class="line">        setenforce 0</span><br><span class="line">        curl http://127.0.0.1 &amp;&gt;/dev/null</span><br><span class="line">        if [ $? -eq 0 ];then</span><br><span class="line">                echo &quot;Apache ok...&quot;</span><br><span class="line">        fi</span><br><span class="line">elif ping -c1 $gateway &amp;&gt;/dev/null;then</span><br><span class="line">        echo &quot;check dns...&quot;</span><br><span class="line">else</span><br><span class="line">        echo &quot;check ip address&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

]]></content>
  </entry>
  <entry>
    <title>在浏览器直接下载百度网盘大文件,不用客户端</title>
    <url>/arlo/1ace6b3c/</url>
    <content><![CDATA[<h1 id="1、打开百度网盘，右上角切换到旧版本"><a href="#1、打开百度网盘，右上角切换到旧版本" class="headerlink" title="1、打开百度网盘，右上角切换到旧版本"></a>1、打开百度网盘，右上角切换到旧版本</h1><h1 id="2、按F12切换进入浏览器调试模式，选择Console"><a href="#2、按F12切换进入浏览器调试模式，选择Console" class="headerlink" title="2、按F12切换进入浏览器调试模式，选择Console"></a>2、按F12切换进入浏览器调试模式，选择Console</h1><h1 id="3、输入以下代码后、回车，会得到一个直链"><a href="#3、输入以下代码后、回车，会得到一个直链" class="headerlink" title="3、输入以下代码后、回车，会得到一个直链"></a>3、输入以下代码后、回车，会得到一个直链</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"> (function()&#123;</span><br><span class="line">    var _id    = 309847;</span><br><span class="line">    var isHome = $(&#x27;a[title=&quot;我的卡包&quot;]&#x27;).html();</span><br><span class="line">    var _temp  = isHome ? &quot;&quot; : $(&#x27;span[title]:first&#x27;).attr(&#x27;title&#x27;).slice(4);</span><br><span class="line">    var _name  = &#x27;文件名&#x27;; </span><br><span class="line">    var _path  = encodeURIComponent(_temp + &#x27;/&#x27; + _name);</span><br><span class="line">    var _link  = &#x27;https://pcs.baidu.com/rest/2.0/pcs/file?method=download&amp;app_id=&#x27;+_id+&#x27;&amp;path=&#x27;+_path;</span><br><span class="line">    console.log(&#x27;下载地址为：&#x27;);</span><br><span class="line">    console.log(&#x27;%c%s&#x27; , &#x27;color: #00ff00; background-color: #000000;&#x27; , _link);</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>ps：这个路径是文件放在顶级根目录下了，在子目录了需要修改一下路径。</p>
]]></content>
  </entry>
  <entry>
    <title>简单粗暴：去除小米电视广告</title>
    <url>/arlo/fcd9bd22/</url>
    <content><![CDATA[<ul>
<li>今天是2022.1.24，亲测可以去掉小米电视4A开机广告以及电视剧、电影片头广告</li>
<li>如果后期失效，有可能域名有变化，需要重新抓包获取<br>方法：使用wireshark抓包，在路由器中屏蔽域名，实现去除小米电视广告（开机广告+视频开头广告）</li>
</ul>
<span id="more"></span>

<h1 id="抓包"><a href="#抓包" class="headerlink" title="抓包"></a>抓包</h1><p>使用笔记本电脑新建一个热点，开启小米电视无线连接，连接到笔记本的移动热点上，这样在笔记本上打开wireshark，就可以获取到小米电视的数据包。</p>
<h2 id="抓取数据包"><a href="#抓取数据包" class="headerlink" title="抓取数据包"></a>抓取数据包</h2><p>用遥控器在电视上点开视频，看到广告后即可获取到数据包</p>
<p><img src="/images/2022/0124/01.png" alt="01"></p>
<h2 id="导出http对象"><a href="#导出http对象" class="headerlink" title="导出http对象"></a>导出http对象</h2><p>点击wireshark文件-导出对象-http</p>
<p><img src="/images/2022/0124/02.png" alt="01"></p>
<h2 id="获取域名"><a href="#获取域名" class="headerlink" title="获取域名"></a>获取域名</h2><p>按主机名排序，将相同的主机名放在一起方便统计</p>
<p><img src="/images/2022/0124/03.png" alt="01"></p>
<p><em>ps：建议多抓几遍，有可能每次获取广告的地址不一样，后边有多个域名提供广告。</em></p>
<h1 id="测试域名屏蔽效果"><a href="#测试域名屏蔽效果" class="headerlink" title="测试域名屏蔽效果"></a>测试域名屏蔽效果</h1><p>首先在本机hosts文件中添加我们整理好的域名,解析到127.0.0.1即可</p>
<p>C:\Windows\System32\drivers\etc\hosts</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">127.0.0.1  api.account.xiaomi.com</span><br><span class="line">127.0.0.1  api.kingdata.ksyun.com</span><br><span class="line">127.0.0.1  cdn.cnbj1.fds.api.mi-img.com</span><br><span class="line">127.0.0.1  centertime.ksyun.com</span><br><span class="line">127.0.0.1  cm.cn.miaozhen.com</span><br><span class="line">127.0.0.1  cmonitor.ptqy.gitv.tv</span><br><span class="line">127.0.0.1  data.mistat.xiaomi.com</span><br><span class="line">127.0.0.1  data.video.ptqy.gitv.tv</span><br><span class="line">127.0.0.1  doh.ptqy.gitv.tv</span><br><span class="line">127.0.0.1  kuai.cdn.ptmi.gitv.tv</span><br><span class="line">127.0.0.1  liveats-vod.video.ptqy.gitv.tv</span><br><span class="line">127.0.0.1  meta-cdn.video.ptqy.gitv.tv</span><br><span class="line">127.0.0.1  msg.ptqy.gitv.tv</span><br><span class="line">127.0.0.1  policy.video.ptqy.gitv.tv</span><br><span class="line">127.0.0.1  puma-api.ptqy.gitv.tv</span><br><span class="line">127.0.0.1  pv.sohu.com</span><br><span class="line">127.0.0.1  qtsftl.m.cn.miaozhen.com</span><br><span class="line">127.0.0.1  rtbasia.ptqy.gitv.tv</span><br><span class="line">127.0.0.1  sdk-cache.video.ptqy.gitv.tv</span><br><span class="line">127.0.0.1  slb-p2p.vcloud.ks-live.com</span><br><span class="line">127.0.0.1  t3.a.market.xiaomi.com</span><br><span class="line">127.0.0.1  t7z.cupid.ptqy.gitv.tv</span><br><span class="line">127.0.0.1  xiaomi-dtv.m.cn.miaozhen.com</span><br><span class="line">127.0.0.1  imp.ad.xelements.cn</span><br><span class="line">127.0.0.1  mon.ad.xelements.cn</span><br><span class="line">127.0.0.1  piq.in-neo.cn</span><br><span class="line">127.0.0.1  t.track.ad.xiaomi.com</span><br><span class="line">127.0.0.1  tcqcloudcdncnc.inter.ptqy.gitv.tv</span><br><span class="line">127.0.0.1  gslb.hpplay.cn</span><br><span class="line">127.0.0.1  qzonestyle.gtimg.cn</span><br><span class="line">127.0.0.1  rp.hpplay.cn</span><br></pre></td></tr></table></figure>
<p>ps：测试完就可以删掉了。</p>
<p>建议使用小米电视自带的“电视管家”先清理电视内存，缓存，然后打开视频进行测试；如果发现还有广告，返回第一步继续抓包，看看是否还有漏网域名，再次添加到host文件中，反复测试无广告后即可在路由器上操作。</p>
<h1 id="在路由器（网络出口）屏蔽"><a href="#在路由器（网络出口）屏蔽" class="headerlink" title="在路由器（网络出口）屏蔽"></a>在路由器（网络出口）屏蔽</h1><h2 id="支持自定义hosts的路由器"><a href="#支持自定义hosts的路由器" class="headerlink" title="支持自定义hosts的路由器"></a>支持自定义hosts的路由器</h2><p>将之前测试的域名添加到自定义hosts文件中即可。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">127.0.0.1  api.account.xiaomi.com</span><br><span class="line">127.0.0.1  api.kingdata.ksyun.com</span><br><span class="line">127.0.0.1  cdn.cnbj1.fds.api.mi-img.com</span><br><span class="line">127.0.0.1  centertime.ksyun.com</span><br><span class="line">127.0.0.1  cm.cn.miaozhen.com</span><br><span class="line">127.0.0.1  cmonitor.ptqy.gitv.tv</span><br><span class="line">127.0.0.1  data.mistat.xiaomi.com</span><br><span class="line">127.0.0.1  data.video.ptqy.gitv.tv</span><br><span class="line">127.0.0.1  doh.ptqy.gitv.tv</span><br><span class="line">127.0.0.1  kuai.cdn.ptmi.gitv.tv</span><br><span class="line">127.0.0.1  liveats-vod.video.ptqy.gitv.tv</span><br><span class="line">127.0.0.1  meta-cdn.video.ptqy.gitv.tv</span><br><span class="line">127.0.0.1  msg.ptqy.gitv.tv</span><br><span class="line">127.0.0.1  policy.video.ptqy.gitv.tv</span><br><span class="line">127.0.0.1  puma-api.ptqy.gitv.tv</span><br><span class="line">127.0.0.1  pv.sohu.com</span><br><span class="line">127.0.0.1  qtsftl.m.cn.miaozhen.com</span><br><span class="line">127.0.0.1  rtbasia.ptqy.gitv.tv</span><br><span class="line">127.0.0.1  sdk-cache.video.ptqy.gitv.tv</span><br><span class="line">127.0.0.1  slb-p2p.vcloud.ks-live.com</span><br><span class="line">127.0.0.1  t3.a.market.xiaomi.com</span><br><span class="line">127.0.0.1  t7z.cupid.ptqy.gitv.tv</span><br><span class="line">127.0.0.1  xiaomi-dtv.m.cn.miaozhen.com</span><br><span class="line">127.0.0.1  imp.ad.xelements.cn</span><br><span class="line">127.0.0.1  mon.ad.xelements.cn</span><br><span class="line">127.0.0.1  piq.in-neo.cn</span><br><span class="line">127.0.0.1  t.track.ad.xiaomi.com</span><br><span class="line">127.0.0.1  tcqcloudcdncnc.inter.ptqy.gitv.tv</span><br><span class="line">127.0.0.1  gslb.hpplay.cn</span><br><span class="line">127.0.0.1  qzonestyle.gtimg.cn</span><br><span class="line">127.0.0.1  rp.hpplay.cn</span><br></pre></td></tr></table></figure>

<h2 id="不支持自定义hosts的路由器"><a href="#不支持自定义hosts的路由器" class="headerlink" title="不支持自定义hosts的路由器"></a>不支持自定义hosts的路由器</h2><p>查看一下路由器是否支持“禁止访问网站管理”，“网站黑名单”之类的功能，这样我们就可以屏蔽域名了；我家里使用的是“TL-WDR7660千兆版”，这款无线路由，入口比较隐蔽，参考tplink官网文档<a href="https://service.tp-link.com.cn/detail_article_4283.html">https://service.tp-link.com.cn/detail_article_4283.html</a></p>
<p><img src="/images/2022/0124/04.png" alt="01"></p>
<p>依次添加需要屏蔽的域名</p>
<p><img src="/images/2022/0124/05.png" alt="01"></p>
<p><img src="/images/2022/0124/06.png" alt="01"></p>
<p>因为我这个路由器，“+ 添加禁止访问的网站”，只能添加16条规则，我手动将上述域名汇总了下，估计是有错杀的，仅供参考。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pv.sohu.com</span><br><span class="line">market.xiaomi.com</span><br><span class="line">ad.xiaomi.com</span><br><span class="line">data.mistat.xiaomi.com</span><br><span class="line">api.account.xiaomi.com</span><br><span class="line">cn.miaozhen.com</span><br><span class="line">api.kingdata.ksyun.com</span><br><span class="line">centertime.ksyun.com</span><br><span class="line">cdn.cnbj1.fds.api.mi-img.com</span><br><span class="line">slb-p2p.vcloud.ks-live.com</span><br><span class="line">piq.in-neo.cn</span><br><span class="line">ad.xelements.cn</span><br><span class="line">qzonestyle.gtimg.cn</span><br><span class="line">ptmi.gitv.tv</span><br><span class="line">ptqy.gitv.tv</span><br><span class="line">hpplay.cn</span><br></pre></td></tr></table></figure>

]]></content>
  </entry>
  <entry>
    <title>好词好句</title>
    <url>/arlo/ef5b34cd/</url>
    <content><![CDATA[<p><em><u><strong>阻碍发展：懒、怕、傲、急</strong></u></em></p>
<p><em><u><strong>助力成长：勤、敢、谦、缓</strong></u></em></p>
<span id="more"></span>



<h1 id="1"><a href="#1" class="headerlink" title="#1"></a>#1</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">日拱一卒无有尽,功不唐捐终入海。   --胡适</span><br><span class="line">和这个结局比起来，我们过去的一切都显得那么肤浅。</span><br><span class="line">他朝若是同淋雪，此生也算共白头。</span><br><span class="line">枕上思量千条路，明朝依旧卖豆腐。</span><br><span class="line">兰陵美酒郁金香， 玉椀盛来琥珀光。 但使主人能醉客， 不知何处是他乡。</span><br><span class="line">千淘万漉虽辛苦，吹尽狂沙始到金。</span><br><span class="line">云山苍苍，江水泱泱，先生之风，山高水长。</span><br><span class="line">叹息老来交旧尽，睡来谁共午瓯茶。</span><br><span class="line">本是青灯不归客，却因浊酒留风尘。星光不问赶路人，岁月不负有心人。</span><br><span class="line">操千曲而后晓声，观千剑而后识器</span><br><span class="line">你看见了，但是你没有注意观察。</span><br><span class="line">种一棵树，最好的时间是十年前，其次是现在。</span><br><span class="line">万般皆是命，半点不由人。但存方寸地，留与子孙耕</span><br><span class="line">理以技装纯，文以诗骗炮</span><br><span class="line">人老不以筋骨为能。</span><br><span class="line">长恨人心不如水，等闲平地起波澜。</span><br><span class="line">空望他，功成名就又怎地，豆腐换成金羽衣</span><br><span class="line">已识乾坤大，犹怜草木青。</span><br><span class="line">通过牺牲别人抵达的信仰不叫信仰，是私欲。通过龌蹉谎言实现的正义不叫正义，是罪恶。</span><br><span class="line">人生不如意十八九，可与人言无二三。</span><br><span class="line">前车倒了千千辆，后车到了亦如然。分明指与平川路，却把忠言当恶言。</span><br><span class="line">宿尽闲花万万千，不如归家伴妻眠。虽然枕上无情趣，睡到天明不要钱。</span><br><span class="line">两手劈开生死路，翻身跳出是非门。</span><br><span class="line">每一个不曾起舞的日子，都是对生命的辜负。 </span><br><span class="line">其实人跟树是一样的，越是向往高处的阳光，它的根就越要伸向黑暗的地底。 </span><br><span class="line">我感到难过，不是因为你欺骗了我，而是因为我再也不能相信你了。 </span><br><span class="line">一个人知道自己为什么而活，就可以忍受任何一种生活。 </span><br><span class="line">但凡不能杀死你的，最终都会使你更强大。</span><br></pre></td></tr></table></figure>

<h1 id="2"><a href="#2" class="headerlink" title="#2"></a>#2</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">君埋泉下泥销骨，我寄人间雪满头。   --白居易《 梦微之 》</span><br><span class="line">世间好物不坚牢，彩云易散琉璃脆。   --杨绛《我们三》</span><br><span class="line">大都好物不坚牢，彩云易散琉璃脆。  --白居易《简简吟》</span><br><span class="line">晚来天欲雪 能饮一杯无。 </span><br><span class="line">春有百花秋有月，夏有凉风冬有雪。若无闲事挂心头，便是人间好时节。</span><br><span class="line">“世界上只有一种英雄主义，就是看清生活的真相之后依然热爱生活。” —— 罗曼·罗兰</span><br><span class="line">群众只会做两件事，锦上添花和落井下石。  --《乌合之众》</span><br><span class="line">你不是我，怎知我走过的路，心中的苦与乐。 --列夫·托尔斯泰</span><br><span class="line">初如柳絮，渐似鹅毛。唰唰似数蟹行沙上，纷纷如乱琼堆砌间。但行动衣沾六出，只顷刻拂满蜂鬓。衬瑶台，似玉龙翻甲绕空舞；飘粉额，如白鹤羽毛连地落。正是：冻合玉楼寒起粟，光摇银海烛生花。</span><br></pre></td></tr></table></figure>

<p>–</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">那一刻我万众瞩目，不为名利，只为再见你的容颜。</span><br><span class="line">那一天我求拜神灵，不为祈福，只为守护你的到来。</span><br><span class="line">那一夜我倾听梵唱，不为参悟，只为寻你一丝气息。</span><br><span class="line">那一次我游历山河，不为故景，只为途中与你重逢。</span><br></pre></td></tr></table></figure>

<p>金瓶梅</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">武大这两日出门早。</span><br><span class="line">大官人如干此事，便买一匹蓝绸、一匹白绸、一匹白绢，再用十两好绵，都把来与老身。</span><br><span class="line">老身却走过去问他借历日，央及他拣个好日期，叫个裁缝来做。他若见我这般说，拣了日期，不肯与我来做时，此事便休了；</span><br><span class="line">他若欢天喜地说：”我替你做。‘不要我叫裁缝，这光便有一分了。</span><br><span class="line">我便请得他来做，就替我缝，这光便二分了。</span><br><span class="line">他若来做时，午间我却安排些酒食点心请他吃。他若说不便当，定要将去家中做，此事便休了；他不言语吃了时，这光便有三分了。</span><br><span class="line">这一日你也莫来，直至第三日，晌午前后，你整整齐齐打扮了来，以咳嗽为号，你在门前叫道：“怎的连日不见王干娘？我买盏茶吃。’我便出来请你入房里坐吃茶。他若见你便起身来，走了归去，难道我扯住他不成？此事便休了。他若见你入来，不动身时，这光便有四分了。</span><br><span class="line">坐下时，我便对雌儿说道：”这个便是与我衣服施主的官人，亏杀他。‘我便夸大官人许多好处，你便卖弄他针指。若是他不来兜揽答应时，此事便休了；他若口中答应与你说话时，这光便有五分了。</span><br><span class="line">我便道：“却难为这位娘子与我作成出手做，亏杀你两施主，一个出钱，一个出力。不是老身路歧相央，难得这位娘子在这里，官人做个主人替娘子浇浇手。’你便取银子出来，央我买。若是他便走时，难道我扯住他？此事便休了。他若是不动身时，事务易成，这光便有六分了。</span><br><span class="line">我却拿银子，临出门时对他说：”有劳娘子相待官人坐一坐。‘他若起身走了家去，我终不成阻挡他？此事便休了。若是他不起身，又好了，这光便有七分了。</span><br><span class="line">待我买得东西提在桌子上，便说：“娘子且收拾过生活去，且吃一杯儿酒，难得这官人坏钱。’他不肯和你同桌吃，去了，此事便休了。若是他不起身，此事又好了，这光便有八分了。</span><br><span class="line">待他吃得酒浓时，正说得入港，我便推道没了酒，再交你买，你便拿银子，又央我买酒去并果子来配酒。我把门拽上，关你两个在屋里。他若焦燥跑了归去时，此事便休了；他若由我拽上门，不焦躁时，这光便有九分，只欠一分了。</span><br><span class="line">只是这一分倒难。大官人你在房里，便着几句甜话儿说入去，却不可燥暴，便去动手动脚打搅了事，那时我不管你。你先把袖子向桌子上拂落一双箸下去，只推拾箸，将手去他脚上捏一捏。他若闹将起来，我自来搭救。此事便休了，再也难成。若是他不做声时，此事十分光了。</span><br><span class="line">这十分光做完备，你怎的谢我？”</span><br></pre></td></tr></table></figure>

<p>–</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">穷人站在十字街头，耍十把钢钩，勾不住亲人血肉；富人在深山老林，耍刀枪棍棒，打不散无义宾朋。有钱男子汉，没钱汉子难。 --郭德纲</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">店里的招牌是红烧肉，而你是一盘花生米，大家都来店里吃饭，点了红烧肉，也点了花生米，你要认清自己。要搞清楚，人们始终是奔着红烧肉来的，而不是花生米，你有自己的价值，但撑不起一桌菜。  --郭德纲</span><br></pre></td></tr></table></figure>

<p>–</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">吾儿孝安，自盘古开天，三黄定国，五帝开疆，凡国之大事，男当在祀与戎泯躯祭国，即燹骨成丘溢血江河，亦不可辱国之士，丧国之疆，士 披肝沥胆，将 寄身刀锋，帅 槊血满袖，王 利刃辉光，吾等无长幼尊卑，无先后贵贱，必同心竭力，倾黄河之水，决东海之波，征胡虏之地，剿倭奴之穴，讨欺吾之寇，伐蛮夷之戮，遂沧海横流，儿立身无愧，任 尸覆遍野，唯 精魂可依，父传字。</span><br></pre></td></tr></table></figure>

<p> 庄子妻死</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">庄子妻死，惠子吊之，庄子则方箕踞鼓盆而歌。</span><br><span class="line">惠子曰：“与人居，长子老身，死不哭亦足矣，又鼓盆而歌，不亦甚乎！”</span><br><span class="line">庄子曰：“不然。是其始死也，我独何能无概然！察其始而本无生，非徒无生也而本无形，非徒无形而本无气。杂乎芒芴之间，变而有气，气变而有形，形变而有生，今又变而之死，是相春秋冬夏四时行也。人且偃然寝于巨市，而我嗷嗷随而哭之，自以为不通乎命，故止也。”</span><br><span class="line"></span><br><span class="line">庄子将死,弟子欲厚葬之.庄子曰&quot;吾以天地为棺葬，以日月为连壁，星辰为琛玑，万物为赍送。吾葬具岂不备邪？何以加此！”</span><br><span class="line">弟子曰：“吾恐鸟鸢之食夫子也。”</span><br><span class="line">庄子曰：“在上为鸟鸢食，在下为蝼蚁食，夺彼与此，何其偏也！”</span><br></pre></td></tr></table></figure>

<p>–</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">今之人，贫者日为衣食所累，富者又怀不足之心，纵然一时稍闲，又有贪淫恋色、好货寻愁之事。那里去有工夫看那治理之书？所以我这一段故事，也不愿世人称奇道妙，也不定要是人喜悦检读，只愿他们当那醉淫饱卧之时，或避世去愁之际，把此一玩，岂不省了些寿命筋力？就比那谋虚逐妄，却也省了口舌是非之害，腿脚奔忙之苦。再者，亦令世人换新眼目，不比那些胡牵乱扯，忽离忽遇，满纸才子淑女，子建文君，红娘小玉等共熟套之旧稿。我师意为何如？</span><br></pre></td></tr></table></figure>

<h1 id="3"><a href="#3" class="headerlink" title="#3"></a>#3</h1><p>史蒂芬·柯维在提出通过四象限法来管理时间</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">重要而且紧急的事情：最重要的事情，而且是紧急的事。实现目标的关键环节，重要的一个会议等等。优先处理才能搞别的事。</span><br><span class="line">重要但不紧急的事情：这种事情要求更多的主动性，积极性和自觉性。因为很多重要的是都不是紧急的，没人催你。读有用的几本书，培养感情，锻炼身体，这些事情重要吗？当然，他们会影响我的健康，事业，还有家庭关系，情侣关系，个人成长等。但是这些事不是很紧急，如果长期拖延就会造成严重的后果，发展成重要紧急的事！比如长期缺乏锻炼引发疾病，到时候后悔莫及。</span><br><span class="line">紧急但不重要的是事情：匆忙地完成了，却发现时间白白浪费。</span><br><span class="line">既不紧急也不重要的事情：这种事就是毫无节制的浪费时间，拿看电视来说吧，饭后没事干打开电视，笑几下一下午就过去了。时间过去后发现还不去出去跑跑步，锻炼一下身体。刷微信，微博，想想都可怕。</span><br></pre></td></tr></table></figure>

<p>情绪控制</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">你的每一个动作，每一句话都会影响到你身边的每一个人，也会影响到他们对你的看法。所以驱使你举止的不能是你的情绪。</span><br><span class="line">感情用事是犯错误的开始。</span><br><span class="line">不做负面情绪的传播者，遇事冷静，不要表现在做事态度上或者行动上。防止影响别人。</span><br><span class="line">不做负面情绪的感染者，不要让别人的消极情绪影响，要有自己的判断，思考。控制自己的情绪，保持头脑冷静，自律自省，做到喜怒不形于色，这样别人就无法从我们的言行，行为甚至表情中窥探出真实想法。</span><br></pre></td></tr></table></figure>

<p>关于健康的辩证法</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">   核桃产地没出过什么天才，虫草产地没出过寿星。长寿没有秘诀，喜欢什么就吃什么，想做什么就做什么。人生很短，何必委屈自己。</span><br><span class="line">《关于健康的辩证法》-此文不错，见解独到，与朋友们分享。</span><br><span class="line"></span><br><span class="line">   对健康，有这么一说：&#x27;适合的就是最好的。&#x27;即：</span><br><span class="line">大道无道，大养无养。</span><br><span class="line">自我理解，自我把控。</span><br><span class="line">“取精华，去糟粕，莫放任”。</span><br><span class="line"></span><br><span class="line">  关于健康，</span><br><span class="line">关于吃油吃肉问题，绝不能一概而论，如果你是体力劳动者或活动很多，尽管吃肉多吃油炒菜就是了。如果你很少活动，又是脑力劳动者少吃点肥肉，少吃点油炒菜可能是对的，但还是要吃些肉，比如瘦肉，牛肉，兔肉，鱼肉之类。</span><br><span class="line">关于健康保健我形式逻辑地分析如下：</span><br><span class="line">一定要根据本人实际情况安排。</span><br><span class="line">   如老了，不一定要走路锻炼，北大哲学系有一篇文章，那些哲学系教授们都不大爱运动，有些一坐几十年，除上班下班从家里到办公室外（家也在校园里），几乎没有其它活动，更不要说运动了，但多数活到90岁以上。</span><br><span class="line">   关于情绪，广西玉林晚报搞过一个万岁活动（访问调查100个100岁以上者即10000岁），后来国家级一些生物学家，营养学家，医学家也参加了调查，半年之久，想调查长寿规律，结果没有结论。因为被调查者有爱动的有不爱动的，有一辈子不干活的，有一辈子干重体力劳动的，有爱喝酒抽烟的，有从來不喝酒抽烟的，有爱吃肉的有一辈子吃素的，有一辈子爱骂人脾气很坏的，有一辈子不爱吭声的，有家里灾难不断的，有家庭一辈子和谐的，有一辈子没结婚的也有结三四次婚的，有一辈子没生育的，也有生过7，8个孩子的，各种情况都有。但没有什么共性的长寿规律。只是平均女性比男性活得长一些（女性100岁以上多一些）。</span><br><span class="line">   最后结论，大道无道，顺其自然（我现在就用这个当座右铭）</span><br><span class="line">   吃葷吃素问题，你适应哪种就哪种，不要刻意安排多吃少吃。海登法师一辈子吃素（最好的菜是烩豆腐），老毛爱吃红烧肉，都活83岁。我在内蒙当兵10年，多数在牧区，牧区老百姓每人每年600斤肉不够吃（他们基本不吃一粒粮食），汉人一年连10斤肉都不到，活的岁数差别不大（不过牧民身体确实棒，力气够大）。</span><br><span class="line">   吃补品问题。应该说没有什么食物有特补效果，比如现在宣传的枸杞子，过去我在宁夏打过马草，看到那里的小孩秋天成口袋地把枸杞子当零食吃，也就是说那里的孩子和大人吃枸杞子比现在那些希望大补的人吃得多得多，也不见得宁夏人多活多少年，健康好多少。</span><br><span class="line">   又如，现在说吃核桃益脑，聪明。北方河北河南山西，南方贵州，那核桃多了。我们在山西十几年，每年也没少吃核桃。记得70年代在山西核桃一分钱一个，我们一买就是一面口袋，一冬净敲核桃吃了。这些地方人比其它地方人聪明一些吗？</span><br><span class="line">   又比如虫草，我90年代末到贵州黔西南工作到退休共8年，刚去时，那里的虫草几十元一斤，街上好多虫草焖鸡店。我们领导來往往点虫草鸡吃（最初10根虫草一只鸡炖好才20元），我在办公室也经常买单坐陪。听那些卖虫草的说，他们到处收购，云南，西藏，青海都去过，也自己采一些。有些虫草断了碎了卖不出去，他们也经常炖鸡炖肉吃，没见卖虫草的哪个身体好一些，命长一些。</span><br><span class="line">   吃绿豆的并不比不吃绿豆的身体好，病少，命长。</span><br><span class="line">   吃素并不比吃肉的健康，命长。</span><br><span class="line">   吃核桃并不比不吃的聪明多少。</span><br><span class="line">   吃枸杞的并不比不吃的健康一点。</span><br><span class="line">   锻炼的并不比懒的不爱动的人多活几天。</span><br><span class="line">   爱生气的不比心静的活得短。</span><br><span class="line">   吃含矾油条的比不吃油条的不见得命短，不见得爱得癌症。</span><br><span class="line">   吃含矾的皮蛋不见得比不吃的活得短。</span><br><span class="line">   吃腌菜酸菜的不见得易的癌症，不见得命短。</span><br><span class="line">   </span><br><span class="line">   一句话，你适应哪种生活，哪种习惯，哪种嗜好而且没觉得有什么不适，那就是你的生活方式，因为人是适者生存，有个环境适应症问题。</span><br></pre></td></tr></table></figure>

<p>祖传三代庸医</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">祖传三代庸医：</span><br><span class="line">第一代是头痛医头，脚痛医脚，虽然去不了病根儿，但起码能减轻症状，让你自以为治好了。</span><br><span class="line">第二代是头痛医脸，脚痛也医脸，因为对们来说，医好医不好不要紧，面子最重要。</span><br><span class="line">第三代更邪乎，头痛堵嘴，脚痛也堵嘴。只要不喊出来，病就算是医好了。</span><br></pre></td></tr></table></figure>



]]></content>
  </entry>
  <entry>
    <title>解决CentOS系统下中文显示乱码问题</title>
    <url>/arlo/3dbe5dca/</url>
    <content><![CDATA[<h1 id="查看系统界面语言"><a href="#查看系统界面语言" class="headerlink" title="查看系统界面语言"></a>查看系统界面语言</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$echo $LANG   #当前系统界面语言</span><br><span class="line">$locale   #自带的语言</span><br><span class="line">$LANG=&quot;zh_CN.UTF-8&quot;   #临时更改系统界面语言 或CentOS 7在sudo vi /etc/locale.conf修改 </span><br></pre></td></tr></table></figure>

<h1 id="修改文件夹下乱码文件名"><a href="#修改文件夹下乱码文件名" class="headerlink" title="修改文件夹下乱码文件名"></a>修改文件夹下乱码文件名</h1><p>从windows传到linux下的文件、目录大多都是有乱码这个问题，只需在服务器上进行转换即可。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#安装convmv</span><br><span class="line">yum -y install convmv  </span><br><span class="line">#把file目录下的所有gbk格式文件名递归转换成utf-8格式</span><br><span class="line">convmv -f gbk -t utf-8 -r --notest /opt/nginx/file/</span><br></pre></td></tr></table></figure>

<p>如果修改后，本地xftp，xshell乱码了，请查看会话属性是否使用的是utf编码。</p>
]]></content>
      <categories>
        <category>Troubleshooting</category>
      </categories>
      <tags>
        <tag>linux常识</tag>
        <tag>编码</tag>
      </tags>
  </entry>
  <entry>
    <title>解决Linux下生成PDF中文乱码的问题</title>
    <url>/arlo/e6167985/</url>
    <content><![CDATA[<p>在linux下跑的程序生成pdf时候出现方格、乱码，初步判断原因应该是linux系统下缺少中文字体，我们需要从windows下将中文字体上传到linux下， 进行安装。</p>
<p><img src="/images/2022/0511/01.png" alt="01"></p>
<span id="more"></span>

<h1 id="安装软件"><a href="#安装软件" class="headerlink" title="安装软件"></a>安装软件</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum -y install fontconfig xorg-x11-font-utils</span><br></pre></td></tr></table></figure>

<h1 id="查看系统里的目前已有字体"><a href="#查看系统里的目前已有字体" class="headerlink" title="查看系统里的目前已有字体"></a>查看系统里的目前已有字体</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@iZ2ze49kwoa6pxxyyxdoa7Z ~]# fc-list</span><br><span class="line"></span><br><span class="line">/usr/share/fonts/dejavu/DejaVuSansCondensed-Oblique.ttf: DejaVu Sans,DejaVu Sans Condensed:style=Condensed Oblique,Oblique</span><br><span class="line">/usr/share/fonts/dejavu/DejaVuSansCondensed-Bold.ttf: DejaVu Sans,DejaVu Sans Condensed:style=Condensed Bold,Bold</span><br><span class="line">/usr/share/fonts/dejavu/DejaVuSans.ttf: DejaVu Sans:style=Book</span><br><span class="line">/usr/share/fonts/dejavu/DejaVuSans-Bold.ttf: DejaVu Sans:style=Bold</span><br><span class="line">/usr/share/fonts/dejavu/DejaVuSansCondensed.ttf: DejaVu Sans,DejaVu Sans Condensed:style=Condensed,Book</span><br><span class="line">/usr/share/fonts/dejavu/DejaVuSans-ExtraLight.ttf: DejaVu Sans,DejaVu Sans Light:style=ExtraLight</span><br><span class="line">/usr/share/fonts/dejavu/DejaVuSansCondensed-BoldOblique.ttf: DejaVu Sans,DejaVu Sans Condensed:style=Condensed Bold Oblique,Bold Oblique</span><br><span class="line">/usr/share/fonts/dejavu/DejaVuSans-Oblique.ttf: DejaVu Sans:style=Oblique</span><br><span class="line">/usr/share/fonts/dejavu/DejaVuSans-BoldOblique.ttf: DejaVu Sans:style=Bold Oblique</span><br></pre></td></tr></table></figure>

<p>目测应该是没有中文字体相关的字体，我们将windows下的字体（C:\Windows\Fonts）打包上传到linux上（&#x2F;usr&#x2F;share&#x2F;fonts）。<em>我这里偷懒了，如果你知道自己用的那个字体，单独上传就行</em>。</p>
<h1 id="安装字体"><a href="#安装字体" class="headerlink" title="安装字体"></a>安装字体</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@iZ2ze49kwoa6pxxyyxdoa7Z fonts]# pwd</span><br><span class="line">/usr/share/fonts</span><br><span class="line">[root@iZ2ze49kwoa6pxxyyxdoa7Z fonts]# mkdir win</span><br><span class="line">[root@iZ2ze49kwoa6pxxyyxdoa7Z fonts]# unzip Fonts.zip -d ./win</span><br><span class="line">[root@iZ2ze49kwoa6pxxyyxdoa7Z fonts]# cd win/</span><br><span class="line">#生成字体索引</span><br><span class="line">[root@iZ2ze49kwoa6pxxyyxdoa7Z win]# mkfontscale</span><br><span class="line">[root@iZ2ze49kwoa6pxxyyxdoa7Z win]# mkfontdir</span><br><span class="line">[root@iZ2ze49kwoa6pxxyyxdoa7Z win]# fc-cache -fv</span><br></pre></td></tr></table></figure>

<h1 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h1><p>再次查看系统里的字体，发现已经有很多新添加的了</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@iZ2ze49kwoa6pxxyyxdoa7Z win]# fc-list</span><br><span class="line">/usr/share/fonts/win/SitkaVF-Italic.ttf: Sitka,Sitka Text:style=Text Italic,Italic</span><br><span class="line">/usr/share/fonts/win/DejaVuSansMono-BoldOblique_0.ttf: DejaVu Sans Mono:style=Bold Oblique</span><br><span class="line">/usr/share/fonts/win/SitkaVF.ttf: Sitka,Sitka Text:style=Heading Bold</span><br><span class="line">/usr/share/fonts/win/seguibli.ttf: Segoe UI,Segoe UI Black:style=Black Italic,Italic</span><br><span class="line">/usr/share/fonts/win/COLONNA.TTF: Colonna MT:style=Regular,obyčejné</span><br><span class="line">/usr/share/fonts/win/LTYPE.TTF: Lucida Sans Typewriter:style=Regular,normal</span><br><span class="line">/usr/share/fonts/win/ebrima.ttf: Ebrima:style=Regular</span><br><span class="line">/usr/share/fonts/win/GARA.TTF: Garamond:style=Regular,Standard</span><br><span class="line">/usr/share/fonts/win/REFSAN.TTF: MS Reference Sans Serif:style=Regular,normal</span><br><span class="line">/usr/share/fonts/win/TCM_____.TTF: Tw Cen MT:style=Regular,Κανονικά</span><br><span class="line">/usr/share/fonts/win/Candarai.ttf: Candara:style=Italic</span><br><span class="line">/usr/share/fonts/win/ROCC____.TTF: Rockwell Condensed:style=Regular,normal</span><br><span class="line">/usr/share/fonts/win/msjh.ttc: Microsoft JhengHei UI:style=Regular</span><br><span class="line">/usr/share/fonts/win/SitkaVF-Italic.ttf: Sitka,Sitka Text:style=Heading Bold Italic</span><br><span class="line">/usr/share/fonts/win/STXIHEI.TTF: STXihei:style=Regular</span><br><span class="line">/usr/share/fonts/win/FRAHVIT.TTF: Franklin Gothic Heavy:style=Italic,Kursivoitu</span><br><span class="line">/usr/share/fonts/win/STZHONGS.TTF: STZhongsong:style=Regular</span><br><span class="line">/usr/share/fonts/win/ROCKI.TTF: Rockwell:style=Italic,Kursivoitu</span><br><span class="line">/usr/share/fonts/win/HPSimplified.ttf: HP Simplified:style=Bold</span><br><span class="line">……</span><br></pre></td></tr></table></figure>

<p>过滤一下中文字体</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@iZ2ze49kwoa6pxxyyxdoa7Z win]# fc-list :lang=zh</span><br><span class="line">/usr/share/fonts/win/msjh.ttc: Microsoft JhengHei UI:style=Regular</span><br><span class="line">/usr/share/fonts/win/STXIHEI.TTF: STXihei:style=Regular</span><br><span class="line">/usr/share/fonts/win/STZHONGS.TTF: STZhongsong:style=Regular</span><br><span class="line">/usr/share/fonts/win/STKAITI.TTF: STKaiti:style=Regular</span><br><span class="line">/usr/share/fonts/win/simkai.ttf: KaiTi:style=Regular,Normaali</span><br><span class="line">/usr/share/fonts/win/STFANGSO.TTF: STFangsong:style=Regular</span><br><span class="line">/usr/share/fonts/win/msyhbd.ttc: Microsoft YaHei UI:style=Έντονα</span><br><span class="line">/usr/share/fonts/win/msyhl.ttc: Microsoft YaHei UI,Microsoft YaHei UI Light:style=Light,Regular</span><br><span class="line">/usr/share/fonts/win/msyhbd.ttc: Microsoft YaHei:style=Έντονα</span><br><span class="line">/usr/share/fonts/win/msyh.ttc: Microsoft YaHei UI:style=Normal</span><br><span class="line">/usr/share/fonts/win/STXINWEI.TTF: STXinwei:style=Regular</span><br><span class="line">/usr/share/fonts/win/Dengl.ttf: DengXian,DengXian Light:style=Light,Regular</span><br><span class="line">/usr/share/fonts/win/hpsimplifiedhans-light.ttf: HP Simplified Hans Light,HP Simplified Hans:style=Regular,Light</span><br><span class="line">/usr/share/fonts/win/FZYTK.TTF: FZYaoTi:style=Regular</span><br><span class="line">/usr/share/fonts/win/msjhbd.ttc: Microsoft JhengHei:style=Félkövér</span><br><span class="line">/usr/share/fonts/win/msyh.ttc: Microsoft YaHei:style=Normal</span><br><span class="line">/usr/share/fonts/win/msyhl.ttc: Microsoft YaHei,Microsoft YaHei Light:style=Light,Regular</span><br><span class="line">/usr/share/fonts/win/simsun.ttc: SimSun,宋体:style=Regular,常规</span><br><span class="line">/usr/share/fonts/win/SIMLI.TTF: LiSu:style=Regular</span><br><span class="line">/usr/share/fonts/win/STXINGKA.TTF: STXingkai:style=Regular</span><br><span class="line">/usr/share/fonts/win/Deng.ttf: DengXian:style=Regular</span><br><span class="line">/usr/share/fonts/win/SIMYOU.TTF: YouYuan:style=Regular</span><br><span class="line">/usr/share/fonts/win/Dengb.ttf: DengXian:style=Bold</span><br><span class="line">/usr/share/fonts/win/FZSTK.TTF: FZShuTi:style=Regular</span><br><span class="line">/usr/share/fonts/win/msjh.ttc: Microsoft JhengHei:style=Regular</span><br><span class="line">/usr/share/fonts/win/STSONG.TTF: STSong:style=Regular</span><br><span class="line">/usr/share/fonts/win/msjhbd.ttc: Microsoft JhengHei UI:style=Félkövér</span><br><span class="line">/usr/share/fonts/win/simsun.ttc: NSimSun,新宋体:style=Regular,常规</span><br><span class="line">/usr/share/fonts/win/simfang.ttf: FangSong:style=Regular,Normaali</span><br><span class="line">/usr/share/fonts/win/simhei.ttf: SimHei:style=Normal</span><br><span class="line">/usr/share/fonts/win/STHUPO.TTF: STHupo:style=Regular</span><br><span class="line">/usr/share/fonts/win/方正粗黑宋简体.ttf: FZCuHeiSongS\-B\-GB:style=Regular</span><br><span class="line">/usr/share/fonts/win/msjhl.ttc: Microsoft JhengHei UI,Microsoft JhengHei UI Light:style=Light,Regular</span><br><span class="line">/usr/share/fonts/win/hpsimplifiedhans-regular.ttf: HP Simplified Hans:style=Regular</span><br><span class="line">/usr/share/fonts/win/STCAIYUN.TTF: STCaiyun:style=Regular</span><br><span class="line">/usr/share/fonts/win/msjhl.ttc: Microsoft JhengHei,微軟正黑體 Light:style=Light,Regular</span><br><span class="line">/usr/share/fonts/win/STLITI.TTF: STLiti:style=Regular</span><br></pre></td></tr></table></figure>

<p>到这里字体就安装完毕了，再试试生成PDF，没有问题了</p>
<p><img src="/images/2022/0511/02.png" alt="01"></p>
]]></content>
      <categories>
        <category>Troubleshooting</category>
      </categories>
      <tags>
        <tag>Troubleshooting</tag>
      </tags>
  </entry>
  <entry>
    <title>PG常用运维语句记录</title>
    <url>/arlo/a1f8a536/</url>
    <content><![CDATA[<h1 id="常用短命令查询"><a href="#常用短命令查询" class="headerlink" title="常用短命令查询"></a>常用短命令查询</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">\?					#查看所有帮助</span><br><span class="line">\l					#列出数据库</span><br><span class="line">\c [database_name]			#切换数据库</span><br><span class="line">\c - [user_name]			#切换用户</span><br><span class="line">\dt					#查看所有自己创建的表</span><br><span class="line">\dt+					#查看所有自己创建的表，显示表的相关内容及占用磁盘大小</span><br><span class="line">\d [table_name]				#查看指定表结构</span><br><span class="line">\dt(+) ]tablename]			#查看指定表，显示表的相关内容及占用磁盘大小</span><br><span class="line">\dv 					#查看所有自己创建的视图</span><br><span class="line">\dv+ 					#查看所有自己创建的视图，显示大小</span><br><span class="line">\df 					#查看所有自己创建的function</span><br><span class="line">\df+					#查看所有自己创建的function,显示function的内容</span><br><span class="line">\df(+) [func_name]			#显示指定的function</span><br><span class="line">\ef [func_name]				#编辑function</span><br><span class="line">\dy					#查看触发器</span><br><span class="line">\dx					#查看添加的PostgreSQL扩展模块</span><br><span class="line">\du  					#查看所有角色</span><br><span class="line">\dp [viewortable]			#查看表或视图的权限</span><br><span class="line">\sf+ 函数名				#查看函数的创建语句</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">\!  [shell命令]				#执行系统shell命令</span><br><span class="line">\i  [xx.sql]				#执行sql脚本</span><br><span class="line">\conninfo				#查看当前连接信息</span><br><span class="line">\encoding [ENCODING]			#显示/修改客户端编码</span><br><span class="line">\password [USERNAME]			#修改当前用户密码</span><br><span class="line">---</span><br><span class="line">set search_path to [new_schema]  #切换schema</span><br><span class="line">---</span><br><span class="line">批量修改表的所有者</span><br><span class="line">select * from information_schema.tables where table_schema=&#x27;public&#x27;;</span><br><span class="line">修改表的所有者（将执行结果复制处理再次执行）</span><br><span class="line">select &#x27;ALTER TABLE &#x27; || table_name || &#x27; OWNER TO yourowner;&#x27; from information_schema.tables where table_schema=&#x27;public&#x27;;</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h1 id="查看死锁的SQL"><a href="#查看死锁的SQL" class="headerlink" title="查看死锁的SQL"></a>查看死锁的SQL</h1><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> blocked_locks.pid     <span class="keyword">AS</span> blocked_pid,</span><br><span class="line"></span><br><span class="line">         blocked_activity.usename  <span class="keyword">AS</span> blocked_user,</span><br><span class="line"></span><br><span class="line">         blocking_locks.pid     <span class="keyword">AS</span> blocking_pid,</span><br><span class="line"></span><br><span class="line">         blocking_activity.usename <span class="keyword">AS</span> blocking_user,</span><br><span class="line"></span><br><span class="line">         blocked_activity.query    <span class="keyword">AS</span> blocked_statement,</span><br><span class="line"></span><br><span class="line">         blocking_activity.query   <span class="keyword">AS</span> current_statement_in_blocking_process</span><br><span class="line"></span><br><span class="line">   <span class="keyword">FROM</span>  pg_catalog.pg_locks         blocked_locks</span><br><span class="line"></span><br><span class="line">    <span class="keyword">JOIN</span> pg_catalog.pg_stat_activity blocked_activity  <span class="keyword">ON</span> blocked_activity.pid <span class="operator">=</span> blocked_locks.pid</span><br><span class="line"></span><br><span class="line">    <span class="keyword">JOIN</span> pg_catalog.pg_locks         blocking_locks </span><br><span class="line"></span><br><span class="line">        <span class="keyword">ON</span> blocking_locks.locktype <span class="operator">=</span> blocked_locks.locktype</span><br><span class="line"></span><br><span class="line">        <span class="keyword">AND</span> blocking_locks.DATABASE <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">DISTINCT</span> <span class="keyword">FROM</span> blocked_locks.DATABASE</span><br><span class="line"></span><br><span class="line">        <span class="keyword">AND</span> blocking_locks.relation <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">DISTINCT</span> <span class="keyword">FROM</span> blocked_locks.relation</span><br><span class="line"></span><br><span class="line">        <span class="keyword">AND</span> blocking_locks.page <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">DISTINCT</span> <span class="keyword">FROM</span> blocked_locks.page</span><br><span class="line"></span><br><span class="line">        <span class="keyword">AND</span> blocking_locks.tuple <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">DISTINCT</span> <span class="keyword">FROM</span> blocked_locks.tuple</span><br><span class="line"></span><br><span class="line">        <span class="keyword">AND</span> blocking_locks.virtualxid <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">DISTINCT</span> <span class="keyword">FROM</span> blocked_locks.virtualxid</span><br><span class="line"></span><br><span class="line">        <span class="keyword">AND</span> blocking_locks.transactionid <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">DISTINCT</span> <span class="keyword">FROM</span> blocked_locks.transactionid</span><br><span class="line"></span><br><span class="line">        <span class="keyword">AND</span> blocking_locks.classid <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">DISTINCT</span> <span class="keyword">FROM</span> blocked_locks.classid</span><br><span class="line"></span><br><span class="line">        <span class="keyword">AND</span> blocking_locks.objid <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">DISTINCT</span> <span class="keyword">FROM</span> blocked_locks.objid</span><br><span class="line"></span><br><span class="line">        <span class="keyword">AND</span> blocking_locks.objsubid <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">DISTINCT</span> <span class="keyword">FROM</span> blocked_locks.objsubid</span><br><span class="line"></span><br><span class="line">        <span class="keyword">AND</span> blocking_locks.pid <span class="operator">!=</span> blocked_locks.pid</span><br><span class="line"></span><br><span class="line">     <span class="keyword">JOIN</span> pg_catalog.pg_stat_activity blocking_activity <span class="keyword">ON</span> blocking_activity.pid <span class="operator">=</span> blocking_locks.pid</span><br><span class="line"></span><br><span class="line">   <span class="keyword">WHERE</span> <span class="keyword">NOT</span> blocked_locks.GRANTED;</span><br></pre></td></tr></table></figure>

<p>或者使用这个sql</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT blocked_locks.pid     AS blocked_pid,</span><br><span class="line">         blocked_activity.usename  AS blocked_user,</span><br><span class="line">         blocking_locks.pid     AS blocking_pid,</span><br><span class="line">         blocking_activity.usename AS blocking_user,</span><br><span class="line">         blocked_activity.query    AS blocked_statement,</span><br><span class="line">         blocking_activity.query   AS current_statement_in_blocking_process</span><br><span class="line">   FROM  pg_catalog.pg_locks         blocked_locks</span><br><span class="line">    JOIN pg_catalog.pg_stat_activity blocked_activity  ON blocked_activity.pid = blocked_locks.pid</span><br><span class="line">    JOIN pg_catalog.pg_locks         blocking_locks</span><br><span class="line">        ON blocking_locks.locktype = blocked_locks.locktype</span><br><span class="line">        AND blocking_locks.DATABASE IS NOT DISTINCT FROM blocked_locks.DATABASE</span><br><span class="line">        AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation</span><br><span class="line">        AND blocking_locks.page IS NOT DISTINCT FROM blocked_locks.page</span><br><span class="line">        AND blocking_locks.tuple IS NOT DISTINCT FROM blocked_locks.tuple</span><br><span class="line">        AND blocking_locks.virtualxid IS NOT DISTINCT FROM blocked_locks.virtualxid</span><br><span class="line">        AND blocking_locks.transactionid IS NOT DISTINCT FROM blocked_locks.transactionid</span><br><span class="line">        AND blocking_locks.classid IS NOT DISTINCT FROM blocked_locks.classid</span><br><span class="line">        AND blocking_locks.objid IS NOT DISTINCT FROM blocked_locks.objid</span><br><span class="line">        AND blocking_locks.objsubid IS NOT DISTINCT FROM blocked_locks.objsubid</span><br><span class="line">        AND blocking_locks.pid != blocked_locks.pid</span><br><span class="line"> </span><br><span class="line">    JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid</span><br><span class="line">   WHERE NOT blocked_locks.GRANTED;</span><br></pre></td></tr></table></figure>

<h1 id="按建立连接的时间排序的正在运行查询的列表"><a href="#按建立连接的时间排序的正在运行查询的列表" class="headerlink" title="按建立连接的时间排序的正在运行查询的列表"></a>按建立连接的时间排序的正在运行查询的列表</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT * FROM pg_stat_activity ORDER BY backend_start;</span><br></pre></td></tr></table></figure>

<h1 id="统计idle，active，null的运行的sql的数量"><a href="#统计idle，active，null的运行的sql的数量" class="headerlink" title="统计idle，active，null的运行的sql的数量"></a>统计idle，active，null的运行的sql的数量</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select state, wait_event, wait_event_type, count(*) from pg_stat_activity group by 1,2,3 order by wait_event;</span><br></pre></td></tr></table></figure>

<h1 id="终止pid会话"><a href="#终止pid会话" class="headerlink" title="终止pid会话"></a>终止pid会话</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT pg_terminate_backend(&#x27;pid&#x27;);</span><br></pre></td></tr></table></figure>

<h1 id="确认当前的连接用户和对应的连接机器"><a href="#确认当前的连接用户和对应的连接机器" class="headerlink" title="确认当前的连接用户和对应的连接机器"></a>确认当前的连接用户和对应的连接机器</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT datname,usename,client_addr,client_port FROM pg_stat_activity ;</span><br></pre></td></tr></table></figure>

<h1 id="查看sql使用情况"><a href="#查看sql使用情况" class="headerlink" title="查看sql使用情况"></a>查看sql使用情况</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT datname,usename,query FROM pg_stat_activity ;</span><br></pre></td></tr></table></figure>

<h1 id="只查看当前正在运行的sql"><a href="#只查看当前正在运行的sql" class="headerlink" title="只查看当前正在运行的sql"></a>只查看当前正在运行的sql</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT datname,usename,query</span><br><span class="line">   FROM pg_stat_activity</span><br><span class="line">   WHERE state != &#x27;idle&#x27; </span><br></pre></td></tr></table></figure>

<h1 id="查看耗时较长的sql"><a href="#查看耗时较长的sql" class="headerlink" title="查看耗时较长的sql"></a>查看耗时较长的sql</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select current_timestamp - query_start as runtime, datname, usename, query</span><br><span class="line">    from pg_stat_activity</span><br><span class="line">    where state != &#x27;idle&#x27;</span><br><span class="line">    order by 1 desc;</span><br></pre></td></tr></table></figure>

<h1 id="查看数据库的最大链接数"><a href="#查看数据库的最大链接数" class="headerlink" title="查看数据库的最大链接数"></a>查看数据库的最大链接数</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">show max_connections;</span><br></pre></td></tr></table></figure>

<h1 id="查看当前使用的连接数"><a href="#查看当前使用的连接数" class="headerlink" title="查看当前使用的连接数"></a>查看当前使用的连接数</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT COUNT(*) from pg_stat_activity;</span><br></pre></td></tr></table></figure>

<h1 id="查看prepostsql的最大链接数"><a href="#查看prepostsql的最大链接数" class="headerlink" title="查看prepostsql的最大链接数"></a>查看prepostsql的最大链接数</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select min_val, max_val from pg_settings where name=&#x27;max_connections&#x27;;</span><br></pre></td></tr></table></figure>

<h1 id="查看正在运行的sql，并且带上运行时长"><a href="#查看正在运行的sql，并且带上运行时长" class="headerlink" title="查看正在运行的sql，并且带上运行时长"></a>查看正在运行的sql，并且带上运行时长</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT </span><br><span class="line">    procpid, </span><br><span class="line">    start, </span><br><span class="line">    now() - start AS lap, </span><br><span class="line">    current_query </span><br><span class="line">FROM </span><br><span class="line">    (SELECT </span><br><span class="line">        backendid, </span><br><span class="line">        pg_stat_get_backend_pid(S.backendid) AS procpid, </span><br><span class="line">        pg_stat_get_backend_activity_start(S.backendid) AS start, </span><br><span class="line">       pg_stat_get_backend_activity(S.backendid) AS current_query </span><br><span class="line">    FROM </span><br><span class="line">        (SELECT pg_stat_get_backend_idset() AS backendid) AS S </span><br><span class="line">    ) AS S </span><br><span class="line">WHERE </span><br><span class="line">   current_query &lt;&gt; &#x27;&lt;IDLE&gt;&#x27; </span><br><span class="line">ORDER BY </span><br><span class="line">   lap DESC;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>postgresql</tag>
      </tags>
  </entry>
  <entry>
    <title>x86平台安装arm虚拟机</title>
    <url>/arlo/70e443dc/</url>
    <content><![CDATA[<h1 id="软件准备"><a href="#软件准备" class="headerlink" title="软件准备"></a>软件准备</h1><p><code>麒麟操作系统：</code><a href="https://itas109.blog.csdn.net/article/details/109453945">https://itas109.blog.csdn.net/article/details/109453945</a></p>
<p><code>QEMU 软件：</code><a href="https://qemu.weilnetz.de/w64/2021/qemu-w64-setup-20210505.exe">https://qemu.weilnetz.de/w64/2021/qemu-w64-setup-20210505.exe</a></p>
<p><code>UEFI(BIOS的替代方案):</code> <a href="http://releases.linaro.org/components/kernel/uefi-linaro/16.02/release/qemu64/QEMU_EFI.fd">http://releases.linaro.org/components/kernel/uefi-linaro/16.02/release/qemu64/QEMU_EFI.fd</a></p>
<span id="more"></span>

<h1 id="安装QEMU软件"><a href="#安装QEMU软件" class="headerlink" title="安装QEMU软件"></a>安装QEMU软件</h1><p>新建一个目录 d:\vm\arm64\qemu ；</p>
<p>双击运行 qemu-w64-setup-20210505.exe， 安装至 d:\vm\arm64\qemu ；</p>
<h1 id="创建硬盘文件"><a href="#创建硬盘文件" class="headerlink" title="创建硬盘文件"></a>创建硬盘文件</h1><p>在 d:\vm\arm\qemu目录地址栏输入<code>cmd</code>，打开终端窗口；执行以下命令，创建一个40G的硬盘文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">qemu-img create -f qcow2 d:\vm\arm64\qemu\kylindisk.qcow2 40G</span><br></pre></td></tr></table></figure>

<h1 id="创建虚拟机"><a href="#创建虚拟机" class="headerlink" title="创建虚拟机"></a>创建虚拟机</h1><p>当前需要的文件路径，目录不要有空格</p>
<table>
<thead>
<tr>
<th>文件</th>
<th>路径</th>
</tr>
</thead>
<tbody><tr>
<td>操作系统镜像</td>
<td>D:\01-Tools\02-ISO\Kylin-Server-10-SP2-aarch64-Release-Build09-20210524.iso</td>
</tr>
<tr>
<td>qemu</td>
<td>D:\vm\arm64\qemu</td>
</tr>
<tr>
<td>QEMU_EFI.fd</td>
<td>D:\vm\arm64\QEMU_EFI.fd</td>
</tr>
<tr>
<td>虚拟机磁盘位置</td>
<td>D:\vm\arm64\qemu\kylindisk.qcow2</td>
</tr>
</tbody></table>
<p>使用以下命令创建虚拟机</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">qemu-system-aarch64.exe -m 8192 -cpu cortex-a72 -smp 8,sockets=4,cores=2 -M virt -bios D:\vm\arm64\QEMU_EFI.fd -device VGA -device nec-usb-xhci -device usb-mouse -device usb-kbd -drive if=none,file=D:\vm\arm64\qemu\kylindisk.qcow2,id=hd0 -device virtio-blk-device,drive=hd0 -drive if=none,file=D:\01-Tools\02-ISO\Kylin-Server-10-SP2-aarch64-Release-Build09-20210524.iso,id=cdrom,media=cdrom -device virtio-scsi-device -device scsi-cd,drive=cdrom  -net nic -net user,hostfwd=tcp::2222-:22</span><br></pre></td></tr></table></figure>

<p>执行完后会弹出窗口，和正常安装操作系统的步骤一样，Next–&gt;Next就完成了；</p>
<p>安装完成后可以进入操作系统，查看cpu架构</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">uname -m</span><br></pre></td></tr></table></figure>

<h1 id="启动虚拟机"><a href="#启动虚拟机" class="headerlink" title="启动虚拟机"></a>启动虚拟机</h1><p>进入到qemu目录，然后<code>cmd</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">qemu-system-aarch64.exe -m 8192 -cpu cortex-a72 -smp 8,sockets=4,cores=2 -M virt -bios D:\vm\arm64\QEMU_EFI.fd -device VGA -device nec-usb-xhci -device usb-mouse -device usb-kbd -drive if=none,file=D:\vm\arm64\qemu\kylindisk.qcow2,id=hd0 -device virtio-blk-device,drive=hd0 -drive if=none,file=,id=cdrom,media=cdrom -device virtio-scsi-device -device scsi-cd,drive=cdrom -net nic -net user,hostfwd=tcp::2222-:22</span><br></pre></td></tr></table></figure>



<p>参考连接：<a href="https://blog.csdn.net/weixin_44255842/article/details/120652227">https://blog.csdn.net/weixin_44255842/article/details/120652227</a></p>
]]></content>
      <categories>
        <category>国产化</category>
      </categories>
      <tags>
        <tag>虚拟化</tag>
        <tag>操作系统</tag>
      </tags>
  </entry>
  <entry>
    <title>搭建Chrony时间同步服务器</title>
    <url>/arlo/7c3b36f1/</url>
    <content><![CDATA[<h1 id="Chrony简介"><a href="#Chrony简介" class="headerlink" title="Chrony简介"></a>Chrony简介</h1><p>Chrony是一个开源自由的网络时间协议 NTP (Network Time Protocol) 的客户端和服务器软软件。它能让计算机保持系统时钟与时钟服务器（NTP）同步，因此让你的计算机保持精确的时间，Chrony也可以作为服务端软件为其他计算机提供时间同步服务。</p>
<p>Chrony由两个程序组成，分别是chronyd和chronyc；chronyd是一个后台运行的守护进程，用于调整内核中运行的系统时钟和时钟服务器同步。它确定计算机增减时间的比率，并对此进行补偿；chronyc提供了一个用户界面，用于监控性能并进行多样化的配置。它可以在chronyd实例控制的计算机上工作，也可以在一台不同的远程计算机上工作。</p>
<span id="more"></span>

<h1 id="Chrony服务器搭建"><a href="#Chrony服务器搭建" class="headerlink" title="Chrony服务器搭建"></a>Chrony服务器搭建</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum -y install chrony</span><br></pre></td></tr></table></figure>

<h2 id="Chrony的配置文件是-etc-chrony-conf"><a href="#Chrony的配置文件是-etc-chrony-conf" class="headerlink" title="Chrony的配置文件是/etc/chrony.conf"></a>Chrony的配置文件是<code>/etc/chrony.conf</code></h2><p><code>egrep -v &quot;^$|^#&quot; /etc/chrony.conf</code></p>
<blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 上级时钟源服务器地址</span><br><span class="line">server ntp.ntsc.ac.cn  iburst minpoll 4 maxpoll 6 prefer</span><br><span class="line">server ntp.aliyun.com  iburst minpoll 4 maxpoll 6</span><br><span class="line">server cn.ntp.org.cn   iburst minpoll 4 maxpoll 6</span><br><span class="line">server ntp.tencent.com iburst minpoll 4 maxpoll 6</span><br><span class="line"># iburst 表示当一个运程NTP服务器可用/不可用时，向它发送一系列的并发包进行检测。</span><br><span class="line"># minpoll 表示最小轮询时间，4表示2^4=16s；</span><br><span class="line"># maxpoll 表示最大轮询时间 2^6=64s; （默认minpoll 6 maxpoll 10）</span><br><span class="line"># prefer 表示优先使用该时间服务器。</span><br><span class="line"></span><br><span class="line"># 系统时钟频率都有小小的误差，这个就是为什么计算机运行一段时间后时间会不精确。NTP会自动来监测我们时钟的误差值并予以调整，所以它会把记录下来的误差先写入driftfile，重新启动系统后，之前的计算结果也就不会丢失了。</span><br><span class="line">driftfile /var/lib/chrony/drift</span><br><span class="line">makestep 1.0 3</span><br><span class="line">rtcsync</span><br><span class="line"># 允许客户端访问的地址范围</span><br><span class="line">allow 192.168.111.0/24</span><br><span class="line">#允许Linux服务器成为实时NTP服务器，即使server端无法从互联网同步时间，也同步本机时间至client</span><br><span class="line">local stratum 10</span><br><span class="line"># Chrony的日志文件</span><br><span class="line">logdir /var/log/chrony</span><br></pre></td></tr></table></figure>

</blockquote>
<h2 id="启动服务-amp-设置开机自启动"><a href="#启动服务-amp-设置开机自启动" class="headerlink" title="启动服务&amp;设置开机自启动"></a>启动服务&amp;设置开机自启动</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl start chronyd</span><br><span class="line">systemctl enable chronyd</span><br></pre></td></tr></table></figure>

<h2 id="防火墙允许服务"><a href="#防火墙允许服务" class="headerlink" title="防火墙允许服务"></a>防火墙允许服务</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">firewall-cmd --permanent --add-service=ntp</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<h1 id="Chrony客户端安装"><a href="#Chrony客户端安装" class="headerlink" title="Chrony客户端安装"></a>Chrony客户端安装</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum -y install chrony</span><br><span class="line">echo &quot;server 192.168.111.128 iburst&quot; &gt;&gt; /etc/chrony.conf </span><br><span class="line">systemctl start chronyd</span><br><span class="line">systemctl enable chronyd</span><br></pre></td></tr></table></figure>

<h1 id="测试Chrony"><a href="#测试Chrony" class="headerlink" title="测试Chrony"></a>测试Chrony</h1><h2 id="手动同步chrony时间"><a href="#手动同步chrony时间" class="headerlink" title="手动同步chrony时间"></a>手动同步chrony时间</h2><p>就像<code>ntpdate -u ntpserver </code>命令一样，我们可以使用chronyd手动将Linux服务器的时间与远程NTP服务器进行同步。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">chronyd -q ‘server &#123;ntp_server_name&#125; iburst’</span><br></pre></td></tr></table></figure>

<h2 id="验证-chrony-的同步"><a href="#验证-chrony-的同步" class="headerlink" title="验证 chrony 的同步"></a>验证 chrony 的同步</h2><p>用于查看本机和上级时钟源同步的状态</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@s1 ~]# chronyc tracking</span><br><span class="line">Reference ID    : CB6B0658 (203.107.6.88)	#上级时钟源的ID号（域名或IP）				</span><br><span class="line">Stratum         : 3		#本机所在的层级（1-15）。这里是3，上级时钟源在第2层</span><br><span class="line">Ref time (UTC)  : Mon Feb 13 11:26:22 2023	#最后一次同步到上级时钟源的时间</span><br><span class="line">System time     : 0.000001052 seconds fast of NTP time	#由于chrony慢同步导致的时间偏差</span><br><span class="line">Last offset     : -0.001335315 seconds	#最后一次同步上级时钟源，测出的和上级时钟源的偏差	</span><br><span class="line">RMS offset      : 0.001335315 seconds	#偏移量的长期平均值</span><br><span class="line">Frequency       : 0.102 ppm slow	#频率。表示本机发生错误的速度，如果chrony服务不纠正时间错误，怎会按照这个速度一直错下去</span><br><span class="line">Residual freq   : +66.280 ppm				</span><br><span class="line">Skew            : 1.828 ppm				#频率的误差范围	</span><br><span class="line">Root delay      : 0.048356328 seconds	#和一级时钟源的网络延时</span><br><span class="line">Root dispersion : 0.006139259 seconds	#累计到一级时钟源的色散，用于计算时间误差</span><br><span class="line">Update interval : 1.4 seconds	#和上级时钟源更新时间的间隔</span><br><span class="line">Leap status     : Normal	#跳变状态。Normal为正常，其他都不正常				</span><br></pre></td></tr></table></figure>

<p>查看和上级时钟源的一些基础信息</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@s1 ~]# chronyc ntpdata</span><br><span class="line"></span><br><span class="line">Remote address  : 114.118.7.163 (727607A3)	#真正同步的商机时钟源ip</span><br><span class="line">Remote port     : 123	#上级时钟源使用的端口</span><br><span class="line">Local address   : 192.168.111.128 (C0A86F80)	#本机用于和上级时钟源同步使用的ip</span><br><span class="line">Leap status     : Normal	#跳跃状态，和tracking一样，normal正常</span><br><span class="line">Version         : 4		#上级时钟源使用的ntp时钟源版本</span><br><span class="line">Mode            : Server	#上级时钟源的模式，^表示server，#表示local，=表示peer对端</span><br><span class="line">Stratum         : 2	#上级时钟源的层级</span><br><span class="line">Poll interval   : 6 (64 seconds)	#和上级时钟源同步时间的间隔，6表示2^6=64秒</span><br><span class="line">Precision       : -22 (0.000000238 seconds)</span><br><span class="line">Root delay      : 0.079330 seconds #到一级时钟源（根时钟源）的网络延迟</span><br><span class="line">Root dispersion : 0.142868 seconds #累计到根时钟源的色散总和</span><br><span class="line">Reference ID    : 7B8B2103 ()</span><br><span class="line">Reference time  : Mon Feb 13 10:37:07 2023	#最后一次和上级时钟源同步到的时间</span><br><span class="line">Offset          : +0.004998442 seconds	#和上级时钟源的偏移量</span><br><span class="line">Peer delay      : 0.062938333 seconds	#到对端的延迟</span><br><span class="line">Peer dispersion : 0.000001180 seconds	#累计到对端的色散</span><br><span class="line">Response time   : 0.000019070 seconds	#请求包发给上级时钟源，上级时钟源在返回响应包之前等待的时间</span><br><span class="line">Jitter asymmetry: +0.50	#表示和上级时钟源发送请求包，接收响应包的网络延迟，-号表示发送请求包的延迟，+号表示接收响应包的延迟</span><br><span class="line">NTP tests       : 111 111 1101</span><br><span class="line">Interleaved     : No</span><br><span class="line">Authenticated   : No</span><br><span class="line">TX timestamping : Kernel</span><br><span class="line">RX timestamping : Kernel</span><br><span class="line">Total TX        : 21	#向上级时钟源发送的请求包总数</span><br><span class="line">Total RX        : 17	#收到的上级时钟源返回的相应包总数</span><br><span class="line">Total valid RX  : 17	#收到的上级时钟源返回的有效响应包总数</span><br></pre></td></tr></table></figure>

<h2 id="检查-chrony-来源"><a href="#检查-chrony-来源" class="headerlink" title="检查 chrony 来源"></a>检查 chrony 来源</h2><p>列出有关chronyd使用的当前时间源的信息</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@s1 ~]# chronyc sources </span><br><span class="line">210 Number of sources = 4</span><br><span class="line">MS Name/IP address         Stratum Poll Reach LastRx Last sample               </span><br><span class="line">===============================================================================</span><br><span class="line">^- 114.118.7.163                 2   6   277    29    -12ms[  -12ms] +/-  168ms</span><br><span class="line">^+ 203.107.6.88                  2   6   377    32  -1364us[-1364us] +/-   25ms</span><br><span class="line">^* 49.7.178.213                  2   6   107    72   +105us[  -73us] +/-   18ms</span><br><span class="line">^+ 106.55.184.199                2   6   377    90  +4271us[+4108us] +/-   29ms</span><br></pre></td></tr></table></figure>

<p>列出有关chronyd使用的每个源的漂移速度和偏移估计的信息</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@s1 ~]# chronyc sources -v</span><br><span class="line">210 Number of sources = 4</span><br><span class="line"></span><br><span class="line">  .-- Source mode  &#x27;^&#x27; = server, &#x27;=&#x27; = peer, &#x27;#&#x27; = local clock.</span><br><span class="line"> / .- Source state &#x27;*&#x27; = current synced, &#x27;+&#x27; = combined , &#x27;-&#x27; = not combined,</span><br><span class="line">| /   &#x27;?&#x27; = unreachable, &#x27;x&#x27; = time may be in error, &#x27;~&#x27; = time too variable.</span><br><span class="line">||                                                 .- xxxx [ yyyy ] +/- zzzz</span><br><span class="line">||      Reachability register (octal) -.           |  xxxx = adjusted offset,</span><br><span class="line">||      Log2(Polling interval) --.      |          |  yyyy = measured offset,</span><br><span class="line">||                                \     |          |  zzzz = estimated error.</span><br><span class="line">||                                 |    |           \</span><br><span class="line">MS Name/IP address         Stratum Poll Reach LastRx Last sample               </span><br><span class="line">===============================================================================</span><br><span class="line">^- 114.118.7.163                 2   6   277    45    -12ms[  -12ms] +/-  168ms</span><br><span class="line">^+ 203.107.6.88                  2   6   377    48  -1364us[-1364us] +/-   25ms</span><br><span class="line">^* 49.7.178.213                  2   6   107    88   +105us[  -73us] +/-   18ms</span><br><span class="line">^+ 106.55.184.199                2   6   377   106  +4271us[+4108us] +/-   29ms</span><br></pre></td></tr></table></figure>

<p><u><strong>输出信息详解：</strong></u></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">第一列M：</span><br><span class="line">这表示信号源的模式。</span><br><span class="line">^表示服务器；</span><br><span class="line">=表示对等方；</span><br><span class="line">＃表示本地连接的参考时钟。</span><br><span class="line"></span><br><span class="line">第二列S：</span><br><span class="line">\*号：表示和上级时钟源同步正常；</span><br><span class="line">+号：备用的、网络正常可达的、被 chrony 算法认可的上级时钟源，*号的时钟源同步异常，首选+号的时钟源；</span><br><span class="line">-号：网络正常可达的、但是不被 chrony 算法认可的上级时钟源。*号的时钟源有问题，不会选择-号的；</span><br><span class="line">？号：表示网络不可达、同步异常的上级时钟源。出问题就是？号。</span><br><span class="line">x 号：网络正常可达，但是被 chrony 认为时间错误的上级时钟源。一般多个时钟源出现脑裂，客户端看到就是 x 号；</span><br><span class="line"></span><br><span class="line">第三列Name/IP address：</span><br><span class="line">这显示了源的名称或IP地址，或参考时钟的参考ID。</span><br><span class="line"></span><br><span class="line">第四列 Stratum:</span><br><span class="line">这显示了来源的层，如其最近收到的样本中所报告的那样。层1表示一台具有本地连接的参考时钟的计算机。与第1层计算机同步的计算机位于第2层。与第2层计算机同步的计算机位于第3层，依此类推。</span><br><span class="line"></span><br><span class="line">第五列 Poll：</span><br><span class="line">这显示轮询源的速率，以秒为单位的时间间隔的以2为底的对数。因此，值为6表示每64秒进行一次测量。chronyd会根据当前情况自动更改轮询速率。</span><br><span class="line"></span><br><span class="line">第六列 Reach：</span><br><span class="line">这显示了源的可达性寄存器以八进制数字打印。寄存器有8位，并在每个从源接收或丢失的数据包上更新。值377表示从最后八次传输中收到了对所有用户的有效答复。</span><br><span class="line"></span><br><span class="line">第七列 LastRx：</span><br><span class="line">此列显示多长时间前从来源接收到了最后一个好的样本（在下一列中显示）。未通过某些测试的测量将被忽略。通常以秒为单位。字母m，h，d或y表示分钟，小时，天或年。</span><br><span class="line"></span><br><span class="line">第八列 Last sample:</span><br><span class="line">此列显示上次测量时本地时钟与源之间的偏移。方括号中的数字表示实际测得的偏移量。可以用ns（表示纳秒），us （表示微秒），ms（表示毫秒）或s（表示秒）作为后缀。方括号左侧的数字表示原始测量值，已调整为允许此后施加于本地时钟的任何摆度。</span><br><span class="line"></span><br><span class="line">+/-指示器后面的数字表示测量中的误差范围。正偏移表示本地时钟位于源时钟之前。</span><br></pre></td></tr></table></figure>

<h1 id="批量服务器时间同步"><a href="#批量服务器时间同步" class="headerlink" title="批量服务器时间同步"></a>批量服务器时间同步</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">#不连续ip地址可以使用数组的方式生成</span><br><span class="line">#list=(50 60 70 80)</span><br><span class="line">#for i in $&#123;list[@]&#125;;</span><br><span class="line">#连续的ip地址可以使用seq列表的方式生成</span><br><span class="line">for i in `seq 1 254`</span><br><span class="line">do </span><br><span class="line">    ip=192.168.111.$i</span><br><span class="line">    ping -c1 $ip &amp;&gt; /dev/null</span><br><span class="line">    if [ $? -eq 0 ]; then</span><br><span class="line">        echo &quot;$ip is up~&quot;</span><br><span class="line">        sshpass -p password ssh -o StrictHostKeyChecking=no root@$ip &quot;yum -y install chrony &amp;&amp; sed -i &#x27;/server / s/^\(.*\)$/#\1/g&#x27; /etc/chrony.conf &amp;&amp; echo &#x27;server 192.168.111.128 iburst&#x27; &gt;&gt; /etc/chrony.conf &amp;&amp; systemctl restart chronyd &amp;&amp; systemctl enable chronyd&quot;</span><br><span class="line">    else </span><br><span class="line">        echo &quot;$ip is down.&quot;</span><br><span class="line">    fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>chrony</tag>
        <tag>时间</tag>
      </tags>
  </entry>
  <entry>
    <title>麒麟V10 grub修复</title>
    <url>/arlo/8d7f386d/</url>
    <content><![CDATA[<h1 id="故障现象"><a href="#故障现象" class="headerlink" title="故障现象"></a>故障现象</h1><p>物理机无法引导进去操作系统，光标停止在grub&gt;，故障现象如下图所示：</p>
<p><img src="/images/2023/0314/01.jpg" alt="01"></p>
<h1 id="问题原因"><a href="#问题原因" class="headerlink" title="问题原因"></a>问题原因</h1><p>grub2配置文件损坏，无法进入系统。 可能是由于调整分区或MBR&#x2F;GPT分区表损坏，造成grub2不能正常启动，进入了救援模式。</p>
<span id="more"></span>

<h1 id="确定boot分区和根分区"><a href="#确定boot分区和根分区" class="headerlink" title="确定boot分区和根分区"></a>确定boot分区和根分区</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">grub &gt; ls  #查看有哪些磁盘分区</span><br><span class="line">grub &gt; ls (hd0,gpt1)/   #EFI分区</span><br><span class="line">grub &gt; ls (hd0,gpt2)/   #boot分区</span><br><span class="line">grub &gt; ls (hd0,gpt3)/   #根分区</span><br></pre></td></tr></table></figure>

<p><img src="/images/2023/0314/02.png" alt="01"></p>
<h1 id="临时修复启动："><a href="#临时修复启动：" class="headerlink" title="临时修复启动："></a>临时修复启动：</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">grub &gt; insmod xfs</span><br><span class="line">grub &gt; set root=&#x27;hd0,gpt2&#x27;    #这里指定的应该是/boot分区，这个分区下应该有 vmlinuz-0-rescue以及initramfs-0-rescue文件。</span><br><span class="line">grub &gt; linux /vmlinuz-0-rescue-xxx root=/dev/mapper/klas-root    #因为有独立的boot分区，所以linux 后面可以直接跟/vmlinuz，该文件存放位于/boot下</span><br><span class="line">grub &gt; initrd /initramfs-0-rescue-xxx.img</span><br><span class="line">grub &gt; boot</span><br></pre></td></tr></table></figure>

<p><img src="/images/2023/0314/03.png" alt="01"></p>
<h1 id="启动后进入系统，安装grub2："><a href="#启动后进入系统，安装grub2：" class="headerlink" title="启动后进入系统，安装grub2："></a>启动后进入系统，安装grub2：</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">lsblk</span><br><span class="line"></span><br><span class="line">yum -y install grub2-aa64-modules  #如果没有网络，可以挂载镜像拷贝grub2-aa64-modules.2.02-76.p05.ky10.noarch.rpm 包自行安装</span><br><span class="line"></span><br><span class="line">grub2-install /dev/sda   #如果报“grub2-install：error： /usr/lib/grub/arm64-efi/modinfo.sh doesn’t exist. Please specify --target or --directory.”，则说明未安装grub2-aa64-modules.noarch。</span><br></pre></td></tr></table></figure>

<h1 id="重新生成grub-cfg文件："><a href="#重新生成grub-cfg文件：" class="headerlink" title="重新生成grub.cfg文件："></a>重新生成grub.cfg文件：</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">grub2-mkconfig -o /boot/efi/EFI/kylin/grub.cfg</span><br></pre></td></tr></table></figure>

<h1 id="重启验证"><a href="#重启验证" class="headerlink" title="重启验证"></a>重启验证</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">reboot</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>国产化</category>
      </categories>
      <tags>
        <tag>Troubleshooting</tag>
      </tags>
  </entry>
  <entry>
    <title>Pod 状态及 Pod 故障排查命令</title>
    <url>/arlo/64397568/</url>
    <content><![CDATA[<p>Pod 状态及 Pod 故障排查命令</p>
<table>
<thead>
<tr>
<th>状态</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Pending（挂起）</td>
<td>Pod 已被 Kubernetes 系统接收，但仍有一个或多个容器未被创建，可以通过kubectl describe 查看处于 Pending 状态的原因</td>
</tr>
<tr>
<td>Running（运行中）</td>
<td>Pod 已经被绑定到一个节点上，并且所有的容器都已经被创建，而且至少有一个是运行状态，或者是正在启动或者重启，可以通过 kubectl logs 查看 Pod 的日志</td>
</tr>
<tr>
<td>Succeeded（成功）</td>
<td>所有容器执行成功并终止，并且不会再次重启，可以通过 kubectl logs 查看 Pod日志</td>
</tr>
<tr>
<td>Failed（失败）</td>
<td>所有容器都已终止，并且至少有一个容器以失败的方式终止，也就是说这个容器要么以非零状态退出，要么被系统终止，可以通过 logs 和 describe 查看 Pod 日志和状态</td>
</tr>
<tr>
<td>Unknown（未知）</td>
<td>通常是由于通信问题造成的无法获得 Pod 的状态</td>
</tr>
<tr>
<td>ImagePullBackOff<br/>ErrImagePull</td>
<td>镜像拉取失败，一般是由于镜像不存在、网络不通或者需要登录认证引起的，可以使用 describe 命令查看具体原因</td>
</tr>
<tr>
<td>CrashLoopBackOff</td>
<td>容器启动失败，可以通过 logs 命令查看具体原因，一般为启动命令不正确，健康检查不通过等</td>
</tr>
<tr>
<td>OOMKilled</td>
<td>容器内存溢出，一般是容器的内存 Limit 设置的过小，或者程序本身有内存溢出，可以通过 logs 查看程序启动日志</td>
</tr>
<tr>
<td>Terminating</td>
<td>Pod 正在被删除，可以通过 describe 查看状态</td>
</tr>
<tr>
<td>SysctlForbidden</td>
<td>Pod 自定义了内核配置，但 kubelet 没有添加内核配置或配置的内核参数不支持，可以通过 describe 查看具体原因</td>
</tr>
<tr>
<td>Completed</td>
<td>容器内部主进程退出，一般计划任务执行结束会显示该状态，此时可以通过 logs查看容器日志</td>
</tr>
<tr>
<td>ContainerCreating</td>
<td>Pod 正在创建，一般为正在下载镜像，或者有配置不当的地方，可以通过 describe查看具体原因</td>
</tr>
</tbody></table>
<blockquote>
<p>Pod 的 Phase 字段只有 Pending、Running、Succeeded、Failed、Unknown，其余的为处于上述状态的原因，可以通过 kubectl get po xxx –o yaml 查看。</p>
</blockquote>
<p>参考：<a href="https://edu.51cto.com/center/course/lesson/index?id=824674">https://edu.51cto.com/center/course/lesson/index?id=824674</a></p>
]]></content>
      <categories>
        <category>DevOps</category>
      </categories>
      <tags>
        <tag>Kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title>K8S命令tab补全</title>
    <url>/arlo/7f65520b/</url>
    <content><![CDATA[<p>配置k8s命令tab补全并设置别名</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum install -y bash-completion</span><br><span class="line">source /usr/share/bash-completion/bash_completion</span><br><span class="line">source &lt;(kubectl completion bash)</span><br><span class="line">echo &quot;source &lt;(kubectl completion bash)&quot; &gt;&gt; ~/.bashrc</span><br><span class="line"># 设置kubectl别名为k</span><br><span class="line">echo &quot;alias k=kubectl&quot; &gt;&gt; ~/.bashrc</span><br><span class="line">#这句不加的话用kubectl可以使用Tab键自动补全，但是别名k不能使用Tab键自动补全</span><br><span class="line">echo &quot;complete -F __start_kubectl k &gt;&gt; ~/.bashrc</span><br></pre></td></tr></table></figure>

<p><code>source ~/.bashrc</code></p>
<p>输入“k ge[tab] no[tab]”效果如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@k8s-master01 ~]# k get nodes</span><br><span class="line">NAME           STATUS   ROLES           AGE     VERSION</span><br><span class="line">k8s-master01   Ready    control-plane   5d15h   v1.26.3</span><br><span class="line">k8s-master02   Ready    control-plane   5d15h   v1.26.3</span><br><span class="line">k8s-master03   Ready    control-plane   5d15h   v1.26.3</span><br><span class="line">k8s-node01     Ready    &lt;none&gt;          5d15h   v1.26.3</span><br><span class="line">k8s-node02     Ready    &lt;none&gt;          5d15h   v1.26.3</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>DevOps</category>
      </categories>
      <tags>
        <tag>Kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title>K8S|5.标签(label)操作</title>
    <url>/arlo/3be5dee8/</url>
    <content><![CDATA[<h1 id="标签"><a href="#标签" class="headerlink" title="标签"></a>标签</h1><p>标签（Labels）是附加到Kubernetes对象（比如 Pod）上的键值对。标签旨在用于指定对用户有意义且相关的对象标识属性。标签可以在创建时附加到对象，随后可以随时添加和修改。每个对象都可以定义一组键（Key）&#x2F; 值（Value）标签，但是每个键（Key）对于给定对象必须是唯一的。</p>
<p>标签作用：就是用来给k8s中对象起别名，有了别名可以过滤和筛选</p>
<h1 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h1><p>标签由键值对组成，其有效标签值：</p>
<ul>
<li>最多为63个字符（可以为空）</li>
<li>除非标签值为空，必须以字母数字字符（[a-z0-9A-Z]）开头和结尾</li>
<li>包含破折号（-）、下划线（_）、点（、）和字母或数字</li>
</ul>
<h1 id="查看所有node节点标签"><a href="#查看所有node节点标签" class="headerlink" title="查看所有node节点标签"></a>查看所有node节点标签</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@k8s-master01 ~]# kubectl get nodes --show-labels</span><br><span class="line">NAME           STATUS   ROLES           AGE     VERSION   LABELS</span><br><span class="line">k8s-master01   Ready    control-plane   6d17h   v1.26.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-master01,kubernetes.io/os=linux,node-role.kubernetes.io/control-plane=,node.kubernetes.io/exclude-from-external-load-balancers=</span><br><span class="line">k8s-master02   Ready    control-plane   6d17h   v1.26.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-master02,kubernetes.io/os=linux,node-role.kubernetes.io/control-plane=,node.kubernetes.io/exclude-from-external-load-balancers=</span><br><span class="line">k8s-master03   Ready    control-plane   6d17h   v1.26.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-master03,kubernetes.io/os=linux,node-role.kubernetes.io/control-plane=,node.kubernetes.io/exclude-from-external-load-balancers=</span><br><span class="line">k8s-node01     Ready    &lt;none&gt;          6d17h   v1.26.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-node01,kubernetes.io/os=linux</span><br><span class="line">k8s-node02     Ready    &lt;none&gt;          6d17h   v1.26.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-node02,kubernetes.io/os=linux</span><br></pre></td></tr></table></figure>

<p>标签操作命令格式<code>kubectl label nodes &lt;nodename&gt; label_name=label_value</code></p>
<span id="more"></span>

<h1 id="添加标签"><a href="#添加标签" class="headerlink" title="添加标签"></a>添加标签</h1><p>给node节点添加一个磁盘类型为ssd的标签</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@k8s-master01 ~]# kubectl label nodes k8s-node01 k8s-node02 disktype=ssd</span><br><span class="line">node/k8s-node01 labeled</span><br><span class="line">node/k8s-node02 labeled</span><br></pre></td></tr></table></figure>

<h1 id="查看标签"><a href="#查看标签" class="headerlink" title="查看标签"></a>查看标签</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">--查看所有标签</span><br><span class="line">[root@k8s-master01 ~]# kubectl get nodes --show-labels</span><br><span class="line">NAME           STATUS   ROLES           AGE     VERSION   LABELS</span><br><span class="line">k8s-master01   Ready    control-plane   6d17h   v1.26.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-master01,kubernetes.io/os=linux,node-role.kubernetes.io/control-plane=,node.kubernetes.io/exclude-from-external-load-balancers=</span><br><span class="line">k8s-master02   Ready    control-plane   6d17h   v1.26.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-master02,kubernetes.io/os=linux,node-role.kubernetes.io/control-plane=,node.kubernetes.io/exclude-from-external-load-balancers=</span><br><span class="line">k8s-master03   Ready    control-plane   6d17h   v1.26.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-master03,kubernetes.io/os=linux,node-role.kubernetes.io/control-plane=,node.kubernetes.io/exclude-from-external-load-balancers=</span><br><span class="line">k8s-node01     Ready    &lt;none&gt;          6d17h   v1.26.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,disktype=ssd,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-node01,kubernetes.io/os=linux</span><br><span class="line">k8s-node02     Ready    &lt;none&gt;          6d17h   v1.26.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,disktype=ssd,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-node02,kubernetes.io/os=linux</span><br><span class="line"></span><br><span class="line">--查看指定标签节点</span><br><span class="line">[root@k8s-master01 ~]# kubectl get nodes -l disktype=ssd</span><br><span class="line">NAME         STATUS   ROLES    AGE     VERSION</span><br><span class="line">k8s-node01   Ready    &lt;none&gt;   6d17h   v1.26.3</span><br><span class="line">k8s-node02   Ready    &lt;none&gt;   6d17h   v1.26.3</span><br></pre></td></tr></table></figure>

<h1 id="删除标签"><a href="#删除标签" class="headerlink" title="删除标签"></a>删除标签</h1><p>删除一个label，只需在命令行最后指定label的key名后跟一个减号相连（（label_name-）即可</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@k8s-master01 ~]# kubectl label nodes k8s-node02 disktype-</span><br><span class="line">node/k8s-node02 unlabeled</span><br><span class="line">可以看到k8s-node02 disktype=ssd标签已经被删除了</span><br><span class="line">[root@k8s-master01 ~]# kubectl get nodes -l disktype</span><br><span class="line">NAME         STATUS   ROLES    AGE     VERSION</span><br><span class="line">k8s-node01   Ready    &lt;none&gt;   6d17h   v1.26.3</span><br></pre></td></tr></table></figure>

<h1 id="修改标签的值"><a href="#修改标签的值" class="headerlink" title="修改标签的值"></a>修改标签的值</h1><p>修改一个label的值，需要加上<code>--overwrite</code>参数</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@k8s-master01 ~]# kubectl label nodes k8s-node01 disktype=sata --overwrite</span><br><span class="line">node/k8s-node01 labeled</span><br><span class="line">[root@k8s-master01 ~]# kubectl get nodes -l disktype=ssd</span><br><span class="line">No resources found</span><br><span class="line">[root@k8s-master01 ~]# kubectl get nodes -l disktype=sata</span><br><span class="line">NAME         STATUS   ROLES    AGE     VERSION</span><br><span class="line">k8s-node01   Ready    &lt;none&gt;   6d17h   v1.26.3</span><br></pre></td></tr></table></figure>

<h1 id="筛选标签"><a href="#筛选标签" class="headerlink" title="筛选标签"></a>筛选标签</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubectl get po -l disktype</span><br><span class="line">kubectl get po -l disktype=ssd</span><br><span class="line">kubectl get po -l &#x27;!disktype&#x27;  </span><br><span class="line">kubectl get po -l &#x27;disktype in (ssd,ssta)&#x27;</span><br><span class="line">kubectl get po -l &#x27;disktype notin (ssd)&#x27;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>DevOps</category>
      </categories>
      <tags>
        <tag>Kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title>VMware虚拟机里搭建Zstack环境，添加物理机报错‘ could not insert &#39;kvm_amd&#39;: Operation not supported stdout’</title>
    <url>/arlo/29447fff/</url>
    <content><![CDATA[<h1 id="故障现象"><a href="#故障现象" class="headerlink" title="故障现象"></a>故障现象</h1><p>在Vmware Workstation中安装了Zstack环境，在初始化添加物理机环节报错</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">shell command[sudo PYTHONPATH=/usr/local/zstack/ansible/files/zstacklib timeout 1800 python2 /usr/local/zstack/ansible/kvm.py -i /usr/local/zstack/ansible/hosts --private-key /usr/local/zstack/apache-tomcat-8.5.57/webapps/zstack/WEB-INF/classes/ansible/rsaKeys/id_rsa -e &#x27;&#123; &quot;init&quot;: &quot;true&quot;, &quot;chrony_servers&quot;: &quot;192.168.111.128&quot;, &quot;trusted_host&quot;: &quot;192.168.111.128&quot;, &quot;remote_port&quot;: &quot;22&quot;, &quot;update_packages&quot;: &quot;true&quot;, &quot;host_uuid&quot;: &quot;e308280cbfd540938d1229e59f932c05&quot;, &quot;zstack_root&quot;: &quot;/var/lib/zstack&quot;, &quot;remote_user&quot;: &quot;root&quot;, &quot;hostname&quot;: &quot;192-168-111-128.zstack.org&quot;, &quot;pkg_kvmagent&quot;: &quot;kvmagent-4.4.0.tar.gz&quot;, &quot;post_url&quot;: &quot;http://192.168.111.128:8080/zstack/kvm/ansiblelog/e308280cbfd540938d1229e59f932c05\n&quot;, &quot;remote_pass&quot;: &quot;*****&quot;, &quot;host&quot;: &quot;192.168.111.128&quot;, &quot;pip_url&quot;: &quot;http://192.168.111.128:8080/zstack/static/pypi/simple&quot;, &quot;zstack_repo&quot;: &quot;\&quot;zstack-mn,qemu-kvm-ev-mn\&quot;&quot;, &quot;yum_server&quot;: &quot;192.168.111.128:8080&quot;, &quot;pkg_zstacklib&quot;: &quot;zstacklib-4.4.0.tar.gz&quot; &#125;&#x27;] failed ret code: 1 stderr: ERROR: [ HOST: 192.168.111.128 ] ERROR: change kernel module kvm_amd status to present failed error: modprobe: ERROR: could not insert &#x27;kvm_amd&#x27;: Operation not supported stdout:</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h1 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h1><ol>
<li>关闭vmware workstation虚拟机</li>
<li>点击虚拟机-设置-处理器-虚拟化引擎，勾选”虚拟化 Intel VT-x&#x2F;EPT 或 AMD-V&#x2F;RVI(V)”</li>
</ol>
]]></content>
      <categories>
        <category>Troubleshooting</category>
      </categories>
      <tags>
        <tag>Troubleshooting</tag>
      </tags>
  </entry>
  <entry>
    <title>K8S|6.deployment常用操作</title>
    <url>/arlo/becf7518/</url>
    <content><![CDATA[<h1 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h1><p>参考：<a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/deployment/">https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/deployment/</a></p>
<h1 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h1><p><code>vim nginx-deployment.yml</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deployment</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-deployment</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx-deployment</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: nginx-deployment</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-deployment</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: nginx-deployment</span><br><span class="line">          image: registry.cn-hangzhou.aliyuncs.com/alxq/nginx:stable-alpine3.17 </span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">      restartPolicy: Always</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubectl apply -f nginx-deployment.yml</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h1 id="查看"><a href="#查看" class="headerlink" title="查看"></a>查看</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubectl get deployment nginx-deployment  		##或者可以写作kubectl get deployment/nginx-deployment</span><br><span class="line">NAME               READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-deployment   3/3     3            3           5h31m</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">在检查集群中的 Deployment 时，所显示的字段有：</span><br><span class="line"></span><br><span class="line">NAME 列出了名字空间中 Deployment 的名称。</span><br><span class="line">READY 显示应用程序的可用的“副本”数。显示的模式是“就绪个数/期望个数”。</span><br><span class="line">UP-TO-DATE 显示为了达到期望状态已经更新的副本数。</span><br><span class="line">AVAILABLE 显示应用可供用户使用的副本数。</span><br><span class="line">AGE 显示应用程序运行的时间。</span><br><span class="line">请注意期望副本数是根据 .spec.replicas 字段设置 3。</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#查看deployment详细描述信息</span><br><span class="line">kubectl describe deployment nginx-deployment</span><br></pre></td></tr></table></figure>

<h1 id="扩-x2F-缩容副本"><a href="#扩-x2F-缩容副本" class="headerlink" title="扩&#x2F;缩容副本"></a>扩&#x2F;缩容副本</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubectl get pod</span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-deployment-58d666ff55-2z556   1/1     Running   0          4m9s</span><br><span class="line">nginx-deployment-58d666ff55-gs2kl   1/1     Running   0          4m20s</span><br><span class="line">nginx-deployment-58d666ff55-hn9s8   1/1     Running   0          4m18s</span><br><span class="line"></span><br><span class="line">kubectl scale deployment nginx-deployment --replicas=5</span><br><span class="line"></span><br><span class="line">kubectl get pod</span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-deployment-58d666ff55-2z556   1/1     Running   0          4m37s</span><br><span class="line">nginx-deployment-58d666ff55-c84mh   1/1     Running   0          23s</span><br><span class="line">nginx-deployment-58d666ff55-gs2kl   1/1     Running   0          4m48s</span><br><span class="line">nginx-deployment-58d666ff55-hn9s8   1/1     Running   0          4m46s</span><br><span class="line">nginx-deployment-58d666ff55-jpvzc   1/1     Running   0          24s</span><br></pre></td></tr></table></figure>

<h1 id="回滚"><a href="#回滚" class="headerlink" title="回滚"></a>回滚</h1><p>Deployment 的 Pod 模板（.spec.template）发生更改时，才会创建新修订版本 – 例如，模板的标签或容器镜像发生变化。 其他更新，如 Deployment 的扩缩容操作不会创建 Deployment 修订版本。 这是为了方便同时执行手动缩放或自动缩放。 换言之，当你回滚到较早的修订版本时，只有 Deployment 的 Pod 模板部分会被回滚。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 查看 Deployment 上线状态</span><br><span class="line">kubectl rollout status deployment nginx-deployment</span><br><span class="line"></span><br><span class="line"># 检查 Deployment 修订历史</span><br><span class="line">kubectl rollout history deployment/nginx-deployment</span><br><span class="line"></span><br><span class="line"># 查看修订历史的详细信息</span><br><span class="line">kubectl rollout history deployment/nginx-deployment --revision=2</span><br><span class="line"></span><br><span class="line"># 回滚到之前的修订版本</span><br><span class="line">kubectl rollout undo deployment/nginx-deployment  #回滚到上个版本</span><br><span class="line">kubectl rollout undo deployment/nginx-deployment --to-revision=2 #回滚到指定版本</span><br><span class="line"></span><br><span class="line"># 重新部署当前版本</span><br><span class="line">kubectl rollout restart deployment/nginx-deployment</span><br></pre></td></tr></table></figure>

<h1 id="暂停、更新、恢复"><a href="#暂停、更新、恢复" class="headerlink" title="暂停、更新、恢复"></a>暂停、更新、恢复</h1><p>在你更新一个 Deployment 的时候，你可以在触发一个或多个更新之前暂停 Deployment 的上线过程。 当你准备应用这些变更时，你可以重新恢复 Deployment 上线过程。 这样做使得你能够在暂停和恢复执行之间应用多个修补程序，而不会触发不必要的上线操作。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#在做这个之前，我们可以监控pod(或者rs)的状态变化，暂停deploy后进行更新，pod没有触发更新，在恢复后进行一次变更</span><br><span class="line">kubectl get po -l app=nginx-deployment -w</span><br><span class="line"></span><br><span class="line"># 暂停deployment</span><br><span class="line">kubectl rollout pause deployment/nginx-deployment</span><br><span class="line"></span><br><span class="line"># 更新deployment</span><br><span class="line">kubectl set image deployment/nginx-deployment nginx=nginx:1.16.1</span><br><span class="line">kubectl set resources deployment/nginx-deployment -c=nginx-deployment --limits=cpu=200m,memory=512Mi</span><br><span class="line"></span><br><span class="line"># 恢复deployment</span><br><span class="line">kubectl rollout resume deployment/nginx-deployment</span><br></pre></td></tr></table></figure>

<h1 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 删除deployment</span><br><span class="line">kubectl delete deployment nginx-deployment </span><br><span class="line">kubectl delete -f nginx-deployment.yml  #建议使用指定配置文件删除</span><br><span class="line"></span><br><span class="line">#删除命名空间下所有资源</span><br><span class="line">kubectl delete all --all [-n namespace-name]</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>DevOps</category>
      </categories>
      <tags>
        <tag>Kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot项目，访问验证码出现Handler dispatch failed: java.lang.InternalError: java.lang.reflect.InvocationTargetException </title>
    <url>/arlo/d8c02aa3/</url>
    <content><![CDATA[<h1 id="报错信息"><a href="#报错信息" class="headerlink" title="报错信息"></a>报错信息</h1><p>部署Springboot 人人框架时候，访问验证码看到返回状态码为200，但是页面无法正常显示，查看后台日志，发现报错如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">2023-10-23T13:15:56.314+08:00 ERROR 26705 --- [nio-8082-exec-1] c.l.c.log.exception.RenExceptionHandler  : Handler dispatch failed: java.lang.InternalError: java.lang.reflect.InvocationTargetException</span><br><span class="line"></span><br><span class="line">jakarta.servlet.ServletException: Handler dispatch failed: java.lang.InternalError: java.lang.reflect.InvocationTargetException</span><br><span class="line">	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1096)</span><br><span class="line">	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:974)</span><br><span class="line">	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1011)</span><br><span class="line">	at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:903)</span><br><span class="line">	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:564)</span><br><span class="line">	at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:885)</span><br><span class="line">	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:658)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:205)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:149)</span><br><span class="line">	at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:51)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:174)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:149)</span><br><span class="line">	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:110)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:174)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:149)</span><br><span class="line">	at org.springframework.security.web.FilterChainProxy.lambda$doFilterInternal$3(FilterChainProxy.java:231)</span><br><span class="line">	at org.springframework.security.web.ObservationFilterChainDecorator$FilterObservation$SimpleFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:479)</span><br><span class="line">	……</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h1 id="解决方式"><a href="#解决方式" class="headerlink" title="解决方式"></a>解决方式</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1、yum install fontconfig -y &amp;&amp; cd /usr/share/fonts &amp;&amp; fc-cache</span><br><span class="line">2、重启应用(jar)服务</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>Troubleshooting</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux中格式化（擦除）DVD + RW / DVD-RW磁盘</title>
    <url>/arlo/8d67f160/</url>
    <content><![CDATA[<h1 id="安装dvd-rw-tools工具"><a href="#安装dvd-rw-tools工具" class="headerlink" title="安装dvd+rw-tools工具"></a>安装dvd+rw-tools工具</h1><p>要格式化&#x2F;擦除DVD + RW磁盘，我们需要dvd+rw-tools工具 。 如果尚未安装，请安装：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum install dvd+rw-tools</span><br><span class="line">yum install cdrecord</span><br></pre></td></tr></table></figure>

<h1 id="格式化光盘"><a href="#格式化光盘" class="headerlink" title="格式化光盘"></a>格式化光盘</h1><p>在将DVD + RW插入刻录机后，可以使用dvd+rw-format工具格式化&#x2F;擦除DVD + RW（实际上无需显式地将其清空）&#x2F; DVD-RW磁盘：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dvd+rw-format -force /dev/sr0</span><br></pre></td></tr></table></figure>

<p>使用cdrecord擦除DVD-RW磁盘的命令（由wodim提供）：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cdrecord dev=/dev/sr0 blank=fast</span><br></pre></td></tr></table></figure>

<h1 id="LINUX下光盘的常见操作"><a href="#LINUX下光盘的常见操作" class="headerlink" title="LINUX下光盘的常见操作"></a>LINUX下光盘的常见操作</h1><p>刻录光盘语法：growisofs -dvd-compat -speed&#x3D;&lt;刻录速度&gt; -Z &lt;设备名&gt;&#x3D;&lt;镜像路径&gt;</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">growisofs -dvd-compat -Z /dev/dvdwriter=/opt/CentOS-5.3-x86_64-bin-DVD.iso</span><br><span class="line"></span><br><span class="line">#刻录ISO文件</span><br><span class="line">growisofs -dvd-compat -Z /dev/sr0=/path/to/image.iso   </span><br><span class="line">#初次刻录（非ISO文件）</span><br><span class="line">growisofs -Z /dev/sr0 -R -J /some/files    </span><br><span class="line">#往已有的DVD盘上添加文件</span><br><span class="line">growisofs -M /dev/sr0 -R -J /more/files   </span><br><span class="line">#给DVD盘封口(一般用不着）</span><br><span class="line">growisofs -M /dev/sr0=/dev/zero  </span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>常识</tag>
        <tag>dvd</tag>
      </tags>
  </entry>
  <entry>
    <title>一键升级OpenSSH版本脚本</title>
    <url>/arlo/428ac623/</url>
    <content><![CDATA[<p>一键升级Openssh脚本</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">##yum源配置</span><br><span class="line">mv /etc/yum.repos.d  /etc/yum.repos.d.bak</span><br><span class="line">echo &quot;1.yum源已备份&quot;</span><br><span class="line"></span><br><span class="line">mkdir /etc/yum.repos.d</span><br><span class="line">cd /etc/yum.repos.d</span><br><span class="line">touch CentOS-Base.repo</span><br><span class="line">#如果有内网yum源，可以使用以下注释配置</span><br><span class="line">#echo &quot;[centos]</span><br><span class="line">#name=CentOS</span><br><span class="line">#baseurl=http://x.x.x.x/CentOS7-2207</span><br><span class="line">#gpgcheck=0</span><br><span class="line">#gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7</span><br><span class="line">#enabled=1&quot; &gt;&gt; /etc/yum.repos.d/CentOS-Base.repo</span><br><span class="line">#使用在线yum源</span><br><span class="line">curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line">yum clean all</span><br><span class="line">yum makecache</span><br><span class="line">yum -y update </span><br><span class="line">echo &quot;2.仓库源已更新&quot;</span><br><span class="line"></span><br><span class="line">##升级包下载</span><br><span class="line">yum -y install wget</span><br><span class="line">cd /opt</span><br><span class="line">wget https://ftp.openbsd.org/pub/OpenBSD/OpenSSH/portable/openssh-9.6p1.tar.gz</span><br><span class="line">wget https://ftp.openssl.org/source/openssl-3.2.0.tar.gz</span><br><span class="line"></span><br><span class="line">##openssl升级</span><br><span class="line">cd /opt</span><br><span class="line">cp /usr/bin/openssl /usr/bin/openssl.old </span><br><span class="line">cp /usr/include /usr/include.old  </span><br><span class="line">tar -zxvf openssl-3.2.0.tar.gz  </span><br><span class="line">cd openssl-3.2.0 </span><br><span class="line">yum -y install perl-IPC-Cmd </span><br><span class="line">if [ $? -eq 0 ]; then</span><br><span class="line">    echo &quot;3.openssl组件已完成安装&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;3.openssl组件安装失败，程序终止&quot;</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">./config --prefix=/usr  --shared  </span><br><span class="line">make &amp;&amp; make install  </span><br><span class="line">sslversion=$(openssl version -a) </span><br><span class="line">echo &quot;4.openssl升级完毕，当前版本为$sslversion&quot;</span><br><span class="line"></span><br><span class="line">##openssh旧版本卸载</span><br><span class="line">echo y | yum remove openssh</span><br><span class="line">if [ $? -eq 0 ]; then</span><br><span class="line">    echo &quot;5.openssh旧版本卸载完成&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;5.openssh旧版本卸载失败，程序终止&quot;</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">##openssh组件安装</span><br><span class="line">yum -y install gcc make perl zlib zlib-devel pam pam-devel</span><br><span class="line">if [ $? -eq 0 ]; then</span><br><span class="line">    echo &quot;6.openssh组件已完成安装&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;6.openssh组件安装失败，程序终止&quot;</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">##openssh新版本安装</span><br><span class="line">cd /opt</span><br><span class="line">tar -zxvf openssh-9.6p1.tar.gz</span><br><span class="line">cd openssh-9.6p1</span><br><span class="line">cp /etc/ssh /etc/ssh.old</span><br><span class="line">echo &quot;7.ssh 配置已备份&quot;</span><br><span class="line">./configure --prefix=/usr/local/openssh --with-zlib=/usr/local/zlib --with-ssl-dir=/usr/local/ssl</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">sed -i &#x27;32s/^#//&#x27; /usr/local/openssh/etc/sshd_config</span><br><span class="line">sed -i &#x27;s/prohibit-password/yes/&#x27; /usr/local/openssh/etc/sshd_config</span><br><span class="line">cp contrib/redhat/sshd.init   /etc/init.d/sshd </span><br><span class="line">chkconfig --add sshd</span><br><span class="line">cp /usr/local/openssh/etc/sshd_config  /etc/ssh/sshd_config </span><br><span class="line">cp /usr/local/openssh/sbin/sshd  /usr/sbin/sshd   </span><br><span class="line">cp /usr/local/openssh/bin/*  /usr/bin/   </span><br><span class="line">cp /usr/local/openssh/etc/ssh_host_ecdsa_key.pub  /etc/ssh/ssh_host_ecdsa_key.pub </span><br><span class="line">systemctl daemon-reload </span><br><span class="line">systemctl restart sshd &amp;&amp; systemctl enable sshd</span><br><span class="line">sshversion=$(ssh -V 2&gt;&amp;1)</span><br><span class="line">echo &quot;8.openssh已升级,当前版本为$sshversion&quot;</span><br><span class="line">echo  &quot;9.升级完成，请手动进行验证结果&quot;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>自动化运维</category>
      </categories>
      <tags>
        <tag>SSH</tag>
      </tags>
  </entry>
  <entry>
    <title>安装操作系统提示“找不到任何设备驱动程序”</title>
    <url>/arlo/8a3bddbb/</url>
    <content><![CDATA[<h1 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h1><p>安装操作系统时候发现不了硬盘，提示“找不到任何驱动程序。请确保安装媒体包含的驱动程序正确，然后单机“确定” ”</p>
<p><img src="https://pic2.zhimg.com/v2-193f2d6037b8e7874c8e6e7bd1f9bfc1_r.jpg" alt="img"></p>
<span id="more"></span>

<h1 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h1><p>windows镜像里没有封装usb3.0的驱动，当我们使用USB3.0的端口来安装Windows7系统时，在加载驱动过程时候会出错，导致系统无法进行下一步安装；</p>
<p>在这个界面使用shift+F10–&gt; diskpart–&gt;list disk ，看不到u盘 </p>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>1、 使用rufus制作好原生操作系统安装盘，然后向U盘中注入Usb3.0的驱动程序；</p>
<p>2、驱动下载链接：<a href="https://www.gigabyte.cn/Motherboard/GA-Z170X-Gaming-G1-rev-10/support#support-dl-driver">https://www.gigabyte.cn/Motherboard/GA-Z170X-Gaming-G1-rev-10/support#support-dl-driver</a></p>
<p>3、驱动注入过程参考：<a href="https://www.gigabyte.cn/WebPage/-79/usb.html">https://www.gigabyte.cn/WebPage/-79/usb.html</a></p>
]]></content>
      <categories>
        <category>Troubleshooting</category>
      </categories>
      <tags>
        <tag>Windows</tag>
        <tag>Troubleshooting</tag>
      </tags>
  </entry>
</search>
